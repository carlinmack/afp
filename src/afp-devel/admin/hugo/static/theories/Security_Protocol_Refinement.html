<div id="Infra">
<div class="head">
<h1>Theory Infra</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Development of Security Protocols by Refinement

  Module:  Refinement/Infra.thy (Isabelle/HOL 2016-1)
  ID:      $Id: Infra.thy 134925 2017-05-24 17:53:14Z csprenge $
  Author:  Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  Infrastructure for refinement proofs (attributes, prover tuning etc)

  Copyright (c) 2009-2016 Christoph Sprenger 
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Protocol Modeling and Refinement Infrastructure›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This chapter sets up our theory of refinement and the protocol
modeling infrastructure.›</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Proving infrastructure›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Infra <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>  
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Prover configuration›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">declare</span></span> if_split_asm <span class="main">[</span><span class="operator">split</span><span class="main">]</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Forward reasoning ("attributes")›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following lemmas are used to produce intro/elim rules from
set definitions and relation definitions.›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> set_def_to_intro <span class="main">=</span> meta_eq_to_obj_eq <span class="main">[</span><span class="operator">THEN</span> eqset_imp_iff<span class="main">,</span> <span class="operator">THEN</span> iffD2<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> set_def_to_dest <span class="main">=</span> meta_eq_to_obj_eq <span class="main">[</span><span class="operator">THEN</span> eqset_imp_iff<span class="main">,</span> <span class="operator">THEN</span> iffD1<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> set_def_to_elim <span class="main">=</span> set_def_to_dest <span class="main">[</span><span class="operator">elim_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> setc_def_to_intro <span class="main">=</span> 
  set_def_to_intro <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">P</span><span class="main">,</span> <span class="operator">to_pred</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> setc_def_to_dest <span class="main">=</span> 
  set_def_to_dest <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">P</span><span class="main">,</span> <span class="operator">to_pred</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> setc_def_to_elim <span class="main">=</span> setc_def_to_dest <span class="main">[</span><span class="operator">elim_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> rel_def_to_intro <span class="main">=</span> setc_def_to_intro <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">s</span> <span class="free">t</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> rel_def_to_dest <span class="main">=</span> setc_def_to_dest <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">s</span> <span class="free">t</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> rel_def_to_elim <span class="main">=</span> rel_def_to_dest <span class="main">[</span><span class="operator">elim_format</span><span class="main">]</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹General results›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Maps›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We usually remove <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">domIff</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> from the simpset and clasets due
to annoying behavior. Sometimes the lemmas below are more well-behaved than 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">domIff</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Usually to be used as "dest: dom\_lemmas". However, adding 
them as permanent dest rules slows down proofs too much, so we refrain from 
doing this.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_definedness<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> dom <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domIff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_definedness_contra<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">y</span><span class="main">;</span> <span class="free">z</span> <span class="main">∉</span> dom <span class="free">f</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domIff<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> dom_lemmas <span class="main">=</span> map_definedness map_definedness_contra


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Set›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> vimage_image_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">f</span><span class="main">-`</span><span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def vimage_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Relations›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> Image_compose <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">R1</span> <span class="keyword1">O</span> <span class="free">R2</span><span class="main">)</span><span class="main">``</span><span class="free">A</span>  <span class="main">=</span> <span class="free">R2</span><span class="main">``</span><span class="main">(</span><span class="free">R1</span><span class="main">``</span><span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Lists›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_id<span class="main">:</span> <span class="quoted"><span class="quoted">"map id <span class="main">=</span> id"</span></span>      <span class="comment1">(* already in simpset *)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="comment1">― ‹Do NOT add the following equation to the simpset! (looping)›</span>
<span class="keyword1"><span class="command">lemma</span></span> map_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="free">g</span> <span class="keyword1">o</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> map <span class="free">g</span> <span class="keyword1">o</span> map <span class="free">f</span>"</span></span>  
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> map_comp_map <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> take_prefix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> take <span class="free">n</span> <span class="free">l</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">xs'</span><span class="main">.</span> <span class="free">l</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">@</span> <span class="bound">xs'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
   <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Finite sets›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Cardinality.›</span></span>

<span class="keyword1"><span class="command">declare</span></span> arg_cong <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted">card</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span> 

<span class="keyword1"><span class="command">lemma</span></span> finite_positive_cardI <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">;</span> finite <span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> card <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_positive_cardD <span class="main">[</span><span class="operator">dest</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">0</span> <span class="main">&lt;</span> card <span class="free">A</span><span class="main">;</span> finite <span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_zero_cardI <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{}</span><span class="main">;</span> finite <span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span> card <span class="free">A</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_zero_cardD <span class="main">[</span><span class="operator">dest</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> card <span class="free">A</span> <span class="main">=</span> <span class="main">0</span><span class="main">;</span> finite <span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>





</pre>
</div><div id="Refinement">
<div class="head">
<h1>Theory Refinement</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Development of Security Protocols by Refinement

  Module:  Refinement/Refinement.thy (Isabelle/HOL 2016-1)
  ID:      $Id: Refinement.thy 132773 2016-12-09 15:30:22Z csprenge $
  Author:  Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  Minimal infrastructure for invariants and refinements

  Copyright (c) 2009-2016 Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Models, Invariants and Refinements›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Refinement <span class="keyword2"><span class="keyword">imports</span></span> <a href="Infra.html">Infra</a> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Specifications, reachability, and behaviours.›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Transition systems are multi-pointed graphs.›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="tfree">'s</span> TS <span class="main">=</span> 
  init <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> set"</span></span>
  trans <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> set"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The inductive set of reachable states.›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> 
  <span class="entity">reach</span> <span class="main">::</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> TS_scheme <span class="main">⇒</span> <span class="tfree">'s</span> set"</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">T</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> TS_scheme"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  r_init <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∈</span> init <span class="free">T</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∈</span> <span class="free">reach</span> <span class="free">T</span>"</span></span>
<span class="main">|</span> r_trans <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∈</span> trans <span class="free">T</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∈</span> <span class="free">reach</span> <span class="free">T</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∈</span> <span class="free">reach</span> <span class="free">T</span>"</span></span>

<span class="comment1">(* inductive_cases reach_invert: "t ∈ reach T" *)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Finite behaviours›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Note that behaviours grow at the head of the list, i.e., the initial 
state is at the end.›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> 
  <span class="entity">beh</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> TS_scheme <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> list<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">T</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> TS_scheme"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  b_empty <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> <span class="free">beh</span> <span class="free">T</span>"</span></span>
<span class="main">|</span> b_init <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∈</span> init <span class="free">T</span> <span class="main">⟹</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">]</span> <span class="main">∈</span> <span class="free">beh</span> <span class="free">T</span>"</span></span>
<span class="main">|</span> b_trans <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∈</span> <span class="free">beh</span> <span class="free">T</span><span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∈</span> trans <span class="free">T</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∈</span> <span class="free">beh</span> <span class="free">T</span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> beh_non_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">#</span> <span class="free">b</span> <span class="main">∈</span> beh <span class="free">T</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Behaviours are prefix closed.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> beh_immediate_prefix_closed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">#</span> <span class="free">b</span> <span class="main">∈</span> beh <span class="free">T</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">∈</span> beh <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> beh_non_empty<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> beh_prefix_closed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">@</span> <span class="free">b</span> <span class="main">∈</span> beh <span class="free">T</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">∈</span> beh <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> beh_immediate_prefix_closed<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹States in behaviours are exactly reachable.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> beh_in_reach <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> beh <span class="free">T</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> set <span class="free">b</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> reach <span class="free">T</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> beh.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> reach_in_beh<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> reach <span class="free">T</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">b</span> <span class="main">∈</span> beh <span class="free">T</span><span class="main">.</span> <span class="free">s</span> <span class="main">∈</span> set <span class="bound">b</span>"</span></span> 
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> reach.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>r_init <span class="skolem">s</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> set <span class="main">[</span><span class="skolem">s</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">s</span><span class="main">]</span> <span class="main">∈</span> beh <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>r_trans <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> beh <span class="free">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> set <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∈</span> set <span class="skolem">b</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b1</span></span> <span class="skolem"><span class="skolem">b2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="skolem">b2</span> <span class="main">@</span> <span class="skolem">s</span> <span class="main">#</span> <span class="skolem">b1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> split_list<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">∈</span> beh <span class="free">T</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">#</span> <span class="skolem">b1</span> <span class="main">∈</span> beh <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> beh_prefix_closed<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> trans <span class="free">T</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">#</span> <span class="skolem">s</span> <span class="main">#</span> <span class="skolem">b1</span> <span class="main">∈</span> beh <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> reach_equiv_beh_states<span class="main">:</span> <span class="quoted"><span class="quoted">"reach <span class="free">T</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>set<span class="main">`</span><span class="main">(</span>beh <span class="free">T</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> reach_in_beh beh_in_reach<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Specifications, observability, and implementation›</span></span> 
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Specifications add an observer function to transition systems.›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'o</span><span class="main">)</span> spec <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> TS"</span></span> <span class="main">+</span>
  obs <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'o</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> beh_obs_upd <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"beh <span class="main">(</span><span class="free">S</span><span class="main">(|</span> obs <span class="main">:=</span> <span class="free">x</span> <span class="main">|)</span><span class="main">)</span> <span class="main">=</span> beh <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main">)</span> <span class="main">(</span><span class="operator">erule</span> beh.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> reach_obs_upd <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach <span class="main">(</span><span class="free">S</span><span class="main">(|</span> obs <span class="main">:=</span> <span class="free">x</span> <span class="main">|)</span><span class="main">)</span> <span class="main">=</span> reach <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main">)</span> <span class="main">(</span><span class="operator">erule</span> reach.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Observable behaviour and reachability.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">obeh</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'o</span><span class="main">)</span> spec <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'o</span> list<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">obeh</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">(</span>map <span class="main">(</span>obs <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">`</span><span class="main">(</span>beh <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">oreach</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'o</span><span class="main">)</span> spec <span class="main">⇒</span> <span class="tfree">'o</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">oreach</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">(</span>obs <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span><span class="main">`</span><span class="main">(</span>reach <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> oreach_equiv_obeh_states<span class="main">:</span>
  <span class="quoted"><span class="quoted">"oreach <span class="free">S</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>set<span class="main">`</span><span class="main">(</span>obeh <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_equiv_beh_states oreach_def obeh_def<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> obeh_pi_translation<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="free">pi</span><span class="main">)</span><span class="main">`</span><span class="main">(</span>obeh <span class="free">S</span><span class="main">)</span> <span class="main">=</span> obeh <span class="main">(</span><span class="free">S</span><span class="main">(|</span> obs <span class="main">:=</span> <span class="free">pi</span> <span class="keyword1">o</span> <span class="main">(</span>obs <span class="free">S</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obeh_def image_comp<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> oreach_pi_translation<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">pi</span><span class="main">`</span><span class="main">(</span>oreach <span class="free">S</span><span class="main">)</span> <span class="main">=</span> oreach <span class="main">(</span><span class="free">S</span><span class="main">(|</span> obs <span class="main">:=</span> <span class="free">pi</span> <span class="keyword1">o</span> <span class="main">(</span>obs <span class="free">S</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> oreach_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A predicate $P$ on the states of a specification is \emph{observable} 
if it cannot distinguish between states yielding the same observation. 
Equivalently, $P$ is observable if it is the inverse image under the 
observation function of a predicate on observations.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">observable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'o</span><span class="main">,</span> <span class="tfree">'s</span> set<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">observable</span> <span class="free"><span class="bound"><span class="entity">ob</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ob</span></span></span> <span class="bound">s</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ob</span></span></span> <span class="bound">s'</span> <span class="main">⟶</span> <span class="bound">s'</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⟶</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">observable2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'o</span><span class="main">,</span> <span class="tfree">'s</span> set<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">observable2</span> <span class="free"><span class="bound"><span class="entity">ob</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">Q</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ob</span></span></span><span class="main">-`</span><span class="bound">Q</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">observable3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'o</span><span class="main">,</span> <span class="tfree">'s</span> set<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">observable3</span> <span class="free"><span class="bound"><span class="entity">ob</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">ob</span></span></span><span class="main">-`</span><span class="free"><span class="bound"><span class="entity">ob</span></span></span><span class="main">`</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>    <span class="comment1">― ‹other direction holds trivially›</span>

<span class="keyword1"><span class="command">lemma</span></span> observableE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>observable <span class="free">ob</span> <span class="free">P</span><span class="main">;</span> <span class="free">ob</span> <span class="free">s</span> <span class="main">=</span> <span class="free">ob</span> <span class="free">s'</span><span class="main">;</span> <span class="free">s'</span> <span class="main">∈</span> <span class="free">P</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> observable_def<span class="main">)</span> <span class="main">(</span><span class="operator">fast</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> observable2_equiv_observable<span class="main">:</span> <span class="quoted"><span class="quoted">"observable2 <span class="free">ob</span> <span class="free">P</span> <span class="main">=</span> observable <span class="free">ob</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> observable_def observable2_def<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> observable3_equiv_observable2<span class="main">:</span> <span class="quoted"><span class="quoted">"observable3 <span class="free">ob</span> <span class="free">P</span> <span class="main">=</span> observable2 <span class="free">ob</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> observable3_def observable2_def<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> observable_id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"observable id <span class="free">P</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> observable_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The set extension of a function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">ob</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the left adjoint of 
a Galois connection on the powerset lattices over domain and range of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">ob</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
where the right adjoint is the inverse image function.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> image_vimage_adjoints<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ob</span><span class="main">`</span><span class="free">P</span> <span class="main">⊆</span> <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">P</span> <span class="main">⊆</span> <span class="free">ob</span><span class="main">-`</span><span class="free">Q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">declare</span></span> image_vimage_subset <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> vimage_image_subset <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Similar but "reversed" (wrt to adjointness) relationships only hold under
additional conditions.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> image_r_vimage_l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Q</span> <span class="main">⊆</span> <span class="free">ob</span><span class="main">`</span><span class="free">P</span><span class="main">;</span> observable <span class="free">ob</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">ob</span><span class="main">-`</span><span class="free">Q</span> <span class="main">⊆</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> vimage_l_image_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">ob</span><span class="main">-`</span><span class="free">Q</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">;</span> <span class="free">Q</span> <span class="main">⊆</span> range <span class="free">ob</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">⊆</span> <span class="free">ob</span><span class="main">`</span><span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> image_mono <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">ob</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Internal and external invariants›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> external_from_internal_invariant<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> reach <span class="free">S</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">;</span> <span class="main">(</span>obs <span class="free">S</span><span class="main">)</span><span class="main">`</span><span class="free">P</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">⟧</span>  
  <span class="main">⟹</span> oreach <span class="free">S</span> <span class="main">⊆</span> <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> oreach_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> external_from_internal_invariant_vimage<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> reach <span class="free">S</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">;</span> <span class="free">P</span> <span class="main">⊆</span> <span class="main">(</span>obs <span class="free">S</span><span class="main">)</span><span class="main">-`</span><span class="free">Q</span> <span class="main">⟧</span>
  <span class="main">⟹</span> oreach <span class="free">S</span> <span class="main">⊆</span> <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> external_from_internal_invariant<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> external_to_internal_invariant_vimage<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> oreach <span class="free">S</span> <span class="main">⊆</span> <span class="free">Q</span><span class="main">;</span> <span class="main">(</span>obs <span class="free">S</span><span class="main">)</span><span class="main">-`</span><span class="free">Q</span> <span class="main">⊆</span> <span class="free">P</span> <span class="main">⟧</span>
  <span class="main">⟹</span> reach <span class="free">S</span> <span class="main">⊆</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> oreach_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> external_to_internal_invariant<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> oreach <span class="free">S</span> <span class="main">⊆</span> <span class="free">Q</span><span class="main">;</span> <span class="free">Q</span> <span class="main">⊆</span> <span class="main">(</span>obs <span class="free">S</span><span class="main">)</span><span class="main">`</span><span class="free">P</span><span class="main">;</span> observable <span class="main">(</span>obs <span class="free">S</span><span class="main">)</span> <span class="free">P</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> reach <span class="free">S</span> <span class="main">⊆</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> external_to_internal_invariant_vimage<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> external_equiv_internal_invariant_vimage<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="main">=</span> <span class="main">(</span>obs <span class="free">S</span><span class="main">)</span><span class="main">-`</span><span class="free">Q</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">(</span>oreach <span class="free">S</span> <span class="main">⊆</span> <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>reach <span class="free">S</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> external_from_internal_invariant_vimage
                external_to_internal_invariant_vimage 
         <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> external_equiv_internal_invariant<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span>obs <span class="free">S</span><span class="main">)</span><span class="main">`</span><span class="free">P</span> <span class="main">=</span> <span class="free">Q</span><span class="main">;</span> observable <span class="main">(</span>obs <span class="free">S</span><span class="main">)</span> <span class="free">P</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">(</span>oreach <span class="free">S</span> <span class="main">⊆</span> <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>reach <span class="free">S</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> external_equiv_internal_invariant_vimage<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Our notion of implementation is inclusion of observable behaviours.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">implements</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'o</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'o</span><span class="main">)</span> spec<span class="main">,</span> <span class="main">(</span><span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">)</span> spec<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">implements</span> <span class="free"><span class="bound"><span class="entity">pi</span></span></span> <span class="free"><span class="bound"><span class="entity">Sa</span></span></span> <span class="free"><span class="bound"><span class="entity">Sc</span></span></span> <span class="main">≡</span> <span class="main">(</span>map <span class="free"><span class="bound"><span class="entity">pi</span></span></span><span class="main">)</span><span class="main">`</span><span class="main">(</span>obeh <span class="free"><span class="bound"><span class="entity">Sc</span></span></span><span class="main">)</span> <span class="main">⊆</span> obeh <span class="free"><span class="bound"><span class="entity">Sa</span></span></span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Reflexivity and transitivity›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> implements_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"implements id <span class="free">S</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> implements_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> implements_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> implements <span class="free">pi1</span> <span class="free">S1</span> <span class="free">S2</span><span class="main">;</span> implements <span class="free">pi2</span> <span class="free">S2</span> <span class="free">S3</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> implements <span class="main">(</span><span class="free">pi1</span> <span class="keyword1">o</span> <span class="free">pi2</span><span class="main">)</span> <span class="free">S1</span> <span class="free">S3</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> implements_def image_subset_iff<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Preservation of external invariants›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> implements_oreach<span class="main">:</span>
  <span class="quoted"><span class="quoted">"implements <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span> <span class="main">⟹</span> <span class="free">pi</span><span class="main">`</span><span class="main">(</span>oreach <span class="free">Sc</span><span class="main">)</span> <span class="main">⊆</span> oreach <span class="free">Sa</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> implements_def oreach_equiv_obeh_states <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> external_invariant_preservation<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> oreach <span class="free">Sa</span> <span class="main">⊆</span> <span class="free">Q</span><span class="main">;</span> implements <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">pi</span><span class="main">`</span><span class="main">(</span>oreach <span class="free">Sc</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> implements_oreach<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> external_invariant_translation<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> oreach <span class="free">Sa</span> <span class="main">⊆</span> <span class="free">Q</span><span class="main">;</span> <span class="free">pi</span><span class="main">-`</span><span class="free">Q</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">;</span> implements <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span> <span class="main">⟧</span>
  <span class="main">⟹</span> oreach <span class="free">Sc</span> <span class="main">⊆</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> vimage_image_subset<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">pi</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">pi</span></span><span class="main"><span class="main">-`</span></span><span class="free"><span class="free">Q</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> vimage_mono external_invariant_preservation<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Preservation of internal invariants›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> internal_invariant_translation<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> reach <span class="free">Sa</span> <span class="main">⊆</span> <span class="free">Pa</span><span class="main">;</span> <span class="free">Pa</span> <span class="main">⊆</span> obs <span class="free">Sa</span> <span class="main">-`</span> <span class="free">Qa</span><span class="main">;</span> <span class="free">pi</span> <span class="main">-`</span> <span class="free">Qa</span> <span class="main">⊆</span> <span class="free">Q</span><span class="main">;</span> obs <span class="free">S</span> <span class="main">-`</span> <span class="free">Q</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">;</span>
     implements <span class="free">pi</span> <span class="free">Sa</span> <span class="free">S</span> <span class="main">⟧</span>
  <span class="main">⟹</span> reach <span class="free">S</span> <span class="main">⊆</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> external_from_internal_invariant_vimage <span class="main"><span class="main">[</span></span>
      <span class="operator">THEN</span> external_invariant_translation<span class="main"><span class="main">,</span></span> 
      <span class="operator">THEN</span> external_to_internal_invariant_vimage<span class="main"><span class="main">]</span></span><span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹First we define Hoare triples over transition relations and then
we derive proof rules to establish invariants.›</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Hoare triples›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">PO_hoare</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'s</span> set<span class="main">,</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> set<span class="main">,</span> <span class="tfree">'s</span> set<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>
     <span class="main">(</span><span class="quoted">"<span class="keyword3">(3</span><span class="keyword1">{</span>_<span class="keyword1">}</span> _ <span class="keyword1">{&gt;</span> _<span class="keyword1">}</span><span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 90<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">{</span></span><span class="free"><span class="bound"><span class="entity">pre</span></span></span><span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main"><span class="free">{&gt;</span></span> <span class="free"><span class="bound"><span class="entity">post</span></span></span><span class="main"><span class="free">}</span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">``</span><span class="free"><span class="bound"><span class="entity">pre</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">post</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_hoare_defs <span class="main">=</span> PO_hoare_def Image_def

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="free">R</span> <span class="main">{&gt;</span> <span class="free">Q</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟶</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Some essential facts about Hoare triples.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> hoare_conseq_left <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span><span class="free">P'</span><span class="main">}</span> <span class="free">R</span> <span class="main">{&gt;</span> <span class="free">Q</span><span class="main">}</span><span class="main">;</span> <span class="free">P</span> <span class="main">⊆</span> <span class="free">P'</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="free">R</span> <span class="main">{&gt;</span> <span class="free">Q</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hoare_conseq_right<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="free">R</span> <span class="main">{&gt;</span> <span class="free">Q'</span><span class="main">}</span><span class="main">;</span> <span class="free">Q'</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="free">R</span> <span class="main">{&gt;</span> <span class="free">Q</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hoare_false_left <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">{}</span><span class="main">}</span> <span class="free">R</span> <span class="main">{&gt;</span> <span class="free">Q</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hoare_true_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="free">R</span> <span class="main">{&gt;</span> UNIV<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hoare_conj_right <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="free">R</span> <span class="main">{&gt;</span> <span class="free">Q1</span><span class="main">}</span><span class="main">;</span> <span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="free">R</span> <span class="main">{&gt;</span> <span class="free">Q2</span><span class="main">}</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="free">R</span> <span class="main">{&gt;</span> <span class="free">Q1</span> <span class="main">∩</span> <span class="free">Q2</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Special transition relations.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> hoare_stop <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="main">{}</span> <span class="main">{&gt;</span> <span class="free">Q</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hoare_skip <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="main">{</span><span class="free">P</span><span class="main">}</span> Id <span class="main">{&gt;</span> <span class="free">Q</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hoare_trans_Un <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="free">R1</span> <span class="main">∪</span> <span class="free">R2</span> <span class="main">{&gt;</span> <span class="free">Q</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="free">R1</span> <span class="main">{&gt;</span> <span class="free">Q</span><span class="main">}</span> <span class="main">∧</span> <span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="free">R2</span> <span class="main">{&gt;</span> <span class="free">Q</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hoare_trans_UN <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="main">⋃</span> <span class="bound">x</span><span class="main">.</span> <span class="free">R</span> <span class="bound">x</span> <span class="main">{&gt;</span> <span class="free">Q</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="free">R</span> <span class="bound">x</span> <span class="main">{&gt;</span> <span class="free">Q</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs<span class="main">)</span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Characterization of reachability›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> reach_init<span class="main">:</span> <span class="quoted"><span class="quoted">"reach <span class="free">T</span> <span class="main">⊆</span> <span class="free">I</span> <span class="main">⟹</span> init <span class="free">T</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> reach_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"reach <span class="free">T</span> <span class="main">⊆</span> <span class="free">I</span> <span class="main">⟹</span> <span class="main">{</span>reach <span class="free">T</span><span class="main">}</span> trans <span class="free">T</span> <span class="main">{&gt;</span> <span class="free">I</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Useful consequences.›</span></span>

<span class="keyword1"><span class="command">corollary</span></span> init_reach <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"init <span class="free">T</span> <span class="main">⊆</span> reach <span class="free">T</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reach_init<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> trans_reach <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>reach <span class="free">T</span><span class="main">}</span> trans <span class="free">T</span> <span class="main">{&gt;</span> reach <span class="free">T</span><span class="main">}</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reach_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Invariant proof rules›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Basic proof rule for invariants.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inv_rule_basic<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> init <span class="free">T</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">;</span> <span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">T</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">P</span><span class="main">}</span> <span class="main">⟧</span>
  <span class="main">⟹</span> reach <span class="free">T</span> <span class="main">⊆</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> reach.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹General invariant proof rule. This rule is complete (set 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">I</span></span> <span class="main"><span class="main">=</span></span> reach <span class="free"><span class="free">T</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>).›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inv_rule<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> init <span class="free">T</span> <span class="main">⊆</span> <span class="free">I</span><span class="main">;</span> <span class="free">I</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">;</span> <span class="main">{</span><span class="free">I</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">T</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">I</span><span class="main">}</span> <span class="main">⟧</span>
  <span class="main">⟹</span> reach <span class="free">T</span> <span class="main">⊆</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>              <span class="comment1">― ‹strengthen goal›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> reach.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following rule is equivalent to the previous one.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> INV_rule<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> init <span class="free">T</span> <span class="main">⊆</span> <span class="free">I</span><span class="main">;</span> <span class="main">{</span><span class="free">I</span> <span class="main">∩</span> reach <span class="free">T</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">T</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">I</span><span class="main">}</span> <span class="main">⟧</span>
  <span class="main">⟹</span> reach <span class="free">T</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> reach.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Proof of equivalence.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inv_rule_from_INV_rule<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> init <span class="free">T</span> <span class="main">⊆</span> <span class="free">I</span><span class="main">;</span> <span class="free">I</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">;</span> <span class="main">{</span><span class="free">I</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">T</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">I</span><span class="main">}</span> <span class="main">⟧</span>
  <span class="main">⟹</span> reach <span class="free">T</span> <span class="main">⊆</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> INV_rule<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> INV_rule_from_inv_rule<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> init <span class="free">T</span> <span class="main">⊆</span> <span class="free">I</span><span class="main">;</span> <span class="main">{</span><span class="free">I</span> <span class="main">∩</span> reach <span class="free">T</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">T</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">I</span><span class="main">}</span> <span class="main">⟧</span>
  <span class="main">⟹</span> reach <span class="free">T</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> I<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">∩</span> reach <span class="free">T</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> inv_rule<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Incremental proof rule for invariants using auxiliary invariant(s). 
This rule might have become obsolete by addition of $INV\_rule$.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inv_rule_incr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> init <span class="free">T</span> <span class="main">⊆</span> <span class="free">I</span><span class="main">;</span> <span class="main">{</span><span class="free">I</span> <span class="main">∩</span> <span class="free">J</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">T</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">I</span><span class="main">}</span><span class="main">;</span> reach <span class="free">T</span> <span class="main">⊆</span> <span class="free">J</span> <span class="main">⟧</span>    
  <span class="main">⟹</span> reach <span class="free">T</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> INV_rule<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Our notion of refinement is simulation. We first define a general
notion of relational Hoare tuple, which we then use to define the refinement
proof obligation.  Finally, we show that observation-consistent refinement 
of specifications implies the implementation relation between them.›</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Relational Hoare tuples›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Relational Hoare tuples formalize the following generalized simulation 
diagram:

\begin{verbatim}
                           o -- Ra --&gt; o
                           |           |
                          pre         post
                           |           |
                           v           V
                           o -- Rc --&gt; o
\end{verbatim}

Here, $Ra$ and $Rc$ are the abstract and concrete transition relations, 
and $pre$ and $post$ are the pre- and post-relations.
(In the definiton below, the operator <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">(O)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> stands for relational 
composition, which is defined as follows: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> relcomp_def <span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.)›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">PO_rhoare</span> <span class="main">::</span> 
    <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span> set<span class="main">,</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> set<span class="main">,</span> <span class="main">(</span><span class="tfree">'t</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span> set<span class="main">,</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span> set<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>
     <span class="main">(</span><span class="quoted">"<span class="keyword3">(4</span><span class="keyword1">{</span>_<span class="keyword1">}</span> _<span class="keyword1">,</span> _ <span class="keyword1">{&gt;</span> _<span class="keyword1">}</span><span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 90<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">{</span></span><span class="free"><span class="bound"><span class="entity">pre</span></span></span><span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Rc</span></span></span> <span class="main"><span class="free">{&gt;</span></span> <span class="free"><span class="bound"><span class="entity">post</span></span></span><span class="main"><span class="free">}</span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">pre</span></span></span> <span class="keyword1">O</span> <span class="free"><span class="bound"><span class="entity">Rc</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="keyword1">O</span> <span class="free"><span class="bound"><span class="entity">post</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_rhoare_defs <span class="main">=</span> PO_rhoare_def relcomp_unfold


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Facts about relational Hoare tuples.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> relhoare_conseq_left <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span><span class="free">pre'</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span><span class="main">;</span> <span class="free">pre</span> <span class="main">⊆</span> <span class="free">pre'</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> relhoare_conseq_right<span class="main">:</span>                    <span class="comment1">― ‹do NOT declare [intro]›</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post'</span><span class="main">}</span><span class="main">;</span> <span class="free">post'</span> <span class="main">⊆</span> <span class="free">post</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> relhoare_false_left <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>               <span class="comment1">― ‹do NOT declare [intro]›</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="main">{}</span> <span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> relhoare_true_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>                <span class="comment1">― ‹not true in general›</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> UNIV<span class="main">}</span> <span class="main">=</span> <span class="main">(</span>Domain <span class="main">(</span><span class="free">pre</span> <span class="keyword1">O</span> <span class="free">Rc</span><span class="main">)</span> <span class="main">⊆</span> Domain <span class="free">Ra</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Domain_rel_comp <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Domain <span class="free">pre</span> <span class="main">⊆</span> <span class="free">R</span> <span class="main">⟹</span> Domain <span class="main">(</span><span class="free">pre</span> <span class="keyword1">O</span> <span class="free">Rc</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Domain_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rel_hoare_skip <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">R</span><span class="main">}</span> Id<span class="main">,</span> Id <span class="main">{&gt;</span> <span class="free">R</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Reflexivity and transitivity.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> relhoare_refl <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Id<span class="main">}</span> <span class="free">R</span><span class="main">,</span> <span class="free">R</span> <span class="main">{&gt;</span> Id<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rhoare_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span><span class="free">R1</span><span class="main">}</span> <span class="free">T1</span><span class="main">,</span> <span class="free">T2</span> <span class="main">{&gt;</span> <span class="free">R1</span><span class="main">}</span><span class="main">;</span> <span class="main">{</span><span class="free">R2</span><span class="main">}</span> <span class="free">T2</span><span class="main">,</span> <span class="free">T3</span> <span class="main">{&gt;</span> <span class="free">R2</span><span class="main">}</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="main">{</span><span class="free">R1</span> <span class="keyword1">O</span> <span class="free">R2</span><span class="main">}</span> <span class="free">T1</span><span class="main">,</span> <span class="free">T3</span> <span class="main">{&gt;</span> <span class="free">R1</span> <span class="keyword1">O</span> <span class="free">R2</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> subset_refl <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> relcomp_mono<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">R1</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> subset_refl <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> relcomp_mono<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">R2</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> O_assoc <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Conjunction in the post-relation cannot be split in general.  However, 
here are two useful special cases.  In the first case the abstract transtition 
relation is deterministic and in the second case one conjunct is a cartesian 
product of two state predicates.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> relhoare_conj_right_det<span class="main">:</span>                 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post1</span><span class="main">}</span><span class="main">;</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post2</span><span class="main">}</span><span class="main">;</span>
     single_valued <span class="free">Ra</span> <span class="main">⟧</span>                           <span class="comment1">― ‹only for deterministic <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Ra›</span></span>!›</span>
  <span class="main">⟹</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post1</span> <span class="main">∩</span> <span class="free">post2</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> single_valuedD <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> relhoare_conj_right_cartesian <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span>Domain <span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span> <span class="main">{&gt;</span> <span class="free">I</span><span class="main">}</span><span class="main">;</span> <span class="main">{</span>Range <span class="free">pre</span><span class="main">}</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">J</span><span class="main">}</span><span class="main">;</span>
     <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">×</span> <span class="free">J</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs PO_hoare_defs Domain_def Range_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Separate rule for cartesian products.›</span></span>

<span class="keyword1"><span class="command">corollary</span></span> relhoare_cartesian<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span>Domain <span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span> <span class="main">{&gt;</span> <span class="free">I</span><span class="main">}</span><span class="main">;</span> <span class="main">{</span>Range <span class="free">pre</span><span class="main">}</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">J</span><span class="main">}</span><span class="main">;</span>
     <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span> <span class="main">⟧</span>                      <span class="comment1">― ‹any post, including <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>UNIV›</span></span>!›</span>
  <span class="main">⟹</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">I</span> <span class="main">×</span> <span class="free">J</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> relhoare_conseq_right<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Unions of transition relations.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> relhoare_concrete_Un <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc1</span> <span class="main">∪</span> <span class="free">Rc2</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span> 
   <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc1</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span> <span class="main">∧</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc2</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> relhoare_concrete_UN <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="main">⋃</span><span class="bound">x</span><span class="main">.</span> <span class="free">Rc</span> <span class="bound">x</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="bound">x</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> relhoare_abstract_Un_left <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra1</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra1</span> <span class="main">∪</span> <span class="free">Ra2</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> relhoare_abstract_Un_right <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra2</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra1</span> <span class="main">∪</span> <span class="free">Ra2</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> relhoare_abstract_UN <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>   <span class="comment1">― ‹might be too aggressive?›</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span> <span class="free">x</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="main">⋃</span><span class="bound">x</span><span class="main">.</span> <span class="free">Ra</span> <span class="bound">x</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement proof obligations›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A transition system refines another one if the initial states and the
transitions are refined. 
Initial state refinement means that for each concrete initial state there is 
a related abstract one. Transition refinement means that the simulation 
relation is preserved (as expressed by a relational Hoare tuple). 
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">PO_refines</span> <span class="main">::</span> 
    <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span> set<span class="main">,</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> TS_scheme<span class="main">,</span> <span class="main">(</span><span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> TS_scheme<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">PO_refines</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span> <span class="free"><span class="bound"><span class="entity">Tc</span></span></span> <span class="main">≡</span> <span class="main">(</span>
       init <span class="free"><span class="bound"><span class="entity">Tc</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">``</span><span class="main">(</span>init <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">)</span>
     <span class="main">∧</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">}</span> <span class="main">(</span>trans <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans <span class="free"><span class="bound"><span class="entity">Tc</span></span></span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">}</span> 
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_refinesI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> init <span class="free">Tc</span> <span class="main">⊆</span> <span class="free">R</span><span class="main">``</span><span class="main">(</span>init <span class="free">Ta</span><span class="main">)</span><span class="main">;</span> <span class="main">{</span><span class="free">R</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">Ta</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans <span class="free">Tc</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">R</span><span class="main">}</span> <span class="main">⟧</span> <span class="main">⟹</span> PO_refines <span class="free">R</span> <span class="free">Ta</span> <span class="free">Tc</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_refines_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_refinesE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> PO_refines <span class="free">R</span> <span class="free">Ta</span> <span class="free">Tc</span><span class="main">;</span> <span class="main">⟦</span> init <span class="free">Tc</span> <span class="main">⊆</span> <span class="free">R</span><span class="main">``</span><span class="main">(</span>init <span class="free">Ta</span><span class="main">)</span><span class="main">;</span> <span class="main">{</span><span class="free">R</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">Ta</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans <span class="free">Tc</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">R</span><span class="main">}</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> 
 <span class="main">⟹</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_refines_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Basic refinement rule. This is just an introduction rule for the
definition.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> refine_basic<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> init <span class="free">Tc</span> <span class="main">⊆</span> <span class="free">R</span><span class="main">``</span><span class="main">(</span>init <span class="free">Ta</span><span class="main">)</span><span class="main">;</span> <span class="main">{</span><span class="free">R</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">Ta</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans <span class="free">Tc</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">R</span><span class="main">}</span> <span class="main">⟧</span>
  <span class="main">⟹</span> PO_refines <span class="free">R</span> <span class="free">Ta</span> <span class="free">Tc</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_refines_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following proof rule uses individual invariants <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">I</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">J</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of the concrete and abstract systems to strengthen the 
simulation relation $R$. 

The hypotheses state that these state predicates are indeed invariants.
Note that the pre-condition of the invariant preservation hypotheses for 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">I</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">J</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are strengthened by adding the predicates 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Domain <span class="main"><span class="main">(</span></span><span class="free"><span class="free">R</span></span> <span class="main"><span class="main">∩</span></span> UNIV <span class="main"><span class="main">×</span></span> <span class="free"><span class="free">J</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Range <span class="main"><span class="main">(</span></span><span class="free"><span class="free">R</span></span> <span class="main"><span class="main">∩</span></span> <span class="free"><span class="free">I</span></span> <span class="main"><span class="main">×</span></span> UNIV<span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, 
respectively.  In particular, the latter predicate may be essential, if a 
concrete invariant depends on the simulation relation and an abstract invariant, 
i.e. to "transport" abstract invariants to the concrete system.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> refine_init_using_invariants<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> init <span class="free">Tc</span> <span class="main">⊆</span> <span class="free">R</span><span class="main">``</span><span class="main">(</span>init <span class="free">Ta</span><span class="main">)</span><span class="main">;</span> init <span class="free">Ta</span> <span class="main">⊆</span> <span class="free">I</span><span class="main">;</span> init <span class="free">Tc</span> <span class="main">⊆</span> <span class="free">J</span> <span class="main">⟧</span>
  <span class="main">⟹</span> init <span class="free">Tc</span> <span class="main">⊆</span> <span class="main">(</span><span class="free">R</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">×</span> <span class="free">J</span><span class="main">)</span><span class="main">``</span><span class="main">(</span>init <span class="free">Ta</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Image_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bspec subsetD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> refine_trans_using_invariants<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span><span class="free">R</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">×</span> <span class="free">J</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">Ta</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans <span class="free">Tc</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">R</span><span class="main">}</span><span class="main">;</span>
     <span class="main">{</span><span class="free">I</span> <span class="main">∩</span> Domain <span class="main">(</span><span class="free">R</span> <span class="main">∩</span> UNIV <span class="main">×</span> <span class="free">J</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">Ta</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">I</span><span class="main">}</span><span class="main">;</span> 
     <span class="main">{</span><span class="free">J</span> <span class="main">∩</span> Range <span class="main">(</span><span class="free">R</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">×</span> UNIV<span class="main">)</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">Tc</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">J</span><span class="main">}</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="main">{</span><span class="free">R</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">×</span> <span class="free">J</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">Ta</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans <span class="free">Tc</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">R</span>  <span class="main">∩</span> <span class="free">I</span> <span class="main">×</span> <span class="free">J</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> relhoare_conj_right_cartesian<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This is our main rule for refinements.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> refine_using_invariants<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span><span class="free">R</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">×</span> <span class="free">J</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">Ta</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans <span class="free">Tc</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">R</span><span class="main">}</span><span class="main">;</span>
     <span class="main">{</span><span class="free">I</span> <span class="main">∩</span> Domain <span class="main">(</span><span class="free">R</span> <span class="main">∩</span> UNIV <span class="main">×</span> <span class="free">J</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">Ta</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">I</span><span class="main">}</span><span class="main">;</span> 
     <span class="main">{</span><span class="free">J</span> <span class="main">∩</span> Range <span class="main">(</span><span class="free">R</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">×</span> UNIV<span class="main">)</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">Tc</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">J</span><span class="main">}</span><span class="main">;</span> 
     init <span class="free">Tc</span> <span class="main">⊆</span> <span class="free">R</span><span class="main">``</span><span class="main">(</span>init <span class="free">Ta</span><span class="main">)</span><span class="main">;</span> 
     init <span class="free">Ta</span> <span class="main">⊆</span> <span class="free">I</span><span class="main">;</span> init <span class="free">Tc</span> <span class="main">⊆</span> <span class="free">J</span> <span class="main">⟧</span>
  <span class="main">⟹</span> PO_refines <span class="main">(</span><span class="free">R</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">×</span> <span class="free">J</span><span class="main">)</span> <span class="free">Ta</span> <span class="free">Tc</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> PO_refines_def<span class="main">)</span>
   <span class="main">(</span><span class="operator">intro</span> refine_init_using_invariants refine_trans_using_invariants conjI<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Deriving invariants from refinements›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Some invariants can only be proved after the simulation has been 
established, because they depend on the simulation relation and some abstract
invariants.  Here is a rule to derive invariant theorems from the refinement.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_refines_implies_Range_init<span class="main">:</span>
  <span class="quoted"><span class="quoted">"PO_refines <span class="free">R</span> <span class="free">Ta</span> <span class="free">Tc</span> <span class="main">⟹</span> init <span class="free">Tc</span> <span class="main">⊆</span> Range <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_refines_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_refines_implies_Range_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"PO_refines <span class="free">R</span> <span class="free">Ta</span> <span class="free">Tc</span> <span class="main">⟹</span> <span class="main">{</span>Range <span class="free">R</span><span class="main">}</span> trans <span class="free">Tc</span> <span class="main">{&gt;</span> Range <span class="free">R</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_refines_def PO_rhoare_def PO_hoare_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_refines_implies_Range_invariant<span class="main">:</span>
  <span class="quoted"><span class="quoted">"PO_refines <span class="free">R</span> <span class="free">Ta</span> <span class="free">Tc</span> <span class="main">⟹</span> reach <span class="free">Tc</span> <span class="main">⊆</span> Range <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> INV_rule<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_refines_implies_Range_init 
                 PO_refines_implies_Range_trans<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following rules are more useful in proofs.›</span></span>

<span class="keyword1"><span class="command">corollary</span></span> INV_init_from_refinement<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> PO_refines <span class="free">R</span> <span class="free">Ta</span> <span class="free">Tc</span><span class="main">;</span> Range <span class="free">R</span> <span class="main">⊆</span> <span class="free">I</span> <span class="main">⟧</span>
  <span class="main">⟹</span> init <span class="free">Tc</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> PO_refines_implies_Range_init<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> INV_trans_from_refinement<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> PO_refines <span class="free">R</span> <span class="free">Ta</span> <span class="free">Tc</span><span class="main">;</span> <span class="free">K</span> <span class="main">⊆</span> Range <span class="free">R</span><span class="main">;</span> Range <span class="free">R</span> <span class="main">⊆</span> <span class="free">I</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="main">{</span><span class="free">K</span><span class="main">}</span> trans <span class="free">Tc</span> <span class="main">{&gt;</span> <span class="free">I</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> PO_refines_implies_Range_trans<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> hoare_conseq_right<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">corollary</span></span> INV_from_refinement<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> PO_refines <span class="free">R</span> <span class="free">Ta</span> <span class="free">Tc</span><span class="main">;</span> Range <span class="free">R</span> <span class="main">⊆</span> <span class="free">I</span> <span class="main">⟧</span>
  <span class="main">⟹</span> reach <span class="free">Tc</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> PO_refines_implies_Range_invariant<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement of specifications›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lift relation membership to finite sequences›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> 
  <span class="entity">seq_lift</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> list <span class="main">×</span> <span class="tfree">'t</span> list<span class="main">)</span> set"</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  sl_nil <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">seq_lift</span> <span class="free">R</span>"</span></span>
<span class="main">|</span> sl_cons <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">seq_lift</span> <span class="free">R</span><span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">seq_lift</span> <span class="free">R</span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> sl_cons_right_invert<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ba'</span><span class="main">,</span> <span class="free">t</span> <span class="main">#</span> <span class="free">bc</span><span class="main">)</span> <span class="main">∈</span> seq_lift <span class="free">R</span>"</span></span> 


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For each concrete behaviour there is a related abstract one.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> behaviour_refinement<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> PO_refines <span class="free">R</span> <span class="free">Ta</span> <span class="free">Tc</span><span class="main">;</span> <span class="free">bc</span> <span class="main">∈</span> beh <span class="free">Tc</span><span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">∃</span><span class="bound">ba</span> <span class="main">∈</span> beh <span class="free">Ta</span><span class="main">.</span> <span class="main">(</span><span class="bound">ba</span><span class="main">,</span> <span class="free">bc</span><span class="main">)</span> <span class="main">∈</span> seq_lift <span class="free">R</span>"</span></span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> beh.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="comment1">― ‹case: singleton›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_refines_def Image_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> subsetD<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

  <span class="comment1">― ‹case: cons; first construct related abstract state›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> sl_cons_right_invert<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> s bc s' ba t<span class="main">)</span>
  <span class="comment1">― ‹now construct abstract transition›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_refines_def PO_rhoare_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">thin_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆</span> <span class="skolem">Y</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">X</span> <span class="skolem">Y</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> subsetD<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Observation consistency of a relation is defined using a mediator 
function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">pi</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to abstract the concrete observation.  This allows us 
to also refine the observables as we move down a refinement branch.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">obs_consistent</span> <span class="main">::</span> 
    <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span> set<span class="main">,</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'o</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'o</span><span class="main">)</span> spec<span class="main">,</span> <span class="main">(</span><span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">)</span> spec<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">obs_consistent</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">pi</span></span></span> <span class="free"><span class="bound"><span class="entity">Sa</span></span></span> <span class="free"><span class="bound"><span class="entity">Sc</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">pi</span></span></span> <span class="main">(</span>obs <span class="free"><span class="bound"><span class="entity">Sc</span></span></span> <span class="bound">t</span><span class="main">)</span> <span class="main">=</span> obs <span class="free"><span class="bound"><span class="entity">Sa</span></span></span> <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> obs_consistent_refl <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"obs_consistent Id id <span class="free">S</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> obs_consistent_trans <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> obs_consistent <span class="free">R1</span> <span class="free">pi1</span> <span class="free">S1</span> <span class="free">S2</span><span class="main">;</span> obs_consistent <span class="free">R2</span> <span class="free">pi2</span> <span class="free">S2</span> <span class="free">S3</span> <span class="main">⟧</span>
  <span class="main">⟹</span> obs_consistent <span class="main">(</span><span class="free">R1</span> <span class="keyword1">O</span> <span class="free">R2</span><span class="main">)</span> <span class="main">(</span><span class="free">pi1</span> <span class="keyword1">o</span> <span class="free">pi2</span><span class="main">)</span> <span class="free">S1</span> <span class="free">S3</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> obs_consistent_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"obs_consistent <span class="main">{}</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> obs_consistent_conj1 <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"obs_consistent <span class="free">R</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span> <span class="main">⟹</span> obs_consistent <span class="main">(</span><span class="free">R</span> <span class="main">∩</span> <span class="free">R'</span><span class="main">)</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> obs_consistent_conj2 <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"obs_consistent <span class="free">R</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span> <span class="main">⟹</span> obs_consistent <span class="main">(</span><span class="free">R'</span> <span class="main">∩</span> <span class="free">R</span><span class="main">)</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> obs_consistent_behaviours<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> obs_consistent <span class="free">R</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span><span class="main">;</span> <span class="free">bc</span> <span class="main">∈</span> beh <span class="free">Sc</span><span class="main">;</span> <span class="free">ba</span> <span class="main">∈</span> beh <span class="free">Sa</span><span class="main">;</span> <span class="main">(</span><span class="free">ba</span><span class="main">,</span> <span class="free">bc</span><span class="main">)</span> <span class="main">∈</span> seq_lift <span class="free">R</span><span class="main">⟧</span>
  <span class="main">⟹</span> map <span class="free">pi</span> <span class="main">(</span>map <span class="main">(</span>obs <span class="free">Sc</span><span class="main">)</span> <span class="free">bc</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span>obs <span class="free">Sa</span><span class="main">)</span> <span class="free">ba</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> seq_lift.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def<span class="main">)</span> 


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Definition of refinement proof obligations.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">refines</span> <span class="main">::</span> 
    <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span> set<span class="main">,</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'o</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'o</span><span class="main">)</span> spec<span class="main">,</span> <span class="main">(</span><span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">)</span> spec<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">refines</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">pi</span></span></span> <span class="free"><span class="bound"><span class="entity">Sa</span></span></span> <span class="free"><span class="bound"><span class="entity">Sc</span></span></span> <span class="main">≡</span> obs_consistent <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">pi</span></span></span> <span class="free"><span class="bound"><span class="entity">Sa</span></span></span> <span class="free"><span class="bound"><span class="entity">Sc</span></span></span> <span class="main">∧</span> PO_refines <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">Sa</span></span></span> <span class="free"><span class="bound"><span class="entity">Sc</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> refines_defs <span class="main">=</span> 
  refines_def PO_refines_def

<span class="keyword1"><span class="command">lemma</span></span> refinesI<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> PO_refines <span class="free">R</span> <span class="free">Sa</span> <span class="free">Sc</span><span class="main">;</span> obs_consistent <span class="free">R</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span> <span class="main">⟧</span>
  <span class="main">⟹</span> refines <span class="free">R</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refines_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> refinesE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> refines <span class="free">R</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span><span class="main">;</span> <span class="main">⟦</span> PO_refines <span class="free">R</span> <span class="free">Sa</span> <span class="free">Sc</span><span class="main">;</span> obs_consistent <span class="free">R</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refines_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Reflexivity and transitivity of refinement.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> refinement_reflexive<span class="main">:</span> <span class="quoted"><span class="quoted">"refines Id id <span class="free">S</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refines_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> refinement_transitive<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> refines <span class="free">R1</span> <span class="free">pi1</span> <span class="free">S1</span> <span class="free">S2</span><span class="main">;</span> refines <span class="free">R2</span> <span class="free">pi2</span> <span class="free">S2</span> <span class="free">S3</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> refines <span class="main">(</span><span class="free">R1</span> <span class="keyword1">O</span> <span class="free">R2</span><span class="main">)</span> <span class="main">(</span><span class="free">pi1</span> <span class="keyword1">o</span> <span class="free">pi2</span><span class="main">)</span> <span class="free">S1</span> <span class="free">S3</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refines_defs <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI
            <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rhoare_trans<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Image_mono<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Soundness of refinement for proving implementation›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> observable_behaviour_refinement<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> refines <span class="free">R</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span><span class="main">;</span> <span class="free">bc</span> <span class="main">∈</span> obeh <span class="free">Sc</span> <span class="main">⟧</span> <span class="main">⟹</span> map <span class="free">pi</span> <span class="free">bc</span> <span class="main">∈</span> obeh <span class="free">Sa</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refines_def obeh_def image_def
         <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> behaviour_refinement obs_consistent_behaviours<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> refinement_soundness<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"refines <span class="free">R</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span> <span class="main">⟹</span> implements <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> implements_def 
         <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> observable_behaviour_refinement<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Extended versions of refinement proof rules including observations›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> Refinement_basic <span class="main">=</span> refine_basic <span class="main">[</span><span class="operator">THEN</span> refinesI<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> Refinement_using_invariants <span class="main">=</span> refine_using_invariants <span class="main">[</span><span class="operator">THEN</span> refinesI<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> refines_reachable_strengthening<span class="main">:</span>
  <span class="quoted"><span class="quoted">"refines <span class="free">R</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span> <span class="main">⟹</span> refines <span class="main">(</span><span class="free">R</span> <span class="main">∩</span> reach <span class="free">Sa</span> <span class="main">×</span> reach <span class="free">Sc</span><span class="main">)</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Refinement_using_invariants<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Inhertitance of internal invariants through refinements›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> INV_init_from_Refinement<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>refines <span class="free">R</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span><span class="main">;</span> Range <span class="free">R</span> <span class="main">⊆</span> <span class="free">I</span><span class="main">⟧</span> <span class="main">⟹</span> init <span class="free">Sc</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> INV_init_from_refinement<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> INV_trans_from_Refinement<span class="main">:</span>
  <span class="quoted"><span class="quoted">" <span class="main">⟦</span>refines <span class="free">R</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span><span class="main">;</span> <span class="free">K</span> <span class="main">⊆</span> Range <span class="free">R</span><span class="main">;</span> Range <span class="free">R</span> <span class="main">⊆</span> <span class="free">I</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">{</span><span class="free">K</span><span class="main">}</span> TS.trans <span class="free">Sc</span> <span class="main">{&gt;</span> <span class="free">I</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> INV_trans_from_refinement<span class="main">)</span> 


<span class="keyword1"><span class="command">lemma</span></span> INV_from_Refinement_basic<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> refines <span class="free">R</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span><span class="main">;</span> Range <span class="free">R</span> <span class="main">⊆</span> <span class="free">I</span> <span class="main">⟧</span> <span class="main">⟹</span> reach <span class="free">Sc</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> INV_from_refinement<span class="main">)</span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> INV_from_Refinement_using_invariants<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"refines <span class="free">R</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span>"</span></span> <span class="quoted"><span class="quoted">"Range <span class="main">(</span><span class="free">R</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">×</span> <span class="free">J</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">K</span>"</span></span>   <span class="comment1">― ‹EQUIV: <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>R``I ∩ J›</span></span>›</span>
          <span class="quoted"><span class="quoted">"reach <span class="free">Sa</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"reach <span class="free">Sc</span> <span class="main">⊆</span> <span class="free">J</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"reach <span class="free">Sc</span> <span class="main">⊆</span> <span class="free">K</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> INV_from_Refinement_basic<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"refines <span class="main">(</span><span class="free">R</span> <span class="main">∩</span> reach <span class="free">Sa</span> <span class="main">×</span> reach <span class="free">Sc</span><span class="main">)</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refines_reachable_strengthening<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Range <span class="main">(</span><span class="free">R</span> <span class="main">∩</span> reach <span class="free">Sa</span> <span class="main">×</span> reach <span class="free">Sc</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">K</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2-4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Agents">
<div class="head">
<h1>Theory Agents</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Development of Security Protocols by Refinement

  Module:  Refinement/Agents.thy (Isabelle/HOL 2016-1)
  ID:      $Id: Agents.thy 133854 2017-03-20 17:53:50Z csprenge $
  Author:  Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;

  Agents and nonces (partly based on Paulson's Message.thy)

  Copyright (c) 2009-2016 Christoph Sprenger 
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Atomic messages›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Agents <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The definitions below are moved here from the message theory, since
the higher levels of protocol abstraction do not know about cryptographic 
messages.›</span></span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Agents›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">datatype</span></span>  <span class="comment1">― ‹We allow any number of agents plus an honest server.›</span>
  agent <span class="main">=</span> Server <span class="main">|</span> Agent <span class="quoted">nat</span>

<span class="keyword1"><span class="command">consts</span></span> 
  bad <span class="main">::</span> <span class="quoted"><span class="quoted">"agent set"</span></span>			      <span class="comment1">― ‹compromised agents›</span>

<span class="keyword1"><span class="command">specification</span></span> <span class="main">(</span><span class="quoted">bad</span><span class="main">)</span>
  Server_not_bad <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Server <span class="main">∉</span> bad"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{</span></span></span>Agent <span class="main"><span class="main"><span class="main">0</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="entity">good</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">good</span> <span class="main">≡</span> <span class="main">-</span>bad"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="entity">Sv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Sv</span> <span class="main">≡</span> Server"</span></span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Nonces›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We have an unspecified type of freshness identifiers. 
For executability, we may need to assume that this type is infinite.›</span></span>

<span class="keyword1"><span class="command">typedecl</span></span> fid_t

<span class="keyword1"><span class="command">datatype</span></span> fresh_t <span class="main">=</span> 
  mk_fresh <span class="quoted"><span class="quoted">"fid_t"</span></span> <span class="quoted"><span class="quoted">"nat"</span></span>      <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">$</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 65<span class="main">)</span> 

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fid</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"fresh_t <span class="main">⇒</span> fid_t"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fid</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">num</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"fresh_t <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">num</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Nonces›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> 
  nonce <span class="main">=</span> <span class="quoted"><span class="quoted">"fresh_t"</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Keys">
<div class="head">
<h1>Theory Keys</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************  

  Project: Development of Security Protocols by Refinement

  Module:  Refinement/Keys.thy (Isabelle/HOL 2016-1)
  ID:      $Id: Keys.thy 132773 2016-12-09 15:30:22Z csprenge $
  Author:  Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  Symmetric (shared) and asymmetric (public/private) keys.
  (based on Larry Paulson's theory Public.thy)

  Copyright (c) 2012-2016 Christoph Sprenger 
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Symmetric and Assymetric Keys›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Keys <span class="keyword2"><span class="keyword">imports</span></span> <a href="Agents.html">Agents</a> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Divide keys into session and long-term keys. Define different kinds
of long-term keys in second step.›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> ltkey <span class="main">=</span>    <span class="comment1">― ‹long-term keys›</span>
  sharK <span class="quoted"><span class="quoted">"agent"</span></span>     <span class="comment1">― ‹key shared with server›</span>
<span class="main">|</span> publK <span class="quoted"><span class="quoted">"agent"</span></span>     <span class="comment1">― ‹agent's public key›</span>
<span class="main">|</span> privK <span class="quoted"><span class="quoted">"agent"</span></span>     <span class="comment1">― ‹agent's private key›</span>

<span class="keyword1"><span class="command">datatype</span></span> key <span class="main">=</span> 
  sesK <span class="quoted"><span class="quoted">"fresh_t"</span></span>   <span class="comment1">― ‹session key›</span>
<span class="main">|</span> ltK <span class="quoted"><span class="quoted">"ltkey"</span></span>      <span class="comment1">― ‹long-term key›</span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">shrK</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent <span class="main">⇒</span> key"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">shrK</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> ltK <span class="main">(</span>sharK <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">pubK</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent <span class="main">⇒</span> key"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pubK</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> ltK <span class="main">(</span>publK <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">priK</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent <span class="main">⇒</span> key"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">priK</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> ltK <span class="main">(</span>privK <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The inverse of a symmetric key is itself; that of a public key
       is the private key and vice versa›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">invKey</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"key <span class="main">⇒</span> key"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">invKey</span> <span class="main">(</span>ltK <span class="main">(</span>publK <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> priK <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">invKey</span> <span class="main">(</span>ltK <span class="main">(</span>privK <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> pubK <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">invKey</span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">K</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">symKeys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"key set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">symKeys</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">K</span><span class="main">.</span> invKey <span class="bound">K</span> <span class="main">=</span> <span class="bound">K</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> invKey_K<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">∈</span> symKeys <span class="main">⟹</span> invKey <span class="free">K</span> <span class="main">=</span> <span class="free">K</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> symKeys_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Most lemmas we need come for free with the inductive type definition:
injectiveness and distinctness.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> invKey_invKey_id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"invKey <span class="main">(</span>invKey <span class="free">K</span><span class="main">)</span> <span class="main">=</span> <span class="free">K</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">K</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
   <span class="main">(</span><span class="operator">rename_tac</span> ltk<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">ltk</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> invKey_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>invKey <span class="free">K</span> <span class="main">=</span> invKey <span class="free">K'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">K</span><span class="main">=</span><span class="free">K'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> f<span class="main"><span class="main">=</span></span><span class="quoted">invKey</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> arg_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We get most lemmas below for free from the inductive definition
of type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">key</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Many of these are just proved as a reality check.›</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Asymmetric Keys›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹No private key equals any public key (essential to ensure that private
keys are private!). A similar statement an axiom in Paulson's theory!›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> privateKey_neq_publicKey<span class="main">:</span> <span class="quoted"><span class="quoted">"priK <span class="free">A</span> <span class="main">≠</span> pubK <span class="free">A'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> publicKey_neq_privateKey<span class="main">:</span> <span class="quoted"><span class="quoted">"pubK <span class="free">A</span> <span class="main">≠</span> priK <span class="free">A'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Basic properties of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">pubK</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">priK</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> publicKey_inject <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>pubK <span class="free">A</span> <span class="main">=</span> pubK <span class="free">A'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">=</span> <span class="free">A'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> not_symKeys_pubK <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pubK <span class="free">A</span> <span class="main">∉</span> symKeys"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> symKeys_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> not_symKeys_priK <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"priK <span class="free">A</span> <span class="main">∉</span> symKeys"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> symKeys_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> symKey_neq_priK<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">∈</span> symKeys <span class="main">⟹</span> <span class="free">K</span> <span class="main">≠</span> priK <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> symKeys_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> symKeys_neq_imp_neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">K</span> <span class="main">∈</span> symKeys<span class="main">)</span> <span class="main">≠</span> <span class="main">(</span><span class="free">K'</span> <span class="main">∈</span> symKeys<span class="main">)</span> <span class="main">⟹</span> <span class="free">K</span> <span class="main">≠</span> <span class="free">K'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> symKeys_invKey_iff <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>invKey <span class="free">K</span> <span class="main">∈</span> symKeys<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">K</span> <span class="main">∈</span> symKeys<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> symKeys_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹"Image" equations that hold for injective functions›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> invKey_image_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>invKey <span class="free">x</span> <span class="main">∈</span> invKey<span class="main">`</span><span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(*holds because invKey is injective*)</span>

<span class="keyword1"><span class="command">lemma</span></span> invKey_pubK_image_priK_image <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"invKey <span class="main">`</span> pubK <span class="main">`</span> <span class="free">AS</span> <span class="main">=</span> priK <span class="main">`</span> <span class="free">AS</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> publicKey_notin_image_privateKey<span class="main">:</span> <span class="quoted"><span class="quoted">"pubK <span class="free">A</span> <span class="main">∉</span> priK <span class="main">`</span> <span class="free">AS</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> privateKey_notin_image_publicKey<span class="main">:</span> <span class="quoted"><span class="quoted">"priK <span class="free">x</span> <span class="main">∉</span> pubK <span class="main">`</span> <span class="free">AA</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> publicKey_image_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>pubK <span class="free">x</span> <span class="main">∈</span> pubK <span class="main">`</span> <span class="free">AA</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">∈</span> <span class="free">AA</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> privateKey_image_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>priK <span class="free">A</span> <span class="main">∈</span> priK <span class="main">`</span> <span class="free">AS</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">∈</span> <span class="free">AS</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>



<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Symmetric Keys›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following was stated as an axiom in Paulson's theory.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sym_sesK<span class="main">:</span> <span class="quoted"><span class="quoted">"sesK <span class="free">f</span> <span class="main">∈</span> symKeys"</span></span>   <span class="comment1">― ‹All session keys are symmetric›</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> symKeys_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sym_shrK<span class="main">:</span> <span class="quoted"><span class="quoted">"shrK <span class="free">X</span> <span class="main">∈</span> symKeys"</span></span>   <span class="comment1">― ‹All shared keys are symmetric›</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> symKeys_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Symmetric keys and inversion›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> symK_eq_invKey<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">SK</span> <span class="main">=</span> invKey <span class="free">K</span><span class="main">;</span> <span class="free">SK</span> <span class="main">∈</span> symKeys <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">K</span> <span class="main">=</span> <span class="free">SK</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> symKeys_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Image-related lemmas.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> publicKey_notin_image_shrK<span class="main">:</span> <span class="quoted"><span class="quoted">"pubK <span class="free">x</span> <span class="main">∉</span> shrK <span class="main">`</span> <span class="free">AA</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> privateKey_notin_image_shrK<span class="main">:</span> <span class="quoted"><span class="quoted">"priK <span class="free">x</span> <span class="main">∉</span> shrK <span class="main">`</span> <span class="free">AA</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> shrK_notin_image_publicKey<span class="main">:</span> <span class="quoted"><span class="quoted">"shrK <span class="free">x</span> <span class="main">∉</span> pubK <span class="main">`</span> <span class="free">AA</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> shrK_notin_image_privateKey<span class="main">:</span> <span class="quoted"><span class="quoted">"shrK <span class="free">x</span> <span class="main">∉</span> priK <span class="main">`</span> <span class="free">AA</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sesK_notin_image_shrK <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sesK <span class="free">K</span> <span class="main">∉</span> shrK<span class="main">`</span><span class="free">AA</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> shrK_notin_image_sesK <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"shrK <span class="free">K</span> <span class="main">∉</span> sesK<span class="main">`</span><span class="free">AA</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sesK_image_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sesK <span class="free">x</span> <span class="main">∈</span> sesK <span class="main">`</span> <span class="free">AA</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">∈</span> <span class="free">AA</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> shrK_image_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>shrK <span class="free">x</span> <span class="main">∈</span> shrK <span class="main">`</span> <span class="free">AA</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">∈</span> <span class="free">AA</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword2"><span class="keyword">end</span></span>


</pre>
</div><div id="Atoms">
<div class="head">
<h1>Theory Atoms</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Development of Security Protocols by Refinement

  Module:  Refinement/Atoms.thy (Isabelle/HOL 2016-1)
  ID:      $Id: Atoms.thy 132773 2016-12-09 15:30:22Z csprenge $
  Author:  Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  Atomic messages for L1-L2 protocols

  Copyright (c) 2009-2016 Christoph Sprenger 
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Atomic messages›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Atoms <span class="keyword2"><span class="keyword">imports</span></span> <a href="Keys.html">Keys</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Atoms datatype›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">datatype</span></span> atom <span class="main">=</span>
  aAgt <span class="quoted"><span class="quoted">"agent"</span></span> 
<span class="main">|</span> aNon <span class="quoted"><span class="quoted">"nonce"</span></span>
<span class="main">|</span> aKey <span class="quoted"><span class="quoted">"key"</span></span>
<span class="main">|</span> aNum <span class="quoted"><span class="quoted">"nat"</span></span> 


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Long-term key setup (abstractly)›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Suppose an initial long-term key setup without looking into the 
structure of long-term keys. 

Remark: This setup is agnostic with respect to the structure of the
type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"ltkey"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Ideally, the type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"ltkey"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> should be a
parameter of the type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"key"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, which is instantiated only at
Level 3.›</span></span>

<span class="keyword1"><span class="command">consts</span></span>
  ltkeySetup <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ltkey <span class="main">×</span> agent<span class="main">)</span> set"</span></span>  <span class="comment1">― ‹LT key setup, for now unspecified›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The initial key setup contains static, long-term keys.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">keySetup</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>key <span class="main">×</span> agent<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">keySetup</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span>ltK <span class="bound">K</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span> <span class="main">|</span> <span class="bound">K</span> <span class="bound">A</span><span class="main">.</span> <span class="main">(</span><span class="bound">K</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span> <span class="main">∈</span> ltkeySetup<span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Corrupted keys are the long-term keys known by bad agents.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">corrKey</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"key set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">corrKey</span> <span class="main">≡</span> keySetup<span class="main">¯</span> <span class="main">``</span> bad"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> corrKey_Dom_keySetup <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">∈</span> corrKey <span class="main">⟹</span> <span class="free">K</span> <span class="main">∈</span> Domain keySetup"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> corrKey_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> keySetup_noSessionKeys <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sesK <span class="free">K</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∉</span> keySetup"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> keySetup_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> corrKey_noSessionKeys <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sesK <span class="free">K</span> <span class="main">∉</span> corrKey"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> keySetup_def corrKey_def<span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Runs">
<div class="head">
<h1>Theory Runs</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Development of Security Protocols by Refinement

  Module:  Refinement/Runs.thy (Isabelle/HOL 2016-1)
  ID:      $Id: Runs.thy 132773 2016-12-09 15:30:22Z csprenge $
  Author:  Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  Protocol runs: local state of executing protocol roles

  Copyright (c) 2010-2016 Christoph Sprenger 
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Protocol runs›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Runs <span class="keyword2"><span class="keyword">imports</span></span> <a href="Atoms.html">Atoms</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Runs›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Define some typical roles.›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> role_t <span class="main">=</span> Init <span class="main">|</span> Resp <span class="main">|</span> Serv

<span class="keyword1"><span class="command">fun</span></span> 
  <span class="entity">roleIdx</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"role_t <span class="main">⇒</span> nat"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">roleIdx</span> Init <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">roleIdx</span> Resp <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">roleIdx</span> Serv <span class="main">=</span> <span class="numeral">2</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The type of runs is a partial function from run identifiers to 
a triple consisting of a role, a list of agents, and a list of atomic messages 
recorded during the run's execution. 

The type of roles could be made a parameter for more flexibility.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  rid_t <span class="main">=</span> <span class="quoted"><span class="quoted">"fid_t"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  runs_t <span class="main">=</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇀</span> role_t <span class="main">×</span> agent list <span class="main">×</span> atom list"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Run abstraction›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Define a function that lifts a function on roles and atom lists 
to a function on runs.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">map_runs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span>role_t<span class="main">,</span> atom list<span class="main">]</span> <span class="main">⇒</span> atom list<span class="main">)</span> <span class="main">⇒</span> runs_t <span class="main">⇒</span> runs_t"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">map_runs</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="free"><span class="bound"><span class="entity">rid</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="free"><span class="bound"><span class="entity">rid</span></span></span> <span class="keyword1">of</span>
     None <span class="main">⇒</span> None
   <span class="main">|</span> Some <span class="main">(</span><span class="bound">rol</span><span class="main">,</span> <span class="bound">agts</span><span class="main">,</span> <span class="bound">al</span><span class="main">)</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="bound">rol</span><span class="main">,</span> <span class="bound">agts</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="bound">rol</span> <span class="bound">al</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_runs_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_runs <span class="free">h</span> Map.empty <span class="main">=</span> Map.empty"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_runs_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_runs_dom <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span>map_runs <span class="free">h</span> <span class="free">runz</span><span class="main">)</span> <span class="main">=</span> dom <span class="free">runz</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_runs_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_runs_update <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_runs <span class="free">h</span> <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">R</span> <span class="main">↦</span> <span class="main">(</span><span class="free">rol</span><span class="main">,</span> <span class="free">agts</span><span class="main">,</span> <span class="free">al</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
   <span class="main">=</span> <span class="main">(</span>map_runs <span class="free">h</span> <span class="free">runz</span><span class="main">)</span><span class="main">(</span><span class="free">R</span> <span class="main">↦</span> <span class="main">(</span><span class="free">rol</span><span class="main">,</span> <span class="free">agts</span><span class="main">,</span> <span class="free">h</span> <span class="free">rol</span> <span class="free">al</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_runs_def<span class="main">)</span>



<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Channels">
<div class="head">
<h1>Theory Channels</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Development of Security Protocols by Refinement

  Module:  Refinement/Channels.thy (Isabelle/HOL 2016-1)
  ID:      $Id: Channels.thy 132773 2016-12-09 15:30:22Z csprenge $
  Author:  Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  Channel messages for Level 2 protocols

  Copyright (c) 2009-2016 Christoph Sprenger 
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Channel Messages›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Channels <span class="keyword2"><span class="keyword">imports</span></span> <a href="Atoms.html">Atoms</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Channel messages›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">datatype</span></span> secprop <span class="main">=</span> auth <span class="main">|</span> confid

<span class="keyword1"><span class="command">type_synonym</span></span> 
  chtyp <span class="main">=</span> <span class="quoted"><span class="quoted">"secprop set"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="entity">secure</span> <span class="main">::</span> <span class="quoted">chtyp</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">secure</span> <span class="main">≡</span> <span class="main">{</span>auth<span class="main">,</span> confid<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> payload <span class="main">=</span> Msg <span class="quoted"><span class="quoted">"atom list"</span></span>
 
<span class="keyword1"><span class="command">datatype</span></span> chmsg <span class="main">=</span> 
  StatCh <span class="quoted"><span class="quoted">"chtyp"</span></span> <span class="quoted"><span class="quoted">"agent"</span></span> <span class="quoted"><span class="quoted">"agent"</span></span> <span class="quoted"><span class="quoted">"payload"</span></span>
<span class="main">|</span> DynCh <span class="quoted"><span class="quoted">"chtyp"</span></span> <span class="quoted"><span class="quoted">"key"</span></span> <span class="quoted"><span class="quoted">"payload"</span></span> 


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Abbreviations for use in protocol defs›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="entity">Insec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>agent<span class="main">,</span> agent<span class="main">,</span> payload<span class="main">]</span> <span class="main">⇒</span> chmsg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Insec</span> <span class="main">≡</span> StatCh <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="entity">Confid</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>agent<span class="main">,</span> agent<span class="main">,</span> payload<span class="main">]</span> <span class="main">⇒</span> chmsg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Confid</span> <span class="main">≡</span> StatCh <span class="main">{</span>confid<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="entity">Auth</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>agent<span class="main">,</span> agent<span class="main">,</span> payload<span class="main">]</span> <span class="main">⇒</span> chmsg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Auth</span> <span class="main">≡</span> StatCh <span class="main">{</span>auth<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="entity">Secure</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>agent<span class="main">,</span> agent<span class="main">,</span> payload<span class="main">]</span> <span class="main">⇒</span> chmsg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Secure</span> <span class="main">≡</span> StatCh <span class="main">{</span>auth<span class="main">,</span> confid<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="entity">dConfid</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>key<span class="main">,</span> payload<span class="main">]</span> <span class="main">⇒</span> chmsg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dConfid</span> <span class="main">≡</span> DynCh <span class="main">{</span>confid<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="entity">dAuth</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>key<span class="main">,</span> payload<span class="main">]</span> <span class="main">⇒</span> chmsg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dAuth</span> <span class="main">≡</span> DynCh <span class="main">{</span>auth<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="entity">dSecure</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>key<span class="main">,</span> payload<span class="main">]</span> <span class="main">⇒</span> chmsg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dSecure</span> <span class="main">≡</span> DynCh <span class="main">{</span>auth<span class="main">,</span> confid<span class="main">}</span>"</span></span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Keys used in dynamic channel messages›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">keys_for</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"chmsg set <span class="main">⇒</span> key set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">keys_for</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">K</span><span class="main">.</span> <span class="main">∃</span><span class="bound">c</span> <span class="bound">M</span><span class="main">.</span> DynCh <span class="bound">c</span> <span class="bound">K</span> <span class="bound">M</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> keys_forI <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"DynCh <span class="free">c</span> <span class="free">K</span> <span class="free">M</span> <span class="main">∈</span> <span class="free">H</span> <span class="main">⟹</span> <span class="free">K</span> <span class="main">∈</span> keys_for <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> keys_for_def<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> keys_for_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"keys_for <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> keys_for_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> keys_for_monotone<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">⊆</span> <span class="free">H</span> <span class="main">⟹</span> keys_for <span class="free">G</span> <span class="main">⊆</span> keys_for <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> keys_for_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> keys_for_mono <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> keys_for_monotone <span class="main">[</span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main">]</span>


<span class="keyword1"><span class="command">lemma</span></span> keys_for_insert_StatCh <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"keys_for <span class="main">(</span>insert <span class="main">(</span>StatCh <span class="free">c</span> <span class="free">A</span> <span class="free">B</span> <span class="free">M</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> keys_for <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> keys_for_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> keys_for_insert_DynCh <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"keys_for <span class="main">(</span>insert <span class="main">(</span>DynCh <span class="free">c</span> <span class="free">K</span> <span class="free">M</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> insert <span class="free">K</span> <span class="main">(</span>keys_for <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> keys_for_def<span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Atoms in a set of channel messages›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The set of atoms contained in a set of channel messages. We also 
include the public atoms, i.e., the agent names, numbers, and corrupted keys. 
›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> 
  <span class="entity">atoms</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"chmsg set <span class="main">⇒</span> atom set"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">H</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"chmsg set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  at_StatCh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> StatCh <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Msg <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">H</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">At</span></span></span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">At</span></span></span> <span class="main">∈</span> <span class="free">atoms</span> <span class="free">H</span>"</span></span>
<span class="main">|</span> at_DynCh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> DynCh <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">(</span>Msg <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">H</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">At</span></span></span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">At</span></span></span> <span class="main">∈</span> <span class="free">atoms</span> <span class="free">H</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> atoms.intros <span class="main">[</span><span class="operator">intro</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> atoms_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"atoms <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> atoms.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> atoms_monotone<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">⊆</span> <span class="free">H</span> <span class="main">⟹</span> atoms <span class="free">G</span> <span class="main">⊆</span> atoms <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> atoms.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> atoms_mono <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> atoms_monotone <span class="main">[</span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main">]</span>


<span class="keyword1"><span class="command">lemma</span></span> atoms_insert_StatCh <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"atoms <span class="main">(</span>insert <span class="main">(</span>StatCh <span class="free">c</span> <span class="free">A</span> <span class="free">B</span> <span class="main">(</span>Msg <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> set <span class="free">M</span> <span class="main">∪</span> atoms <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> atoms.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> atoms_insert_DynCh <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"atoms <span class="main">(</span>insert <span class="main">(</span>DynCh <span class="free">c</span> <span class="free">K</span> <span class="main">(</span>Msg <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> set <span class="free">M</span> <span class="main">∪</span> atoms <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> atoms.cases<span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Intruder knowledge (atoms)›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Atoms that the intruder can extract from a set of channel messages.›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> 
  <span class="entity">extr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"atom set <span class="main">⇒</span> chmsg set <span class="main">⇒</span> atom set"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">T</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"atom set"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">H</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"chmsg set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  extr_Inj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">At</span></span></span> <span class="main">∈</span> <span class="free">T</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">At</span></span></span> <span class="main">∈</span> <span class="free">extr</span> <span class="free">T</span> <span class="free">H</span>"</span></span>
<span class="main">|</span> extr_StatCh<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> StatCh <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Msg <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">H</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">At</span></span></span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">;</span> confid <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∈</span> bad <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∈</span> bad <span class="main">⟧</span> 
   <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">At</span></span></span> <span class="main">∈</span> <span class="free">extr</span> <span class="free">T</span> <span class="free">H</span>"</span></span>
<span class="main">|</span> extr_DynCh<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> DynCh <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">(</span>Msg <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">H</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">At</span></span></span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">;</span> confid <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">∨</span> aKey <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">∈</span> <span class="free">extr</span> <span class="free">T</span> <span class="free">H</span> <span class="main">⟧</span> 
   <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">At</span></span></span> <span class="main">∈</span> <span class="free">extr</span> <span class="free">T</span> <span class="free">H</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> extr.intros <span class="main">[</span><span class="operator">intro</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> extr.cases <span class="main">[</span><span class="operator">elim</span><span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Typical parameter describing initial intruder knowledge.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">ik0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"atom set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">ik0</span> <span class="main">≡</span> range aAgt <span class="main">∪</span> range aNum <span class="main">∪</span> aKey<span class="main">`</span>corrKey"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ik0_aAgt <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"aAgt <span class="free">A</span> <span class="main">∈</span> ik0"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ik0_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ik0_aNum <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"aNum <span class="free">T</span> <span class="main">∈</span> ik0"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ik0_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ik0_aNon <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"aNon <span class="free">N</span> <span class="main">∉</span> ik0"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ik0_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ik0_aKey_corr <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>aKey <span class="free">K</span> <span class="main">∈</span> ik0<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">K</span> <span class="main">∈</span> corrKey<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ik0_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Basic lemmas›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> extr_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"extr <span class="free">T</span> <span class="main">{}</span> <span class="main">=</span> <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> extr_monotone <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">⊆</span> <span class="free">H</span> <span class="main">⟹</span> extr <span class="free">T</span> <span class="free">G</span> <span class="main">⊆</span> extr <span class="free">T</span> <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> extr.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> extr_mono <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> extr_monotone <span class="main">[</span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> extr_monotone_param <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">⊆</span> <span class="free">U</span> <span class="main">⟹</span> extr <span class="free">T</span> <span class="free">H</span> <span class="main">⊆</span> extr <span class="free">U</span> <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> extr.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> extr_mono_param <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> extr_monotone_param <span class="main">[</span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> extr_insert <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">At</span> <span class="main">∈</span> extr <span class="free">T</span> <span class="free">H</span> <span class="main">⟹</span> <span class="free">At</span> <span class="main">∈</span> extr <span class="free">T</span> <span class="main">(</span>insert <span class="free">C</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> extr_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> extr_into_atoms <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">At</span> <span class="main">∈</span> extr <span class="free">T</span> <span class="free">H</span> <span class="main">⟹</span> <span class="free">At</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">∪</span> atoms <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> extr.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Insertion lemmas for atom parameters›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> extr_insert_non_key_param <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">At</span> <span class="main">∈</span> range aNon <span class="main">∪</span> range aAgt <span class="main">∪</span> range aNum"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"extr <span class="main">(</span>insert <span class="free">At</span> <span class="free">T</span><span class="main">)</span> <span class="free">H</span> <span class="main">=</span> insert <span class="free">At</span> <span class="main">(</span>extr <span class="free">T</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Bt</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Bt</span> <span class="main">∈</span> extr <span class="main">(</span>insert <span class="free">At</span> <span class="free">T</span><span class="main">)</span> <span class="free">H</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Bt</span> <span class="main">∈</span> insert <span class="free">At</span> <span class="main">(</span>extr <span class="free">T</span> <span class="free">H</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> extr_insert_unused_key_param <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">∉</span> keys_for <span class="free">H</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"extr <span class="main">(</span>insert <span class="main">(</span>aKey <span class="free">K</span><span class="main">)</span> <span class="free">T</span><span class="main">)</span> <span class="free">H</span> <span class="main">=</span> insert <span class="main">(</span>aKey <span class="free">K</span><span class="main">)</span> <span class="main">(</span>extr <span class="free">T</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">At</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">At</span> <span class="main">∈</span> extr <span class="main">(</span>insert <span class="main">(</span>aKey <span class="free">K</span><span class="main">)</span> <span class="free">T</span><span class="main">)</span> <span class="free">H</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">At</span> <span class="main">∈</span> insert <span class="main">(</span>aKey <span class="free">K</span><span class="main">)</span> <span class="main">(</span>extr <span class="free">T</span> <span class="free">H</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> keys_for_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Insertion lemmas for each type of channel message›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Note that the parameter accumulates the extracted atoms. In particular, 
these may include keys that may open further dynamically confidential messages. 
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> extr_insert_StatCh <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"extr <span class="free">T</span> <span class="main">(</span>insert <span class="main">(</span>StatCh <span class="free">c</span> <span class="free">A</span> <span class="free">B</span> <span class="main">(</span>Msg <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> 
   <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> confid <span class="main">∉</span> <span class="free">c</span> <span class="main">∨</span> <span class="free">A</span> <span class="main">∈</span> bad <span class="main">∨</span> <span class="free">B</span> <span class="main">∈</span> bad <span class="keyword1">then</span> extr <span class="main">(</span>set <span class="free">M</span> <span class="main">∪</span> <span class="free">T</span><span class="main">)</span> <span class="free">H</span> <span class="keyword1">else</span> extr <span class="free">T</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"confid <span class="main">∉</span> <span class="free">c</span> <span class="main">∨</span> <span class="free">A</span> <span class="main">∈</span> bad <span class="main">∨</span> <span class="free">B</span> <span class="main">∈</span> bad"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">At</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">At</span> <span class="main">∈</span> extr <span class="free">T</span> <span class="main">(</span>insert <span class="main">(</span>StatCh <span class="free">c</span> <span class="free">A</span> <span class="free">B</span> <span class="main">(</span>Msg <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">At</span> <span class="main">∈</span> extr <span class="main">(</span>set <span class="free">M</span> <span class="main">∪</span> <span class="free">T</span><span class="main">)</span> <span class="free">H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">At</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">At</span> <span class="main">∈</span> extr <span class="main">(</span>set <span class="free">M</span> <span class="main">∪</span> <span class="free">T</span><span class="main">)</span> <span class="free">H</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span>    <span class="quoted"><span class="quoted">"confid <span class="main">∉</span> <span class="free">c</span> <span class="main">∨</span> <span class="free">A</span> <span class="main">∈</span> bad <span class="main">∨</span> <span class="free">B</span> <span class="main">∈</span> bad"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">At</span> <span class="main">∈</span> extr <span class="free">T</span> <span class="main">(</span>insert <span class="main">(</span>StatCh <span class="free">c</span> <span class="free">A</span> <span class="free">B</span> <span class="main">(</span>Msg <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">At</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">At</span> <span class="main">∈</span> extr <span class="free">T</span> <span class="main">(</span>insert <span class="main">(</span>StatCh <span class="free">c</span> <span class="free">A</span> <span class="free">B</span> <span class="main">(</span>Msg <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"confid <span class="main">∈</span> <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∉</span> bad"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∉</span> bad"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">At</span> <span class="main">∈</span> extr <span class="free">T</span> <span class="free">H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> extr_insert_DynCh <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"extr <span class="free">T</span> <span class="main">(</span>insert <span class="main">(</span>DynCh <span class="free">c</span> <span class="free">K</span> <span class="main">(</span>Msg <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> 
   <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> confid <span class="main">∉</span> <span class="free">c</span> <span class="main">∨</span> aKey <span class="free">K</span> <span class="main">∈</span> extr <span class="free">T</span> <span class="free">H</span> <span class="keyword1">then</span> extr <span class="main">(</span>set <span class="free">M</span> <span class="main">∪</span> <span class="free">T</span><span class="main">)</span> <span class="free">H</span> <span class="keyword1">else</span> extr <span class="free">T</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"confid <span class="main">∉</span> <span class="free">c</span> <span class="main">∨</span> aKey <span class="free">K</span> <span class="main">∈</span> extr <span class="free">T</span> <span class="free">H</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">At</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">At</span> <span class="main">∈</span> extr <span class="free">T</span> <span class="main">(</span>insert <span class="main">(</span>DynCh <span class="free">c</span> <span class="free">K</span> <span class="main">(</span>Msg <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">At</span> <span class="main">∈</span> extr <span class="main">(</span>set <span class="free">M</span> <span class="main">∪</span> <span class="free">T</span><span class="main">)</span> <span class="free">H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">At</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">At</span> <span class="main">∈</span> extr <span class="main">(</span>set <span class="free">M</span> <span class="main">∪</span> <span class="free">T</span><span class="main">)</span> <span class="free">H</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">At</span> <span class="main">∈</span> extr <span class="free">T</span> <span class="main">(</span>insert <span class="main">(</span>DynCh <span class="free">c</span> <span class="free">K</span> <span class="main">(</span>Msg <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"extr <span class="free">T</span> <span class="main">(</span>insert <span class="main">(</span>DynCh <span class="free">c</span> <span class="free">K</span> <span class="main">(</span>Msg <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> extr <span class="free">T</span> <span class="free">H</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span> <span class="main">(</span><span class="operator">erule</span> extr.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">declare</span></span> extr.cases <span class="main">[</span><span class="operator">rule</span> <span class="quasi_keyword">del</span><span class="main">,</span> <span class="operator">elim</span><span class="main">]</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Faking messages›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Channel messages that are fakeable from a given set of channel
messages.  Parameters are a set of atoms and a set of freshness identifiers.

For faking messages on dynamic non-authentic channels, we cannot allow the
intruder to use arbitrary keys. Otherwise, we would lose the possibility to 
generate fresh values in our model. Therefore, the chosen keys must correspond
to session keys associated with existing runs (i.e., from set 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">rkeys</span></span> <span class="free"><span class="free">U</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>).
›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="entity">rkeys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"fid_t set <span class="main">⇒</span> key set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rkeys</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">≡</span> sesK<span class="main">`</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">$</span> <span class="bound">y</span><span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">×</span> <span class="main">(</span>UNIV<span class="main">::</span>nat set<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rkeys_sesK <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sesK <span class="main">(</span><span class="free">R</span><span class="main">$</span><span class="free">i</span><span class="main">)</span> <span class="main">∈</span> rkeys <span class="free">U</span> <span class="main">⟹</span> <span class="free">R</span> <span class="main">∈</span> <span class="free">U</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>


<span class="keyword1"><span class="command">inductive_set</span></span> 
  <span class="entity">fake</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"atom set <span class="main">⇒</span> fid_t set <span class="main">⇒</span> chmsg set <span class="main">⇒</span> chmsg set"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">T</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"atom set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">U</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"fid_t set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">H</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"chmsg set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  fake_Inj<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">∈</span> <span class="free">H</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">∈</span> <span class="free">fake</span> <span class="free">T</span> <span class="free">U</span> <span class="free">H</span>"</span></span>
<span class="main">|</span> fake_StatCh<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> set <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">⊆</span> extr <span class="free">T</span> <span class="free">H</span><span class="main">;</span> auth <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∈</span> bad <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∈</span> bad  <span class="main">⟧</span> 
   <span class="main">⟹</span> StatCh <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Msg <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">fake</span> <span class="free">T</span> <span class="free">U</span> <span class="free">H</span>"</span></span>
<span class="main">|</span> fake_DynCh<span class="main">:</span>  
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> set <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">⊆</span> extr <span class="free">T</span> <span class="free">H</span><span class="main">;</span> auth <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">∈</span> rkeys <span class="free">U</span> <span class="main">∨</span> aKey <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">∈</span> extr <span class="free">T</span> <span class="free">H</span> <span class="main">⟧</span> 
   <span class="main">⟹</span> DynCh <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">(</span>Msg <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">fake</span> <span class="free">T</span> <span class="free">U</span> <span class="free">H</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> fake.cases <span class="main">[</span><span class="operator">elim</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> fake.intros <span class="main">[</span><span class="operator">intro</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> fake_intros <span class="main">=</span> fake_StatCh fake_DynCh

<span class="keyword1"><span class="command">lemma</span></span> fake_expanding <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">⊆</span> fake <span class="free">T</span> <span class="free">U</span> <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fake_monotone <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">⊆</span> <span class="free">H</span> <span class="main">⟹</span> fake <span class="free">T</span> <span class="free">U</span> <span class="free">G</span> <span class="main">⊆</span> fake <span class="free">T</span> <span class="free">U</span> <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> fake.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fake_intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fake_monotone_param1 <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">⊆</span> <span class="free">T'</span> <span class="main">⟹</span> fake <span class="free">T</span> <span class="free">U</span> <span class="free">H</span> <span class="main">⊆</span> fake <span class="free">T'</span> <span class="free">U</span> <span class="free">H</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> fake.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fake_intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> fake_mono <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> fake_monotone <span class="main">[</span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> fake_mono_param1 <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> fake_monotone_param1 <span class="main">[</span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main">]</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Atoms and extr together with fake›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> atoms_fake <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"atoms <span class="main">(</span>fake <span class="free">T</span> <span class="free">U</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> <span class="free">T</span> <span class="main">∪</span> atoms <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">At</span> 
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">At</span> <span class="main">∈</span> <span class="free">T</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">At</span> <span class="main">∈</span> atoms <span class="main">(</span>fake <span class="free">T</span> <span class="free">U</span> <span class="free">H</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">B</span> 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Insec <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">(</span>Msg <span class="main">[</span><span class="skolem">At</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> fake <span class="free">T</span> <span class="free">U</span> <span class="free">H</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">At</span> <span class="main">∈</span> <span class="free">T</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> fake_StatCh<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> at_StatCh<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">At</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">At</span> <span class="main">∈</span> atoms <span class="main">(</span>fake <span class="free">T</span> <span class="free">U</span> <span class="free">H</span><span class="main">)</span> "</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">At</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">∪</span> atoms <span class="free">H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> extr_fake <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">T'</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"extr <span class="free">T</span> <span class="main">(</span>fake <span class="free">T'</span> <span class="free">U</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> extr <span class="free">T</span> <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">At</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">At</span> <span class="main">∈</span> extr <span class="free">T</span> <span class="main">(</span>fake <span class="free">T'</span> <span class="free">U</span> <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">At</span> <span class="main">∈</span> extr <span class="free">T</span> <span class="main">(</span>fake <span class="free">T</span> <span class="free">U</span> <span class="free">H</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">At</span> <span class="main">∈</span> extr <span class="free">T</span> <span class="free">H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="comment1">(*
lemma extr_fake [simp]: "extr T (fake T U H) = extr T H"
proof -
  {
    fix At
    assume "At ∈ extr T (fake T U H)"
    hence "At ∈ extr T H" by induct auto
  }
  thus ?thesis by auto
qed
*)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Message">
<div class="head">
<h1>Theory Message</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Title:      HOL/Auth/Message
  Author:     Lawrence C Paulson, Cambridge University Computer Laboratory
  Copyright   1996  University of Cambridge

  Datatypes of agents and messages;
  Inductive relations "parts", "analz" and "synth"

********************************************************************************

  Module:  Refinement/Message.thy (Isabelle/HOL 2016-1)
  ID:      $Id: Message.thy 133856 2017-03-20 18:05:54Z csprenge $
  Edited:  Christoph Sprenger &lt;sprenger@inf.ethz.ch&gt;, ETH Zurich

  Integrated and adapted for security protocol refinement

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Theory of Agents and Messages for Security Protocols›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Message <span class="keyword2"><span class="keyword">imports</span></span> <a href="Keys.html">Keys</a> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(*Needed occasionally with spy_analz_tac, e.g. in analz_insert_Key_newK*)</span>
<span class="keyword1"><span class="command">lemma</span></span> Un_idem_collapse <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∪</span> <span class="main">(</span><span class="free">B</span> <span class="main">∪</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">B</span> <span class="main">∪</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">datatype</span></span>
     msg <span class="main">=</span> Agent  <span class="quoted">agent</span>     <span class="comment1">― ‹Agent names›</span>
         <span class="main">|</span> Number <span class="quoted">nat</span>       <span class="comment1">― ‹Ordinary integers, timestamps, ...›</span>
         <span class="main">|</span> Nonce  <span class="quoted">nonce</span>     <span class="comment1">― ‹Unguessable nonces›</span>
         <span class="main">|</span> Key    <span class="quoted">key</span>       <span class="comment1">― ‹Crypto keys›</span>
         <span class="main">|</span> Hash   <span class="quoted">msg</span>       <span class="comment1">― ‹Hashing›</span>
         <span class="main">|</span> MPair  <span class="quoted">msg</span> <span class="quoted">msg</span>   <span class="comment1">― ‹Compound messages›</span>
         <span class="main">|</span> Crypt  <span class="quoted">key</span> <span class="quoted">msg</span>   <span class="comment1">― ‹Encryption, public- or shared-key›</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Concrete syntax: messages appear as <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⦃A,B,NA⦄›</span></span></span></span>, etc...›</span></span>

<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_MTuple"</span>      <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'a</span><span class="main">,</span> args<span class="main">]</span> <span class="main">=&gt;</span> <span class="tfree">'a</span> <span class="main">*</span> <span class="tfree">'b</span>"</span></span>       <span class="main">(</span><span class="quoted">"<span class="keyword3">(2</span><span class="keyword1">⦃</span>_<span class="keyword1">,</span><span class="keyword3">/ </span>_<span class="keyword1">⦄</span><span class="keyword3">)</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"<span class="main">⦃</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">,</span> <span class="free">z</span><span class="main">⦄</span>"</span>   <span class="main">==</span> <span class="quoted">"<span class="main">⦃</span><span class="free">x</span><span class="main">,</span> <span class="main">⦃</span><span class="free">y</span><span class="main">,</span> <span class="free">z</span><span class="main">⦄</span><span class="main">⦄</span>"</span>
  <span class="quoted">"<span class="main">⦃</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">⦄</span>"</span>      <span class="main">==</span> <span class="quoted">"<span class="keyword1">CONST</span> MPair <span class="free">x</span> <span class="free">y</span>"</span>


<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">HPair</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>msg<span class="main">,</span>msg<span class="main">]</span> <span class="main">⇒</span> msg"</span></span>                       <span class="main">(</span><span class="quoted">"<span class="keyword3">(4</span><span class="keyword1">Hash[</span>_<span class="keyword1">]</span> <span class="keyword3">/</span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 1000<span class="main">]</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="comment1">― ‹Message Y paired with a MAC computed with the help of X›</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">Hash[</span></span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main"><span class="free">]</span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">≡</span> <span class="main">⦃</span>Hash<span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">⦄</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">⦄</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">keysFor</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set <span class="main">⇒</span> key set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
    <span class="comment1">― ‹Keys useful to decrypt elements of a message set›</span>
  <span class="quoted"><span class="quoted">"<span class="free">keysFor</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">≡</span> invKey <span class="main">`</span> <span class="main">{</span><span class="bound">K</span><span class="main">.</span> <span class="main">∃</span><span class="bound">X</span><span class="main">.</span> Crypt <span class="bound">K</span> <span class="bound">X</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span><span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Inductive Definition of All Parts" of a Message›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span>
  <span class="entity">parts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set <span class="main">=&gt;</span> msg set"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">H</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    Inj <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>               <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">H</span> <span class="main">==&gt;</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">parts</span> <span class="free">H</span>"</span></span>
  <span class="main">|</span> Fst<span class="main">:</span>         <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">⦄</span>   <span class="main">∈</span> <span class="free">parts</span> <span class="free">H</span> <span class="main">==&gt;</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">parts</span> <span class="free">H</span>"</span></span>
  <span class="main">|</span> Snd<span class="main">:</span>         <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">⦄</span>   <span class="main">∈</span> <span class="free">parts</span> <span class="free">H</span> <span class="main">==&gt;</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∈</span> <span class="free">parts</span> <span class="free">H</span>"</span></span>
  <span class="main">|</span> Body<span class="main">:</span>        <span class="quoted"><span class="quoted">"Crypt <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">parts</span> <span class="free">H</span> <span class="main">==&gt;</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">parts</span> <span class="free">H</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Monotonicity›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> parts_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">⊆</span> <span class="free">H</span> <span class="main">==&gt;</span> parts<span class="main">(</span><span class="free">G</span><span class="main">)</span> <span class="main">⊆</span> parts<span class="main">(</span><span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> parts.induct<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> parts.Fst parts.Snd parts.Body<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Equations hold because constructors are injective.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> Other_image_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Agent <span class="free">x</span> <span class="main">∈</span> Agent<span class="main">`</span><span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">:</span><span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Key_image_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Key <span class="free">x</span> <span class="main">∈</span> Key<span class="main">`</span><span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">∈</span><span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Nonce_Key_image_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Nonce <span class="free">x</span> <span class="main">∉</span> Key<span class="main">`</span><span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>



<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹keysFor operator›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> keysFor_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"keysFor <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> keysFor_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> keysFor_Un <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"keysFor <span class="main">(</span><span class="free">H</span> <span class="main">∪</span> <span class="free">H'</span><span class="main">)</span> <span class="main">=</span> keysFor <span class="free">H</span> <span class="main">∪</span> keysFor <span class="free">H'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> keysFor_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> keysFor_UN <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"keysFor <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">H</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> keysFor <span class="main">(</span><span class="free">H</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> keysFor_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Monotonicity›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> keysFor_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">⊆</span> <span class="free">H</span> <span class="main">==&gt;</span> keysFor<span class="main">(</span><span class="free">G</span><span class="main">)</span> <span class="main">⊆</span> keysFor<span class="main">(</span><span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> keysFor_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> keysFor_insert_Agent <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"keysFor <span class="main">(</span>insert <span class="main">(</span>Agent <span class="free">A</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> keysFor <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> keysFor_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> keysFor_insert_Nonce <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"keysFor <span class="main">(</span>insert <span class="main">(</span>Nonce <span class="free">N</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> keysFor <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> keysFor_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> keysFor_insert_Number <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"keysFor <span class="main">(</span>insert <span class="main">(</span>Number <span class="free">N</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> keysFor <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> keysFor_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> keysFor_insert_Key <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"keysFor <span class="main">(</span>insert <span class="main">(</span>Key <span class="free">K</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> keysFor <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> keysFor_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> keysFor_insert_Hash <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"keysFor <span class="main">(</span>insert <span class="main">(</span>Hash <span class="free">X</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> keysFor <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> keysFor_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> keysFor_insert_MPair <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"keysFor <span class="main">(</span>insert <span class="main">⦃</span><span class="free">X</span><span class="main">,</span><span class="free">Y</span><span class="main">⦄</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> keysFor <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> keysFor_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> keysFor_insert_Crypt <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"keysFor <span class="main">(</span>insert <span class="main">(</span>Crypt <span class="free">K</span> <span class="free">X</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span>invKey <span class="free">K</span><span class="main">)</span> <span class="main">(</span>keysFor <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> keysFor_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> keysFor_image_Key <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"keysFor <span class="main">(</span>Key<span class="main">`</span><span class="free">E</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> keysFor_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Crypt_imp_invKey_keysFor<span class="main">:</span> <span class="quoted"><span class="quoted">"Crypt <span class="free">K</span> <span class="free">X</span> <span class="main">∈</span> <span class="free">H</span> <span class="main">==&gt;</span> invKey <span class="free">K</span> <span class="main">∈</span> keysFor <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> keysFor_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Inductive relation "parts"›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> MPair_parts<span class="main">:</span>
     <span class="quoted"><span class="quoted">"<span class="main">[|</span> <span class="main">⦃</span><span class="free">X</span><span class="main">,</span><span class="free">Y</span><span class="main">⦄</span> <span class="main">∈</span> parts <span class="free">H</span><span class="main">;</span>
         <span class="main">[|</span> <span class="free">X</span> <span class="main">∈</span> parts <span class="free">H</span><span class="main">;</span> <span class="free">Y</span> <span class="main">∈</span> parts <span class="free">H</span> <span class="main">|]</span> <span class="main">==&gt;</span> <span class="free">P</span> <span class="main">|]</span> <span class="main">==&gt;</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> parts.Fst parts.Snd<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> MPair_parts <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main">!</span></span><span class="main">]</span>  parts.Body <span class="main">[</span><span class="operator">dest</span><span class="main"><span class="main">!</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹NB These two rules are UNSAFE in the formal sense, as they discard the
     compound message.  They work well on THIS FILE.
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>MPair_parts›</span></span></span></span> is left as SAFE because it speeds up proofs.
  The Crypt rule is normally kept UNSAFE to avoid breaking up certificates.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> parts_increasing<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">⊆</span> parts<span class="main">(</span><span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemmas</span></span> parts_insertI <span class="main">=</span> subset_insertI <span class="main">[</span><span class="operator">THEN</span> parts_mono<span class="main">,</span> <span class="operator">THEN</span> subsetD<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> parts_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"parts<span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> parts_emptyE <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span><span class="main">∈</span> parts<span class="main">{}</span> <span class="main">==&gt;</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹WARNING: loops if H = {Y}, therefore must not be repeated!›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> parts_singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span><span class="main">∈</span> parts <span class="free">H</span> <span class="main">==&gt;</span> <span class="main">∃</span><span class="bound">Y</span><span class="main">∈</span><span class="free">H</span><span class="main">.</span> <span class="free">X</span><span class="main">∈</span> parts <span class="main">{</span><span class="bound">Y</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Unions›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> parts_Un_subset1<span class="main">:</span> <span class="quoted"><span class="quoted">"parts<span class="main">(</span><span class="free">G</span><span class="main">)</span> <span class="main">∪</span> parts<span class="main">(</span><span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> parts<span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Un_least parts_mono Un_upper1 Un_upper2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> parts_Un_subset2<span class="main">:</span> <span class="quoted"><span class="quoted">"parts<span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> parts<span class="main">(</span><span class="free">G</span><span class="main">)</span> <span class="main">∪</span> parts<span class="main">(</span><span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> parts_Un <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"parts<span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> parts<span class="main">(</span><span class="free">G</span><span class="main">)</span> <span class="main">∪</span> parts<span class="main">(</span><span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI parts_Un_subset1 parts_Un_subset2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> parts_insert<span class="main">:</span> <span class="quoted"><span class="quoted">"parts <span class="main">(</span>insert <span class="free">X</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> parts <span class="main">{</span><span class="free">X</span><span class="main">}</span> <span class="main">∪</span> parts <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> insert_is_Un <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">H</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> parts_Un<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹TWO inserts to avoid looping.  This rewrite is better than nothing.
  Not suitable for Addsimps: its behaviour can be strange.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> parts_insert2<span class="main">:</span>
     <span class="quoted"><span class="quoted">"parts <span class="main">(</span>insert <span class="free">X</span> <span class="main">(</span>insert <span class="free">Y</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> parts <span class="main">{</span><span class="free">X</span><span class="main">}</span> <span class="main">∪</span> parts <span class="main">{</span><span class="free">Y</span><span class="main">}</span> <span class="main">∪</span> parts <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Un_assoc<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parts_insert <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> parts_UN_subset1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> parts<span class="main">(</span><span class="free">H</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> parts<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">H</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> UN_least parts_mono UN_upper<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> parts_UN_subset2<span class="main">:</span> <span class="quoted"><span class="quoted">"parts<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">H</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> parts<span class="main">(</span><span class="free">H</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> parts_UN <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"parts<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">H</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> parts<span class="main">(</span><span class="free">H</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI parts_UN_subset1 parts_UN_subset2<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Added to simplify arguments to parts, analz and synth.
  NOTE: the UN versions are no longer used!›</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This allows <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>blast›</span></span></span></span> to simplify occurrences of
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"parts<span class="main"><span class="main">(</span></span><span class="free"><span class="free">G</span></span><span class="main"><span class="main">∪</span></span><span class="free"><span class="free">H</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in the assumption.›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> in_parts_UnE <span class="main">=</span> parts_Un <span class="main">[</span><span class="operator">THEN</span> equalityD1<span class="main">,</span> <span class="operator">THEN</span> subsetD<span class="main">,</span> <span class="operator">THEN</span> UnE<span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> in_parts_UnE <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main">!</span></span><span class="main">]</span>


<span class="keyword1"><span class="command">lemma</span></span> parts_insert_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"insert <span class="free">X</span> <span class="main">(</span>parts <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> parts<span class="main">(</span>insert <span class="free">X</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> parts_mono <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Idempotence and transitivity›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> parts_partsD <span class="main">[</span><span class="operator">dest</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span><span class="main">∈</span> parts <span class="main">(</span>parts <span class="free">H</span><span class="main">)</span> <span class="main">==&gt;</span> <span class="free">X</span><span class="main">∈</span> parts <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> parts_idem <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"parts <span class="main">(</span>parts <span class="free">H</span><span class="main">)</span> <span class="main">=</span> parts <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> parts_subset_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>parts <span class="free">G</span> <span class="main">⊆</span> parts <span class="free">H</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">G</span> <span class="main">⊆</span> parts <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subset_trans parts_increasing<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> parts_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> parts_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[|</span> <span class="free">X</span><span class="main">∈</span> parts <span class="free">G</span><span class="main">;</span>  <span class="free">G</span> <span class="main">⊆</span> parts <span class="free">H</span> <span class="main">|]</span> <span class="main">==&gt;</span> <span class="free">X</span><span class="main">∈</span> parts <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> parts_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Cut›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> parts_cut<span class="main">:</span>
     <span class="quoted"><span class="quoted">"<span class="main">[|</span> <span class="free">Y</span><span class="main">∈</span> parts <span class="main">(</span>insert <span class="free">X</span> <span class="free">G</span><span class="main">)</span><span class="main">;</span>  <span class="free">X</span><span class="main">∈</span> parts <span class="free">H</span> <span class="main">|]</span> <span class="main">==&gt;</span> <span class="free">Y</span><span class="main">∈</span> parts <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> parts_trans<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> parts_cut_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span><span class="main">∈</span> parts <span class="free">H</span> <span class="main">==&gt;</span> parts <span class="main">(</span>insert <span class="free">X</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> parts <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> parts_cut <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> parts_insertI<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Rewrite rules for pulling out atomic messages›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> parts_insert_eq_I <span class="main">=</span> equalityI <span class="main">[</span><span class="operator">OF</span> subsetI parts_insert_subset<span class="main">]</span>


<span class="keyword1"><span class="command">lemma</span></span> parts_insert_Agent <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
     <span class="quoted"><span class="quoted">"parts <span class="main">(</span>insert <span class="main">(</span>Agent <span class="free">agt</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span>Agent <span class="free">agt</span><span class="main">)</span> <span class="main">(</span>parts <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> parts_insert_eq_I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> parts_insert_Nonce <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
     <span class="quoted"><span class="quoted">"parts <span class="main">(</span>insert <span class="main">(</span>Nonce <span class="free">N</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span>Nonce <span class="free">N</span><span class="main">)</span> <span class="main">(</span>parts <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> parts_insert_eq_I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> parts_insert_Number <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
     <span class="quoted"><span class="quoted">"parts <span class="main">(</span>insert <span class="main">(</span>Number <span class="free">N</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span>Number <span class="free">N</span><span class="main">)</span> <span class="main">(</span>parts <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> parts_insert_eq_I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> parts_insert_Key <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
     <span class="quoted"><span class="quoted">"parts <span class="main">(</span>insert <span class="main">(</span>Key <span class="free">K</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span>Key <span class="free">K</span><span class="main">)</span> <span class="main">(</span>parts <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> parts_insert_eq_I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> parts_insert_Hash <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
     <span class="quoted"><span class="quoted">"parts <span class="main">(</span>insert <span class="main">(</span>Hash <span class="free">X</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span>Hash <span class="free">X</span><span class="main">)</span> <span class="main">(</span>parts <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> parts_insert_eq_I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> parts_insert_Crypt <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
     <span class="quoted"><span class="quoted">"parts <span class="main">(</span>insert <span class="main">(</span>Crypt <span class="free">K</span> <span class="free">X</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span>Crypt <span class="free">K</span> <span class="free">X</span><span class="main">)</span> <span class="main">(</span>parts <span class="main">(</span>insert <span class="free">X</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> equalityI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> parts.Body<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> parts_insert_MPair <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
     <span class="quoted"><span class="quoted">"parts <span class="main">(</span>insert <span class="main">⦃</span><span class="free">X</span><span class="main">,</span><span class="free">Y</span><span class="main">⦄</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span>
          insert <span class="main">⦃</span><span class="free">X</span><span class="main">,</span><span class="free">Y</span><span class="main">⦄</span> <span class="main">(</span>parts <span class="main">(</span>insert <span class="free">X</span> <span class="main">(</span>insert <span class="free">Y</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> equalityI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> parts.Fst parts.Snd<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> parts_image_Key <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"parts <span class="main">(</span>Key<span class="main">`</span><span class="free">N</span><span class="main">)</span> <span class="main">=</span> Key<span class="main">`</span><span class="free">N</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹In any message, there is an upper bound N on its greatest nonce.›</span></span>
<span class="comment1">(*
lemma msg_Nonce_supply: "∃N. ∀n. N≤n --&gt; Nonce n ∉ parts {msg}"
apply (induct msg)
apply (simp_all (no_asm_simp) add: exI parts_insert2)
 txt{*MPair case: blast works out the necessary sum itself!*}
 prefer 2 apply auto apply (blast elim!: add_leE)
txt{*Nonce case*}
apply (rule_tac x = "N + Suc nat" in exI, auto)
done
*)</span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Inductive relation "analz"›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Inductive definition of "analz" -- what can be broken down from a set of
    messages, including keys.  A form of downward closure.  Pairs can
    be taken apart; messages decrypted with known keys.›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span>
  <span class="entity">analz</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set <span class="main">=&gt;</span> msg set"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">H</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    Inj <span class="main">[</span><span class="operator">intro</span><span class="main">,</span><span class="operator">simp</span><span class="main">]</span> <span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">H</span> <span class="main">==&gt;</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">analz</span> <span class="free">H</span>"</span></span>
  <span class="main">|</span> Fst<span class="main">:</span>     <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">⦄</span> <span class="main">∈</span> <span class="free">analz</span> <span class="free">H</span> <span class="main">==&gt;</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">analz</span> <span class="free">H</span>"</span></span>
  <span class="main">|</span> Snd<span class="main">:</span>     <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">⦄</span> <span class="main">∈</span> <span class="free">analz</span> <span class="free">H</span> <span class="main">==&gt;</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∈</span> <span class="free">analz</span> <span class="free">H</span>"</span></span>
  <span class="main">|</span> Decrypt <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
             <span class="quoted"><span class="quoted">"<span class="main">[|</span>Crypt <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">analz</span> <span class="free">H</span><span class="main">;</span> Key<span class="main">(</span>invKey <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">)</span><span class="main">:</span> <span class="free">analz</span> <span class="free">H</span><span class="main">|]</span> <span class="main">==&gt;</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">analz</span> <span class="free">H</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Monotonicity; Lemma 1 of Lowe's paper›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> analz_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G</span><span class="main">⊆</span><span class="free">H</span> <span class="main">==&gt;</span> analz<span class="main">(</span><span class="free">G</span><span class="main">)</span> <span class="main">⊆</span> analz<span class="main">(</span><span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> analz.induct<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> analz.Fst analz.Snd<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> analz_monotonic <span class="main">=</span> analz_mono <span class="main">[</span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Making it safe speeds up proofs›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> MPair_analz <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
     <span class="quoted"><span class="quoted">"<span class="main">[|</span> <span class="main">⦃</span><span class="free">X</span><span class="main">,</span><span class="free">Y</span><span class="main">⦄</span> <span class="main">∈</span> analz <span class="free">H</span><span class="main">;</span>
             <span class="main">[|</span> <span class="free">X</span> <span class="main">∈</span> analz <span class="free">H</span><span class="main">;</span> <span class="free">Y</span> <span class="main">∈</span> analz <span class="free">H</span> <span class="main">|]</span> <span class="main">==&gt;</span> <span class="free">P</span>
          <span class="main">|]</span> <span class="main">==&gt;</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> analz.Fst analz.Snd<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> analz_increasing<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">⊆</span> analz<span class="main">(</span><span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> analz_subset_parts<span class="main">:</span> <span class="quoted"><span class="quoted">"analz <span class="free">H</span> <span class="main">⊆</span> parts <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> analz.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> analz_into_parts <span class="main">=</span> analz_subset_parts <span class="main">[</span><span class="operator">THEN</span> subsetD<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> not_parts_not_analz <span class="main">=</span> analz_subset_parts <span class="main">[</span><span class="operator">THEN</span> contra_subsetD<span class="main">]</span>


<span class="keyword1"><span class="command">lemma</span></span> parts_analz <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"parts <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">=</span> parts <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> equalityI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> analz_subset_parts <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> parts_mono<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> subset_trans<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> analz_increasing <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> parts_mono<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> analz_parts <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span>parts <span class="free">H</span><span class="main">)</span> <span class="main">=</span> parts <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> analz.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> analz_insertI <span class="main">=</span> subset_insertI <span class="main">[</span><span class="operator">THEN</span> analz_mono<span class="main">,</span> <span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main">]</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹General equational properties›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> analz_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"analz<span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> analz.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Converse fails: we can analz more from the union than from the
  separate parts, as a key in one might decrypt a message in the other›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> analz_Un<span class="main">:</span> <span class="quoted"><span class="quoted">"analz<span class="main">(</span><span class="free">G</span><span class="main">)</span> <span class="main">∪</span> analz<span class="main">(</span><span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> analz<span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Un_least analz_mono Un_upper1 Un_upper2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> analz_insert<span class="main">:</span> <span class="quoted"><span class="quoted">"insert <span class="free">X</span> <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> analz<span class="main">(</span>insert <span class="free">X</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> analz_mono <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Rewrite rules for pulling out atomic messages›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> analz_insert_eq_I <span class="main">=</span> equalityI <span class="main">[</span><span class="operator">OF</span> subsetI analz_insert<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> analz_insert_Agent <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
     <span class="quoted"><span class="quoted">"analz <span class="main">(</span>insert <span class="main">(</span>Agent <span class="free">agt</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span>Agent <span class="free">agt</span><span class="main">)</span> <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> analz_insert_eq_I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> analz.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> analz_insert_Nonce <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
     <span class="quoted"><span class="quoted">"analz <span class="main">(</span>insert <span class="main">(</span>Nonce <span class="free">N</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span>Nonce <span class="free">N</span><span class="main">)</span> <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> analz_insert_eq_I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> analz.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> analz_insert_Number <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
     <span class="quoted"><span class="quoted">"analz <span class="main">(</span>insert <span class="main">(</span>Number <span class="free">N</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span>Number <span class="free">N</span><span class="main">)</span> <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> analz_insert_eq_I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> analz.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> analz_insert_Hash <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
     <span class="quoted"><span class="quoted">"analz <span class="main">(</span>insert <span class="main">(</span>Hash <span class="free">X</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span>Hash <span class="free">X</span><span class="main">)</span> <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> analz_insert_eq_I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> analz.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Can only pull out Keys if they are not needed to decrypt the rest›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> analz_insert_Key <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">∉</span> keysFor <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">==&gt;</span>
          analz <span class="main">(</span>insert <span class="main">(</span>Key <span class="free">K</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span>Key <span class="free">K</span><span class="main">)</span> <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> keysFor_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> analz_insert_eq_I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> analz.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> analz_insert_MPair <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
     <span class="quoted"><span class="quoted">"analz <span class="main">(</span>insert <span class="main">⦃</span><span class="free">X</span><span class="main">,</span><span class="free">Y</span><span class="main">⦄</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span>
          insert <span class="main">⦃</span><span class="free">X</span><span class="main">,</span><span class="free">Y</span><span class="main">⦄</span> <span class="main">(</span>analz <span class="main">(</span>insert <span class="free">X</span> <span class="main">(</span>insert <span class="free">Y</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> equalityI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> analz.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> analz.induct<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> analz.Fst analz.Snd<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Can pull out enCrypted message if the Key is not known›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> analz_insert_Crypt<span class="main">:</span>
     <span class="quoted"><span class="quoted">"Key <span class="main">(</span>invKey <span class="free">K</span><span class="main">)</span> <span class="main">∉</span> analz <span class="free">H</span>
      <span class="main">==&gt;</span> analz <span class="main">(</span>insert <span class="main">(</span>Crypt <span class="free">K</span> <span class="free">X</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span>Crypt <span class="free">K</span> <span class="free">X</span><span class="main">)</span> <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> analz_insert_eq_I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> analz.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> lemma1<span class="main">:</span> <span class="quoted"><span class="quoted">"Key <span class="main">(</span>invKey <span class="free">K</span><span class="main">)</span> <span class="main">∈</span> analz <span class="free">H</span> <span class="main">==&gt;</span>
               analz <span class="main">(</span>insert <span class="main">(</span>Crypt <span class="free">K</span> <span class="free">X</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span>
               insert <span class="main">(</span>Crypt <span class="free">K</span> <span class="free">X</span><span class="main">)</span> <span class="main">(</span>analz <span class="main">(</span>insert <span class="free">X</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> analz.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> lemma2<span class="main">:</span> <span class="quoted"><span class="quoted">"Key <span class="main">(</span>invKey <span class="free">K</span><span class="main">)</span> <span class="main">∈</span> analz <span class="free">H</span> <span class="main">==&gt;</span>
               insert <span class="main">(</span>Crypt <span class="free">K</span> <span class="free">X</span><span class="main">)</span> <span class="main">(</span>analz <span class="main">(</span>insert <span class="free">X</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span>
               analz <span class="main">(</span>insert <span class="main">(</span>Crypt <span class="free">K</span> <span class="free">X</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> analz.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> analz_insertI analz.Decrypt<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> analz_insert_Decrypt<span class="main">:</span>
     <span class="quoted"><span class="quoted">"Key <span class="main">(</span>invKey <span class="free">K</span><span class="main">)</span> <span class="main">∈</span> analz <span class="free">H</span> <span class="main">==&gt;</span>
               analz <span class="main">(</span>insert <span class="main">(</span>Crypt <span class="free">K</span> <span class="free">X</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span>
               insert <span class="main">(</span>Crypt <span class="free">K</span> <span class="free">X</span><span class="main">)</span> <span class="main">(</span>analz <span class="main">(</span>insert <span class="free">X</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI lemma1 lemma2<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Case analysis: either the message is secure, or it is not! Effective,
but can cause subgoals to blow up! Use with <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>split_if›</span></span></span></span>; apparently
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>split_tac›</span></span></span></span> does not cope with patterns such as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span><span class="quoted"><span class="quoted">"analz <span class="main"><span class="main">(</span></span>insert
<span class="main"><span class="main">(</span></span>Crypt <span class="free"><span class="free">K</span></span> <span class="free"><span class="free">X</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">H</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> analz_Crypt_if <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
     <span class="quoted"><span class="quoted">"analz <span class="main">(</span>insert <span class="main">(</span>Crypt <span class="free">K</span> <span class="free">X</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>Key <span class="main">(</span>invKey <span class="free">K</span><span class="main">)</span> <span class="main">∈</span> analz <span class="free">H</span><span class="main">)</span>
           <span class="keyword1">then</span> insert <span class="main">(</span>Crypt <span class="free">K</span> <span class="free">X</span><span class="main">)</span> <span class="main">(</span>analz <span class="main">(</span>insert <span class="free">X</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>
           <span class="keyword1">else</span> insert <span class="main">(</span>Crypt <span class="free">K</span> <span class="free">X</span><span class="main">)</span> <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> analz_insert_Crypt analz_insert_Decrypt<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This rule supposes "for the sake of argument" that we have the key.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> analz_insert_Crypt_subset<span class="main">:</span>
     <span class="quoted"><span class="quoted">"analz <span class="main">(</span>insert <span class="main">(</span>Crypt <span class="free">K</span> <span class="free">X</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span>
           insert <span class="main">(</span>Crypt <span class="free">K</span> <span class="free">X</span><span class="main">)</span> <span class="main">(</span>analz <span class="main">(</span>insert <span class="free">X</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> analz.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">lemma</span></span> analz_image_Key <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span>Key<span class="main">`</span><span class="free">N</span><span class="main">)</span> <span class="main">=</span> Key<span class="main">`</span><span class="free">N</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> analz.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Idempotence and transitivity›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> analz_analzD <span class="main">[</span><span class="operator">dest</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span><span class="main">∈</span> analz <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">==&gt;</span> <span class="free">X</span><span class="main">∈</span> analz <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> analz.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> analz_idem <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">=</span> analz <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> analz_subset_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>analz <span class="free">G</span> <span class="main">⊆</span> analz <span class="free">H</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">G</span> <span class="main">⊆</span> analz <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subset_trans analz_increasing<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> analz_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> analz_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[|</span> <span class="free">X</span><span class="main">∈</span> analz <span class="free">G</span><span class="main">;</span>  <span class="free">G</span> <span class="main">⊆</span> analz <span class="free">H</span> <span class="main">|]</span> <span class="main">==&gt;</span> <span class="free">X</span><span class="main">∈</span> analz <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> analz_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Cut; Lemma 2 of Lowe›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> analz_cut<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[|</span> <span class="free">Y</span><span class="main">∈</span> analz <span class="main">(</span>insert <span class="free">X</span> <span class="free">H</span><span class="main">)</span><span class="main">;</span>  <span class="free">X</span><span class="main">∈</span> analz <span class="free">H</span> <span class="main">|]</span> <span class="main">==&gt;</span> <span class="free">Y</span><span class="main">∈</span> analz <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> analz_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="comment1">(*Cut can be proved easily by induction on
   "Y: analz (insert X H) ==&gt; X: analz H --&gt; Y: analz H"
*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This rewrite rule helps in the simplification of messages that involve
  the forwarding of unknown components (X).  Without it, removing occurrences
  of X can be very complicated.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> analz_insert_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span><span class="main">∈</span> analz <span class="free">H</span> <span class="main">==&gt;</span> analz <span class="main">(</span>insert <span class="free">X</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> analz <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> analz_cut analz_insertI<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹A congruence rule for "analz"›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> analz_subset_cong<span class="main">:</span>
     <span class="quoted"><span class="quoted">"<span class="main">[|</span> analz <span class="free">G</span> <span class="main">⊆</span> analz <span class="free">G'</span><span class="main">;</span> analz <span class="free">H</span> <span class="main">⊆</span> analz <span class="free">H'</span> <span class="main">|]</span>
      <span class="main">==&gt;</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> analz <span class="main">(</span><span class="free">G'</span> <span class="main">∪</span> <span class="free">H'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> conjI subset_trans analz_mono Un_upper1 Un_upper2<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> analz_cong<span class="main">:</span>
     <span class="quoted"><span class="quoted">"<span class="main">[|</span> analz <span class="free">G</span> <span class="main">=</span> analz <span class="free">G'</span><span class="main">;</span> analz <span class="free">H</span> <span class="main">=</span> analz <span class="free">H'</span> <span class="main">|]</span>
      <span class="main">==&gt;</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> analz <span class="main">(</span><span class="free">G'</span> <span class="main">∪</span> <span class="free">H'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI analz_subset_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> analz_insert_cong<span class="main">:</span>
     <span class="quoted"><span class="quoted">"analz <span class="free">H</span> <span class="main">=</span> analz <span class="free">H'</span> <span class="main">==&gt;</span> analz<span class="main">(</span>insert <span class="free">X</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> analz<span class="main">(</span>insert <span class="free">X</span> <span class="free">H'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> insert_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> analz_cong<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹If there are no pairs or encryptions then analz does nothing›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> analz_trivial<span class="main">:</span>
     <span class="quoted"><span class="quoted">"<span class="main">[|</span> <span class="main">∀</span><span class="bound">X</span> <span class="bound">Y</span><span class="main">.</span> <span class="main">⦃</span><span class="bound">X</span><span class="main">,</span><span class="bound">Y</span><span class="main">⦄</span> <span class="main">∉</span> <span class="free">H</span><span class="main">;</span>  <span class="main">∀</span><span class="bound">X</span> <span class="bound">K</span><span class="main">.</span> Crypt <span class="bound">K</span> <span class="bound">X</span> <span class="main">∉</span> <span class="free">H</span> <span class="main">|]</span> <span class="main">==&gt;</span> analz <span class="free">H</span> <span class="main">=</span> <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> analz.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹These two are obsolete (with a single Spy) but cost little to prove...›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> analz_UN_analz_lemma<span class="main">:</span>
     <span class="quoted"><span class="quoted">"<span class="free">X</span><span class="main">∈</span> analz <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> analz <span class="main">(</span><span class="free">H</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">==&gt;</span> <span class="free">X</span><span class="main">∈</span> analz <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">H</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> analz.induct<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> analz_mono <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> analz_UN_analz <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> analz <span class="main">(</span><span class="free">H</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> analz <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">H</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> analz_UN_analz_lemma analz_mono <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Inductive relation "synth"›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Inductive definition of "synth" -- what can be built up from a set of
    messages.  A form of upward closure.  Pairs can be built, messages
    encrypted with known keys.  Agent names are public domain.
    Numbers can be guessed, but Nonces cannot be.›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span>
  <span class="entity">synth</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set <span class="main">=&gt;</span> msg set"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">H</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    Inj    <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">H</span> <span class="main">==&gt;</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">synth</span> <span class="free">H</span>"</span></span>
  <span class="main">|</span> Agent  <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>   <span class="quoted"><span class="quoted">"Agent <span class="free"><span class="bound"><span class="entity">agt</span></span></span> <span class="main">∈</span> <span class="free">synth</span> <span class="free">H</span>"</span></span>
  <span class="main">|</span> Number <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>   <span class="quoted"><span class="quoted">"Number <span class="free"><span class="bound"><span class="entity">n</span></span></span>  <span class="main">∈</span> <span class="free">synth</span> <span class="free">H</span>"</span></span>
  <span class="main">|</span> Hash   <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">synth</span> <span class="free">H</span> <span class="main">==&gt;</span> Hash <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">synth</span> <span class="free">H</span>"</span></span>
  <span class="main">|</span> MPair  <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">[|</span><span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">synth</span> <span class="free">H</span><span class="main">;</span>  <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∈</span> <span class="free">synth</span> <span class="free">H</span><span class="main">|]</span> <span class="main">==&gt;</span> <span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">⦄</span> <span class="main">∈</span> <span class="free">synth</span> <span class="free">H</span>"</span></span>
  <span class="main">|</span> Crypt  <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">[|</span><span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">synth</span> <span class="free">H</span><span class="main">;</span>  Key<span class="main">(</span><span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">H</span><span class="main">|]</span> <span class="main">==&gt;</span> Crypt <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">synth</span> <span class="free">H</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Monotonicity›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> synth_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G</span><span class="main">⊆</span><span class="free">H</span> <span class="main">==&gt;</span> synth<span class="main">(</span><span class="free">G</span><span class="main">)</span> <span class="main">⊆</span> synth<span class="main">(</span><span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> synth.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹NO <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Agent_synth›</span></span></span></span>, as any Agent name can be synthesized.
  The same holds for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Number</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> Nonce_synth <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Nonce <span class="free">n</span> <span class="main">∈</span> synth <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> Key_synth   <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Key <span class="free">K</span> <span class="main">∈</span> synth <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> Hash_synth  <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Hash <span class="free">X</span> <span class="main">∈</span> synth <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> MPair_synth <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">X</span><span class="main">,</span><span class="free">Y</span><span class="main">⦄</span> <span class="main">∈</span> synth <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> Crypt_synth <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Crypt <span class="free">K</span> <span class="free">X</span> <span class="main">∈</span> synth <span class="free">H</span>"</span></span>


<span class="keyword1"><span class="command">lemma</span></span> synth_increasing<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">⊆</span> synth<span class="main">(</span><span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Unions›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Converse fails: we can synth more from the union than from the
  separate parts, building a compound message using elements of each.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> synth_Un<span class="main">:</span> <span class="quoted"><span class="quoted">"synth<span class="main">(</span><span class="free">G</span><span class="main">)</span> <span class="main">∪</span> synth<span class="main">(</span><span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> synth<span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Un_least synth_mono Un_upper1 Un_upper2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> synth_insert<span class="main">:</span> <span class="quoted"><span class="quoted">"insert <span class="free">X</span> <span class="main">(</span>synth <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> synth<span class="main">(</span>insert <span class="free">X</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> synth_mono <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Idempotence and transitivity›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> synth_synthD <span class="main">[</span><span class="operator">dest</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span><span class="main">∈</span> synth <span class="main">(</span>synth <span class="free">H</span><span class="main">)</span> <span class="main">==&gt;</span> <span class="free">X</span><span class="main">∈</span> synth <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> synth.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> synth_idem<span class="main">:</span> <span class="quoted"><span class="quoted">"synth <span class="main">(</span>synth <span class="free">H</span><span class="main">)</span> <span class="main">=</span> synth <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> synth_subset_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>synth <span class="free">G</span> <span class="main">⊆</span> synth <span class="free">H</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">G</span> <span class="main">⊆</span> synth <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subset_trans synth_increasing<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> synth_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> synth_idem<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> synth_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[|</span> <span class="free">X</span><span class="main">∈</span> synth <span class="free">G</span><span class="main">;</span>  <span class="free">G</span> <span class="main">⊆</span> synth <span class="free">H</span> <span class="main">|]</span> <span class="main">==&gt;</span> <span class="free">X</span><span class="main">∈</span> synth <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> synth_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Cut; Lemma 2 of Lowe›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> synth_cut<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[|</span> <span class="free">Y</span><span class="main">∈</span> synth <span class="main">(</span>insert <span class="free">X</span> <span class="free">H</span><span class="main">)</span><span class="main">;</span>  <span class="free">X</span><span class="main">∈</span> synth <span class="free">H</span> <span class="main">|]</span> <span class="main">==&gt;</span> <span class="free">Y</span><span class="main">∈</span> synth <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> synth_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Agent_synth <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Agent <span class="free">A</span> <span class="main">∈</span> synth <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> Number_synth <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Number <span class="free">n</span> <span class="main">∈</span> synth <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> Nonce_synth_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Nonce <span class="free">N</span> <span class="main">∈</span> synth <span class="free">H</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Nonce <span class="free">N</span> <span class="main">∈</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> Key_synth_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Key <span class="free">K</span> <span class="main">∈</span> synth <span class="free">H</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Key <span class="free">K</span> <span class="main">∈</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> Crypt_synth_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
     <span class="quoted"><span class="quoted">"Key <span class="free">K</span> <span class="main">∉</span> <span class="free">H</span> <span class="main">==&gt;</span> <span class="main">(</span>Crypt <span class="free">K</span> <span class="free">X</span> <span class="main">∈</span> synth <span class="free">H</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Crypt <span class="free">K</span> <span class="free">X</span> <span class="main">∈</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">lemma</span></span> keysFor_synth <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"keysFor <span class="main">(</span>synth <span class="free">H</span><span class="main">)</span> <span class="main">=</span> keysFor <span class="free">H</span> <span class="main">∪</span> invKey<span class="main">`</span><span class="main">{</span><span class="bound">K</span><span class="main">.</span> Key <span class="bound">K</span> <span class="main">∈</span> <span class="free">H</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> keysFor_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Combinations of parts, analz and synth›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> parts_synth <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"parts <span class="main">(</span>synth <span class="free">H</span><span class="main">)</span> <span class="main">=</span> parts <span class="free">H</span> <span class="main">∪</span> synth <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> equalityI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> parts.induct<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> synth_increasing <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> parts_mono<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span>
                    parts.Fst parts.Snd parts.Body<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> analz_analz_Un <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span>analz <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> equalityI analz_subset_cong<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> analz_synth_Un <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span>synth <span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">∪</span> synth <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> equalityI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> analz.induct<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 5 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> analz_mono <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> analz.Fst analz.Snd analz.Decrypt<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> analz_synth <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span>synth <span class="free">H</span><span class="main">)</span> <span class="main">=</span> analz <span class="free">H</span> <span class="main">∪</span> synth <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> H <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> analz_synth_Un<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_use</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹chsp: added›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> analz_Un_analz <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> analz <span class="free">H</span><span class="main">)</span> <span class="main">=</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Un_commute<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> analz_synth_Un2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> synth <span class="free">H</span><span class="main">)</span> <span class="main">=</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">∪</span> synth <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Un_commute<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹For reasoning about the Fake rule in traces›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> parts_insert_subset_Un<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span><span class="main">∈</span> <span class="free">G</span> <span class="main">==&gt;</span> parts<span class="main">(</span>insert <span class="free">X</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> parts <span class="free">G</span> <span class="main">∪</span> parts <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> parts_mono parts_Un_subset2<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹More specifically for Fake.  Very occasionally we could do with a version
  of the form  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span><span class="quoted"><span class="quoted">"parts<span class="main"><span class="main">{</span></span><span class="free"><span class="free">X</span></span><span class="main"><span class="main">}</span></span> <span class="main"><span class="main">⊆</span></span> synth <span class="main"><span class="main">(</span></span>analz <span class="free"><span class="free">H</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∪</span></span> parts <span class="free"><span class="free">H</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> Fake_parts_insert<span class="main">:</span>
     <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">==&gt;</span>
      parts <span class="main">(</span>insert <span class="free">X</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">∪</span> parts <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> parts_insert_subset_Un<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_use</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> Fake_parts_insert_in_Un<span class="main">:</span>
     <span class="quoted"><span class="quoted">"<span class="main">[|</span><span class="free">Z</span> <span class="main">∈</span> parts <span class="main">(</span>insert <span class="free">X</span> <span class="free">H</span><span class="main">)</span><span class="main">;</span>  <span class="free">X</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span><span class="main">|]</span>
      <span class="main">==&gt;</span> <span class="free">Z</span> <span class="main">∈</span>  synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">∪</span> parts <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Fake_parts_insert  <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">,</span></span> <span class="operator">dest</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">H</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is sometimes <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span><span class="quoted"><span class="quoted">"Key <span class="main"><span class="main">`</span></span> <span class="free"><span class="free">KK</span></span> <span class="main"><span class="main">∪</span></span> <span class="free"><span class="free">spies</span></span> <span class="free"><span class="free">evs</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, so can't put
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">G</span></span><span class="main"><span class="main">=</span></span><span class="free"><span class="free">H</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> Fake_analz_insert<span class="main">:</span>
     <span class="quoted"><span class="quoted">"<span class="free">X</span><span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">G</span><span class="main">)</span> <span class="main">==&gt;</span>
      analz <span class="main">(</span>insert <span class="free">X</span> <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="free">G</span><span class="main">)</span> <span class="main">∪</span> analz <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">x</span> <span class="main">∈</span> analz <span class="main">(</span>synth <span class="main">(</span>analz <span class="free">G</span><span class="main">)</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> "</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> analz_mono <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span>
                      analz_mono <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> synth_mono<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_use</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> analz_conj_parts <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span> <span class="main">∈</span> analz <span class="free">H</span> <span class="main">&amp;</span> <span class="free">X</span> <span class="main">∈</span> parts <span class="free">H</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">X</span> <span class="main">∈</span> analz <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> analz_subset_parts <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> analz_disj_parts <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span> <span class="main">∈</span> analz <span class="free">H</span> <span class="main">|</span> <span class="free">X</span> <span class="main">∈</span> parts <span class="free">H</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">X</span> <span class="main">∈</span> parts <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> analz_subset_parts <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Without this equation, other rules for synth and analz would yield
  redundant cases›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> MPair_synth_analz <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦃</span><span class="free">X</span><span class="main">,</span><span class="free">Y</span><span class="main">⦄</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="free">X</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">&amp;</span> <span class="free">Y</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> Crypt_synth_analz<span class="main">:</span>
     <span class="quoted"><span class="quoted">"<span class="main">[|</span> Key <span class="free">K</span> <span class="main">∈</span> analz <span class="free">H</span><span class="main">;</span>  Key <span class="main">(</span>invKey <span class="free">K</span><span class="main">)</span> <span class="main">∈</span> analz <span class="free">H</span> <span class="main">|]</span>
       <span class="main">==&gt;</span> <span class="main">(</span>Crypt <span class="free">K</span> <span class="free">X</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">X</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">lemma</span></span> Hash_synth_analz <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
     <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∉</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>
      <span class="main">==&gt;</span> <span class="main">(</span>Hash<span class="main">⦃</span><span class="free">X</span><span class="main">,</span><span class="free">Y</span><span class="main">⦄</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Hash<span class="main">⦃</span><span class="free">X</span><span class="main">,</span><span class="free">Y</span><span class="main">⦄</span> <span class="main">∈</span> analz <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹HPair: a combination of Hash and MPair›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Freeness›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Agent_neq_HPair<span class="main">:</span> <span class="quoted"><span class="quoted">"Agent <span class="free">A</span> <span class="main">~=</span> <span class="keyword1">Hash[</span><span class="free">X</span><span class="main">]</span> <span class="free">Y</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> HPair_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Nonce_neq_HPair<span class="main">:</span> <span class="quoted"><span class="quoted">"Nonce <span class="free">N</span> <span class="main">~=</span> <span class="keyword1">Hash[</span><span class="free">X</span><span class="main">]</span> <span class="free">Y</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> HPair_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Number_neq_HPair<span class="main">:</span> <span class="quoted"><span class="quoted">"Number <span class="free">N</span> <span class="main">~=</span> <span class="keyword1">Hash[</span><span class="free">X</span><span class="main">]</span> <span class="free">Y</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> HPair_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Key_neq_HPair<span class="main">:</span> <span class="quoted"><span class="quoted">"Key <span class="free">K</span> <span class="main">~=</span> <span class="keyword1">Hash[</span><span class="free">X</span><span class="main">]</span> <span class="free">Y</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> HPair_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Hash_neq_HPair<span class="main">:</span> <span class="quoted"><span class="quoted">"Hash <span class="free">Z</span> <span class="main">~=</span> <span class="keyword1">Hash[</span><span class="free">X</span><span class="main">]</span> <span class="free">Y</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> HPair_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Crypt_neq_HPair<span class="main">:</span> <span class="quoted"><span class="quoted">"Crypt <span class="free">K</span> <span class="free">X'</span> <span class="main">~=</span> <span class="keyword1">Hash[</span><span class="free">X</span><span class="main">]</span> <span class="free">Y</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> HPair_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> HPair_neqs <span class="main">=</span> Agent_neq_HPair Nonce_neq_HPair Number_neq_HPair
                    Key_neq_HPair Hash_neq_HPair Crypt_neq_HPair

<span class="keyword1"><span class="command">declare</span></span> HPair_neqs <span class="main">[</span><span class="operator">iff</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> HPair_neqs <span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">iff</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> HPair_eq <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">Hash[</span><span class="free">X'</span><span class="main">]</span> <span class="free">Y'</span> <span class="main">=</span> <span class="keyword1">Hash[</span><span class="free">X</span><span class="main">]</span> <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">X'</span> <span class="main">=</span> <span class="free">X</span> <span class="main">&amp;</span> <span class="free">Y'</span><span class="main">=</span><span class="free">Y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HPair_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> MPair_eq_HPair <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦃</span><span class="free">X'</span><span class="main">,</span><span class="free">Y'</span><span class="main">⦄</span> <span class="main">=</span> <span class="keyword1">Hash[</span><span class="free">X</span><span class="main">]</span> <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">X'</span> <span class="main">=</span> Hash<span class="main">⦃</span><span class="free">X</span><span class="main">,</span><span class="free">Y</span><span class="main">⦄</span> <span class="main">&amp;</span> <span class="free">Y'</span><span class="main">=</span><span class="free">Y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HPair_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> HPair_eq_MPair <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">Hash[</span><span class="free">X</span><span class="main">]</span> <span class="free">Y</span> <span class="main">=</span> <span class="main">⦃</span><span class="free">X'</span><span class="main">,</span><span class="free">Y'</span><span class="main">⦄</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">X'</span> <span class="main">=</span> Hash<span class="main">⦃</span><span class="free">X</span><span class="main">,</span><span class="free">Y</span><span class="main">⦄</span> <span class="main">&amp;</span> <span class="free">Y'</span><span class="main">=</span><span class="free">Y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HPair_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Specialized laws, proved in terms of those for Hash and MPair›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> keysFor_insert_HPair <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"keysFor <span class="main">(</span>insert <span class="main">(</span><span class="keyword1">Hash[</span><span class="free">X</span><span class="main">]</span> <span class="free">Y</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> keysFor <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HPair_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> parts_insert_HPair <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"parts <span class="main">(</span>insert <span class="main">(</span><span class="keyword1">Hash[</span><span class="free">X</span><span class="main">]</span> <span class="free">Y</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span>
     insert <span class="main">(</span><span class="keyword1">Hash[</span><span class="free">X</span><span class="main">]</span> <span class="free">Y</span><span class="main">)</span> <span class="main">(</span>insert <span class="main">(</span>Hash<span class="main">⦃</span><span class="free">X</span><span class="main">,</span><span class="free">Y</span><span class="main">⦄</span><span class="main">)</span> <span class="main">(</span>parts <span class="main">(</span>insert <span class="free">Y</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HPair_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> analz_insert_HPair <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"analz <span class="main">(</span>insert <span class="main">(</span><span class="keyword1">Hash[</span><span class="free">X</span><span class="main">]</span> <span class="free">Y</span><span class="main">)</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span>
     insert <span class="main">(</span><span class="keyword1">Hash[</span><span class="free">X</span><span class="main">]</span> <span class="free">Y</span><span class="main">)</span> <span class="main">(</span>insert <span class="main">(</span>Hash<span class="main">⦃</span><span class="free">X</span><span class="main">,</span><span class="free">Y</span><span class="main">⦄</span><span class="main">)</span> <span class="main">(</span>analz <span class="main">(</span>insert <span class="free">Y</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HPair_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> HPair_synth_analz <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
     <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∉</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>
    <span class="main">==&gt;</span> <span class="main">(</span><span class="keyword1">Hash[</span><span class="free">X</span><span class="main">]</span> <span class="free">Y</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span>Hash<span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">⦄</span> <span class="main">∈</span> analz <span class="free">H</span> <span class="main">&amp;</span> <span class="free">Y</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HPair_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We do NOT want Crypt... messages broken up in protocols!!›</span></span>
<span class="keyword1"><span class="command">declare</span></span> parts.Body <span class="main">[</span><span class="operator">rule</span> <span class="quasi_keyword">del</span><span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Rewrites to push in Key and Crypt messages, so that other messages can
    be pulled out using the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>analz_insert›</span></span></span></span> rules›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> pushKeys <span class="main">=</span>
  insert_commute <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Key <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"Agent <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">K</span> <span class="free">C</span><span class="main">]</span>
  insert_commute <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Key <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"Nonce <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">K</span> <span class="free">N</span><span class="main">]</span>
  insert_commute <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Key <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"Number <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">K</span> <span class="free">N</span><span class="main">]</span>
  insert_commute <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Key <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"Hash <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">K</span> <span class="free">X</span><span class="main">]</span>
  insert_commute <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Key <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"MPair <span class="free">X</span> <span class="free">Y</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">K</span> <span class="free">X</span> <span class="free">Y</span><span class="main">]</span>
  insert_commute <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Key <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"Crypt <span class="free">X</span> <span class="free">K'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">K</span> <span class="free">K'</span> <span class="free">X</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> pushCrypts <span class="main">=</span>
  insert_commute <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Crypt <span class="free">X</span> <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"Agent <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">X</span> <span class="free">K</span> <span class="free">C</span><span class="main">]</span>
  insert_commute <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Crypt <span class="free">X</span> <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"Agent <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">X</span> <span class="free">K</span> <span class="free">C</span><span class="main">]</span>
  insert_commute <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Crypt <span class="free">X</span> <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"Nonce <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">X</span> <span class="free">K</span> <span class="free">N</span><span class="main">]</span>
  insert_commute <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Crypt <span class="free">X</span> <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"Number <span class="free">N</span>"</span></span>  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">X</span> <span class="free">K</span> <span class="free">N</span><span class="main">]</span>
  insert_commute <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Crypt <span class="free">X</span> <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"Hash <span class="free">X'</span>"</span></span>  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">X</span> <span class="free">K</span> <span class="free">X'</span><span class="main">]</span>
  insert_commute <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Crypt <span class="free">X</span> <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"MPair <span class="free">X'</span> <span class="free">Y</span>"</span></span>  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">X</span> <span class="free">K</span> <span class="free">X'</span> <span class="free">Y</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Cannot be added with <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>[simp]›</span></span></span></span> -- messages should not always be
  re-ordered.›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> pushes <span class="main">=</span> pushKeys pushCrypts


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹By default only <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>o_apply›</span></span></span></span> is built-in.  But in the presence of
eta-expansion this means that some terms displayed as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">f</span></span> <span class="keyword1"><span class="keyword1">o</span></span> <span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> will be
rewritten, and others will not!›</span></span>
<span class="keyword1"><span class="command">declare</span></span> o_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>


<span class="keyword1"><span class="command">lemma</span></span> Crypt_notin_image_Key <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Crypt <span class="free">K</span> <span class="free">X</span> <span class="main">∉</span> Key <span class="main">`</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Hash_notin_image_Key <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">:</span><span class="quoted"><span class="quoted">"Hash <span class="free">X</span> <span class="main">∉</span> Key <span class="main">`</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> synth_analz_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G</span><span class="main">⊆</span><span class="free">H</span> <span class="main">==&gt;</span> synth <span class="main">(</span>analz<span class="main">(</span><span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> synth <span class="main">(</span>analz<span class="main">(</span><span class="free">H</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> synth_mono analz_mono<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Fake_analz_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
     <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> synth<span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">==&gt;</span> synth <span class="main">(</span>analz <span class="main">(</span>insert <span class="free">X</span> <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> Fake_analz_insert<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">H</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> synth_increasing<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> Un_absorb2<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> synth_mono<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> synth_idem<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> equalityI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> synth_analz_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Two generalizations of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>analz_insert_eq›</span></span></span></span>›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> gen_analz_insert_eq <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
     <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> analz <span class="free">H</span> <span class="main">==&gt;</span> <span class="keyword1">ALL</span> <span class="bound">G</span><span class="main">.</span> <span class="free">H</span> <span class="main">⊆</span> <span class="bound">G</span> <span class="main">--&gt;</span> analz <span class="main">(</span>insert <span class="free">X</span> <span class="bound">G</span><span class="main">)</span> <span class="main">=</span> analz <span class="bound">G</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> analz_cut analz_insertI analz_mono <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> synth_analz_insert_eq <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
     <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span>
      <span class="main">==&gt;</span> <span class="keyword1">ALL</span> <span class="bound">G</span><span class="main">.</span> <span class="free">H</span> <span class="main">⊆</span> <span class="bound">G</span> <span class="main">--&gt;</span> <span class="main">(</span>Key <span class="free">K</span> <span class="main">∈</span> analz <span class="main">(</span>insert <span class="free">X</span> <span class="bound">G</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Key <span class="free">K</span> <span class="main">∈</span> analz <span class="bound">G</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> synth.induct<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gen_analz_insert_eq subset_trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ subset_insertI<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> Fake_parts_sing<span class="main">:</span>
     <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">==&gt;</span> parts<span class="main">{</span><span class="free">X</span><span class="main">}</span> <span class="main">⊆</span> synth <span class="main">(</span>analz <span class="free">H</span><span class="main">)</span> <span class="main">∪</span> parts <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> Fake_parts_insert<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> parts_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> Fake_parts_sing_imp_Un <span class="main">=</span> Fake_parts_sing <span class="main">[</span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> rev_subsetD<span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹For some reason, moving this up can make some proofs loop!›</span></span>
<span class="keyword1"><span class="command">declare</span></span> invKey_K <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="s0g_secrecy">
<div class="head">
<h1>Theory s0g_secrecy</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Development of Security Protocols by Refinement

  Module:  Refinement/s0g_secrecy.thy (Isabelle/HOL 2016-1)
  ID:      $Id: s0g_secrecy.thy 134924 2017-05-24 17:23:15Z csprenge $
  Author:  Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  Key distribution protocols
  Initial Model: Secrecy (global version)

  Copyright (c) 2009-2016 Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Secrecy with Leaking (global version)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> s0g_secrecy <span class="keyword2"><span class="keyword">imports</span></span> <a href="Refinement.html">Refinement</a> <a href="Agents.html">Agents</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This model extends the global secrecy model by adding a <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>leak›</span></span></span></span> 
event, which models that the adversary can learn messages through leaks of 
some (unspecified) kind.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Proof tool configuration. Avoid annoying automatic unfolding of
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>dom›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">declare</span></span> domIff <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">iff</span> <span class="quasi_keyword">del</span><span class="main">]</span> 


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹State›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The only state variable is a knowledge relation, an authorization 
relation, and a leakage relation. 

<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">d</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">A</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">kn</span></span> <span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> means that the agent <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> knows data <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">d</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">d</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">A</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">az</span></span> <span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> means that the agent <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is authorized to 
know data <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">d</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">d</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">A</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">lk</span></span> <span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> means that data <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">d</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> has leaked to agent 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Leakage models potential unauthorized knowledge.
›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="tfree">'d</span> s0g_state <span class="main">=</span> 
  kn <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> agent<span class="main">)</span> set"</span></span>
  az <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> agent<span class="main">)</span> set"</span></span>
  lk <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'d</span> set"</span></span>                         <span class="comment1">― ‹leaked data›</span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  <span class="tfree">'d</span> s0g_obs <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'d</span> s0g_state"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lkr</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> lk <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">×</span> UNIV"</span></span>

<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariant definitions›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Global secrecy is stated as an invariant.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">s0g_secrecy</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'d</span> s0g_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">s0g_secrecy</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> kn <span class="bound">s</span> <span class="main">⊆</span> az <span class="bound">s</span> <span class="main">∪</span> lkr <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> s0g_secrecyI <span class="main">=</span> s0g_secrecy_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> s0g_secrecyE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> 
  s0g_secrecy_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Data that someone is authorized to know and leaked data is known 
by someone.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">s0g_dom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'d</span> s0g_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">s0g_dom</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> Domain <span class="main">(</span>az <span class="bound">s</span> <span class="main">∪</span> lkr <span class="bound">s</span><span class="main">)</span> <span class="main">⊆</span> Domain <span class="main">(</span>kn <span class="bound">s</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> s0g_domI <span class="main">=</span> s0g_dom_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> s0g_domE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> s0g_dom_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Events›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹New secrets may be generated anytime.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">s0g_gen</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'d</span><span class="main">,</span> agent<span class="main">,</span> agent set<span class="main">]</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'d</span> s0g_state <span class="main">×</span> <span class="tfree">'d</span> s0g_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">s0g_gen</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">∧</span>    
    <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">∉</span> Domain <span class="main">(</span>kn <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>                      <span class="comment1">― ‹fresh item›</span>
 
    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> 
      kn <span class="main">:=</span> insert <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>kn <span class="bound">s</span><span class="main">)</span><span class="main">,</span> 
      az <span class="main">:=</span> az <span class="bound">s</span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">}</span> <span class="main">×</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">∩</span> bad <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="keyword1">else</span> UNIV<span class="main">)</span>
    <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Learning secrets.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">s0g_learn</span> <span class="main">::</span> 
    <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'d</span><span class="main">,</span> agent<span class="main">]</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'d</span> s0g_state <span class="main">×</span> <span class="tfree">'d</span> s0g_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">s0g_learn</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>d ∈ Domain (kn s) ∧›</span></span> someone knows <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>d›</span></span> (follows from authorization)›</span>

    <span class="comment1">― ‹check authorization or leakage to preserve secrecy›</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">∈</span> az <span class="bound">s</span> <span class="main">∪</span> lkr <span class="bound">s</span> <span class="main">∧</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> kn <span class="main">:=</span> insert <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">(</span>kn <span class="bound">s</span><span class="main">)</span> <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Leaking secrets.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">s0g_leak</span> <span class="main">::</span> 
    <span class="quoted"><span class="quoted">"<span class="tfree">'d</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'d</span> s0g_state <span class="main">×</span> <span class="tfree">'d</span> s0g_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">s0g_leak</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">∈</span> Domain <span class="main">(</span>kn <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>       <span class="comment1">― ‹someone knows <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>d›</span></span>›</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> lk <span class="main">:=</span> insert <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">(</span>lk <span class="bound">s</span><span class="main">)</span> <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Specification›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">s0g_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'d</span> s0g_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s0g_init</span> <span class="main">≡</span> s0g_secrecy <span class="main">∩</span> s0g_dom"</span></span>   <span class="comment1">― ‹any state satisfying invariants›</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">s0g_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'d</span> s0g_state <span class="main">×</span> <span class="tfree">'d</span> s0g_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s0g_trans</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">d</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">G</span><span class="main">.</span>
     s0g_gen <span class="bound">d</span> <span class="bound">A</span> <span class="bound">G</span> <span class="main">∪</span>  
     s0g_learn <span class="bound">d</span> <span class="bound">B</span> <span class="main">∪</span> 
     s0g_leak <span class="bound">d</span> <span class="main">∪</span> 
     Id
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">s0g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'d</span> s0g_state<span class="main">,</span> <span class="tfree">'d</span> s0g_obs<span class="main">)</span> spec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s0g</span> <span class="main">≡</span> <span class="main">⦇</span>
    init <span class="main">=</span> s0g_init<span class="main">,</span>
    trans <span class="main">=</span> s0g_trans<span class="main">,</span>
    obs <span class="main">=</span> id
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> s0g_defs <span class="main">=</span> 
  s0g_def s0g_init_def s0g_trans_def
  s0g_gen_def s0g_learn_def s0g_leak_def

<span class="keyword1"><span class="command">lemma</span></span> s0g_obs_id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"obs s0g <span class="main">=</span> id"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s0g_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All state predicates are trivially observable.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> s0g_anyP_observable <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"observable <span class="main">(</span>obs s0g<span class="main">)</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariant proofs›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹inv1: Secrecy›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_s0g_secrecy_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init s0g <span class="main">⊆</span> s0g_secrecy"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s0g_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> s0g_secrecyI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_s0g_secrecy_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>s0g_secrecy<span class="main">}</span> trans s0g <span class="main">{&gt;</span> s0g_secrecy<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s0g_defs PO_hoare_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> s0g_secrecyI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_s0g_secrecy <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"reach s0g <span class="main">⊆</span> s0g_secrecy"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹As en external invariant.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_s0g_obs_secrecy <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"oreach s0g <span class="main">⊆</span> s0g_secrecy"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> external_from_internal_invariant<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹inv2: Authorized and leaked data is known to someone›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_s0g_dom_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init s0g <span class="main">⊆</span> s0g_dom"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s0g_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> s0g_domI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_s0g_dom_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>s0g_dom<span class="main">}</span> trans s0g <span class="main">{&gt;</span> s0g_dom<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s0g_defs PO_hoare_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> s0g_domI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_s0g_dom <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach s0g <span class="main">⊆</span> s0g_dom"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹As en external invariant.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_s0g_obs_dom <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach s0g <span class="main">⊆</span> s0g_dom"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> external_from_internal_invariant<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="a0n_agree">
<div class="head">
<h1>Theory a0n_agree</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Development of Security Protocols by Refinement

  Module:  Refinement/a0n_agree.thy (Isabelle/HOL 2016-1)
  ID:      $Id: a0n_agree.thy 134924 2017-05-24 17:23:15Z csprenge $
  Author:  Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  One-Way authentication protocols
  Initial Model: Non-injective agreement 

  Copyright (c) 2009-2016 Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Non-injective Agreement›</span></span>

<span class="keyword1"><span class="command">theory</span></span> a0n_agree <span class="keyword2"><span class="keyword">imports</span></span> <a href="Refinement.html">Refinement</a> <a href="Agents.html">Agents</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The initial model abstractly specifies entity authentication, where 
one agent/role authenticates another. More precisely, this property corresponds 
to non-injective agreement on a data set <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ds›</span></span></span></span>. We use Running and Commit 
signals to obtain a protocol-independent extensional specification.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Proof tool configuration. Avoid annoying automatic unfolding of
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>dom›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">declare</span></span> domIff <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">iff</span> <span class="quasi_keyword">del</span><span class="main">]</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹State›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Signals. At this stage there are no protocol runs yet. All we model
are the signals that indicate a certain progress of a protocol run by one 
agent/role (Commit signal) and the other role (Running signal). The signals 
contain a list of agents that are assumed to be honest and a polymorphic data 
set to be agreed upon, which is instantiated later. 

Usually, the agent list will contain the names of the two agents who want to
agree on the data, but sometimes one of the agents is honest by assumption 
(e.g., the server) or the honesty of additional agents needs to be assumed
for the agreement to hold.›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'ds</span> signal <span class="main">=</span>
  Running <span class="quoted"><span class="quoted">"agent list"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'ds</span>"</span></span> 
<span class="main">|</span> Commit <span class="quoted"><span class="quoted">"agent list"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'ds</span>"</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="tfree">'ds</span> a0n_state <span class="main">=</span> 
  signals <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'ds</span> signal <span class="main">⇒</span> nat"</span></span>    <span class="comment1">― ‹multi-set of signals›</span>
  corrupted <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'ds</span> set"</span></span>            <span class="comment1">― ‹set of corrupted data›</span>

<span class="keyword1"><span class="command">type_synonym</span></span> 
  <span class="tfree">'ds</span> a0n_obs <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'ds</span> a0n_state"</span></span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Events›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">a0n_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'ds</span> a0n_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">a0n_init</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∃</span><span class="bound">ds</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">⦇</span>
     signals <span class="main">=</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">,</span>
     corrupted <span class="main">=</span> <span class="bound">ds</span>
  <span class="main">⦈</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Running signal, indicating end of responder run.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">a0n_running</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>agent list<span class="main">,</span> <span class="tfree">'ds</span><span class="main">]</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'ds</span> a0n_state <span class="main">×</span> <span class="tfree">'ds</span> a0n_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">a0n_running</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> 
      signals <span class="main">:=</span> <span class="main">(</span>signals <span class="bound">s</span><span class="main">)</span><span class="main">(</span>Running <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">:=</span> signals <span class="bound">s</span> <span class="main">(</span>Running <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> 
    <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Commit signal, marking end of initiator run.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">a0n_commit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>agent list<span class="main">,</span> <span class="tfree">'ds</span><span class="main">]</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'ds</span> a0n_state <span class="main">×</span> <span class="tfree">'ds</span> a0n_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">a0n_commit</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">⊆</span> good <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">∉</span> corrupted <span class="bound">s</span> <span class="main">⟶</span> signals <span class="bound">s</span> <span class="main">(</span>Running <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> 
      signals <span class="main">:=</span> <span class="main">(</span>signals <span class="bound">s</span><span class="main">)</span><span class="main">(</span>Commit <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">:=</span> signals <span class="bound">s</span> <span class="main">(</span>Commit <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> 
    <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Data corruption.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">a0n_corrupt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'ds</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'ds</span> a0n_state <span class="main">×</span> <span class="tfree">'ds</span> a0n_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">a0n_corrupt</span> <span class="free"><span class="bound"><span class="entity">ds</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> 
      corrupted <span class="main">:=</span> corrupted <span class="bound">s</span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">ds</span></span></span> 
    <span class="main">⦈</span>   
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Transition system.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">a0n_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'ds</span> a0n_state <span class="main">×</span> <span class="tfree">'ds</span> a0n_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">a0n_trans</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">h</span> <span class="bound">d</span> <span class="bound">ds</span><span class="main">.</span>
     a0n_running <span class="bound">h</span> <span class="bound">d</span> <span class="main">∪</span>
     a0n_commit <span class="bound">h</span> <span class="bound">d</span> <span class="main">∪</span> 
     a0n_corrupt <span class="bound">ds</span> <span class="main">∪</span> 
     Id
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">a0n</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'ds</span> a0n_state<span class="main">,</span> <span class="tfree">'ds</span> a0n_obs<span class="main">)</span> spec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">a0n</span> <span class="main">≡</span> <span class="main">⦇</span>
    init <span class="main">=</span> a0n_init<span class="main">,</span>
    trans <span class="main">=</span> a0n_trans<span class="main">,</span> 
    obs <span class="main">=</span> id
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> a0n_defs <span class="main">=</span> 
  a0n_def a0n_init_def a0n_trans_def 
  a0n_running_def a0n_commit_def a0n_corrupt_def


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Any property is trivially observable.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> a0n_obs <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"obs a0n<span class="main">=</span> id"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a0n_def<span class="main">)</span>  

<span class="keyword1"><span class="command">lemma</span></span> a0n_anyP_observable <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"observable <span class="main">(</span>obs a0n<span class="main">)</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>  


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹inv1: non-injective agreement›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This is an extensional variant of Lowe's \emph{non-injective agreement}
of the first with the second agent (by convention) in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>h›</span></span></span></span> on data 
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>d›</span></span></span></span> [Lowe97]. 
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">a0n_inv1_niagree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'ds</span> a0n_state set"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">a0n_inv1_niagree</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">h</span> <span class="bound">d</span><span class="main">.</span>
     set <span class="bound">h</span> <span class="main">⊆</span> good <span class="main">⟶</span> <span class="bound">d</span> <span class="main">∉</span> corrupted <span class="bound">s</span> <span class="main">⟶</span>
       signals <span class="bound">s</span> <span class="main">(</span>Commit <span class="bound">h</span> <span class="bound">d</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span> signals <span class="bound">s</span> <span class="main">(</span>Running <span class="bound">h</span> <span class="bound">d</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> a0n_inv1_niagreeI <span class="main">=</span> 
  a0n_inv1_niagree_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> a0n_inv1_niagreeE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> 
  a0n_inv1_niagree_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> a0n_inv1_niagreeD <span class="main">=</span> 
  a0n_inv1_niagree_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 2<span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_a0n_inv1_niagree_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init a0n <span class="main">⊆</span> a0n_inv1_niagree"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a0n_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a0n_inv1_niagreeI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_a0n_inv1_niagree_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>a0n_inv1_niagree<span class="main">}</span> trans a0n <span class="main">{&gt;</span> a0n_inv1_niagree<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs a0n_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a0n_inv1_niagreeI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a0n_inv1_niagreeD <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_a0n_inv1_niagree <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach a0n <span class="main">⊆</span> a0n_inv1_niagree"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This is also an external invariant.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> a0n_obs_inv1_niagree <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"oreach a0n <span class="main">⊆</span> a0n_inv1_niagree"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> external_from_internal_invariant<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> a0n_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="a0i_agree">
<div class="head">
<h1>Theory a0i_agree</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Development of Security Protocols by Refinement

  Module:  Refinement/a0i_agree.thy (Isabelle/HOL 2016-1)
  ID:      $Id: a0i_agree.thy 134924 2017-05-24 17:23:15Z csprenge $
  Author:  Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  One-Way authentication protocols
  Initial Model: Injective agreement

  Copyright (c) 2009-2016 Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Injective Agreement›</span></span>

<span class="keyword1"><span class="command">theory</span></span> a0i_agree <span class="keyword2"><span class="keyword">imports</span></span> <a href="a0n_agree.html">a0n_agree</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This refinement adds injectiveness to the agreement property.›</span></span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹State›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The state and observations are the same as in the previous model.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  <span class="tfree">'d</span> a0i_state <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'d</span> a0n_state"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  <span class="tfree">'d</span> a0i_obs <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'d</span> a0n_obs"</span></span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Events›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We just refine the commit event. Everything else remains the same.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">a0i_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'ds</span> a0n_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">a0i_init</span> <span class="main">≡</span> a0n_init"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">a0i_running</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>agent list<span class="main">,</span> <span class="tfree">'ds</span><span class="main">]</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'ds</span> a0i_state <span class="main">×</span> <span class="tfree">'ds</span> a0i_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">a0i_running</span> <span class="main">≡</span> a0n_running"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">a0i_commit</span> <span class="main">::</span> 
    <span class="quoted"><span class="quoted">"<span class="main">[</span>agent list<span class="main">,</span> <span class="tfree">'ds</span><span class="main">]</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'ds</span> a0i_state <span class="main">×</span> <span class="tfree">'ds</span> a0i_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">a0i_commit</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">⊆</span> good <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">∉</span> corrupted <span class="bound">s</span> <span class="main">⟶</span>
       signals <span class="bound">s</span> <span class="main">(</span>Commit <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">&lt;</span> signals <span class="bound">s</span> <span class="main">(</span>Running <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> 
      signals <span class="main">:=</span> <span class="main">(</span>signals <span class="bound">s</span><span class="main">)</span><span class="main">(</span>Commit <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">:=</span> signals <span class="bound">s</span> <span class="main">(</span>Commit <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> 
    <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">a0i_corrupt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'ds</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'ds</span> a0i_state <span class="main">×</span> <span class="tfree">'ds</span> a0i_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">a0i_corrupt</span> <span class="main">≡</span> a0n_corrupt"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Transition system.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">a0i_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'ds</span> a0i_state <span class="main">×</span> <span class="tfree">'ds</span> a0i_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">a0i_trans</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">h</span> <span class="bound">d</span> <span class="bound">ds</span><span class="main">.</span>
     a0i_running <span class="bound">h</span> <span class="bound">d</span> <span class="main">∪</span>
     a0i_commit <span class="bound">h</span> <span class="bound">d</span> <span class="main">∪</span> 
     a0i_corrupt <span class="bound">ds</span> <span class="main">∪</span> 
     Id
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">a0i</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'ds</span> a0i_state<span class="main">,</span> <span class="tfree">'ds</span> a0i_obs<span class="main">)</span> spec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">a0i</span> <span class="main">≡</span> <span class="main">⦇</span>
    init <span class="main">=</span> a0i_init<span class="main">,</span>
    trans <span class="main">=</span> a0i_trans<span class="main">,</span> 
    obs <span class="main">=</span> id
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> a0i_defs <span class="main">=</span> 
  a0n_defs a0i_def a0i_trans_def a0i_commit_def


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Any property is trivially observable.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> a0i_obs <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"obs a0i <span class="main">=</span> id"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a0i_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> a0i_anyP_observable <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"observable <span class="main">(</span>obs a0i<span class="main">)</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>  


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Injective agreement.›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">a0i_inv1_iagree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'ds</span> a0i_state set"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">a0i_inv1_iagree</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">h</span> <span class="bound">d</span><span class="main">.</span>
     set <span class="bound">h</span> <span class="main">⊆</span> good <span class="main">⟶</span> <span class="bound">d</span> <span class="main">∉</span> corrupted <span class="bound">s</span> <span class="main">⟶</span>
       signals <span class="bound">s</span> <span class="main">(</span>Commit <span class="bound">h</span> <span class="bound">d</span><span class="main">)</span> <span class="main">≤</span> signals <span class="bound">s</span> <span class="main">(</span>Running <span class="bound">h</span> <span class="bound">d</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> a0i_inv1_iagreeI <span class="main">=</span> 
  a0i_inv1_iagree_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> a0i_inv1_iagreeE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> 
  a0i_inv1_iagree_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> a0i_inv1_iagreeD <span class="main">=</span> 
  a0i_inv1_iagree_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>


<span class="keyword1"><span class="command">lemma</span></span> PO_a0i_inv1_iagree_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init a0i <span class="main">⊆</span> a0i_inv1_iagree"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a0i_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a0i_inv1_iagreeI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_a0i_inv1_iagree_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>a0i_inv1_iagree<span class="main">}</span> trans a0i <span class="main">{&gt;</span> a0i_inv1_iagree<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs a0i_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a0i_inv1_iagreeI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> a0i_inv1_iagreeD <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> le_SucI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_a0i_inv1_iagree <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach a0i <span class="main">⊆</span> a0i_inv1_iagree"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹As an external invariant.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_a0i_obs_inv1_iagree <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach a0i <span class="main">⊆</span> a0i_inv1_iagree"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> external_from_internal_invariant<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> a0i_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">med0n0i</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'d</span> a0i_obs <span class="main">⇒</span> <span class="tfree">'d</span> a0i_obs"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med0n0i</span> <span class="main">≡</span> id"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R0n0i</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'d</span> a0n_state <span class="main">×</span> <span class="tfree">'d</span> a0i_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R0n0i</span> <span class="main">≡</span> Id"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_a0i_running_refines_a0n_running<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R0n0i<span class="main">}</span> 
     <span class="main">(</span>a0n_running <span class="free">h</span> <span class="free">d</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>a0i_running <span class="free">h</span> <span class="free">d</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R0n0i<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> R0n0i_def<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> relhoare_refl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_a0i_commit_refines_a0n_commit<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R0n0i<span class="main">}</span> 
     <span class="main">(</span>a0n_commit <span class="free">h</span> <span class="free">d</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>a0i_commit <span class="free">h</span> <span class="free">d</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R0n0i<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R0n0i_def a0i_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_a0i_corrupt_refines_a0n_corrupt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R0n0i<span class="main">}</span> 
     <span class="main">(</span>a0n_corrupt <span class="free">d</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>a0i_corrupt <span class="free">d</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R0n0i<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> R0n0i_def<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> relhoare_refl<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_a0i_trans_refines_a0n_trans <span class="main">=</span> 
  PO_a0i_running_refines_a0n_running
  PO_a0i_commit_refines_a0n_commit
  PO_a0i_corrupt_refines_a0n_corrupt


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All together now...›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_refines_init_a0n <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init a0i <span class="main">⊆</span> R0n0i<span class="main">``</span><span class="main">(</span>init a0n<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R0n0i_def a0i_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_refines_trans_a0n <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R0n0i<span class="main">}</span> 
     <span class="main">(</span>trans a0n<span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans a0i<span class="main">)</span> 
   <span class="main">{&gt;</span> R0n0i<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a0n_def a0n_trans_def a0i_def a0i_trans_def
         <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_a0i_trans_refines_a0n_trans<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> PO_obs_consistent <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"obs_consistent R0n0i med0n0i a0n a0i"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R0n0i_def med0n0i_def a0i_def a0n_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_a0i_refines_a0n<span class="main">:</span>
  <span class="quoted"><span class="quoted">"refines R0n0i med0n0i a0n a0i"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Refinement_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Derived invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> iagree_implies_niagree <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"a0i_inv1_iagree <span class="main">⊆</span> a0n_inv1_niagree"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a0n_inv1_niagreeI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> d<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">d</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> a0i_inv1_iagreeD<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Non-injective agreeement as internal and external invariants.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_a0i_a0n_inv1_niagree <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach a0i <span class="main">⊆</span> a0n_inv1_niagree"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_a0i_obs_a0n_inv1_niagree <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach a0i <span class="main">⊆</span> a0n_inv1_niagree"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="m1_auth">
<div class="head">
<h1>Theory m1_auth</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Development of Security Protocols by Refinement

  Module:  Auth_simple/m1_auth.thy (Isabelle/HOL 2016-1)
  ID:      $Id: m1_auth.thy 134925 2017-05-24 17:53:14Z csprenge $
  Author:  Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  One-Way authentication protocols
  Refinement 1: Direct memory access protocol 

  Copyright (c) 2009-2016 Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Unidirectional Authentication Protocols›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this chapter, we derive some simple unilateral authentication 
protocols. We have a single abstract model at Level 1. We then refine this model 
into two channel protocols (Level 2), one using authentic channels and one using 
confidential channels. We then refine these in turn into cryptographic protocols 
(Level 3) respectively using signatures and public-key encryption.
›</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Refinement 1: Abstract Protocol›</span></span>

<span class="keyword1"><span class="command">theory</span></span> m1_auth <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Runs.html">../Refinement/Runs</a>"</span> <span class="quoted">"<a href="a0i_agree.html">../Refinement/a0i_agree</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* declare option.split_asm [split] *)</span>
<span class="keyword1"><span class="command">declare</span></span> domIff <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">iff</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹State›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We introduce protocol runs.›</span></span>

<span class="keyword1"><span class="command">record</span></span> m1_state <span class="main">=</span> 
  runs <span class="main">::</span> <span class="quoted">runs_t</span>

<span class="keyword1"><span class="command">type_synonym</span></span> 
  m1_obs <span class="main">=</span> <span class="quoted">m1_state</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m1_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m1_state set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_init</span> <span class="main">≡</span> <span class="main">{</span> <span class="main">⦇</span> 
     runs <span class="main">=</span> Map.empty 
  <span class="main">⦈</span> <span class="main">}</span>"</span></span>

<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Events›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>   <span class="comment1">― ‹refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">skip</span></span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1_step1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">]</span> <span class="main">⇒</span> <span class="main">(</span>m1_state <span class="main">×</span> m1_state<span class="main">)</span> set"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>  
  <span class="quoted"><span class="quoted">"<span class="free">m1_step1</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>  

     <span class="comment1">― ‹guards›</span>
     <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>              <span class="comment1">― ‹new initiator run›</span>
     <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span><span class="main">0</span> <span class="main">∧</span>                      <span class="comment1">― ‹generated nonce›</span>

     <span class="comment1">― ‹actions›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> 
       runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span>
         <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>
       <span class="main">)</span>  
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>   <span class="comment1">― ‹refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">a0i_running</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1_step2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> nonce<span class="main">]</span> <span class="main">⇒</span> <span class="main">(</span>m1_state <span class="main">×</span> m1_state<span class="main">)</span> set"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_step2</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Nb</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Ni›</span></span> is completely arbitrary›</span>

     <span class="comment1">― ‹guards›</span>
     <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>              <span class="comment1">― ‹new responder run›</span>
     <span class="free"><span class="bound"><span class="entity">Nb</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span><span class="main">0</span> <span class="main">∧</span>                      <span class="comment1">― ‹generated nonce›</span>

     <span class="comment1">― ‹actions›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
       runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>   <span class="comment1">― ‹refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">a0i_commit</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1_step3</span> <span class="main">::</span> 
    <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> nonce<span class="main">]</span> <span class="main">⇒</span> <span class="main">(</span>m1_state <span class="main">×</span> m1_state<span class="main">)</span> set"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_step3</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Nb</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>

     <span class="comment1">― ‹guards›</span>
     runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>
     <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span><span class="main">0</span> <span class="main">∧</span>

     <span class="comment1">― ‹authentication guard:›</span>
     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∉</span> bad <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∉</span> bad <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Rb</span><span class="main">.</span> 
        <span class="free"><span class="bound"><span class="entity">Nb</span></span></span> <span class="main">=</span> <span class="bound">Rb</span><span class="main">$</span><span class="main">0</span> <span class="main">∧</span> runs <span class="bound">s</span> <span class="bound">Rb</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>

     <span class="comment1">― ‹actions›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
       runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Transition system.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m1_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m1_state <span class="main">×</span> m1_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_trans</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Ra</span> <span class="bound">Rb</span> <span class="bound">Na</span> <span class="bound">Nb</span><span class="main">.</span>
     m1_step1 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span>    <span class="main">∪</span>
     m1_step2 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Nb</span> <span class="main">∪</span>
     m1_step3 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Nb</span> <span class="main">∪</span>
     Id
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m1_state<span class="main">,</span> m1_obs<span class="main">)</span> spec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="main">≡</span> <span class="main">⦇</span>
    init <span class="main">=</span> m1_init<span class="main">,</span>
    trans <span class="main">=</span> m1_trans<span class="main">,</span> 
    obs <span class="main">=</span> id
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m1_defs <span class="main">=</span> 
  m1_def m1_init_def m1_trans_def
  m1_step1_def m1_step2_def m1_step3_def 


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Simulation relation›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define two auxiliary functions to reconstruct the signals of the
initial model from completed initiator and responder runs of the current one.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> 
  irsig <span class="main">=</span> <span class="quoted"><span class="quoted">"nonce <span class="main">×</span> nonce"</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">runs2sigs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"runs_t <span class="main">⇒</span> irsig signal <span class="main">⇒</span> nat"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">runs2sigs</span> <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="main">(</span>Commit <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span><span class="main">0</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">]</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">runs2sigs</span> <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="main">(</span>Running <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">]</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">runs2sigs</span> <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">0</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Simulation relation and mediator function. We map completed initiator 
and responder runs to commit and running signals, respectively.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">med10</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m1_obs <span class="main">⇒</span> irsig a0i_obs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med10</span> <span class="free"><span class="bound"><span class="entity">o1</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> signals <span class="main">=</span> runs2sigs <span class="main">(</span>runs <span class="free"><span class="bound"><span class="entity">o1</span></span></span><span class="main">)</span><span class="main">,</span> corrupted <span class="main">=</span> <span class="main">{}</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R01</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>irsig a0i_state <span class="main">×</span> m1_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R01</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> signals <span class="bound">s</span> <span class="main">=</span> runs2sigs <span class="main">(</span>runs <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> corrupted <span class="bound">s</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> R01_defs <span class="main">=</span> R01_def med10_def 


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Lemmas about the auxiliary functions›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Basic lemmas›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> runs2sigs_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">runz</span> <span class="main">=</span> Map.empty <span class="main">⟹</span> runs2sigs <span class="free">runz</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span> 
   <span class="main">(</span><span class="operator">rule</span> runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Update lemmas›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> runs2sigs_upd_init_none <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Ra</span> <span class="main">∉</span> dom <span class="free">runz</span> <span class="main">⟧</span>
  <span class="main">⟹</span> runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Ra</span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> runs2sigs <span class="free">runz</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span>
   <span class="main">(</span><span class="operator">rule</span> runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> runs2sigs_upd_init_some <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">runz</span> <span class="free">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Ra</span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="free">Nb</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
     <span class="main">(</span>runs2sigs <span class="free">runz</span><span class="main">)</span><span class="main">(</span>Commit <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span> <span class="main">(</span><span class="free">Ra</span><span class="main">$</span><span class="main">0</span><span class="main">,</span> <span class="free">Nb</span><span class="main">)</span> <span class="main">:=</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span> 
   <span class="main">(</span><span class="operator">rule</span> runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> runs2sigs_upd_resp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Rb</span> <span class="main">∉</span> dom <span class="free">runz</span> <span class="main">⟧</span>
  <span class="main">⟹</span> runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Rb</span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="free">Na</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
     <span class="main">(</span>runs2sigs <span class="free">runz</span><span class="main">)</span><span class="main">(</span>Running <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span> <span class="main">(</span><span class="free">Na</span><span class="main">,</span> <span class="free">Rb</span><span class="main">$</span><span class="main">0</span><span class="main">)</span> <span class="main">:=</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> rev_mp<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span> 
   <span class="main">(</span><span class="operator">rule</span> runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step1_refines_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R01<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R01<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_def R01_defs a0i_defs m1_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step2_refines_a0i_running<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R01<span class="main">}</span> 
     <span class="main">(</span>a0i_running <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span> <span class="main">(</span><span class="free">Na</span><span class="main">,</span> <span class="free">Nb</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Nb</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R01<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R01_defs a0i_defs m1_defs <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step3_refines_a0i_commit<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R01<span class="main">}</span> 
     <span class="main">(</span>a0i_commit <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span> <span class="main">(</span><span class="free">Na</span><span class="main">,</span> <span class="free">Nb</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1_step3 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Nb</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R01<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R01_defs a0i_defs m1_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_m1_trans_refines_a0i_trans <span class="main">=</span> 
  PO_m1_step1_refines_skip PO_m1_step2_refines_a0i_running
  PO_m1_step3_refines_a0i_commit


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All together now...›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_refines_init_a0i <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m1 <span class="main">⊆</span> R01<span class="main">``</span><span class="main">(</span>init a0i<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R01_defs a0i_defs m1_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_refines_trans_a0i <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R01<span class="main">}</span> 
     <span class="main">(</span>trans a0i<span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans m1<span class="main">)</span> 
   <span class="main">{&gt;</span> R01<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1_def m1_trans_def a0i_def a0i_trans_def
         <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_m1_trans_refines_a0i_trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_obs_consistent <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"obs_consistent R01 med10 a0i m1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R01_defs a0i_def m1_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_refines_a0i<span class="main">:</span>
  <span class="quoted"><span class="quoted">"refines R01 med10 a0i m1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Refinement_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="m2_auth_chan">
<div class="head">
<h1>Theory m2_auth_chan</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Development of Security Protocols by Refinement

  Module:  Auth_simple/m2_auth_chan.thy (Isabelle/HOL 2016-1)
  ID:      $Id: m2_auth_chan.thy 133854 2017-03-20 17:53:50Z csprenge $
  Author:  Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  One-Way authentication protocols
  Refinement 2: protocol using authentic channels

  Copyright (c) 2009-2016 Christoph Sprenger 
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Refinement 2a: Authentic Channel Protocol›</span></span>

<span class="keyword1"><span class="command">theory</span></span> m2_auth_chan <span class="keyword2"><span class="keyword">imports</span></span> <a href="m1_auth.html">m1_auth</a> <span class="quoted">"<a href="Channels.html">../Refinement/Channels</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We refine the abstract authentication protocol to a version of the 
ISO/IEC 9798-3 protocol using abstract channels. In standard protocol notation, 
the original protocol is specified as follows.
\[
\begin{array}{llll}
  \mathrm{M1.} &amp; A \rightarrow B &amp; : &amp; A, B, N_A \\
  \mathrm{M2.} &amp; B \rightarrow A &amp; : &amp; \{N_B, N_A, A\}_{K^{-1}(B)} 
\end{array}
\]
We introduce insecure channels between pairs of agents for the first message and 
authentic channels for the second.›</span></span>

<span class="keyword1"><span class="command">declare</span></span> domIff <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">iff</span> <span class="quasi_keyword">del</span><span class="main">]</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹State›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹State: we extend the state with insecure and authentic channels 
defined above.›</span></span>

<span class="keyword1"><span class="command">record</span></span> m2_state <span class="main">=</span> <span class="quoted">m1_state</span> <span class="main">+</span>
  chan <span class="main">::</span> <span class="quoted"><span class="quoted">"chmsg set"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Observations.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> 
  m2_obs <span class="main">=</span> <span class="quoted">m1_state</span> 

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_obs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_state <span class="main">⇒</span> m2_obs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_obs</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> 
     runs <span class="main">=</span> runs <span class="free"><span class="bound"><span class="entity">s</span></span></span>
  <span class="main">⦈</span>"</span></span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Events›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m2_step1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">]</span> <span class="main">⇒</span> <span class="main">(</span>m2_state <span class="main">×</span> m2_state<span class="main">)</span> set"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_step1</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>
     <span class="comment1">― ‹guards›</span>
     <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
     <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span><span class="main">0</span> <span class="main">∧</span>

     <span class="comment1">― ‹actions›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
       runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> 
       chan <span class="main">:=</span> insert <span class="main">(</span>Insec <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span>  
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m2_step2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> nonce<span class="main">]</span> <span class="main">⇒</span> <span class="main">(</span>m2_state <span class="main">×</span> m2_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_step2</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Nb</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>
     <span class="comment1">― ‹guards›</span>
     <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
     <span class="free"><span class="bound"><span class="entity">Nb</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span><span class="main">0</span> <span class="main">∧</span>

     Insec <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">∧</span>                          <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>rcv M1›</span></span>›</span>

     <span class="comment1">― ‹actions›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> 
       runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> 
       chan <span class="main">:=</span> insert <span class="main">(</span>Auth <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">,</span> aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span>  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>snd M2›</span></span>›</span>
     <span class="main">⦈</span>  
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m2_step3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> nonce<span class="main">]</span> <span class="main">⇒</span> <span class="main">(</span>m2_state <span class="main">×</span> m2_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_step3</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Nb</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>
     <span class="comment1">― ‹guards›</span>
     runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>
     <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span><span class="main">0</span> <span class="main">∧</span>

     Auth <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">,</span> aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">∧</span>            <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>recv M2›</span></span>›</span>

     <span class="comment1">― ‹actions›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> 
       runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
     <span class="main">⦈</span>  
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Intruder fake event.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">Id</span><span class="antiquote">}</span></span>›</span> 
  <span class="entity">m2_fake</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m2_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_fake</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span> 

    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> chan <span class="main">:=</span> fake ik0 <span class="main">(</span>dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span> <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Transition system.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_state set"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">m2_init</span> <span class="main">≡</span> <span class="main">{</span> <span class="main">⦇</span> 
     runs <span class="main">=</span> Map.empty<span class="main">,</span> 
     chan <span class="main">=</span> <span class="main">{}</span>
  <span class="main">⦈</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m2_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_trans</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Ra</span> <span class="bound">Rb</span> <span class="bound">Na</span> <span class="bound">Nb</span><span class="main">.</span> 
     <span class="main">(</span>m2_step1 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span><span class="main">)</span>    <span class="main">∪</span>
     <span class="main">(</span>m2_step2 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Nb</span><span class="main">)</span> <span class="main">∪</span>
     <span class="main">(</span>m2_step3 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Nb</span><span class="main">)</span> <span class="main">∪</span>
     m2_fake <span class="main">∪</span>
     Id
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state<span class="main">,</span> m2_obs<span class="main">)</span> spec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2</span> <span class="main">≡</span> <span class="main">⦇</span>
    init <span class="main">=</span> m2_init<span class="main">,</span>
    trans <span class="main">=</span> m2_trans<span class="main">,</span> 
    obs <span class="main">=</span> m2_obs
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_defs <span class="main">=</span> 
  m2_def m2_init_def m2_trans_def m2_obs_def
  m2_step1_def m2_step2_def m2_step3_def m2_fake_def 


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Authentic channel and responder›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This property relates the messages in the authentic channel to the 
responder run frame.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_inv1_auth</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_state set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_inv1_auth</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Nb</span><span class="main">.</span> 
     Auth <span class="bound">B</span> <span class="bound">A</span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="bound">Nb</span><span class="main">,</span> aNon <span class="bound">Na</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">⟶</span> <span class="bound">B</span> <span class="main">∉</span> bad <span class="main">⟶</span> <span class="bound">A</span> <span class="main">∉</span> bad <span class="main">⟶</span> 
       <span class="main">(</span><span class="main">∃</span><span class="bound">Rb</span><span class="main">.</span> runs <span class="bound">s</span> <span class="bound">Rb</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="bound">Na</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">Nb</span> <span class="main">=</span> <span class="bound">Rb</span><span class="main">$</span><span class="main">0</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv1_authI <span class="main">=</span> 
  m2_inv1_auth_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv1_authE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> 
  m2_inv1_auth_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv1_authD <span class="main">[</span><span class="operator">dest</span><span class="main">]</span> <span class="main">=</span> 
  m2_inv1_auth_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv2_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m2 <span class="main">⊆</span> m2_inv1_auth"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_def m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv1_authI<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv2_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv1_auth<span class="main">}</span> trans m2 <span class="main">{&gt;</span> m2_inv1_auth<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_def m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv1_authI<span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>
<span class="comment1">― ‹1 subgoal›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span><span class="main">)</span>                            <span class="comment1">(* SLOW *)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m2_inv1_auth"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> inv_rule_incr<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Simulation relation and mediator function. This is a pure superposition 
refinement.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R12</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m1_state <span class="main">×</span> m2_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R12</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> runs <span class="bound">s</span> <span class="main">=</span> runs <span class="bound">t</span><span class="main">}</span>"</span></span>           <span class="comment1">― ‹That's it!›</span>
 
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">med21</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_obs <span class="main">⇒</span> m1_obs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med21</span> <span class="main">≡</span> id"</span></span> 


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement proof›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_step1_refines_m1_step1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12<span class="main">}</span> 
     <span class="main">(</span>m1_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m2_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R12<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12_def m1_defs m2_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_step2_refines_m1_step2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12<span class="main">}</span> 
     <span class="main">(</span>m1_step2 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Nb</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m2_step2 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Nb</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R12<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12_def m1_defs m2_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_step3_refines_m1_step3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12 <span class="main">∩</span> UNIV <span class="main">×</span> m2_inv1_auth<span class="main">}</span> 
     <span class="main">(</span>m1_step3 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Nb</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m2_step3 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Nb</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R12<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12_def m1_defs m2_defs<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹New fake event refines skip.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_fake_refines_m1_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12<span class="main">}</span> Id<span class="main">,</span> m2_fake <span class="main">{&gt;</span> R12<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12_def m1_defs m2_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_m2_trans_refines_m1_trans <span class="main">=</span> 
  PO_m2_step1_refines_m1_step1 PO_m2_step2_refines_m1_step2
  PO_m2_step3_refines_m1_step3 PO_m2_fake_refines_m1_skip 


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All together now...›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_refines_init_m1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m2 <span class="main">⊆</span> R12<span class="main">``</span><span class="main">(</span>init m1<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R12_def m1_defs m2_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_refines_trans_m1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12 <span class="main">∩</span> UNIV <span class="main">×</span> m2_inv1_auth<span class="main">}</span> 
     <span class="main">(</span>trans m1<span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans m2<span class="main">)</span> 
   <span class="main">{&gt;</span> R12<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_def m2_trans_def m1_def m1_trans_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_m2_trans_refines_m1_trans<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_obs_consistent <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"obs_consistent R12 med21 m1 m2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R12_def med21_def m1_defs m2_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> m2_refines_m1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"refines 
     <span class="main">(</span>R12 <span class="main">∩</span> UNIV <span class="main">×</span> m2_inv1_auth<span class="main">)</span>
     med21 m1 m2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Refinement_using_invariants<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="m2_confid_chan">
<div class="head">
<h1>Theory m2_confid_chan</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Development of Security Protocols by Refinement

  Module:  Auth_simple/m2_confid_chan.thy (Isabelle/HOL 2016-1)
  ID:      $Id: m2_confid_chan.thy 133854 2017-03-20 17:53:50Z csprenge $
  Author:  Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  One-Way authentication protocols
  Refinement 2: protocol using confidential channels

  Copyright (c) 2009-2016 Christoph Sprenger 
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Refinement 2b: Confidential Channel Protocol›</span></span>

<span class="keyword1"><span class="command">theory</span></span> m2_confid_chan <span class="keyword2"><span class="keyword">imports</span></span> <a href="m1_auth.html">m1_auth</a> <span class="quoted">"<a href="Channels.html">../Refinement/Channels</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We refine the abstract authentication protocol to the first two
steps of the Needham-Schroeder-Lowe protocol, which we call NSL/2.
In standard protocol notation, the original protocol is specified as follows.
\[
\begin{array}{llll}
  \mathrm{M1.} &amp; A \rightarrow B &amp; : &amp; \{N_A, A\}_{K(B)} \\
  \mathrm{M2.} &amp; B \rightarrow A &amp; : &amp; \{N_A, N_B, B\}_{K(A)} 
\end{array}
\]
At this refinement level, we abstract the encrypted messages to 
non-cryptographic messages transmitted on confidential channels.›</span></span>

<span class="keyword1"><span class="command">declare</span></span> domIff <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">iff</span> <span class="quasi_keyword">del</span><span class="main">]</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹State and observations›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">record</span></span> m2_state <span class="main">=</span> <span class="quoted">m1_state</span> <span class="main">+</span>
  chan <span class="main">::</span> <span class="quoted"><span class="quoted">"chmsg set"</span></span>                     <span class="comment1">― ‹channels›</span>

<span class="keyword1"><span class="command">type_synonym</span></span> 
  m2_obs <span class="main">=</span> <span class="quoted">m1_state</span> 

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_obs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_state <span class="main">⇒</span> m2_obs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_obs</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> 
     runs <span class="main">=</span> runs <span class="free"><span class="bound"><span class="entity">s</span></span></span>
  <span class="main">⦈</span>"</span></span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Events›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_init</span> <span class="main">≡</span> <span class="main">{</span> <span class="main">⦇</span> 
     runs <span class="main">=</span> Map.empty<span class="main">,</span> 
     chan <span class="main">=</span> <span class="main">{}</span>
  <span class="main">⦈</span> <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m2_step1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">]</span> <span class="main">⇒</span> <span class="main">(</span>m2_state <span class="main">×</span> m2_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_step1</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>

     <span class="comment1">― ‹guards:›</span>
     <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
     <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span><span class="main">0</span> <span class="main">∧</span>

     <span class="comment1">― ‹actions:›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
       runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> 
       <span class="comment1">― ‹send <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Na›</span></span> on confidential channel 1›</span>
       chan <span class="main">:=</span> insert <span class="main">(</span>Confid <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span>
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m2_step2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> nonce<span class="main">]</span> <span class="main">⇒</span> <span class="main">(</span>m2_state <span class="main">×</span> m2_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_step2</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Nb</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>

     <span class="comment1">― ‹guards›</span>
     <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
     <span class="free"><span class="bound"><span class="entity">Nb</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span><span class="main">0</span> <span class="main">∧</span>

     Confid <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">∧</span>           <span class="comment1">― ‹receive M1›</span>

     <span class="comment1">― ‹actions›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> 
       runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> 
       chan <span class="main">:=</span> insert <span class="main">(</span>Confid <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">,</span> aNon <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span>
     <span class="main">⦈</span>  
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m2_step3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> nonce<span class="main">]</span> <span class="main">⇒</span> <span class="main">(</span>m2_state <span class="main">×</span> m2_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_step3</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Nb</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>

     <span class="comment1">― ‹guards›</span>
     runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>
     <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span><span class="main">0</span> <span class="main">∧</span>

     Confid <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">,</span> aNon <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">∧</span>  <span class="comment1">― ‹receive M2›</span>

     <span class="comment1">― ‹actions›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> 
       runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
     <span class="main">⦈</span>  
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Intruder fake event.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">Id</span><span class="antiquote">}</span></span>›</span> 
  <span class="entity">m2_fake</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m2_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_fake</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span> 
    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> chan <span class="main">:=</span> fake ik0 <span class="main">(</span>dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span> <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Transition system.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m2_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_trans</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Ra</span> <span class="bound">Rb</span> <span class="bound">Na</span> <span class="bound">Nb</span><span class="main">.</span>
     m2_step1 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span>    <span class="main">∪</span>
     m2_step2 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Nb</span> <span class="main">∪</span>
     m2_step3 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Nb</span> <span class="main">∪</span>
     m2_fake <span class="main">∪</span>
     Id
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state<span class="main">,</span> m2_obs<span class="main">)</span> spec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2</span> <span class="main">≡</span> <span class="main">⦇</span>
    init <span class="main">=</span> m2_init<span class="main">,</span>
    trans <span class="main">=</span> m2_trans<span class="main">,</span> 
    obs <span class="main">=</span> m2_obs
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_defs <span class="main">=</span> 
  m2_def m2_init_def m2_trans_def m2_obs_def
  m2_step1_def m2_step2_def m2_step3_def m2_fake_def 


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Invariant 1: Messages only contains generated nonces.›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_inv1_nonces</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_state set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_inv1_nonces</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">R</span><span class="main">.</span> 
     aNon <span class="main">(</span><span class="bound">R</span><span class="main">$</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> atoms <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">R</span> <span class="main">∈</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> 
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv1_noncesI <span class="main">=</span> 
  m2_inv1_nonces_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv1_noncesE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> 
  m2_inv1_nonces_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv1_noncesD <span class="main">=</span> 
  m2_inv1_nonces_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>


<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv1_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"init m2 <span class="main">⊆</span> m2_inv1_nonces"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_def m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv1_noncesI<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv1_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv1_nonces<span class="main">}</span> trans m2 <span class="main">{&gt;</span> m2_inv1_nonces<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_def m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv1_noncesI<span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m2_inv1_noncesD<span class="main">)</span>
<span class="comment1">― ‹1 subgoal›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"aNon <span class="main">(</span><span class="improper">R</span><span class="main">$</span><span class="main">0</span><span class="main">)</span> <span class="main">∈</span> atoms <span class="main">(</span>chan <span class="improper">xa</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv012 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m2_inv1_nonces"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Invariant 3: relates message 2 with the responder run›</span></span>
<span class="comment1">(******************************************************************************)</span>
<span class="comment1">(*
 1. ⋀a y. ⟦runs a = runs y; runs y Ra = Some (Init, [A, B], []);
           Confid A B (Msg [aNon (Ra$0), aNon Nb]) ∈ chan y; A ∉ bad; B ∉ bad⟧
          ⟹ ∃Rb. Nb = Rb $ 0 ∧ runs y Rb = Some (Resp, [A, B], [aNon (Ra $ 0)])
*)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹It is needed, together with initiator nonce secrecy, in proof 
obligation REF/<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">m2_step2</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_inv3_msg2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_state set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_inv3_msg2</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Nb</span><span class="main">.</span> 
     Confid <span class="bound">B</span> <span class="bound">A</span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="bound">Na</span><span class="main">,</span> aNon <span class="bound">Nb</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">⟶</span> 
     aNon <span class="bound">Na</span> <span class="main">∉</span> extr ik0 <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound">Rb</span><span class="main">.</span> <span class="bound">Nb</span> <span class="main">=</span> <span class="bound">Rb</span><span class="main">$</span><span class="main">0</span> <span class="main">∧</span> runs <span class="bound">s</span> <span class="bound">Rb</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="bound">Na</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv3_msg2I <span class="main">=</span> m2_inv3_msg2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv3_msg2E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m2_inv3_msg2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv3_msg2D <span class="main">=</span> m2_inv3_msg2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>


<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv4_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m2 <span class="main">⊆</span> m2_inv3_msg2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_def m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv3_msg2I<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv4_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv3_msg2<span class="main">}</span> trans m2 <span class="main">{&gt;</span> m2_inv3_msg2<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_def m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv3_msg2I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m2_inv3_msg2D dom_lemmas<span class="main">)</span>
<span class="comment1">― ‹2 subgoals›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> m2_inv3_msg2D<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> m2_inv3_msg2D<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv4 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m2_inv3_msg2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_incr<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Invariant 4: Initiator nonce secrecy.›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹It is needed in the proof 
obligation REF/<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">m2_step2</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. It would be sufficient to prove the invariant 
for the case <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">x</span></span><span class="main"><span class="main">=</span></span>None"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, but we have generalized it here.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_inv4_inon_secret</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_state set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_inv4_inon_secret</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Ra</span> <span class="bound">al</span><span class="main">.</span>
     runs <span class="bound">s</span> <span class="bound">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> <span class="bound">al</span><span class="main">)</span> <span class="main">⟶</span>
     <span class="bound">A</span> <span class="main">∉</span> bad <span class="main">⟶</span> <span class="bound">B</span> <span class="main">∉</span> bad <span class="main">⟶</span> 
       aNon <span class="main">(</span><span class="bound">Ra</span><span class="main">$</span><span class="main">0</span><span class="main">)</span> <span class="main">∉</span> extr ik0 <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv4_inon_secretI <span class="main">=</span> 
  m2_inv4_inon_secret_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv4_inon_secretE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> 
  m2_inv4_inon_secret_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv4_inon_secretD <span class="main">=</span> 
  m2_inv4_inon_secret_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>


<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv3_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m2 <span class="main">⊆</span> m2_inv4_inon_secret"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_def m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv4_inon_secretI<span class="main">)</span>
 
<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv3_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv4_inon_secret <span class="main">∩</span> m2_inv1_nonces<span class="main">}</span> 
     trans m2 
   <span class="main">{&gt;</span> m2_inv4_inon_secret<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_def m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv4_inon_secretI<span class="main">)</span>  
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m2_inv4_inon_secretD<span class="main">)</span> 
<span class="comment1">― ‹3 subgoals›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span>                <span class="comment1">― ‹requires <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"m2_inv1_nonces"</span><span class="antiquote">}</span></span>›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span>                <span class="comment1">― ‹requires ind hyp›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span>                <span class="comment1">― ‹requires ind hyp›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span> 

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv3 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m2_inv4_inon_secret"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_incr <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> J<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"m2_inv1_nonces"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R12</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m1_state <span class="main">×</span> m2_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R12</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> runs <span class="bound">s</span> <span class="main">=</span> runs <span class="bound">t</span><span class="main">}</span>"</span></span>  

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">med21</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_obs <span class="main">⇒</span> m1_obs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med21</span> <span class="main">≡</span> id"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Proof obligations.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_step1_refines_m1_step1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12<span class="main">}</span> 
     <span class="main">(</span>m1_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m2_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R12<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12_def m1_defs m2_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_step2_refines_m1_step2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12<span class="main">}</span> 
     <span class="main">(</span>m1_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Nb</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m2_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Nb</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R12<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12_def m1_defs m2_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_step3_refines_m1_step3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12 <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">(</span>m2_inv4_inon_secret <span class="main">∩</span> m2_inv3_msg2<span class="main">)</span><span class="main">}</span> 
     <span class="main">(</span>m1_step3 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Nb</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m2_step3 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Nb</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R12<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12_def m1_defs m2_defs<span class="main">)</span>
   <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹New fake events refine skip.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_fake_refines_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12<span class="main">}</span> Id<span class="main">,</span> m2_fake <span class="main">{&gt;</span> R12<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_def R12_def m1_defs m2_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_m2_trans_refines_m1_trans <span class="main">=</span> 
  PO_m2_step1_refines_m1_step1 PO_m2_step2_refines_m1_step2
  PO_m2_step3_refines_m1_step3 PO_m2_fake_refines_skip 


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All together now...›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_refines_init_m1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m2 <span class="main">⊆</span> R12<span class="main">``</span><span class="main">(</span>init m1<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R12_def m1_defs m2_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_refines_trans_m1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12 <span class="main">∩</span> 
    UNIV <span class="main">×</span> <span class="main">(</span>m2_inv4_inon_secret <span class="main">∩</span> m2_inv3_msg2<span class="main">)</span><span class="main">}</span> 
     <span class="main">(</span>trans m1<span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans m2<span class="main">)</span> 
   <span class="main">{&gt;</span> R12<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_def m2_trans_def m1_def m1_trans_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_m2_trans_refines_m1_trans<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_R12_obs_consistent <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"obs_consistent R12 med21 m1 m2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R12_def m1_defs m2_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_refines_m2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"refines 
     <span class="main">(</span>R12 <span class="main">∩</span> 
      UNIV <span class="main">×</span> <span class="main">(</span>m2_inv4_inon_secret <span class="main">∩</span> m2_inv3_msg2 <span class="main">∩</span> m2_inv1_nonces<span class="main">)</span><span class="main">)</span>
     med21 m1 m2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Refinement_using_invariants<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="m3_sig">
<div class="head">
<h1>Theory m3_sig</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Development of Security Protocols by Refinement

  Module:  Auth_simple/m3_sig.thy (Isabelle/HOL 2016-1)
  ID:      $Id: m3_sig.thy 133852 2017-03-20 15:59:33Z csprenge $
  Author:  Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;

  One-Way authentication protocols
  Refinement 3: protocol using signatures

  Copyright (c) 2009-2016 Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Refinement 3a: Signature-based Dolev-Yao Protocol (Variant A)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> m3_sig <span class="keyword2"><span class="keyword">imports</span></span> <a href="m2_auth_chan.html">m2_auth_chan</a> <span class="quoted">"<a href="Message.html">../Refinement/Message</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We implement the channel protocol of the previous refinement with
signatures and add a full-fledged Dolev-Yao adversary.  In this variant, the
adversary is realized using Paulson's closure operators for message derivation
(as opposed to a collection of one-step derivation events a la Strand spaces).
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Proof tool configuration. Avoid annoying automatic unfolding of
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>dom›</span></span></span></span> (again).›</span></span>

<span class="keyword1"><span class="command">declare</span></span> domIff <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">iff</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> analz_into_parts <span class="main">[</span><span class="operator">dest</span><span class="main">]</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹State›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We extend the state of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">m1</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with insecure and authentic
channels between each pair of agents.›</span></span>

<span class="keyword1"><span class="command">record</span></span> m3_state <span class="main">=</span> <span class="quoted">m1_state</span> <span class="main">+</span>
  IK <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set"</span></span>                             <span class="comment1">― ‹intruder knowledge›</span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  m3_obs <span class="main">=</span> <span class="quoted">m1_state</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_obs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_state <span class="main">⇒</span> m3_obs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_obs</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">⦇</span>
     runs <span class="main">=</span> runs <span class="free"><span class="bound"><span class="entity">s</span></span></span>
  <span class="main">⦈</span>"</span></span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Events›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_step1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">]</span> <span class="main">⇒</span> <span class="main">(</span>m3_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step1</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>

     <span class="comment1">― ‹guards›</span>
     <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
     <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span><span class="main">0</span> <span class="main">∧</span>

     <span class="comment1">― ‹actions›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
       runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
       IK <span class="main">:=</span> insert <span class="main">⦃</span>Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Nonce <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">⦄</span> <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span>    <span class="comment1">― ‹send msg 1›</span>
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_step2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> nonce<span class="main">]</span> <span class="main">⇒</span> <span class="main">(</span>m3_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step2</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Nb</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>

     <span class="comment1">― ‹guards›</span>
     <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
     <span class="free"><span class="bound"><span class="entity">Nb</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span><span class="main">0</span> <span class="main">∧</span>

     <span class="main">⦃</span>Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Nonce <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">⦄</span> <span class="main">∈</span> IK <span class="bound">s</span> <span class="main">∧</span>            <span class="comment1">― ‹receive msg 1›</span>

     <span class="comment1">― ‹actions›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
       runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
                                                        <span class="comment1">― ‹send msg 2›</span>
       IK <span class="main">:=</span> insert <span class="main">(</span>Crypt <span class="main">(</span>priK <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">⦃</span>Nonce <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">,</span> Nonce <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⦄</span><span class="main">)</span> <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span>
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_step3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> nonce<span class="main">]</span> <span class="main">⇒</span> <span class="main">(</span>m3_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step3</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Nb</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>

     <span class="comment1">― ‹guards›</span>
     runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>
     <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span><span class="main">0</span> <span class="main">∧</span>

     Crypt <span class="main">(</span>priK <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">⦃</span>Nonce <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">,</span> Nonce <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⦄</span> <span class="main">∈</span> IK <span class="bound">s</span> <span class="main">∧</span> <span class="comment1">― ‹recv msg 2›</span>

     <span class="comment1">― ‹actions›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
       runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The intruder messages are now generated by a full-fledged Dolev-Yao
intruder.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_DY_fake</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m3_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_DY_fake</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>

     <span class="comment1">― ‹actions:›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
       IK <span class="main">:=</span> synth <span class="main">(</span>analz <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span><span class="main">)</span>
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Transition system.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_init</span> <span class="main">≡</span> <span class="main">{</span> <span class="main">⦇</span>
     runs <span class="main">=</span> Map.empty<span class="main">,</span>
     IK <span class="main">=</span> <span class="main">(</span>Key<span class="main">`</span>priK<span class="main">`</span>bad<span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>Key<span class="main">`</span>range pubK<span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>Key<span class="main">`</span>shrK<span class="main">`</span>bad<span class="main">)</span>
  <span class="main">⦈</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m3_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_trans</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Ra</span> <span class="bound">Rb</span> <span class="bound">Na</span> <span class="bound">Nb</span><span class="main">.</span>
     m3_step1 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span>    <span class="main">∪</span>
     m3_step2 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Nb</span> <span class="main">∪</span>
     m3_step3 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Nb</span> <span class="main">∪</span>
     m3_DY_fake         <span class="main">∪</span>
     Id
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m3_state<span class="main">,</span> m3_obs<span class="main">)</span> spec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3</span> <span class="main">≡</span> <span class="main">⦇</span>
    init <span class="main">=</span> m3_init<span class="main">,</span>
    trans <span class="main">=</span> m3_trans<span class="main">,</span>
    obs <span class="main">=</span> m3_obs
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_defs <span class="main">=</span>
  m3_def m3_init_def m3_trans_def m3_obs_def
  m3_step1_def m3_step2_def m3_step3_def
  m3_DY_fake_def


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Specialize injectiveness of parts to enable aggressive application.›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> parts_Inj_IK <span class="main">=</span> parts.Inj <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"IK <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">s</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> analz_Inj_IK <span class="main">=</span> analz.Inj <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"IK <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">s</span><span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following invariants do not depend on the protocol messages.
We want to keep this compilation refinement from channel protocols to
full-fledged Dolev-Yao protocols as generic as possible.›</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv1: Long-term key secrecy›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Private signing keys are secret, that is, the intruder only knows
private keys of corrupted agents.

The invariant uses the weaker <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">parts</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> operator instead of the perhaps
more intuitive <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">analz</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in its premise.  This strengthens the invariant
and potentially simplifies its proof.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_inv1_lkeysec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_state set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_inv1_lkeysec</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">A</span><span class="main">.</span>
     Key <span class="main">(</span>priK <span class="bound">A</span><span class="main">)</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">A</span> <span class="main">∈</span> bad
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_inv1_lkeysecI <span class="main">=</span>
  m3_inv1_lkeysec_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv1_lkeysecE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span>
  m3_inv1_lkeysec_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv1_lkeysecD <span class="main">=</span>
  m3_inv1_lkeysec_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>


<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv1_lkeysec_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m3 <span class="main">⊆</span> m3_inv1_lkeysec"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv1_lkeysecI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv1_lkeysec_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m3_inv1_lkeysec<span class="main">}</span> trans m3 <span class="main">{&gt;</span> m3_inv1_lkeysec<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv1_lkeysecI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv1_lkeysec <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m3 <span class="main">⊆</span> m3_inv1_lkeysec"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv2: Intruder knows long-term keys of bad guys›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_inv2_badkeys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_inv2_badkeys</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">C</span><span class="main">.</span>
     <span class="bound">C</span> <span class="main">∈</span> bad <span class="main">⟶</span> Key <span class="main">(</span>priK <span class="bound">C</span><span class="main">)</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_inv2_badkeysI <span class="main">=</span>
  m3_inv2_badkeys_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv2_badkeysE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span>
  m3_inv2_badkeys_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv2_badkeysD <span class="main">[</span><span class="operator">dest</span><span class="main">]</span> <span class="main">=</span>
  m3_inv2_badkeys_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv2_badkeys_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m3 <span class="main">⊆</span> m3_inv2_badkeys"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m3_defs m3_inv2_badkeys_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv2_badkeys_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m3_inv2_badkeys<span class="main">}</span> trans m3 <span class="main">{&gt;</span> m3_inv2_badkeys<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv2_badkeysI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv2_badkeys <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m3 <span class="main">⊆</span> m3_inv2_badkeys"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv3: Intruder knows all public keys (NOT USED)›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This invariant is only needed with equality in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>R23_msgs›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_inv3_pubkeys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_inv3_pubkeys</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">C</span><span class="main">.</span>
     Key <span class="main">(</span>pubK <span class="bound">C</span><span class="main">)</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_inv3_pubkeysI <span class="main">=</span>
  m3_inv3_pubkeys_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv3_pubkeysE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span>
  m3_inv3_pubkeys_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv3_pubkeysD <span class="main">[</span><span class="operator">dest</span><span class="main">]</span> <span class="main">=</span>
  m3_inv3_pubkeys_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv3_pubkeys_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m3 <span class="main">⊆</span> m3_inv3_pubkeys"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m3_defs m3_inv3_pubkeys_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv3_pubkeys_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m3_inv3_pubkeys<span class="main">}</span> trans m3 <span class="main">{&gt;</span> m3_inv3_pubkeys<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv3_pubkeysI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv3_pubkeys <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m3 <span class="main">⊆</span> m3_inv3_pubkeys"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Automatic tool tuning. Tame too-agressive pair decomposition, which is
declared as a safe elim rule ([elim!]).›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> MPair_parts <span class="main">[</span><span class="operator">rule</span> <span class="quasi_keyword">del</span><span class="main">,</span> <span class="operator">elim</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> MPair_analz <span class="main">[</span><span class="operator">rule</span> <span class="quasi_keyword">del</span><span class="main">,</span> <span class="operator">elim</span><span class="main">]</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Simulation relation›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">nonces</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set <span class="main">⇒</span> nonce set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nonces</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">N</span><span class="main">.</span> Nonce <span class="bound">N</span> <span class="main">∈</span> analz <span class="free"><span class="bound"><span class="entity">H</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">ink</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"chmsg set <span class="main">⇒</span> nonce set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ink</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">N</span><span class="main">.</span> aNon <span class="bound">N</span> <span class="main">∈</span> extr ik0 <span class="free"><span class="bound"><span class="entity">H</span></span></span><span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Abstraction function on sets of messages.›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span>
  <span class="entity">abs_msg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set <span class="main">⇒</span> chmsg set"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">H</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  am_M1<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⦃</span>Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Nonce <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">⦄</span> <span class="main">∈</span> <span class="free">H</span>
  <span class="main">⟹</span> Insec <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">abs_msg</span> <span class="free">H</span>"</span></span>

<span class="main">|</span> am_M2<span class="main">:</span>
    <span class="quoted"><span class="quoted">"Crypt <span class="main">(</span>priK <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">⦃</span>Nonce <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">,</span> Nonce <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⦄</span> <span class="main">∈</span> <span class="free">H</span>
  <span class="main">⟹</span> Auth <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">,</span> aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">abs_msg</span> <span class="free">H</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The simulation relation is canonical. It states that the protocol
messages in the intruder knowledge refine the abstract messages appearing in
the channels <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Insec</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Auth</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R23_msgs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R23_msgs</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> abs_msg <span class="main">(</span>parts <span class="main">(</span>IK <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> chan <span class="bound">s</span><span class="main">}</span>"</span></span>   <span class="comment1">― ‹with <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>parts›</span></span>!›</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R23_ink</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R23_ink</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> nonces <span class="main">(</span>IK <span class="bound">t</span><span class="main">)</span> <span class="main">⊆</span> ink <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R23_preserved</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R23_preserved</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> runs <span class="bound">s</span> <span class="main">=</span> runs <span class="bound">t</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R23</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R23</span> <span class="main">≡</span> R23_msgs <span class="main">∩</span> R23_ink <span class="main">∩</span> R23_preserved"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_defs <span class="main">=</span> R23_def R23_msgs_def R23_ink_def R23_preserved_def


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Mediator function: nothing new.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">med32</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_obs <span class="main">⇒</span> m2_obs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med32</span> <span class="main">≡</span> id"</span></span>


<span class="keyword1"><span class="command">lemmas</span></span> R23_msgsI <span class="main">=</span>
  R23_msgs_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_intro<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_msgsE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span>
  R23_msgs_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_elim<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_msgsE' <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span>
  R23_msgs_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_dest<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">THEN</span> subsetD<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_inkI <span class="main">=</span>
  R23_ink_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_intro<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_inkE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span>
  R23_ink_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_elim<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_preservedI <span class="main">=</span>
  R23_preserved_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_intro<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_preservedE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span>
  R23_preserved_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_elim<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_intros <span class="main">=</span> R23_msgsI R23_inkI R23_preservedI


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Facts about the abstraction function›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">declare</span></span> abs_msg.intros <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> abs_msg.cases <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main">!</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"abs_msg <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_Un <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"abs_msg <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> abs_msg <span class="free">G</span> <span class="main">∪</span> abs_msg <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_mono <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">m</span> <span class="main">∈</span> abs_msg <span class="free">G</span><span class="main">;</span> <span class="free">G</span> <span class="main">⊆</span> <span class="free">H</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">∈</span> abs_msg <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_insert_mono <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">m</span> <span class="main">∈</span> abs_msg <span class="free">H</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">∈</span> abs_msg <span class="main">(</span>insert <span class="free">m'</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Abstraction of concretely fakeable message yields abstractly fakeable
messages. This is the key lemma for the refinement of the intruder.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_DY_subset_fakeable<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> R23_msgs<span class="main">;</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> R23_ink<span class="main">;</span> <span class="free">t</span> <span class="main">∈</span> m3_inv1_lkeysec <span class="main">⟧</span>
  <span class="main">⟹</span> abs_msg <span class="main">(</span>synth <span class="main">(</span>analz <span class="main">(</span>IK <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> fake ik0 <span class="main">(</span>dom <span class="main">(</span>runs <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fake_intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fake_Inj<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fake_intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> absmsg_parts_subset_fakeable<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> R23_msgs <span class="main">⟧</span>
  <span class="main">⟹</span> abs_msg <span class="main">(</span>parts <span class="main">(</span>IK <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> fake ik0 <span class="main">(</span><span class="main">-</span>dom <span class="main">(</span>runs <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"chan <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> subset_trans<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> abs_msg_DY_subset_fakeable <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main">!</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> absmsg_parts_subset_fakeable <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main">!</span></span><span class="main">]</span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement proof›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step1_refines_m2_step1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
     <span class="main">(</span>m2_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m2_defs m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step2_refines_m2_step2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23 <span class="comment1">⌦‹∩ UNIV × m3_inv3_pubkeys›</span><span class="main">}</span>
     <span class="main">(</span>m2_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Nb</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Nb</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m2_defs m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step3_refines_m2_step3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
     <span class="main">(</span>m2_step3 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Nb</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step3 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Nb</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m2_defs m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The Dolev-Yao fake event refines the abstract fake event.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_DY_fake_refines_m2_fake<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23 <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">(</span>m3_inv1_lkeysec <span class="main">∩</span> m3_inv2_badkeys<span class="main">)</span><span class="main">}</span>
     m2_fake<span class="main">,</span> m3_DY_fake
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m2_defs m3_defs<span class="main">)</span>
   <span class="main">(</span><span class="operator">rule</span> R23_intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All together now...›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_m3_trans_refines_m2_trans <span class="main">=</span>
  PO_m3_step1_refines_m2_step1 PO_m3_step2_refines_m2_step2
  PO_m3_step3_refines_m2_step3 PO_m3_DY_fake_refines_m2_fake

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_refines_init_m2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m3 <span class="main">⊆</span> R23<span class="main">``</span><span class="main">(</span>init m2<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23_defs m2_defs m3_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_refines_trans_m2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23 <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">(</span>m3_inv2_badkeys <span class="main">∩</span> m3_inv1_lkeysec<span class="main">)</span><span class="main">}</span>
     <span class="main">(</span>trans m2<span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans m3<span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m3_def m3_trans_def m2_def m2_trans_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_m3_trans_refines_m2_trans<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_obs_consistent <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"obs_consistent R23 med32 m2 m3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R23_def med32_def m2_defs m3_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_refines_m2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"refines
     <span class="main">(</span>R23 <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">(</span>m3_inv2_badkeys <span class="main">∩</span> m3_inv1_lkeysec<span class="main">)</span><span class="main">)</span>
     med32 m2 m3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Refinement_using_invariants<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>


</pre>
</div><div id="m3_enc">
<div class="head">
<h1>Theory m3_enc</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Development of Security Protocols by Refinement

  Module:  Auth_simple/m3_enc.thy (Isabelle/HOL 2016-1)
  ID:      $Id: m3_enc.thy 133852 2017-03-20 15:59:33Z csprenge $
  Author:  Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  One-Way authentication protocols
  Refinement 3: protocol using public-key encryption and Dolev-Yao intruder

  Copyright (c) 2009-2016 Christoph Sprenger 
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Refinement 3b: Encryption-based Dolev-Yao Protocol (Variant A)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> m3_enc <span class="keyword2"><span class="keyword">imports</span></span> <a href="m2_confid_chan.html">m2_confid_chan</a> <span class="quoted">"<a href="Message.html">../Refinement/Message</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This refines the channel protocol using public-key encryption and
adds a full-fledged Dolev-Yao adversary.  In this variant, the adversary is 
realized using Paulson's message derivation closure operators (as opposed to
a collection of one-step message construction and decomposition events a la 
Strand spaces).›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Proof tool configuration. Avoid annoying automatic unfolding of
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>dom›</span></span></span></span> (again).›</span></span>

<span class="keyword1"><span class="command">declare</span></span> domIff <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">iff</span> <span class="quasi_keyword">del</span><span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A general lemma about <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>parts›</span></span></span></span> (move?!).›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> parts_insertD <span class="main">=</span> parts_insert <span class="main">[</span><span class="operator">THEN</span> equalityD1<span class="main">,</span> <span class="operator">THEN</span> subsetD<span class="main">]</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹State and observations›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We extend the state of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">m1</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with two confidential channels
between each pair of agents, one channel for each protocol message.›</span></span>

<span class="keyword1"><span class="command">record</span></span> m3_state <span class="main">=</span> <span class="quoted">m1_state</span> <span class="main">+</span>
  IK <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set"</span></span>                                 <span class="comment1">― ‹intruder knowledge›</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Observations: local agent states.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> 
  m3_obs <span class="main">=</span> <span class="quoted">m1_obs</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m3_obs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_state <span class="main">⇒</span> m3_obs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_obs</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> 
     runs <span class="main">=</span> runs <span class="free"><span class="bound"><span class="entity">s</span></span></span>
  <span class="main">⦈</span>"</span></span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Events›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_step1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">]</span> <span class="main">⇒</span> <span class="main">(</span>m3_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step1</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>

     <span class="comment1">― ‹guards:›</span>
     <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
     <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span><span class="main">0</span> <span class="main">∧</span>

     <span class="comment1">― ‹actions:›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
       runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> 
       IK <span class="main">:=</span> insert <span class="main">(</span>Crypt <span class="main">(</span>pubK <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">⦃</span>Nonce <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⦄</span><span class="main">)</span>  <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span>
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_step2</span> <span class="main">::</span> 
    <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> nonce<span class="main">]</span> <span class="main">⇒</span> <span class="main">(</span>m3_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step2</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Nb</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>

     <span class="comment1">― ‹guards›</span>
     <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
     <span class="free"><span class="bound"><span class="entity">Nb</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span><span class="main">0</span> <span class="main">∧</span>

     Crypt <span class="main">(</span>pubK <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">⦃</span>Nonce <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⦄</span> <span class="main">∈</span> IK <span class="bound">s</span> <span class="main">∧</span>      <span class="comment1">― ‹receive msg 1›</span>

     <span class="comment1">― ‹actions›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> 
       runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> 
       IK <span class="main">:=</span> insert <span class="main">(</span>Crypt <span class="main">(</span>pubK <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">⦃</span>Nonce <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">,</span> Nonce <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⦄</span><span class="main">)</span> <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span> 
     <span class="main">⦈</span>  
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_step3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> nonce<span class="main">]</span> <span class="main">⇒</span> <span class="main">(</span>m3_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step3</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Nb</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>

     <span class="comment1">― ‹guards›</span>
     runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>
     <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span><span class="main">0</span> <span class="main">∧</span>

     Crypt <span class="main">(</span>pubK <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">⦃</span>Nonce <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">,</span> Nonce <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⦄</span> <span class="main">∈</span> IK <span class="bound">s</span> <span class="main">∧</span>   <span class="comment1">― ‹recv msg2›</span>

     <span class="comment1">― ‹actions›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> 
       runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
     <span class="main">⦈</span>  
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Standard Dolev-Yao intruder.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m3_DY_fake</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m3_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_DY_fake</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>

     <span class="comment1">― ‹actions:›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> IK <span class="main">:=</span> synth <span class="main">(</span>analz <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span>  
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Transition system.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m3_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_state set"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_init</span> <span class="main">≡</span> <span class="main">{</span> <span class="main">⦇</span> 
     runs <span class="main">=</span> Map.empty<span class="main">,</span> 
     IK <span class="main">=</span> <span class="main">(</span>Key<span class="main">`</span>priK<span class="main">`</span>bad<span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>Key<span class="main">`</span>range pubK<span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>Key<span class="main">`</span>shrK<span class="main">`</span>bad<span class="main">)</span> 
  <span class="main">⦈</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m3_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m3_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_trans</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Ra</span> <span class="bound">Rb</span> <span class="bound">Na</span> <span class="bound">Nb</span><span class="main">.</span>
     m3_step1 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span>    <span class="main">∪</span>
     m3_step2 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Nb</span> <span class="main">∪</span>
     m3_step3 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Nb</span> <span class="main">∪</span>
     m3_DY_fake <span class="main">∪</span>
     Id
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m3_state<span class="main">,</span> m3_obs<span class="main">)</span> spec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3</span> <span class="main">≡</span> <span class="main">⦇</span>
    init <span class="main">=</span> m3_init<span class="main">,</span>
    trans <span class="main">=</span> m3_trans<span class="main">,</span> 
    obs <span class="main">=</span> m3_obs
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_defs <span class="main">=</span> 
  m3_def m3_init_def m3_trans_def m3_obs_def
  m3_step1_def m3_step2_def m3_step3_def 
  m3_DY_fake_def 


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Automatic tool tuning. Tame too-agressive pair decomposition, which is
declared as a safe elim rule ([elim!]).›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> MPair_parts <span class="main">[</span><span class="operator">rule</span> <span class="quasi_keyword">del</span><span class="main">,</span> <span class="operator">elim</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> MPair_analz <span class="main">[</span><span class="operator">rule</span> <span class="quasi_keyword">del</span><span class="main">,</span> <span class="operator">elim</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Specialize injectiveness of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"parts"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"analz"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to 
enable aggressive application.›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> parts_Inj_IK <span class="main">=</span> parts.Inj <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"IK <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">s</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> analz_Inj_IK <span class="main">=</span> analz.Inj <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"IK <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">s</span><span class="main">]</span>

<span class="keyword1"><span class="command">declare</span></span> analz_into_parts <span class="main">[</span><span class="operator">dest</span><span class="main">]</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv1: Key secrecy›</span></span>
<span class="comment1">(******************************************************************************)</span>
 
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Decryption keys are secret, that is, the intruder only knows private 
keys of corrupted agents.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_inv1_keys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_state set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_inv1_keys</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">A</span><span class="main">.</span> 
     Key <span class="main">(</span>priK <span class="bound">A</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">A</span> <span class="main">∈</span> bad
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_inv1_keysI <span class="main">=</span> m3_inv1_keys_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv1_keysE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> 
  m3_inv1_keys_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv1_keysD <span class="main">[</span><span class="operator">dest</span><span class="main">]</span> <span class="main">=</span> 
  m3_inv1_keys_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>


<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv1_keys_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m3 <span class="main">⊆</span> m3_inv1_keys"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv1_keysI<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv1_keys_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m3_inv1_keys<span class="main">}</span> trans m3 <span class="main">{&gt;</span> m3_inv1_keys<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv1_keysI<span class="main">)</span> 
   <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv1_keys <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m3 <span class="main">⊆</span> m3_inv1_keys"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Simulation relation›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Simulation relation is canonical. It states that the protocol messages
appearing in the intruder knowledge refine those occurring on the abstract
confidential channels. Moreover, if the concrete intruder knows a nonce then so 
does the abstract one (as defined by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ink›</span></span></span></span>).›</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Abstraction function on sets of messages.›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> 
  <span class="entity">abs_msg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set <span class="main">⇒</span> chmsg set"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">H</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  am_msg1<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"Crypt <span class="main">(</span>pubK <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">⦃</span>Nonce <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⦄</span> <span class="main">∈</span> <span class="free">H</span>
  <span class="main">⟹</span> Confid <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">abs_msg</span> <span class="free">H</span>"</span></span>

<span class="main">|</span> am_msg2<span class="main">:</span>
    <span class="quoted"><span class="quoted">"Crypt <span class="main">(</span>pubK <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">⦃</span>Nonce <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">,</span> Nonce <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⦄</span> <span class="main">∈</span> <span class="free">H</span> 
  <span class="main">⟹</span> Confid <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">,</span> aNon <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">abs_msg</span> <span class="free">H</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> abs_msg.intros <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> abs_msg.cases <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main">!</span></span><span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The simulation relation is canonical. It states that the protocol 
messages in the intruder knowledge refine the abstract messages appearing on
the confidential channels.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R23_msgs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R23_msgs</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> abs_msg <span class="main">(</span>parts <span class="main">(</span>IK <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> chan <span class="bound">s</span><span class="main">}</span>"</span></span>   <span class="comment1">― ‹with <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>parts›</span></span>!›</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">R23_non</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R23_non</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">N</span><span class="main">.</span> Nonce <span class="bound">N</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="bound">t</span><span class="main">)</span> <span class="main">⟶</span> aNon <span class="bound">N</span> <span class="main">∈</span> extr ik0 <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">R23_pres</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R23_pres</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> runs <span class="bound">s</span> <span class="main">=</span> runs <span class="bound">t</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">R23</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R23</span> <span class="main">≡</span> R23_msgs <span class="main">∩</span> R23_non <span class="main">∩</span> R23_pres"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_defs <span class="main">=</span>
  R23_def R23_msgs_def R23_non_def R23_pres_def

<span class="keyword1"><span class="command">lemmas</span></span> R23_msgsI <span class="main">=</span> 
  R23_msgs_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_intro<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_msgsE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> 
  R23_msgs_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_elim<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_msgsE' <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> 
  R23_msgs_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_dest<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">THEN</span> subsetD<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_nonI <span class="main">=</span> 
  R23_non_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_intro<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_nonE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> 
  R23_non_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_elim<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_presI <span class="main">=</span> 
  R23_pres_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_intro<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_presE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> 
  R23_pres_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_elim<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_intros <span class="main">=</span> R23_msgsI R23_nonI R23_presI


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Mediator function.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">med32</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_obs <span class="main">⇒</span> m2_obs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med32</span> <span class="main">≡</span> id"</span></span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Misc lemmas›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹General facts about <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"abs_msg"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"abs_msg <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_Un <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"abs_msg <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> abs_msg <span class="free">G</span> <span class="main">∪</span> abs_msg <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_mono <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">m</span> <span class="main">∈</span> abs_msg <span class="free">G</span><span class="main">;</span> <span class="free">G</span> <span class="main">⊆</span> <span class="free">H</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">∈</span> abs_msg <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_insert_mono <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">m</span> <span class="main">∈</span> abs_msg <span class="free">H</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">∈</span> abs_msg <span class="main">(</span>insert <span class="free">m'</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Abstraction of concretely fakeable message yields abstractly fakeable 
messages. This is the key lemma for the refinement of the intruder.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_DY_subset_fake<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> R23_msgs<span class="main">;</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> R23_non<span class="main">;</span> <span class="free">t</span> <span class="main">∈</span> m3_inv1_keys <span class="main">⟧</span>
  <span class="main">⟹</span> abs_msg <span class="main">(</span>synth <span class="main">(</span>analz <span class="main">(</span>IK <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> fake ik0 <span class="main">(</span>dom <span class="main">(</span>runs <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fake_Inj<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fake_intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fake_Inj<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fake_intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_parts_subset_fake<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> R23_msgs <span class="main">⟧</span>
  <span class="main">⟹</span> abs_msg <span class="main">(</span>parts <span class="main">(</span>IK <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> fake ik0 <span class="main">(</span><span class="main">-</span>dom <span class="main">(</span>runs <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"chan <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> subset_trans<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> abs_msg_DY_subset_fake <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main">!</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> abs_msg_parts_subset_fake <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main">!</span></span><span class="main">]</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement proof›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Proofs obligations.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step1_refines_m2_step1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23 <span class="main">∩</span> UNIV <span class="main">×</span> m3_inv1_keys<span class="main">}</span> 
     <span class="main">(</span>m2_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m2_defs m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step2_refines_m2_step2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23 <span class="main">∩</span> UNIV <span class="main">×</span> m3_inv1_keys<span class="main">}</span> 
     <span class="main">(</span>m2_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Nb</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Nb</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m2_defs m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step3_refines_m2_step3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span> 
     <span class="main">(</span>m2_step3 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Nb</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step3 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Nb</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m2_defs m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Dolev-Yao fake event refines abstract fake event.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_DY_fake_refines_m2_fake<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23 <span class="main">∩</span> UNIV <span class="main">×</span> m3_inv1_keys<span class="main">}</span> 
     <span class="main">(</span>m2_fake<span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_DY_fake<span class="main">)</span> 
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m2_defs m3_defs<span class="main">)</span> 
   <span class="main">(</span><span class="operator">rule</span> R23_intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All together now...›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_m3_trans_refines_m2_trans <span class="main">=</span> 
  PO_m3_step1_refines_m2_step1 PO_m3_step2_refines_m2_step2 
  PO_m3_step3_refines_m2_step3 PO_m3_DY_fake_refines_m2_fake 

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_refines_init_m2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m3 <span class="main">⊆</span> R23<span class="main">``</span><span class="main">(</span>init m2<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23_defs m2_defs m3_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_refines_trans_m2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23 <span class="main">∩</span> UNIV <span class="main">×</span> m3_inv1_keys<span class="main">}</span> 
     <span class="main">(</span>trans m2<span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans m3<span class="main">)</span> 
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m3_def m3_trans_def m2_def m2_trans_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_m3_trans_refines_m2_trans<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_R23_obs_consistent <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"obs_consistent R23 med32 m2 m3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R23_def m2_defs m3_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_refines_m2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"refines 
     <span class="main">(</span>R23 <span class="main">∩</span> UNIV <span class="main">×</span> m3_inv1_keys<span class="main">)</span>
     med32 m2 m3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Refinement_using_invariants<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="m1_keydist">
<div class="head">
<h1>Theory m1_keydist</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Development of Security Protocols by Refinement

  Module:  Key_establish/m1b_keydist.thy (Isabelle/HOL 2016-1)
  ID:      $Id: m1_keydist.thy 134925 2017-05-24 17:53:14Z csprenge $
  Author:  Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  Key distribution protocols
  First refinement: abstract server-based key transport protocol with 
  initiator and responder roles.

  Copyright (c) 2009-2016 Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Key Establishment Protocols›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this chapter, we develop several key establishment protocols:
\begin{itemize} 
\item Needham-Schroeder Shared Key (NSSK) 
\item core Kerberos IV and V, and
\item Denning-Sacco. 
\end{itemize}
›</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Basic abstract key distribution (L1)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> m1_keydist <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Runs.html">../Refinement/Runs</a>"</span> <span class="quoted">"<a href="s0g_secrecy.html">../Refinement/s0g_secrecy</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The first refinement introduces the protocol roles, local memory of the
agents and the communication structure of the protocol.  For actual 
communication, the "receiver" directly reads the memory of the "sender". 

It captures the core of essentials of server-based key distribution protocols:
The server generates a key that the clients read from his memory. At this
stage we are only interested in secrecy preservation, not in authentication.
›</span></span>

<span class="keyword1"><span class="command">declare</span></span> option.split_asm <span class="main">[</span><span class="operator">split</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> domIff <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">iff</span> <span class="quasi_keyword">del</span><span class="main">]</span> 

<span class="keyword1"><span class="command">consts</span></span>
  sk <span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>             <span class="comment1">― ‹identifier used for session keys›</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹State›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Runs record the protocol participants (initiator, responder) and the 
keys learned during the execution. In later refinements, we will also add
nonces and timestamps to the run record.

The variables <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>kn›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>az›</span></span></span></span> from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>s0g_secrecy_leak›</span></span></span></span> 
are replaced by runs using a data refinement. Variable <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>lk›</span></span></span></span> is 
concretized into variable <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>leak›</span></span></span></span>. 

We define the state in two separate record definitions. The first one has 
just a runs field and the second extends this with a leak field.  Later 
refinements may define different state for leaks (e.g. to record more context).
›</span></span>

<span class="keyword1"><span class="command">record</span></span> m1r_state <span class="main">=</span> 
  runs <span class="main">::</span> <span class="quoted">runs_t</span>

<span class="keyword1"><span class="command">record</span></span> m1x_state <span class="main">=</span> <span class="quoted">m1r_state</span> <span class="main">+</span>  
  leak <span class="main">::</span> <span class="quoted"><span class="quoted">"key set"</span></span>             <span class="comment1">― ‹keys leaked to attacker›</span>

<span class="keyword1"><span class="command">type_synonym</span></span> m1x_obs <span class="main">=</span> <span class="quoted"><span class="quoted">"m1x_state"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Predicate types for invariants and transition relation types. Use the
r-version for invariants and transitions if there is no reference to the leak
variable. This improves reusability in later refinements.
›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'x</span> m1r_pred <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> m1r_state_scheme set"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'x</span> m1x_pred <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> m1x_state_scheme set"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'x</span> m1r_trans <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'x</span> m1r_state_scheme <span class="main">×</span> <span class="tfree">'x</span> m1r_state_scheme<span class="main">)</span> set"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'x</span> m1x_trans <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'x</span> m1x_state_scheme <span class="main">×</span> <span class="tfree">'x</span> m1x_state_scheme<span class="main">)</span> set"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Key knowledge and authorization (reconstruction)›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Key knowledge and authorization relations, reconstructed from the runs 
and an unspecified initial key setup. These auxiliary definitions are used in 
some event guards and in the simulation relation (see below).›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Knowledge relation (reconstructed)›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span>
  <span class="entity">knC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"runs_t <span class="main">⇒</span> <span class="main">(</span>key <span class="main">×</span> agent<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">runz</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"runs_t"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  knC_init<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">runz</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> aKey <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">al</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">knC</span> <span class="free">runz</span>"</span></span>
<span class="main">|</span> knC_resp<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">runz</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> aKey <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">al</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">knC</span> <span class="free">runz</span>"</span></span>
<span class="main">|</span> knC_serv<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">∈</span> dom <span class="free">runz</span><span class="main">;</span> fst <span class="main">(</span>the <span class="main">(</span><span class="free">runz</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Serv <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span><span class="main">,</span> Sv<span class="main">)</span> <span class="main">∈</span> <span class="free">knC</span> <span class="free">runz</span>"</span></span>
<span class="main">|</span> knC_0<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">∈</span> keySetup <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">knC</span> <span class="free">runz</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Authorization relation (reconstructed)›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span>
  <span class="entity">azC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"runs_t <span class="main">⇒</span> <span class="main">(</span>key <span class="main">×</span> agent<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">runz</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"runs_t"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  azC_good<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">runz</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">al</span></span></span><span class="main">)</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">∈</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Sv<span class="main">}</span> <span class="main">⟧</span> 
   <span class="main">⟹</span> <span class="main">(</span>sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">azC</span> <span class="free">runz</span>"</span></span>
<span class="main">|</span> azC_bad<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">runz</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">al</span></span></span><span class="main">)</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∈</span> bad <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∈</span> bad <span class="main">⟧</span> 
   <span class="main">⟹</span> <span class="main">(</span>sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">azC</span> <span class="free">runz</span>"</span></span>
<span class="main">|</span> azC_0<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">∈</span> keySetup <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">azC</span> <span class="free">runz</span>"</span></span>


<span class="keyword1"><span class="command">declare</span></span> knC.intros <span class="main">[</span><span class="operator">intro</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> azC.intros <span class="main">[</span><span class="operator">intro</span><span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Misc lemmas: empty state, projections, ...›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> knC_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"knC Map.empty <span class="main">=</span> keySetup"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> knC.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> azC_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"azC Map.empty <span class="main">=</span> keySetup"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> azC.cases<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>azC›</span></span></span></span> and run abstraction›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> azC_map_runs <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"azC <span class="main">(</span>map_runs <span class="free">h</span> <span class="free">runz</span><span class="main">)</span> <span class="main">=</span> azC <span class="free">runz</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_runs_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> azC.cases<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Update lemmas for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"knC"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> knC_upd_Init_Resp_None<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">R</span> <span class="main">∉</span> dom <span class="free">runz</span><span class="main">;</span> <span class="free">rol</span> <span class="main">∈</span> <span class="main">{</span>Init<span class="main">,</span> Resp<span class="main">}</span> <span class="main">⟧</span>
  <span class="main">⟹</span> knC <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">R</span> <span class="main">↦</span> <span class="main">(</span><span class="free">rol</span><span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> knC <span class="free">runz</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domIff <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> knC.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> knC_upd_Init_Some<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">runz</span> <span class="free">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> knC <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Ra</span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span><span class="free">Kab</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>knC <span class="free">runz</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> knC.cases<span class="main">)</span> 
<span class="comment1">― ‹3 subgoals›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> Raa Aa Ba K al<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Aa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Ba</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> al<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">al</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> knC_init<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> Rb Aa Ba K al<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Aa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Ba</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> al<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">al</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> knC_resp<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> knC_serv<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> knC_upd_Resp_Some<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">runz</span> <span class="free">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> knC <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Ra</span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span><span class="free">Kab</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span>knC <span class="free">runz</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> knC.cases<span class="main">)</span>
<span class="comment1">― ‹3 subgoals›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> Raa Aa Ba K al<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Aa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Ba</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> al<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">al</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> knC_init<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> Raa Aa Ba K al<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Aa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Ba</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> al<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">al</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> knC_resp<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> knC_serv<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> knC_upd_Server<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Rs</span> <span class="main">∉</span> dom <span class="free">runz</span> <span class="main">⟧</span>
  <span class="main">⟹</span> knC <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Rs</span> <span class="main">↦</span> <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span>sesK <span class="main">(</span><span class="free">Rs</span><span class="main">$</span>sk<span class="main">)</span><span class="main">,</span> Sv<span class="main">)</span> <span class="main">(</span>knC <span class="free">runz</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> knC.cases<span class="main">)</span>
<span class="comment1">― ‹2 subgoals›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> Raa Aa Ba K al<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Aa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Ba</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> knC_init<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> Raa Aa Ba K al<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Aa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Ba</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> knC_resp<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> knC_upd_lemmas <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> 
  knC_upd_Init_Resp_None knC_upd_Init_Some knC_upd_Resp_Some
  knC_upd_Server 


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Update lemmas for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"azC"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> azC_upd_Init_None<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Ra</span> <span class="main">∉</span> dom <span class="free">runz</span> <span class="main">⟧</span>
  <span class="main">⟹</span> azC <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Ra</span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> azC <span class="free">runz</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> azC.simps <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> azC.cases <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> azC_upd_Resp_None<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Rb</span> <span class="main">∉</span> dom <span class="free">runz</span> <span class="main">⟧</span>
  <span class="main">⟹</span> azC <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Rb</span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> azC <span class="free">runz</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> azC.simps <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> azC.cases <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> azC_upd_Init_Some<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">runz</span> <span class="free">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> azC <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Ra</span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="free">al</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> azC <span class="free">runz</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> azC.cases<span class="main">)</span>
<span class="comment1">― ‹5 subgoals›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> azC_good<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> azC_good<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> azC_good<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> azC_bad<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> azC_upd_Resp_Some<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">runz</span> <span class="free">Rb</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> azC <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Rb</span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="free">al</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> azC <span class="free">runz</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> azC.cases<span class="main">)</span>
<span class="comment1">― ‹5 subgoals›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> azC_good<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> azC_good<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> azC_good<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> azC_bad<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> azC_upd_Serv_bad<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Rs</span> <span class="main">∉</span> dom <span class="free">runz</span><span class="main">;</span> <span class="free">A</span> <span class="main">∈</span> bad <span class="main">∨</span> <span class="free">B</span> <span class="main">∈</span> bad <span class="main">⟧</span>
  <span class="main">⟹</span> azC <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Rs</span> <span class="main">↦</span> <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="free">al</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> azC <span class="free">runz</span> <span class="main">∪</span> <span class="main">{</span>sesK <span class="main">(</span><span class="free">Rs</span><span class="main">$</span>sk<span class="main">)</span><span class="main">}</span> <span class="main">×</span> UNIV"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> azC.cases<span class="main">)</span>
<span class="comment1">― ‹10 subgoals›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span>
  <span class="operator">rename_tac</span> Rsa Aa Ba ala<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">Aa</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">Ba</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> al<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">ala</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> azC_good<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">rename_tac</span> Rsa Aa Ba ala<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">Aa</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">Ba</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> al<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">ala</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> azC_good<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">rename_tac</span> Rsa Aa Ba ala<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">Aa</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">Ba</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> al<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">ala</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> azC_good<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">rename_tac</span> Rsa Aa Ba ala C<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">Aa</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">Ba</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> al<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">ala</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> azC_bad<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">rename_tac</span> Rsa Aa Ba ala C<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">Aa</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">Ba</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> al<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">ala</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> azC_bad<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas
<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> azC_upd_Serv_good<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Rs</span> <span class="main">∉</span> dom <span class="free">runz</span><span class="main">;</span> <span class="free">K</span> <span class="main">=</span> sesK <span class="main">(</span><span class="free">Rs</span><span class="main">$</span>sk<span class="main">)</span><span class="main">;</span> <span class="free">A</span> <span class="main">∉</span> bad<span class="main">;</span> <span class="free">B</span> <span class="main">∉</span> bad <span class="main">⟧</span>
  <span class="main">⟹</span> azC <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Rs</span> <span class="main">↦</span> <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="free">al</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">=</span> azC <span class="free">runz</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">K</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">K</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">K</span><span class="main">,</span> Sv<span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> azC.cases<span class="main">)</span>
<span class="comment1">― ‹5 subgoals›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span>
  <span class="operator">rename_tac</span> Rsa Aa Ba ala<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Aa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Ba</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> al<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">ala</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> azC_good<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">rename_tac</span> Rsa Aa Ba ala<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Aa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Ba</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> al<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">ala</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> azC_good<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">rename_tac</span> Rsa Aa Ba ala<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Aa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Ba</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> al<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">ala</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> azC_good<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">rename_tac</span> Rsa Aa Ba ala C<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Aa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Ba</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> al<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">ala</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> azC_bad<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">rename_tac</span> Rsa Aa Ba ala C<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Aa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Ba</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> al<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">ala</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> azC_bad<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas
<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> azC_upd_Serv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Rs</span> <span class="main">∉</span> dom <span class="free">runz</span><span class="main">;</span> <span class="free">K</span> <span class="main">=</span> sesK <span class="main">(</span><span class="free">Rs</span><span class="main">$</span>sk<span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> azC <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Rs</span> <span class="main">↦</span> <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="free">al</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
     azC <span class="free">runz</span> <span class="main">∪</span> <span class="main">{</span><span class="free">K</span><span class="main">}</span> <span class="main">×</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">A</span> <span class="main">∉</span> bad <span class="main">∧</span> <span class="free">B</span> <span class="main">∉</span> bad <span class="keyword1">then</span> <span class="main">{</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">,</span> Sv<span class="main">}</span> <span class="keyword1">else</span> UNIV<span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> azC_upd_Serv_bad azC_upd_Serv_good<span class="main">)</span> 

<span class="keyword1"><span class="command">lemmas</span></span> azC_upd_lemmas <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span>
  azC_upd_Init_None azC_upd_Resp_None
  azC_upd_Init_Some azC_upd_Resp_Some azC_upd_Serv


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Events›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">A</span>"</span><span class="antiquote">}</span></span>, refines skip›</span>
  <span class="entity">m1x_step1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'x</span> m1r_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1x_step1</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>

    <span class="comment1">― ‹guards:›</span>
    <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>                <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Ra›</span></span> is fresh›</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="comment1">― ‹create initiator thread›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">B</span>"</span><span class="antiquote">}</span></span>, refines skip›</span>
  <span class="entity">m1x_step2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'x</span> m1r_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1x_step2</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>

    <span class="comment1">― ‹guards:›</span>
    <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>               <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Rb›</span></span> is fresh›</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="comment1">― ‹create responder thread›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"Server"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">s0g_gen</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1x_step3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> key<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'x</span> m1r_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1x_step3</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>

    <span class="comment1">― ‹guards:›</span>
    <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>                        <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Rs›</span></span> is fresh›</span>
    <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">=</span> sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span>                       <span class="comment1">― ‹generate session key›</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">↦</span> <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">A</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">s0g_learn</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1x_step4</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> key<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'x</span> m1x_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1x_step4</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">∉</span> leak <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">∈</span> azC <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>   <span class="comment1">― ‹authorization guard›</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"B"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">s0g_learn</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1x_step5</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> key<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'x</span> m1x_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1x_step5</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span> 
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">∉</span> leak <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">∈</span> azC <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>    <span class="comment1">― ‹authorization guard›</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by attacker, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">s0g_leak</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1x_leak</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> <span class="tfree">'x</span> m1x_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1x_leak</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>           
    <span class="comment1">― ‹guards:›</span>
    <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">∈</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
    fst <span class="main">(</span>the <span class="main">(</span>runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Serv <span class="main">∧</span>         <span class="comment1">― ‹compromise server run <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Rs›</span></span>›</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> leak <span class="main">:=</span> insert <span class="main">(</span>sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span> <span class="main">(</span>leak <span class="bound">s</span><span class="main">)</span> <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Specification›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m1x_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m1x_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1x_init</span> <span class="main">≡</span> <span class="main">{</span> <span class="main">⦇</span>
     runs <span class="main">=</span> Map.empty<span class="main">,</span>
     leak <span class="main">=</span> corrKey         <span class="comment1">― ‹statically corrupted keys initially leaked›</span>
  <span class="main">⦈</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m1x_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> m1x_trans"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1x_trans</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Ra</span> <span class="bound">Rb</span> <span class="bound">Rs</span> <span class="bound">Kab</span><span class="main">.</span>
     m1x_step1 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">∪</span>
     m1x_step2 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">∪</span>
     m1x_step3 <span class="bound">Rs</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Kab</span> <span class="main">∪</span>
     m1x_step4 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Kab</span> <span class="main">∪</span>
     m1x_step5 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Kab</span> <span class="main">∪</span>
     m1x_leak <span class="bound">Rs</span> <span class="main">∪</span>
     Id
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m1x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m1x_state<span class="main">,</span> m1x_obs<span class="main">)</span> spec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1x</span> <span class="main">≡</span> <span class="main">⦇</span>
    init <span class="main">=</span> m1x_init<span class="main">,</span>
    trans <span class="main">=</span> m1x_trans<span class="main">,</span>
    obs <span class="main">=</span> id
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m1x_defs <span class="main">=</span> 
  m1x_def m1x_init_def m1x_trans_def
  m1x_step1_def m1x_step2_def m1x_step3_def m1x_step4_def m1x_step5_def 
  m1x_leak_def 

<span class="keyword1"><span class="command">lemma</span></span> m1x_obs_id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"obs m1x <span class="main">=</span> id"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1x_def<span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv1: Key definedness›</span></span>
<span class="comment1">(*inv**************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Only run identifiers or static keys can be (concretely) known or 
authorized keys. (This reading corresponds to the contraposition of the 
property expressed below.)›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m1x_inv1_key</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m1x_state set"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1x_inv1_key</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Rs</span> <span class="bound">A</span><span class="main">.</span>
     <span class="bound">Rs</span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span> 
       <span class="main">(</span>sesK <span class="main">(</span><span class="bound">Rs</span><span class="main">$</span>sk<span class="main">)</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span> <span class="main">∉</span> knC <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span> 
       <span class="main">(</span>sesK <span class="main">(</span><span class="bound">Rs</span><span class="main">$</span>sk<span class="main">)</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span> <span class="main">∉</span> azC <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
       sesK <span class="main">(</span><span class="bound">Rs</span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∉</span> leak <span class="bound">s</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m1x_inv1_keyI <span class="main">=</span> m1x_inv1_key_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m1x_inv1_keyE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> 
  m1x_inv1_key_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m1x_inv1_keyD <span class="main">[</span><span class="operator">dest</span><span class="main">]</span> <span class="main">=</span> 
  m1x_inv1_key_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1x_inv1_key_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m1x <span class="main">⊆</span> m1x_inv1_key"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1x_defs m1x_inv1_key_def<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> PO_m1x_inv1_key_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m1x_inv1_key<span class="main">}</span> trans m1x <span class="main">{&gt;</span> m1x_inv1_key<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m1x_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m1x_inv1_keyI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1x_inv1_key <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m1x <span class="main">⊆</span> m1x_inv1_key"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement of s0g›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹med10: The mediator function maps a concrete observation to an 
abstract one.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">med01x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m1x_obs <span class="main">⇒</span> key s0g_obs"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med01x</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> kn <span class="main">=</span> knC <span class="main">(</span>runs <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">,</span> az <span class="main">=</span> azC <span class="main">(</span>runs <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">,</span> lk <span class="main">=</span> leak <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⦈</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹R01: The simulation relation expreses key knowledge and authorization
in terms of the client and server run information.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R01x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>key s0g_state <span class="main">×</span> m1x_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R01x</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> med01x <span class="bound">t</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> R01x_defs <span class="main">=</span> R01x_def med01x_def


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1x_step1_refines_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R01x<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1x_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R01x<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R01x_defs s0g_defs m1x_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1x_step2_refines_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R01x<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1x_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R01x<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R01x_defs s0g_defs m1x_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1x_step3_refines_s0g_gen<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R01x <span class="main">∩</span> UNIV <span class="main">×</span> m1x_inv1_key<span class="main">}</span> 
     <span class="main">(</span>s0g_gen <span class="free">Kab</span> Sv <span class="main">{</span>Sv<span class="main">,</span> <span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">}</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1x_step3 <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R01x<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R01x_defs s0g_defs m1x_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1x_step4_refines_s0g_learn<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R01x<span class="main">}</span> 
     <span class="main">(</span>s0g_learn <span class="free">Kab</span> <span class="free">A</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1x_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R01x<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R01x_defs s0g_defs m1x_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1x_step5_refines_s0g_learn<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R01x<span class="main">}</span> 
     <span class="main">(</span>s0g_learn <span class="free">Kab</span> <span class="free">B</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1x_step5 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R01x<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R01x_defs s0g_defs m1x_defs<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> PO_m1x_leak_refines_s0g_leak<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R01x<span class="main">}</span> 
     <span class="main">(</span>s0g_leak <span class="main">(</span>sesK <span class="main">(</span><span class="free">Rs</span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1x_leak <span class="free">Rs</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R01x<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R01x_defs s0g_defs m1x_defs<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All together now...›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_m1x_trans_refines_s0g_trans <span class="main">=</span> 
  PO_m1x_step1_refines_skip PO_m1x_step2_refines_skip
  PO_m1x_step3_refines_s0g_gen PO_m1x_step4_refines_s0g_learn 
  PO_m1x_step5_refines_s0g_learn PO_m1x_leak_refines_s0g_leak

<span class="keyword1"><span class="command">lemma</span></span> PO_m1x_refines_init_s0g <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m1x <span class="main">⊆</span> R01x<span class="main">``</span><span class="main">(</span>init s0g<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R01x_defs s0g_defs m1x_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> s0g_secrecyI s0g_domI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1x_refines_trans_s0g <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R01x <span class="main">∩</span> UNIV <span class="main">×</span> m1x_inv1_key<span class="main">}</span> 
     <span class="main">(</span>trans s0g<span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans m1x<span class="main">)</span> 
   <span class="main">{&gt;</span> R01x<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1x_def m1x_trans_def s0g_def s0g_trans_def
         <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_m1x_trans_refines_s0g_trans<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Observation consistency.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> obs_consistent_med01x <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"obs_consistent R01x med01x s0g m1x"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R01x_defs s0g_def m1x_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement result.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1x_refines_s0g <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"refines 
     <span class="main">(</span>R01x <span class="main">∩</span> UNIV <span class="main">×</span> m1x_inv1_key<span class="main">)</span>
     med01x s0g m1x"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Refinement_using_invariants<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>  m1x_implements_s0g <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"implements med01x s0g m1x"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refinement_soundness<span class="main">)</span> <span class="main">(</span><span class="operator">fast</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Derived invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv2: Secrecy›</span></span>
<span class="comment1">(*invh*************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Secrecy, expressed in terms of runs.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m1x_secrecy</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> m1x_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1x_secrecy</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> knC <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">⊆</span> azC <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∪</span> leak <span class="bound">s</span> <span class="main">×</span> UNIV<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m1x_secrecyI <span class="main">=</span> m1x_secrecy_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m1x_secrecyE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m1x_secrecy_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1x_obs_secrecy <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach m1x <span class="main">⊆</span> m1x_secrecy"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> external_invariant_translation <span class="main"><span class="main">[</span></span><span class="operator">OF</span> PO_s0g_obs_secrecy _ m1x_implements_s0g<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> med01x_def m1x_secrecy_def s0g_secrecy_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1x_secrecy <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m1x <span class="main">⊆</span> m1x_secrecy"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> external_to_internal_invariant <span class="main"><span class="main">[</span></span><span class="operator">OF</span> PO_m1x_obs_secrecy<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="m1_keydist_iirn">
<div class="head">
<h1>Theory m1_keydist_iirn</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Development of Security Protocols by Refinement

  Module:   Key_establish/m1_keydist_iirn.thy (Isabelle/HOL 2016-1)
  ID:       $Id: m1_keydist_iirn.thy 133854 2017-03-20 17:53:50Z csprenge $
  Author:   Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;

  Key distribution protocols
  Level 1, 1st refinement: Abstract server-based key transport protocol with 
  initiator and responder roles. Provides injective server authentication to 
  the initiator and non-injective server authenticaiton to the responder.

  Copyright (c) 2009-2016 Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Abstract (i/n)-authenticated key transport (L1)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> m1_keydist_iirn <span class="keyword2"><span class="keyword">imports</span></span> <a href="m1_keydist.html">m1_keydist</a> <span class="quoted">"<a href="a0i_agree.html">../Refinement/a0i_agree</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We add authentication for the initiator and responder to the basic
server-based key transport protocol: 
\begin{enumerate}
\item the initiator injectively agrees with the server on the key and some
additional data
\item the responder non-injectively agrees with the server on the key and 
some additional data.
\end{enumerate}
The "additional data" is a parameter of this model.›</span></span>

<span class="keyword1"><span class="command">declare</span></span> option.split <span class="main">[</span><span class="operator">split</span><span class="main">]</span>
<span class="comment1">(* declare option.split_asm [split] *)</span>

<span class="keyword1"><span class="command">consts</span></span>
  na <span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>

<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹State›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The state type remains the same, but in this model we will record
nonces and timestamps in the run frame.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> m1a_state <span class="main">=</span> <span class="quoted"><span class="quoted">"m1x_state"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> m1a_obs <span class="main">=</span> <span class="quoted"><span class="quoted">"m1x_obs"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'x</span> m1a_pred <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> m1x_pred"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'x</span> m1a_trans <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> m1x_trans"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We need some parameters regarding the list of freshness values
stored by the server. These   should be defined in further refinements.›</span></span>

<span class="keyword1"><span class="command">consts</span></span> 
  is_len <span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>   <span class="comment1">― ‹num of agreeing list elements for initiator-server›</span>  
  rs_len <span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>   <span class="comment1">― ‹num of agreeing list elements for responder-server›</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Events›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>         <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">A</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m1x_step1"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1a_step1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'x</span> m1r_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1a_step1</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>                <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Ra›</span></span> is fresh›</span>
    <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>na <span class="main">∧</span>                       <span class="comment1">― ‹NEW: generate a nonce›</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="comment1">― ‹create initiator thread›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>       <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">B</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m1x_step2"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1a_step2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'x</span> m1r_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1a_step2</span> <span class="main">≡</span> m1x_step2"</span></span>

<span class="keyword1"><span class="command">definition</span></span>       <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"Server"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m1x_step3</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1a_step3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> key<span class="main">,</span> nonce<span class="main">,</span> atom list<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'x</span> m1r_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1a_step3</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">al</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>
     <span class="comment1">― ‹guards:›</span>
     <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>                 <span class="comment1">― ‹fresh run id›</span>
     <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">=</span> sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span>                <span class="comment1">― ‹generate session key›</span>

     <span class="comment1">― ‹actions:›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">↦</span> <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">al</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>         <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"A"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m1x_step4</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1a_step4</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> key<span class="main">,</span> atom list<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'x</span> m1a_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1a_step4</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">nla</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
     <span class="comment1">― ‹guards:›</span>
     runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>
     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">∉</span> leak <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">∈</span> azC <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>  <span class="comment1">― ‹authorization guard›</span>
     <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>na <span class="main">∧</span>                                   <span class="comment1">― ‹fix parameter›</span>

     <span class="comment1">― ‹new guard for agreement with server on <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>(Kab, B, Na, isl)›</span></span>,›</span>
     <span class="comment1">― ‹where <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>isl = take is_len nla›</span></span>; injectiveness by including <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Na›</span></span>›</span>
     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∉</span> bad <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Rs</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">=</span> sesK <span class="main">(</span><span class="bound">Rs</span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span>
        runs <span class="bound">s</span> <span class="bound">Rs</span> <span class="main">=</span> Some <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">#</span> take is_len <span class="free"><span class="bound"><span class="entity">nla</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>

     <span class="comment1">― ‹actions:›</span>
     <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">nla</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span>
  <span class="main">}</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span>         <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">B</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m1x_step5</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1a_step5</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> key<span class="main">,</span> atom list<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'x</span> m1a_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1a_step5</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">nlb</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span> 
     <span class="comment1">― ‹guards:›</span>
     runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span> 
     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">∉</span> leak <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">∈</span> azC <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>         <span class="comment1">― ‹authorization guard›</span>

     <span class="comment1">― ‹guard for showing agreement with server on <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>(Kab, A, rsl)›</span></span>,›</span>
     <span class="comment1">― ‹where <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>rsl = take rs_len nlb›</span></span>; this agreement is non-injective›</span>

     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∉</span> bad <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Rs</span> <span class="bound">Na</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">=</span> sesK <span class="main">(</span><span class="bound">Rs</span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span>
        runs <span class="bound">s</span> <span class="bound">Rs</span> <span class="main">=</span> Some <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> aNon <span class="bound">Na</span> <span class="main">#</span> take rs_len <span class="free"><span class="bound"><span class="entity">nlb</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>

     <span class="comment1">― ‹actions:›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">nlb</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by attacker, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m1x_leak</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1a_leak</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> <span class="tfree">'x</span> m1x_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1a_leak</span> <span class="main">=</span> m1x_leak"</span></span> 


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Specification›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m1a_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m1a_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1a_init</span> <span class="main">≡</span> m1x_init"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m1a_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> m1a_trans"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1a_trans</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Ra</span> <span class="bound">Rb</span> <span class="bound">Rs</span> <span class="bound">Na</span> <span class="bound">Kab</span> <span class="bound">nls</span> <span class="bound">nla</span> <span class="bound">nlb</span><span class="main">.</span>
     m1a_step1 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="main">∪</span>
     m1a_step2 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">∪</span>
     m1a_step3 <span class="bound">Rs</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Kab</span> <span class="bound">Na</span> <span class="bound">nls</span> <span class="main">∪</span>
     m1a_step4 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Kab</span> <span class="bound">nla</span> <span class="main">∪</span>
     m1a_step5 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Kab</span> <span class="bound">nlb</span> <span class="main">∪</span>
     m1a_leak <span class="bound">Rs</span> <span class="main">∪</span>
     Id
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m1a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m1a_state<span class="main">,</span> m1a_obs<span class="main">)</span> spec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1a</span> <span class="main">≡</span> <span class="main">⦇</span>
     init <span class="main">=</span> m1a_init<span class="main">,</span>
     trans <span class="main">=</span> m1a_trans<span class="main">,</span>
     obs <span class="main">=</span> id
  <span class="main">⦈</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> init_m1a<span class="main">:</span> <span class="quoted"><span class="quoted">"init m1a <span class="main">=</span> m1a_init"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1a_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> trans_m1a<span class="main">:</span> <span class="quoted"><span class="quoted">"trans m1a <span class="main">=</span> m1a_trans"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1a_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> obs_m1a <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"obs m1a <span class="main">=</span> id"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1a_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> m1a_loc_defs <span class="main">=</span> 
  m1a_def m1a_init_def m1a_trans_def
  m1a_step1_def m1a_step2_def m1a_step3_def m1a_step4_def m1a_step5_def 
  m1a_leak_def 

<span class="keyword1"><span class="command">lemmas</span></span> m1a_defs <span class="main">=</span> m1a_loc_defs m1x_defs


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv0: Finite domain›</span></span>
<span class="comment1">(*inv**************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹There are only finitely many runs. This is needed to establish
the responder/initiator agreement.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m1a_inv0_fin</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> m1r_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1a_inv0_fin</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> finite <span class="main">(</span>dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m1a_inv0_finI <span class="main">=</span> m1a_inv0_fin_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m1a_inv0_finE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m1a_inv0_fin_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m1a_inv0_finD <span class="main">=</span> m1a_inv0_fin_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_inv0_fin_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m1a <span class="main">⊆</span> m1a_inv0_fin"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1a_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m1a_inv0_finI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_inv0_fin_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m1a_inv0_fin<span class="main">}</span> trans m1a <span class="main">{&gt;</span> m1a_inv0_fin<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m1a_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m1a_inv0_finI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_inv0_fin <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m1a <span class="main">⊆</span> m1a_inv0_fin"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_incr<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>m1x›</span></span></span></span>›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Simulation relation›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Define run abstraction.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> 
  <span class="entity">rm1x1a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"role_t <span class="main">⇒</span> atom list <span class="main">⇒</span> atom list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rm1x1a</span> Init <span class="main">=</span> take <span class="main">1</span>"</span></span>         <span class="comment1">― ‹take <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Kab›</span></span> from <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Kab # nla›</span></span>›</span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rm1x1a</span> Resp <span class="main">=</span> take <span class="main">1</span>"</span></span>         <span class="comment1">― ‹take <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Kab›</span></span> from <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Kab # nlb›</span></span>›</span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rm1x1a</span> Serv <span class="main">=</span> take <span class="main">0</span>"</span></span>         <span class="comment1">― ‹drop all from <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>[Na]›</span></span>›</span>

<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="entity">runs1x1a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"runs_t <span class="main">⇒</span> runs_t"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">runs1x1a</span> <span class="main">≡</span> map_runs rm1x1a"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹med1x1: The mediator function maps a concrete observation to an 
abstract one.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">med1x1a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m1a_obs <span class="main">⇒</span> m1x_obs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med1x1a</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> runs <span class="main">=</span> runs1x1a <span class="main">(</span>runs <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">,</span> leak <span class="main">=</span> leak <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹R1x1a: The simulation relation is defined in terms of the mediator
function.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R1x1a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m1x_state <span class="main">×</span> m1a_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R1x1a</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> med1x1a <span class="bound">t</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> R1x1a_defs <span class="main">=</span> 
  R1x1a_def med1x1a_def 


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement proof›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_step1_refines_m1x_step1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R1x1a<span class="main">}</span> 
     <span class="main">(</span>m1x_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1a_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R1x1a<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R1x1a_defs m1a_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_step2_refines_m1x_step2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R1x1a<span class="main">}</span> 
     <span class="main">(</span>m1x_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1a_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R1x1a<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R1x1a_defs m1a_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_step3_refines_m1x_step3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R1x1a<span class="main">}</span> 
     <span class="main">(</span>m1x_step3 <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1a_step3 <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Na</span> <span class="free">nls</span><span class="main">)</span>
   <span class="main">{&gt;</span> R1x1a<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R1x1a_defs m1a_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_step4_refines_m1x_step4<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R1x1a<span class="main">}</span> 
     <span class="main">(</span>m1x_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1a_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span> <span class="free">nla</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R1x1a<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R1x1a_defs m1a_defs map_runs_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_step5_refines_m1x_step5<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R1x1a<span class="main">}</span> 
     <span class="main">(</span>m1x_step5 <span class="free">A</span> <span class="free">B</span> <span class="free">Rb</span> <span class="free">Kab</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1a_step5 <span class="free">A</span> <span class="free">B</span> <span class="free">Rb</span> <span class="free">Kab</span> <span class="free">nlb</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R1x1a<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R1x1a_defs m1a_defs map_runs_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_leak_refines_m1x_leak<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R1x1a<span class="main">}</span> 
     <span class="main">(</span>m1x_leak <span class="free">Rs</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1a_leak <span class="free">Rs</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R1x1a<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R1x1a_defs m1a_defs map_runs_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All together now...›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_m1a_trans_refines_m1x_trans <span class="main">=</span> 
  PO_m1a_step1_refines_m1x_step1 PO_m1a_step2_refines_m1x_step2
  PO_m1a_step3_refines_m1x_step3 PO_m1a_step4_refines_m1x_step4
  PO_m1a_step5_refines_m1x_step5 PO_m1a_leak_refines_m1x_leak


<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_refines_init_m1x <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m1a <span class="main">⊆</span>  R1x1a<span class="main">``</span><span class="main">(</span>init m1x<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R1x1a_defs m1a_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_refines_trans_m1x <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R1x1a<span class="main">}</span> 
     <span class="main">(</span>trans m1x<span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans m1a<span class="main">)</span> 
   <span class="main">{&gt;</span> R1x1a<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1a_def m1a_trans_def m1x_def m1x_trans_def
            <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_m1a_trans_refines_m1x_trans<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_m1a_trans_refines_m1x_trans<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Observation consistency.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> obs_consistent_med1x1a <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"obs_consistent R1x1a med1x1a m1x m1a"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R1x1a_def m1a_defs<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement result.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_refines_m1x <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"refines R1x1a med1x1a m1x m1a"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Refinement_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>  m1a_implements_m1x <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"implements med1x1a m1x m1a"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refinement_soundness<span class="main">)</span> <span class="main">(</span><span class="operator">fast</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹By transitivity:›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m1a_implements_s0g <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"implements <span class="main">(</span>med01x <span class="keyword1">o</span> med1x1a<span class="main">)</span> s0g m1a"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> implements_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv (inherited): Secrecy›</span></span>
<span class="comment1">(*invh*************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Secrecy preserved from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>m1x›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> knC_runs1x1a <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"knC <span class="main">(</span>runs1x1a <span class="free">runz</span><span class="main">)</span> <span class="main">=</span> knC <span class="free">runz</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_runs_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> knC.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="comment1">― ‹5 subgoals›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> b<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">b</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> b<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">b</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> knC_init<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_runs_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> knC_resp<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_runs_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> knC_serv<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_runs_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_obs_secrecy <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach m1a <span class="main">⊆</span> m1x_secrecy"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> Q<span class="main"><span class="main">=</span></span><span class="quoted">m1x_secrecy</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> external_invariant_translation<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> med1x1a_def m1x_secrecy_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_secrecy <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m1a <span class="main">⊆</span> m1x_secrecy"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> external_to_internal_invariant<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>a0i›</span></span></span></span> for initiator/server›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For the initiator, we get an injective agreement with the server on 
the session key, the responder name, the initiator's nonce and the list of 
freshness values <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"isl"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Simulation relation›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define two auxiliary functions to reconstruct the signals of the
initial model from completed initiator and server runs.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> 
  issig <span class="main">=</span> <span class="quoted"><span class="quoted">"key <span class="main">×</span> agent <span class="main">×</span> nonce <span class="main">×</span> atom list"</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">is_runs2sigs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"runs_t <span class="main">⇒</span> issig signal <span class="main">⇒</span> nat"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_runs2sigs</span> <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="main">(</span>Running <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Sv<span class="main">]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">nl</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
     <span class="main">(</span><span class="keyword1">if</span> <span class="main">∃</span><span class="bound">Rs</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">=</span> sesK <span class="main">(</span><span class="bound">Rs</span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span> 
         <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="bound">Rs</span> <span class="main">=</span> Some <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">nl</span></span></span><span class="main">)</span> 
      <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">is_runs2sigs</span> <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="main">(</span>Commit <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Sv<span class="main">]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">nl</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
     <span class="main">(</span><span class="keyword1">if</span> <span class="main">∃</span><span class="bound">Ra</span> <span class="bound">nla</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">=</span> <span class="bound">Ra</span><span class="main">$</span>na <span class="main">∧</span> 
         <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="bound">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">#</span> <span class="bound">nla</span><span class="main">)</span> <span class="main">∧</span> 
         take is_len <span class="bound">nla</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">nl</span></span></span>
      <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">is_runs2sigs</span> <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">0</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Simulation relation and mediator function. We map completed initiator 
and responder runs to commit and running signals, respectively.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">med_a0m1a_is</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m1a_obs <span class="main">⇒</span> issig a0i_obs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med_a0m1a_is</span> <span class="free"><span class="bound"><span class="entity">o1</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> signals <span class="main">=</span> is_runs2sigs <span class="main">(</span>runs <span class="free"><span class="bound"><span class="entity">o1</span></span></span><span class="main">)</span><span class="main">,</span> corrupted <span class="main">=</span> <span class="main">{}</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R_a0m1a_is</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>issig a0i_state <span class="main">×</span> m1a_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R_a0m1a_is</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> signals <span class="bound">s</span> <span class="main">=</span> is_runs2sigs <span class="main">(</span>runs <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> corrupted <span class="bound">s</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> R_a0m1a_is_defs <span class="main">=</span> R_a0m1a_is_def med_a0m1a_is_def 


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Lemmas about the auxiliary functions›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_runs2sigs_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">runz</span> <span class="main">=</span> Map.empty <span class="main">⟹</span> is_runs2sigs <span class="free">runz</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span> 
   <span class="main">(</span><span class="operator">rule</span> is_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Update lemmas›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_runs2sigs_upd_init_none <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Ra</span> <span class="main">∉</span> dom <span class="free">runz</span> <span class="main">⟧</span>
  <span class="main">⟹</span> is_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Ra</span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> is_runs2sigs <span class="free">runz</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span> 
   <span class="main">(</span><span class="operator">rule</span> is_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_runs2sigs_upd_resp_none <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Rb</span> <span class="main">∉</span> dom <span class="free">runz</span> <span class="main">⟧</span>
  <span class="main">⟹</span> is_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Rb</span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> is_runs2sigs <span class="free">runz</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span> 
   <span class="main">(</span><span class="operator">rule</span> is_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_runs2sigs_upd_serv <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Rs</span> <span class="main">∉</span> dom <span class="free">runz</span> <span class="main">⟧</span>
  <span class="main">⟹</span> is_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Rs</span> <span class="main">↦</span> <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> aNon <span class="free">Na</span> <span class="main">#</span> <span class="free">ils</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
     <span class="main">(</span>is_runs2sigs <span class="free">runz</span><span class="main">)</span><span class="main">(</span>Running <span class="main">[</span><span class="free">A</span><span class="main">,</span> Sv<span class="main">]</span> <span class="main">(</span>sesK <span class="main">(</span><span class="free">Rs</span><span class="main">$</span>sk<span class="main">)</span><span class="main">,</span> <span class="free">B</span><span class="main">,</span> <span class="free">Na</span><span class="main">,</span> <span class="free">ils</span><span class="main">)</span> <span class="main">:=</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> rev_mp<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_runs2sigs.induct<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domIff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_runs2sigs_upd_init_some <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">runz</span> <span class="free">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">;</span> <span class="free">ils</span> <span class="main">=</span> take is_len <span class="free">nla</span> <span class="main">⟧</span>
  <span class="main">⟹</span> is_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Ra</span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> aKey <span class="free">Kab</span> <span class="main">#</span> <span class="free">nla</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span>is_runs2sigs <span class="free">runz</span><span class="main">)</span><span class="main">(</span>Commit <span class="main">[</span><span class="free">A</span><span class="main">,</span> Sv<span class="main">]</span> <span class="main">(</span><span class="free">Kab</span><span class="main">,</span> <span class="free">B</span><span class="main">,</span> <span class="free">Ra</span><span class="main">$</span>na<span class="main">,</span> <span class="free">ils</span><span class="main">)</span> <span class="main">:=</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> rev_mp<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_runs2sigs.induct<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_runs2sigs_upd_resp_some <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">runz</span> <span class="free">Rb</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> is_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Rb</span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> aKey <span class="free">Kab</span> <span class="main">#</span> <span class="free">nlb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
     is_runs2sigs <span class="free">runz</span>"</span></span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>  
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement proof›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_step1_refines_a0_is_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0m1a_is<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1a_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0m1a_is<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0m1a_is_defs m1a_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_step2_refines_a0_is_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0m1a_is<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1a_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0m1a_is<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0m1a_is_defs m1a_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_step3_refines_a0_is_running<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0m1a_is<span class="main">}</span> 
     <span class="main">(</span>a0i_running <span class="main">[</span><span class="free">A</span><span class="main">,</span> Sv<span class="main">]</span> <span class="main">(</span><span class="free">Kab</span><span class="main">,</span> <span class="free">B</span><span class="main">,</span> <span class="free">Na</span><span class="main">,</span> <span class="free">nls</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> 
     <span class="main">(</span>m1a_step3 <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Na</span> <span class="free">nls</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0m1a_is<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0m1a_is_defs a0i_defs m1a_defs 
         <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_step4_refines_a0_is_commit<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0m1a_is <span class="main">∩</span> UNIV <span class="main">×</span> m1a_inv0_fin<span class="main">}</span> 
     <span class="main">(</span>a0i_commit <span class="main">[</span><span class="free">A</span><span class="main">,</span> Sv<span class="main">]</span> <span class="main">(</span><span class="free">Kab</span><span class="main">,</span> <span class="free">B</span><span class="main">,</span> <span class="free">Na</span><span class="main">,</span> take is_len <span class="free">nla</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> 
     <span class="main">(</span>m1a_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span> <span class="free">nla</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0m1a_is<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0m1a_is_defs a0i_defs m1a_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_step5_refines_a0_is_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0m1a_is<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1a_step5 <span class="free">A</span> <span class="free">B</span> <span class="free">Rb</span> <span class="free">Kab</span> <span class="free">nlb</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0m1a_is<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0m1a_is_defs m1a_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_leak_refines_a0_is_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0m1a_is<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1a_leak <span class="free">Rs</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0m1a_is<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0m1a_is_defs m1a_defs<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All together now...›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_m1a_trans_refines_a0_is_trans <span class="main">=</span> 
  PO_m1a_step1_refines_a0_is_skip PO_m1a_step2_refines_a0_is_skip
  PO_m1a_step3_refines_a0_is_running PO_m1a_step4_refines_a0_is_commit
  PO_m1a_step5_refines_a0_is_skip PO_m1a_leak_refines_a0_is_skip
  

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_refines_init_a0_is <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m1a <span class="main">⊆</span>  R_a0m1a_is<span class="main">``</span><span class="main">(</span>init a0i<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R_a0m1a_is_defs a0i_defs m1a_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_refines_trans_a0_is <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0m1a_is <span class="main">∩</span> a0i_inv1_iagree <span class="main">×</span> m1a_inv0_fin<span class="main">}</span> 
     <span class="main">(</span>trans a0i<span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans m1a<span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0m1a_is<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1a_def m1a_trans_def a0i_def a0i_trans_def
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_m1a_trans_refines_a0_is_trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> obs_consistent_med_a0m1a_is <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"obs_consistent R_a0m1a_is med_a0m1a_is a0i m1a"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R_a0m1a_is_def med_a0m1a_is_def 
                   a0i_def m1a_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement result.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_refines_a0_is <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"refines <span class="main">(</span>R_a0m1a_is <span class="main">∩</span> a0i_inv1_iagree <span class="main">×</span> m1a_inv0_fin<span class="main">)</span> med_a0m1a_is a0i m1a"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Refinement_using_invariants<span class="main">)</span> 
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>  m1a_implements_a0_is<span class="main">:</span> <span class="quoted"><span class="quoted">"implements med_a0m1a_is a0i m1a"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refinement_soundness<span class="main">)</span> <span class="main">(</span><span class="operator">fast</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv2i (inherited): Initiator and server›</span></span>
<span class="comment1">(*invh*************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This is a translation of the agreement property to Level 1. It
follows from the refinement and is needed to prove inv1.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m1a_inv2i_serv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> m1x_state_scheme set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1a_inv2i_serv</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Ra</span> <span class="bound">Kab</span> <span class="bound">nla</span><span class="main">.</span>
     <span class="bound">A</span> <span class="main">∉</span> bad <span class="main">⟶</span>
     runs <span class="bound">s</span> <span class="bound">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> aKey <span class="bound">Kab</span> <span class="main">#</span> <span class="bound">nla</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound">Rs</span><span class="main">.</span> <span class="bound">Kab</span> <span class="main">=</span> sesK <span class="main">(</span><span class="bound">Rs</span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span> 
         runs <span class="bound">s</span> <span class="bound">Rs</span> <span class="main">=</span> Some <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> aNon <span class="main">(</span><span class="bound">Ra</span><span class="main">$</span>na<span class="main">)</span> <span class="main">#</span> take is_len <span class="bound">nla</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m1a_inv2i_servI <span class="main">=</span> 
  m1a_inv2i_serv_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m1a_inv2i_servE <span class="main">=</span>     <span class="comment1">(* DO NOT declare elim: leads to slow proofs! *)</span>
  m1a_inv2i_serv_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m1a_inv2i_servD <span class="main">=</span>     <span class="comment1">(* DO NOT declare dest: leads to slow proofs! *)</span>
  m1a_inv2i_serv_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> -1<span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof, see below after init/serv authentication proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_inv2i_serv <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"reach m1a <span class="main">⊆</span> m1a_inv2i_serv"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> INV_from_Refinement_basic <span class="main"><span class="main">[</span></span><span class="operator">OF</span> PO_m1a_refines_a0_is<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R_a0m1a_is_def a0i_inv1_iagree_def 
            <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m1a_inv2i_servI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="improper">A</span><span class="main">,</span> Sv<span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv1: Key freshness for initiator›</span></span>
<span class="comment1">(*inv**************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The initiator obtains key freshness from the injective agreement
with the server AND the fact that there is only one server run with a 
given key.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m1a_inv1_ifresh</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> m1a_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1a_inv1_ifresh</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="bound">A'</span> <span class="bound">B</span> <span class="bound">B'</span> <span class="bound">Ra</span> <span class="bound">Ra'</span> <span class="bound">Kab</span> <span class="bound">nl</span> <span class="bound">nl'</span><span class="main">.</span>
     runs <span class="bound">s</span> <span class="bound">Ra</span>  <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span>  <span class="bound">B</span><span class="main">]</span><span class="main">,</span>  aKey <span class="bound">Kab</span> <span class="main">#</span> <span class="bound">nl</span><span class="main">)</span> <span class="main">⟶</span>
     runs <span class="bound">s</span> <span class="bound">Ra'</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="bound">A'</span><span class="main">,</span> <span class="bound">B'</span><span class="main">]</span><span class="main">,</span> aKey <span class="bound">Kab</span> <span class="main">#</span> <span class="bound">nl'</span><span class="main">)</span> <span class="main">⟶</span>
     <span class="bound">A</span> <span class="main">∉</span> bad <span class="main">⟶</span> <span class="bound">B</span> <span class="main">∉</span> bad <span class="main">⟶</span> <span class="bound">Kab</span> <span class="main">∉</span> leak <span class="bound">s</span> <span class="main">⟶</span>
       <span class="bound">Ra</span> <span class="main">=</span> <span class="bound">Ra'</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m1a_inv1_ifreshI <span class="main">=</span> m1a_inv1_ifresh_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m1a_inv1_ifreshE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m1a_inv1_ifresh_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m1a_inv1_ifreshD <span class="main">=</span> m1a_inv1_ifresh_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_inv1_ifresh_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m1a <span class="main">⊆</span> m1a_inv1_ifresh"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1a_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m1a_inv1_ifreshI<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_inv1_ifresh_step4<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m1a_inv1_ifresh <span class="main">∩</span> m1a_inv2i_serv <span class="main">∩</span> m1x_secrecy<span class="main">}</span> 
      m1a_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span> <span class="free">nla</span>
   <span class="main">{&gt;</span> m1a_inv1_ifresh<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m1a_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m1a_inv1_ifreshI<span class="main"><span class="keyword3">,</span></span>  <span class="comment1">(* UGLY *)</span>
       <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m1a_inv1_ifreshD<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m1a_inv2i_servD<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Rs</span> <span class="skolem">Ra'</span> <span class="skolem">A'</span> <span class="skolem">B'</span> <span class="skolem">nl'</span> <span class="skolem">s</span> 
  <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span>sesK <span class="main">(</span><span class="skolem">Rs</span> <span class="main">$</span> sk<span class="main">)</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> azC <span class="main">(</span>runs <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"sesK <span class="main">(</span><span class="skolem">Rs</span> <span class="main">$</span> sk<span class="main">)</span> <span class="main">∉</span> leak <span class="skolem">s</span>"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∉</span> bad"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∉</span> bad"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ra'</span> <span class="main">≠</span> <span class="free">Ra</span>"</span></span>
    <span class="quoted"><span class="quoted">"runs <span class="skolem">s</span> <span class="free">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span> 
    <span class="quoted"><span class="quoted">"runs <span class="skolem">s</span> <span class="skolem">Rs</span> <span class="main">=</span> Some <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> aNon <span class="main">(</span><span class="free">Ra</span> <span class="main">$</span> na<span class="main">)</span> <span class="main">#</span> take is_len <span class="free">nla</span><span class="main">)</span>"</span></span> 
    <span class="quoted"><span class="quoted">"runs <span class="skolem">s</span> <span class="skolem">Ra'</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="skolem">A'</span><span class="main">,</span> <span class="skolem">B'</span><span class="main">]</span><span class="main">,</span> aKey <span class="main">(</span>sesK <span class="main">(</span><span class="skolem">Rs</span> <span class="main">$</span> sk<span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">nl'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> m1x_secrecy"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> m1a_inv2i_serv"</span></span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">A'</span> <span class="main">∈</span> bad"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True 
    <span class="keyword1"><span class="command">from</span></span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sesK <span class="main">(</span><span class="skolem">Rs</span><span class="main">$</span>sk<span class="main">)</span><span class="main">,</span> <span class="skolem">A'</span><span class="main">)</span> <span class="main">∈</span> azC <span class="main">(</span>runs <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> m1x_secrecyE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">with</span></span> H True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> azC.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m1a_inv2i_servD<span class="main">)</span> 
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m1a_inv2i_servD<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A'</span> <span class="skolem">B'</span> <span class="skolem">Ra'</span> <span class="skolem">nl</span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Kab</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> azC <span class="main">(</span>runs <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Kab</span> <span class="main">∉</span> leak <span class="skolem">s</span>"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="skolem">A'</span> <span class="main">∉</span> bad"</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">B'</span> <span class="main">∉</span> bad"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> bad"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ra'</span> <span class="main">≠</span> <span class="free">Ra</span>"</span></span>
    <span class="quoted"><span class="quoted">"runs <span class="skolem">s</span> <span class="skolem">Ra'</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="skolem">A'</span><span class="main">,</span> <span class="skolem">B'</span><span class="main">]</span><span class="main">,</span> aKey <span class="free">Kab</span> <span class="main">#</span> <span class="skolem">nl</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"runs <span class="skolem">s</span> <span class="free">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> m1a_inv2i_serv"</span></span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> azC.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m1a_inv2i_servD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_inv1_ifresh_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m1a_inv1_ifresh <span class="main">∩</span> m1a_inv2i_serv <span class="main">∩</span> m1x_secrecy<span class="main">}</span> trans m1a <span class="main">{&gt;</span> m1a_inv1_ifresh<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1a_def m1a_trans_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Ra</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Kab</span> <span class="skolem">Ts</span> <span class="skolem">nla</span>
  <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">{</span>m1a_inv1_ifresh <span class="main">∩</span> m1a_inv2i_serv <span class="main">∩</span> m1x_secrecy<span class="main">}</span> 
        m1a_step4 <span class="skolem">Ra</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Kab</span> <span class="skolem">Ts</span> <span class="skolem">nla</span>
     <span class="main">{&gt;</span> m1a_inv1_ifresh<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> PO_m1a_inv1_ifresh_step4<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m1a_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m1a_inv1_ifreshI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_inv1_ifresh <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m1a <span class="main">⊆</span> m1a_inv1_ifresh"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> J<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">" m1a_inv2i_serv <span class="main">∩</span> m1x_secrecy"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> inv_rule_incr<span class="main">)</span> 
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Int_assoc <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>a0n›</span></span></span></span> for responder/server›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For the responder, we get a non-injective agreement with the server on 
the session key, the initiator's name, and additional data.›</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Simulation relation›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define two auxiliary functions to reconstruct the signals of the
initial model from completed responder and server runs.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  rssig <span class="main">=</span> <span class="quoted"><span class="quoted">"key <span class="main">×</span> agent <span class="main">×</span> atom list"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">rs_commit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>runs_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> key<span class="main">,</span> atom list<span class="main">]</span> <span class="main">⇒</span> rid_t set"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rs_commit</span> <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">rsl</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">Rb</span><span class="main">.</span> <span class="main">∃</span><span class="bound">nlb</span><span class="main">.</span> 
     <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="bound">Rb</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">#</span> <span class="bound">nlb</span><span class="main">)</span> <span class="main">∧</span> take rs_len <span class="bound">nlb</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">rsl</span></span></span> 
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">rs_runs2sigs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"runs_t <span class="main">⇒</span> rssig signal <span class="main">⇒</span> nat"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rs_runs2sigs</span> <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="main">(</span>Running <span class="main">[</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Sv<span class="main">]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rsl</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
     <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Rs</span> <span class="bound">Na</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">=</span> sesK <span class="main">(</span><span class="bound">Rs</span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span> 
           <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="bound">Rs</span> <span class="main">=</span> Some <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> aNon <span class="bound">Na</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">rsl</span></span></span><span class="main">)</span><span class="main">)</span> 
      <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rs_runs2sigs</span> <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="main">(</span>Commit <span class="main">[</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Sv<span class="main">]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rsl</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
     card <span class="main">(</span>rs_commit <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">rsl</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rs_runs2sigs</span> <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">0</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Simulation relation and mediator function. We map completed initiator 
and responder runs to commit and running signals, respectively.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">med_a0m1a_rs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m1a_obs <span class="main">⇒</span> rssig a0n_obs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med_a0m1a_rs</span> <span class="free"><span class="bound"><span class="entity">o1</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> signals <span class="main">=</span> rs_runs2sigs <span class="main">(</span>runs <span class="free"><span class="bound"><span class="entity">o1</span></span></span><span class="main">)</span><span class="main">,</span> corrupted <span class="main">=</span> <span class="main">{}</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R_a0m1a_rs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rssig a0n_state <span class="main">×</span> m1a_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R_a0m1a_rs</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> signals <span class="bound">s</span> <span class="main">=</span> rs_runs2sigs <span class="main">(</span>runs <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> corrupted <span class="bound">s</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> R_a0m1a_rs_defs <span class="main">=</span> R_a0m1a_rs_def med_a0m1a_rs_def 


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Lemmas about the auxiliary functions›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Other lemmas›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rs_runs2sigs_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">runz</span> <span class="main">=</span> Map.empty <span class="main">⟹</span> rs_runs2sigs <span class="free">runz</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span> 
   <span class="main">(</span><span class="operator">rule</span> rs_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rs_commit_finite <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">runz</span><span class="main">)</span> <span class="main">⟹</span> finite <span class="main">(</span>rs_commit <span class="free">runz</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">nls</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Update lemmas›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rs_runs2sigs_upd_init_none <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Ra</span> <span class="main">∉</span> dom <span class="free">runz</span> <span class="main">⟧</span>
  <span class="main">⟹</span> rs_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Ra</span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> rs_runs2sigs <span class="free">runz</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span> 
   <span class="main">(</span><span class="operator">rule</span> rs_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rs_runs2sigs_upd_resp_none <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Rb</span> <span class="main">∉</span> dom <span class="free">runz</span> <span class="main">⟧</span>
  <span class="main">⟹</span> rs_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Rb</span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> rs_runs2sigs <span class="free">runz</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span> 
   <span class="main">(</span><span class="operator">rule</span> rs_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rs_runs2sigs_upd_serv <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Rs</span> <span class="main">∉</span> dom <span class="free">runz</span> <span class="main">⟧</span>
  <span class="main">⟹</span> rs_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Rs</span> <span class="main">↦</span> <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> aNon <span class="free">Na</span> <span class="main">#</span> <span class="free">nls</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
     <span class="main">(</span>rs_runs2sigs <span class="free">runz</span><span class="main">)</span><span class="main">(</span>Running <span class="main">[</span><span class="free">B</span><span class="main">,</span> Sv<span class="main">]</span> <span class="main">(</span>sesK <span class="main">(</span><span class="free">Rs</span><span class="main">$</span>sk<span class="main">)</span><span class="main">,</span> <span class="free">A</span><span class="main">,</span> <span class="free">nls</span><span class="main">)</span> <span class="main">:=</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span> 
   <span class="main">(</span><span class="operator">rule</span> rs_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rs_runs2sigs_upd_init_some <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">runz</span> <span class="free">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> rs_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Ra</span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> aKey <span class="free">Kab</span> <span class="main">#</span> <span class="free">nl</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
     rs_runs2sigs <span class="free">runz</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span>
   <span class="main">(</span><span class="operator">rule</span> rs_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>  

<span class="keyword1"><span class="command">lemma</span></span> rs_runs2sigs_upd_resp_some <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">runz</span> <span class="free">Rb</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">;</span> finite <span class="main">(</span>dom <span class="free">runz</span><span class="main">)</span><span class="main">;</span>
     <span class="free">rsl</span> <span class="main">=</span> take rs_len <span class="free">nlb</span> <span class="main">⟧</span>
 <span class="main">⟹</span> rs_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Rb</span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> aKey <span class="free">Kab</span> <span class="main">#</span> <span class="free">nlb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span>rs_runs2sigs <span class="free">runz</span><span class="main">)</span><span class="main">(</span>
      Commit <span class="main">[</span><span class="free">B</span><span class="main">,</span> Sv<span class="main">]</span> <span class="main">(</span><span class="free">Kab</span><span class="main">,</span> <span class="free">A</span><span class="main">,</span> <span class="free">rsl</span><span class="main">)</span> <span class="main">:=</span> Suc <span class="main">(</span>card <span class="main">(</span>rs_commit <span class="free">runz</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">rsl</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> rev_mp<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rs_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>
<span class="comment1">― ‹1 subgoal›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> s<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"card <span class="main">(</span>insert <span class="free">Rb</span> <span class="main">(</span>rs_commit <span class="improper">runz</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="main">(</span>take rs_len <span class="free">nlb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
       <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement proof›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_step1_refines_a0_rs_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0m1a_rs<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1a_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0m1a_rs<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0m1a_rs_defs m1a_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_step2_refines_a0_rs_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0m1a_rs<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1a_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0m1a_rs<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0m1a_rs_defs m1a_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_step3_refines_a0_rs_running<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0m1a_rs<span class="main">}</span> 
     <span class="main">(</span>a0n_running <span class="main">[</span><span class="free">B</span><span class="main">,</span> Sv<span class="main">]</span> <span class="main">(</span><span class="free">Kab</span><span class="main">,</span> <span class="free">A</span><span class="main">,</span> <span class="free">nls</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> 
     <span class="main">(</span>m1a_step3 <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Na</span> <span class="free">nls</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0m1a_rs<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0m1a_rs_defs a0i_defs m1a_defs
         <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_step4_refines_a0_rs_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0m1a_rs<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1a_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span> <span class="free">nla</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0m1a_rs<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0m1a_rs_defs a0i_defs m1a_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_step5_refines_a0_rs_commit<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0m1a_rs <span class="main">∩</span> UNIV <span class="main">×</span> m1a_inv0_fin<span class="main">}</span> 
     <span class="main">(</span>a0n_commit <span class="main">[</span><span class="free">B</span><span class="main">,</span> Sv<span class="main">]</span> <span class="main">(</span><span class="free">Kab</span><span class="main">,</span> <span class="free">A</span><span class="main">,</span> take rs_len <span class="free">nlb</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> 
     <span class="main">(</span>m1a_step5 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">nlb</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0m1a_rs<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0m1a_rs_defs a0i_defs m1a_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_leak_refines_a0_rs_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0m1a_rs<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1a_leak <span class="free">Rs</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0m1a_rs<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0m1a_rs_defs a0i_defs m1a_defs<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All together now...›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_m1a_trans_refines_a0_rs_trans <span class="main">=</span> 
  PO_m1a_step1_refines_a0_rs_skip PO_m1a_step2_refines_a0_rs_skip
  PO_m1a_step3_refines_a0_rs_running PO_m1a_step4_refines_a0_rs_skip
  PO_m1a_step5_refines_a0_rs_commit PO_m1a_leak_refines_a0_rs_skip


<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_refines_init_ra0n <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m1a <span class="main">⊆</span>  R_a0m1a_rs<span class="main">``</span><span class="main">(</span>init a0n<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R_a0m1a_rs_defs a0n_defs m1a_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_refines_trans_ra0n <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0m1a_rs <span class="main">∩</span> a0n_inv1_niagree <span class="main">×</span> m1a_inv0_fin<span class="main">}</span> 
     <span class="main">(</span>trans a0n<span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans m1a<span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0m1a_rs<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1a_def m1a_trans_def a0n_def a0n_trans_def
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_m1a_trans_refines_a0_rs_trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> obs_consistent_med_a0m1a_rs <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"obs_consistent 
     <span class="main">(</span>R_a0m1a_rs <span class="main">∩</span> a0n_inv1_niagree <span class="main">×</span> m1a_inv0_fin<span class="main">)</span> 
     med_a0m1a_rs a0n m1a"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R_a0m1a_rs_def med_a0m1a_rs_def 
                   a0n_def m1a_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement result.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_refines_a0_rs <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"refines <span class="main">(</span>R_a0m1a_rs <span class="main">∩</span> a0n_inv1_niagree <span class="main">×</span> m1a_inv0_fin<span class="main">)</span> med_a0m1a_rs a0n m1a"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Refinement_using_invariants<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> m1a_implements_ra0n<span class="main">:</span> <span class="quoted"><span class="quoted">"implements med_a0m1a_rs a0n m1a"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refinement_soundness<span class="main">)</span> <span class="main">(</span><span class="operator">fast</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv2r (inherited): Responder and server›</span></span>
<span class="comment1">(*invh*************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This is a translation of the agreement property to Level 1. It
follows from the refinement and not needed here but later.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m1a_inv2r_serv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> m1x_state_scheme set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1a_inv2r_serv</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Rb</span> <span class="bound">Kab</span> <span class="bound">nlb</span><span class="main">.</span>
     <span class="bound">B</span> <span class="main">∉</span> bad <span class="main">⟶</span> 
     runs <span class="bound">s</span> <span class="bound">Rb</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> aKey <span class="bound">Kab</span> <span class="main">#</span> <span class="bound">nlb</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound">Rs</span> <span class="bound">Na</span><span class="main">.</span> <span class="bound">Kab</span> <span class="main">=</span> sesK <span class="main">(</span><span class="bound">Rs</span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span>
        runs <span class="bound">s</span> <span class="bound">Rs</span> <span class="main">=</span> Some <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> aNon <span class="bound">Na</span> <span class="main">#</span> take rs_len <span class="bound">nlb</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m1a_inv2r_servI <span class="main">=</span> 
  m1a_inv2r_serv_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m1a_inv2r_servE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> 
  m1a_inv2r_serv_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m1a_inv2r_servD <span class="main">=</span> 
  m1a_inv2r_serv_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> -1<span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_inv2r_serv <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"reach m1a <span class="main">⊆</span> m1a_inv2r_serv"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> INV_from_Refinement_basic <span class="main"><span class="main">[</span></span><span class="operator">OF</span> PO_m1a_refines_a0_rs<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R_a0m1a_rs_def a0n_inv1_niagree_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m1a_inv2r_servI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> x A B Rb Kab nlb a<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="improper">B</span><span class="main">,</span> Sv<span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> x A B Rb Kab nlb a<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">Kab</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="m1_keydist_inrn">
<div class="head">
<h1>Theory m1_keydist_inrn</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Development of Security Protocols by Refinement

  Module:   Key_establish/m1_keydist_iirn.thy (Isabelle/HOL 2016-1)
  ID:       $Id: m1_keydist_inrn.thy 133854 2017-03-20 17:53:50Z csprenge $
  Author:   Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;

  Key distribution protocols
  Level 1, 1st refinement: Abstract server-based key transport protocol with 
  initiator and responder roles. Provides non-injective server authentication 
  to the initiator and responder.

  Copyright (c) 2009-2016 Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Abstract (n/n)-authenticated key transport (L1)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> m1_keydist_inrn <span class="keyword2"><span class="keyword">imports</span></span> <a href="m1_keydist.html">m1_keydist</a> <span class="quoted">"<a href="a0i_agree.html">../Refinement/a0i_agree</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We add authentication for the initiator and responder to the basic
server-based key transport protocol: 
\begin{enumerate}
\item the initiator injectively agrees with the server on the key and some
additional data
\item the responder non-injectively agrees with the server on the key and 
some additional data.
\end{enumerate}
The "additional data" is a parameter of this model.›</span></span>

<span class="keyword1"><span class="command">declare</span></span> option.split <span class="main">[</span><span class="operator">split</span><span class="main">]</span>
<span class="comment1">(* declare option.split_asm [split] *)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹State›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The state type remains the same, but in this model we will record
nonces and timestamps in the run frame.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> m1a_state <span class="main">=</span> <span class="quoted"><span class="quoted">"m1x_state"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> m1a_obs <span class="main">=</span> <span class="quoted"><span class="quoted">"m1x_obs"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'x</span> m1a_pred <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> m1x_pred"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'x</span> m1a_trans <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> m1x_trans"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We need some parameters regarding the list of freshness values
stored by the server. These should be defined in further refinements.›</span></span>

<span class="keyword1"><span class="command">consts</span></span> 
  is_len <span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>   <span class="comment1">― ‹num of agreeing list elements for initiator-server›</span>  
  rs_len <span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>   <span class="comment1">― ‹num of agreeing list elements for responder-server›</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Events›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>         <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">A</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m1x_step1"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1a_step1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'x</span> m1r_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1a_step1</span> <span class="main">≡</span> m1x_step1"</span></span>

<span class="keyword1"><span class="command">definition</span></span>       <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">B</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m1x_step2"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1a_step2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'x</span> m1r_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1a_step2</span> <span class="main">≡</span> m1x_step2"</span></span>

<span class="keyword1"><span class="command">definition</span></span>       <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"Server"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m1x_step3</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1a_step3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> key<span class="main">,</span> atom list<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'x</span> m1r_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1a_step3</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">al</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>
     <span class="comment1">― ‹guards:›</span>
     <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>                 <span class="comment1">― ‹fresh run id›</span>
     <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">=</span> sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span>                 <span class="comment1">― ‹generate session key›</span>

     <span class="comment1">― ‹actions:›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">↦</span> <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">al</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>         <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"A"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m1x_step4</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1a_step4</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> key<span class="main">,</span> atom list<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'x</span> m1a_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1a_step4</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">nla</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
     <span class="comment1">― ‹guards:›</span>
     runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>
     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">∉</span> leak <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">∈</span> azC <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>      <span class="comment1">― ‹authorization guard›</span>

     <span class="comment1">― ‹new guard for non-injective agreement with server on <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>(Kab, B, isl)›</span></span>,›</span>
     <span class="comment1">― ‹where <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>isl = take is_len nla›</span></span>›</span>
     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∉</span> bad <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Rs</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">=</span> sesK <span class="main">(</span><span class="bound">Rs</span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span>
        runs <span class="bound">s</span> <span class="bound">Rs</span> <span class="main">=</span> Some <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> take is_len <span class="free"><span class="bound"><span class="entity">nla</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>

     <span class="comment1">― ‹actions:›</span>
     <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">nla</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span>
  <span class="main">}</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span>         <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">B</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m1x_step5</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1a_step5</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> key<span class="main">,</span> atom list<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'x</span> m1a_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1a_step5</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">nlb</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span> 
     <span class="comment1">― ‹guards:›</span>
     runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span> 
     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">∉</span> leak <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">∈</span> azC <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>         <span class="comment1">― ‹authorization guard›</span>

     <span class="comment1">― ‹guard for non-injective agreement with server on <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>(Kab, A, rsl)›</span></span>›</span>
     <span class="comment1">― ‹where <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>rsl = take rs_len nlb›</span></span>›</span>
     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∉</span> bad <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Rs</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">=</span> sesK <span class="main">(</span><span class="bound">Rs</span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span>
        runs <span class="bound">s</span> <span class="bound">Rs</span> <span class="main">=</span> Some <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> take rs_len <span class="free"><span class="bound"><span class="entity">nlb</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>

     <span class="comment1">― ‹actions:›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">nlb</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by attacker, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m1x_leak</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1a_leak</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> <span class="tfree">'x</span> m1x_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1a_leak</span> <span class="main">=</span> m1x_leak"</span></span> 


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Specification›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m1a_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m1a_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1a_init</span> <span class="main">≡</span> m1x_init"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m1a_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> m1a_trans"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1a_trans</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Ra</span> <span class="bound">Rb</span> <span class="bound">Rs</span> <span class="bound">Kab</span> <span class="bound">nls</span> <span class="bound">nla</span> <span class="bound">nlb</span><span class="main">.</span>
     m1a_step1 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">∪</span>
     m1a_step2 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">∪</span>
     m1a_step3 <span class="bound">Rs</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Kab</span> <span class="bound">nls</span> <span class="main">∪</span>
     m1a_step4 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Kab</span> <span class="bound">nla</span> <span class="main">∪</span>
     m1a_step5 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Kab</span> <span class="bound">nlb</span> <span class="main">∪</span>
     m1a_leak <span class="bound">Rs</span> <span class="main">∪</span>
     Id
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m1a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m1a_state<span class="main">,</span> m1a_obs<span class="main">)</span> spec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1a</span> <span class="main">≡</span> <span class="main">⦇</span>
     init <span class="main">=</span> m1a_init<span class="main">,</span>
     trans <span class="main">=</span> m1a_trans<span class="main">,</span>
     obs <span class="main">=</span> id
  <span class="main">⦈</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> init_m1a<span class="main">:</span> <span class="quoted"><span class="quoted">"init m1a <span class="main">=</span> m1a_init"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1a_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> trans_m1a<span class="main">:</span> <span class="quoted"><span class="quoted">"trans m1a <span class="main">=</span> m1a_trans"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1a_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> obs_m1a <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"obs m1a <span class="main">=</span> id"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1a_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> m1a_loc_defs <span class="main">=</span> 
  m1a_def m1a_init_def m1a_trans_def
  m1a_step1_def m1a_step2_def m1a_step3_def m1a_step4_def m1a_step5_def 
  m1a_leak_def

<span class="keyword1"><span class="command">lemmas</span></span> m1a_defs <span class="main">=</span> m1a_loc_defs m1x_defs


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv0: Finite domain›</span></span>
<span class="comment1">(*inv**************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹There are only finitely many runs. This is needed to establish
the responder/initiator agreement.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m1a_inv0_fin</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> m1r_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1a_inv0_fin</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> finite <span class="main">(</span>dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m1a_inv0_finI <span class="main">=</span> m1a_inv0_fin_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m1a_inv0_finE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m1a_inv0_fin_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m1a_inv0_finD <span class="main">=</span> m1a_inv0_fin_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_inv0_fin_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m1a <span class="main">⊆</span> m1a_inv0_fin"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1a_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m1a_inv0_finI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_inv0_fin_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m1a_inv0_fin<span class="main">}</span> trans m1a <span class="main">{&gt;</span> m1a_inv0_fin<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m1a_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m1a_inv0_finI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_inv0_fin <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m1a <span class="main">⊆</span> m1a_inv0_fin"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_incr<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>m1x›</span></span></span></span>›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Simulation relation›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Define run abstraction.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> 
  <span class="entity">rm1x1a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"role_t <span class="main">⇒</span> atom list <span class="main">⇒</span> atom list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rm1x1a</span> Init <span class="main">=</span> take <span class="main">1</span>"</span></span>         <span class="comment1">― ‹take <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Kab›</span></span> from <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Kab # nla›</span></span>›</span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rm1x1a</span> Resp <span class="main">=</span> take <span class="main">1</span>"</span></span>         <span class="comment1">― ‹take <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Kab›</span></span> from <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Kab # nlb›</span></span>›</span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rm1x1a</span> Serv <span class="main">=</span> take <span class="main">0</span>"</span></span>         <span class="comment1">― ‹drop all from <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>nls›</span></span>›</span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">runs1x1a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"runs_t <span class="main">⇒</span> runs_t"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">runs1x1a</span> <span class="main">≡</span> map_runs rm1x1a"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹med1x1: The mediator function maps a concrete observation to an 
abstract one.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">med1x1a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m1a_obs <span class="main">⇒</span> m1x_obs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med1x1a</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> runs <span class="main">=</span> runs1x1a <span class="main">(</span>runs <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">,</span> leak <span class="main">=</span> leak <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹R1x1a: The simulation relation is defined in terms of the mediator
function.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R1x1a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m1x_state <span class="main">×</span> m1a_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R1x1a</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> med1x1a <span class="bound">t</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> R1x1a_defs <span class="main">=</span> 
  R1x1a_def med1x1a_def 


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement proof›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_step1_refines_m1x_step1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R1x1a<span class="main">}</span> 
     <span class="main">(</span>m1x_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1a_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R1x1a<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R1x1a_defs m1a_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_step2_refines_m1x_step2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R1x1a<span class="main">}</span> 
     <span class="main">(</span>m1x_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1a_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R1x1a<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R1x1a_defs m1a_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_step3_refines_m1x_step3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R1x1a<span class="main">}</span> 
     <span class="main">(</span>m1x_step3 <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1a_step3 <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">nls</span><span class="main">)</span>
   <span class="main">{&gt;</span> R1x1a<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R1x1a_defs m1a_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_step4_refines_m1x_step4<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R1x1a<span class="main">}</span> 
     <span class="main">(</span>m1x_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1a_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">nla</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R1x1a<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R1x1a_defs m1a_defs map_runs_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_step5_refines_m1x_step5<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R1x1a<span class="main">}</span> 
     <span class="main">(</span>m1x_step5 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1a_step5 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">nlb</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R1x1a<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R1x1a_defs m1a_defs map_runs_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_leak_refines_m1x_leak<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R1x1a<span class="main">}</span> 
     <span class="main">(</span>m1x_leak <span class="free">Rs</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1a_leak <span class="free">Rs</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R1x1a<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R1x1a_defs m1a_defs map_runs_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All together now...›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_m1a_trans_refines_m1x_trans <span class="main">=</span> 
  PO_m1a_step1_refines_m1x_step1 PO_m1a_step2_refines_m1x_step2
  PO_m1a_step3_refines_m1x_step3 PO_m1a_step4_refines_m1x_step4
  PO_m1a_step5_refines_m1x_step5 PO_m1a_leak_refines_m1x_leak


<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_refines_init_m1x <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m1a <span class="main">⊆</span>  R1x1a<span class="main">``</span><span class="main">(</span>init m1x<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R1x1a_defs m1a_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_refines_trans_m1x <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R1x1a<span class="main">}</span> 
     <span class="main">(</span>trans m1x<span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans m1a<span class="main">)</span> 
   <span class="main">{&gt;</span> R1x1a<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1a_def m1a_trans_def m1x_def m1x_trans_def
         <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_m1a_trans_refines_m1x_trans<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_m1a_trans_refines_m1x_trans<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Observation consistency.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> obs_consistent_med1x1a <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"obs_consistent R1x1a med1x1a m1x m1a"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R1x1a_def m1a_defs<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement result.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_refines_m1x <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"refines R1x1a med1x1a m1x m1a"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Refinement_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>  m1a_implements_m1x <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"implements med1x1a m1x m1a"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refinement_soundness<span class="main">)</span> <span class="main">(</span><span class="operator">fast</span><span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>a0n›</span></span></span></span> for initiator/server›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For the initiator, we get an non-injective agreement with the server on 
the session key, the responder name, and the atom list <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"isl"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Simulation relation›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define two auxiliary functions to reconstruct the signals of the
initial model from completed initiator and server runs.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  issig <span class="main">=</span> <span class="quoted"><span class="quoted">"key <span class="main">×</span> agent <span class="main">×</span> atom list"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">is_commit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>runs_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> key<span class="main">,</span> atom list<span class="main">]</span> <span class="main">⇒</span> rid_t set"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_commit</span> <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">sl</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">Ra</span><span class="main">.</span> <span class="main">∃</span><span class="bound">nla</span><span class="main">.</span> 
     <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="bound">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">#</span> <span class="bound">nla</span><span class="main">)</span> <span class="main">∧</span> take is_len <span class="bound">nla</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">sl</span></span></span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">is_runs2sigs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"runs_t <span class="main">⇒</span> issig signal <span class="main">⇒</span> nat"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_runs2sigs</span> <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="main">(</span>Running <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Sv<span class="main">]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sl</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
     <span class="main">(</span><span class="keyword1">if</span> <span class="main">∃</span><span class="bound">Rs</span> <span class="bound">nls</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">=</span> sesK <span class="main">(</span><span class="bound">Rs</span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span> 
         <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="bound">Rs</span> <span class="main">=</span> Some <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="bound">nls</span><span class="main">)</span> <span class="main">∧</span> take is_len <span class="bound">nls</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">sl</span></span></span>
      <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">is_runs2sigs</span> <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="main">(</span>Commit <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Sv<span class="main">]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sl</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
     card <span class="main">(</span>is_commit <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">sl</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">is_runs2sigs</span> <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">0</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Simulation relation and mediator function. We map completed initiator 
and responder runs to commit and running signals, respectively.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">med_a0m1a_is</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m1a_obs <span class="main">⇒</span> issig a0i_obs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med_a0m1a_is</span> <span class="free"><span class="bound"><span class="entity">o1</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> signals <span class="main">=</span> is_runs2sigs <span class="main">(</span>runs <span class="free"><span class="bound"><span class="entity">o1</span></span></span><span class="main">)</span><span class="main">,</span> corrupted <span class="main">=</span> <span class="main">{}</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R_a0m1a_is</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>issig a0i_state <span class="main">×</span> m1a_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R_a0m1a_is</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> signals <span class="bound">s</span> <span class="main">=</span> is_runs2sigs <span class="main">(</span>runs <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> corrupted <span class="bound">s</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> R_a0m1a_is_defs <span class="main">=</span> R_a0m1a_is_def med_a0m1a_is_def 


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Lemmas about the auxiliary functions›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_runs2sigs_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">runz</span> <span class="main">=</span> Map.empty <span class="main">⟹</span> is_runs2sigs <span class="free">runz</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span> 
   <span class="main">(</span><span class="operator">rule</span> is_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_commit_finite <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">runz</span><span class="main">)</span> <span class="main">⟹</span> finite <span class="main">(</span>is_commit <span class="free">runz</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">nls</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Update lemmas›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_runs2sigs_upd_init_none <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Ra</span> <span class="main">∉</span> dom <span class="free">runz</span> <span class="main">⟧</span>
  <span class="main">⟹</span> is_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Ra</span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> is_runs2sigs <span class="free">runz</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span> 
   <span class="main">(</span><span class="operator">rule</span> is_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_runs2sigs_upd_resp_none <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Rb</span> <span class="main">∉</span> dom <span class="free">runz</span> <span class="main">⟧</span>
  <span class="main">⟹</span> is_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Rb</span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> is_runs2sigs <span class="free">runz</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span> 
   <span class="main">(</span><span class="operator">rule</span> is_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_runs2sigs_upd_serv <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Rs</span> <span class="main">∉</span> dom <span class="free">runz</span> <span class="main">⟧</span>
  <span class="main">⟹</span> is_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Rs</span> <span class="main">↦</span> <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="free">nls</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
     <span class="main">(</span>is_runs2sigs <span class="free">runz</span><span class="main">)</span><span class="main">(</span>Running <span class="main">[</span><span class="free">A</span><span class="main">,</span> Sv<span class="main">]</span> <span class="main">(</span>sesK <span class="main">(</span><span class="free">Rs</span><span class="main">$</span>sk<span class="main">)</span><span class="main">,</span> <span class="free">B</span><span class="main">,</span> take is_len <span class="free">nls</span><span class="main">)</span> <span class="main">:=</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span> 
   <span class="main">(</span><span class="operator">rule</span> is_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_runs2sigs_upd_init_some <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">runz</span> <span class="free">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">;</span> finite <span class="main">(</span>dom <span class="free">runz</span><span class="main">)</span><span class="main">;</span> 
     <span class="free">ils</span> <span class="main">=</span> take is_len <span class="free">nla</span> <span class="main">⟧</span>
  <span class="main">⟹</span> is_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Ra</span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> aKey <span class="free">Kab</span> <span class="main">#</span> <span class="free">nla</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span>is_runs2sigs <span class="free">runz</span><span class="main">)</span><span class="main">(</span>
        Commit <span class="main">[</span><span class="free">A</span><span class="main">,</span> Sv<span class="main">]</span> <span class="main">(</span><span class="free">Kab</span><span class="main">,</span> <span class="free">B</span><span class="main">,</span> <span class="free">ils</span><span class="main">)</span> <span class="main">:=</span> 
          Suc <span class="main">(</span>card <span class="main">(</span>is_commit <span class="free">runz</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">ils</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> s<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?a0.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">runz</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?a1.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> is_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="comment1">― ‹1 subgoal›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> runz<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> s<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"card <span class="main">(</span>insert <span class="free">Ra</span> <span class="main">(</span>is_commit <span class="improper">runz</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="main">(</span>take is_len <span class="free">nla</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_runs2sigs_upd_resp_some <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">runz</span> <span class="free">Rb</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> is_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Rb</span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> aKey <span class="free">Kab</span> <span class="main">#</span> <span class="free">nlb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
     is_runs2sigs <span class="free">runz</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span>
   <span class="main">(</span><span class="operator">rule</span> is_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>  


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement proof›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_step1_refines_a0_is_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0m1a_is<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1a_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0m1a_is<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0m1a_is_defs m1a_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_step2_refines_a0_is_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0m1a_is<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1a_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0m1a_is<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0m1a_is_defs m1a_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_step3_refines_a0_is_running<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0m1a_is<span class="main">}</span> 
     <span class="main">(</span>a0n_running <span class="main">[</span><span class="free">A</span><span class="main">,</span> Sv<span class="main">]</span> <span class="main">(</span><span class="free">Kab</span><span class="main">,</span> <span class="free">B</span><span class="main">,</span> take is_len <span class="free">nls</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> 
     <span class="main">(</span>m1a_step3 <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">nls</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0m1a_is<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0m1a_is_defs a0i_defs m1a_defs
         <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_step4_refines_a0_is_commit<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0m1a_is <span class="main">∩</span> UNIV <span class="main">×</span> m1a_inv0_fin<span class="main">}</span> 
     <span class="main">(</span>a0n_commit <span class="main">[</span><span class="free">A</span><span class="main">,</span> Sv<span class="main">]</span> <span class="main">(</span><span class="free">Kab</span><span class="main">,</span> <span class="free">B</span><span class="main">,</span> take is_len <span class="free">nla</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> 
     <span class="main">(</span>m1a_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">nla</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0m1a_is<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0m1a_is_defs a0i_defs m1a_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_step5_refines_a0_is_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0m1a_is<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1a_step5 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">nlb</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0m1a_is<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0m1a_is_defs m1a_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_leak_refines_a0_is_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0m1a_is<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1a_leak <span class="free">Rs</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0m1a_is<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0m1a_is_defs m1a_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All together now...›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_m1a_trans_refines_a0_is_trans <span class="main">=</span> 
  PO_m1a_step1_refines_a0_is_skip PO_m1a_step2_refines_a0_is_skip
  PO_m1a_step3_refines_a0_is_running PO_m1a_step4_refines_a0_is_commit
  PO_m1a_step5_refines_a0_is_skip PO_m1a_leak_refines_a0_is_skip
  

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_refines_init_a0_is <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m1a <span class="main">⊆</span>  R_a0m1a_is<span class="main">``</span><span class="main">(</span>init a0n<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R_a0m1a_is_defs a0n_defs m1a_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_refines_trans_a0_is <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0m1a_is <span class="main">∩</span> UNIV <span class="main">×</span> m1a_inv0_fin<span class="main">}</span> 
     <span class="main">(</span>trans a0n<span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans m1a<span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0m1a_is<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1a_def m1a_trans_def a0n_def a0n_trans_def
         <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_m1a_trans_refines_a0_is_trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> obs_consistent_med_a0m1a_is <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"obs_consistent R_a0m1a_is med_a0m1a_is a0n m1a"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R_a0m1a_is_def med_a0m1a_is_def 
                   a0n_def m1a_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement result.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_refines_a0_is <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"refines <span class="main">(</span>R_a0m1a_is <span class="main">∩</span> UNIV <span class="main">×</span> m1a_inv0_fin<span class="main">)</span> med_a0m1a_is a0n m1a"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Refinement_using_invariants<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>  m1a_implements_a0_is<span class="main">:</span> <span class="quoted"><span class="quoted">"implements med_a0m1a_is a0n m1a"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refinement_soundness<span class="main">)</span> <span class="main">(</span><span class="operator">fast</span><span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>a0n›</span></span></span></span> for responder/server›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For the responder, we get a non-injective agreement with the server on 
the session key, the initiator's name, and additional data.›</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Simulation relation›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define two auxiliary functions to reconstruct the signals of the
initial model from completed responder and server runs.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  rssig <span class="main">=</span> <span class="quoted"><span class="quoted">"key <span class="main">×</span> agent <span class="main">×</span> atom list"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">rs_commit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>runs_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> key<span class="main">,</span> atom list<span class="main">]</span> <span class="main">⇒</span> rid_t set"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rs_commit</span> <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">rsl</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">Rb</span><span class="main">.</span> <span class="main">∃</span><span class="bound">nlb</span><span class="main">.</span> 
     <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="bound">Rb</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">#</span> <span class="bound">nlb</span><span class="main">)</span> <span class="main">∧</span> take rs_len <span class="bound">nlb</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">rsl</span></span></span> 
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">rs_runs2sigs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"runs_t <span class="main">⇒</span> rssig signal <span class="main">⇒</span> nat"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rs_runs2sigs</span> <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="main">(</span>Running <span class="main">[</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Sv<span class="main">]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rsl</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
     <span class="main">(</span><span class="keyword1">if</span> <span class="main">∃</span><span class="bound">Rs</span> <span class="bound">nls</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">=</span> sesK <span class="main">(</span><span class="bound">Rs</span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span>
         <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="bound">Rs</span> <span class="main">=</span> Some <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="bound">nls</span><span class="main">)</span> <span class="main">∧</span> take rs_len <span class="bound">nls</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">rsl</span></span></span>
      <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rs_runs2sigs</span> <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="main">(</span>Commit <span class="main">[</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Sv<span class="main">]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rsl</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
     card <span class="main">(</span>rs_commit <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">rsl</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rs_runs2sigs</span> <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">0</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Simulation relation and mediator function. We map completed initiator 
and responder runs to commit and running signals, respectively.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">med_a0m1a_rs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m1a_obs <span class="main">⇒</span> rssig a0n_obs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med_a0m1a_rs</span> <span class="free"><span class="bound"><span class="entity">o1</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> signals <span class="main">=</span> rs_runs2sigs <span class="main">(</span>runs <span class="free"><span class="bound"><span class="entity">o1</span></span></span><span class="main">)</span><span class="main">,</span> corrupted <span class="main">=</span> <span class="main">{}</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R_a0m1a_rs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rssig a0n_state <span class="main">×</span> m1a_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R_a0m1a_rs</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> signals <span class="bound">s</span> <span class="main">=</span> rs_runs2sigs <span class="main">(</span>runs <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> corrupted <span class="bound">s</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> R_a0m1a_rs_defs <span class="main">=</span> R_a0m1a_rs_def med_a0m1a_rs_def 


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Lemmas about the auxiliary functions›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Other lemmas›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rs_runs2sigs_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">runz</span> <span class="main">=</span> Map.empty <span class="main">⟹</span> rs_runs2sigs <span class="free">runz</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span> 
   <span class="main">(</span><span class="operator">rule</span> rs_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rs_commit_finite <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">runz</span><span class="main">)</span> <span class="main">⟹</span> finite <span class="main">(</span>rs_commit <span class="free">runz</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">nls</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Update lemmas›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rs_runs2sigs_upd_init_none <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Ra</span> <span class="main">∉</span> dom <span class="free">runz</span> <span class="main">⟧</span>
  <span class="main">⟹</span> rs_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Ra</span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> rs_runs2sigs <span class="free">runz</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span> 
   <span class="main">(</span><span class="operator">rule</span> rs_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rs_runs2sigs_upd_resp_none <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Rb</span> <span class="main">∉</span> dom <span class="free">runz</span> <span class="main">⟧</span>
  <span class="main">⟹</span> rs_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Rb</span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> rs_runs2sigs <span class="free">runz</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span> 
   <span class="main">(</span><span class="operator">rule</span> rs_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rs_runs2sigs_upd_serv <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Rs</span> <span class="main">∉</span> dom <span class="free">runz</span> <span class="main">⟧</span>
  <span class="main">⟹</span> rs_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Rs</span> <span class="main">↦</span> <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="free">nls</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
     <span class="main">(</span>rs_runs2sigs <span class="free">runz</span><span class="main">)</span><span class="main">(</span>Running <span class="main">[</span><span class="free">B</span><span class="main">,</span> Sv<span class="main">]</span> <span class="main">(</span>sesK <span class="main">(</span><span class="free">Rs</span><span class="main">$</span>sk<span class="main">)</span><span class="main">,</span> <span class="free">A</span><span class="main">,</span> take rs_len <span class="free">nls</span><span class="main">)</span> <span class="main">:=</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span> 
   <span class="main">(</span><span class="operator">rule</span> rs_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rs_runs2sigs_upd_init_some <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">runz</span> <span class="free">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> rs_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Ra</span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> aKey <span class="free">Kab</span> <span class="main">#</span> <span class="free">nl</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
     rs_runs2sigs <span class="free">runz</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span>
   <span class="main">(</span><span class="operator">rule</span> rs_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>  

<span class="keyword1"><span class="command">lemma</span></span> rs_runs2sigs_upd_resp_some <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">runz</span> <span class="free">Rb</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">;</span> finite <span class="main">(</span>dom <span class="free">runz</span><span class="main">)</span><span class="main">;</span>
     <span class="free">rsl</span> <span class="main">=</span> take rs_len <span class="free">nlb</span> <span class="main">⟧</span>
 <span class="main">⟹</span> rs_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Rb</span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> aKey <span class="free">Kab</span> <span class="main">#</span> <span class="free">nlb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span>rs_runs2sigs <span class="free">runz</span><span class="main">)</span><span class="main">(</span>
      Commit <span class="main">[</span><span class="free">B</span><span class="main">,</span> Sv<span class="main">]</span> <span class="main">(</span><span class="free">Kab</span><span class="main">,</span> <span class="free">A</span><span class="main">,</span> <span class="free">rsl</span><span class="main">)</span> <span class="main">:=</span> Suc <span class="main">(</span>card <span class="main">(</span>rs_commit <span class="free">runz</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">rsl</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rs_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>
<span class="comment1">― ‹1 subgoal›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> runz<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> s<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"card <span class="main">(</span>insert <span class="free">Rb</span> <span class="main">(</span>rs_commit <span class="improper">runz</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="main">(</span>take rs_len <span class="free">nlb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
       <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement proof›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_step1_refines_a0_rs_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0m1a_rs<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1a_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0m1a_rs<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0m1a_rs_defs m1a_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_step2_refines_a0_rs_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0m1a_rs<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1a_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0m1a_rs<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0m1a_rs_defs m1a_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_step3_refines_a0_rs_running<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0m1a_rs<span class="main">}</span> 
     <span class="main">(</span>a0n_running <span class="main">[</span><span class="free">B</span><span class="main">,</span> Sv<span class="main">]</span> <span class="main">(</span><span class="free">Kab</span><span class="main">,</span> <span class="free">A</span><span class="main">,</span> take rs_len <span class="free">nls</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> 
     <span class="main">(</span>m1a_step3 <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">nls</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0m1a_rs<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0m1a_rs_defs a0n_defs m1a_defs
         <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_step4_refines_a0_rs_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0m1a_rs<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1a_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">nla</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0m1a_rs<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0m1a_rs_defs m1a_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_step5_refines_a0_rs_commit<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0m1a_rs <span class="main">∩</span> UNIV <span class="main">×</span> m1a_inv0_fin<span class="main">}</span> 
     <span class="main">(</span>a0n_commit <span class="main">[</span><span class="free">B</span><span class="main">,</span> Sv<span class="main">]</span> <span class="main">(</span><span class="free">Kab</span><span class="main">,</span> <span class="free">A</span><span class="main">,</span> take rs_len <span class="free">nlb</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> 
     <span class="main">(</span>m1a_step5 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">nlb</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0m1a_rs<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0m1a_rs_defs a0n_defs m1a_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_leak_refines_a0_rs_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0m1a_rs<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1a_leak <span class="free">Rs</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0m1a_rs<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0m1a_rs_defs a0i_defs m1a_defs<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All together now...›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_m1a_trans_refines_a0_rs_trans <span class="main">=</span> 
  PO_m1a_step1_refines_a0_rs_skip PO_m1a_step2_refines_a0_rs_skip
  PO_m1a_step3_refines_a0_rs_running PO_m1a_step4_refines_a0_rs_skip
  PO_m1a_step5_refines_a0_rs_commit PO_m1a_leak_refines_a0_rs_skip


<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_refines_init_ra0n <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m1a <span class="main">⊆</span>  R_a0m1a_rs<span class="main">``</span><span class="main">(</span>init a0n<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R_a0m1a_rs_defs a0n_defs m1a_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_refines_trans_ra0n <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0m1a_rs <span class="main">∩</span> UNIV <span class="main">×</span> m1a_inv0_fin<span class="main">}</span> 
     <span class="main">(</span>trans a0n<span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans m1a<span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0m1a_rs<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1a_def m1a_trans_def a0n_def a0n_trans_def
         <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_m1a_trans_refines_a0_rs_trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> obs_consistent_med_a0m1a_rs <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"obs_consistent <span class="main">(</span>R_a0m1a_rs <span class="main">∩</span> UNIV <span class="main">×</span> m1a_inv0_fin<span class="main">)</span> med_a0m1a_rs a0n m1a"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R_a0m1a_rs_def med_a0m1a_rs_def 
                   a0n_def m1a_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement result.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1a_refines_a0_rs <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"refines <span class="main">(</span>R_a0m1a_rs <span class="main">∩</span> UNIV <span class="main">×</span> m1a_inv0_fin<span class="main">)</span> med_a0m1a_rs a0n m1a"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Refinement_using_invariants<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>  m1a_implements_ra0n<span class="main">:</span> <span class="quoted"><span class="quoted">"implements med_a0m1a_rs a0n m1a"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refinement_soundness<span class="main">)</span> <span class="main">(</span><span class="operator">fast</span><span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="m1_kerberos">
<div class="head">
<h1>Theory m1_kerberos</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Development of Security Protocols by Refinement

  Module:   Key_establish/m1_kerberos.thy (Isabelle/HOL 2016)
  ID:       $Id: m1_kerberos.thy 133856 2017-03-20 18:05:54Z csprenge $
  Author:   Ivano Somaini, ETH Zurich &lt;somainii@student.ethz.ch&gt;
            Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;

  Key distribution protocols
  Abstract version of Kerberos protocol with server-authentication and
  mutual initiator and responder authentication.

  Copyright (c) 2009-2016 Ivano Somaini, Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Abstract Kerberos core protocol (L1)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> m1_kerberos <span class="keyword2"><span class="keyword">imports</span></span> <a href="m1_keydist_iirn.html">m1_keydist_iirn</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We augment the basic abstract key distribution model such that 
the server sends a timestamp along with the session key. We use a cache to 
guard against replay attacks and timestamp validity checks to ensure recentness
of the session key. 

We establish three refinements for this model, namely that this model refines
\begin{enumerate}
\item the authenticated key distribution model <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>m1_keydist_iirn›</span></span></span></span>, 

\item the injective agreement model <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>a0i›</span></span></span></span>, instantiated such that 
the responder agrees with the initiator on the session key, its timestamp
and the initiator's authenticator timestamp.

\item the injective agreement model <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>a0i›</span></span></span></span>, instantiated such that 
the initiator agrees with the responder on the session key, its timestamp
and the initiator's authenticator timestamp.
\end{enumerate}
›</span></span>

<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹State›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We extend the basic key distribution by adding timestamps. 
We add a clock variable modeling the current time and an authenticator
replay cache recording triples <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">A</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">Kab</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">Ta</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of agents, session keys,
and authenticator timestamps. The inclusion of the session key avoids false
replay rejections for different keys with identical authenticator timestamps.

The frames, runs, and observations remain the same as in the previous model, 
but we will use the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"nat list"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>'s to store timestamps. 
›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  time <span class="main">=</span> <span class="quoted"><span class="quoted">"nat"</span></span>                     <span class="comment1">― ‹for clock and timestamps›</span>

<span class="keyword1"><span class="command">consts</span></span>
  Ls <span class="main">::</span> <span class="quoted"><span class="quoted">"time"</span></span>                     <span class="comment1">― ‹life time for session keys›</span>
  La <span class="main">::</span> <span class="quoted"><span class="quoted">"time"</span></span>                     <span class="comment1">― ‹life time for authenticators›</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹State and observations›</span></span>

<span class="keyword1"><span class="command">record</span></span>
  m1_state <span class="main">=</span> <span class="quoted"><span class="quoted">"m1r_state"</span></span> <span class="main">+</span>
    leak <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>key <span class="main">×</span> agent <span class="main">×</span> agent <span class="main">×</span> nonce <span class="main">×</span> time<span class="main">)</span> set"</span></span>   <span class="comment1">― ‹key leaked plus context›</span>
    clk <span class="main">::</span> <span class="quoted"><span class="quoted">"time"</span></span> 
    cache <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>agent <span class="main">×</span> key <span class="main">×</span> time<span class="main">)</span> set"</span></span> 

<span class="keyword1"><span class="command">type_synonym</span></span> m1_obs <span class="main">=</span> <span class="quoted"><span class="quoted">"m1_state"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'x</span> m1_pred <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> m1_state_scheme set"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'x</span> m1_trans <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'x</span> m1_state_scheme <span class="main">×</span> <span class="tfree">'x</span> m1_state_scheme<span class="main">)</span> set"</span></span>

<span class="keyword1"><span class="command">consts</span></span>
  END <span class="main">::</span> <span class="quoted"><span class="quoted">"atom"</span></span>                    <span class="comment1">― ‹run end marker (for initiator)›</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Events›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>         <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">A</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m1x_step1"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1_step1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'x</span> m1_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_step1</span> <span class="main">≡</span> m1a_step1"</span></span>

<span class="keyword1"><span class="command">definition</span></span>       <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">B</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m1x_step2"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1_step2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'x</span> m1_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_step2</span> <span class="main">≡</span> m1a_step2"</span></span>

<span class="keyword1"><span class="command">definition</span></span>       <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"Server"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m1x_step3</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1_step3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> key<span class="main">,</span> nonce<span class="main">,</span> time<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'x</span> m1_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_step3</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
     <span class="comment1">― ‹new guards:›</span>
     <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">=</span> clk <span class="bound">s</span> <span class="main">∧</span>                      <span class="comment1">― ‹fresh timestamp›</span>

     <span class="comment1">― ‹rest as before:›</span>
     <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> m1a_step3 <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">[</span>aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">]</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>         <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"A"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m1x_step5</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1_step4</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> key<span class="main">,</span> time<span class="main">,</span> time<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'x</span> m1_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_step4</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
     <span class="comment1">― ‹previous guards:›</span>
     runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>
     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">∉</span> Domain <span class="main">(</span>leak <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">∈</span> azC <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>   <span class="comment1">― ‹authorization guard›</span>
     <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>na <span class="main">∧</span>                                     <span class="comment1">― ‹fix parameter›</span>

     <span class="comment1">― ‹guard for agreement with server on <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>(Kab, B, Na, isl)›</span></span>,›</span>
     <span class="comment1">― ‹where <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>isl = take is_len nla›</span></span>; injectiveness by including <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Na›</span></span>›</span>
     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∉</span> bad <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Rs</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">=</span> sesK <span class="main">(</span><span class="bound">Rs</span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span>
        runs <span class="bound">s</span> <span class="bound">Rs</span> <span class="main">=</span> Some <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>

     <span class="comment1">― ‹new guards:›</span>
     <span class="free"><span class="bound"><span class="entity">Ta</span></span></span> <span class="main">=</span> clk <span class="bound">s</span> <span class="main">∧</span>                     <span class="comment1">― ‹fresh timestamp›</span>
     clk <span class="bound">s</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">+</span> Ls <span class="main">∧</span>                <span class="comment1">― ‹ensure session key recentness›</span>

     <span class="comment1">― ‹actions:›</span>
     <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>         <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">B</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m1x_step4</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1_step5</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> key<span class="main">,</span> time<span class="main">,</span> time<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'x</span> m1_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_step5</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span> 
     <span class="comment1">― ‹previous guards:›</span>
     runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span> 
     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">∉</span> Domain <span class="main">(</span>leak <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">∈</span> azC <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>  <span class="comment1">― ‹authorization guard›</span>

     <span class="comment1">― ‹guard for showing agreement with server on <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>(Kab, A, rsl)›</span></span>,›</span>
     <span class="comment1">― ‹where <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>rsl = take rs_len nlb›</span></span>; this agreement is non-injective›</span>
     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∉</span> bad <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Rs</span> <span class="bound">Na</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">=</span> sesK <span class="main">(</span><span class="bound">Rs</span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span>
        runs <span class="bound">s</span> <span class="bound">Rs</span> <span class="main">=</span> Some <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="bound">Na</span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>

     <span class="comment1">― ‹new guards:›</span>
     <span class="comment1">― ‹guard for showing agreement with initiator <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>A›</span></span> on <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>(Kab, Ts, Ta)›</span></span>›</span>
     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∉</span> bad <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∉</span> bad <span class="main">⟶</span> 
       <span class="main">(</span><span class="main">∃</span><span class="bound">Ra</span> <span class="bound">nl</span><span class="main">.</span> runs <span class="bound">s</span> <span class="bound">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">#</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">#</span> aNum <span class="free"><span class="bound"><span class="entity">Ta</span></span></span> <span class="main">#</span> <span class="bound">nl</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>

     <span class="comment1">― ‹ensure recentness of session key›</span>
     clk <span class="bound">s</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">+</span> Ls <span class="main">∧</span>

     <span class="comment1">― ‹check validity of authenticator and prevent its replay›</span>
     <span class="comment1">― ‹'replays' with fresh authenticator ok!›</span>
     clk <span class="bound">s</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span> <span class="main">+</span> La <span class="main">∧</span> 
     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">)</span> <span class="main">∉</span> cache <span class="bound">s</span> <span class="main">∧</span> 

     <span class="comment1">― ‹actions:›</span>
     <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
       runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
       cache <span class="main">:=</span> insert <span class="main">(</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">)</span> <span class="main">(</span>cache <span class="bound">s</span><span class="main">)</span> 
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>         <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">A</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">skip</span></span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1_step6</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> key<span class="main">,</span> time<span class="main">,</span> time<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'x</span> m1_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_step6</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
     runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span>  <span class="comment1">― ‹key recv'd before›</span>
     <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>na <span class="main">∧</span>                                                     <span class="comment1">― ‹fix parameter›</span>

     <span class="comment1">― ‹check key's freshness [NEW]›</span>
     <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>clk s &lt; Ts + Ls ∧›</span></span>›</span>

     <span class="comment1">― ‹guard for showing agreement with <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>B›</span></span> on <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Kab›</span></span>, <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Ts›</span></span>, and <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Ta›</span></span>›</span>
     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∉</span> bad <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∉</span> bad <span class="main">⟶</span> 
       <span class="main">(</span><span class="main">∃</span><span class="bound">Rb</span><span class="main">.</span> runs <span class="bound">s</span> <span class="bound">Rb</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> 

     <span class="comment1">― ‹actions: (redundant) update local state marks successful termination›</span>
     <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
       runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">,</span> END<span class="main">]</span><span class="main">)</span><span class="main">)</span> 
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>         <span class="comment1">― ‹by attacker, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m1a_leak</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1_leak</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> time<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'x</span> m1_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_leak</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span> 
    <span class="main">(</span>clk <span class="bound">s</span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">+</span> Ls<span class="main">)</span> <span class="main">∧</span>             <span class="comment1">― ‹only compromise 'old' session keys›</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="comment1">― ‹record session key as leaked;›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> leak <span class="main">:=</span> insert <span class="main">(</span>sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">)</span> <span class="main">(</span>leak <span class="bound">s</span><span class="main">)</span> <span class="main">⦈</span> 
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Clock tick event›</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">skip</span></span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1_tick</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"time <span class="main">⇒</span> <span class="tfree">'x</span> m1_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_tick</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
     <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> clk <span class="main">:=</span> clk <span class="bound">s</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">⦈</span> 
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Purge event: purge cache of expired timestamps›</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">skip</span></span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1_purge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent <span class="main">⇒</span> <span class="tfree">'x</span> m1_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_purge</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
     <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> 
       cache <span class="main">:=</span> cache <span class="bound">s</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">K</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span> <span class="main">|</span> <span class="bound">A</span> <span class="bound">K</span> <span class="bound">T</span><span class="main">.</span> 
         <span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">K</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span> <span class="main">∈</span> cache <span class="bound">s</span> <span class="main">∧</span> <span class="bound">T</span> <span class="main">+</span> La <span class="main">≤</span> clk <span class="bound">s</span>
       <span class="main">}</span> 
     <span class="main">⦈</span> 
  <span class="main">}</span>"</span></span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Specification›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m1_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m1_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_init</span> <span class="main">≡</span> <span class="main">{</span> <span class="main">⦇</span> runs <span class="main">=</span> Map.empty<span class="main">,</span> leak <span class="main">=</span> corrKey <span class="main">×</span> <span class="main">{</span>undefined<span class="main">}</span><span class="main">,</span> clk <span class="main">=</span> <span class="main">0</span><span class="main">,</span> cache <span class="main">=</span> <span class="main">{}</span> <span class="main">⦈</span> <span class="main">}</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m1_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> m1_trans"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_trans</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Ra</span> <span class="bound">Rb</span> <span class="bound">Rs</span> <span class="bound">Na</span> <span class="bound">Kab</span> <span class="bound">Ts</span> <span class="bound">Ta</span> <span class="bound">T</span><span class="main">.</span>
        m1_step1 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="main">∪</span>
        m1_step2 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">∪</span>
        m1_step3 <span class="bound">Rs</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Kab</span> <span class="bound">Na</span> <span class="bound">Ts</span> <span class="main">∪</span>
        m1_step4 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Kab</span> <span class="bound">Ts</span> <span class="bound">Ta</span> <span class="main">∪</span>
        m1_step5 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Kab</span> <span class="bound">Ts</span> <span class="bound">Ta</span> <span class="main">∪</span>
        m1_step6 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Kab</span> <span class="bound">Ts</span> <span class="bound">Ta</span> <span class="main">∪</span> 
        m1_leak <span class="bound">Rs</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Ts</span> <span class="main">∪</span>
        m1_tick <span class="bound">T</span> <span class="main">∪</span>
        m1_purge <span class="bound">A</span> <span class="main">∪</span> 
        Id
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m1_state<span class="main">,</span> m1_obs<span class="main">)</span> spec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="main">≡</span> <span class="main">⦇</span>
      init <span class="main">=</span> m1_init<span class="main">,</span>
      trans <span class="main">=</span> m1_trans<span class="main">,</span>
      obs <span class="main">=</span> id
  <span class="main">⦈</span>"</span></span> 

<span class="keyword1"><span class="command">lemmas</span></span> m1_loc_defs <span class="main">=</span> 
  m1_def m1_init_def m1_trans_def
  m1_step1_def m1_step2_def m1_step3_def m1_step4_def m1_step5_def 
  m1_step6_def m1_leak_def m1_purge_def m1_tick_def

<span class="keyword1"><span class="command">lemmas</span></span> m1_defs <span class="main">=</span> m1_loc_defs m1a_defs

<span class="keyword1"><span class="command">lemma</span></span> m1_obs_id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"obs m1 <span class="main">=</span> id"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1_def<span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv0: Finite domain›</span></span>
<span class="comment1">(*inv**************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹There are only finitely many runs. This is needed to establish
the responder/initiator agreement.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m1_inv0_fin</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> m1_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_inv0_fin</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> finite <span class="main">(</span>dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m1_inv0_finI <span class="main">=</span> m1_inv0_fin_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m1_inv0_finE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m1_inv0_fin_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m1_inv0_finD <span class="main">=</span> m1_inv0_fin_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proofs.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_inv0_fin_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m1 <span class="main">⊆</span> m1_inv0_fin"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m1_inv0_finI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_inv0_fin_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m1_inv0_fin<span class="main">}</span> trans m1 <span class="main">{&gt;</span> m1_inv0_fin<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m1_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m1_inv0_finI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_inv0_fin <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m1 <span class="main">⊆</span> m1_inv0_fin"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_incr<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv1: Caching invariant for responder›</span></span>
<span class="comment1">(*inv**************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m1_inv1r_cache</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> m1_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_inv1r_cache</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Kab</span> <span class="bound">Ts</span> <span class="bound">Ta</span> <span class="bound">nl</span><span class="main">.</span>
     runs <span class="bound">s</span> <span class="bound">Rb</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> aKey <span class="bound">Kab</span> <span class="main">#</span> aNum <span class="bound">Ts</span> <span class="main">#</span> aNum <span class="bound">Ta</span> <span class="main">#</span> <span class="bound">nl</span><span class="main">)</span> <span class="main">⟶</span> 
     clk <span class="bound">s</span> <span class="main">&lt;</span> <span class="bound">Ta</span> <span class="main">+</span> La <span class="main">⟶</span>
       <span class="main">(</span><span class="bound">B</span><span class="main">,</span> <span class="bound">Kab</span><span class="main">,</span> <span class="bound">Ta</span><span class="main">)</span> <span class="main">∈</span> cache <span class="bound">s</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m1_inv1r_cacheI <span class="main">=</span> m1_inv1r_cache_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m1_inv1r_cacheE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m1_inv1r_cache_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m1_inv1r_cacheD <span class="main">=</span> m1_inv1r_cache_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_inv1r_cache_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m1 <span class="main">⊆</span> m1_inv1r_cache"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m1_inv1r_cacheI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_inv1r_cache_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m1_inv1r_cache<span class="main">}</span> trans m1 <span class="main">{&gt;</span> m1_inv1r_cache<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m1_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m1_inv1r_cacheI
            <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m1_inv1r_cacheD<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m1_inv1r_cacheD<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_inv1r_cache <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m1 <span class="main">⊆</span> m1_inv1r_cache"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>m1a›</span></span></span></span>›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Simulation relation›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The abstraction removes all but the first freshness
identifiers (corresponding to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Kab›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Ts›</span></span></span></span>) from the 
initiator and responder frames and leaves the server's freshness ids untouched.
›</span></span>

<span class="keyword1"><span class="command">overloading</span></span> is_len' <span class="main">≡</span> <span class="quoted"><span class="quoted">"is_len"</span></span> rs_len' <span class="main">≡</span> <span class="quoted"><span class="quoted">"rs_len"</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> is_len_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">is_len'</span> <span class="main">≡</span> <span class="main">1</span><span class="main">::</span>nat"</span></span>
<span class="keyword1"><span class="command">definition</span></span> rs_len_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rs_len'</span> <span class="main">≡</span> <span class="main">1</span><span class="main">::</span>nat"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">fun</span></span> 
  <span class="entity">rm1a1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"role_t <span class="main">⇒</span> atom list <span class="main">⇒</span> atom list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rm1a1</span> Init <span class="main">=</span> take <span class="main">(</span>Suc is_len<span class="main">)</span>"</span></span>       <span class="comment1">― ‹take <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Kab›</span></span>, <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Ts›</span></span>; drop <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Ta›</span></span>›</span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rm1a1</span> Resp <span class="main">=</span> take <span class="main">(</span>Suc rs_len<span class="main">)</span>"</span></span>       <span class="comment1">― ‹take <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Kab›</span></span>, <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Ts›</span></span>; drop <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Ta›</span></span>›</span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rm1a1</span> Serv <span class="main">=</span> id"</span></span>                      <span class="comment1">― ‹take <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Na›</span></span>, <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Ts›</span></span>›</span>

<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="entity">runs1a1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"runs_t <span class="main">⇒</span> runs_t"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">runs1a1</span> <span class="main">≡</span> map_runs rm1a1"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> knC_runs1a1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"knC <span class="main">(</span>runs1a1 <span class="free">runz</span><span class="main">)</span> <span class="main">=</span> knC <span class="free">runz</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_runs_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> knC.cases<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> b<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">b</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> b<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">b</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> knC_init<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_runs_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> knC_resp<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_runs_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> knC_serv<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_runs_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹med1a1: The mediator function maps a concrete observation (i.e., run) 
to an abstract one.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹R1a1: The simulation relation is defined in terms of the mediator
function.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">med1a1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m1_obs <span class="main">⇒</span> m1a_obs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med1a1</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> runs <span class="main">=</span> runs1a1 <span class="main">(</span>runs <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">,</span> m1x_state.leak <span class="main">=</span> Domain <span class="main">(</span>leak <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">⦈</span>"</span></span>
   
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R1a1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m1a_state <span class="main">×</span> m1_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R1a1</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> med1a1 <span class="bound">t</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> R1a1_defs <span class="main">=</span> R1a1_def med1a1_def 


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement proof›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step1_refines_m1a_step1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R1a1<span class="main">}</span> 
     <span class="main">(</span>m1a_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R1a1<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R1a1_defs m1_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step2_refines_m1a_step2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R1a1<span class="main">}</span> 
     <span class="main">(</span>m1a_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R1a1<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R1a1_defs m1_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step3_refines_m1a_step3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R1a1<span class="main">}</span> 
     <span class="main">(</span>m1a_step3 <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Na</span> <span class="main">[</span>aNum <span class="free">Ts</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1_step3 <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Na</span> <span class="free">Ts</span><span class="main">)</span>
   <span class="main">{&gt;</span> R1a1<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R1a1_defs m1_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step4_refines_m1a_step4<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R1a1<span class="main">}</span> 
     <span class="main">(</span>m1a_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span> <span class="main">[</span>aNum <span class="free">Ts</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R1a1<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R1a1_defs m1_defs map_runs_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step5_refines_m1a_step5<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R1a1<span class="main">}</span> 
     <span class="main">(</span>m1a_step5 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="main">[</span>aNum <span class="free">Ts</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1_step5 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R1a1<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R1a1_defs m1_defs map_runs_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step6_refines_m1a_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R1a1<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1_step6 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span>
   <span class="main">{&gt;</span> R1a1<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R1a1_defs m1_defs map_runs_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_leak_refines_m1a_leak<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R1a1<span class="main">}</span> 
     <span class="main">(</span>m1a_leak <span class="free">Rs</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1_leak <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Ts</span><span class="main">)</span>
   <span class="main">{&gt;</span> R1a1<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R1a1_defs m1_defs map_runs_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_tick_refines_m1a_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R1a1<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1_tick <span class="free">T</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R1a1<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R1a1_defs m1_defs map_runs_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_purge_refines_m1a_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R1a1<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1_purge <span class="free">A</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R1a1<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R1a1_defs m1_defs map_runs_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All together now...›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_m1_trans_refines_m1a_trans <span class="main">=</span> 
  PO_m1_step1_refines_m1a_step1 PO_m1_step2_refines_m1a_step2
  PO_m1_step3_refines_m1a_step3 PO_m1_step4_refines_m1a_step4
  PO_m1_step5_refines_m1a_step5 PO_m1_step6_refines_m1a_skip 
  PO_m1_leak_refines_m1a_leak PO_m1_tick_refines_m1a_skip 
  PO_m1_purge_refines_m1a_skip

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_refines_init_m1a <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m1 <span class="main">⊆</span>  R1a1<span class="main">``</span><span class="main">(</span>init m1a<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R1a1_defs m1_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> s0g_secrecyI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_refines_trans_m1a <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R1a1<span class="main">}</span> 
     <span class="main">(</span>trans m1a<span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans m1<span class="main">)</span> 
   <span class="main">{&gt;</span> R1a1<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1_def m1_trans_def m1a_def m1a_trans_def
         <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_m1_trans_refines_m1a_trans<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_m1_trans_refines_m1a_trans<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Observation consistency.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> obs_consistent_med1a1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"obs_consistent R1a1 med1a1 m1a m1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R1a1_def m1a_def m1_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement result.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_refines_m1a <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"refines R1a1 med1a1 m1a m1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Refinement_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>  m1_implements_m1a <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"implements med1a1 m1a m1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refinement_soundness<span class="main">)</span> <span class="main">(</span><span class="operator">fast</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv (inherited): Secrecy›</span></span>
<span class="comment1">(*invh*************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Secrecy, as external and internal invariant›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m1_secrecy</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> m1_pred"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_secrecy</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> knC <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">⊆</span> azC <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∪</span> Domain <span class="main">(</span>leak <span class="bound">s</span><span class="main">)</span> <span class="main">×</span> UNIV<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m1_secrecyI <span class="main">=</span> m1_secrecy_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m1_secrecyE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m1_secrecy_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_obs_secrecy <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach m1 <span class="main">⊆</span> m1_secrecy"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> Q<span class="main"><span class="main">=</span></span><span class="quoted">m1x_secrecy</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> external_invariant_translation<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> med1a1_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m1_secrecyI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_secrecy <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m1 <span class="main">⊆</span> m1_secrecy"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> external_to_internal_invariant<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv (inherited): Responder auth server.›</span></span>
<span class="comment1">(*invh*************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m1_inv2r_serv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> m1r_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_inv2r_serv</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Rb</span> <span class="bound">Kab</span> <span class="bound">Ts</span> <span class="bound">nlb</span><span class="main">.</span>
     <span class="bound">B</span> <span class="main">∉</span> bad <span class="main">⟶</span> 
     runs <span class="bound">s</span> <span class="bound">Rb</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> aKey <span class="bound">Kab</span> <span class="main">#</span> aNum <span class="bound">Ts</span> <span class="main">#</span> <span class="bound">nlb</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound">Rs</span> <span class="bound">Na</span><span class="main">.</span> <span class="bound">Kab</span> <span class="main">=</span> sesK <span class="main">(</span><span class="bound">Rs</span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span> 
          runs <span class="bound">s</span> <span class="bound">Rs</span> <span class="main">=</span> Some <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="bound">Na</span><span class="main">,</span> aNum <span class="bound">Ts</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m1_inv2r_servI <span class="main">=</span> m1_inv2r_serv_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m1_inv2r_servE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m1_inv2r_serv_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m1_inv2r_servD <span class="main">=</span> m1_inv2r_serv_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> -1<span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Proof of invariance.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_inv2r_serv <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m1 <span class="main">⊆</span> m1_inv2r_serv"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> Sa<span class="main"><span class="main">=</span></span><span class="quoted">m1a</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Pa<span class="main"><span class="main">=</span></span><span class="quoted">m1a_inv2r_serv</span> 
       <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Qa<span class="main"><span class="main">=</span></span><span class="quoted">m1a_inv2r_serv</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Q<span class="main"><span class="main">=</span></span><span class="quoted">m1_inv2r_serv</span> 
       <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> internal_invariant_translation<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>
<span class="comment1">― ‹1 subgoal›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vimage_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m1_inv2r_servI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1a_inv2r_serv_def med1a1_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> x A B Rb Kab Ts nlb<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">A</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">B</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Rb</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Kab</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span>aNum <span class="improper">Ts</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_runs_def<span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv (inherited): Initiator auth server.›</span></span>
<span class="comment1">(*invh*************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Simplified version of invariant <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>m1a_inv2i_serv›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m1_inv2i_serv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> m1r_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_inv2i_serv</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Ra</span> <span class="bound">Kab</span> <span class="bound">Ts</span> <span class="bound">nla</span><span class="main">.</span>
     <span class="bound">A</span> <span class="main">∉</span> bad <span class="main">⟶</span> 
     runs <span class="bound">s</span> <span class="bound">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> aKey <span class="bound">Kab</span> <span class="main">#</span> aNum <span class="bound">Ts</span> <span class="main">#</span> <span class="bound">nla</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound">Rs</span><span class="main">.</span> <span class="bound">Kab</span> <span class="main">=</span> sesK <span class="main">(</span><span class="bound">Rs</span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span>
         runs <span class="bound">s</span> <span class="bound">Rs</span> <span class="main">=</span> Some <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span>  <span class="main">[</span>aNon <span class="main">(</span><span class="bound">Ra</span><span class="main">$</span>na<span class="main">)</span><span class="main">,</span> aNum <span class="bound">Ts</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m1_inv2i_servI <span class="main">=</span> m1_inv2i_serv_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m1_inv2i_servE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m1_inv2i_serv_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m1_inv2i_servD <span class="main">=</span> m1_inv2i_serv_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> -1<span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Proof of invariance.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_inv2i_serv <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m1 <span class="main">⊆</span> m1_inv2i_serv"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> Pa<span class="main"><span class="main">=</span></span><span class="quoted">m1a_inv2i_serv</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Qa<span class="main"><span class="main">=</span></span><span class="quoted">m1a_inv2i_serv</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Q<span class="main"><span class="main">=</span></span><span class="quoted">m1_inv2i_serv</span>
       <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> internal_invariant_translation<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>
<span class="comment1">― ‹1 subgoal›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1a_inv2i_serv_def med1a1_def vimage_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m1_inv2i_servI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> x A B Ra Kab Ts nla<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">A</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">B</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Ra</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Kab</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span>aNum <span class="improper">Ts</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_runs_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">declare</span></span> PO_m1_inv2i_serv <span class="main">[</span><span class="operator">THEN</span> subsetD<span class="main">,</span> <span class="operator">intro</span><span class="main">]</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv (inherited): Initiator key freshness›</span></span>
<span class="comment1">(*invh*************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m1_inv1_ifresh</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> m1_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_inv1_ifresh</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="bound">A'</span> <span class="bound">B</span> <span class="bound">B'</span> <span class="bound">Ra</span> <span class="bound">Ra'</span> <span class="bound">Kab</span> <span class="bound">nl</span> <span class="bound">nl'</span><span class="main">.</span>
     runs <span class="bound">s</span> <span class="bound">Ra</span>  <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span>  <span class="bound">B</span><span class="main">]</span><span class="main">,</span>  aKey <span class="bound">Kab</span> <span class="main">#</span> <span class="bound">nl</span><span class="main">)</span> <span class="main">⟶</span>
     runs <span class="bound">s</span> <span class="bound">Ra'</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="bound">A'</span><span class="main">,</span> <span class="bound">B'</span><span class="main">]</span><span class="main">,</span> aKey <span class="bound">Kab</span> <span class="main">#</span> <span class="bound">nl'</span><span class="main">)</span> <span class="main">⟶</span>
     <span class="bound">A</span> <span class="main">∉</span> bad <span class="main">⟶</span> <span class="bound">B</span> <span class="main">∉</span> bad <span class="main">⟶</span> <span class="bound">Kab</span> <span class="main">∉</span> Domain <span class="main">(</span>leak <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="bound">Ra</span> <span class="main">=</span> <span class="bound">Ra'</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m1_inv1_ifreshI <span class="main">=</span> m1_inv1_ifresh_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m1_inv1_ifreshE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m1_inv1_ifresh_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m1_inv1_ifreshD <span class="main">=</span> m1_inv1_ifresh_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_ifresh <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m1 <span class="main">⊆</span> m1_inv1_ifresh"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> Pa<span class="main"><span class="main">=</span></span><span class="quoted">m1a_inv1_ifresh</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Qa<span class="main"><span class="main">=</span></span><span class="quoted">m1a_inv1_ifresh</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Q<span class="main"><span class="main">=</span></span><span class="quoted">m1_inv1_ifresh</span>
       <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> internal_invariant_translation<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> med1a1_def map_runs_def vimage_def m1_inv1_ifresh_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>a0i›</span></span></span></span> for responder/initiator›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The responder injectively agrees with the initiator on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Kab</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Ts</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Ta</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Simulation relation›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define two auxiliary functions to reconstruct the signals of the
initial model from completed initiator and responder runs.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  risig <span class="main">=</span> <span class="quoted"><span class="quoted">"key <span class="main">×</span> time <span class="main">×</span> time"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">ri_running</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>runs_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> key<span class="main">,</span> time<span class="main">,</span> time<span class="main">]</span> <span class="main">⇒</span> rid_t set"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ri_running</span> <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">Ra</span><span class="main">.</span> <span class="main">∃</span><span class="bound">nl</span><span class="main">.</span> 
     <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="bound">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">#</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">#</span> aNum <span class="free"><span class="bound"><span class="entity">Ta</span></span></span> <span class="main">#</span> <span class="bound">nl</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">ri_commit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>runs_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> key<span class="main">,</span> time<span class="main">,</span> time<span class="main">]</span> <span class="main">⇒</span> rid_t set"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ri_commit</span> <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">Rb</span><span class="main">.</span> <span class="main">∃</span><span class="bound">nl</span><span class="main">.</span> 
     <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="bound">Rb</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">#</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">#</span> aNum <span class="free"><span class="bound"><span class="entity">Ta</span></span></span> <span class="main">#</span> <span class="bound">nl</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">ri_runs2sigs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"runs_t <span class="main">⇒</span> risig signal <span class="main">⇒</span> nat"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ri_runs2sigs</span> <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="main">(</span>Running <span class="main">[</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
     card <span class="main">(</span>ri_running <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ri_runs2sigs</span> <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="main">(</span>Commit <span class="main">[</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
     card <span class="main">(</span>ri_commit <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ri_runs2sigs</span> <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">0</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Simulation relation and mediator function. We map completed initiator 
and responder runs to commit and running signals, respectively.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">med_a0iim1_ri</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m1_obs <span class="main">⇒</span> risig a0i_obs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med_a0iim1_ri</span> <span class="free"><span class="bound"><span class="entity">o1</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> signals <span class="main">=</span> ri_runs2sigs <span class="main">(</span>runs <span class="free"><span class="bound"><span class="entity">o1</span></span></span><span class="main">)</span><span class="main">,</span> corrupted <span class="main">=</span> <span class="main">{}</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R_a0iim1_ri</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>risig a0i_state <span class="main">×</span> m1_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R_a0iim1_ri</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> signals <span class="bound">s</span> <span class="main">=</span> ri_runs2sigs <span class="main">(</span>runs <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> corrupted <span class="bound">s</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> R_a0iim1_ri_defs <span class="main">=</span> R_a0iim1_ri_def med_a0iim1_ri_def 


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Lemmas about the auxiliary functions›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Other lemmas›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ri_runs2sigs_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">runz</span> <span class="main">=</span> Map.empty <span class="main">⟹</span> ri_runs2sigs <span class="free">runz</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span> 
   <span class="main">(</span><span class="operator">rule</span> ri_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> finite_ri_running <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">runz</span><span class="main">)</span> <span class="main">⟹</span> finite <span class="main">(</span>ri_running <span class="free">runz</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_ri_commit <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">runz</span><span class="main">)</span> <span class="main">⟹</span> finite <span class="main">(</span>ri_commit <span class="free">runz</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Update lemmas›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ri_runs2sigs_upd_init_none <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Na</span> <span class="main">∉</span> dom <span class="free">runz</span> <span class="main">⟧</span>
  <span class="main">⟹</span> ri_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Na</span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ri_runs2sigs <span class="free">runz</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ri_runs2sigs.induct<span class="main">)</span> 
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ri_runs2sigs_upd_resp_none <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Rb</span> <span class="main">∉</span> dom <span class="free">runz</span> <span class="main">⟧</span>
  <span class="main">⟹</span> ri_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Rb</span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ri_runs2sigs <span class="free">runz</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ri_runs2sigs.induct<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ri_runs2sigs_upd_serv <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Rs</span> <span class="main">∉</span> dom <span class="free">runz</span> <span class="main">⟧</span>
  <span class="main">⟹</span> ri_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Rs</span> <span class="main">↦</span> <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="free">Na</span><span class="main">,</span> aNum <span class="free">Ts</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">=</span> ri_runs2sigs <span class="free">runz</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ri_runs2sigs.induct<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ri_runs2sigs_upd_init_some <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">runz</span> <span class="free">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">;</span> finite <span class="main">(</span>dom <span class="free">runz</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> ri_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Ra</span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">,</span> aNum <span class="free">Ts</span><span class="main">,</span> aNum <span class="free">Ta</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span>ri_runs2sigs <span class="free">runz</span><span class="main">)</span><span class="main">(</span>
       Running <span class="main">[</span><span class="free">B</span><span class="main">,</span> <span class="free">A</span><span class="main">]</span> <span class="main">(</span><span class="free">Kab</span><span class="main">,</span> <span class="free">Ts</span><span class="main">,</span> <span class="free">Ta</span><span class="main">)</span> <span class="main">:=</span> 
         Suc <span class="main">(</span>card <span class="main">(</span>ri_running <span class="free">runz</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> rev_mp<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ri_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
<span class="comment1">― ‹1 subgoal›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> runz<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> s<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"card <span class="main">(</span>insert <span class="free">Ra</span> <span class="main">(</span>ri_running <span class="improper">runz</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> ri_runs2sigs_upd_resp_some <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">runz</span> <span class="free">Rb</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">;</span> finite <span class="main">(</span>dom <span class="free">runz</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> ri_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Rb</span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">,</span> aNum <span class="free">Ts</span><span class="main">,</span> aNum <span class="free">Ta</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span>ri_runs2sigs <span class="free">runz</span><span class="main">)</span><span class="main">(</span>
        Commit <span class="main">[</span><span class="free">B</span><span class="main">,</span> <span class="free">A</span><span class="main">]</span> <span class="main">(</span><span class="free">Kab</span><span class="main">,</span> <span class="free">Ts</span><span class="main">,</span> <span class="free">Ta</span><span class="main">)</span> <span class="main">:=</span> 
          Suc <span class="main">(</span>card <span class="main">(</span>ri_commit <span class="free">runz</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> rev_mp<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ri_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="comment1">― ‹1 subgoal›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> runz<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> s<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"card <span class="main">(</span>insert <span class="free">Rb</span> <span class="main">(</span>ri_commit <span class="improper">runz</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> ri_runs2sigs_upd_init_some2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">runz</span> <span class="free">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">,</span> aNum <span class="free">Ts</span><span class="main">,</span> aNum <span class="free">Ta</span><span class="main">]</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> ri_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Ra</span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">,</span> aNum <span class="free">Ts</span><span class="main">,</span> aNum <span class="free">Ta</span><span class="main">,</span> END<span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
     ri_runs2sigs <span class="free">runz</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ri_runs2sigs.induct<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement proof›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step1_refines_a0_ri_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0iim1_ri<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0iim1_ri<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0iim1_ri_defs m1_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step2_refines_a0_ri_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0iim1_ri<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0iim1_ri<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0iim1_ri_defs m1_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step3_refines_a0_ri_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0iim1_ri<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1_step3 <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Na</span> <span class="free">Ts</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0iim1_ri<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0iim1_ri_defs m1_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step4_refines_a0_ri_running<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0iim1_ri <span class="main">∩</span> UNIV <span class="main">×</span> m1_inv0_fin<span class="main">}</span> 
     <span class="main">(</span>a0i_running <span class="main">[</span><span class="free">B</span><span class="main">,</span> <span class="free">A</span><span class="main">]</span> <span class="main">(</span><span class="free">Kab</span><span class="main">,</span> <span class="free">Ts</span><span class="main">,</span> <span class="free">Ta</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0iim1_ri<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0iim1_ri_defs a0i_defs m1_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step5_refines_a0_ri_commit<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0iim1_ri <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">(</span>m1_inv1r_cache <span class="main">∩</span> m1_inv0_fin<span class="main">)</span><span class="main">}</span> 
     <span class="main">(</span>a0i_commit <span class="main">[</span><span class="free">B</span><span class="main">,</span> <span class="free">A</span><span class="main">]</span> <span class="main">(</span><span class="free">Kab</span><span class="main">,</span> <span class="free">Ts</span><span class="main">,</span> <span class="free">Ta</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1_step5 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0iim1_ri<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0iim1_ri_defs a0i_defs m1_defs<span class="main">)</span>
<span class="comment1">― ‹2 subgoals›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> s t aa ab ac ba Rs Na Ra nl<span class="main"><span class="keyword3">,</span></span>
       <span class="operator">subgoal_tac</span> 
         <span class="quoted"><span class="quoted">"card <span class="main">(</span>ri_commit <span class="main">(</span>runs <span class="improper">t</span><span class="main">)</span> <span class="free">A</span> <span class="free">B</span> <span class="main">(</span>sesK <span class="main">(</span><span class="improper">Rs</span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span>
          card <span class="main">(</span>ri_running <span class="main">(</span>runs <span class="improper">t</span><span class="main">)</span> <span class="free">A</span> <span class="free">B</span> <span class="main">(</span>sesK <span class="main">(</span><span class="improper">Rs</span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> s t Rs Na Ra nl<span class="main"><span class="keyword3">,</span></span>
       <span class="operator">subgoal_tac</span> 
         <span class="quoted"><span class="quoted">"card <span class="main">(</span>ri_commit <span class="main">(</span>runs <span class="improper">t</span><span class="main">)</span> <span class="free">A</span> <span class="free">B</span> <span class="main">(</span>sesK <span class="main">(</span><span class="improper">Rs</span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span>
          card <span class="main">(</span>ri_running <span class="main">(</span>runs <span class="improper">t</span><span class="main">)</span> <span class="free">A</span> <span class="free">B</span> <span class="main">(</span>sesK <span class="main">(</span><span class="improper">Rs</span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step6_refines_a0_ri_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0iim1_ri<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1_step6 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0iim1_ri<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0iim1_ri_defs m1_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_leak_refines_a0_ri_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0iim1_ri<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1_leak <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Ts</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0iim1_ri<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0iim1_ri_defs a0i_defs m1_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_tick_refines_a0_ri_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0iim1_ri<span class="main">}</span>
     Id<span class="main">,</span> <span class="main">(</span>m1_tick <span class="free">T</span><span class="main">)</span>
   <span class="main">{&gt;</span> R_a0iim1_ri<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0iim1_ri_defs m1_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_purge_refines_a0_ri_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0iim1_ri<span class="main">}</span>
     Id<span class="main">,</span> <span class="main">(</span>m1_purge <span class="free">A</span><span class="main">)</span>
   <span class="main">{&gt;</span> R_a0iim1_ri<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0iim1_ri_defs m1_defs<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All together now...›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_m1_trans_refines_a0_ri_trans <span class="main">=</span> 
  PO_m1_step1_refines_a0_ri_skip  PO_m1_step2_refines_a0_ri_skip
  PO_m1_step3_refines_a0_ri_skip  PO_m1_step4_refines_a0_ri_running
  PO_m1_step5_refines_a0_ri_commit PO_m1_step6_refines_a0_ri_skip 
  PO_m1_leak_refines_a0_ri_skip PO_m1_tick_refines_a0_ri_skip 
  PO_m1_purge_refines_a0_ri_skip

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_refines_init_a0_ri <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m1 <span class="main">⊆</span>  R_a0iim1_ri<span class="main">``</span><span class="main">(</span>init a0i<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R_a0iim1_ri_defs a0i_defs m1_defs
         <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">⦇</span>signals <span class="main">=</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">,</span> corrupted <span class="main">=</span> <span class="main">{}</span> <span class="main">⦈</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_refines_trans_a0_ri <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0iim1_ri <span class="main">∩</span> a0i_inv1_iagree <span class="main">×</span> <span class="main">(</span>m1_inv1r_cache <span class="main">∩</span> m1_inv0_fin<span class="main">)</span><span class="main">}</span> 
     <span class="main">(</span>trans a0i<span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans m1<span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0iim1_ri<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1_def m1_trans_def a0i_def a0i_trans_def
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_m1_trans_refines_a0_ri_trans<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> obs_consistent_med_a0iim1_ri <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"obs_consistent 
     <span class="main">(</span>R_a0iim1_ri <span class="main">∩</span> a0i_inv1_iagree <span class="main">×</span> <span class="main">(</span>m1_inv1r_cache <span class="main">∩</span> m1_inv0_fin<span class="main">)</span><span class="main">)</span>
     med_a0iim1_ri a0i m1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R_a0iim1_ri_def med_a0iim1_ri_def 
                   a0i_def m1_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement result.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_refines_a0ii_ri <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"refines 
     <span class="main">(</span>R_a0iim1_ri <span class="main">∩</span> a0i_inv1_iagree <span class="main">×</span> <span class="main">(</span>m1_inv1r_cache <span class="main">∩</span> m1_inv0_fin<span class="main">)</span><span class="main">)</span>
     med_a0iim1_ri a0i m1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Refinement_using_invariants<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>  m1_implements_a0ii_ri<span class="main">:</span> <span class="quoted"><span class="quoted">"implements med_a0iim1_ri a0i m1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refinement_soundness<span class="main">)</span> <span class="main">(</span><span class="operator">fast</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv3 (inherited): Responder and initiator›</span></span>
<span class="comment1">(*invh*************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This is a translation of the agreement property to Level 1. It
follows from the refinement and is needed to prove inv4 below.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m1_inv3r_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> m1_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_inv3r_init</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Rb</span> <span class="bound">Kab</span> <span class="bound">Ts</span> <span class="bound">Ta</span> <span class="bound">nlb</span><span class="main">.</span>
     <span class="bound">B</span> <span class="main">∉</span> bad <span class="main">⟶</span> <span class="bound">A</span> <span class="main">∉</span> bad <span class="main">⟶</span> <span class="bound">Kab</span> <span class="main">∉</span> Domain <span class="main">(</span>leak <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span>
     runs <span class="bound">s</span> <span class="bound">Rb</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> aKey <span class="bound">Kab</span> <span class="main">#</span> aNum <span class="bound">Ts</span> <span class="main">#</span> aNum <span class="bound">Ta</span> <span class="main">#</span> <span class="bound">nlb</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound">Ra</span> <span class="bound">nla</span><span class="main">.</span> 
        runs <span class="bound">s</span> <span class="bound">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> aKey <span class="bound">Kab</span> <span class="main">#</span> aNum <span class="bound">Ts</span> <span class="main">#</span> aNum <span class="bound">Ta</span> <span class="main">#</span> <span class="bound">nla</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m1_inv3r_initI <span class="main">=</span> m1_inv3r_init_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m1_inv3r_initE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m1_inv3r_init_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m1_inv3r_initD <span class="main">=</span> m1_inv3r_init_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> -1<span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_inv3r_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m1 <span class="main">⊆</span> m1_inv3r_init"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> INV_from_Refinement_basic <span class="main"><span class="main">[</span></span><span class="operator">OF</span> PO_m1_refines_a0ii_ri<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R_a0iim1_ri_def a0i_inv1_iagree_def
            <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>  m1_inv3r_initI<span class="main">)</span>
<span class="comment1">― ‹1 subgoal›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> s A B Rb Kab Ts Ta nlb a<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="improper">B</span><span class="main">,</span> <span class="improper">A</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">Kab</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">Ts</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">Ta</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>ri_commit <span class="main">(</span>runs <span class="improper">s</span><span class="main">)</span> <span class="improper">A</span> <span class="improper">B</span> <span class="improper">Kab</span> <span class="improper">Ts</span> <span class="improper">Ta</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv4: Key freshness for responder›</span></span>
<span class="comment1">(*inv*************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m1_inv4_rfresh</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> m1_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_inv4_rfresh</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Rb1</span> <span class="bound">Rb2</span> <span class="bound">A1</span> <span class="bound">A2</span> <span class="bound">B1</span> <span class="bound">B2</span> <span class="bound">Kab</span> <span class="bound">Ts1</span> <span class="bound">Ts2</span> <span class="bound">Ta1</span> <span class="bound">Ta2</span><span class="main">.</span>
     runs <span class="bound">s</span> <span class="bound">Rb1</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="bound">A1</span><span class="main">,</span> <span class="bound">B1</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="bound">Kab</span><span class="main">,</span> aNum <span class="bound">Ts1</span><span class="main">,</span> aNum <span class="bound">Ta1</span><span class="main">]</span><span class="main">)</span> <span class="main">⟶</span> 
     runs <span class="bound">s</span> <span class="bound">Rb2</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="bound">A2</span><span class="main">,</span> <span class="bound">B2</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="bound">Kab</span><span class="main">,</span> aNum <span class="bound">Ts2</span><span class="main">,</span> aNum <span class="bound">Ta2</span><span class="main">]</span><span class="main">)</span> <span class="main">⟶</span> 
     <span class="bound">B1</span> <span class="main">∉</span> bad <span class="main">⟶</span> <span class="bound">A1</span> <span class="main">∉</span> bad <span class="main">⟶</span> <span class="bound">Kab</span> <span class="main">∉</span> Domain <span class="main">(</span>leak <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="bound">Rb1</span> <span class="main">=</span> <span class="bound">Rb2</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m1_inv4_rfreshI <span class="main">=</span> m1_inv4_rfresh_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m1_inv4_rfreshE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m1_inv4_rfresh_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m1_inv4_rfreshD <span class="main">=</span> m1_inv4_rfresh_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Proof of key freshness for responder. All cases except step5 are straightforward.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_inv4_rfresh_step5<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m1_inv4_rfresh <span class="main">∩</span> m1_inv3r_init <span class="main">∩</span> m1_inv2r_serv <span class="main">∩</span> m1_inv1r_cache <span class="main">∩</span>
    m1_secrecy <span class="main">∩</span> m1_inv1_ifresh<span class="main">}</span> 
     <span class="main">(</span>m1_step5 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span>
   <span class="main">{&gt;</span> m1_inv4_rfresh<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m1_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m1_inv4_rfreshI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m1_inv4_rfreshD<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m1_inv2r_servD<span class="main">)</span> 

<span class="comment1">― ‹5 subgoals›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> m1_inv2r_servD<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> azC.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> m1_inv2r_servD<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> azC.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> m1_inv2r_servD<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> azC.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> Rb2 A2 B2 Ts2 Ta2 s Rs Na Ra nl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">B2</span> <span class="main">∈</span> bad"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">thin_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sesK <span class="main">(</span><span class="improper">Rs</span><span class="main">$</span>sk<span class="main">)</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> azC <span class="main">(</span>runs <span class="improper">s</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sesK <span class="main">(</span><span class="improper">Rs</span><span class="main">$</span>sk<span class="main">)</span><span class="main">,</span> <span class="improper">B2</span><span class="main">)</span> <span class="main">∈</span> azC <span class="main">(</span>runs <span class="improper">s</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> azC.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> m1_secrecyE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">A2</span> <span class="main">∈</span> bad"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m1_inv2r_servD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> m1_inv3r_initD<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> Raa nla<span class="main"><span class="keyword3">,</span></span> <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">Raa</span> <span class="main">=</span> <span class="improper">Ra</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>    <span class="comment1">― ‹uses cache invariant›</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> m1_inv3r_initD<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> Raa nla<span class="main"><span class="keyword3">,</span></span> <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">Raa</span> <span class="main">=</span> <span class="improper">Ra</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>      <span class="comment1">― ‹uses cache invariant›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_m1_inv4_rfresh_step5_lemmas <span class="main">=</span> 
  PO_m1_inv4_rfresh_step5

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_inv4_rfresh_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m1 <span class="main">⊆</span> m1_inv4_rfresh"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m1_inv4_rfreshI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_inv4_rfresh_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m1_inv4_rfresh <span class="main">∩</span> m1_inv3r_init <span class="main">∩</span> m1_inv2r_serv <span class="main">∩</span> m1_inv1r_cache <span class="main">∩</span>
    m1_secrecy <span class="main">∩</span> m1_inv1_ifresh<span class="main">}</span> 
      trans m1 
   <span class="main">{&gt;</span> m1_inv4_rfresh<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1_def m1_trans_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_m1_inv4_rfresh_step5_lemmas<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m1_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m1_inv4_rfreshI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m1_inv4_rfreshD<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> PO_m1_inv4_rfresh <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m1 <span class="main">⊆</span> m1_inv4_rfresh"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> 
         J<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"m1_inv3r_init <span class="main">∩</span> m1_inv2r_serv <span class="main">∩</span> m1_inv1r_cache <span class="main">∩</span> m1_secrecy <span class="main">∩</span> m1_inv1_ifresh"</span></span> 
       <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> inv_rule_incr<span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Int_assoc <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_obs_inv4_rfresh <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach m1 <span class="main">⊆</span> m1_inv4_rfresh"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> external_from_internal_invariant<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>a0i›</span></span></span></span> for initiator/responder›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The initiator injectively agrees with the responder on <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Kab›</span></span></span></span>,
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Ts›</span></span></span></span>, and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Ta›</span></span></span></span>.›</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Simulation relation›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define two auxiliary functions to reconstruct the signals of the
initial model from completed initiator and responder runs.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  irsig <span class="main">=</span> <span class="quoted"><span class="quoted">"key <span class="main">×</span> time <span class="main">×</span> time"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">ir_running</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>runs_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> key<span class="main">,</span> time<span class="main">,</span> time<span class="main">]</span> <span class="main">⇒</span> rid_t set"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ir_running</span> <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">Rb</span><span class="main">.</span> <span class="main">∃</span><span class="bound">nl</span><span class="main">.</span> 
     <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="bound">Rb</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">#</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">#</span> aNum <span class="free"><span class="bound"><span class="entity">Ta</span></span></span> <span class="main">#</span> <span class="bound">nl</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">ir_commit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>runs_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> key<span class="main">,</span> time<span class="main">,</span> time<span class="main">]</span> <span class="main">⇒</span> rid_t set"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ir_commit</span> <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">Ra</span><span class="main">.</span> <span class="main">∃</span><span class="bound">nl</span><span class="main">.</span> 
     <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="bound">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">#</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">#</span> aNum <span class="free"><span class="bound"><span class="entity">Ta</span></span></span> <span class="main">#</span> END <span class="main">#</span> <span class="bound">nl</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">ir_runs2sigs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"runs_t <span class="main">⇒</span> risig signal <span class="main">⇒</span> nat"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">ir_runs2sigs</span> <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="main">(</span>Running <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
     card <span class="main">(</span>ir_running <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ir_runs2sigs</span> <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="main">(</span>Commit <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
     card <span class="main">(</span>ir_commit <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ir_runs2sigs</span> <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">0</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Simulation relation and mediator function. We map completed initiator 
and responder runs to commit and running signals, respectively.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">med_a0iim1_ir</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m1_obs <span class="main">⇒</span> irsig a0i_obs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med_a0iim1_ir</span> <span class="free"><span class="bound"><span class="entity">o1</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> signals <span class="main">=</span> ir_runs2sigs <span class="main">(</span>runs <span class="free"><span class="bound"><span class="entity">o1</span></span></span><span class="main">)</span><span class="main">,</span> corrupted <span class="main">=</span> <span class="main">{}</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R_a0iim1_ir</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>irsig a0i_state <span class="main">×</span> m1_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R_a0iim1_ir</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> signals <span class="bound">s</span> <span class="main">=</span> ir_runs2sigs <span class="main">(</span>runs <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> corrupted <span class="bound">s</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> R_a0iim1_ir_defs <span class="main">=</span> R_a0iim1_ir_def med_a0iim1_ir_def


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Lemmas about the auxiliary functions›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> ir_runs2sigs_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">runz</span> <span class="main">=</span> Map.empty <span class="main">⟹</span> ir_runs2sigs <span class="free">runz</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span> 
   <span class="main">(</span><span class="operator">rule</span> ir_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="comment1">(* already proven higher up:
lemma ir_running_finite [simp, intro]:
  "finite (dom runz) ⟹ finite (ir_running runz A B Kab Ts Ta)"
by (auto intro: finite_subset dest: dom_lemmas) 
*)</span>

<span class="keyword1"><span class="command">lemma</span></span> ir_commit_finite <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">runz</span><span class="main">)</span> <span class="main">⟹</span> finite <span class="main">(</span>ir_commit <span class="free">runz</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Update lemmas›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ir_runs2sigs_upd_init_none <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Ra</span> <span class="main">∉</span> dom <span class="free">runz</span> <span class="main">⟧</span>
  <span class="main">⟹</span> ir_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Ra</span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ir_runs2sigs <span class="free">runz</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span> 
   <span class="main">(</span><span class="operator">rule</span> ir_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ir_runs2sigs_upd_resp_none <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Rb</span> <span class="main">∉</span> dom <span class="free">runz</span> <span class="main">⟧</span>
  <span class="main">⟹</span> ir_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Rb</span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ir_runs2sigs <span class="free">runz</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span> 
   <span class="main">(</span><span class="operator">rule</span> ir_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ir_runs2sigs_upd_serv <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Rs</span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="free">y</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> ir_runs2sigs <span class="main">(</span>runs <span class="free">y</span><span class="main">(</span><span class="free">Rs</span> <span class="main">↦</span> <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="free">Na</span><span class="main">,</span> aNum <span class="free">Ts</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">=</span> ir_runs2sigs <span class="main">(</span>runs <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span> 
   <span class="main">(</span><span class="operator">rule</span> ir_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ir_runs2sigs_upd_init_some <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">runz</span> <span class="free">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> ir_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Ra</span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">,</span> aNum <span class="free">Ts</span><span class="main">,</span> aNum <span class="free">Ta</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
     ir_runs2sigs <span class="free">runz</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span> 
   <span class="main">(</span><span class="operator">rule</span> ir_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ir_runs2sigs_upd_resp_some_raw<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">runz</span> <span class="free">Rb</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span> 
    <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">runz</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"ir_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Rb</span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">,</span> aNum <span class="free">Ts</span><span class="main">,</span> aNum <span class="free">Ta</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span>
     <span class="main">(</span><span class="main">(</span>ir_runs2sigs <span class="free">runz</span><span class="main">)</span><span class="main">(</span>
       Running <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span> <span class="main">(</span><span class="free">Kab</span><span class="main">,</span> <span class="free">Ts</span><span class="main">,</span> <span class="free">Ta</span><span class="main">)</span> <span class="main">:=</span> 
         Suc <span class="main">(</span>card <span class="main">(</span>ir_running <span class="free">runz</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ir_runs2sigs.induct<span class="main">)</span> 
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">runz</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Kab</span> <span class="skolem">Ts</span> <span class="skolem">Ta</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> H <span class="main">=</span> this
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">Rb</span> <span class="main">∉</span> ir_running <span class="skolem">runz</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Kab</span> <span class="skolem">Ts</span> <span class="skolem">Ta</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> H <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"card <span class="main">(</span>insert <span class="free">Rb</span> <span class="main">(</span>ir_running <span class="skolem">runz</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Kab</span> <span class="skolem">Ts</span> <span class="skolem">Ta</span><span class="main">)</span><span class="main">)</span> 
       <span class="main">=</span> Suc <span class="main">(</span>card <span class="main">(</span>ir_running <span class="skolem">runz</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Kab</span> <span class="skolem">Ts</span> <span class="skolem">Ta</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> subst<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ir_runs2sigs_upd_resp_some <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">runz</span> <span class="free">Rb</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">;</span> finite <span class="main">(</span>dom <span class="free">runz</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> ir_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Rb</span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">,</span> aNum <span class="free">Ts</span><span class="main">,</span> aNum <span class="free">Ta</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span>ir_runs2sigs <span class="free">runz</span><span class="main">)</span><span class="main">(</span>
       Running <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span> <span class="main">(</span><span class="free">Kab</span><span class="main">,</span> <span class="free">Ts</span><span class="main">,</span> <span class="free">Ta</span><span class="main">)</span> <span class="main">:=</span> 
         Suc <span class="main">(</span>card <span class="main">(</span>ir_running <span class="free">runz</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext ir_runs2sigs_upd_resp_some_raw<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ir_runs2sigs_upd_init_some2_raw<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">runz</span> <span class="free">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">,</span> aNum <span class="free">Ts</span><span class="main">,</span> aNum <span class="free">Ta</span><span class="main">]</span><span class="main">)</span>"</span></span> 
    <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">runz</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"ir_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Ra</span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">,</span> aNum <span class="free">Ts</span><span class="main">,</span> aNum <span class="free">Ta</span><span class="main">,</span> END<span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span>
     <span class="main">(</span><span class="main">(</span>ir_runs2sigs <span class="free">runz</span><span class="main">)</span><span class="main">(</span>
        Commit <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span> <span class="main">(</span><span class="free">Kab</span><span class="main">,</span> <span class="free">Ts</span><span class="main">,</span> <span class="free">Ta</span><span class="main">)</span> <span class="main">:=</span> 
          Suc <span class="main">(</span>card <span class="main">(</span>ir_commit <span class="free">runz</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">runz</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ir_runs2sigs.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">runz</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Kab</span> <span class="skolem">Ts</span> <span class="skolem">Ta</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> H <span class="main">=</span> this 
    <span class="keyword1"><span class="command">from</span></span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ra</span> <span class="main">∉</span> ir_commit <span class="skolem">runz</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Kab</span> <span class="skolem">Ts</span> <span class="skolem">Ta</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> H <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"card <span class="main">(</span>insert <span class="free">Ra</span> <span class="main">(</span>ir_commit <span class="skolem">runz</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Kab</span> <span class="skolem">Ts</span> <span class="skolem">Ta</span><span class="main">)</span><span class="main">)</span> 
       <span class="main">=</span> Suc <span class="main">(</span>card <span class="main">(</span>ir_commit <span class="skolem">runz</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Kab</span> <span class="skolem">Ts</span> <span class="skolem">Ta</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> subst<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ir_runs2sigs_upd_init_some2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">runz</span> <span class="free">Na</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">,</span> aNum <span class="free">Ts</span><span class="main">,</span> aNum <span class="free">Ta</span><span class="main">]</span><span class="main">)</span><span class="main">;</span> finite <span class="main">(</span>dom <span class="free">runz</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> ir_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Na</span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">,</span> aNum <span class="free">Ts</span><span class="main">,</span> aNum <span class="free">Ta</span><span class="main">,</span> END<span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span>ir_runs2sigs <span class="free">runz</span><span class="main">)</span><span class="main">(</span>
        Commit <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span> <span class="main">(</span><span class="free">Kab</span><span class="main">,</span> <span class="free">Ts</span><span class="main">,</span> <span class="free">Ta</span><span class="main">)</span> <span class="main">:=</span> 
          Suc <span class="main">(</span>card <span class="main">(</span>ir_commit <span class="free">runz</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ir_runs2sigs_upd_init_some2_raw ext<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement proof›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step1_refines_ir_a0ii_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0iim1_ir<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0iim1_ir<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0iim1_ir_defs m1_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step2_refines_ir_a0ii_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0iim1_ir<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0iim1_ir<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0iim1_ir_defs m1_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step3_refines_ir_a0ii_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0iim1_ir<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1_step3 <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Na</span> <span class="free">Ts</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0iim1_ir<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0iim1_ir_defs a0i_defs m1_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step4_refines_ir_a0ii_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0iim1_ir<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0iim1_ir<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0iim1_ir_defs m1_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step5_refines_ir_a0ii_running<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0iim1_ir <span class="main">∩</span> UNIV <span class="main">×</span> m1_inv0_fin<span class="main">}</span> 
     <span class="main">(</span>a0i_running <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span> <span class="main">(</span><span class="free">Kab</span><span class="main">,</span> <span class="free">Ts</span><span class="main">,</span> <span class="free">Ta</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1_step5 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0iim1_ir<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0iim1_ir_defs a0i_defs m1_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step6_refines_ir_a0ii_commit<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0iim1_ir <span class="main">∩</span> UNIV <span class="main">×</span> m1_inv0_fin<span class="main">}</span> 
     <span class="main">(</span>a0n_commit <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span> <span class="main">(</span><span class="free">Kab</span><span class="main">,</span> <span class="free">Ts</span><span class="main">,</span> <span class="free">Ta</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1_step6 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0iim1_ir<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0iim1_ir_defs a0n_defs m1_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_leak_refines_ir_a0ii_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0iim1_ir<span class="main">}</span>
     Id<span class="main">,</span> <span class="main">(</span>m1_leak <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Ts</span><span class="main">)</span>
   <span class="main">{&gt;</span> R_a0iim1_ir<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0iim1_ir_defs a0n_defs m1_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_tick_refines_ir_a0ii_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0iim1_ir<span class="main">}</span>
     Id<span class="main">,</span> <span class="main">(</span>m1_tick <span class="free">T</span><span class="main">)</span>
   <span class="main">{&gt;</span> R_a0iim1_ir<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0iim1_ir_defs m1_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_purge_refines_ir_a0ii_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0iim1_ir<span class="main">}</span>
     Id<span class="main">,</span> <span class="main">(</span>m1_purge <span class="free">A</span><span class="main">)</span>
   <span class="main">{&gt;</span> R_a0iim1_ir<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0iim1_ir_defs m1_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All together now...›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_m1_trans_refines_ir_a0ii_trans <span class="main">=</span> 
  PO_m1_step1_refines_ir_a0ii_skip  PO_m1_step2_refines_ir_a0ii_skip
  PO_m1_step3_refines_ir_a0ii_skip  PO_m1_step4_refines_ir_a0ii_skip
  PO_m1_step5_refines_ir_a0ii_running PO_m1_step6_refines_ir_a0ii_commit
  PO_m1_leak_refines_ir_a0ii_skip PO_m1_tick_refines_ir_a0ii_skip 
  PO_m1_purge_refines_ir_a0ii_skip

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_refines_init_ir_a0ii <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m1 <span class="main">⊆</span>  R_a0iim1_ir<span class="main">``</span><span class="main">(</span>init a0n<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R_a0iim1_ir_defs a0n_defs m1_defs
         <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">⦇</span>signals <span class="main">=</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">,</span> corrupted <span class="main">=</span> <span class="main">{}</span><span class="main">⦈</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_refines_trans_ir_a0ii <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0iim1_ir <span class="main">∩</span> UNIV <span class="main">×</span> m1_inv0_fin<span class="main">}</span> 
     <span class="main">(</span>trans a0n<span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans m1<span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0iim1_ir<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1_def m1_trans_def a0n_def a0n_trans_def
         <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_m1_trans_refines_ir_a0ii_trans<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Observation consistency.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> obs_consistent_med_a0iim1_ir <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"obs_consistent 
     <span class="main">(</span>R_a0iim1_ir <span class="main">∩</span> UNIV <span class="main">×</span> m1_inv0_fin<span class="main">)</span> 
     med_a0iim1_ir a0n m1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R_a0iim1_ir_def med_a0iim1_ir_def 
                   a0n_def m1_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement result.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_refines_a0ii_ir <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"refines <span class="main">(</span>R_a0iim1_ir <span class="main">∩</span> UNIV <span class="main">×</span> m1_inv0_fin<span class="main">)</span> 
     med_a0iim1_ir a0n m1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Refinement_using_invariants<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span>  m1_implements_a0ii_ir<span class="main">:</span> <span class="quoted"><span class="quoted">"implements med_a0iim1_ir a0n m1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refinement_soundness<span class="main">)</span> <span class="main">(</span><span class="operator">fast</span><span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="m2_kerberos">
<div class="head">
<h1>Theory m2_kerberos</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Development of Security Protocols by Refinement

  Module:  Key_establish/m2_kerberos.thy (Isabelle/HOL 2016-1)
  ID:      $Id: m2_kerberos.thy 133854 2017-03-20 17:53:50Z csprenge $
  Author:  Ivano Somaini, ETH Zurich &lt;somainii@student.ethz.ch&gt;
           Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  Key distribution protocols
  Second refinement: channel-protocol, parallel version of BAN-Kerberos

  Copyright (c) 2009-2016 Ivano Somaini, Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Abstract Kerberos core protocol (L2)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> m2_kerberos <span class="keyword2"><span class="keyword">imports</span></span> <a href="m1_kerberos.html">m1_kerberos</a> <span class="quoted">"<a href="Channels.html">../Refinement/Channels</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
We model an abstract version of the core Kerberos protocol:
\[
\begin{array}{lll}
  \mathrm{M1.}  &amp; A \rightarrow S: &amp; A, B, Na \\ 
  \mathrm{M2a.} &amp; S \rightarrow A: &amp; \{Kab, Ts, B, Na\}_{Kas} \\
  \mathrm{M2b.} &amp; S \rightarrow B: &amp; \{Kab, Ts, A\}_{Kbs} \\
  \mathrm{M3.}  &amp; A \rightarrow B: &amp; \{A, Ta\}_{Kab} \\
  \mathrm{M4.}  &amp; B \rightarrow A: &amp; \{Ta\}_{Kab} \\
\end{array}
\]
Message 1 is sent over an insecure channel, the other four (cleartext) messages 
over secure channels.
›</span></span>

<span class="keyword1"><span class="command">declare</span></span> domIff <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">iff</span> <span class="quasi_keyword">del</span><span class="main">]</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹State›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹State and observations›</span></span>

<span class="keyword1"><span class="command">record</span></span> m2_state <span class="main">=</span> <span class="quoted"><span class="quoted">"m1_state"</span></span> <span class="main">+</span>
  chan <span class="main">::</span> <span class="quoted"><span class="quoted">"chmsg set"</span></span>              <span class="comment1">― ‹channel messages›</span>

<span class="keyword1"><span class="command">type_synonym</span></span> 
  m2_obs <span class="main">=</span> <span class="quoted"><span class="quoted">"m1_state"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_obs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_state <span class="main">⇒</span> m2_obs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_obs</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> 
     runs <span class="main">=</span> runs <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span>
     leak <span class="main">=</span> leak <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span>
     clk <span class="main">=</span> clk <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> 
     cache <span class="main">=</span> cache <span class="free"><span class="bound"><span class="entity">s</span></span></span>
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  m2_pred <span class="main">=</span> <span class="quoted"><span class="quoted">"m2_state set"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  m2_trans <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m2_state<span class="main">)</span> set"</span></span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Events›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Protocol events.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">A</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m1a_step1"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m2_step1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">]</span> <span class="main">⇒</span> m2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_step1</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>
     <span class="comment1">― ‹guards:›</span>
     <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>                                <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Ra›</span></span> is fresh›</span>
     <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>na <span class="main">∧</span>                                        <span class="comment1">― ‹generate nonce›</span>

     <span class="comment1">― ‹actions:›</span>
     <span class="comment1">― ‹create initiator thread and send message 1›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
       runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
       chan <span class="main">:=</span> insert <span class="main">(</span>Insec <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span>  <span class="comment1">― ‹send <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M1›</span></span>›</span>
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">B</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">m1e_step2</span>"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m2_step2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">]</span> <span class="main">⇒</span> m2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_step2</span> <span class="main">≡</span> m1_step2"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"Server"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">m1e_step3</span></span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m2_step3</span> <span class="main">::</span> 
    <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> key<span class="main">,</span> nonce<span class="main">,</span> time<span class="main">]</span> <span class="main">⇒</span> m2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_step3</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span> 

     <span class="comment1">― ‹guards:›</span>
     <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>                               <span class="comment1">― ‹fresh server run›</span>
     <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">=</span> sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span>                               <span class="comment1">― ‹fresh session key›</span>
     <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">=</span> clk <span class="bound">s</span> <span class="main">∧</span>                                      <span class="comment1">― ‹fresh timestamp›</span>

     Insec <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">∧</span>              <span class="comment1">― ‹recv <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M1›</span></span>›</span>
   
     <span class="comment1">― ‹actions:›</span>
     <span class="comment1">― ‹record key and send messages 2 and 3›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
       runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">↦</span> <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> 
       chan <span class="main">:=</span> <span class="main">{</span>Secure Sv <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aAgt <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span> aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">,</span>  <span class="comment1">― ‹send <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M2a/b›</span></span>›</span>
                Secure Sv <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aAgt <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> chan <span class="bound">s</span>
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">A</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">m1e_step4</span></span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m2_step4</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> key<span class="main">,</span> time<span class="main">,</span> time<span class="main">]</span> <span class="main">⇒</span> m2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_step4</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>
     <span class="comment1">― ‹guards:›</span>
     runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>          <span class="comment1">― ‹session key not yet recv'd›</span>
     <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>na <span class="main">∧</span>                                   <span class="comment1">― ‹fix nonce›</span>
     <span class="free"><span class="bound"><span class="entity">Ta</span></span></span> <span class="main">=</span> clk <span class="bound">s</span> <span class="main">∧</span>                                   <span class="comment1">― ‹fresh timestamp›</span>
     clk <span class="bound">s</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">+</span> Ls <span class="main">∧</span>                              <span class="comment1">― ‹ensure key recentness›</span>

     Secure Sv <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aAgt <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span> aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">∧</span>  <span class="comment1">― ‹recv <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M2a›</span></span>›</span>

     <span class="comment1">― ‹actions:›</span>
     <span class="comment1">― ‹record session key›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
       runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
       chan <span class="main">:=</span> insert <span class="main">(</span>dAuth <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aAgt <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span>   <span class="comment1">― ‹send <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M3›</span></span>›</span>
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">B</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">m1e_step5</span></span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m2_step5</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> key<span class="main">,</span> time<span class="main">,</span> time<span class="main">]</span> <span class="main">⇒</span> m2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_step5</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span> 
     <span class="comment1">― ‹guards:›</span>
     runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>          <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Kab›</span></span> not yet received›</span>
     Secure Sv <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aAgt <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">∧</span>   <span class="comment1">― ‹recv <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M2b›</span></span>›</span>
     dAuth <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aAgt <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">∧</span>            <span class="comment1">― ‹recv <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M3›</span></span>›</span>

     <span class="comment1">― ‹ensure freshness of session key›</span>
     clk <span class="bound">s</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">+</span> Ls <span class="main">∧</span>

     <span class="comment1">― ‹check authenticator's validity and replay; 'replays' with fresh authenticator ok!›</span>
     clk <span class="bound">s</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span> <span class="main">+</span> La <span class="main">∧</span> 
     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">)</span> <span class="main">∉</span> cache <span class="bound">s</span> <span class="main">∧</span> 

     <span class="comment1">― ‹actions:›</span>
     <span class="comment1">― ‹record session key, send message <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M4›</span></span>›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
       runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> 
       cache <span class="main">:=</span> insert <span class="main">(</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">)</span> <span class="main">(</span>cache <span class="bound">s</span><span class="main">)</span><span class="main">,</span>
       chan <span class="main">:=</span> insert <span class="main">(</span>dAuth <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aNum <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span>   <span class="comment1">― ‹send <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M4›</span></span>›</span>
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">A</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">m1e_step6</span></span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m2_step6</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> key<span class="main">,</span> time<span class="main">,</span> time<span class="main">]</span> <span class="main">⇒</span> m2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_step6</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span> 
     runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span>   <span class="comment1">― ‹key recv'd before›</span>
     <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>na <span class="main">∧</span>                                    <span class="comment1">― ‹generated nonce›</span>

     clk <span class="bound">s</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">+</span> Ls <span class="main">∧</span>                               <span class="comment1">― ‹check session key's recentness›</span>

     dAuth <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aNum <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">∧</span>            <span class="comment1">― ‹recv <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M4›</span></span>›</span>
 
     <span class="comment1">― ‹actions:›</span>
     <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
       runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">,</span> END<span class="main">]</span><span class="main">)</span><span class="main">)</span>
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Clock tick event›</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m1_tick</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m2_tick</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"time <span class="main">⇒</span> m2_trans"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_tick</span> <span class="main">≡</span> m1_tick"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Purge event: purge cache of expired timestamps›</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m1_purge"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m2_purge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent <span class="main">⇒</span> m2_trans"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_purge</span> <span class="main">≡</span> m1_purge"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Intruder events.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m1_leak</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m2_leak</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> time<span class="main">]</span> <span class="main">⇒</span> m2_trans"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_leak</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span> 
    <span class="main">(</span>clk <span class="bound">s</span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">+</span> Ls<span class="main">)</span> <span class="main">∧</span>            <span class="comment1">― ‹only compromise 'old' session keys›</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="comment1">― ‹record session key as leaked;›</span>
    <span class="comment1">― ‹intruder sends himself an insecure channel message containing the key›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> leak <span class="main">:=</span> insert <span class="main">(</span>sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">)</span> <span class="main">(</span>leak <span class="bound">s</span><span class="main">)</span><span class="main">,</span> 
            chan <span class="main">:=</span> insert <span class="main">(</span>Insec undefined undefined <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="main">(</span>sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span> <span class="main">⦈</span> 
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">Id</span><span class="antiquote">}</span></span>›</span> 
  <span class="entity">m2_fake</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_fake</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span> 

     <span class="comment1">― ‹actions:›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
       <span class="comment1">― ‹close under fakeable messages›</span>
       chan <span class="main">:=</span> fake ik0 <span class="main">(</span>dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span> 
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Transition system›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_init</span> <span class="main">≡</span> <span class="main">{</span> <span class="main">⦇</span>
     runs <span class="main">=</span> Map.empty<span class="main">,</span>
     leak <span class="main">=</span> corrKey <span class="main">×</span> <span class="main">{</span>undefined<span class="main">}</span><span class="main">,</span>
     clk <span class="main">=</span> <span class="main">0</span><span class="main">,</span>
     cache <span class="main">=</span> <span class="main">{}</span><span class="main">,</span>
     chan <span class="main">=</span> <span class="main">{}</span>
  <span class="main">⦈</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_trans"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_trans</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Ra</span> <span class="bound">Rb</span> <span class="bound">Rs</span> <span class="bound">Na</span> <span class="bound">Kab</span> <span class="bound">Ts</span> <span class="bound">Ta</span> <span class="bound">T</span><span class="main">.</span>
     m2_step1 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="main">∪</span>
     m2_step2 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">∪</span>
     m2_step3 <span class="bound">Rs</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Kab</span> <span class="bound">Na</span> <span class="bound">Ts</span> <span class="main">∪</span>
     m2_step4 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Kab</span> <span class="bound">Ts</span> <span class="bound">Ta</span> <span class="main">∪</span>
     m2_step5 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Kab</span> <span class="bound">Ts</span> <span class="bound">Ta</span> <span class="main">∪</span>
     m2_step6 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Kab</span> <span class="bound">Ts</span> <span class="bound">Ta</span> <span class="main">∪</span>
     m2_tick <span class="bound">T</span> <span class="main">∪</span>
     m2_purge <span class="bound">A</span> <span class="main">∪</span> 
     m2_leak <span class="bound">Rs</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Ts</span> <span class="main">∪</span>
     m2_fake <span class="main">∪</span>
     Id
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state<span class="main">,</span> m2_obs<span class="main">)</span> spec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2</span> <span class="main">≡</span> <span class="main">⦇</span>
    init <span class="main">=</span> m2_init<span class="main">,</span>
    trans <span class="main">=</span> m2_trans<span class="main">,</span>
    obs <span class="main">=</span> m2_obs
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_loc_defs <span class="main">=</span> 
  m2_def m2_init_def m2_trans_def m2_obs_def
  m2_step1_def m2_step2_def m2_step3_def m2_step4_def m2_step5_def 
  m2_step6_def m2_tick_def m2_purge_def m2_leak_def m2_fake_def 

<span class="keyword1"><span class="command">lemmas</span></span> m2_defs <span class="main">=</span> m2_loc_defs m1_defs


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants and simulation relation›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv1: Key definedness›</span></span>
<span class="comment1">(*inv**************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All session keys in channel messages stem from existing runs.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_inv1_keys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">m2_inv1_keys</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">R</span><span class="main">.</span>
     aKey <span class="main">(</span>sesK <span class="main">(</span><span class="bound">R</span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span> <span class="main">∈</span> atoms <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span> <span class="main">∨</span> sesK <span class="main">(</span><span class="bound">R</span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∈</span> Domain <span class="main">(</span>leak <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span> 
       <span class="bound">R</span> <span class="main">∈</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv1_keysI <span class="main">=</span> m2_inv1_keys_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv1_keysE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m2_inv1_keys_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv1_keysD <span class="main">=</span> m2_inv1_keys_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv1_keys_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m2 <span class="main">⊆</span> m2_inv1_keys"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv1_keysI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv1_keys_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv1_keys<span class="main">}</span> trans m2 <span class="main">{&gt;</span> m2_inv1_keys<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv1_keysI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m2_inv1_keysD dom_lemmas<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv1_keys <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m2_inv1_keys"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv2: Definedness of used keys›</span></span>
<span class="comment1">(*inv*************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_inv2_keys_for</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">m2_inv2_keys_for</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">R</span><span class="main">.</span>
     sesK <span class="main">(</span><span class="bound">R</span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∈</span> keys_for <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">R</span> <span class="main">∈</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv2_keys_forI <span class="main">=</span> m2_inv2_keys_for_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv2_keys_forE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m2_inv2_keys_for_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv2_keys_forD <span class="main">=</span> m2_inv2_keys_for_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv2_keys_for_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m2 <span class="main">⊆</span> m2_inv2_keys_for"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv2_keys_forI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv2_keys_for_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv2_keys_for <span class="main">∩</span> m2_inv1_keys<span class="main">}</span> trans m2 <span class="main">{&gt;</span> m2_inv2_keys_for<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv2_keys_forI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m2_inv2_keys_forD m2_inv1_keysD <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>
<span class="comment1">― ‹2 subgoals, from step3 and fake›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> R s xb xc xd xi<span class="main"><span class="keyword3">,</span></span> 
       <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"aKey <span class="main">(</span>sesK <span class="main">(</span><span class="improper">R</span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span> <span class="main">∈</span> atoms <span class="main">(</span>chan <span class="improper">s</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> keys_for_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> fake.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv2_keys_for <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m2_inv2_keys_for"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_incr<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv3a: Session key compromise›</span></span>
<span class="comment1">(*inv**************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A L2 version of a session key comprise invariant. Roughly, it states
that adding a set of keys <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">KK</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to the parameter <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>T›</span></span></span></span> of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">extr</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
does not help the intruder to extract keys other than those in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">KK</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> or
extractable without adding <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">KK</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. 
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_inv3a_sesK_compr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">m2_inv3a_sesK_compr</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">K</span> <span class="bound">KK</span><span class="main">.</span>
     <span class="comment1">⌦‹KK ⊆ range sesK ⟶›</span>
     aKey <span class="bound">K</span> <span class="main">∈</span> extr <span class="main">(</span>aKey<span class="main">`</span><span class="bound">KK</span> <span class="main">∪</span> ik0<span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="bound">K</span> <span class="main">∈</span> <span class="bound">KK</span> <span class="main">∨</span> aKey <span class="bound">K</span> <span class="main">∈</span> extr ik0 <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv3a_sesK_comprI <span class="main">=</span> m2_inv3a_sesK_compr_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv3a_sesK_comprE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m2_inv3a_sesK_compr_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv3a_sesK_comprD <span class="main">=</span> m2_inv3a_sesK_compr_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Additional lemma to get the keys in front›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> insert_commute_aKey <span class="main">=</span> insert_commute <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"aKey <span class="free">K</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">K</span><span class="main">]</span> 

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv3a_sesK_compr_simps <span class="main">=</span> 
  m2_inv3a_sesK_comprD
  m2_inv3a_sesK_comprD <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"insert <span class="free">Kab</span> <span class="free">KK</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">Kab</span> <span class="free">KK</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  m2_inv3a_sesK_comprD <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">Kab</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">Kab</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  insert_commute_aKey 

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv3a_sesK_compr_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m2 <span class="main">⊆</span> m2_inv3a_sesK_compr"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv3a_sesK_comprI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv3a_sesK_compr_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv3a_sesK_compr<span class="main">}</span> trans m2 <span class="main">{&gt;</span> m2_inv3a_sesK_compr<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs m2_inv3a_sesK_compr_simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv3a_sesK_comprI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv3a_sesK_compr <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m2_inv3a_sesK_compr"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> 


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv3b: Leakage of old session keys›</span></span>
<span class="comment1">(*inv**************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Only old session keys are leaked to the intruder.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m2_inv3b_leak</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_inv3b_leak</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Rs</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Ts</span><span class="main">.</span> 
     <span class="main">(</span>sesK <span class="main">(</span><span class="bound">Rs</span><span class="main">$</span>sk<span class="main">)</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">Na</span><span class="main">,</span> <span class="bound">Ts</span><span class="main">)</span> <span class="main">∈</span> leak <span class="bound">s</span> <span class="main">⟶</span> clk <span class="bound">s</span> <span class="main">≥</span> <span class="bound">Ts</span> <span class="main">+</span> Ls
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv3b_leakI <span class="main">=</span> m2_inv3b_leak_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv3b_leakE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m2_inv3b_leak_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv3b_leakD <span class="main">=</span> m2_inv3b_leak_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv3b_leak_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m2 <span class="main">⊆</span> m2_inv3b_leak"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv3b_leakI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv3b_leak_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv3b_leak <span class="main">∩</span> m2_inv1_keys<span class="main">}</span> trans m2 <span class="main">{&gt;</span> m2_inv3b_leak<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv3b_leakI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m2_inv3b_leakD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv3b_leak <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m2_inv3b_leak"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_incr<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv3: Lost session keys›</span></span>
<span class="comment1">(*inv**************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹inv3: Lost but not leaked session keys generated by the server for at 
least one bad agent. This invariant is needed in the proof of the strengthening 
of the authorization guards in steps 4 and 5 (e.g., 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Kab</span></span> <span class="main"><span class="main">∉</span></span> Domain <span class="main"><span class="main">(</span></span><span class="free"><span class="free">leaks</span></span> <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">⟶</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">Kab</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">A</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∈</span></span> azC <span class="main"><span class="main">(</span></span>runs <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for the initiator's step4). 
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_inv3_extrKey</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_inv3_extrKey</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">K</span><span class="main">.</span>
     aKey <span class="bound">K</span> <span class="main">∈</span> extr ik0 <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span> 
       <span class="main">(</span><span class="bound">K</span> <span class="main">∈</span> corrKey <span class="main">∧</span> <span class="bound">K</span> <span class="main">∈</span> Domain <span class="main">(</span>leak <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound">R</span> <span class="bound">A'</span> <span class="bound">B'</span> <span class="bound">Na'</span> <span class="bound">Ts'</span><span class="main">.</span> <span class="bound">K</span> <span class="main">=</span> sesK <span class="main">(</span><span class="bound">R</span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span>
          runs <span class="bound">s</span> <span class="bound">R</span> <span class="main">=</span> Some <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="bound">A'</span><span class="main">,</span> <span class="bound">B'</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="bound">Na'</span><span class="main">,</span> aNum <span class="bound">Ts'</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span> 
          <span class="main">(</span><span class="bound">A'</span> <span class="main">∈</span> bad <span class="main">∨</span> <span class="bound">B'</span> <span class="main">∈</span> bad <span class="main">∨</span> <span class="main">(</span><span class="bound">K</span><span class="main">,</span> <span class="bound">A'</span><span class="main">,</span> <span class="bound">B'</span><span class="main">,</span> <span class="bound">Na'</span><span class="main">,</span> <span class="bound">Ts'</span><span class="main">)</span> <span class="main">∈</span> leak <span class="bound">s</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv3_extrKeyI <span class="main">=</span> m2_inv3_extrKey_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv3_extrKeyE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m2_inv3_extrKey_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv3_extrKeyD <span class="main">=</span> m2_inv3_extrKey_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv3_extrKey_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m2 <span class="main">⊆</span> m2_inv3_extrKey"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv3_extrKeyI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv3_extrKey_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv3_extrKey <span class="main">∩</span> m2_inv3a_sesK_compr<span class="main">}</span> 
      trans m2 
   <span class="main">{&gt;</span> m2_inv3_extrKey<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv3_extrKeyI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_inv3a_sesK_compr_simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv3_extrKeyD <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span> <span class="comment1">(* SLOW *)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv3_extrKey <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m2_inv3_extrKey"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> J<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"m2_inv3a_sesK_compr"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> inv_rule_incr<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> 


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv4: Messages M2a/M2b for good agents and server state›</span></span>
<span class="comment1">(*inv**************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹inv4: Secure messages to honest agents and server state; one variant 
for each of M2a and M2b. These invariants establish guard strengthening for
server authentication by the initiator and the responder.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_inv4_M2a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_inv4_M2a</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Kab</span> <span class="bound">Ts</span> <span class="bound">Na</span><span class="main">.</span>
     Secure Sv <span class="bound">A</span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="bound">Kab</span><span class="main">,</span> aAgt <span class="bound">B</span><span class="main">,</span> aNum <span class="bound">Ts</span><span class="main">,</span> aNon <span class="bound">Na</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">⟶</span> <span class="bound">A</span> <span class="main">∈</span> good <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound">Rs</span><span class="main">.</span> <span class="bound">Kab</span> <span class="main">=</span> sesK <span class="main">(</span><span class="bound">Rs</span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span>
          runs <span class="bound">s</span> <span class="bound">Rs</span> <span class="main">=</span> Some <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="bound">Na</span><span class="main">,</span> aNum <span class="bound">Ts</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_inv4_M2b</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_inv4_M2b</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Kab</span> <span class="bound">Ts</span><span class="main">.</span>
     Secure Sv <span class="bound">B</span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="bound">Kab</span><span class="main">,</span> aAgt <span class="bound">A</span><span class="main">,</span> aNum <span class="bound">Ts</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">⟶</span> <span class="bound">B</span> <span class="main">∈</span> good <span class="main">⟶</span>
        <span class="main">(</span><span class="main">∃</span><span class="bound">Rs</span> <span class="bound">Na</span><span class="main">.</span> <span class="bound">Kab</span> <span class="main">=</span> sesK <span class="main">(</span><span class="bound">Rs</span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span>
           runs <span class="bound">s</span> <span class="bound">Rs</span> <span class="main">=</span> Some <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="bound">Na</span><span class="main">,</span> aNum <span class="bound">Ts</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv4_M2aI <span class="main">=</span> m2_inv4_M2a_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv4_M2aE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m2_inv4_M2a_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv4_M2aD <span class="main">=</span> m2_inv4_M2a_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv4_M2bI <span class="main">=</span> m2_inv4_M2b_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv4_M2bE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m2_inv4_M2b_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv4_M2bD <span class="main">=</span> m2_inv4_M2b_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proofs.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv4_M2a_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m2 <span class="main">⊆</span> m2_inv4_M2a"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv4_M2aI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv4_M2a_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv4_M2a<span class="main">}</span> trans m2 <span class="main">{&gt;</span> m2_inv4_M2a<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv4_M2aI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv4_M2aD <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span> 
<span class="comment1">― ‹4 subgoals›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spec<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spec<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spec<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv4_M2a <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m2_inv4_M2a"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv4_M2b_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m2 <span class="main">⊆</span> m2_inv4_M2b"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv4_M2bI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv4_M2b_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv4_M2b<span class="main">}</span> trans m2 <span class="main">{&gt;</span> m2_inv4_M2b<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv4_M2bI<span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv4_M2bD <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>  
<span class="comment1">― ‹4 subgoals›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spec<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spec<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spec<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv4_M2b <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m2_inv4_M2b"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_incr<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Consequence needed in proof of inv8/step5 and inv9/step4: The 
session key uniquely identifies other fields in M2a and M2b, provided it 
is secret.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m2_inv4_M2a_M2b_match<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Secure Sv <span class="free">A'</span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">,</span> aAgt <span class="free">B'</span><span class="main">,</span> aNum <span class="free">Ts'</span><span class="main">,</span> aNon <span class="free">N</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="free">s</span><span class="main">;</span> 
     Secure Sv <span class="free">B</span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">,</span> aAgt <span class="free">A</span><span class="main">,</span> aNum <span class="free">Ts</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="free">s</span><span class="main">;</span> 
     aKey <span class="free">Kab</span> <span class="main">∉</span> extr ik0 <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">s</span> <span class="main">∈</span> m2_inv4_M2a<span class="main">;</span> <span class="free">s</span> <span class="main">∈</span> m2_inv4_M2b <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">A</span> <span class="main">=</span> <span class="free">A'</span> <span class="main">∧</span> <span class="free">B</span> <span class="main">=</span> <span class="free">B'</span> <span class="main">∧</span> <span class="free">Ts</span> <span class="main">=</span> <span class="free">Ts'</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">A'</span> <span class="main">∉</span> bad <span class="main">∧</span> <span class="free">B</span> <span class="main">∉</span> bad"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv4_M2aD m2_inv4_M2bD<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹More consequences of invariants. Needed in ref/step4 and ref/step5 
respectively to show the strengthening of the authorization guards.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m2_inv34_M2a_authorized<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Secure Sv <span class="free">A</span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="free">K</span><span class="main">,</span> aAgt <span class="free">B</span><span class="main">,</span> aNum <span class="free">T</span><span class="main">,</span> aNon <span class="free">N</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="free">s</span>"</span></span> 
          <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> m2_inv4_M2a"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> m2_inv3_extrKey"</span></span> 
          <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">∉</span> Domain <span class="main">(</span>leak <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">K</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> azC <span class="main">(</span>runs <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> bad"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"aKey <span class="free">K</span> <span class="main">∈</span> extr ik0 <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="main">(</span>3-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1-2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m2_inv4_M2aD<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m2_inv34_M2b_authorized<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Secure Sv <span class="free">B</span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="free">K</span><span class="main">,</span> aAgt <span class="free">A</span><span class="main">,</span> aNum <span class="free">T</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="free">s</span>"</span></span> 
          <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> m2_inv4_M2b"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> m2_inv3_extrKey"</span></span> 
          <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">∉</span> Domain <span class="main">(</span>leak <span class="free">s</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">K</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> azC <span class="main">(</span>runs <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∈</span> bad"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True 
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">B</span> <span class="main">∈</span> bad›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"aKey <span class="free">K</span> <span class="main">∈</span> extr ik0 <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="main">(</span>3-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="main">(</span>1-2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m2_inv4_M2bD<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv5 (derived): Key secrecy for server›</span></span>
<span class="comment1">(*invd**************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹inv5: Key secrecy from server perspective. This invariant links the 
abstract notion of key secrecy to the intruder key knowledge.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_inv5_ikk_sv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_inv5_ikk_sv</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">R</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Ts</span><span class="main">.</span>
     runs <span class="bound">s</span> <span class="bound">R</span> <span class="main">=</span> Some <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="bound">Na</span><span class="main">,</span> aNum <span class="bound">Ts</span><span class="main">]</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">A</span> <span class="main">∈</span> good <span class="main">⟶</span> <span class="bound">B</span> <span class="main">∈</span> good <span class="main">⟶</span>
     aKey <span class="main">(</span>sesK <span class="main">(</span><span class="bound">R</span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span> <span class="main">∈</span> extr ik0 <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">(</span>sesK <span class="main">(</span><span class="bound">R</span><span class="main">$</span>sk<span class="main">)</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">Na</span><span class="main">,</span> <span class="bound">Ts</span><span class="main">)</span> <span class="main">∈</span> leak <span class="bound">s</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv5_ikk_svI <span class="main">=</span> m2_inv5_ikk_sv_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv5_ikk_svE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m2_inv5_ikk_sv_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv5_ikk_svD <span class="main">=</span> m2_inv5_ikk_sv_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof. This invariant follows from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>m2_inv3_extrKey›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m2_inv5_ikk_sv_derived<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> m2_inv3_extrKey <span class="main">⟹</span> <span class="free">s</span> <span class="main">∈</span> m2_inv5_ikk_sv"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_inv3_extrKey_def m2_inv5_ikk_sv_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv5_ikk_sv <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m2_inv5_ikk_sv"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m2_inv3_extrKey"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> m2_inv5_ikk_sv"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> m2_inv5_ikk_sv_derived<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*
lemma PO_m2_inv5_ikk_sv_init [iff]:
  "init m2 ⊆ m2_inv5_ikk_sv"
by (auto simp add: m2_defs intro!: m2_inv5_ikk_svI)

lemma PO_m2_inv5_ikk_sv_trans [iff]:
  "{m2_inv5_ikk_sv ∩ m2_inv3a_sesK_compr ∩ m2_inv3_extrKey} 
     trans m2 
   {&gt; m2_inv5_ikk_sv}"
apply (simp add: PO_hoare_defs m2_defs, safe intro!: m2_inv5_ikk_svI)
apply (auto simp add: m2_inv3a_sesK_compr_simps dest: dom_lemmas)
done

lemma PO_m2_inv5_ikk_sv [iff]: "reach m2 ⊆ m2_inv5_ikk_sv"
by (rule_tac J="m2_inv3a_sesK_compr ∩ m2_inv3_extrKey" in inv_rule_incr) (auto)
*)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv6 (derived): Key secrecy for initiator›</span></span>
<span class="comment1">(*invd**************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This invariant is derivable (see below).›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_inv6_ikk_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_inv6_ikk_init</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Ra</span> <span class="bound">K</span> <span class="bound">Ts</span> <span class="bound">nl</span><span class="main">.</span>
     runs <span class="bound">s</span> <span class="bound">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> aKey <span class="bound">K</span> <span class="main">#</span> aNum <span class="bound">Ts</span> <span class="main">#</span> <span class="bound">nl</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">A</span> <span class="main">∈</span> good <span class="main">⟶</span> <span class="bound">B</span> <span class="main">∈</span> good <span class="main">⟶</span> 
     aKey <span class="bound">K</span> <span class="main">∈</span> extr ik0 <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="bound">K</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">Ra</span><span class="main">$</span>na<span class="main">,</span> <span class="bound">Ts</span><span class="main">)</span> <span class="main">∈</span> leak <span class="bound">s</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv6_ikk_initI <span class="main">=</span> m2_inv6_ikk_init_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv6_ikk_initE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m2_inv6_ikk_init_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv6_ikk_initD <span class="main">=</span> m2_inv6_ikk_init_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv7 (derived): Key secrecy for responder›</span></span>
<span class="comment1">(*invd**************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This invariant is derivable (see below).›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_inv7_ikk_resp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_inv7_ikk_resp</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Rb</span> <span class="bound">K</span> <span class="bound">Ts</span> <span class="bound">nl</span><span class="main">.</span>
     runs <span class="bound">s</span> <span class="bound">Rb</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> aKey <span class="bound">K</span> <span class="main">#</span> aNum <span class="bound">Ts</span> <span class="main">#</span> <span class="bound">nl</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">A</span> <span class="main">∈</span> good <span class="main">⟶</span> <span class="bound">B</span> <span class="main">∈</span> good <span class="main">⟶</span> 
     aKey <span class="bound">K</span> <span class="main">∈</span> extr ik0 <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound">Na</span><span class="main">.</span> <span class="main">(</span><span class="bound">K</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">Na</span><span class="main">,</span> <span class="bound">Ts</span><span class="main">)</span> <span class="main">∈</span> leak <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv7_ikk_respI <span class="main">=</span> m2_inv7_ikk_resp_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv7_ikk_respE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m2_inv7_ikk_resp_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv7_ikk_respD <span class="main">=</span> m2_inv7_ikk_resp_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv8: Relating M4 to the responder state›</span></span>
<span class="comment1">(*inv**************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This invariant relates message M4 from the responder to the responder's 
state. It is required in the refinement of step 6 to prove that the initiator 
agrees with the responder on (A, B, Ta, Kab).›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m2_inv8_M4</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_state set"</span></span>  
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_inv8_M4</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Kab</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Ts</span> <span class="bound">Ta</span> <span class="bound">N</span><span class="main">.</span>
     Secure Sv <span class="bound">A</span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="bound">Kab</span><span class="main">,</span> aAgt <span class="bound">B</span><span class="main">,</span> aNum <span class="bound">Ts</span><span class="main">,</span> aNon <span class="bound">N</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">⟶</span>
     dAuth <span class="bound">Kab</span> <span class="main">(</span>Msg <span class="main">[</span>aNum <span class="bound">Ta</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">⟶</span>  
     aKey <span class="bound">Kab</span> <span class="main">∉</span> extr ik0 <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="main">∃</span><span class="bound">Rb</span><span class="main">.</span> runs <span class="bound">s</span> <span class="bound">Rb</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="bound">Kab</span><span class="main">,</span> aNum <span class="bound">Ts</span><span class="main">,</span> aNum <span class="bound">Ta</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv8_M4I <span class="main">=</span> m2_inv8_M4_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv8_M4E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m2_inv8_M4_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv8_M4D <span class="main">=</span> m2_inv8_M4_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv8_M4_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m2 <span class="main">⊆</span> m2_inv8_M4"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv8_M4I<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv8_M4_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv8_M4 <span class="main">∩</span> m2_inv4_M2a <span class="main">∩</span> m2_inv4_M2b <span class="main">∩</span> m2_inv3a_sesK_compr <span class="main">∩</span> m2_inv2_keys_for<span class="main">}</span> 
      trans m2 
   <span class="main">{&gt;</span> m2_inv8_M4<span class="main">}</span>"</span></span>  
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Rs</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Kab</span> <span class="skolem">Na</span> <span class="skolem">Ts</span>
    <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv8_M4 <span class="main">∩</span> m2_inv3a_sesK_compr <span class="main">∩</span> m2_inv2_keys_for<span class="main">}</span> 
          m2_step3 <span class="skolem">Rs</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Kab</span> <span class="skolem">Na</span> <span class="skolem">Ts</span> 
       <span class="main">{&gt;</span> m2_inv8_M4<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv8_M4I<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_inv3a_sesK_compr_simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv8_M4D <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Ra</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Na</span> <span class="skolem">Kab</span> <span class="skolem">Ts</span> <span class="skolem">Ta</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv8_M4<span class="main">}</span> m2_step4 <span class="skolem">Ra</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Na</span> <span class="skolem">Kab</span> <span class="skolem">Ts</span> <span class="skolem">Ta</span> <span class="main">{&gt;</span> m2_inv8_M4<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv8_M4I<span class="main">)</span>
      <span class="comment1">― ‹1 subgoal›</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> m2_inv8_M4D<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> Rb<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Rb</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Rb</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Kab</span> <span class="skolem">Ts</span> <span class="skolem">Ta</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv8_M4 <span class="main">∩</span> m2_inv4_M2a <span class="main">∩</span> m2_inv4_M2b<span class="main">}</span> m2_step5 <span class="skolem">Rb</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Kab</span> <span class="skolem">Ts</span> <span class="skolem">Ta</span> <span class="main">{&gt;</span> m2_inv8_M4<span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv8_M4I<span class="main">)</span>
      <span class="comment1">― ‹2 subgoals›</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> m2_inv4_M2a_M2b_match<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv8_M4D<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> Rba<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Rba</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Ra</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Na</span> <span class="skolem">Kab</span> <span class="skolem">Ts</span> <span class="skolem">Ta</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv8_M4<span class="main">}</span> m2_step6 <span class="skolem">Ra</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Na</span> <span class="skolem">Kab</span> <span class="skolem">Ts</span> <span class="skolem">Ta</span> <span class="main">{&gt;</span> m2_inv8_M4<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv8_M4I<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv8_M4D<span class="main">)</span>
      <span class="comment1">― ‹1 subgoal›</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> Rb<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Rb</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv8_M4<span class="main">}</span> m2_fake <span class="main">{&gt;</span> m2_inv8_M4<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv8_M4I<span class="main">)</span>
      <span class="comment1">― ‹1 subgoal›</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> fake.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv8_M4D<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">}</span></span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_def m2_trans_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spec<span class="main">)</span>    <span class="comment1">(* use above *)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv8_M4I<span class="main">)</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_inv3a_sesK_compr_simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv8_M4D <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv8_M4 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m2_inv8_M4"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> J<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"m2_inv4_M2a <span class="main">∩</span> m2_inv4_M2b <span class="main">∩</span> m2_inv3a_sesK_compr <span class="main">∩</span> m2_inv2_keys_for"</span></span> 
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> inv_rule_incr<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv9a: Relating the initiator state to M2a›</span></span>
<span class="comment1">(*inv**************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m2_inv9a_init_M2a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_inv9a_init_M2a</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Ra</span> <span class="bound">Kab</span> <span class="bound">Ts</span> <span class="bound">z</span><span class="main">.</span>
     runs <span class="bound">s</span> <span class="bound">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> aKey <span class="bound">Kab</span> <span class="main">#</span> aNum <span class="bound">Ts</span> <span class="main">#</span> <span class="bound">z</span><span class="main">)</span> <span class="main">⟶</span>
       Secure Sv <span class="bound">A</span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="bound">Kab</span><span class="main">,</span> aAgt <span class="bound">B</span><span class="main">,</span> aNum <span class="bound">Ts</span><span class="main">,</span> aNon <span class="main">(</span><span class="bound">Ra</span><span class="main">$</span>na<span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="bound">s</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv9a_init_M2aI <span class="main">=</span> m2_inv9a_init_M2a_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv9a_init_M2aE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m2_inv9a_init_M2a_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv9a_init_M2aD <span class="main">=</span> m2_inv9a_init_M2a_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv9a_init_M2a_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m2 <span class="main">⊆</span> m2_inv9a_init_M2a"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv9a_init_M2aI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv9a_init_M2a_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv9a_init_M2a<span class="main">}</span> trans m2 <span class="main">{&gt;</span> m2_inv9a_init_M2a<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv9a_init_M2aI 
              <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m2_inv9a_init_M2aD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv9a_init_M2a <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m2_inv9a_init_M2a"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_incr<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv9: Relating M3 to the initiator state›</span></span>
<span class="comment1">(*inv**************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This invariant relates message M3 to the initiator's state. It is 
required in step 5 of the refinement to prove that the initiator agrees with 
the responder on (A, B, Ta, Kab).›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m2_inv9_M3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_state set"</span></span>  
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_inv9_M3</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Kab</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Ts</span> <span class="bound">Ta</span><span class="main">.</span>
     Secure Sv <span class="bound">B</span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="bound">Kab</span><span class="main">,</span> aAgt <span class="bound">A</span><span class="main">,</span> aNum <span class="bound">Ts</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">⟶</span>
     dAuth <span class="bound">Kab</span> <span class="main">(</span>Msg <span class="main">[</span>aAgt <span class="bound">A</span><span class="main">,</span> aNum <span class="bound">Ta</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">⟶</span> 
     aKey <span class="bound">Kab</span> <span class="main">∉</span> extr ik0 <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span> <span class="comment1">⌦‹A ∉ bad ⟶ B ∉ bad ⟶›</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound">Ra</span> <span class="bound">nl</span><span class="main">.</span> runs <span class="bound">s</span> <span class="bound">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> aKey <span class="bound">Kab</span> <span class="main">#</span> aNum <span class="bound">Ts</span> <span class="main">#</span> aNum <span class="bound">Ta</span> <span class="main">#</span> <span class="bound">nl</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv9_M3I <span class="main">=</span> m2_inv9_M3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv9_M3E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m2_inv9_M3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv9_M3D <span class="main">=</span> m2_inv9_M3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv9_M3_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m2 <span class="main">⊆</span> m2_inv9_M3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv9_M3I<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv9_M3_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv9_M3 <span class="main">∩</span> m2_inv4_M2a <span class="main">∩</span> m2_inv4_M2b <span class="main">∩</span> m2_inv3a_sesK_compr <span class="main">∩</span> m2_inv2_keys_for<span class="main">}</span> 
      trans m2 
   <span class="main">{&gt;</span> m2_inv9_M3<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
<span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Rs</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Kab</span> <span class="skolem">Na</span> <span class="skolem">Ts</span>
  <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv9_M3 <span class="main">∩</span> m2_inv3a_sesK_compr <span class="main">∩</span> m2_inv2_keys_for<span class="main">}</span> 
        m2_step3 <span class="skolem">Rs</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Kab</span> <span class="skolem">Na</span> <span class="skolem">Ts</span> 
     <span class="main">{&gt;</span> m2_inv9_M3<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv9_M3I<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_inv3a_sesK_compr_simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv9_M3D <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Ra</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Na</span> <span class="skolem">Kab</span> <span class="skolem">Ts</span> <span class="skolem">Ta</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv9_M3 <span class="main">∩</span> m2_inv4_M2a <span class="main">∩</span> m2_inv4_M2b<span class="main">}</span> m2_step4 <span class="skolem">Ra</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Na</span> <span class="skolem">Kab</span> <span class="skolem">Ts</span> <span class="skolem">Ta</span> <span class="main">{&gt;</span> m2_inv9_M3<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv9_M3I<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m2_inv4_M2a_M2b_match<span class="main">)</span>
    <span class="comment1">― ‹1 subgoal›</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> m2_inv9_M3D<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Raa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Rb</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Kab</span> <span class="skolem">Ts</span> <span class="skolem">Ta</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv9_M3<span class="main">}</span> m2_step5 <span class="skolem">Rb</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Kab</span> <span class="skolem">Ts</span> <span class="skolem">Ta</span> <span class="main">{&gt;</span> m2_inv9_M3<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv9_M3I<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv9_M3D <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>
    <span class="comment1">― ‹2 subgoals›</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spec <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main">)</span>    <span class="comment1">― ‹witness Na in both cases›</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Ra</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Na</span> <span class="skolem">Kab</span> <span class="skolem">Ts</span> <span class="skolem">Ta</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv9_M3<span class="main">}</span> m2_step6 <span class="skolem">Ra</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Na</span> <span class="skolem">Kab</span> <span class="skolem">Ts</span> <span class="skolem">Ta</span> <span class="main">{&gt;</span> m2_inv9_M3<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv9_M3I<span class="main">)</span>
    <span class="comment1">― ‹1 subgoals›</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv9_M3D <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> Raa nl<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">Raa</span> <span class="main">=</span> <span class="skolem">Ra</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv9_M3<span class="main">}</span> m2_fake <span class="main">{&gt;</span> m2_inv9_M3<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv9_M3I<span class="main">)</span>
    <span class="comment1">― ‹1 subgoals›</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> fake.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_def m2_trans_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spec<span class="main">)</span>     <span class="comment1">(* use above *)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv9_M3I<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_inv3a_sesK_compr_simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv9_M3D <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv9_M3 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m2_inv9_M3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> J<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"m2_inv4_M2a <span class="main">∩</span> m2_inv4_M2b <span class="main">∩</span> m2_inv3a_sesK_compr <span class="main">∩</span> m2_inv2_keys_for"</span></span> 
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> inv_rule_incr<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The simulation relation. This is a pure superposition refinement.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R12</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m1_state <span class="main">×</span> m2_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R12</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> runs <span class="bound">s</span> <span class="main">=</span> runs <span class="bound">t</span> <span class="main">∧</span> leak <span class="bound">s</span> <span class="main">=</span> leak <span class="bound">t</span> <span class="main">∧</span> clk <span class="bound">s</span> <span class="main">=</span> clk <span class="bound">t</span> <span class="main">∧</span> cache <span class="bound">s</span> <span class="main">=</span> cache <span class="bound">t</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The mediator function is the identity.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">med21</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_obs <span class="main">⇒</span> m1_obs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med21</span> <span class="main">=</span> id"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_step1_refines_m1_step1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12<span class="main">}</span> 
     <span class="main">(</span>m1_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m2_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R12<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12_def m2_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_step2_refines_m1_step2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12<span class="main">}</span> 
     <span class="main">(</span>m1_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m2_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span>
   <span class="main">{&gt;</span> R12<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12_def m2_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_step3_refines_m1_step3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12<span class="main">}</span> 
     <span class="main">(</span>m1_step3 <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Na</span> <span class="free">Ts</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m2_step3 <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Na</span> <span class="free">Ts</span><span class="main">)</span>
   <span class="main">{&gt;</span> R12<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12_def m2_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_step4_refines_m1_step4<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12 <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">(</span>m2_inv4_M2a <span class="main">∩</span> m2_inv3_extrKey<span class="main">)</span><span class="main">}</span> 
     <span class="main">(</span>m1_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m2_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span>  
   <span class="main">{&gt;</span> R12<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12_def m2_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m2_inv34_M2a_authorized<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_step5_refines_m1_step5<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12 <span class="main">∩</span> UNIV 
        <span class="main">×</span> <span class="main">(</span>m2_inv9_M3 <span class="main">∩</span> m2_inv5_ikk_sv <span class="main">∩</span> m2_inv4_M2b <span class="main">∩</span> m2_inv3_extrKey <span class="main">∩</span> m2_inv3b_leak<span class="main">)</span><span class="main">}</span> 
     <span class="main">(</span>m1_step5 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m2_step5 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R12<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12_def m2_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m2_inv34_M2b_authorized<span class="main">)</span>
<span class="comment1">― ‹1 subgoal›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> m2_inv4_M2bD<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m2_inv9_M3D m2_inv5_ikk_svD <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> m2_inv3b_leakD<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_step6_refines_m1_step6<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12 <span class="main">∩</span> UNIV 
        <span class="main">×</span> <span class="main">(</span>m2_inv9a_init_M2a <span class="main">∩</span> m2_inv8_M4 <span class="main">∩</span> m2_inv5_ikk_sv <span class="main">∩</span> m2_inv4_M2a <span class="main">∩</span> m2_inv3b_leak<span class="main">)</span><span class="main">}</span> 
     <span class="main">(</span>m1_step6 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m2_step6 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R12<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12_def m2_defs<span class="main">)</span>
<span class="comment1">― ‹1 subgoal›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> m2_inv9a_init_M2aD <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> m2_inv4_M2aD<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m2_inv9a_init_M2aD <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> m2_inv8_M4D<span class="main"><span class="main">]</span></span> m2_inv5_ikk_svD <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> m2_inv3b_leakD<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_tick_refines_m1_tick<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12<span class="main">}</span>
    <span class="main">(</span>m1_tick <span class="free">T</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m2_tick <span class="free">T</span><span class="main">)</span>
   <span class="main">{&gt;</span> R12<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12_def m2_defs<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_purge_refines_m1_purge<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12<span class="main">}</span>
    <span class="main">(</span>m1_purge <span class="free">A</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m2_purge <span class="free">A</span><span class="main">)</span>
   <span class="main">{&gt;</span> R12<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12_def m2_defs<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_leak_refines_leak<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12<span class="main">}</span> 
     m1_leak <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Ts</span><span class="main">,</span> m2_leak <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Ts</span>
   <span class="main">{&gt;</span> R12<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12_def m2_defs <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_fake_refines_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12<span class="main">}</span> 
     Id<span class="main">,</span> m2_fake
   <span class="main">{&gt;</span> R12<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12_def m2_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All together now...›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_m2_trans_refines_m1_trans <span class="main">=</span> 
  PO_m2_step1_refines_m1_step1 PO_m2_step2_refines_m1_step2
  PO_m2_step3_refines_m1_step3 PO_m2_step4_refines_m1_step4
  PO_m2_step5_refines_m1_step5 PO_m2_step6_refines_m1_step6 
  PO_m2_tick_refines_m1_tick PO_m2_purge_refines_m1_purge
  PO_m2_leak_refines_leak PO_m2_fake_refines_skip 

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_refines_init_m1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m2 <span class="main">⊆</span> R12<span class="main">``</span><span class="main">(</span>init m1<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R12_def m1_defs m2_loc_defs<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> PO_m2_refines_trans_m1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12 <span class="main">∩</span> 
    UNIV <span class="main">×</span> <span class="main">(</span>m2_inv9_M3 <span class="main">∩</span> m2_inv9a_init_M2a <span class="main">∩</span> m2_inv8_M4 <span class="main">∩</span> 
            m2_inv4_M2b <span class="main">∩</span> m2_inv4_M2a <span class="main">∩</span> m2_inv3_extrKey <span class="main">∩</span> m2_inv3b_leak<span class="main">)</span><span class="main">}</span> 
     <span class="main">(</span>trans m1<span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans m2<span class="main">)</span> 
   <span class="main">{&gt;</span> R12<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="comment1">― ‹derive invariant <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"m2_inv5_ikk_sv"</span><span class="antiquote">}</span></span> from <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"m2_inv3_extrKey"</span><span class="antiquote">}</span></span>›</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?pre'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"R12 <span class="main">∩</span> 
    UNIV <span class="main">×</span> <span class="main">(</span>m2_inv9_M3 <span class="main">∩</span> m2_inv9a_init_M2a <span class="main">∩</span> m2_inv8_M4 <span class="main">∩</span> m2_inv5_ikk_sv <span class="main">∩</span>
            m2_inv4_M2b <span class="main">∩</span> m2_inv4_M2a <span class="main">∩</span> m2_inv3_extrKey <span class="main">∩</span> m2_inv3b_leak<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="var">?pre</span><span class="main">}</span> <span class="var">?t1</span><span class="main">,</span> <span class="var">?t2</span> <span class="main">{&gt;</span><span class="var">?post</span><span class="main">}</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> relhoare_conseq_left<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?pre</span> <span class="main">⊆</span> <span class="var">?pre'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> m2_inv5_ikk_sv_derived<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="var">?pre'</span><span class="main">}</span> <span class="var">?t1</span><span class="main">,</span> <span class="var">?t2</span> <span class="main">{&gt;</span> <span class="var">?post</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_def m2_trans_def m1_def m1_trans_def<span class="main">)</span>
         <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_m2_trans_refines_m1_trans<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1"><span class="command">lemma</span></span> PO_obs_consistent_R12 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"obs_consistent R12 med21 m1 m2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R12_def med21_def m2_defs<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement result.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m2_refines_m1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"refines 
     <span class="main">(</span>R12 <span class="main">∩</span> 
      <span class="main">(</span>UNIV <span class="main">×</span> 
       <span class="main">(</span>m2_inv9_M3 <span class="main">∩</span> m2_inv9a_init_M2a <span class="main">∩</span> m2_inv8_M4 <span class="main">∩</span> 
        m2_inv4_M2b <span class="main">∩</span> m2_inv4_M2a <span class="main">∩</span> m2_inv3_extrKey <span class="main">∩</span> m2_inv3b_leak <span class="main">∩</span> 
        m2_inv3a_sesK_compr <span class="main">∩</span> m2_inv2_keys_for <span class="main">∩</span> m2_inv1_keys<span class="main">)</span><span class="main">)</span><span class="main">)</span>
     med21 m1 m2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Refinement_using_invariants<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> m2_implements_m1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"implements med21 m1 m2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refinement_soundness<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Inherited and derived invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Show preservation of invariants <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"m1_inv2i_serv"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"m1_inv2r_serv"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>m1›</span></span></span></span>.›</span></span>

<span class="comment1">(*invh*************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_sat_m1_inv2i_serv <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m1_inv2i_serv"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Pa<span class="main"><span class="main">=</span></span><span class="quoted">m1_inv2i_serv</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Qa<span class="main"><span class="main">=</span></span><span class="quoted">m1_inv2i_serv</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Q<span class="main"><span class="main">=</span></span><span class="quoted">m1_inv2i_serv</span> 
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> m2_implements_m1 <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>5<span class="main"><span class="main">]</span></span> internal_invariant_translation<span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_loc_defs med21_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m1_inv2i_servI<span class="main">)</span>

<span class="comment1">(*invh*************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_sat_m1_inv2r_serv <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m1_inv2r_serv"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Pa<span class="main"><span class="main">=</span></span><span class="quoted">m1_inv2r_serv</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Qa<span class="main"><span class="main">=</span></span><span class="quoted">m1_inv2r_serv</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Q<span class="main"><span class="main">=</span></span><span class="quoted">m1_inv2r_serv</span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> m2_implements_m1 <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>5<span class="main"><span class="main">]</span></span> internal_invariant_translation<span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_loc_defs med21_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m1_inv2r_servI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now we derive the L2 key secrecy invariants for the initiator and the responder 
(see above for the definitions).›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv6_init_ikk <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m2_inv6_ikk_init"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m1_inv2i_serv <span class="main">∩</span> m2_inv5_ikk_sv"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> m2_inv6_ikk_init"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv6_ikk_initI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m2_inv5_ikk_svD<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv6_resp_ikk <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m2_inv7_ikk_resp"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m1_inv2r_serv <span class="main">∩</span> m2_inv5_ikk_sv"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> m2_inv7_ikk_resp"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv7_ikk_respI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m2_inv5_ikk_svD<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="m3_kerberos_par">
<div class="head">
<h1>Theory m3_kerberos_par</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Development of Security Protocols by Refinement

  Module:  Key_establish/m3_kerberos_par.thy (Isabelle/HOL 2016-1)
  ID:      $Id: m3_kerberos_par.thy 132890 2016-12-24 10:25:57Z csprenge $
  Authors: Ivano Somaini, ETH Zurich &lt;somainii@student.ethz.ch&gt;
           Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;

  Key distribution protocols
  Third refinement: parallel version of core Kerberos protocol

  Copyright (c) 2009-2016 Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Core Kerberos, "parallel" variant (L3)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> m3_kerberos_par <span class="keyword2"><span class="keyword">imports</span></span> <a href="m2_kerberos.html">m2_kerberos</a> <span class="quoted">"<a href="Message.html">../Refinement/Message</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
We model a direct implementation of the channel-based core Kerberos protocol
at Level 2 without ticket forwarding:
\[
\begin{array}{lll}
  \mathrm{M1.} &amp; A \rightarrow S: &amp; A, B, Na \\ 
  \mathrm{M2a.} &amp; S \rightarrow A: &amp; \{Kab, B, Ts, Na\}_{Kas} \\
  \mathrm{M2b.} &amp; S \rightarrow B: &amp; \{Kab, A, Ts\}_{Kbs} \\
  \mathrm{M3.} &amp; A \rightarrow B: &amp; \{A, Ta\}_{Kab} \\
  \mathrm{M4.} &amp; B \rightarrow A: &amp; \{Ta\}_{Kab} \\
\end{array}
\]
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Proof tool configuration. Avoid annoying automatic unfolding of
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>dom›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">declare</span></span> domIff <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">iff</span> <span class="quasi_keyword">del</span><span class="main">]</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Setup›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now we can define the initial key knowledge.›</span></span>

<span class="keyword1"><span class="command">overloading</span></span> ltkeySetup' <span class="main">≡</span> <span class="quoted">ltkeySetup</span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> ltkeySetup_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ltkeySetup'</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span>sharK <span class="bound">C</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span> <span class="main">|</span> <span class="bound">C</span> <span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">=</span> <span class="bound">C</span> <span class="main">∨</span> <span class="bound">A</span> <span class="main">=</span> Sv<span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> corrKey_shrK_bad <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"corrKey <span class="main">=</span> shrK<span class="main">`</span>bad"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> keySetup_def ltkeySetup_def corrKey_def<span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹State›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The secure channels are star-shaped to/from the server.  Therefore,
we have only one agent in the relation.›</span></span>

<span class="keyword1"><span class="command">record</span></span> m3_state <span class="main">=</span> <span class="quoted"><span class="quoted">"m1_state"</span></span> <span class="main">+</span>
  IK <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set"</span></span>                                <span class="comment1">― ‹intruder knowledge›</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Observable state:
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"runs"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"leak"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"clk"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"cache"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  m3_obs <span class="main">=</span> <span class="quoted"><span class="quoted">"m2_obs"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_obs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_state <span class="main">⇒</span> m3_obs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_obs</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> runs <span class="main">=</span> runs <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> leak <span class="main">=</span> leak <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> clk <span class="main">=</span> clk <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> cache <span class="main">=</span> cache <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  m3_pred <span class="main">=</span> <span class="quoted"><span class="quoted">"m3_state set"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  m3_trans <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m3_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Events›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Protocol events.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">A</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m2_step1"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_step1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step1</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>                  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Ra›</span></span> is fresh›</span>
    <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>na <span class="main">∧</span>                         <span class="comment1">― ‹generated nonce›</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      IK <span class="main">:=</span> insert <span class="main">⦃</span>Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Nonce <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">⦄</span> <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span>   <span class="comment1">― ‹send <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M1›</span></span>›</span>
    <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">B</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m2_step2"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_step2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step2</span> <span class="main">≡</span> m1_step2"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"Server"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m2_step3</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_step3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> key<span class="main">,</span> nonce<span class="main">,</span> time<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step3</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>
     <span class="comment1">― ‹guards:›</span>
     <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>                          <span class="comment1">― ‹fresh server run›</span>
     <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">=</span> sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span>                          <span class="comment1">― ‹fresh session key›</span>

     <span class="main">⦃</span>Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Nonce <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">⦄</span> <span class="main">∈</span> IK <span class="bound">s</span> <span class="main">∧</span>         <span class="comment1">― ‹recv <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M1›</span></span>›</span>
     <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">=</span> clk <span class="bound">s</span> <span class="main">∧</span>                                  <span class="comment1">― ‹fresh timestamp›</span>

     <span class="comment1">― ‹actions:›</span>
     <span class="comment1">― ‹record session key and send <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M2›</span></span>›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
       runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">↦</span> <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
       IK <span class="main">:=</span> insert <span class="main">(</span>Crypt <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">⦃</span>Key <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Number <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span> Nonce <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">⦄</span><span class="main">)</span>
             <span class="main">(</span>insert <span class="main">(</span>Crypt <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">⦃</span>Key <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span>  Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Number <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">⦄</span><span class="main">)</span>  <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span><span class="main">)</span>
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">A</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m2_step4</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_step4</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> key<span class="main">,</span> time<span class="main">,</span> time<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step4</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>
     <span class="comment1">― ‹guards:›</span>
     runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>           <span class="comment1">― ‹key not yet recv'd›</span>
     <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>na <span class="main">∧</span>                                     <span class="comment1">― ‹generated nonce›</span>

     Crypt <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>                                  <span class="comment1">― ‹recv <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M2a›</span></span>›</span>
       <span class="main">⦃</span>Key <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Number <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span> Nonce <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">⦄</span> <span class="main">∈</span> IK <span class="bound">s</span> <span class="main">∧</span>

     <span class="comment1">― ‹read current time›</span>
     <span class="free"><span class="bound"><span class="entity">Ta</span></span></span> <span class="main">=</span> clk <span class="bound">s</span> <span class="main">∧</span>

     <span class="comment1">― ‹check freshness of session key›</span>
     clk <span class="bound">s</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">+</span> Ls <span class="main">∧</span>

     <span class="comment1">― ‹actions:›</span>
     <span class="comment1">― ‹record session key and send <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M3›</span></span>›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
       runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
       IK <span class="main">:=</span> insert <span class="main">(</span>Crypt <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">⦃</span>Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Number <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">⦄</span><span class="main">)</span> <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span>  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M3›</span></span>›</span>
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">B</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m2_step5</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_step5</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> key<span class="main">,</span> time<span class="main">,</span> time<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step5</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>
     <span class="comment1">― ‹guards:›</span>
     runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>             <span class="comment1">― ‹key not yet recv'd›</span>

     Crypt <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">⦃</span>Key <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Number <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">⦄</span> <span class="main">∈</span> IK <span class="bound">s</span> <span class="main">∧</span>   <span class="comment1">― ‹recv <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M2b›</span></span>›</span>
     Crypt <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">⦃</span>Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Number <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">⦄</span> <span class="main">∈</span> IK <span class="bound">s</span> <span class="main">∧</span>                 <span class="comment1">― ‹recv <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M3›</span></span>›</span>

     <span class="comment1">― ‹ensure freshness of session key›</span>
     clk <span class="bound">s</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">+</span> Ls <span class="main">∧</span>

     <span class="comment1">― ‹check authenticator's validity and replay; 'replays' with fresh authenticator ok!›</span>
     clk <span class="bound">s</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span> <span class="main">+</span> La <span class="main">∧</span>
     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">)</span> <span class="main">∉</span> cache <span class="bound">s</span> <span class="main">∧</span>

     <span class="comment1">― ‹actions:›</span>
     <span class="comment1">― ‹record session key›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
       runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
       cache <span class="main">:=</span> insert <span class="main">(</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">)</span> <span class="main">(</span>cache <span class="bound">s</span><span class="main">)</span><span class="main">,</span>
       IK <span class="main">:=</span> insert <span class="main">(</span>Crypt <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">(</span>Number <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span>              <span class="comment1">― ‹send <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M4›</span></span>›</span>
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">A</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m2_step6</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_step6</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> key<span class="main">,</span> time<span class="main">,</span> time<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step6</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
     <span class="comment1">― ‹guards:›</span>
     runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span>  <span class="comment1">― ‹knows key›</span>
     <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>na <span class="main">∧</span>                                    <span class="comment1">― ‹generated nonce›</span>
     clk <span class="bound">s</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">+</span> Ls <span class="main">∧</span>                               <span class="comment1">― ‹check session key's recentness›</span>

     Crypt <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">(</span>Number <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">)</span> <span class="main">∈</span> IK <span class="bound">s</span> <span class="main">∧</span>                  <span class="comment1">― ‹recv <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M4›</span></span>›</span>

     <span class="comment1">― ‹actions:›</span>
     <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
        runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">,</span> END<span class="main">]</span><span class="main">)</span><span class="main">)</span>
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Clock tick event›</span></span>

<span class="keyword1"><span class="command">definition</span></span>   <span class="comment1">― ‹refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m2_tick"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_tick</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"time <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_tick</span> <span class="main">≡</span> m1_tick"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Purge event: purge cache of expired timestamps›</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m2_purge"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_purge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_purge</span> <span class="main">≡</span> m1_purge"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Session key compromise.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m2_leak</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_leak</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> time<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_leak</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span>clk <span class="bound">s</span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">+</span> Ls<span class="main">)</span> <span class="main">∧</span>             <span class="comment1">― ‹only compromise 'old' session keys!›</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="comment1">― ‹record session key as leaked and add it to intruder knowledge›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> leak <span class="main">:=</span> insert <span class="main">(</span>sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">)</span> <span class="main">(</span>leak <span class="bound">s</span><span class="main">)</span><span class="main">,</span>
            IK <span class="main">:=</span> insert <span class="main">(</span>Key <span class="main">(</span>sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span> <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Intruder fake event. The following "Dolev-Yao" event generates all
intruder-derivable messages.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m2_fake"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_DY_fake</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_DY_fake</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>

     <span class="comment1">― ‹actions:›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">(|</span> IK <span class="main">:=</span> synth <span class="main">(</span>analz <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">|)</span>       <span class="comment1">― ‹take DY closure›</span>
  <span class="main">}</span>"</span></span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Transition system›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_init</span> <span class="main">≡</span> <span class="main">{</span> <span class="main">⦇</span>
     runs <span class="main">=</span> Map.empty<span class="main">,</span>
     leak <span class="main">=</span> shrK<span class="main">`</span>bad <span class="main">×</span> <span class="main">{</span>undefined<span class="main">}</span><span class="main">,</span>
     clk <span class="main">=</span> <span class="main">0</span><span class="main">,</span>
     cache <span class="main">=</span> <span class="main">{}</span><span class="main">,</span>
     IK <span class="main">=</span> Key<span class="main">`</span>shrK<span class="main">`</span>bad
  <span class="main">⦈</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_trans"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_trans</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Ra</span> <span class="bound">Rb</span> <span class="bound">Rs</span> <span class="bound">Na</span> <span class="bound">Kab</span> <span class="bound">Ts</span> <span class="bound">Ta</span> <span class="bound">T</span><span class="main">.</span>
     m3_step1 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="main">∪</span>
     m3_step2 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">∪</span>
     m3_step3 <span class="bound">Rs</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Kab</span> <span class="bound">Na</span> <span class="bound">Ts</span> <span class="main">∪</span>
     m3_step4 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Kab</span> <span class="bound">Ts</span> <span class="bound">Ta</span> <span class="main">∪</span>
     m3_step5 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Kab</span> <span class="bound">Ts</span> <span class="bound">Ta</span> <span class="main">∪</span>
     m3_step6 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Kab</span> <span class="bound">Ts</span> <span class="bound">Ta</span> <span class="main">∪</span>
     m3_tick <span class="bound">T</span> <span class="main">∪</span>
     m3_purge <span class="bound">A</span> <span class="main">∪</span>
     m3_leak <span class="bound">Rs</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Ts</span> <span class="main">∪</span>
     m3_DY_fake <span class="main">∪</span>
     Id
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m3_state<span class="main">,</span> m3_obs<span class="main">)</span> spec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3</span> <span class="main">≡</span> <span class="main">⦇</span>
    init <span class="main">=</span> m3_init<span class="main">,</span>
    trans <span class="main">=</span> m3_trans<span class="main">,</span>
    obs <span class="main">=</span> m3_obs
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_loc_defs <span class="main">=</span>
  m3_def m3_init_def m3_trans_def m3_obs_def
  m3_step1_def m3_step2_def m3_step3_def m3_step4_def m3_step5_def
  m3_step6_def m3_tick_def m3_purge_def m3_leak_def m3_DY_fake_def

<span class="keyword1"><span class="command">lemmas</span></span> m3_defs <span class="main">=</span> m3_loc_defs m2_defs


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Specialized injection that we can apply more aggressively.›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> analz_Inj_IK <span class="main">=</span> analz.Inj <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"IK <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">s</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> parts_Inj_IK <span class="main">=</span> parts.Inj <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"IK <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">s</span><span class="main">]</span>

<span class="keyword1"><span class="command">declare</span></span> parts_Inj_IK <span class="main">[</span><span class="operator">dest</span><span class="main"><span class="main">!</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">declare</span></span> analz_into_parts <span class="main">[</span><span class="operator">dest</span><span class="main">]</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv1: Secrecy of pre-distributed shared keys›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹inv1: Secrecy of long-term keys›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_inv1_lkeysec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_inv1_lkeysec</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">C</span><span class="main">.</span>
     <span class="main">(</span>Key <span class="main">(</span>shrK <span class="bound">C</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">C</span> <span class="main">∈</span> bad<span class="main">)</span> <span class="main">∧</span>
     <span class="main">(</span><span class="bound">C</span> <span class="main">∈</span> bad <span class="main">⟶</span> Key <span class="main">(</span>shrK <span class="bound">C</span><span class="main">)</span> <span class="main">∈</span> IK <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_inv1_lkeysecI <span class="main">=</span> m3_inv1_lkeysec_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv1_lkeysecE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m3_inv1_lkeysec_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv1_lkeysec_dest <span class="main">=</span> m3_inv1_lkeysec_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv1_lkeysec_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m3 <span class="main">⊆</span> m3_inv1_lkeysec"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv1_lkeysecI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv1_lkeysec_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m3_inv1_lkeysec<span class="main">}</span> trans m3 <span class="main">{&gt;</span> m3_inv1_lkeysec<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv1_lkeysecI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv1_lkeysec <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m3 <span class="main">⊆</span> m3_inv1_lkeysec"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">fast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Useful simplifier lemmas›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m3_inv1_lkeysec_for_parts <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">s</span> <span class="main">∈</span> m3_inv1_lkeysec <span class="main">⟧</span> <span class="main">⟹</span> Key <span class="main">(</span>shrK <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>IK <span class="free">s</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">C</span> <span class="main">∈</span> bad"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> m3_inv1_lkeysec_for_analz <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">s</span> <span class="main">∈</span> m3_inv1_lkeysec <span class="main">⟧</span> <span class="main">⟹</span> Key <span class="main">(</span>shrK <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="free">s</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">C</span> <span class="main">∈</span> bad"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv7a: Session keys not used to encrypt other session keys›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Session keys are not used to encrypt other keys. Proof requires
generalization to sets of session keys.

NOTE: This invariant will be derived from the corresponding L2 invariant
using the simulation relation.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_inv7a_sesK_compr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_inv7a_sesK_compr</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">K</span> <span class="bound">KK</span><span class="main">.</span>
     <span class="bound">KK</span> <span class="main">⊆</span> range sesK <span class="main">⟶</span>
     <span class="main">(</span>Key <span class="bound">K</span> <span class="main">∈</span> analz <span class="main">(</span>Key<span class="main">`</span><span class="bound">KK</span> <span class="main">∪</span> <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">K</span> <span class="main">∈</span> <span class="bound">KK</span> <span class="main">∨</span> Key <span class="bound">K</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_inv7a_sesK_comprI <span class="main">=</span> m3_inv7a_sesK_compr_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv7a_sesK_comprE <span class="main">=</span> m3_inv7a_sesK_compr_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv7a_sesK_comprD <span class="main">=</span> m3_inv7a_sesK_compr_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Additional lemma›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> insert_commute_Key <span class="main">=</span> insert_commute <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Key <span class="free">K</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">K</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_inv7a_sesK_compr_simps <span class="main">=</span>
  m3_inv7a_sesK_comprD
  m3_inv7a_sesK_comprD <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">Kab</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">Kab</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  m3_inv7a_sesK_comprD <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"insert <span class="free">Kab</span> <span class="free">KK</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">Kab</span> <span class="free">KK</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  insert_commute_Key


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Message abstraction and simulation relation›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Abstraction function on sets of messages.›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span>
  <span class="entity">abs_msg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set <span class="main">⇒</span> chmsg set"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">H</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  am_M1<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⦃</span>Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Nonce <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">⦄</span> <span class="main">∈</span> <span class="free">H</span>
  <span class="main">⟹</span> Insec <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">abs_msg</span> <span class="free">H</span>"</span></span>
<span class="main">|</span> am_M2a<span class="main">:</span>
    <span class="quoted"><span class="quoted">"Crypt <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">⦃</span>Key <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Number <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">,</span> Nonce <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">⦄</span> <span class="main">∈</span> <span class="free">H</span>
  <span class="main">⟹</span> Secure Sv <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">,</span> aAgt <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">,</span> aNon <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">abs_msg</span> <span class="free">H</span>"</span></span>
<span class="main">|</span> am_M2b<span class="main">:</span>
    <span class="quoted"><span class="quoted">"Crypt <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">⦃</span>Key <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">,</span>  Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Number <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">⦄</span> <span class="main">∈</span> <span class="free">H</span>
  <span class="main">⟹</span> Secure Sv <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">,</span> aAgt <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">abs_msg</span> <span class="free">H</span>"</span></span>
<span class="main">|</span> am_M3<span class="main">:</span>
    <span class="quoted"><span class="quoted">"Crypt <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">⦃</span>Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Number <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">⦄</span> <span class="main">∈</span> <span class="free">H</span>
  <span class="main">⟹</span> dAuth <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aAgt <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">abs_msg</span> <span class="free">H</span>"</span></span>
<span class="main">|</span> am_M4<span class="main">:</span>
    <span class="quoted"><span class="quoted">"Crypt <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">(</span>Number <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">H</span>
  <span class="main">⟹</span> dAuth <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aNum <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">abs_msg</span> <span class="free">H</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹R23: The simulation relation. This is a data refinement of
the insecure and secure channels of refinement 2.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R23_msgs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R23_msgs</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> abs_msg <span class="main">(</span>parts <span class="main">(</span>IK <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> chan <span class="bound">s</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R23_keys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R23_keys</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">KK</span> <span class="bound">K</span><span class="main">.</span> <span class="bound">KK</span> <span class="main">⊆</span> range sesK <span class="main">⟶</span>
     Key <span class="bound">K</span> <span class="main">∈</span> analz <span class="main">(</span>Key<span class="main">`</span><span class="bound">KK</span> <span class="main">∪</span> <span class="main">(</span>IK <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> aKey <span class="bound">K</span> <span class="main">∈</span> extr <span class="main">(</span>aKey<span class="main">`</span><span class="bound">KK</span> <span class="main">∪</span> ik0<span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R23_non</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R23_non</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">KK</span> <span class="bound">N</span><span class="main">.</span> <span class="bound">KK</span> <span class="main">⊆</span> range sesK <span class="main">⟶</span>
     Nonce <span class="bound">N</span> <span class="main">∈</span> analz <span class="main">(</span>Key<span class="main">`</span><span class="bound">KK</span> <span class="main">∪</span> <span class="main">(</span>IK <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> aNon <span class="bound">N</span> <span class="main">∈</span> extr <span class="main">(</span>aKey<span class="main">`</span><span class="bound">KK</span> <span class="main">∪</span> ik0<span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R23_pres</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R23_pres</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> runs <span class="bound">s</span> <span class="main">=</span> runs <span class="bound">t</span> <span class="main">∧</span> leak <span class="bound">s</span> <span class="main">=</span> leak <span class="bound">t</span> <span class="main">∧</span> clk <span class="bound">s</span> <span class="main">=</span> clk <span class="bound">t</span> <span class="main">∧</span> cache <span class="bound">s</span> <span class="main">=</span> cache <span class="bound">t</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R23</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R23</span> <span class="main">≡</span> R23_msgs <span class="main">∩</span> R23_keys <span class="main">∩</span> R23_non <span class="main">∩</span> R23_pres"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_defs <span class="main">=</span>
  R23_def R23_msgs_def R23_keys_def R23_non_def R23_pres_def


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The mediator function is the identity here.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">med32</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_obs <span class="main">⇒</span> m2_obs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med32</span> <span class="main">≡</span> id"</span></span>


<span class="keyword1"><span class="command">lemmas</span></span> R23_msgsI <span class="main">=</span> R23_msgs_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_intro<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_msgsE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> R23_msgs_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_elim<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_msgsE' <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> R23_msgs_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_dest<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">THEN</span> subsetD<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_keysI <span class="main">=</span> R23_keys_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_intro<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_keysE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> R23_keys_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_elim<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_nonI <span class="main">=</span> R23_non_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_intro<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_nonE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> R23_non_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_elim<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_presI <span class="main">=</span> R23_pres_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_intro<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_presE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> R23_pres_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_elim<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_intros <span class="main">=</span> R23_msgsI R23_keysI R23_nonI R23_presI


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Simplifier lemmas for various instantiations (keys and nonces).›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_keys_simp <span class="main">=</span> R23_keys_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_dest<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_keys_simps <span class="main">=</span>
  R23_keys_simp
  R23_keys_simp <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  R23_keys_simp <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">K'</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">K'</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  R23_keys_simp <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"insert <span class="free">K'</span> <span class="free">KK</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">K'</span> <span class="free">KK</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> _ conjI<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_non_simp <span class="main">=</span> R23_non_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_dest<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_non_simps <span class="main">=</span>
  R23_non_simp
  R23_non_simp <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  R23_non_simp <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">K</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">K</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  R23_non_simp <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"insert <span class="free">K</span> <span class="free">KK</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">K</span> <span class="free">KK</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> _ conjI<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_simps <span class="main">=</span> R23_keys_simps R23_non_simps

<span class="comment1">(*
lemmas R23_keys_emptyD =
  R23_keys_simp [where KK="{}", simplified, THEN iffD1, rotated 1]
  R23_keys_simp [where KK="{}", simplified, THEN iffD2, rotated 1]

lemmas R23_non_emptyD =
  R23_non_simp [where KK="{}", simplified, THEN iffD1, rotated 1]
  R23_non_simp [where KK="{}", simplified, THEN iffD2, rotated 1]

lemmas R23_emptyD = R23_keys_emptyD R23_non_emptyD
*)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹General lemmas›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹General facts about <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"abs_msg"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">declare</span></span> abs_msg.intros <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span></span></span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> abs_msg.cases <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main">!</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"abs_msg <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_Un <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"abs_msg <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> abs_msg <span class="free">G</span> <span class="main">∪</span> abs_msg <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_mono <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">m</span> <span class="main">∈</span> abs_msg <span class="free">G</span><span class="main">;</span> <span class="free">G</span> <span class="main">⊆</span> <span class="free">H</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">∈</span> abs_msg <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_insert_mono <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">m</span> <span class="main">∈</span> abs_msg <span class="free">H</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">∈</span> abs_msg <span class="main">(</span>insert <span class="free">m'</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Facts about <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"abs_msg"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> concerning abstraction of fakeable
messages. This is crucial for proving the refinement of the intruder event.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_DY_subset_fakeable<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> R23_msgs<span class="main">;</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> R23_keys<span class="main">;</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> R23_non<span class="main">;</span> <span class="free">t</span> <span class="main">∈</span> m3_inv1_lkeysec <span class="main">⟧</span>
  <span class="main">⟹</span> abs_msg <span class="main">(</span>synth <span class="main">(</span>analz <span class="main">(</span>IK <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> fake ik0 <span class="main">(</span>dom <span class="main">(</span>runs <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="comment1">― ‹9 subgoals, deal with replays first›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 3 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 4 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 5 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
<span class="comment1">― ‹remaining 5 subgoals are real fakes›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> fake_StatCh fake_DynCh<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23_simps<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement proof›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Pair decomposition. These were set to \texttt{elim!}, which is too
agressive here.›</span></span>

<span class="keyword1"><span class="command">declare</span></span> MPair_analz <span class="main">[</span><span class="operator">rule</span> <span class="quasi_keyword">del</span><span class="main">,</span> <span class="operator">elim</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> MPair_parts <span class="main">[</span><span class="operator">rule</span> <span class="quasi_keyword">del</span><span class="main">,</span> <span class="operator">elim</span><span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Protocol events.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step1_refines_m2_step1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
     <span class="main">(</span>m2_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step2_refines_m2_step2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
     <span class="main">(</span>m2_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step3_refines_m2_step3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23 <span class="main">∩</span> <span class="main">(</span>m2_inv3a_sesK_compr<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>m3_inv7a_sesK_compr <span class="main">∩</span> m3_inv1_lkeysec<span class="main">)</span><span class="main">}</span>
     <span class="main">(</span>m2_step3 <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Na</span> <span class="free">Ts</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step3 <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Na</span> <span class="free">Ts</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R23_msgs"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R23_keys"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R23_non"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R23_pres"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> m2_inv3a_sesK_compr"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> m3_inv7a_sesK_compr"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> m3_inv1_lkeysec"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">Kab</span> <span class="main">=</span> sesK <span class="main">(</span><span class="free">Rs</span><span class="main">$</span>sk<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Rs</span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">⦃</span> Agent <span class="free">A</span><span class="main">,</span> Agent <span class="free">B</span><span class="main">,</span> Nonce <span class="free">Na</span> <span class="main">⦄</span> <span class="main">∈</span> parts <span class="main">(</span>IK <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span><span class="main">=</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">⦇</span> runs <span class="main">:=</span> runs <span class="skolem">s</span><span class="main">(</span><span class="free">Rs</span> <span class="main">↦</span> <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="free">Na</span><span class="main">,</span> aNum <span class="main">(</span>clk <span class="skolem">t</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
          chan <span class="main">:=</span> insert <span class="main">(</span>Secure Sv <span class="free">A</span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">,</span> aAgt <span class="free">B</span><span class="main">,</span> aNum <span class="main">(</span>clk <span class="skolem">t</span><span class="main">)</span><span class="main">,</span> aNon <span class="free">Na</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
                 <span class="main">(</span>insert <span class="main">(</span>Secure Sv <span class="free">B</span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">,</span> aAgt <span class="free">A</span><span class="main">,</span> aNum <span class="main">(</span>clk <span class="skolem">t</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chan <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t'</span></span></span><span class="main">=</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">⦇</span> runs <span class="main">:=</span> runs <span class="skolem">t</span><span class="main">(</span><span class="free">Rs</span> <span class="main">↦</span> <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="free">Na</span><span class="main">,</span> aNum <span class="main">(</span>clk <span class="skolem">t</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
          IK <span class="main">:=</span> insert <span class="main">(</span>Crypt <span class="main">(</span>shrK <span class="free">A</span><span class="main">)</span> <span class="main">⦃</span> Key <span class="free">Kab</span><span class="main">,</span> Agent <span class="free">B</span><span class="main">,</span> Number <span class="main">(</span>clk <span class="skolem">t</span><span class="main">)</span><span class="main">,</span> Nonce <span class="free">Na</span> <span class="main">⦄</span><span class="main">)</span>
                <span class="main">(</span>insert <span class="main">(</span>Crypt <span class="main">(</span>shrK <span class="free">B</span><span class="main">)</span> <span class="main">⦃</span> Key <span class="free">Kab</span><span class="main">,</span> Agent <span class="free">A</span><span class="main">,</span> Number <span class="main">(</span>clk <span class="skolem">t</span><span class="main">)</span> <span class="main">⦄</span><span class="main">)</span> <span class="main">(</span>IK <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>
  <span class="comment1">― ‹here we go›</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s'</span><span class="main">,</span> <span class="var">?t'</span><span class="main">)</span> <span class="main">∈</span> R23_msgs"</span></span> <span class="keyword1"><span class="command">using</span></span> H
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> R23_intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s'</span><span class="main">,</span> <span class="var">?t'</span><span class="main">)</span> <span class="main">∈</span> R23_keys"</span></span> <span class="keyword1"><span class="command">using</span></span> H
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span>
       <span class="main">(</span><span class="operator">rule</span> R23_intros<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_inv3a_sesK_compr_simps m3_inv7a_sesK_compr_simps<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23_keys_simps<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s'</span><span class="main">,</span> <span class="var">?t'</span><span class="main">)</span> <span class="main">∈</span> R23_non"</span></span> <span class="keyword1"><span class="command">using</span></span> H
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span>
       <span class="main">(</span><span class="operator">rule</span> R23_intros<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_inv3a_sesK_compr_simps m3_inv7a_sesK_compr_simps R23_non_simps<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s'</span><span class="main">,</span> <span class="var">?t'</span><span class="main">)</span> <span class="main">∈</span> R23_pres"</span></span> <span class="keyword1"><span class="command">using</span></span> H
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> R23_intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">note</span></span> calculation
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step4_refines_m2_step4<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23 <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">(</span>m3_inv1_lkeysec<span class="main">)</span> <span class="main">}</span>
     <span class="main">(</span>m2_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step5_refines_m2_step5<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
     <span class="main">(</span>m2_step5 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step5 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step6_refines_m2_step6<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
     <span class="main">(</span>m2_step6 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step6 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_tick_refines_m2_tick<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
     <span class="main">(</span>m2_tick <span class="free">T</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_tick <span class="free">T</span><span class="main">)</span>
   <span class="main">{&gt;</span>R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_purge_refines_m2_purge<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
     <span class="main">(</span>m2_purge <span class="free">A</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_purge <span class="free">A</span><span class="main">)</span>
   <span class="main">{&gt;</span>R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Intruder events.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_leak_refines_m2_leak<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
     <span class="main">(</span>m2_leak <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Ts</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_leak <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Ts</span><span class="main">)</span>
   <span class="main">{&gt;</span>R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs R23_simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>

<span class="comment1">(* also works, but requires invariants:
apply (auto simp add: m2_inv3a_sesK_compr_simps m2_inv3b_sesK_compr_non_simps
                      m3_inv7a_sesK_compr_simps m3_inv7b_sesK_compr_non_simps
            dest: R23_emptyD)
*)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_DY_fake_refines_m2_fake<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23 <span class="main">∩</span> UNIV <span class="main">×</span> m3_inv1_lkeysec<span class="main">}</span>
     m2_fake<span class="main">,</span> m3_DY_fake
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros
            <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> abs_msg.cases<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> abs_msg_DY_subset_fakeable <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span>
            <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> abs_msg.cases<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23_simps<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All together now...›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_m3_trans_refines_m2_trans <span class="main">=</span>
  PO_m3_step1_refines_m2_step1 PO_m3_step2_refines_m2_step2
  PO_m3_step3_refines_m2_step3 PO_m3_step4_refines_m2_step4
  PO_m3_step5_refines_m2_step5 PO_m3_step6_refines_m2_step6
  PO_m3_tick_refines_m2_tick PO_m3_purge_refines_m2_purge
  PO_m3_leak_refines_m2_leak PO_m3_DY_fake_refines_m2_fake


<span class="keyword1"><span class="command">lemma</span></span> PO_m3_refines_init_m2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m3 <span class="main">⊆</span> R23<span class="main">``</span><span class="main">(</span>init m2<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_refines_trans_m2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23 <span class="main">∩</span> <span class="main">(</span>m2_inv3a_sesK_compr<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>m3_inv7a_sesK_compr <span class="main">∩</span> m3_inv1_lkeysec<span class="main">)</span><span class="main">}</span>
     <span class="main">(</span>trans m2<span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans m3<span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m3_def m3_trans_def m2_def m2_trans_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_m3_trans_refines_m2_trans<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_observation_consistent <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"obs_consistent R23 med32 m2 m3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R23_def med32_def m3_defs<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement result.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m3_refines_m2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"refines
     <span class="main">(</span>R23 <span class="main">∩</span> <span class="main">(</span>m2_inv3a_sesK_compr<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>m3_inv1_lkeysec<span class="main">)</span><span class="main">)</span>
     med32 m2 m3"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"R23 <span class="main">∩</span> m2_inv3a_sesK_compr <span class="main">×</span> UNIV <span class="main">⊆</span> UNIV <span class="main">×</span> m3_inv7a_sesK_compr"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23_def R23_keys_simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv7a_sesK_comprI<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> Refinement_using_invariants<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m3_implements_m2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"implements med32 m2 m3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refinement_soundness<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Inherited invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv3 (derived): Key secrecy for initiator›</span></span>
<span class="comment1">(*invh*************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_inv3_ikk_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_inv3_ikk_init</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Ra</span> <span class="bound">K</span> <span class="bound">Ts</span> <span class="bound">nl</span><span class="main">.</span>
     runs <span class="bound">s</span> <span class="bound">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> aKey <span class="bound">K</span> <span class="main">#</span> aNum <span class="bound">Ts</span> <span class="main">#</span> <span class="bound">nl</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">A</span> <span class="main">∈</span> good <span class="main">⟶</span> <span class="bound">B</span> <span class="main">∈</span> good <span class="main">⟶</span>
     Key <span class="bound">K</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="bound">K</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">Ra</span><span class="main">$</span>na<span class="main">,</span> <span class="bound">Ts</span><span class="main">)</span> <span class="main">∈</span> leak <span class="bound">s</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_inv3_ikk_initI <span class="main">=</span> m3_inv3_ikk_init_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv3_ikk_initE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m3_inv3_ikk_init_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv3_ikk_initD <span class="main">=</span> m3_inv3_ikk_init_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv3_ikk_init<span class="main">:</span> <span class="quoted"><span class="quoted">"reach m3 <span class="main">⊆</span> m3_inv3_ikk_init"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> INV_from_Refinement_using_invariants <span class="main"><span class="main">[</span></span><span class="operator">OF</span> m3_refines_m2<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Range <span class="main">(</span>R23 <span class="main">∩</span> m2_inv3a_sesK_compr <span class="main">×</span> m3_inv1_lkeysec <span class="main">∩</span> m2_inv6_ikk_init <span class="main">×</span> UNIV<span class="main">)</span>
      <span class="main">⊆</span> m3_inv3_ikk_init"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23_def R23_keys_simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv3_ikk_initI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv4 (derived): Key secrecy for responder›</span></span>
<span class="comment1">(*invh*************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_inv4_ikk_resp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_inv4_ikk_resp</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Rb</span> <span class="bound">K</span> <span class="bound">Ts</span> <span class="bound">nl</span><span class="main">.</span>
     runs <span class="bound">s</span> <span class="bound">Rb</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> aKey <span class="bound">K</span> <span class="main">#</span> aNum <span class="bound">Ts</span> <span class="main">#</span> <span class="bound">nl</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">A</span> <span class="main">∈</span> good <span class="main">⟶</span> <span class="bound">B</span> <span class="main">∈</span> good <span class="main">⟶</span>
     Key <span class="bound">K</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound">Na</span><span class="main">.</span> <span class="main">(</span><span class="bound">K</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">Na</span><span class="main">,</span> <span class="bound">Ts</span><span class="main">)</span> <span class="main">∈</span> leak <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_inv4_ikk_respI <span class="main">=</span> m3_inv4_ikk_resp_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv4_ikk_respE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m3_inv4_ikk_resp_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv4_ikk_respD <span class="main">=</span> m3_inv4_ikk_resp_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv4_ikk_resp<span class="main">:</span> <span class="quoted"><span class="quoted">"reach m3 <span class="main">⊆</span> m3_inv4_ikk_resp"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> INV_from_Refinement_using_invariants <span class="main"><span class="main">[</span></span><span class="operator">OF</span> m3_refines_m2<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Range <span class="main">(</span>R23 <span class="main">∩</span> m2_inv3a_sesK_compr <span class="main">×</span> m3_inv1_lkeysec <span class="main">∩</span> m2_inv7_ikk_resp <span class="main">×</span> UNIV<span class="main">)</span>
      <span class="main">⊆</span> m3_inv4_ikk_resp"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23_def R23_keys_simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv4_ikk_respI<span class="main">)</span>
       <span class="main">(</span><span class="operator">elim</span> m2_inv7_ikk_respE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="m3_kerberos5">
<div class="head">
<h1>Theory m3_kerberos5</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Development of Security Protocols by Refinement

  Module:  Key_establish/m3_kerberos5.thy (Isabelle/HOL 2016-1)
  ID:      $Id: m3_kerberos5.thy 132890 2016-12-24 10:25:57Z csprenge $
  Authors: Ivano Somaini, ETH Zurich &lt;somainii@student.ethz.ch&gt;
           Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;

  Key distribution protocols
  Third refinement: core Kerberos V

  Copyright (c) 2009-2016 Ivano Somaini, Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Core Kerberos 5 (L3)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> m3_kerberos5 <span class="keyword2"><span class="keyword">imports</span></span> <a href="m2_kerberos.html">m2_kerberos</a> <span class="quoted">"<a href="Message.html">../Refinement/Message</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
We model the core Kerberos 5 protocol:
\[
\begin{array}{lll}
  \mathrm{M1.} &amp; A \rightarrow S: &amp; A, B, Na \\ 
  \mathrm{M2.} &amp; S \rightarrow A: &amp; \{Kab, B, Ts, Na\}_{Kas}, \{Kab, A, Ts\}_{Kbs} \\
  \mathrm{M3.} &amp; A \rightarrow B: &amp; \{A, Ta\}_{Kab}, \{Kab, A, Ts\}_{Kbs} \\
  \mathrm{M4.} &amp; B \rightarrow A: &amp; \{Ta\}_{Kab} \\
\end{array}
\]
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Proof tool configuration. Avoid annoying automatic unfolding of
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>dom›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">declare</span></span> domIff <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">iff</span> <span class="quasi_keyword">del</span><span class="main">]</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Setup›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now we can define the initial key knowledge.›</span></span>

<span class="keyword1"><span class="command">overloading</span></span> ltkeySetup' <span class="main">≡</span> <span class="quoted">ltkeySetup</span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> ltkeySetup_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ltkeySetup'</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span>sharK <span class="bound">C</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span> <span class="main">|</span> <span class="bound">C</span> <span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">=</span> <span class="bound">C</span> <span class="main">∨</span> <span class="bound">A</span> <span class="main">=</span> Sv<span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> corrKey_shrK_bad <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"corrKey <span class="main">=</span> shrK<span class="main">`</span>bad"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> keySetup_def ltkeySetup_def corrKey_def<span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹State›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The secure channels are star-shaped to/from the server.  Therefore,
we have only one agent in the relation.›</span></span>

<span class="keyword1"><span class="command">record</span></span> m3_state <span class="main">=</span> <span class="quoted"><span class="quoted">"m1_state"</span></span> <span class="main">+</span>
  IK <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set"</span></span>                                <span class="comment1">― ‹intruder knowledge›</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Observable state:
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"runs"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"leak"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"clk"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"cache"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  m3_obs <span class="main">=</span> <span class="quoted"><span class="quoted">"m2_obs"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_obs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_state <span class="main">⇒</span> m3_obs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_obs</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> runs <span class="main">=</span> runs <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> leak <span class="main">=</span> leak <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> clk <span class="main">=</span> clk <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> cache <span class="main">=</span> cache <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  m3_pred <span class="main">=</span> <span class="quoted"><span class="quoted">"m3_state set"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  m3_trans <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m3_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Events›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Protocol events.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">A</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m2_step1"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_step1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step1</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>                  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Ra›</span></span> is fresh›</span>
    <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>na <span class="main">∧</span>                         <span class="comment1">― ‹generated nonce›</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      IK <span class="main">:=</span> insert <span class="main">⦃</span>Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Nonce <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">⦄</span> <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span>   <span class="comment1">― ‹send M1›</span>
    <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">B</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m2_step2"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_step2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step2</span> <span class="main">≡</span> m1_step2"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"Server"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m2_step3</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_step3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> key<span class="main">,</span> nonce<span class="main">,</span> time<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step3</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>                          <span class="comment1">― ‹fresh server run›</span>
    <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">=</span> sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span>                          <span class="comment1">― ‹fresh session key›</span>

    <span class="main">⦃</span>Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Nonce <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">⦄</span> <span class="main">∈</span> IK <span class="bound">s</span> <span class="main">∧</span>    <span class="comment1">― ‹recv <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M1›</span></span>›</span>
    <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">=</span> clk <span class="bound">s</span> <span class="main">∧</span>                                 <span class="comment1">― ‹fresh timestamp›</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="comment1">― ‹record session key and send <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M2›</span></span>›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">↦</span> <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      IK <span class="main">:=</span> insert <span class="main">⦃</span>Crypt <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">⦃</span>Key <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Number <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span> Nonce <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">⦄</span><span class="main">,</span>
                      Crypt <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">⦃</span>Key <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Number <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">⦄</span><span class="main">⦄</span>
               <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span>
    <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">A</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m2_step4</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_step4</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> key<span class="main">,</span> time<span class="main">,</span> time<span class="main">,</span> msg<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step4</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>

     <span class="comment1">― ‹guards:›</span>
     runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>           <span class="comment1">― ‹key not yet recv'd›</span>
     <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>na <span class="main">∧</span>                                    <span class="comment1">― ‹generated nonce›</span>

     <span class="main">⦃</span>Crypt <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>                               <span class="comment1">― ‹recv <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M2›</span></span>›</span>
          <span class="main">⦃</span>Key <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Number <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span> Nonce <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">⦄</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">⦄</span> <span class="main">∈</span> IK <span class="bound">s</span> <span class="main">∧</span>

     <span class="comment1">― ‹read current time›</span>
     <span class="free"><span class="bound"><span class="entity">Ta</span></span></span> <span class="main">=</span> clk <span class="bound">s</span> <span class="main">∧</span>

     <span class="comment1">― ‹check freshness of session key›</span>
     clk <span class="bound">s</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">+</span> Ls <span class="main">∧</span>

     <span class="comment1">― ‹actions:›</span>
     <span class="comment1">― ‹record session key and send <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M3›</span></span>›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
       runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
       IK <span class="main">:=</span> insert <span class="main">⦃</span>Crypt <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">⦃</span>Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Number <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">⦄</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">⦄</span> <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span>  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M3›</span></span>›</span>
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">B</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m2_step5</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_step5</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> key<span class="main">,</span> time<span class="main">,</span> time<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step5</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>
     <span class="comment1">― ‹guards:›</span>
     runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>             <span class="comment1">― ‹key not yet recv'd›</span>

     <span class="main">⦃</span>Crypt <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">⦃</span>Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Number <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">⦄</span><span class="main">,</span>            <span class="comment1">― ‹recv <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M3›</span></span>›</span>
        Crypt <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">⦃</span>Key <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Number <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">⦄</span><span class="main">⦄</span> <span class="main">∈</span> IK <span class="bound">s</span> <span class="main">∧</span>

     <span class="comment1">― ‹ensure freshness of session key›</span>
     clk <span class="bound">s</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">+</span> Ls <span class="main">∧</span>

     <span class="comment1">― ‹check authenticator's validity and replay; 'replays' with fresh authenticator ok!›</span>
     clk <span class="bound">s</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span> <span class="main">+</span> La <span class="main">∧</span>
     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">)</span> <span class="main">∉</span> cache <span class="bound">s</span> <span class="main">∧</span>

     <span class="comment1">― ‹actions:›</span>
     <span class="comment1">― ‹record session key›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
       runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
       cache <span class="main">:=</span> insert <span class="main">(</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">)</span> <span class="main">(</span>cache <span class="bound">s</span><span class="main">)</span><span class="main">,</span>
       IK <span class="main">:=</span> insert <span class="main">(</span>Crypt <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">(</span>Number <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span>              <span class="comment1">― ‹send <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M4›</span></span>›</span>
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">A</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m2_step6</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_step6</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> key<span class="main">,</span> time<span class="main">,</span> time<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step6</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
     <span class="comment1">― ‹guards:›</span>
     runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span>  <span class="comment1">― ‹knows key›</span>
     <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>na <span class="main">∧</span>                                    <span class="comment1">― ‹generated nonce›</span>
     clk <span class="bound">s</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">+</span> Ls <span class="main">∧</span>                               <span class="comment1">― ‹check session key's recentness›</span>

     Crypt <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">(</span>Number <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">)</span> <span class="main">∈</span> IK <span class="bound">s</span> <span class="main">∧</span>                  <span class="comment1">― ‹recv <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M4›</span></span>›</span>

     <span class="comment1">― ‹actions:›</span>
     <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
       runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">,</span> END<span class="main">]</span><span class="main">)</span><span class="main">)</span>
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Clock tick event›</span></span>

<span class="keyword1"><span class="command">definition</span></span>   <span class="comment1">― ‹refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m2_tick"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_tick</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"time <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_tick</span> <span class="main">≡</span> m1_tick"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Purge event: purge cache of expired timestamps›</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m2_purge"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_purge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_purge</span> <span class="main">≡</span> m1_purge"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Session key compromise.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m2_leak</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_leak</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> time<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_leak</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span>clk <span class="bound">s</span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">+</span> Ls<span class="main">)</span> <span class="main">∧</span>             <span class="comment1">― ‹only compromise 'old' session keys›</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="comment1">― ‹record session key as leaked and add it to intruder knowledge›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> leak <span class="main">:=</span> insert <span class="main">(</span>sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">)</span> <span class="main">(</span>leak <span class="bound">s</span><span class="main">)</span><span class="main">,</span>
            IK <span class="main">:=</span> insert <span class="main">(</span>Key <span class="main">(</span>sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span> <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Intruder fake event. The following "Dolev-Yao" event generates all
intruder-derivable messages.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m2_fake"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_DY_fake</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_DY_fake</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>

     <span class="comment1">― ‹actions:›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">(|</span> IK <span class="main">:=</span> synth <span class="main">(</span>analz <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">|)</span>       <span class="comment1">― ‹take DY closure›</span>
  <span class="main">}</span>"</span></span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Transition system›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_init</span> <span class="main">≡</span> <span class="main">{</span> <span class="main">⦇</span>
     runs <span class="main">=</span> Map.empty<span class="main">,</span>
     leak <span class="main">=</span> shrK<span class="main">`</span>bad <span class="main">×</span> <span class="main">{</span>undefined<span class="main">}</span><span class="main">,</span>
     clk <span class="main">=</span> <span class="main">0</span><span class="main">,</span>
     cache <span class="main">=</span> <span class="main">{}</span><span class="main">,</span>
     IK <span class="main">=</span> Key<span class="main">`</span>shrK<span class="main">`</span>bad
  <span class="main">⦈</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_trans"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_trans</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Ra</span> <span class="bound">Rb</span> <span class="bound">Rs</span> <span class="bound">Na</span> <span class="bound">Kab</span> <span class="bound">Ts</span> <span class="bound">Ta</span> <span class="bound">T</span> <span class="bound">X</span><span class="main">.</span>
     m3_step1 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="main">∪</span>
     m3_step2 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">∪</span>
     m3_step3 <span class="bound">Rs</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Kab</span> <span class="bound">Na</span> <span class="bound">Ts</span> <span class="main">∪</span>
     m3_step4 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Kab</span> <span class="bound">Ts</span> <span class="bound">Ta</span> <span class="bound">X</span> <span class="main">∪</span>
     m3_step5 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Kab</span> <span class="bound">Ts</span> <span class="bound">Ta</span> <span class="main">∪</span>
     m3_step6 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Kab</span> <span class="bound">Ts</span> <span class="bound">Ta</span> <span class="main">∪</span>
     m3_tick <span class="bound">T</span> <span class="main">∪</span>
     m3_purge <span class="bound">A</span> <span class="main">∪</span>
     m3_leak <span class="bound">Rs</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Ts</span> <span class="main">∪</span>
     m3_DY_fake <span class="main">∪</span>
     Id
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m3_state<span class="main">,</span> m3_obs<span class="main">)</span> spec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3</span> <span class="main">≡</span> <span class="main">⦇</span>
    init <span class="main">=</span> m3_init<span class="main">,</span>
    trans <span class="main">=</span> m3_trans<span class="main">,</span>
    obs <span class="main">=</span> m3_obs
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_loc_defs <span class="main">=</span>
  m3_def m3_init_def m3_trans_def m3_obs_def
  m3_step1_def m3_step2_def m3_step3_def m3_step4_def m3_step5_def
  m3_step6_def m3_tick_def m3_purge_def m3_leak_def m3_DY_fake_def

<span class="keyword1"><span class="command">lemmas</span></span> m3_defs <span class="main">=</span> m3_loc_defs m2_defs


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Specialized injection that we can apply more aggressively.›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> analz_Inj_IK <span class="main">=</span> analz.Inj <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"IK <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">s</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> parts_Inj_IK <span class="main">=</span> parts.Inj <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"IK <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">s</span><span class="main">]</span>

<span class="keyword1"><span class="command">declare</span></span> parts_Inj_IK <span class="main">[</span><span class="operator">dest</span><span class="main"><span class="main">!</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">declare</span></span> analz_into_parts <span class="main">[</span><span class="operator">dest</span><span class="main">]</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv1: Secrecy of pre-distributed shared keys›</span></span>
<span class="comment1">(*inv*************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_inv1_lkeysec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_inv1_lkeysec</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">C</span><span class="main">.</span>
     <span class="main">(</span>Key <span class="main">(</span>shrK <span class="bound">C</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">C</span> <span class="main">∈</span> bad<span class="main">)</span> <span class="main">∧</span>
     <span class="main">(</span><span class="bound">C</span> <span class="main">∈</span> bad <span class="main">⟶</span> Key <span class="main">(</span>shrK <span class="bound">C</span><span class="main">)</span> <span class="main">∈</span> IK <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_inv1_lkeysecI <span class="main">=</span> m3_inv1_lkeysec_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv1_lkeysecE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m3_inv1_lkeysec_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv1_lkeysecD <span class="main">=</span> m3_inv1_lkeysec_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv1_lkeysec_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m3 <span class="main">⊆</span> m3_inv1_lkeysec"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv1_lkeysecI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv1_lkeysec_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m3_inv1_lkeysec<span class="main">}</span> trans m3 <span class="main">{&gt;</span> m3_inv1_lkeysec<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv1_lkeysecI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv1_lkeysec <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m3 <span class="main">⊆</span> m3_inv1_lkeysec"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">fast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Useful simplifier lemmas›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m3_inv1_lkeysec_for_parts <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">s</span> <span class="main">∈</span> m3_inv1_lkeysec <span class="main">⟧</span> <span class="main">⟹</span> Key <span class="main">(</span>shrK <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>IK <span class="free">s</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">C</span> <span class="main">∈</span> bad"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> m3_inv1_lkeysec_for_analz <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">s</span> <span class="main">∈</span> m3_inv1_lkeysec <span class="main">⟧</span> <span class="main">⟹</span> Key <span class="main">(</span>shrK <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="free">s</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">C</span> <span class="main">∈</span> bad"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv2: Session keys not used to encrypt other session keys›</span></span>
<span class="comment1">(*invh*************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Session keys are not used to encrypt other keys. Proof requires
generalization to sets of session keys.

NOTE: This invariant will be inherted from the corresponding L2 invariant
using the simulation relation.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_inv2_sesK_compr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_inv2_sesK_compr</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">K</span> <span class="bound">KK</span><span class="main">.</span>
     <span class="bound">KK</span> <span class="main">⊆</span> range sesK <span class="main">⟶</span>
     <span class="main">(</span>Key <span class="bound">K</span> <span class="main">∈</span> analz <span class="main">(</span>Key<span class="main">`</span><span class="bound">KK</span> <span class="main">∪</span> <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">K</span> <span class="main">∈</span> <span class="bound">KK</span> <span class="main">∨</span> Key <span class="bound">K</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_inv2_sesK_comprI <span class="main">=</span> m3_inv2_sesK_compr_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv2_sesK_comprE <span class="main">=</span> m3_inv2_sesK_compr_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv2_sesK_comprD <span class="main">=</span> m3_inv2_sesK_compr_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Additional lemma›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> insert_commute_Key <span class="main">=</span> insert_commute <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Key <span class="free">K</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">K</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_inv2_sesK_compr_simps <span class="main">=</span>
  m3_inv2_sesK_comprD
  m3_inv2_sesK_comprD <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"insert <span class="free">Kab</span> <span class="free">KK</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">Kab</span> <span class="free">KK</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  m3_inv2_sesK_comprD <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">Kab</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">Kab</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  insert_commute_Key


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Message abstraction and simulation relation›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Abstraction function on sets of messages.›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span>
  <span class="entity">abs_msg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set <span class="main">⇒</span> chmsg set"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">H</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  am_M1<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⦃</span>Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Nonce <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">⦄</span> <span class="main">∈</span> <span class="free">H</span>
  <span class="main">⟹</span> Insec <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">abs_msg</span> <span class="free">H</span>"</span></span>
<span class="main">|</span> am_M2a<span class="main">:</span>
    <span class="quoted"><span class="quoted">"Crypt <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">⦃</span>Key <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Number <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">,</span> Nonce <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">⦄</span> <span class="main">∈</span> <span class="free">H</span>
  <span class="main">⟹</span> Secure Sv <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">,</span> aAgt <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">,</span> aNon <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">abs_msg</span> <span class="free">H</span>"</span></span>
<span class="main">|</span> am_M2b<span class="main">:</span>
    <span class="quoted"><span class="quoted">"Crypt <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">⦃</span>Key <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">,</span>  Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Number <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">⦄</span> <span class="main">∈</span> <span class="free">H</span>
  <span class="main">⟹</span> Secure Sv <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">,</span> aAgt <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">abs_msg</span> <span class="free">H</span>"</span></span>
<span class="main">|</span> am_M3<span class="main">:</span>
    <span class="quoted"><span class="quoted">"Crypt <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">⦃</span>Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Number <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">⦄</span> <span class="main">∈</span> <span class="free">H</span>
  <span class="main">⟹</span> dAuth <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aAgt <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">abs_msg</span> <span class="free">H</span>"</span></span>
<span class="main">|</span> am_M4<span class="main">:</span>
    <span class="quoted"><span class="quoted">"Crypt <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">(</span>Number <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">H</span>
  <span class="main">⟹</span> dAuth <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aNum <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">abs_msg</span> <span class="free">H</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹R23: The simulation relation. This is a data refinement of
the insecure and secure channels of refinement 2.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R23_msgs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R23_msgs</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> abs_msg <span class="main">(</span>parts <span class="main">(</span>IK <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> chan <span class="bound">s</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R23_keys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R23_keys</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">KK</span> <span class="bound">K</span><span class="main">.</span> <span class="bound">KK</span> <span class="main">⊆</span> range sesK <span class="main">⟶</span>
     Key <span class="bound">K</span> <span class="main">∈</span> analz <span class="main">(</span>Key<span class="main">`</span><span class="bound">KK</span> <span class="main">∪</span> <span class="main">(</span>IK <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> aKey <span class="bound">K</span> <span class="main">∈</span> extr <span class="main">(</span>aKey<span class="main">`</span><span class="bound">KK</span> <span class="main">∪</span> ik0<span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R23_non</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R23_non</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">KK</span> <span class="bound">N</span><span class="main">.</span> <span class="bound">KK</span> <span class="main">⊆</span> range sesK <span class="main">⟶</span>
     Nonce <span class="bound">N</span> <span class="main">∈</span> analz <span class="main">(</span>Key<span class="main">`</span><span class="bound">KK</span> <span class="main">∪</span> <span class="main">(</span>IK <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> aNon <span class="bound">N</span> <span class="main">∈</span> extr <span class="main">(</span>aKey<span class="main">`</span><span class="bound">KK</span> <span class="main">∪</span> ik0<span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R23_pres</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R23_pres</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> runs <span class="bound">s</span> <span class="main">=</span> runs <span class="bound">t</span> <span class="main">∧</span> leak <span class="bound">s</span> <span class="main">=</span> leak <span class="bound">t</span> <span class="main">∧</span> clk <span class="bound">s</span> <span class="main">=</span> clk <span class="bound">t</span> <span class="main">∧</span> cache <span class="bound">s</span> <span class="main">=</span> cache <span class="bound">t</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R23</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R23</span> <span class="main">≡</span> R23_msgs <span class="main">∩</span> R23_keys <span class="main">∩</span> R23_non <span class="main">∩</span> R23_pres"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_defs <span class="main">=</span>
  R23_def R23_msgs_def R23_keys_def R23_non_def R23_pres_def


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The mediator function is the identity here.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">med32</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_obs <span class="main">⇒</span> m2_obs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med32</span> <span class="main">≡</span> id"</span></span>


<span class="keyword1"><span class="command">lemmas</span></span> R23_msgsI <span class="main">=</span> R23_msgs_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_intro<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_msgsE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> R23_msgs_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_elim<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_msgsE' <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> R23_msgs_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_dest<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">THEN</span> subsetD<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_keysI <span class="main">=</span> R23_keys_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_intro<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_keysE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> R23_keys_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_elim<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_nonI <span class="main">=</span> R23_non_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_intro<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_nonE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> R23_non_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_elim<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_presI <span class="main">=</span> R23_pres_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_intro<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_presE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> R23_pres_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_elim<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_intros <span class="main">=</span> R23_msgsI R23_keysI R23_nonI R23_presI


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Simplifier lemmas for various instantiations (keys and nonces).›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_keys_simp <span class="main">=</span> R23_keys_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_dest<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_keys_simps <span class="main">=</span>
  R23_keys_simp
  R23_keys_simp <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  R23_keys_simp <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">K'</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">K'</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  R23_keys_simp <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"insert <span class="free">K'</span> <span class="free">KK</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">K'</span> <span class="free">KK</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> _ conjI<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_non_simp <span class="main">=</span> R23_non_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_dest<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_non_simps <span class="main">=</span>
  R23_non_simp
  R23_non_simp <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  R23_non_simp <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">K</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">K</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  R23_non_simp <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"insert <span class="free">K</span> <span class="free">KK</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">K</span> <span class="free">KK</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> _ conjI<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_simps <span class="main">=</span> R23_keys_simps R23_non_simps


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹General lemmas›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹General facts about <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"abs_msg"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">declare</span></span> abs_msg.intros <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span></span></span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> abs_msg.cases <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main">!</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"abs_msg <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_Un <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"abs_msg <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> abs_msg <span class="free">G</span> <span class="main">∪</span> abs_msg <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_mono <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">m</span> <span class="main">∈</span> abs_msg <span class="free">G</span><span class="main">;</span> <span class="free">G</span> <span class="main">⊆</span> <span class="free">H</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">∈</span> abs_msg <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_insert_mono <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">m</span> <span class="main">∈</span> abs_msg <span class="free">H</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">∈</span> abs_msg <span class="main">(</span>insert <span class="free">m'</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Facts about <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"abs_msg"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> concerning abstraction of fakeable
messages. This is crucial for proving the refinement of the intruder event.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_DY_subset_fakeable<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> R23_msgs<span class="main">;</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> R23_keys<span class="main">;</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> R23_non<span class="main">;</span> <span class="free">t</span> <span class="main">∈</span> m3_inv1_lkeysec <span class="main">⟧</span>
  <span class="main">⟹</span> abs_msg <span class="main">(</span>synth <span class="main">(</span>analz <span class="main">(</span>IK <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> fake ik0 <span class="main">(</span>dom <span class="main">(</span>runs <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="comment1">― ‹9 subgoals, deal with replays first›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 3 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 4 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 5 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
<span class="comment1">― ‹remaining 5 subgoals are real fakes›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> fake_StatCh fake_DynCh<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23_simps<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement proof›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Pair decomposition. These were set to \texttt{elim!}, which is too
agressive here.›</span></span>

<span class="keyword1"><span class="command">declare</span></span> MPair_analz <span class="main">[</span><span class="operator">rule</span> <span class="quasi_keyword">del</span><span class="main">,</span> <span class="operator">elim</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> MPair_parts <span class="main">[</span><span class="operator">rule</span> <span class="quasi_keyword">del</span><span class="main">,</span> <span class="operator">elim</span><span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Protocol events.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step1_refines_m2_step1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
     <span class="main">(</span>m2_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step2_refines_m2_step2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
     <span class="main">(</span>m2_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step3_refines_m2_step3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23 <span class="main">∩</span> <span class="main">(</span>m2_inv3a_sesK_compr<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>m3_inv2_sesK_compr <span class="main">∩</span> m3_inv1_lkeysec<span class="main">)</span><span class="main">}</span>
     <span class="main">(</span>m2_step3 <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Na</span> <span class="free">Ts</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step3 <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Na</span> <span class="free">Ts</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R23_msgs"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R23_keys"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R23_non"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R23_pres"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> m2_inv3a_sesK_compr"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> m3_inv2_sesK_compr"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> m3_inv1_lkeysec"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">Kab</span> <span class="main">=</span> sesK <span class="main">(</span><span class="free">Rs</span><span class="main">$</span>sk<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Rs</span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">⦃</span> Agent <span class="free">A</span><span class="main">,</span> Agent <span class="free">B</span><span class="main">,</span> Nonce <span class="free">Na</span> <span class="main">⦄</span> <span class="main">∈</span> parts <span class="main">(</span>IK <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span><span class="main">=</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">⦇</span> runs <span class="main">:=</span> runs <span class="skolem">s</span><span class="main">(</span><span class="free">Rs</span> <span class="main">↦</span> <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="free">Na</span><span class="main">,</span> aNum <span class="main">(</span>clk <span class="skolem">t</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
          chan <span class="main">:=</span> insert <span class="main">(</span>Secure Sv <span class="free">A</span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">,</span> aAgt <span class="free">B</span><span class="main">,</span> aNum <span class="main">(</span>clk <span class="skolem">t</span><span class="main">)</span><span class="main">,</span> aNon <span class="free">Na</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
                 <span class="main">(</span>insert <span class="main">(</span>Secure Sv <span class="free">B</span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">,</span> aAgt <span class="free">A</span><span class="main">,</span> aNum <span class="main">(</span>clk <span class="skolem">t</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chan <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t'</span></span></span><span class="main">=</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">⦇</span> runs <span class="main">:=</span> runs <span class="skolem">t</span><span class="main">(</span><span class="free">Rs</span> <span class="main">↦</span> <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="free">Na</span><span class="main">,</span> aNum <span class="main">(</span>clk <span class="skolem">t</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
          IK <span class="main">:=</span> insert
                  <span class="main">⦃</span> Crypt <span class="main">(</span>shrK <span class="free">A</span><span class="main">)</span> <span class="main">⦃</span> Key <span class="free">Kab</span><span class="main">,</span> Agent <span class="free">B</span><span class="main">,</span> Number <span class="main">(</span>clk <span class="skolem">t</span><span class="main">)</span><span class="main">,</span> Nonce <span class="free">Na</span> <span class="main">⦄</span><span class="main">,</span>
                    Crypt <span class="main">(</span>shrK <span class="free">B</span><span class="main">)</span> <span class="main">⦃</span> Key <span class="free">Kab</span><span class="main">,</span> Agent <span class="free">A</span><span class="main">,</span> Number <span class="main">(</span>clk <span class="skolem">t</span><span class="main">)</span> <span class="main">⦄</span> <span class="main">⦄</span>
                  <span class="main">(</span>IK <span class="skolem">t</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>
  <span class="comment1">― ‹here we go›</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s'</span><span class="main">,</span> <span class="var">?t'</span><span class="main">)</span> <span class="main">∈</span> R23_msgs"</span></span> <span class="keyword1"><span class="command">using</span></span> H
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> R23_intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s'</span><span class="main">,</span> <span class="var">?t'</span><span class="main">)</span> <span class="main">∈</span> R23_keys"</span></span> <span class="keyword1"><span class="command">using</span></span> H
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> R23_intros<span class="main"><span class="keyword3">,</span></span>
            <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_inv3a_sesK_compr_simps m3_inv2_sesK_compr_simps<span class="main"><span class="keyword3">,</span></span>
            <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23_keys_simps<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s'</span><span class="main">,</span> <span class="var">?t'</span><span class="main">)</span> <span class="main">∈</span> R23_non"</span></span> <span class="keyword1"><span class="command">using</span></span> H
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span>
       <span class="main">(</span><span class="operator">rule</span> R23_intros<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_inv3a_sesK_compr_simps m3_inv2_sesK_compr_simps R23_non_simps<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s'</span><span class="main">,</span> <span class="var">?t'</span><span class="main">)</span> <span class="main">∈</span> R23_pres"</span></span> <span class="keyword1"><span class="command">using</span></span> H
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> R23_intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">note</span></span> calculation
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step4_refines_m2_step4<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23 <span class="main">∩</span> UNIV <span class="main">×</span> m3_inv1_lkeysec<span class="main">}</span>
     <span class="main">(</span>m2_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span> <span class="free">X</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R23_msgs"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R23_keys"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R23_non"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R23_pres"</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> m3_inv1_lkeysec"</span></span>
      <span class="quoted"><span class="quoted">"runs <span class="skolem">t</span> <span class="free">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Na</span> <span class="main">=</span> <span class="free">Ra</span><span class="main">$</span>na"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">⦃</span> Crypt <span class="main">(</span>shrK <span class="free">A</span><span class="main">)</span> <span class="main">⦃</span>Key <span class="free">Kab</span><span class="main">,</span> Agent <span class="free">B</span><span class="main">,</span> Number <span class="free">Ts</span><span class="main">,</span> Nonce <span class="free">Na</span><span class="main">⦄</span><span class="main">,</span> <span class="free">X</span><span class="main">⦄</span>  <span class="main">∈</span> analz <span class="main">(</span>IK <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">⦇</span> runs <span class="main">:=</span> runs <span class="skolem">s</span><span class="main">(</span><span class="free">Ra</span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">,</span> aNum <span class="free">Ts</span><span class="main">,</span> aNum <span class="main">(</span>clk <span class="skolem">t</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
                 chan <span class="main">:=</span> insert <span class="main">(</span>dAuth <span class="free">Kab</span> <span class="main">(</span>Msg <span class="main">[</span>aAgt <span class="free">A</span><span class="main">,</span> aNum <span class="main">(</span>clk <span class="skolem">t</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chan <span class="skolem">s</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?t'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">⦇</span> runs <span class="main">:=</span> runs <span class="skolem">t</span><span class="main">(</span><span class="free">Ra</span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">,</span> aNum <span class="free">Ts</span><span class="main">,</span> aNum <span class="main">(</span>clk <span class="skolem">t</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
                 IK <span class="main">:=</span> insert <span class="main">⦃</span>Crypt <span class="free">Kab</span> <span class="main">⦃</span>Agent <span class="free">A</span><span class="main">,</span> Number <span class="main">(</span>clk <span class="skolem">t</span><span class="main">)</span><span class="main">⦄</span><span class="main">,</span> <span class="free">X</span><span class="main">⦄</span> <span class="main">(</span>IK <span class="skolem">t</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> H <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"Secure Sv <span class="free">A</span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">,</span> aAgt <span class="free">B</span><span class="main">,</span> aNum <span class="free">Ts</span><span class="main">,</span> aNon <span class="free">Na</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> analz_into_parts <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> MPair_parts<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> parts <span class="main">(</span>IK <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s'</span><span class="main">,</span> <span class="var">?t'</span><span class="main">)</span> <span class="main">∈</span> R23_msgs"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s'</span><span class="main">,</span> <span class="var">?t'</span><span class="main">)</span> <span class="main">∈</span> R23_keys"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> analz_cut <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> analz_monotonic<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s'</span><span class="main">,</span> <span class="var">?t'</span><span class="main">)</span> <span class="main">∈</span> R23_non"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> analz_cut <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> analz_monotonic<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s'</span><span class="main">,</span> <span class="var">?t'</span><span class="main">)</span> <span class="main">∈</span> R23_pres"</span></span> <span class="keyword1"><span class="command">using</span></span> H
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">note</span></span> calculation
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> analz_Inj_IK<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step5_refines_m2_step5<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
     <span class="main">(</span>m2_step5 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step5 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step6_refines_m2_step6<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
     <span class="main">(</span>m2_step6 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step6 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_tick_refines_m2_tick<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
    <span class="main">(</span>m2_tick <span class="free">T</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_tick <span class="free">T</span><span class="main">)</span>
   <span class="main">{&gt;</span>R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_purge_refines_m2_purge<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
     <span class="main">(</span>m2_purge <span class="free">A</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_purge <span class="free">A</span><span class="main">)</span>
   <span class="main">{&gt;</span>R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Intruder events.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_leak_refines_m2_leak<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
     <span class="main">(</span>m2_leak <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Ts</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_leak <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Ts</span><span class="main">)</span>
   <span class="main">{&gt;</span>R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs R23_simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_DY_fake_refines_m2_fake<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23 <span class="main">∩</span> m2_inv3a_sesK_compr <span class="main">×</span> <span class="main">(</span>m3_inv2_sesK_compr <span class="main">∩</span> m3_inv1_lkeysec<span class="main">)</span><span class="main">}</span>
     m2_fake<span class="main">,</span> m3_DY_fake
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros
            <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> abs_msg.cases<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> abs_msg_DY_subset_fakeable <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span>
            <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> abs_msg.cases<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23_simps<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All together now...›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_m3_trans_refines_m2_trans <span class="main">=</span>
  PO_m3_step1_refines_m2_step1 PO_m3_step2_refines_m2_step2
  PO_m3_step3_refines_m2_step3 PO_m3_step4_refines_m2_step4
  PO_m3_step5_refines_m2_step5 PO_m3_step6_refines_m2_step6
  PO_m3_tick_refines_m2_tick PO_m3_purge_refines_m2_purge
  PO_m3_leak_refines_m2_leak PO_m3_DY_fake_refines_m2_fake


<span class="keyword1"><span class="command">lemma</span></span> PO_m3_refines_init_m2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m3 <span class="main">⊆</span> R23<span class="main">``</span><span class="main">(</span>init m2<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_refines_trans_m2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23 <span class="main">∩</span> <span class="main">(</span>m2_inv3a_sesK_compr<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>m3_inv2_sesK_compr <span class="main">∩</span> m3_inv1_lkeysec<span class="main">)</span><span class="main">}</span>
     <span class="main">(</span>trans m2<span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans m3<span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m3_def m3_trans_def m2_def m2_trans_def<span class="main">)</span>
   <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_m3_trans_refines_m2_trans<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_observation_consistent <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"obs_consistent R23 med32 m2 m3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R23_def med32_def m3_defs<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement result.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m3_refines_m2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"refines
     <span class="main">(</span>R23 <span class="main">∩</span> <span class="main">(</span>m2_inv3a_sesK_compr<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>m3_inv1_lkeysec<span class="main">)</span><span class="main">)</span>
     med32 m2 m3"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"R23 <span class="main">∩</span> m2_inv3a_sesK_compr <span class="main">×</span> UNIV <span class="main">⊆</span> UNIV <span class="main">×</span> m3_inv2_sesK_compr"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23_def R23_keys_simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv2_sesK_comprI<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> Refinement_using_invariants<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m3_implements_m2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"implements med32 m2 m3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refinement_soundness<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Inherited invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv3 (derived): Key secrecy for initiator›</span></span>
<span class="comment1">(*invh*************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_inv3_ikk_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_inv3_ikk_init</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Ra</span> <span class="bound">K</span> <span class="bound">Ts</span> <span class="bound">nl</span><span class="main">.</span>
     runs <span class="bound">s</span> <span class="bound">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> aKey <span class="bound">K</span> <span class="main">#</span> aNum <span class="bound">Ts</span> <span class="main">#</span> <span class="bound">nl</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">A</span> <span class="main">∈</span> good <span class="main">⟶</span> <span class="bound">B</span> <span class="main">∈</span> good <span class="main">⟶</span>
     Key <span class="bound">K</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="bound">K</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">Ra</span><span class="main">$</span>na<span class="main">,</span> <span class="bound">Ts</span><span class="main">)</span> <span class="main">∈</span> leak <span class="bound">s</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_inv3_ikk_initI <span class="main">=</span> m3_inv3_ikk_init_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv3_ikk_initE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m3_inv3_ikk_init_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv3_ikk_initD <span class="main">=</span> m3_inv3_ikk_init_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv3_ikk_init<span class="main">:</span> <span class="quoted"><span class="quoted">"reach m3 <span class="main">⊆</span> m3_inv3_ikk_init"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> INV_from_Refinement_using_invariants <span class="main"><span class="main">[</span></span><span class="operator">OF</span> m3_refines_m2<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Range <span class="main">(</span>R23 <span class="main">∩</span> m2_inv3a_sesK_compr <span class="main">×</span> m3_inv1_lkeysec <span class="main">∩</span> m2_inv6_ikk_init <span class="main">×</span> UNIV<span class="main">)</span>
      <span class="main">⊆</span> m3_inv3_ikk_init"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23_def R23_keys_simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv3_ikk_initI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv4 (derived): Key secrecy for responder›</span></span>
<span class="comment1">(*invh*************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_inv4_ikk_resp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_inv4_ikk_resp</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Rb</span> <span class="bound">K</span> <span class="bound">Ts</span> <span class="bound">nl</span><span class="main">.</span>
     runs <span class="bound">s</span> <span class="bound">Rb</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> aKey <span class="bound">K</span> <span class="main">#</span> aNum <span class="bound">Ts</span> <span class="main">#</span> <span class="bound">nl</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">A</span> <span class="main">∈</span> good <span class="main">⟶</span> <span class="bound">B</span> <span class="main">∈</span> good <span class="main">⟶</span>
     Key <span class="bound">K</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound">Na</span><span class="main">.</span> <span class="main">(</span><span class="bound">K</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">Na</span><span class="main">,</span> <span class="bound">Ts</span><span class="main">)</span> <span class="main">∈</span> leak <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_inv4_ikk_respI <span class="main">=</span> m3_inv4_ikk_resp_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv4_ikk_respE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m3_inv4_ikk_resp_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv4_ikk_respD <span class="main">=</span> m3_inv4_ikk_resp_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv4_ikk_resp<span class="main">:</span> <span class="quoted"><span class="quoted">"reach m3 <span class="main">⊆</span> m3_inv4_ikk_resp"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> INV_from_Refinement_using_invariants <span class="main"><span class="main">[</span></span><span class="operator">OF</span> m3_refines_m2<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Range <span class="main">(</span>R23 <span class="main">∩</span> m2_inv3a_sesK_compr <span class="main">×</span> m3_inv1_lkeysec <span class="main">∩</span> m2_inv7_ikk_resp <span class="main">×</span> UNIV<span class="main">)</span>
      <span class="main">⊆</span> m3_inv4_ikk_resp"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23_def R23_keys_simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv4_ikk_respI<span class="main">)</span>
       <span class="main">(</span><span class="operator">elim</span> m2_inv7_ikk_respE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="m3_kerberos4">
<div class="head">
<h1>Theory m3_kerberos4</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Development of Security Protocols by Refinement

  Module:  Key_establish/m3_kerberos4.thy (Isabelle/HOL 2016-1)
  ID:      $Id: m3_kerberos4.thy 132890 2016-12-24 10:25:57Z csprenge $
  Authors  Ivano Somaini, ETH Zurich &lt;somainii@student.ethz.ch&gt;
           Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;

  Key distribution protocols
  Third refinement: core Kerberos IV

  Copyright (c) 2009-2016 Ivano Somaini, Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Core Kerberos 4 (L3)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> m3_kerberos4 <span class="keyword2"><span class="keyword">imports</span></span> <a href="m2_kerberos.html">m2_kerberos</a> <span class="quoted">"<a href="Message.html">../Refinement/Message</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
We model the core Kerberos 4 protocol:
\[
\begin{array}{lll}
  \mathrm{M1.} &amp; A \rightarrow S: &amp; A, B \\ 
  \mathrm{M2.} &amp; S \rightarrow A: &amp; \{Kab, B, Ts, Na, \{Kab, A, Ts\}_{Kbs} \}_{Kas} \\
  \mathrm{M3.} &amp; A \rightarrow B: &amp; \{A, Ta\}_{Kab}, \{Kab, A, Ts\}_{Kbs} \\
  \mathrm{M4.} &amp; B \rightarrow A: &amp; \{Ta\}_{Kab} \\
\end{array}
\]
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Proof tool configuration. Avoid annoying automatic unfolding of
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>dom›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">declare</span></span> domIff <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">iff</span> <span class="quasi_keyword">del</span><span class="main">]</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Setup›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now we can define the initial key knowledge.›</span></span>

<span class="keyword1"><span class="command">overloading</span></span> ltkeySetup' <span class="main">≡</span> <span class="quoted">ltkeySetup</span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> ltkeySetup_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ltkeySetup'</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span>sharK <span class="bound">C</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span> <span class="main">|</span> <span class="bound">C</span> <span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">=</span> <span class="bound">C</span> <span class="main">∨</span> <span class="bound">A</span> <span class="main">=</span> Sv<span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> corrKey_shrK_bad <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"corrKey <span class="main">=</span> shrK<span class="main">`</span>bad"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> keySetup_def ltkeySetup_def corrKey_def<span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹State›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The secure channels are star-shaped to/from the server.  Therefore,
we have only one agent in the relation.›</span></span>

<span class="keyword1"><span class="command">record</span></span> m3_state <span class="main">=</span> <span class="quoted"><span class="quoted">"m1_state"</span></span> <span class="main">+</span>
  IK <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set"</span></span>                                <span class="comment1">― ‹intruder knowledge›</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Observable state:
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"runs"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"clk"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"cache"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  m3_obs <span class="main">=</span> <span class="quoted"><span class="quoted">"m2_obs"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_obs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_state <span class="main">⇒</span> m3_obs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_obs</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> runs <span class="main">=</span> runs <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> leak <span class="main">=</span> leak <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> clk <span class="main">=</span> clk <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> cache <span class="main">=</span> cache <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  m3_pred <span class="main">=</span> <span class="quoted"><span class="quoted">"m3_state set"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  m3_trans <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m3_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Events›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Protocol events.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">A</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m2_step1"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_step1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step1</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>                  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Ra›</span></span> is fresh›</span>
    <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>na <span class="main">∧</span>                         <span class="comment1">― ‹generated nonce›</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      IK <span class="main">:=</span> insert <span class="main">⦃</span>Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Nonce <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">⦄</span> <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span>   <span class="comment1">― ‹send <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M1›</span></span>›</span>
    <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">B</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m2_step2"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_step2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step2</span> <span class="main">≡</span> m1_step2"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"Server"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m2_step3</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_step3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> key<span class="main">,</span> nonce<span class="main">,</span> time<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step3</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>                          <span class="comment1">― ‹fresh server run›</span>
    <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">=</span> sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span>                          <span class="comment1">― ‹fresh session key›</span>

    <span class="main">⦃</span>Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Nonce <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">⦄</span> <span class="main">∈</span> IK <span class="bound">s</span> <span class="main">∧</span>    <span class="comment1">― ‹recv <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M1›</span></span>›</span>
    <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">=</span> clk <span class="bound">s</span> <span class="main">∧</span>                                 <span class="comment1">― ‹fresh timestamp›</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="comment1">― ‹record session key and send <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M2›</span></span>›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">↦</span> <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      IK <span class="main">:=</span> insert <span class="main">(</span>Crypt <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>                        <span class="comment1">― ‹send <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M2›</span></span>›</span>
                     <span class="main">⦃</span>Key <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Number <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span> Nonce <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">,</span>
                        Crypt <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">⦃</span>Key <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Number <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">⦄</span><span class="main">⦄</span><span class="main">)</span>
               <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span>
    <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">A</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m2_step4</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_step4</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> key<span class="main">,</span> time<span class="main">,</span> time<span class="main">,</span> msg<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step4</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>

     <span class="comment1">― ‹guards:›</span>
     runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>           <span class="comment1">― ‹key not yet recv'd›</span>
     <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>na <span class="main">∧</span>                                    <span class="comment1">― ‹generated nonce›</span>

     Crypt <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>                                  <span class="comment1">― ‹recv <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M2›</span></span>›</span>
       <span class="main">⦃</span>Key <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Number <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span> Nonce <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">⦄</span> <span class="main">∈</span> IK <span class="bound">s</span> <span class="main">∧</span>

     <span class="comment1">― ‹read current time›</span>
     <span class="free"><span class="bound"><span class="entity">Ta</span></span></span> <span class="main">=</span> clk <span class="bound">s</span> <span class="main">∧</span>

     <span class="comment1">― ‹check freshness of session key›</span>
     clk <span class="bound">s</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">+</span> Ls <span class="main">∧</span>

     <span class="comment1">― ‹actions:›</span>
     <span class="comment1">― ‹record session key and send <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M3›</span></span>›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
       runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
       IK <span class="main">:=</span> insert <span class="main">⦃</span>Crypt <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">⦃</span>Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Number <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">⦄</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">⦄</span> <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span>  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M3›</span></span>›</span>
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">B</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m2_step5</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_step5</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> key<span class="main">,</span> time<span class="main">,</span> time<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step5</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>
     <span class="comment1">― ‹guards:›</span>
     runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>             <span class="comment1">― ‹key not yet recv'd›</span>

     <span class="main">⦃</span>Crypt <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">⦃</span>Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Number <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">⦄</span><span class="main">,</span>                   <span class="comment1">― ‹recv <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M3›</span></span>›</span>
        Crypt <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">⦃</span>Key <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Number <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">⦄</span><span class="main">⦄</span> <span class="main">∈</span> IK <span class="bound">s</span> <span class="main">∧</span>

     <span class="comment1">― ‹ensure freshness of session key›</span>
     clk <span class="bound">s</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">+</span> Ls <span class="main">∧</span>

     <span class="comment1">― ‹check authenticator's validity and replay; 'replays' with fresh authenticator ok!›</span>
     clk <span class="bound">s</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span> <span class="main">+</span> La <span class="main">∧</span>
     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">)</span> <span class="main">∉</span> cache <span class="bound">s</span> <span class="main">∧</span>

     <span class="comment1">― ‹actions:›</span>
     <span class="comment1">― ‹record session key›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
       runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
       cache <span class="main">:=</span> insert <span class="main">(</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">)</span> <span class="main">(</span>cache <span class="bound">s</span><span class="main">)</span><span class="main">,</span>
       IK <span class="main">:=</span> insert <span class="main">(</span>Crypt <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">(</span>Number <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span>               <span class="comment1">― ‹send <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M4›</span></span>›</span>
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">A</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m2_step6</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_step6</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> key<span class="main">,</span> time<span class="main">,</span> time<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step6</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
     <span class="comment1">― ‹guards:›</span>
     runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span>  <span class="comment1">― ‹knows key›</span>
     <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>na <span class="main">∧</span>                                    <span class="comment1">― ‹generated nonce›</span>
     clk <span class="bound">s</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">+</span> Ls <span class="main">∧</span>                               <span class="comment1">― ‹check session key's recentness›</span>

     Crypt <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">(</span>Number <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">)</span> <span class="main">∈</span> IK <span class="bound">s</span> <span class="main">∧</span>                               <span class="comment1">― ‹recv <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M4›</span></span>›</span>

     <span class="comment1">― ‹actions:›</span>
     <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
        runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">,</span> END<span class="main">]</span><span class="main">)</span><span class="main">)</span>
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Clock tick event›</span></span>

<span class="keyword1"><span class="command">definition</span></span>   <span class="comment1">― ‹refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m2_tick"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_tick</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"time <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_tick</span> <span class="main">≡</span> m1_tick"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Purge event: purge cache of expired timestamps›</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m2_purge"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_purge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_purge</span> <span class="main">≡</span> m1_purge"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Session key compromise.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m2_leak</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_leak</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> time<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_leak</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span>clk <span class="bound">s</span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">+</span> Ls<span class="main">)</span> <span class="main">∧</span>             <span class="comment1">― ‹only compromise 'old' session keys!›</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="comment1">― ‹record session key as leaked and add it to intruder knowledge›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> leak <span class="main">:=</span> insert <span class="main">(</span>sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">)</span> <span class="main">(</span>leak <span class="bound">s</span><span class="main">)</span><span class="main">,</span>
            IK <span class="main">:=</span> insert <span class="main">(</span>Key <span class="main">(</span>sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span> <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Intruder fake event. The following "Dolev-Yao" event generates all
intruder-derivable messages.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m2_fake"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_DY_fake</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_DY_fake</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>

     <span class="comment1">― ‹actions:›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> IK <span class="main">:=</span> synth <span class="main">(</span>analz <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span>       <span class="comment1">― ‹take DY closure›</span>
  <span class="main">}</span>"</span></span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Transition system›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_init</span> <span class="main">≡</span> <span class="main">{</span> <span class="main">⦇</span>
     runs <span class="main">=</span> Map.empty<span class="main">,</span>
     leak <span class="main">=</span> shrK<span class="main">`</span>bad <span class="main">×</span> <span class="main">{</span>undefined<span class="main">}</span><span class="main">,</span>
     clk <span class="main">=</span> <span class="main">0</span><span class="main">,</span>
     cache <span class="main">=</span> <span class="main">{}</span><span class="main">,</span>
     IK <span class="main">=</span> Key<span class="main">`</span>shrK<span class="main">`</span>bad
  <span class="main">⦈</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_trans"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_trans</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Ra</span> <span class="bound">Rb</span> <span class="bound">Rs</span> <span class="bound">Na</span> <span class="bound">Kab</span> <span class="bound">Ts</span> <span class="bound">Ta</span> <span class="bound">T</span> <span class="bound">X</span><span class="main">.</span>
     m3_step1 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="main">∪</span>
     m3_step2 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">∪</span>
     m3_step3 <span class="bound">Rs</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Kab</span> <span class="bound">Na</span> <span class="bound">Ts</span> <span class="main">∪</span>
     m3_step4 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Kab</span> <span class="bound">Ts</span> <span class="bound">Ta</span> <span class="bound">X</span> <span class="main">∪</span>
     m3_step5 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Kab</span> <span class="bound">Ts</span> <span class="bound">Ta</span> <span class="main">∪</span>
     m3_step6 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Kab</span> <span class="bound">Ts</span> <span class="bound">Ta</span> <span class="main">∪</span>
     m3_tick <span class="bound">T</span> <span class="main">∪</span>
     m3_purge <span class="bound">A</span> <span class="main">∪</span>
     m3_leak <span class="bound">Rs</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Ts</span> <span class="main">∪</span>
     m3_DY_fake <span class="main">∪</span>
     Id
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m3_state<span class="main">,</span> m3_obs<span class="main">)</span> spec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3</span> <span class="main">≡</span> <span class="main">⦇</span>
    init <span class="main">=</span> m3_init<span class="main">,</span>
    trans <span class="main">=</span> m3_trans<span class="main">,</span>
    obs <span class="main">=</span> m3_obs
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_loc_defs <span class="main">=</span>
  m3_def m3_init_def m3_trans_def m3_obs_def
  m3_step1_def m3_step2_def m3_step3_def m3_step4_def m3_step5_def
  m3_step6_def m3_tick_def m3_purge_def m3_leak_def m3_DY_fake_def

<span class="keyword1"><span class="command">lemmas</span></span> m3_defs <span class="main">=</span> m3_loc_defs m2_defs


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Specialized injection that we can apply more aggressively.›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> analz_Inj_IK <span class="main">=</span> analz.Inj <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"IK <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">s</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> parts_Inj_IK <span class="main">=</span> parts.Inj <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"IK <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">s</span><span class="main">]</span>

<span class="keyword1"><span class="command">declare</span></span> parts_Inj_IK <span class="main">[</span><span class="operator">dest</span><span class="main"><span class="main">!</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">declare</span></span> analz_into_parts <span class="main">[</span><span class="operator">dest</span><span class="main">]</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv4: Secrecy of pre-distributed shared keys›</span></span>
<span class="comment1">(*inv**************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_inv4_lkeysec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_inv4_lkeysec</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">C</span><span class="main">.</span>
     <span class="main">(</span>Key <span class="main">(</span>shrK <span class="bound">C</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">C</span> <span class="main">∈</span> bad<span class="main">)</span> <span class="main">∧</span>
     <span class="main">(</span><span class="bound">C</span> <span class="main">∈</span> bad <span class="main">⟶</span> Key <span class="main">(</span>shrK <span class="bound">C</span><span class="main">)</span> <span class="main">∈</span> IK <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_inv4_lkeysecI <span class="main">=</span> m3_inv4_lkeysec_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv4_lkeysecE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m3_inv4_lkeysec_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv4_lkeysecD <span class="main">=</span> m3_inv4_lkeysec_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv4_lkeysec_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m3 <span class="main">⊆</span> m3_inv4_lkeysec"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv4_lkeysecI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv4_lkeysec_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m3_inv4_lkeysec<span class="main">}</span> trans m3 <span class="main">{&gt;</span> m3_inv4_lkeysec<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv4_lkeysecI<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Body<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv4_lkeysec <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m3 <span class="main">⊆</span> m3_inv4_lkeysec"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_incr<span class="main">)</span> <span class="main">(</span><span class="operator">fast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Useful simplifier lemmas›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m3_inv4_lkeysec_for_parts <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">s</span> <span class="main">∈</span> m3_inv4_lkeysec <span class="main">⟧</span> <span class="main">⟹</span> Key <span class="main">(</span>shrK <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>IK <span class="free">s</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">C</span> <span class="main">∈</span> bad"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> m3_inv4_lkeysec_for_analz <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">s</span> <span class="main">∈</span> m3_inv4_lkeysec <span class="main">⟧</span> <span class="main">⟹</span> Key <span class="main">(</span>shrK <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="free">s</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">C</span> <span class="main">∈</span> bad"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv6: Ticket shape for honestly encrypted M2›</span></span>
<span class="comment1">(*inv**************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_inv6_ticket</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_inv6_ticket</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">T</span> <span class="bound">K</span> <span class="bound">N</span> <span class="bound">X</span><span class="main">.</span>
     <span class="bound">A</span> <span class="main">∉</span> bad <span class="main">⟶</span>
     Crypt <span class="main">(</span>shrK <span class="bound">A</span><span class="main">)</span> <span class="main">⦃</span>Key <span class="bound">K</span><span class="main">,</span> Agent <span class="bound">B</span><span class="main">,</span> Number <span class="bound">T</span><span class="main">,</span> Nonce <span class="bound">N</span><span class="main">,</span> <span class="bound">X</span><span class="main">⦄</span> <span class="main">∈</span> parts <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="bound">X</span> <span class="main">=</span> Crypt <span class="main">(</span>shrK <span class="bound">B</span><span class="main">)</span> <span class="main">⦃</span>Key <span class="bound">K</span><span class="main">,</span> Agent <span class="bound">A</span><span class="main">,</span> Number <span class="bound">T</span><span class="main">⦄</span> <span class="main">∧</span> <span class="bound">K</span> <span class="main">∈</span> range sesK
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_inv6_ticketI <span class="main">=</span> m3_inv6_ticket_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv6_ticketE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m3_inv6_ticket_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv6_ticketD <span class="main">=</span> m3_inv6_ticket_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> -1<span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv6_ticket_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m3 <span class="main">⊆</span> m3_inv6_ticket"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv6_ticketI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv6_ticket_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m3_inv6_ticket <span class="main">∩</span> m3_inv4_lkeysec<span class="main">}</span> trans m3 <span class="main">{&gt;</span> m3_inv6_ticket<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv6_ticketI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m3_inv6_ticketD<span class="main">)</span>
<span class="comment1">― ‹2 subgoals›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> parts_cut<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> Body<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m3_inv6_ticketD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv6_ticket <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m3 <span class="main">⊆</span> m3_inv6_ticket"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_incr<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv7: Session keys not used to encrypt other session keys›</span></span>
<span class="comment1">(*inv**************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Session keys are not used to encrypt other keys. Proof requires
generalization to sets of session keys.

NOTE: For Kerberos 4, this invariant cannot be inherited from the corresponding
L2 invariant. The simulation relation is only an implication not an equivalence.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_inv7a_sesK_compr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_inv7a_sesK_compr</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">K</span> <span class="bound">KK</span><span class="main">.</span>
     <span class="bound">KK</span> <span class="main">⊆</span> range sesK <span class="main">⟶</span>
     <span class="main">(</span>Key <span class="bound">K</span> <span class="main">∈</span> analz <span class="main">(</span>Key<span class="main">`</span><span class="bound">KK</span> <span class="main">∪</span> <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">K</span> <span class="main">∈</span> <span class="bound">KK</span> <span class="main">∨</span> Key <span class="bound">K</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_inv7a_sesK_comprI <span class="main">=</span> m3_inv7a_sesK_compr_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv7a_sesK_comprE <span class="main">=</span> m3_inv7a_sesK_compr_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv7a_sesK_comprD <span class="main">=</span> m3_inv7a_sesK_compr_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Additional lemma›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> insert_commute_Key <span class="main">=</span> insert_commute <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Key <span class="free">K</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">K</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_inv7a_sesK_compr_simps <span class="main">=</span>
  m3_inv7a_sesK_comprD
  m3_inv7a_sesK_comprD <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"insert <span class="free">Kab</span> <span class="free">KK</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">Kab</span> <span class="free">KK</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  m3_inv7a_sesK_comprD <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">Kab</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">Kab</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  insert_commute_Key


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv7a_sesK_compr_step4<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m3_inv7a_sesK_compr <span class="main">∩</span> m3_inv6_ticket <span class="main">∩</span> m3_inv4_lkeysec<span class="main">}</span>
      m3_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span> <span class="free">X</span>
   <span class="main">{&gt;</span> m3_inv7a_sesK_compr<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">K</span> <span class="skolem">KK</span> <span class="skolem">s</span>
    <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> m3_inv4_lkeysec"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> m3_inv7a_sesK_compr"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> m3_inv6_ticket"</span></span>
      <span class="quoted"><span class="quoted">"runs <span class="skolem">s</span> <span class="free">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">Na</span> <span class="main">=</span> <span class="free">Ra</span><span class="main">$</span>na"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">KK</span> <span class="main">⊆</span> range sesK"</span></span>
      <span class="quoted"><span class="quoted">"Crypt <span class="main">(</span>shrK <span class="free">A</span><span class="main">)</span> <span class="main">⦃</span>Key <span class="free">Kab</span><span class="main">,</span> Agent <span class="free">B</span><span class="main">,</span> Number <span class="free">Ts</span><span class="main">,</span> Nonce <span class="free">Na</span><span class="main">,</span> <span class="free">X</span><span class="main">⦄</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>Key <span class="skolem">K</span> <span class="main">∈</span> analz <span class="main">(</span>insert <span class="free">X</span> <span class="main">(</span>Key <span class="main">`</span> <span class="skolem">KK</span> <span class="main">∪</span> IK <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">(</span><span class="skolem">K</span> <span class="main">∈</span> <span class="skolem">KK</span> <span class="main">∨</span> Key <span class="skolem">K</span> <span class="main">∈</span> analz <span class="main">(</span>insert <span class="free">X</span> <span class="main">(</span>IK <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> bad"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Decrypt<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> analz <span class="main">(</span>Key <span class="main">`</span> <span class="skolem">KK</span> <span class="main">∪</span> IK <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> analz_monotonic<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> H
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m3_inv7a_sesK_compr_simps analz_insert_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> H
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m3_inv7a_sesK_compr_simps
                    <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv6_ticketD <span class="main"><span class="main">[</span></span><span class="operator">OF</span> analz_into_parts<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv7a_sesK_comprI <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> analz_Inj_IK<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All together now.›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_m3_inv7a_sesK_compr_trans_lemmas <span class="main">=</span>
  PO_m3_inv7a_sesK_compr_step4

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv7a_sesK_compr_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m3 <span class="main">⊆</span> m3_inv7a_sesK_compr"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv7a_sesK_comprI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv7a_sesK_compr_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m3_inv7a_sesK_compr <span class="main">∩</span> m3_inv6_ticket <span class="main">∩</span> m3_inv4_lkeysec<span class="main">}</span>
     trans m3
   <span class="main">{&gt;</span> m3_inv7a_sesK_compr<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m3_def m3_trans_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_m3_inv7a_sesK_compr_trans_lemmas<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m3_defs m3_inv7a_sesK_compr_simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv7a_sesK_comprI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv7a_sesK_compr <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m3 <span class="main">⊆</span> m3_inv7a_sesK_compr"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> J<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"m3_inv6_ticket <span class="main">∩</span> m3_inv4_lkeysec"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> inv_rule_incr<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv7b: Session keys not used to encrypt nonces›</span></span>
<span class="comment1">(*inv**************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Session keys are not used to encrypt nonces. The proof requires a
generalization to sets of session keys.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_inv7b_sesK_compr_non</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_inv7b_sesK_compr_non</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">N</span> <span class="bound">KK</span><span class="main">.</span>
     <span class="bound">KK</span> <span class="main">⊆</span> range sesK <span class="main">⟶</span> <span class="main">(</span>Nonce <span class="bound">N</span> <span class="main">∈</span> analz <span class="main">(</span>Key<span class="main">`</span><span class="bound">KK</span> <span class="main">∪</span> <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Nonce <span class="bound">N</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_inv7b_sesK_compr_nonI <span class="main">=</span> m3_inv7b_sesK_compr_non_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv7b_sesK_compr_nonE <span class="main">=</span> m3_inv7b_sesK_compr_non_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv7b_sesK_compr_nonD <span class="main">=</span> m3_inv7b_sesK_compr_non_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_inv7b_sesK_compr_non_simps <span class="main">=</span>
  m3_inv7b_sesK_compr_nonD
  m3_inv7b_sesK_compr_nonD <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"insert <span class="free">Kab</span> <span class="free">KK</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">Kab</span> <span class="free">KK</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  m3_inv7b_sesK_compr_nonD <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">Kab</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">Kab</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  insert_commute_Key


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv7b_sesK_compr_non_step3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m3_inv7b_sesK_compr_non<span class="main">}</span> m3_step3 <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Na</span> <span class="free">Ts</span> <span class="main">{&gt;</span> m3_inv7b_sesK_compr_non<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m3_defs m3_inv7b_sesK_compr_non_simps
         <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv7b_sesK_compr_nonI <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> analz_Inj_IK<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv7b_sesK_compr_non_step4<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m3_inv7b_sesK_compr_non <span class="main">∩</span> m3_inv6_ticket <span class="main">∩</span> m3_inv4_lkeysec<span class="main">}</span>
      m3_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span> <span class="free">X</span>
   <span class="main">{&gt;</span> m3_inv7b_sesK_compr_non<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">N</span> <span class="skolem">KK</span> <span class="skolem">s</span>
    <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> m3_inv4_lkeysec"</span></span><span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> m3_inv7b_sesK_compr_non"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> m3_inv6_ticket"</span></span>
      <span class="quoted"><span class="quoted">"runs <span class="skolem">s</span> <span class="free">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">Na</span> <span class="main">=</span> <span class="free">Ra</span><span class="main">$</span>na"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">KK</span> <span class="main">⊆</span> range sesK"</span></span>
      <span class="quoted"><span class="quoted">"Crypt <span class="main">(</span>shrK <span class="free">A</span><span class="main">)</span> <span class="main">⦃</span>Key <span class="free">Kab</span><span class="main">,</span> Agent <span class="free">B</span><span class="main">,</span> Number <span class="free">Ts</span><span class="main">,</span> Nonce <span class="free">Na</span><span class="main">,</span> <span class="free">X</span><span class="main">⦄</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>Nonce <span class="skolem">N</span> <span class="main">∈</span> analz <span class="main">(</span>insert <span class="free">X</span> <span class="main">(</span>Key <span class="main">`</span> <span class="skolem">KK</span> <span class="main">∪</span> IK <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">(</span>Nonce <span class="skolem">N</span> <span class="main">∈</span> analz <span class="main">(</span>insert <span class="free">X</span> <span class="main">(</span>IK <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> bad"</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">∈</span> bad›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> H
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Decrypt<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> analz <span class="main">(</span>Key <span class="main">`</span> <span class="skolem">KK</span> <span class="main">∪</span> IK <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> analz_monotonic<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> H
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m3_inv7b_sesK_compr_non_simps analz_insert_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∉</span> bad"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> H
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m3_inv7b_sesK_compr_non_simps
                    <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv6_ticketD <span class="main"><span class="main">[</span></span><span class="operator">OF</span> analz_into_parts<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv7b_sesK_compr_nonI
           <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> analz_Inj_IK<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All together now.›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_m3_inv7b_sesK_compr_non_trans_lemmas <span class="main">=</span>
  PO_m3_inv7b_sesK_compr_non_step3 PO_m3_inv7b_sesK_compr_non_step4

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv7b_sesK_compr_non_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m3 <span class="main">⊆</span> m3_inv7b_sesK_compr_non"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv7b_sesK_compr_nonI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv7b_sesK_compr_non_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m3_inv7b_sesK_compr_non <span class="main">∩</span> m3_inv6_ticket <span class="main">∩</span> m3_inv4_lkeysec<span class="main">}</span>
     trans m3
   <span class="main">{&gt;</span> m3_inv7b_sesK_compr_non<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m3_def m3_trans_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_m3_inv7b_sesK_compr_non_trans_lemmas<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m3_defs m3_inv7b_sesK_compr_non_simps
                   <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv7b_sesK_compr_nonI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv7b_sesK_compr_non <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m3 <span class="main">⊆</span> m3_inv7b_sesK_compr_non"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> J<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"m3_inv6_ticket <span class="main">∩</span> m3_inv4_lkeysec"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> inv_rule_incr<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Message abstraction and simulation relation›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Abstraction function on sets of messages.›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span>
  <span class="entity">abs_msg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set <span class="main">⇒</span> chmsg set"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">H</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  am_M1<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⦃</span>Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Nonce <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">⦄</span> <span class="main">∈</span> <span class="free">H</span>
  <span class="main">⟹</span> Insec <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">abs_msg</span> <span class="free">H</span>"</span></span>
<span class="main">|</span> am_M2a<span class="main">:</span>
    <span class="quoted"><span class="quoted">"Crypt <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">⦃</span>Key <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Number <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">,</span> Nonce <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">⦄</span> <span class="main">∈</span> <span class="free">H</span>
  <span class="main">⟹</span> Secure Sv <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">,</span> aAgt <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">,</span> aNon <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">abs_msg</span> <span class="free">H</span>"</span></span>
<span class="main">|</span> am_M2b<span class="main">:</span>
    <span class="quoted"><span class="quoted">"Crypt <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">⦃</span>Key <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">,</span>  Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Number <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">⦄</span> <span class="main">∈</span> <span class="free">H</span>
  <span class="main">⟹</span> Secure Sv <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">,</span> aAgt <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">abs_msg</span> <span class="free">H</span>"</span></span>
<span class="main">|</span> am_M3<span class="main">:</span>
    <span class="quoted"><span class="quoted">"Crypt <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">⦃</span>Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Number <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">⦄</span> <span class="main">∈</span> <span class="free">H</span>
  <span class="main">⟹</span> dAuth <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aAgt <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">abs_msg</span> <span class="free">H</span>"</span></span>
<span class="main">|</span> am_M4<span class="main">:</span>
    <span class="quoted"><span class="quoted">"Crypt <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">(</span>Number <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">H</span>
  <span class="main">⟹</span> dAuth <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aNum <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">abs_msg</span> <span class="free">H</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹R23: The simulation relation. This is a data refinement of
the insecure and secure channels of refinement 2.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R23_msgs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R23_msgs</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> abs_msg <span class="main">(</span>parts <span class="main">(</span>IK <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> chan <span class="bound">s</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R23_keys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R23_keys</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">KK</span> <span class="bound">K</span><span class="main">.</span> <span class="bound">KK</span> <span class="main">⊆</span> range sesK <span class="main">⟶</span>
     Key <span class="bound">K</span> <span class="main">∈</span> analz <span class="main">(</span>Key<span class="main">`</span><span class="bound">KK</span> <span class="main">∪</span> <span class="main">(</span>IK <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> aKey <span class="bound">K</span> <span class="main">∈</span> extr <span class="main">(</span>aKey<span class="main">`</span><span class="bound">KK</span> <span class="main">∪</span> ik0<span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R23_non</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R23_non</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">KK</span> <span class="bound">N</span><span class="main">.</span> <span class="bound">KK</span> <span class="main">⊆</span> range sesK <span class="main">⟶</span>
     Nonce <span class="bound">N</span> <span class="main">∈</span> analz <span class="main">(</span>Key<span class="main">`</span><span class="bound">KK</span> <span class="main">∪</span> <span class="main">(</span>IK <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> aNon <span class="bound">N</span> <span class="main">∈</span> extr <span class="main">(</span>aKey<span class="main">`</span><span class="bound">KK</span> <span class="main">∪</span> ik0<span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R23_pres</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R23_pres</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> runs <span class="bound">s</span> <span class="main">=</span> runs <span class="bound">t</span> <span class="main">∧</span> leak <span class="bound">s</span> <span class="main">=</span> leak <span class="bound">t</span> <span class="main">∧</span> clk <span class="bound">s</span> <span class="main">=</span> clk <span class="bound">t</span> <span class="main">∧</span> cache <span class="bound">s</span> <span class="main">=</span> cache <span class="bound">t</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R23</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R23</span> <span class="main">≡</span> R23_msgs <span class="main">∩</span> R23_keys <span class="main">∩</span> R23_non <span class="main">∩</span> R23_pres"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_defs <span class="main">=</span>
  R23_def R23_msgs_def R23_keys_def R23_non_def R23_pres_def


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The mediator function is the identity here.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">med32</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_obs <span class="main">⇒</span> m2_obs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med32</span> <span class="main">≡</span> id"</span></span>


<span class="keyword1"><span class="command">lemmas</span></span> R23_msgsI <span class="main">=</span> R23_msgs_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_intro<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_msgsE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> R23_msgs_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_elim<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_msgsE' <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span>
  R23_msgs_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_dest<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">THEN</span> subsetD<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_keysI <span class="main">=</span> R23_keys_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_intro<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_keysE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> R23_keys_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_elim<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_keysD <span class="main">=</span> R23_keys_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_dest<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 2<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_nonI <span class="main">=</span> R23_non_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_intro<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_nonE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> R23_non_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_elim<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_nonD <span class="main">=</span> R23_non_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_dest<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 2<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_presI <span class="main">=</span> R23_pres_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_intro<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_presE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> R23_pres_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_elim<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_intros <span class="main">=</span> R23_msgsI R23_keysI R23_nonI R23_presI


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lemmas for various instantiations (keys and nonces).›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_keys_dests <span class="main">=</span>
  R23_keysD
  R23_keysD <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  R23_keysD <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">K</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">K</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  R23_keysD <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"insert <span class="free">K</span> <span class="free">KK</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">K</span> <span class="free">KK</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> _ _ conjI<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_non_dests <span class="main">=</span>
  R23_nonD
  R23_nonD <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  R23_nonD <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">K</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">K</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  R23_nonD <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"insert <span class="free">K</span> <span class="free">KK</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">K</span> <span class="free">KK</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> _ _ conjI<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_dests <span class="main">=</span> R23_keys_dests R23_non_dests


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹General lemmas›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹General facts about <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"abs_msg"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">declare</span></span> abs_msg.intros <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span></span></span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> abs_msg.cases <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main">!</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"abs_msg <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_Un <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"abs_msg <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> abs_msg <span class="free">G</span> <span class="main">∪</span> abs_msg <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_mono <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">m</span> <span class="main">∈</span> abs_msg <span class="free">G</span><span class="main">;</span> <span class="free">G</span> <span class="main">⊆</span> <span class="free">H</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">∈</span> abs_msg <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_insert_mono <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">m</span> <span class="main">∈</span> abs_msg <span class="free">H</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">∈</span> abs_msg <span class="main">(</span>insert <span class="free">m'</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Facts about <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"abs_msg"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> concerning abstraction of fakeable
messages. This is crucial for proving the refinement of the intruder event.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_DY_subset_fakeable<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> R23_msgs<span class="main">;</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> R23_keys<span class="main">;</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> R23_non<span class="main">;</span> <span class="free">t</span> <span class="main">∈</span> m3_inv4_lkeysec <span class="main">⟧</span>
  <span class="main">⟹</span> abs_msg <span class="main">(</span>synth <span class="main">(</span>analz <span class="main">(</span>IK <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> fake ik0 <span class="main">(</span>dom <span class="main">(</span>runs <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="comment1">― ‹9 subgoals, deal with replays first›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 3 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 4 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 5 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
<span class="comment1">― ‹remaining 5 subgoals are real fakes›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> fake_StatCh fake_DynCh<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> R23_dests<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement proof›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Pair decomposition. These were set to \texttt{elim!}, which is too
agressive here.›</span></span>

<span class="keyword1"><span class="command">declare</span></span> MPair_analz <span class="main">[</span><span class="operator">rule</span> <span class="quasi_keyword">del</span><span class="main">,</span> <span class="operator">elim</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> MPair_parts <span class="main">[</span><span class="operator">rule</span> <span class="quasi_keyword">del</span><span class="main">,</span> <span class="operator">elim</span><span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Protocol events.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step1_refines_m2_step1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
     <span class="main">(</span>m2_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step2_refines_m2_step2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
     <span class="main">(</span>m2_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step3_refines_m2_step3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23 <span class="main">∩</span> <span class="main">(</span>m2_inv3a_sesK_compr<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>m3_inv7a_sesK_compr <span class="main">∩</span> m3_inv4_lkeysec<span class="main">)</span><span class="main">}</span>
     <span class="main">(</span>m2_step3 <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Na</span> <span class="free">Ts</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step3 <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Na</span> <span class="free">Ts</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R23_msgs"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R23_keys"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R23_non"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R23_pres"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> m2_inv3a_sesK_compr"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> m3_inv7a_sesK_compr"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> m3_inv4_lkeysec"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">Kab</span> <span class="main">=</span> sesK <span class="main">(</span><span class="free">Rs</span><span class="main">$</span>sk<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Rs</span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">⦃</span>Agent <span class="free">A</span><span class="main">,</span> Agent <span class="free">B</span><span class="main">,</span> Nonce <span class="free">Na</span><span class="main">⦄</span> <span class="main">∈</span> parts <span class="main">(</span>IK <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span><span class="main">=</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">⦇</span> runs <span class="main">:=</span> runs <span class="skolem">s</span><span class="main">(</span><span class="free">Rs</span> <span class="main">↦</span> <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="free">Na</span><span class="main">,</span> aNum <span class="main">(</span>clk <span class="skolem">t</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
          chan <span class="main">:=</span> insert <span class="main">(</span>Secure Sv <span class="free">A</span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">,</span> aAgt <span class="free">B</span><span class="main">,</span> aNum <span class="main">(</span>clk <span class="skolem">t</span><span class="main">)</span><span class="main">,</span> aNon <span class="free">Na</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
                 <span class="main">(</span>insert <span class="main">(</span>Secure Sv <span class="free">B</span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">,</span> aAgt <span class="free">A</span><span class="main">,</span> aNum <span class="main">(</span>clk <span class="skolem">t</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chan <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t'</span></span></span><span class="main">=</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">⦇</span> runs <span class="main">:=</span> runs <span class="skolem">t</span><span class="main">(</span><span class="free">Rs</span> <span class="main">↦</span> <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="free">Na</span><span class="main">,</span> aNum <span class="main">(</span>clk <span class="skolem">t</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
          IK <span class="main">:=</span> insert
                  <span class="main">(</span>Crypt <span class="main">(</span>shrK <span class="free">A</span><span class="main">)</span>
                     <span class="main">⦃</span> Key <span class="free">Kab</span><span class="main">,</span> Agent <span class="free">B</span><span class="main">,</span> Number <span class="main">(</span>clk <span class="skolem">t</span><span class="main">)</span><span class="main">,</span> Nonce <span class="free">Na</span><span class="main">,</span>
                       Crypt <span class="main">(</span>shrK <span class="free">B</span><span class="main">)</span> <span class="main">⦃</span> Key <span class="free">Kab</span><span class="main">,</span> Agent <span class="free">A</span><span class="main">,</span> Number <span class="main">(</span>clk <span class="skolem">t</span><span class="main">)</span> <span class="main">⦄</span><span class="main">⦄</span><span class="main">)</span>
                  <span class="main">(</span>IK <span class="skolem">t</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>
  <span class="comment1">― ‹here we go›</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s'</span><span class="main">,</span> <span class="var">?t'</span><span class="main">)</span> <span class="main">∈</span> R23_msgs"</span></span> <span class="keyword1"><span class="command">using</span></span> H
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> R23_intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s'</span><span class="main">,</span> <span class="var">?t'</span><span class="main">)</span> <span class="main">∈</span> R23_keys"</span></span> <span class="keyword1"><span class="command">using</span></span> H
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> R23_intros<span class="main"><span class="keyword3">,</span></span>
            <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_inv3a_sesK_compr_simps m3_inv7a_sesK_compr_simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> R23_keys_dests<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s'</span><span class="main">,</span> <span class="var">?t'</span><span class="main">)</span> <span class="main">∈</span> R23_non"</span></span> <span class="keyword1"><span class="command">using</span></span> H
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> R23_intros<span class="main"><span class="keyword3">,</span></span>
            <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_inv3a_sesK_compr_simps m3_inv7a_sesK_compr_simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> R23_non_dests<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s'</span><span class="main">,</span> <span class="var">?t'</span><span class="main">)</span> <span class="main">∈</span> R23_pres"</span></span> <span class="keyword1"><span class="command">using</span></span> H
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> R23_intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">note</span></span> calculation
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step4_refines_m2_step4<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23 <span class="main">∩</span> <span class="main">(</span>UNIV<span class="main">)</span>
        <span class="main">×</span> <span class="main">(</span>m3_inv7a_sesK_compr <span class="main">∩</span> m3_inv7b_sesK_compr_non <span class="main">∩</span> m3_inv6_ticket <span class="main">∩</span> m3_inv4_lkeysec<span class="main">)</span><span class="main">}</span>
     <span class="main">(</span>m2_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span> <span class="free">X</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R23_msgs"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R23_keys"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R23_non"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R23_pres"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> m3_inv7a_sesK_compr"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> m3_inv7b_sesK_compr_non"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> m3_inv6_ticket"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> m3_inv4_lkeysec"</span></span>
      <span class="quoted"><span class="quoted">"runs <span class="skolem">t</span> <span class="free">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">Na</span> <span class="main">=</span> <span class="free">Ra</span><span class="main">$</span>na"</span></span>
      <span class="quoted"><span class="quoted">"Crypt <span class="main">(</span>shrK <span class="free">A</span><span class="main">)</span> <span class="main">⦃</span>Key <span class="free">Kab</span><span class="main">,</span> Agent <span class="free">B</span><span class="main">,</span> Number <span class="free">Ts</span><span class="main">,</span> Nonce <span class="free">Na</span><span class="main">,</span> <span class="free">X</span><span class="main">⦄</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">⦇</span> runs <span class="main">:=</span> runs <span class="skolem">s</span><span class="main">(</span><span class="free">Ra</span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">,</span> aNum <span class="free">Ts</span><span class="main">,</span> aNum <span class="main">(</span>clk <span class="skolem">t</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
                 chan <span class="main">:=</span> insert <span class="main">(</span>dAuth <span class="free">Kab</span> <span class="main">(</span>Msg <span class="main">[</span>aAgt <span class="free">A</span><span class="main">,</span> aNum <span class="main">(</span>clk <span class="skolem">t</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chan <span class="skolem">s</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?t'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">⦇</span> runs <span class="main">:=</span> runs <span class="skolem">t</span><span class="main">(</span><span class="free">Ra</span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">,</span> aNum <span class="free">Ts</span><span class="main">,</span> aNum <span class="main">(</span>clk <span class="skolem">t</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
                 IK <span class="main">:=</span> insert <span class="main">⦃</span> Crypt <span class="free">Kab</span> <span class="main">⦃</span>Agent <span class="free">A</span><span class="main">,</span> Number <span class="main">(</span>clk <span class="skolem">t</span><span class="main">)</span><span class="main">⦄</span><span class="main">,</span> <span class="free">X</span> <span class="main">⦄</span> <span class="main">(</span>IK <span class="skolem">t</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> H <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"Secure Sv <span class="free">A</span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">,</span> aAgt <span class="free">B</span><span class="main">,</span> aNum <span class="free">Ts</span><span class="main">,</span> aNon <span class="free">Na</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> parts <span class="main">(</span>IK <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Body MPair_parts<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s'</span><span class="main">,</span> <span class="var">?t'</span><span class="main">)</span> <span class="main">∈</span> R23_msgs"</span></span> <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s'</span><span class="main">,</span> <span class="var">?t'</span><span class="main">)</span> <span class="main">∈</span> R23_keys"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> bad"</span></span>
      <span class="keyword1"><span class="command">with</span></span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">drule</span> Decrypt<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> H <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> R23_intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> analz_cut <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> analz_monotonic<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∉</span> bad"</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">note</span></span> H
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">∉</span> bad›</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> Crypt <span class="main">(</span>shrK <span class="free">B</span><span class="main">)</span> <span class="main">⦃</span>Key <span class="free">Kab</span><span class="main">,</span> Agent <span class="free">A</span><span class="main">,</span> Number <span class="free">Ts</span> <span class="main">⦄</span> <span class="main">∧</span> <span class="free">Kab</span> <span class="main">∈</span> range sesK"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv6_ticketD<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> H1<span class="main">:</span> <span class="quoted"><span class="quoted">"Key <span class="main">(</span>shrK <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="skolem">t</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"aKey <span class="free">Kab</span> <span class="main">∈</span> extr ik0 <span class="main">(</span>chan <span class="skolem">s</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">note</span></span> calculation
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"Secure Sv <span class="free">B</span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">,</span> aAgt <span class="free">A</span><span class="main">,</span> aNum <span class="free">Ts</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="skolem">s</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">drule</span> analz_into_parts<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> Body<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> MPair_parts<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
            <span class="keyword1"><span class="command">ultimately</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> H1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> R23_intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m3_inv7a_sesK_compr_simps<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s'</span><span class="main">,</span> <span class="var">?t'</span><span class="main">)</span> <span class="main">∈</span> R23_non"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> bad"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">drule</span> Decrypt<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> H
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> R23_intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> analz_cut <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> analz_monotonic<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∉</span> bad"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> Crypt <span class="main">(</span>shrK <span class="free">B</span><span class="main">)</span> <span class="main">⦃</span>Key <span class="free">Kab</span><span class="main">,</span> Agent <span class="free">A</span><span class="main">,</span> Number <span class="free">Ts</span> <span class="main">⦄</span> <span class="main">∧</span> <span class="free">Kab</span> <span class="main">∈</span> range sesK"</span></span> <span class="keyword1"><span class="command">using</span></span> H
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv6_ticketD<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> H
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> R23_intros<span class="main"><span class="keyword3">,</span></span>
                <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m3_inv7a_sesK_compr_simps m3_inv7b_sesK_compr_non_simps<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s'</span><span class="main">,</span> <span class="var">?t'</span><span class="main">)</span> <span class="main">∈</span> R23_pres"</span></span> <span class="keyword1"><span class="command">using</span></span> H
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">note</span></span> calculation
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> analz_Inj_IK<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step5_refines_m2_step5<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
     <span class="main">(</span>m2_step5 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step5 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step6_refines_m2_step6<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
     <span class="main">(</span>m2_step6 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step6 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">Ta</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_tick_refines_m2_tick<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
    <span class="main">(</span>m2_tick <span class="free">T</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_tick <span class="free">T</span><span class="main">)</span>
   <span class="main">{&gt;</span>R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_purge_refines_m2_purge<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
     <span class="main">(</span>m2_purge <span class="free">A</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_purge <span class="free">A</span><span class="main">)</span>
   <span class="main">{&gt;</span>R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Intruder events.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_leak_refines_m2_leak<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
     <span class="main">(</span>m2_leak <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Ts</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_leak <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Ts</span><span class="main">)</span>
   <span class="main">{&gt;</span>R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> R23_dests<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_DY_fake_refines_m2_fake<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23 <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">(</span>m3_inv4_lkeysec<span class="main">)</span><span class="main">}</span>
     m2_fake<span class="main">,</span> m3_DY_fake
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros
            <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> abs_msg.cases<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> abs_msg_DY_subset_fakeable <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span>
            <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> abs_msg.cases<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> R23_dests<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All together now...›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_m3_trans_refines_m2_trans <span class="main">=</span>
  PO_m3_step1_refines_m2_step1 PO_m3_step2_refines_m2_step2
  PO_m3_step3_refines_m2_step3 PO_m3_step4_refines_m2_step4
  PO_m3_step5_refines_m2_step5 PO_m3_step6_refines_m2_step6
  PO_m3_tick_refines_m2_tick PO_m3_purge_refines_m2_purge
  PO_m3_leak_refines_m2_leak PO_m3_DY_fake_refines_m2_fake


<span class="keyword1"><span class="command">lemma</span></span> PO_m3_refines_init_m2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m3 <span class="main">⊆</span> R23<span class="main">``</span><span class="main">(</span>init m2<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_refines_trans_m2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23 <span class="main">∩</span> <span class="main">(</span>m2_inv3a_sesK_compr<span class="main">)</span>
        <span class="main">×</span> <span class="main">(</span>m3_inv7a_sesK_compr <span class="main">∩</span> m3_inv7b_sesK_compr_non <span class="main">∩</span> m3_inv6_ticket <span class="main">∩</span> m3_inv4_lkeysec<span class="main">)</span><span class="main">}</span>
     <span class="main">(</span>trans m2<span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans m3<span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m3_def m3_trans_def m2_def m2_trans_def<span class="main">)</span>
   <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_m3_trans_refines_m2_trans<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_observation_consistent <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"obs_consistent R23 med32 m2 m3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R23_def med32_def m3_defs<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement result.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m3_refines_m2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"refines
     <span class="main">(</span>R23 <span class="main">∩</span>
      <span class="main">(</span>m2_inv3a_sesK_compr<span class="main">)</span> <span class="main">×</span>
      <span class="main">(</span>m3_inv7a_sesK_compr <span class="main">∩</span> m3_inv7b_sesK_compr_non <span class="main">∩</span> m3_inv6_ticket <span class="main">∩</span> m3_inv4_lkeysec<span class="main">)</span><span class="main">)</span>
     med32 m2 m3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Refinement_using_invariants<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> m3_implements_m2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"implements med32 m2 m3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refinement_soundness<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Inherited invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv3 (derived): Key secrecy for initiator›</span></span>
<span class="comment1">(*invh*************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_inv3_ikk_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_inv3_ikk_init</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Ra</span> <span class="bound">K</span> <span class="bound">Ts</span> <span class="bound">nl</span><span class="main">.</span>
     runs <span class="bound">s</span> <span class="bound">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> aKey <span class="bound">K</span> <span class="main">#</span> aNum <span class="bound">Ts</span> <span class="main">#</span> <span class="bound">nl</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">A</span> <span class="main">∈</span> good <span class="main">⟶</span> <span class="bound">B</span> <span class="main">∈</span> good <span class="main">⟶</span>
     Key <span class="bound">K</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="bound">K</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">Ra</span><span class="main">$</span>na<span class="main">,</span> <span class="bound">Ts</span><span class="main">)</span> <span class="main">∈</span> leak <span class="bound">s</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_inv3_ikk_initI <span class="main">=</span> m3_inv3_ikk_init_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv3_ikk_initE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m3_inv3_ikk_init_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv3_ikk_initD <span class="main">=</span> m3_inv3_ikk_init_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv3_ikk_init<span class="main">:</span> <span class="quoted"><span class="quoted">"reach m3 <span class="main">⊆</span> m3_inv3_ikk_init"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> INV_from_Refinement_using_invariants <span class="main"><span class="main">[</span></span><span class="operator">OF</span> m3_refines_m2<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Range <span class="main">(</span>R23 <span class="main">∩</span>
          m2_inv3a_sesK_compr
          <span class="main">×</span> <span class="main">(</span>m3_inv7a_sesK_compr <span class="main">∩</span> m3_inv7b_sesK_compr_non <span class="main">∩</span> m3_inv6_ticket <span class="main">∩</span> m3_inv4_lkeysec<span class="main">)</span>
        <span class="main">∩</span> m2_inv6_ikk_init <span class="main">×</span> UNIV<span class="main">)</span>
      <span class="main">⊆</span> m3_inv3_ikk_init"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23_def R23_pres_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv3_ikk_initI<span class="main">)</span>
       <span class="main">(</span><span class="operator">elim</span> m2_inv6_ikk_initE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> R23_keys_dests<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv4 (derived): Key secrecy for responder›</span></span>
<span class="comment1">(*invh*************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_inv4_ikk_resp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_inv4_ikk_resp</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Rb</span> <span class="bound">K</span> <span class="bound">Ts</span> <span class="bound">nl</span><span class="main">.</span>
     runs <span class="bound">s</span> <span class="bound">Rb</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> aKey <span class="bound">K</span> <span class="main">#</span> aNum <span class="bound">Ts</span> <span class="main">#</span> <span class="bound">nl</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">A</span> <span class="main">∈</span> good <span class="main">⟶</span> <span class="bound">B</span> <span class="main">∈</span> good <span class="main">⟶</span>
     Key <span class="bound">K</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound">Na</span><span class="main">.</span> <span class="main">(</span><span class="bound">K</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">Na</span><span class="main">,</span> <span class="bound">Ts</span><span class="main">)</span> <span class="main">∈</span> leak <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_inv4_ikk_respI <span class="main">=</span> m3_inv4_ikk_resp_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv4_ikk_respE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m3_inv4_ikk_resp_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv4_ikk_respD <span class="main">=</span> m3_inv4_ikk_resp_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv4_ikk_resp<span class="main">:</span> <span class="quoted"><span class="quoted">"reach m3 <span class="main">⊆</span> m3_inv4_ikk_resp"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> INV_from_Refinement_using_invariants <span class="main"><span class="main">[</span></span><span class="operator">OF</span> m3_refines_m2<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Range <span class="main">(</span>R23 <span class="main">∩</span> m2_inv3a_sesK_compr
                   <span class="main">×</span> <span class="main">(</span>m3_inv7a_sesK_compr <span class="main">∩</span> m3_inv7b_sesK_compr_non <span class="main">∩</span> m3_inv6_ticket <span class="main">∩</span> m3_inv4_lkeysec<span class="main">)</span>
                   <span class="main">∩</span> m2_inv7_ikk_resp <span class="main">×</span> UNIV<span class="main">)</span>
      <span class="main">⊆</span> m3_inv4_ikk_resp"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23_def R23_pres_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv4_ikk_respI<span class="main">)</span>
       <span class="main">(</span><span class="operator">elim</span> m2_inv7_ikk_respE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> R23_keys_dests<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="m1_nssk">
<div class="head">
<h1>Theory m1_nssk</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Development of Security Protocols by Refinement

  Module:  Key_establish/m1_nssk.thy (Isabelle/HOL 2016-1)
  ID:      $Id: m1_nssk.thy 133856 2017-03-20 18:05:54Z csprenge $
  Author:  Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  Key distribution protocols
  First refinement: abstract server-based key transport protocol with 
  initiator and responder roles.

  Copyright (c) 2009-2016 Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Abstract Needham-Schroeder Shared Key (L1)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> m1_nssk <span class="keyword2"><span class="keyword">imports</span></span> <a href="m1_keydist_iirn.html">m1_keydist_iirn</a> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We add augment the basic abstract key distribution model such that 
the server reads and stores the initiator's nonce. We show three refinements, 
namley that this model refines
\begin{enumerate}
\item the basic key distribution model <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>m1a›</span></span></span></span>, and
\item the injective agreement model <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>a0i›</span></span></span></span>, instantiated such that 
the initiator agrees with the server on the session key and its nonce.
\item the non-injective agreement model <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>a0n›</span></span></span></span>, instantiated such that 
the responder agrees with the server on the session key.
\end{enumerate}
›</span></span>

<span class="keyword1"><span class="command">consts</span></span>
  nb <span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>       <span class="comment1">― ‹responder nonce constant›</span>
  END <span class="main">::</span> <span class="quoted"><span class="quoted">"atom"</span></span>     <span class="comment1">― ‹run end marker for responder›</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹State›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We extend the basic key distribution by adding nonces. The frames, 
the state, and the observations remain the same as in the previous model, but 
we will use the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"nat list"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>'s to store nonces.›</span></span>

<span class="keyword1"><span class="command">record</span></span> m1_state <span class="main">=</span> <span class="quoted">m1r_state</span> <span class="main">+</span> 
  leak <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>key <span class="main">×</span> fresh_t <span class="main">×</span> fresh_t<span class="main">)</span> set"</span></span>   <span class="comment1">― ‹keys leaked plus session context›</span>

<span class="keyword1"><span class="command">type_synonym</span></span> m1_obs <span class="main">=</span> <span class="quoted"><span class="quoted">"m1_state"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'x</span> m1_pred <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> m1_state_scheme set"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'x</span> m1_trans <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'x</span> m1_state_scheme <span class="main">×</span> <span class="tfree">'x</span> m1_state_scheme<span class="main">)</span> set"</span></span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Events›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">A</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m1a_step1"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1_step1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'x</span> m1r_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_step1</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">≡</span> m1a_step1 <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>    <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">B</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"m1a_step2"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1_step2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'x</span> m1r_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_step2</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> m1a_step2 <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>    <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"Server"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m1a_step3</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1_step3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> key<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'x</span> m1r_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_step3</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">≡</span> m1a_step3 <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"A"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m1a_step4</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1_step4</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> key<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'x</span> m1_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_step4</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
     <span class="comment1">― ‹guards:›</span>
     runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>
     <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>na <span class="main">∧</span>                                              <span class="comment1">― ‹fix parameter›</span>
     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">∉</span> Domain <span class="main">(</span>leak <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">∈</span> azC <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>     <span class="comment1">― ‹authorization guard›</span>

     <span class="comment1">― ‹new guard for agreement with server on <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>(Kab, B, Na)›</span></span>,›</span>
     <span class="comment1">― ‹injectiveness by including <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Na›</span></span>›</span>
     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∉</span> bad <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Rs</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">=</span> sesK <span class="main">(</span><span class="bound">Rs</span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span>
        runs <span class="bound">s</span> <span class="bound">Rs</span> <span class="main">=</span> Some <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>

     <span class="comment1">― ‹actions:›</span>
     <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">B</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m1a_step5</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1_step5</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> key<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'x</span> m1_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_step5</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Nb</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span> 
     <span class="comment1">― ‹new guards:›</span>
     <span class="free"><span class="bound"><span class="entity">Nb</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>nb <span class="main">∧</span>                                              <span class="comment1">― ‹generate Nb›</span>

     <span class="comment1">― ‹prev guards:›</span>
     runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span> 
     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">∉</span> Domain <span class="main">(</span>leak <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">∈</span> azC <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>    <span class="comment1">― ‹authorization guard›</span>

     <span class="comment1">― ‹guard for showing agreement with server on <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>(Kab, A)›</span></span>,›</span>
     <span class="comment1">― ‹this agreement is non-injective›</span>
     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∉</span> bad <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Rs</span> <span class="bound">Na</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">=</span> sesK <span class="main">(</span><span class="bound">Rs</span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span>
        runs <span class="bound">s</span> <span class="bound">Rs</span> <span class="main">=</span> Some <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="bound">Na</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>

     <span class="comment1">― ‹actions:›</span>
     <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">A</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">skip</span></span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1_step6</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> nonce<span class="main">,</span> key<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'x</span> m1_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_step6</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Nb</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span> 
    runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span>      <span class="comment1">― ‹key recv'd before›</span>
    <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>na <span class="main">∧</span>

    <span class="comment1">― ‹guard for showing agreement with <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>B›</span></span> on <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Kab›</span></span> and <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Nb›</span></span>›</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∉</span> bad <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∉</span> bad <span class="main">⟶</span> 
    <span class="main">(</span><span class="main">∀</span><span class="bound">Nb'</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">,</span> <span class="bound">Nb'</span><span class="main">)</span> <span class="main">∉</span> leak <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span>    <span class="comment1">― ‹NEW: weaker condition›</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound">Rb</span> <span class="bound">nl</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">Nb</span></span></span> <span class="main">=</span> <span class="bound">Rb</span><span class="main">$</span>nb <span class="main">∧</span> runs <span class="bound">s</span> <span class="bound">Rb</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">#</span> <span class="bound">nl</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> 

    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aNon <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">B</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">skip</span></span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1_step7</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> key<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'x</span> m1_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_step7</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Nb</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span>      <span class="comment1">― ‹key recv'd before›</span>
    <span class="free"><span class="bound"><span class="entity">Nb</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>nb <span class="main">∧</span>

    <span class="comment1">― ‹guard for showing agreement with <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>A›</span></span> on <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Kab›</span></span> and <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Nb›</span></span>›</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∉</span> bad <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∉</span> bad <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">∉</span> Domain <span class="main">(</span>leak <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span> 
      <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>(∀Na'. (Kab, Na', Nb) ∉ leak s) ⟶›</span></span> too strong, does not work›</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">Ra</span><span class="main">.</span> runs <span class="bound">s</span> <span class="bound">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aNon <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> 
     
    <span class="comment1">― ‹actions: (redundant) update local state marks successful termination›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> END<span class="main">]</span><span class="main">)</span><span class="main">)</span>
    <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by attacker, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">s0g_leak</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1_leak</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> rid_t<span class="main">,</span> rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'x</span> m1_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_leak</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>           
    <span class="comment1">― ‹guards:›</span>
    runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>na<span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span>
    runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="main">(</span>sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span><span class="main">,</span> aNon <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>nb<span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span>  
    runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="main">(</span>sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span><span class="main">,</span> END<span class="main">]</span><span class="main">)</span> <span class="main">∧</span>  

    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> leak <span class="main">:=</span> insert <span class="main">(</span>sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>na<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>nb<span class="main">)</span> <span class="main">(</span>leak <span class="bound">s</span><span class="main">)</span> <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Specification›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">m1_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m1_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_init</span> <span class="main">≡</span> <span class="main">{</span> <span class="main">⦇</span>
     runs <span class="main">=</span> Map.empty<span class="main">,</span>
     leak <span class="main">=</span> corrKey <span class="main">×</span> <span class="main">{</span>undefined<span class="main">}</span> <span class="main">×</span> <span class="main">{</span>undefined<span class="main">}</span>      <span class="comment1">― ‹initial leakage›</span>
  <span class="main">⦈</span> <span class="main">}</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m1_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> m1_trans"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_trans</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Ra</span> <span class="bound">Rb</span> <span class="bound">Rs</span> <span class="bound">Na</span> <span class="bound">Nb</span> <span class="bound">Kab</span><span class="main">.</span>
     m1_step1 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="main">∪</span>
     m1_step2 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">∪</span>
     m1_step3 <span class="bound">Rs</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Kab</span> <span class="main">∪</span>
     m1_step4 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Kab</span> <span class="main">∪</span>
     m1_step5 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Nb</span> <span class="bound">Kab</span> <span class="main">∪</span>
     m1_step6 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Nb</span> <span class="bound">Kab</span> <span class="main">∪</span>
     m1_step7 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Nb</span> <span class="bound">Kab</span> <span class="main">∪</span>
     m1_leak <span class="bound">Rs</span> <span class="bound">Ra</span> <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">∪</span>
     Id
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m1_state<span class="main">,</span> m1_obs<span class="main">)</span> spec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="main">≡</span> <span class="main">⦇</span>
    init <span class="main">=</span> m1_init<span class="main">,</span>
    trans <span class="main">=</span> m1_trans<span class="main">,</span>
    obs <span class="main">=</span> id
  <span class="main">⦈</span>"</span></span> 

<span class="keyword1"><span class="command">lemmas</span></span> m1_loc_defs <span class="main">=</span> 
  m1_def m1_trans_def
  m1_step1_def m1_step2_def m1_step3_def m1_step4_def m1_step5_def 
  m1_step6_def m1_step7_def m1_leak_def

<span class="keyword1"><span class="command">lemmas</span></span> m1_defs <span class="main">=</span> m1_loc_defs m1a_defs 

<span class="keyword1"><span class="command">lemma</span></span> m1_obs_id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"obs m1 <span class="main">=</span> id"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1_def<span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv0: Finite domain›</span></span>
<span class="comment1">(*inv**************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹There are only finitely many runs. This is needed to establish the 
responder/initiator agreements. This is already defined in the previous model,
we just need to show that it still holds in the current model.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">m1_inv0_fin</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> m1_pred"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_inv0_fin</span> <span class="main">≡</span> m1a_inv0_fin"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m1_inv0_finI <span class="main">=</span> m1a_inv0_finI
<span class="keyword1"><span class="command">lemmas</span></span> m1_inv0_finE <span class="main">=</span> m1a_inv0_finE
<span class="keyword1"><span class="command">lemmas</span></span> m1_inv0_finD <span class="main">=</span> m1a_inv0_finD


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proofs.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_inv0_fin_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m1 <span class="main">⊆</span> m1_inv0_fin"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m1_inv0_finI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_inv0_fin_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m1_inv0_fin<span class="main">}</span> trans m1 <span class="main">{&gt;</span> m1_inv0_fin<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m1_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m1_inv0_finI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_inv0_fin <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m1 <span class="main">⊆</span> m1_inv0_fin"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_incr<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> PO_m1_inv0_fin <span class="main">[</span><span class="operator">THEN</span> subsetD<span class="main">,</span> <span class="operator">intro</span><span class="main">]</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>m1a›</span></span></span></span>›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Simulation relation›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹med1a1: The mediator function maps a concrete observation (i.e., run) 
to an abstract one.›</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Instantiate parameters regarding list of freshness identifiers stored
at server.›</span></span>

<span class="keyword1"><span class="command">overloading</span></span> is_len' <span class="main">≡</span> <span class="quoted"><span class="quoted">"is_len"</span></span> rs_len' <span class="main">≡</span> <span class="quoted"><span class="quoted">"rs_len"</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> is_len_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">is_len'</span> <span class="main">≡</span> <span class="main">0</span><span class="main">::</span>nat"</span></span>
<span class="keyword1"><span class="command">definition</span></span> rs_len_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rs_len'</span> <span class="main">≡</span> <span class="main">0</span><span class="main">::</span>nat"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">fun</span></span> 
  <span class="entity">rm1a1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"role_t <span class="main">⇒</span> atom list <span class="main">⇒</span> atom list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rm1a1</span> Init <span class="main">=</span> take <span class="main">(</span>Suc is_len<span class="main">)</span>"</span></span>       <span class="comment1">― ‹take <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Kab›</span></span>›</span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rm1a1</span> Resp <span class="main">=</span> take <span class="main">(</span>Suc rs_len<span class="main">)</span>"</span></span>       <span class="comment1">― ‹take <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Kab›</span></span>›</span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rm1a1</span> Serv <span class="main">=</span> id"</span></span>                      <span class="comment1">― ‹take all›</span>

<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="entity">runs1a1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"runs_t <span class="main">⇒</span> runs_t"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">runs1a1</span> <span class="main">≡</span> map_runs rm1a1"</span></span> 

<span class="keyword1"><span class="command">lemmas</span></span> runs1a1_def <span class="main">=</span> map_runs_def

<span class="keyword1"><span class="command">lemma</span></span> knC_runs1a1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"knC <span class="main">(</span>runs1a1 <span class="free">runz</span><span class="main">)</span> <span class="main">=</span> knC <span class="free">runz</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_runs_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> knC.cases<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> b<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">b</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> b<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">b</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> knC_init<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> runs1a1_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> knC_resp<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> runs1a1_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> knC_serv<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> runs1a1_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹R1a1: The simulation relation is defined in terms of the mediator
function.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">med1a1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m1_obs <span class="main">⇒</span> m1a_obs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med1a1</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> runs <span class="main">=</span> runs1a1 <span class="main">(</span>runs <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">,</span> m1x_state.leak <span class="main">=</span> Domain <span class="main">(</span>leak <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">⦈</span>"</span></span>
   
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R1a1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m1a_state <span class="main">×</span> m1_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R1a1</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> med1a1 <span class="bound">t</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> R1a1_defs <span class="main">=</span> R1a1_def med1a1_def 


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement proof›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step1_refines_m1a_step1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R1a1<span class="main">}</span> 
     <span class="main">(</span>m1a_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R1a1<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R1a1_defs m1_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step2_refines_m1a_step2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R1a1<span class="main">}</span> 
     <span class="main">(</span>m1a_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R1a1<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R1a1_defs m1_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step3_refines_m1a_step3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R1a1<span class="main">}</span> 
     <span class="main">(</span>m1a_step3 <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Na</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1_step3 <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span><span class="main">)</span>
   <span class="main">{&gt;</span> R1a1<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R1a1_defs m1_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step4_refines_m1a_step4<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R1a1<span class="main">}</span> 
     <span class="main">(</span>m1a_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R1a1<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R1a1_defs m1_defs runs1a1_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step5_refines_m1a_step5<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R1a1<span class="main">}</span> 
     <span class="main">(</span>m1a_step5 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1_step5 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Nb</span> <span class="free">Kab</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R1a1<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R1a1_defs m1_defs runs1a1_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step6_refines_m1a_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R1a1<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1_step6 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Nb</span> <span class="free">Kab</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R1a1<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R1a1_defs m1_defs runs1a1_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step7_refines_m1a_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R1a1<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1_step7 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Nb</span> <span class="free">Kab</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R1a1<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R1a1_defs m1_defs runs1a1_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_leak_refines_m1a_leak<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R1a1<span class="main">}</span> 
     <span class="main">(</span>m1a_leak <span class="free">Rs</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1_leak <span class="free">Rs</span> <span class="free">Ra</span> <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span>
   <span class="main">{&gt;</span> R1a1<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R1a1_defs m1_defs map_runs_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All together now...›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_m1_trans_refines_m1a_trans <span class="main">=</span> 
  PO_m1_step1_refines_m1a_step1 PO_m1_step2_refines_m1a_step2
  PO_m1_step3_refines_m1a_step3 PO_m1_step4_refines_m1a_step4
  PO_m1_step5_refines_m1a_step5 PO_m1_step6_refines_m1a_skip 
  PO_m1_step7_refines_m1a_skip PO_m1_leak_refines_m1a_leak

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_refines_init_m1a <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m1 <span class="main">⊆</span>  R1a1<span class="main">``</span><span class="main">(</span>init m1a<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R1a1_defs m1a_defs m1_loc_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_refines_trans_m1a <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R1a1<span class="main">}</span> 
     <span class="main">(</span>trans m1a<span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans m1<span class="main">)</span> 
   <span class="main">{&gt;</span> R1a1<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1_def m1_trans_def m1a_def m1a_trans_def
         <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_m1_trans_refines_m1a_trans<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_m1_trans_refines_m1a_trans<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Observation consistency.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> obs_consistent_med1a1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"obs_consistent R1a1 med1a1 m1a m1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R1a1_def med1a1_def m1a_def m1_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement result.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_refines_m1a <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"refines R1a1 med1a1 m1a m1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Refinement_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>  m1_implements_m1a <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"implements med1a1 m1a m1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refinement_soundness<span class="main">)</span> <span class="main">(</span><span class="operator">fast</span><span class="main">)</span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv (inherited): Key secrecy›</span></span>
<span class="comment1">(*invh**************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Secrecy, as external and internal invariant›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m1_secrecy</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> m1_pred"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_secrecy</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> knC <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">⊆</span> azC <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∪</span> Domain <span class="main">(</span>leak <span class="bound">s</span><span class="main">)</span> <span class="main">×</span> UNIV<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m1_secrecyI <span class="main">=</span> m1_secrecy_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m1_secrecyE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m1_secrecy_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>


<span class="keyword1"><span class="command">lemma</span></span> PO_m1_obs_secrecy <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach m1 <span class="main">⊆</span> m1_secrecy"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> Q<span class="main"><span class="main">=</span></span><span class="quoted">m1x_secrecy</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> external_invariant_translation<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> med1a1_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m1_secrecyI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_secrecy <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m1 <span class="main">⊆</span> m1_secrecy"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> external_to_internal_invariant<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>

<span class="comment1">(*
subsubsection {* inv (inherited): Disjointness of session and static keys *}
(******************************************************************************)

lemma PO_m1_inv0b_key [iff]: "reach m1 ⊆ m1a_inv0b_key"
apply (rule_tac Pa=m1a_inv0b_key and Qa=m1a_inv0b_key and Q=m1a_inv0b_key
       in internal_invariant_translation)
apply (auto del: subsetI)
apply (force simp add: med1a1_def runs1a1_def vimage_def m1a_inv0b_key_def)
done
*)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv (inherited): Initiator auth server.›</span></span>
<span class="comment1">(*invh*************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Simplified version of invariant <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>m1a_inv2i_serv›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m1_inv2i_serv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> m1r_pred"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_inv2i_serv</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Ra</span> <span class="bound">Na</span> <span class="bound">Kab</span> <span class="bound">nla</span><span class="main">.</span>
     <span class="bound">A</span> <span class="main">∉</span> bad <span class="main">⟶</span> 
     runs <span class="bound">s</span> <span class="bound">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> aKey <span class="bound">Kab</span> <span class="main">#</span> <span class="bound">nla</span><span class="main">)</span> <span class="main">⟶</span>
     <span class="bound">Na</span> <span class="main">=</span> <span class="bound">Ra</span><span class="main">$</span>na <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound">Rs</span><span class="main">.</span> <span class="bound">Kab</span> <span class="main">=</span> sesK <span class="main">(</span><span class="bound">Rs</span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span> runs <span class="bound">s</span> <span class="bound">Rs</span> <span class="main">=</span> Some <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="bound">Na</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m1_inv2i_servI <span class="main">=</span> m1_inv2i_serv_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m1_inv2i_servE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m1_inv2i_serv_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m1_inv2i_servD <span class="main">=</span> m1_inv2i_serv_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 2<span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Proof of invariance.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_inv2i_serv <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m1 <span class="main">⊆</span> m1_inv2i_serv"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> Pa<span class="main"><span class="main">=</span></span><span class="quoted">m1a_inv2i_serv</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Qa<span class="main"><span class="main">=</span></span><span class="quoted">m1a_inv2i_serv</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Q<span class="main"><span class="main">=</span></span><span class="quoted">m1_inv2i_serv</span>
       <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> internal_invariant_translation<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1a_inv2i_serv_def med1a1_def vimage_def 
            <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m1_inv2i_servI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> s A B Ra Kab nla<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">A</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">B</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Ra</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Kab</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> runs1a1_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">declare</span></span> PO_m1_inv2i_serv <span class="main">[</span><span class="operator">THEN</span> subsetD<span class="main">,</span> <span class="operator">intro</span><span class="main">]</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv (inherited): Responder auth server.›</span></span>
<span class="comment1">(*invh*************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Simplified version of invarant <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>m1a_inv2r_serv›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m1_inv2r_serv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> m1r_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_inv2r_serv</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Rb</span> <span class="bound">Kab</span> <span class="bound">nlb</span><span class="main">.</span>
     <span class="bound">B</span> <span class="main">∉</span> bad <span class="main">⟶</span> 
     runs <span class="bound">s</span> <span class="bound">Rb</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> aKey <span class="bound">Kab</span> <span class="main">#</span> <span class="bound">nlb</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound">Rs</span> <span class="bound">Na</span><span class="main">.</span> <span class="bound">Kab</span> <span class="main">=</span> sesK <span class="main">(</span><span class="bound">Rs</span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span> runs <span class="bound">s</span> <span class="bound">Rs</span> <span class="main">=</span> Some <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="bound">Na</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m1_inv2r_servI <span class="main">=</span> m1_inv2r_serv_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m1_inv2r_servE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m1_inv2r_serv_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m1_inv2r_servD <span class="main">=</span> m1_inv2r_serv_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> -1<span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Proof of invariance.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_inv2r_serv <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m1 <span class="main">⊆</span> m1_inv2r_serv"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> Pa<span class="main"><span class="main">=</span></span><span class="quoted">m1a_inv2r_serv</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Qa<span class="main"><span class="main">=</span></span><span class="quoted">m1a_inv2r_serv</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Q<span class="main"><span class="main">=</span></span><span class="quoted">m1_inv2r_serv</span>
       <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> internal_invariant_translation<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1a_inv2r_serv_def med1a1_def vimage_def 
            <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m1_inv2r_servI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> s A B Rb Kab nlb<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">A</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">B</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Rb</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Kab</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> runs1a1_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">declare</span></span> PO_m1_inv2r_serv <span class="main">[</span><span class="operator">THEN</span> subsetD<span class="main">,</span> <span class="operator">intro</span><span class="main">]</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv (inherited): Initiator key freshness›</span></span>
<span class="comment1">(*invh*************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m1_inv3_ifresh</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> m1_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_inv3_ifresh</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="bound">A'</span> <span class="bound">B</span> <span class="bound">B'</span> <span class="bound">Ra</span> <span class="bound">Ra'</span> <span class="bound">Kab</span> <span class="bound">nl</span> <span class="bound">nl'</span><span class="main">.</span>
     runs <span class="bound">s</span> <span class="bound">Ra</span>  <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span>  <span class="bound">B</span><span class="main">]</span><span class="main">,</span>  aKey <span class="bound">Kab</span> <span class="main">#</span> <span class="bound">nl</span><span class="main">)</span> <span class="main">⟶</span>
     runs <span class="bound">s</span> <span class="bound">Ra'</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="bound">A'</span><span class="main">,</span> <span class="bound">B'</span><span class="main">]</span><span class="main">,</span> aKey <span class="bound">Kab</span> <span class="main">#</span> <span class="bound">nl'</span><span class="main">)</span> <span class="main">⟶</span>
     <span class="bound">A</span> <span class="main">∉</span> bad <span class="main">⟶</span> <span class="bound">B</span> <span class="main">∉</span> bad <span class="main">⟶</span> <span class="bound">Kab</span> <span class="main">∉</span> Domain <span class="main">(</span>leak <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="bound">Ra</span> <span class="main">=</span> <span class="bound">Ra'</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m1_inv3_ifreshI <span class="main">=</span> m1_inv3_ifresh_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m1_inv3_ifreshE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m1_inv3_ifresh_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m1_inv3_ifreshD <span class="main">=</span> m1_inv3_ifresh_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_inv3_ifresh <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m1 <span class="main">⊆</span> m1_inv3_ifresh"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> Pa<span class="main"><span class="main">=</span></span><span class="quoted">m1a_inv1_ifresh</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Qa<span class="main"><span class="main">=</span></span><span class="quoted">m1a_inv1_ifresh</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Q<span class="main"><span class="main">=</span></span><span class="quoted">m1_inv3_ifresh</span> 
       <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> internal_invariant_translation<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> med1a1_def runs1a1_def vimage_def m1_inv3_ifresh_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>a0i›</span></span></span></span> for initiator/responder›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Simulation relation›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define two auxiliary functions to reconstruct the signals of the
initial model from completed initiator and responder runs. For the initiator, 
we get an injective agreement with the responder on Kab and Nb.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  irsig <span class="main">=</span> <span class="quoted"><span class="quoted">"key <span class="main">×</span> nonce"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">ir_commit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>runs_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> key<span class="main">,</span> nonce<span class="main">]</span> <span class="main">⇒</span> rid_t set"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ir_commit</span> <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Nb</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">Ra</span><span class="main">.</span> 
     <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="bound">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aNon <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">]</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">ir_runs2sigs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"runs_t <span class="main">⇒</span> irsig signal <span class="main">⇒</span> nat"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ir_runs2sigs</span> <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="main">(</span>Commit <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
     card <span class="main">(</span>ir_commit <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ir_runs2sigs</span> <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="main">(</span>Running <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="main">∃</span><span class="bound">Rb</span> <span class="bound">nl</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">Nb</span></span></span> <span class="main">=</span> <span class="bound">Rb</span><span class="main">$</span>nb <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="bound">Rb</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">#</span> <span class="bound">nl</span><span class="main">)</span> 
      <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ir_runs2sigs</span> <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">0</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Simulation relation and mediator function. We map completed initiator 
and responder runs to commit and running signals, respectively.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">med_a0im1_ir</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m1_obs <span class="main">⇒</span> irsig a0i_obs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med_a0im1_ir</span> <span class="free"><span class="bound"><span class="entity">o1</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> signals <span class="main">=</span> ir_runs2sigs <span class="main">(</span>runs <span class="free"><span class="bound"><span class="entity">o1</span></span></span><span class="main">)</span><span class="main">,</span> corrupted <span class="main">=</span> Domain <span class="main">(</span>leak <span class="free"><span class="bound"><span class="entity">o1</span></span></span><span class="main">)</span> <span class="main">×</span> UNIV <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R_a0im1_ir</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>irsig a0i_state <span class="main">×</span> m1_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R_a0im1_ir</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> signals <span class="bound">s</span> <span class="main">=</span> ir_runs2sigs <span class="main">(</span>runs <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> corrupted <span class="bound">s</span> <span class="main">=</span> Domain <span class="main">(</span>leak <span class="bound">t</span><span class="main">)</span> <span class="main">×</span> UNIV<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> R_a0im1_ir_defs <span class="main">=</span> R_a0im1_ir_def med_a0im1_ir_def 


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Lemmas about the abstraction function›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> ir_runs2sigs_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
   <span class="quoted"><span class="quoted">"<span class="free">runz</span> <span class="main">=</span> Map.empty <span class="main">⟹</span> ir_runs2sigs <span class="free">runz</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span> 
   <span class="main">(</span><span class="operator">rule</span> ir_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_ir_commit <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> 
   <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">runz</span><span class="main">)</span> <span class="main">⟹</span> finite <span class="main">(</span>ir_commit <span class="free">runz</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Nb</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Update lemmas›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ir_runs2sigs_upd_init_none <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Ra</span> <span class="main">∉</span> dom <span class="free">runz</span> <span class="main">⟧</span>
  <span class="main">⟹</span> ir_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Ra</span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ir_runs2sigs <span class="free">runz</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span>
   <span class="main">(</span><span class="operator">rule</span> ir_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ir_runs2sigs_upd_resp_none <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Rb</span> <span class="main">∉</span> dom <span class="free">runz</span> <span class="main">⟧</span>
  <span class="main">⟹</span> ir_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Rb</span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ir_runs2sigs <span class="free">runz</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span>
   <span class="main">(</span><span class="operator">rule</span> ir_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ir_runs2sigs_upd_serv_none <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Rs</span> <span class="main">∉</span> dom <span class="free">runz</span> <span class="main">⟧</span>
  <span class="main">⟹</span> ir_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Rs</span> <span class="main">↦</span> <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="free">nl</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ir_runs2sigs <span class="free">runz</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span>
   <span class="main">(</span><span class="operator">rule</span> ir_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ir_runs2sigs_upd_init_some <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">runz</span> <span class="free">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> ir_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Ra</span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ir_runs2sigs <span class="free">runz</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span>
   <span class="main">(</span><span class="operator">rule</span> ir_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ir_runs2sigs_upd_resp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">runz</span> <span class="free">Rb</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> ir_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Rb</span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span>ir_runs2sigs <span class="free">runz</span><span class="main">)</span><span class="main">(</span>Running <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span> <span class="main">(</span><span class="free">Kab</span><span class="main">,</span> <span class="free">Rb</span><span class="main">$</span>nb<span class="main">)</span> <span class="main">:=</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ir_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> ir_runs2sigs_upd_init <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">runz</span> <span class="free">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">]</span><span class="main">)</span><span class="main">;</span> finite <span class="main">(</span>dom <span class="free">runz</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> ir_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Ra</span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">,</span> aNon <span class="free">Nb</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
     <span class="main">(</span>ir_runs2sigs <span class="free">runz</span><span class="main">)</span>
       <span class="main">(</span>Commit <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span> <span class="main">(</span><span class="free">Kab</span><span class="main">,</span> <span class="free">Nb</span><span class="main">)</span> <span class="main">:=</span> Suc <span class="main">(</span>card <span class="main">(</span>ir_commit <span class="free">runz</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Nb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?a0.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">runz</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> ir_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="comment1">― ‹1 subgoal, solved using <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> "card_insert_disjoint"<span class="antiquote">}</span></span>›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> runz<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> 
         s<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"card <span class="main">(</span>insert <span class="free">Ra</span> <span class="main">(</span>ir_commit <span class="improper">runz</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Nb</span><span class="main">)</span><span class="main">)</span>"</span></span> 
       <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> ir_runs2sigs_upd_resp_some <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">runz</span> <span class="free">Rb</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free">K</span><span class="main">]</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> ir_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Rb</span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free">K</span><span class="main">,</span> END<span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ir_runs2sigs <span class="free">runz</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span> 
   <span class="main">(</span><span class="operator">rule</span> ir_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Needed for injectiveness of agreement.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m1_inv2i_serv_lemma<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> runs <span class="free">t</span> <span class="free">Ra</span>  <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">,</span> aNon <span class="free">Nb</span><span class="main">]</span><span class="main">)</span><span class="main">;</span>
     runs <span class="free">t</span> <span class="free">Ra'</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">]</span><span class="main">)</span><span class="main">;</span> 
     <span class="free">A</span> <span class="main">∉</span> bad<span class="main">;</span> <span class="free">t</span> <span class="main">∈</span> m1_inv2i_serv <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> m1_inv2i_servD<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rotate_tac</span> 1<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> m1_inv2i_servD<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement proof›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step1_refines_ir_a0i_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0im1_ir<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0im1_ir<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0im1_ir_defs m1_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step2_refines_ir_a0i_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0im1_ir<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0im1_ir<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0im1_ir_defs m1_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step3_refines_ir_a0i_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0im1_ir<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1_step3 <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0im1_ir<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0im1_ir_defs m1_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step4_refines_ir_a0i_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0im1_ir<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0im1_ir<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0im1_ir_defs a0i_defs m1_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step5_refines_ir_a0i_running<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0im1_ir<span class="main">}</span> 
     <span class="main">(</span>a0i_running <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span> <span class="main">(</span><span class="free">Kab</span><span class="main">,</span> <span class="free">Nb</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1_step5 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Nb</span> <span class="free">Kab</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0im1_ir<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0im1_ir_defs a0i_defs m1_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step6_refines_ir_a0i_commit<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0im1_ir <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">(</span>m1_inv2i_serv <span class="main">∩</span> m1_inv0_fin<span class="main">)</span><span class="main">}</span> 
     <span class="main">(</span>a0i_commit <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span> <span class="main">(</span><span class="free">Kab</span><span class="main">,</span> <span class="free">Nb</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1_step6 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Nb</span> <span class="free">Kab</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0im1_ir<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0im1_ir_defs a0i_defs m1_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m1_inv2i_serv_lemma<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step7_refines_ir_a0i_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0im1_ir<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1_step7 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Nb</span> <span class="free">Kab</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0im1_ir<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0im1_ir_defs a0i_defs m1_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_leak_refines_ir_a0i_corrupt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0im1_ir<span class="main">}</span> 
     <span class="main">(</span>a0i_corrupt <span class="main">(</span><span class="main">{</span>sesK <span class="main">(</span><span class="free">Rs</span><span class="main">$</span>sk<span class="main">)</span><span class="main">}</span> <span class="main">×</span> UNIV<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1_leak <span class="free">Rs</span> <span class="free">Ra</span> <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0im1_ir<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0im1_ir_defs a0i_defs m1_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All together now...›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_m1_trans_refines_ir_a0i_trans <span class="main">=</span> 
  PO_m1_step1_refines_ir_a0i_skip PO_m1_step2_refines_ir_a0i_skip
  PO_m1_step3_refines_ir_a0i_skip PO_m1_step4_refines_ir_a0i_skip
  PO_m1_step5_refines_ir_a0i_running PO_m1_step6_refines_ir_a0i_commit
  PO_m1_step7_refines_ir_a0i_skip PO_m1_leak_refines_ir_a0i_corrupt 

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_refines_ir_init_a0i <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m1 <span class="main">⊆</span>  R_a0im1_ir<span class="main">``</span><span class="main">(</span>init a0i<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R_a0im1_ir_defs a0i_defs m1_defs
         <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">⦇</span>signals <span class="main">=</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">,</span> corrupted <span class="main">=</span> corrKey <span class="main">×</span> UNIV <span class="main">⦈</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_refines_ir_trans_a0i <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0im1_ir <span class="main">∩</span> reach a0i <span class="main">×</span> reach m1<span class="main">}</span> 
     <span class="main">(</span>trans a0i<span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans m1<span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0im1_ir<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> pre'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"R_a0im1_ir <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">(</span>m1_inv2i_serv <span class="main">∩</span> m1_inv0_fin<span class="main">)</span>"</span></span> 
       <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> relhoare_conseq_left<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1_def m1_trans_def a0i_def a0i_trans_def
            <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_m1_trans_refines_ir_a0i_trans<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Observation consistency.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> obs_consistent_med_a0im1_ir <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"obs_consistent R_a0im1_ir med_a0im1_ir a0i m1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R_a0im1_ir_def med_a0im1_ir_def 
         a0i_def m1_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement result.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_refines_ir_a0i <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"refines 
     <span class="main">(</span>R_a0im1_ir <span class="main">∩</span> reach a0i <span class="main">×</span> reach m1<span class="main">)</span>
     med_a0im1_ir a0i m1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Refinement_using_invariants<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>  m1_implements_ir_a0i<span class="main">:</span> <span class="quoted"><span class="quoted">"implements med_a0im1_ir a0i m1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refinement_soundness<span class="main">)</span> <span class="main">(</span><span class="operator">fast</span><span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>a0i›</span></span></span></span> for responder/initiator›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Simulation relation›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define two auxiliary functions to reconstruct the signals of the
initial model from initiator and responder runs. For the responder, we get an 
injective agreement with the initiator on Kab and Nb.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  risig <span class="main">=</span> <span class="quoted"><span class="quoted">"key <span class="main">×</span> nonce"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">ri_running</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>runs_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> key<span class="main">,</span> nonce<span class="main">]</span> <span class="main">⇒</span> rid_t set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ri_running</span> <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Nb</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">Ra</span><span class="main">.</span> 
     <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="bound">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aNon <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">]</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">ri_runs2sigs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"runs_t <span class="main">⇒</span> risig signal <span class="main">⇒</span> nat"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ri_runs2sigs</span> <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="main">(</span>Commit <span class="main">[</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
     <span class="main">(</span><span class="keyword1">if</span> <span class="main">∃</span><span class="bound">Rb</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">Nb</span></span></span> <span class="main">=</span> <span class="bound">Rb</span><span class="main">$</span>nb <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="bound">Rb</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> END<span class="main">]</span><span class="main">)</span> 
      <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ri_runs2sigs</span> <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="main">(</span>Running <span class="main">[</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
     card <span class="main">(</span>ri_running <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ri_runs2sigs</span> <span class="free"><span class="bound"><span class="entity">runz</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">0</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Simulation relation and mediator function. We map completed initiator 
and responder runs to commit and running signals, respectively.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">med_a0im1_ri</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m1_obs <span class="main">⇒</span> risig a0i_obs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med_a0im1_ri</span> <span class="free"><span class="bound"><span class="entity">o1</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> signals <span class="main">=</span> ri_runs2sigs <span class="main">(</span>runs <span class="free"><span class="bound"><span class="entity">o1</span></span></span><span class="main">)</span><span class="main">,</span> corrupted <span class="main">=</span> Domain <span class="main">(</span>leak <span class="free"><span class="bound"><span class="entity">o1</span></span></span><span class="main">)</span> <span class="main">×</span> UNIV <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R_a0im1_ri</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>risig a0i_state <span class="main">×</span> m1_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R_a0im1_ri</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> signals <span class="bound">s</span> <span class="main">=</span> ri_runs2sigs <span class="main">(</span>runs <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> corrupted <span class="bound">s</span> <span class="main">=</span> Domain <span class="main">(</span>leak <span class="bound">t</span><span class="main">)</span> <span class="main">×</span> UNIV<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> R_a0im1_ri_defs <span class="main">=</span> R_a0im1_ri_def med_a0im1_ri_def 


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Lemmas about the auxiliary functions›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> ri_runs2sigs_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">runz</span> <span class="main">=</span> Map.empty <span class="main">⟹</span> ri_runs2sigs <span class="free">runz</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span> 
   <span class="main">(</span><span class="operator">rule</span> ri_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_inv_ri_running <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> 
   <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">runz</span><span class="main">)</span> <span class="main">⟹</span> finite <span class="main">(</span>ri_running <span class="free">runz</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Nb</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Update lemmas›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ri_runs2sigs_upd_init_none <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Na</span> <span class="main">∉</span> dom <span class="free">runz</span> <span class="main">⟧</span>
  <span class="main">⟹</span> ri_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Na</span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ri_runs2sigs <span class="free">runz</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span>
   <span class="main">(</span><span class="operator">rule</span> ri_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ri_runs2sigs_upd_resp_none <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Rb</span> <span class="main">∉</span> dom <span class="free">runz</span> <span class="main">⟧</span>
  <span class="main">⟹</span> ri_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Rb</span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ri_runs2sigs <span class="free">runz</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span>
   <span class="main">(</span><span class="operator">rule</span> ri_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ri_runs2sigs_upd_serv_none <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Rs</span> <span class="main">∉</span> dom <span class="free">runz</span> <span class="main">⟧</span>
  <span class="main">⟹</span> ri_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Rs</span> <span class="main">↦</span> <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="free">nl</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ri_runs2sigs <span class="free">runz</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span>
   <span class="main">(</span><span class="operator">rule</span> ri_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ri_runs2sigs_upd_init <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">runz</span> <span class="free">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">]</span><span class="main">)</span><span class="main">;</span> finite <span class="main">(</span>dom <span class="free">runz</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> ri_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Ra</span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">,</span> aNon <span class="free">Nb</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span>ri_runs2sigs <span class="free">runz</span><span class="main">)</span>
       <span class="main">(</span>Running <span class="main">[</span><span class="free">B</span><span class="main">,</span> <span class="free">A</span><span class="main">]</span> <span class="main">(</span><span class="free">Kab</span><span class="main">,</span> <span class="free">Nb</span><span class="main">)</span> <span class="main">:=</span> Suc <span class="main">(</span>card <span class="main">(</span>ri_running <span class="free">runz</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Nb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?a0.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">runz</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> ri_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="comment1">― ‹1 subgoal, solved using <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> "card_insert_disjoint"<span class="antiquote">}</span></span>›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> runz<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> 
         s<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"card <span class="main">(</span>insert <span class="free">Ra</span> <span class="main">(</span>ri_running <span class="improper">runz</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Nb</span><span class="main">)</span><span class="main">)</span>"</span></span> 
       <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> ri_runs2sigs_upd_init_some <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">runz</span> <span class="free">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> ri_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Ra</span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ri_runs2sigs <span class="free">runz</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span>
   <span class="main">(</span><span class="operator">rule</span> ri_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ri_runs2sigs_upd_resp_some <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">runz</span> <span class="free">Rb</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">⟧</span>
  <span class="main">⟹</span> ri_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Rb</span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free">K</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ri_runs2sigs <span class="free">runz</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span>
   <span class="main">(</span><span class="operator">rule</span> ri_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ri_runs2sigs_upd_resp_some2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">runz</span> <span class="free">Rb</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">]</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> ri_runs2sigs <span class="main">(</span><span class="free">runz</span><span class="main">(</span><span class="free">Rb</span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">,</span> END<span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
     <span class="main">(</span>ri_runs2sigs <span class="free">runz</span><span class="main">)</span><span class="main">(</span>Commit <span class="main">[</span><span class="free">B</span><span class="main">,</span> <span class="free">A</span><span class="main">]</span> <span class="main">(</span><span class="free">Kab</span><span class="main">,</span> <span class="free">Rb</span><span class="main">$</span>nb<span class="main">)</span> <span class="main">:=</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ri_runs2sigs.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement proof›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step1_refines_ri_a0i_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0im1_ri<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0im1_ri<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0im1_ri_defs m1_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step2_refines_ri_a0i_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0im1_ri<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0im1_ri<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0im1_ri_defs m1_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step3_refines_ri_a0i_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0im1_ri<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1_step3 <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0im1_ri<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0im1_ri_defs a0i_defs m1_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step4_refines_ri_a0i_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0im1_ri<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Nb</span> <span class="free">Kab</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0im1_ri<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0im1_ri_defs a0i_defs m1_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step5_refines_ri_a0i_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0im1_ri<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1_step5 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Nb</span> <span class="free">Kab</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0im1_ri<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0im1_ri_defs a0i_defs m1_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step6_refines_ri_a0i_running<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0im1_ri <span class="main">∩</span> UNIV <span class="main">×</span> m1_inv0_fin<span class="main">}</span> 
     <span class="main">(</span>a0i_running <span class="main">[</span><span class="free">B</span><span class="main">,</span> <span class="free">A</span><span class="main">]</span> <span class="main">(</span><span class="free">Kab</span><span class="main">,</span> <span class="free">Nb</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1_step6 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Nb</span> <span class="free">Kab</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0im1_ri<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0im1_ri_defs a0i_defs m1_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step7_refines_ri_a0i_commit<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0im1_ri <span class="main">∩</span> UNIV <span class="main">×</span> m1_inv0_fin<span class="main">}</span> 
     <span class="main">(</span>a0i_commit <span class="main">[</span><span class="free">B</span><span class="main">,</span> <span class="free">A</span><span class="main">]</span> <span class="main">(</span><span class="free">Kab</span><span class="main">,</span> <span class="free">Nb</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1_step7 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Nb</span> <span class="free">Kab</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0im1_ri<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0im1_ri_defs a0i_defs m1_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_leak_refines_ri_a0i_corrupt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0im1_ri<span class="main">}</span> 
     <span class="main">(</span>a0i_corrupt <span class="main">(</span><span class="main">{</span>sesK <span class="main">(</span><span class="free">Rs</span><span class="main">$</span>sk<span class="main">)</span><span class="main">}</span> <span class="main">×</span> UNIV<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1_leak <span class="free">Rs</span> <span class="free">Ra</span> <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0im1_ri<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R_a0im1_ri_defs a0i_defs m1_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All together now...›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_m1_trans_refines_ri_a0i_trans <span class="main">=</span> 
  PO_m1_step1_refines_ri_a0i_skip PO_m1_step2_refines_ri_a0i_skip
  PO_m1_step3_refines_ri_a0i_skip PO_m1_step4_refines_ri_a0i_skip
  PO_m1_step5_refines_ri_a0i_skip PO_m1_step6_refines_ri_a0i_running
  PO_m1_step7_refines_ri_a0i_commit PO_m1_leak_refines_ri_a0i_corrupt

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_refines_ri_init_a0i <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m1 <span class="main">⊆</span>  R_a0im1_ri<span class="main">``</span><span class="main">(</span>init a0i<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R_a0im1_ri_defs a0i_defs m1_defs
         <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">⦇</span>signals <span class="main">=</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">,</span> corrupted <span class="main">=</span> corrKey <span class="main">×</span> UNIV <span class="main">⦈</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_refines_ri_trans_a0i <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R_a0im1_ri <span class="main">∩</span> a0i_inv1_iagree <span class="main">×</span> m1_inv0_fin<span class="main">}</span> 
     <span class="main">(</span>trans a0i<span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans m1<span class="main">)</span> 
   <span class="main">{&gt;</span> R_a0im1_ri<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1_def m1_trans_def a0i_def a0i_trans_def<span class="main">)</span>
   <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_m1_trans_refines_ri_a0i_trans<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Observation consistency.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> obs_consistent_med_a0im1_ri <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"obs_consistent R_a0im1_ri med_a0im1_ri a0i m1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R_a0im1_ri_def med_a0im1_ri_def a0i_def m1_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement result.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_refines_ri_a0i <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"refines <span class="main">(</span>R_a0im1_ri <span class="main">∩</span> a0i_inv1_iagree <span class="main">×</span> m1_inv0_fin<span class="main">)</span> med_a0im1_ri a0i m1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Refinement_using_invariants<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>  m1_implements_ri_a0i<span class="main">:</span> <span class="quoted"><span class="quoted">"implements med_a0im1_ri a0i m1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refinement_soundness<span class="main">)</span> <span class="main">(</span><span class="operator">fast</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv3 (inherited): Responder and initiator›</span></span>
<span class="comment1">(*invh*************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This is a translation of the agreement property to Level 1. It
follows from the refinement and is needed to prove inv4.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m1_inv3r_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> m1_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_inv3r_init</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Rb</span> <span class="bound">Kab</span><span class="main">.</span>
     <span class="bound">B</span> <span class="main">∉</span> bad <span class="main">⟶</span> <span class="bound">A</span> <span class="main">∉</span> bad <span class="main">⟶</span> <span class="bound">Kab</span> <span class="main">∉</span> Domain <span class="main">(</span>leak <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span>
     runs <span class="bound">s</span> <span class="bound">Rb</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="bound">Kab</span><span class="main">,</span> END<span class="main">]</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound">Ra</span> <span class="bound">nla</span><span class="main">.</span> runs <span class="bound">s</span> <span class="bound">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> aKey <span class="bound">Kab</span> <span class="main">#</span> aNon <span class="main">(</span><span class="bound">Rb</span><span class="main">$</span>nb<span class="main">)</span> <span class="main">#</span> <span class="bound">nla</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m1_inv3r_initI <span class="main">=</span> 
  m1_inv3r_init_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m1_inv3r_initE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> 
  m1_inv3r_init_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m1_inv3r_initD <span class="main">=</span> 
  m1_inv3r_init_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> -1<span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_inv3r_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m1 <span class="main">⊆</span> m1_inv3r_init"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> INV_from_Refinement_basic <span class="main"><span class="main">[</span></span><span class="operator">OF</span> PO_m1_refines_ri_a0i<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R_a0im1_ri_def a0i_inv1_iagree_def
            <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>  m1_inv3r_initI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> s A B Rb Kab a<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="improper">B</span><span class="main">,</span> <span class="improper">A</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">Kab</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
<span class="comment1">(* apply (drule_tac x="Rb$nb" in spec, auto) *)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>ri_running <span class="main">(</span>runs <span class="improper">s</span><span class="main">)</span> <span class="improper">A</span> <span class="improper">B</span> <span class="improper">Kab</span> <span class="main">(</span><span class="improper">Rb</span><span class="main">$</span>nb<span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv4: Key freshness for responder›</span></span>
<span class="comment1">(*inv**************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m1_inv4_rfresh</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> m1_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_inv4_rfresh</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Rb</span> <span class="bound">Rb'</span> <span class="bound">A</span> <span class="bound">A'</span> <span class="bound">B</span> <span class="bound">B'</span> <span class="bound">Kab</span><span class="main">.</span>
     runs <span class="bound">s</span> <span class="bound">Rb</span>  <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span>  <span class="bound">B</span> <span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="bound">Kab</span><span class="main">,</span> END<span class="main">]</span><span class="main">)</span> <span class="main">⟶</span> 
     runs <span class="bound">s</span> <span class="bound">Rb'</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="bound">A'</span><span class="main">,</span> <span class="bound">B'</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="bound">Kab</span><span class="main">,</span> END<span class="main">]</span><span class="main">)</span> <span class="main">⟶</span> 
     <span class="bound">B</span> <span class="main">∉</span> bad <span class="main">⟶</span> <span class="bound">A</span> <span class="main">∉</span> bad <span class="main">⟶</span> <span class="bound">Kab</span> <span class="main">∉</span> Domain <span class="main">(</span>leak <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="bound">Rb</span> <span class="main">=</span> <span class="bound">Rb'</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m1_inv4_rfreshI <span class="main">=</span> m1_inv4_rfresh_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m1_inv4_rfreshE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m1_inv4_rfresh_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m1_inv4_rfreshD <span class="main">=</span> m1_inv4_rfresh_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Proof of key freshness for responder›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_inv4_rfresh_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m1 <span class="main">⊆</span> m1_inv4_rfresh"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m1_inv4_rfreshI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_inv4_rfresh_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m1_inv4_rfresh <span class="main">∩</span> m1_inv3r_init <span class="main">∩</span> m1_inv2r_serv <span class="main">∩</span> m1_inv3_ifresh <span class="main">∩</span> m1_secrecy<span class="main">}</span> 
      trans m1 
   <span class="main">{&gt;</span> m1_inv4_rfresh<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m1_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m1_inv4_rfreshI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m1_inv4_rfreshD<span class="main">)</span> 

<span class="comment1">― ‹4 subgoals, from responder's final step 7›</span>  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> Rb A A' B B' Kab xa xe<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule_tac</span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">B</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> m1_inv2r_servD<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">B'</span> <span class="main">∉</span> bad"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m1_inv2r_servD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sesK <span class="main">(</span><span class="improper">Rs</span><span class="main">$</span>sk<span class="main">)</span><span class="main">,</span> <span class="improper">B'</span><span class="main">)</span> <span class="main">∈</span> azC <span class="main">(</span>runs <span class="improper">xa</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> m1_secrecyE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> azC.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> Rb A A' B B' Kab xa xe<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule_tac</span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">B</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> m1_inv2r_servD<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sesK <span class="main">(</span><span class="improper">Rs</span><span class="main">$</span>sk<span class="main">)</span><span class="main">,</span> <span class="improper">B'</span><span class="main">)</span> <span class="main">∈</span> azC <span class="main">(</span>runs <span class="improper">xa</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> m1_secrecyE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> azC.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> Rb' A A' B B' Kab xa xe Ra<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">A'</span> <span class="main">∉</span> bad <span class="main">∧</span> <span class="improper">B'</span> <span class="main">∉</span> bad"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> m1_inv3r_initD<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> Raa nla<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule_tac</span> Ra<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Ra</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> m1_inv3_ifreshD<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">Ra</span> <span class="main">=</span> <span class="improper">Raa</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

    <span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"A' ∈ bad"</span><span class="antiquote">}</span></span>›</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule_tac</span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">B</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> m1_inv2r_servD<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> Rs Na<span class="main">)</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">B'</span> <span class="main">∉</span> bad"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m1_inv2r_servD<span class="main">)</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sesK <span class="main">(</span><span class="improper">Rs</span><span class="main">$</span>sk<span class="main">)</span><span class="main">,</span> <span class="improper">B'</span><span class="main">)</span> <span class="main">∈</span> azC <span class="main">(</span>runs <span class="improper">xa</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> m1_secrecyE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> azC.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

    <span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"B' ∈ bad"</span><span class="antiquote">}</span></span>›</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule_tac</span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">B</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> m1_inv2r_servD<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> Rs Na<span class="main">)</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sesK <span class="main">(</span><span class="improper">Rs</span><span class="main">$</span>sk<span class="main">)</span><span class="main">,</span> <span class="improper">B'</span><span class="main">)</span> <span class="main">∈</span> azC <span class="main">(</span>runs <span class="improper">xa</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> m1_secrecyE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> azC.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> m1_inv3r_initD<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> Raa nla<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">Raa</span> <span class="main">=</span> <span class="improper">Ra</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_inv4_rfresh <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m1 <span class="main">⊆</span> m1_inv4_rfresh"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> 
         J<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"m1_inv3r_init <span class="main">∩</span> m1_inv2r_serv <span class="main">∩</span> m1_inv3_ifresh <span class="main">∩</span> m1_secrecy"</span></span> 
       <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> inv_rule_incr<span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Int_assoc <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_obs_inv4_rfresh <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"oreach m1 <span class="main">⊆</span> m1_inv4_rfresh"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> external_from_internal_invariant<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="m2_nssk">
<div class="head">
<h1>Theory m2_nssk</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Development of Security Protocols by Refinement

  Module:  Key_establish/m2_nssk.thy (Isabelle/HOL 2016-1)
  ID:      $Id: m2_nssk.thy 133854 2017-03-20 17:53:50Z csprenge $
  Author:  Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
  
  Key distribution protocols
  Second refinement: channel-protocol, parallel version of Needham-Schroeder
  Shared Key protocol (NSSK, Boyd/Mathuria, Protocol 3.19)

  Copyright (c) 2009-2016 Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Abstract Needham-Schroeder Shared Key (L2)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> m2_nssk <span class="keyword2"><span class="keyword">imports</span></span> <a href="m1_nssk.html">m1_nssk</a> <span class="quoted">"<a href="Channels.html">../Refinement/Channels</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
We model an abstract version of the Needham-Schroeder Shared Key protocol:
\[
\begin{array}{lll}
  \mathrm{M1.} &amp; A \rightarrow S: &amp; A, B, Na \\ 
  \mathrm{M2.} &amp; S \rightarrow A: &amp; \{Na, B, Kab, \{Kab, A\}_{Kbs} \}_{Kas} \\
  \mathrm{M3.} &amp; A \rightarrow B: &amp; \{A, Kab\}_{Kbs} \\
  \mathrm{M4.} &amp; B \rightarrow A: &amp; \{Nb\}_{Kab} \\  
  \mathrm{M5.} &amp; A \rightarrow B: &amp; \{Nb - 1 \}_{Kab} \\
\end{array}
\]
The last two message are supposed to authenticate $A$ to $B$, but this fails
as shown by Dening and Sacco.  Therefore and since we are mainly interested
in secrecy at this point, we drop the last two message from this development.

This refinement introduces channels with security properties.  We model 
a parallel/"channel-pure" version of the first three messages of the NSSK 
protocol:
\[
\begin{array}{lll}
  \mathrm{M1.} &amp; A \rightarrow S: &amp; A, B, Na \\ 
  \mathrm{M2.} &amp; S \rightarrow A: &amp; \{Na, B, Kab\}_{Kas} \\
  \mathrm{M3.} &amp; S \rightarrow B: &amp; \{Kab, A\}_{Kbs} \\
\end{array}
\]
Message 1 is sent over an insecure channel, the other two message over
secure channels to/from the server.
›</span></span>

<span class="keyword1"><span class="command">declare</span></span> domIff <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">iff</span> <span class="quasi_keyword">del</span><span class="main">]</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹State›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">record</span></span> m2_state <span class="main">=</span> <span class="quoted"><span class="quoted">"m1_state"</span></span> <span class="main">+</span>
  chan <span class="main">::</span> <span class="quoted"><span class="quoted">"chmsg set"</span></span>              <span class="comment1">― ‹channel messages›</span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  m2_obs <span class="main">=</span> <span class="quoted"><span class="quoted">"m1_state"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_obs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_state <span class="main">⇒</span> m2_obs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_obs</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> runs <span class="main">=</span> runs <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> leak <span class="main">=</span> leak <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  m2_pred <span class="main">=</span> <span class="quoted"><span class="quoted">"m2_state set"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  m2_trans <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m2_state<span class="main">)</span> set"</span></span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Events›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Protocol events.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">A</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m1a_step1"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m2_step1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">]</span> <span class="main">⇒</span> m2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_step1</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>

    <span class="comment1">― ‹guards:›</span>
    <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>                      <span class="comment1">― ‹fresh run identifier›</span>
    <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>na <span class="main">∧</span>                             <span class="comment1">― ‹generate nonce <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Na›</span></span>›</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="comment1">― ‹create initiator thread and send message 1›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      chan <span class="main">:=</span> insert <span class="main">(</span>Insec <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span>   <span class="comment1">― ‹msg 1›</span>
    <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">B</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m1a_step2"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m2_step2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">]</span> <span class="main">⇒</span> m2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_step2</span> <span class="main">≡</span> m1_step2"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"Server"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m1a_step3</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m2_step3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> key<span class="main">]</span> <span class="main">⇒</span> m2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_step3</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span> 
    <span class="comment1">― ‹guards:›</span>
    <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>                           <span class="comment1">― ‹new server run›</span>
    <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">=</span> sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span>                          <span class="comment1">― ‹fresh session key›</span>

    Insec <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">∧</span>          <span class="comment1">― ‹recv msg 1›</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="comment1">― ‹record key and send messages 2 and 3›</span>
    <span class="comment1">― ‹note that last field in server record is for responder nonce›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">↦</span> <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> 
      chan <span class="main">:=</span> <span class="main">{</span>Secure Sv <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">,</span> aAgt <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">,</span> 
               Secure Sv <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aAgt <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> chan <span class="bound">s</span>
    <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">A</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m1a_step4</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m2_step4</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> key<span class="main">]</span> <span class="main">⇒</span> m2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_step4</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>

    <span class="comment1">― ‹guards:›</span>
    runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span> 
    <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>na <span class="main">∧</span>

    Secure Sv <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">,</span> aAgt <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">∧</span>  <span class="comment1">― ‹recv msg 2›</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="comment1">― ‹record session key›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
    <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">B</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m1_step5</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m2_step5</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> key<span class="main">]</span> <span class="main">⇒</span> m2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_step5</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Nb</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span> 

    <span class="comment1">― ‹guards:›</span>
    runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">Nb</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>nb <span class="main">∧</span>

    Secure Sv <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aAgt <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">∧</span>     <span class="comment1">― ‹recv msg 3›</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="comment1">― ‹record session key›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> 
      chan <span class="main">:=</span> insert <span class="main">(</span>dAuth <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span>
    <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">A</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m1_step6</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m2_step6</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> nonce<span class="main">,</span> key<span class="main">]</span> <span class="main">⇒</span> m2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_step6</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Nb</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span> 
    runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span>    <span class="comment1">― ‹key recv'd before›</span>
    <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>na <span class="main">∧</span>

    dAuth <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">∧</span>             <span class="comment1">― ‹receive <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M4›</span></span>›</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aNon <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      chan <span class="main">:=</span> insert <span class="main">(</span>dAuth <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">,</span> aNon <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span>
    <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">B</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m1_step6</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m2_step7</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> key<span class="main">]</span> <span class="main">⇒</span> m2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_step7</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Nb</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span>     <span class="comment1">― ‹key recv'd before›</span>
    <span class="free"><span class="bound"><span class="entity">Nb</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>nb <span class="main">∧</span>

    dAuth <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">,</span> aNon <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">∧</span>     <span class="comment1">― ‹receive <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M5›</span></span>›</span>

    <span class="comment1">― ‹actions: (redundant) update local state marks successful termination›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> END<span class="main">]</span><span class="main">)</span><span class="main">)</span>
    <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Intruder fake event.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m1_leak</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m2_leak</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> rid_t<span class="main">,</span> rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">]</span> <span class="main">⇒</span> m2_trans"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_leak</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>na<span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span>
    runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="main">(</span>sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span><span class="main">,</span> aNon <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>nb<span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span>  
    runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="main">(</span>sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span><span class="main">,</span> END<span class="main">]</span><span class="main">)</span> <span class="main">∧</span>  

    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> leak <span class="main">:=</span> insert <span class="main">(</span>sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>na<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>nb<span class="main">)</span> <span class="main">(</span>leak <span class="bound">s</span><span class="main">)</span><span class="main">,</span> 
            chan <span class="main">:=</span> insert <span class="main">(</span>Insec undefined undefined <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="main">(</span>sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span> <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">Id</span><span class="antiquote">}</span></span>›</span> 
  <span class="entity">m2_fake</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_fake</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span> 

    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      chan <span class="main">:=</span> fake ik0  <span class="main">(</span>dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span>
    <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Transition system›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_init</span> <span class="main">≡</span> <span class="main">{</span> <span class="main">⦇</span> 
     runs <span class="main">=</span> Map.empty<span class="main">,</span> 
     leak <span class="main">=</span> corrKey <span class="main">×</span> <span class="main">{</span>undefined<span class="main">}</span> <span class="main">×</span> <span class="main">{</span>undefined<span class="main">}</span><span class="main">,</span> 
     chan <span class="main">=</span> <span class="main">{}</span> <span class="main">⦈</span> 
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_trans"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_trans</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Ra</span> <span class="bound">Rb</span> <span class="bound">Rs</span> <span class="bound">Na</span> <span class="bound">Nb</span> <span class="bound">Kab</span><span class="main">.</span>
     m2_step1 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="main">∪</span>
     m2_step2 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">∪</span>
     m2_step3 <span class="bound">Rs</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Kab</span> <span class="main">∪</span>
     m2_step4 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Kab</span> <span class="main">∪</span>
     m2_step5 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Nb</span> <span class="bound">Kab</span> <span class="main">∪</span>
     m2_step6 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Nb</span> <span class="bound">Kab</span> <span class="main">∪</span>
     m2_step7 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Nb</span> <span class="bound">Kab</span> <span class="main">∪</span>
     m2_leak <span class="bound">Rs</span> <span class="bound">Ra</span> <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">∪</span>
     m2_fake <span class="main">∪</span>
     Id
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state<span class="main">,</span> m2_obs<span class="main">)</span> spec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2</span> <span class="main">≡</span> <span class="main">⦇</span>
    init <span class="main">=</span> m2_init<span class="main">,</span>
    trans <span class="main">=</span> m2_trans<span class="main">,</span>
    obs <span class="main">=</span> m2_obs
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_loc_defs <span class="main">=</span> 
  m2_def m2_init_def m2_trans_def m2_obs_def
  m2_step1_def m2_step2_def m2_step3_def m2_step4_def m2_step5_def 
  m2_step6_def m2_step7_def m2_leak_def m2_fake_def 

<span class="keyword1"><span class="command">lemmas</span></span> m2_defs <span class="main">=</span> m2_loc_defs m1_defs


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv1: Key definedness›</span></span>
<span class="comment1">(*inv**************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All session keys in channel messages stem from existing runs.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_inv1_keys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">m2_inv1_keys</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">R</span><span class="main">.</span>
     aKey <span class="main">(</span>sesK <span class="main">(</span><span class="bound">R</span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span> <span class="main">∈</span> atoms <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span> <span class="main">∨</span> sesK <span class="main">(</span><span class="bound">R</span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∈</span> Domain <span class="main">(</span>leak <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span> 
       <span class="bound">R</span> <span class="main">∈</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv1_keysI <span class="main">=</span> m2_inv1_keys_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv1_keysE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m2_inv1_keys_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv1_keysD <span class="main">=</span> m2_inv1_keys_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv1_keys_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m2 <span class="main">⊆</span> m2_inv1_keys"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv1_keysI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv1_keys_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv1_keys<span class="main">}</span> trans m2 <span class="main">{&gt;</span> m2_inv1_keys<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv1_keysI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv1_keysD <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv1_keys <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m2_inv1_keys"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv2: Definedness of used keys›</span></span>
<span class="comment1">(*inv**************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_inv2_keys_for</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">m2_inv2_keys_for</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">R</span><span class="main">.</span>
     sesK <span class="main">(</span><span class="bound">R</span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∈</span> keys_for <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">R</span> <span class="main">∈</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv2_keys_forI <span class="main">=</span> m2_inv2_keys_for_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv2_keys_forE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m2_inv2_keys_for_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv2_keys_forD <span class="main">=</span> m2_inv2_keys_for_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv2_keys_for_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m2 <span class="main">⊆</span> m2_inv2_keys_for"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv2_keys_forI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv2_keys_for_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv2_keys_for <span class="main">∩</span> m2_inv1_keys<span class="main">}</span> trans m2 <span class="main">{&gt;</span> m2_inv2_keys_for<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv2_keys_forI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv2_keys_forD <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m2_inv1_keysD <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>
<span class="comment1">― ‹2 subgoals, from step 4 and fake›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> R xa xb xc xe<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"aKey <span class="main">(</span>sesK <span class="main">(</span><span class="improper">R</span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span> <span class="main">∈</span> atoms <span class="main">(</span>chan <span class="improper">xa</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> 
       <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv1_keysD <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> keys_for_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> fake.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv2_keys_for <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m2_inv2_keys_for"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_incr<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Useful application of invariant.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m2_inv2_keys_for__extr_insert_key<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">R</span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">s</span> <span class="main">∈</span> m2_inv2_keys_for <span class="main">⟧</span>
 <span class="main">⟹</span> extr <span class="main">(</span>insert <span class="main">(</span>aKey <span class="main">(</span>sesK <span class="main">(</span><span class="free">R</span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">T</span><span class="main">)</span> <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span>aKey <span class="main">(</span>sesK <span class="main">(</span><span class="free">R</span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>extr <span class="free">T</span> <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"sesK <span class="main">(</span><span class="free">R</span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∉</span> keys_for <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv2b: leaked keys include corrupted ones›</span></span>
<span class="comment1">(*inv**************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_inv2b_corrKey_leaked</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">m2_inv2b_corrKey_leaked</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">K</span><span class="main">.</span>
     <span class="bound">K</span> <span class="main">∈</span> corrKey <span class="main">⟶</span> <span class="bound">K</span> <span class="main">∈</span> Domain <span class="main">(</span>leak <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv2b_corrKey_leakedI <span class="main">=</span> m2_inv2b_corrKey_leaked_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv2b_corrKey_leakedE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m2_inv2b_corrKey_leaked_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv2b_corrKey_leakedD <span class="main">=</span> m2_inv2b_corrKey_leaked_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv2b_corrKey_leaked_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m2 <span class="main">⊆</span> m2_inv2b_corrKey_leaked"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv2b_corrKey_leakedI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv2b_corrKey_leaked_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv2b_corrKey_leaked <span class="main">∩</span> m2_inv1_keys<span class="main">}</span> trans m2 <span class="main">{&gt;</span> m2_inv2b_corrKey_leaked<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv2b_corrKey_leakedI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv2b_corrKey_leaked <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m2_inv2b_corrKey_leaked"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_incr<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv3a: Session key compromise›</span></span>
<span class="comment1">(*inv**************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A L2 version of a session key comprise invariant. Roughly, it states
that adding a set of keys <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">KK</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to the parameter <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>T›</span></span></span></span> of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">extr</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
does not help the intruder to extract keys other than those in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">KK</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> or
extractable without adding <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">KK</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. 
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_inv3a_sesK_compr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">m2_inv3a_sesK_compr</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">K</span> <span class="bound">KK</span><span class="main">.</span>
     <span class="comment1">⌦‹KK ⊆ range sesK ⟶›</span>
     aKey <span class="bound">K</span> <span class="main">∈</span> extr <span class="main">(</span>aKey<span class="main">`</span><span class="bound">KK</span> <span class="main">∪</span> ik0<span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="bound">K</span> <span class="main">∈</span> <span class="bound">KK</span> <span class="main">∨</span> aKey <span class="bound">K</span> <span class="main">∈</span> extr ik0 <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv3a_sesK_comprI <span class="main">=</span> m2_inv3a_sesK_compr_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv3a_sesK_comprE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m2_inv3a_sesK_compr_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv3a_sesK_comprD <span class="main">=</span> m2_inv3a_sesK_compr_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Additional lemma to get the keys in front›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> insert_commute_aKey <span class="main">=</span> insert_commute <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"aKey <span class="free">K</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">K</span><span class="main">]</span> 

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv3a_sesK_compr_simps <span class="main">=</span> 
  m2_inv3a_sesK_comprD
  m2_inv3a_sesK_comprD <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">Kab</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">Kab</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  m2_inv3a_sesK_comprD <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"insert <span class="free">Kab</span> <span class="free">KK</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">Kab</span> <span class="free">KK</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  insert_commute_aKey 

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv3a_sesK_compr_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m2 <span class="main">⊆</span> m2_inv3a_sesK_compr"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv3a_sesK_comprI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv3a_sesK_compr_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv3a_sesK_compr<span class="main">}</span> trans m2 <span class="main">{&gt;</span> m2_inv3a_sesK_compr<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs m2_inv3a_sesK_compr_simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv3a_sesK_comprI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv3a_sesK_compr <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m2_inv3a_sesK_compr"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> 


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv3b: Session key compromise for nonces›</span></span>
<span class="comment1">(*inv**************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A variant of the above for nonces. Roughly, it states that adding 
a set of keys <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">KK</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to the parameter <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>T›</span></span></span></span> of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">extr</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
does not help the intruder to extract more nonces than those extractable 
without adding <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">KK</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

NOTE: This lemma is only needed at the next refinement level.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_inv3b_sesK_compr_non</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">m2_inv3b_sesK_compr_non</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">N</span> <span class="bound">KK</span><span class="main">.</span>
     <span class="comment1">⌦‹KK ⊆ range sesK ⟶›</span>
     aNon <span class="bound">N</span> <span class="main">∈</span> extr <span class="main">(</span>aKey<span class="main">`</span><span class="bound">KK</span> <span class="main">∪</span> ik0<span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span> <span class="main">⟷</span> aNon <span class="bound">N</span> <span class="main">∈</span> extr ik0 <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv3b_sesK_compr_nonI <span class="main">=</span> m2_inv3b_sesK_compr_non_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv3b_sesK_compr_nonE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m2_inv3b_sesK_compr_non_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv3b_sesK_compr_nonD <span class="main">=</span> m2_inv3b_sesK_compr_non_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv3b_sesK_compr_non_simps <span class="main">=</span> 
  m2_inv3b_sesK_compr_nonD
  m2_inv3b_sesK_compr_nonD <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">Kab</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">Kab</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> 
  m2_inv3b_sesK_compr_nonD <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"insert <span class="free">Kab</span> <span class="free">KK</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">Kab</span> <span class="free">KK</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> 
  insert_commute_aKey    <span class="comment1">― ‹to get the keys to the front›</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv3b_sesK_compr_non_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m2 <span class="main">⊆</span> m2_inv3b_sesK_compr_non"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv3b_sesK_compr_nonI<span class="main">)</span>

<span class="comment1">(* with dSecure instead of dAuth in step5:

lemma PO_m2_inv3b_sesK_compr_non_trans [iff]:
  "{m2_inv3b_sesK_compr_non ∩ m2_inv3a_sesK_compr} 
     m2_step5 Rb A B Nb Kab 
   {&gt; m2_inv3b_sesK_compr_non}"
apply (auto simp add: PO_hoare_defs m2_defs m2_inv3b_sesK_compr_non_simps 
                      m2_inv3a_sesK_compr_simps
         intro!: m2_inv3b_sesK_compr_nonI)
(* 1 subgoal, unsolvable! *)
oops
*)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv3b_sesK_compr_non_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv3b_sesK_compr_non<span class="main">}</span> trans m2 <span class="main">{&gt;</span> m2_inv3b_sesK_compr_non<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs m2_inv3b_sesK_compr_non_simps 
         <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv3b_sesK_compr_nonI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv3b_sesK_compr_non <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m2_inv3b_sesK_compr_non"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> 


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv3: Lost session keys›</span></span>
<span class="comment1">(*inv**************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹inv3: Lost session keys were generated by the server for at least one
bad agent. This invariant is needed in the proof of the strengthening of the 
authorization guards in steps 4 and 5 (e.g., <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">Kab</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">A</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∈</span></span> azC <span class="main"><span class="main">(</span></span>runs <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
for the initiator's step4).›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_inv3_extrKey</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_inv3_extrKey</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">K</span><span class="main">.</span>
     aKey <span class="bound">K</span> <span class="main">∈</span> extr ik0 <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">K</span> <span class="main">∉</span> corrKey <span class="main">⟶</span> 
       <span class="main">(</span><span class="main">∃</span><span class="bound">R</span> <span class="bound">A'</span> <span class="bound">B'</span> <span class="bound">Na'</span><span class="main">.</span> <span class="bound">K</span> <span class="main">=</span> sesK <span class="main">(</span><span class="bound">R</span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span>
          runs <span class="bound">s</span> <span class="bound">R</span> <span class="main">=</span> Some <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="bound">A'</span><span class="main">,</span> <span class="bound">B'</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="bound">Na'</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span> 
          <span class="main">(</span><span class="bound">A'</span> <span class="main">∈</span> bad <span class="main">∨</span> <span class="bound">B'</span> <span class="main">∈</span> bad <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Nb'</span><span class="main">.</span> <span class="main">(</span><span class="bound">K</span><span class="main">,</span> <span class="bound">Na'</span><span class="main">,</span> <span class="bound">Nb'</span><span class="main">)</span> <span class="main">∈</span> leak <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv3_extrKeyI <span class="main">=</span> m2_inv3_extrKey_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv3_extrKeyE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m2_inv3_extrKey_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv3_extrKeyD <span class="main">=</span> m2_inv3_extrKey_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv3_extrKey_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m2 <span class="main">⊆</span> m2_inv3_extrKey"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv3_extrKeyI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv3_extrKey_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv3_extrKey <span class="main">∩</span> m2_inv3a_sesK_compr<span class="main">}</span> trans m2 <span class="main">{&gt;</span> m2_inv3_extrKey<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv3_extrKeyI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_inv3a_sesK_compr_simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>
<span class="comment1">― ‹11 subgoals, sledgehammer›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> m2_inv3_extrKeyD map_definedness_contra<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> m2_inv3_extrKeyD map_definedness_contra<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> m2_inv3_extrKeyD<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> m2_inv3_extrKeyD<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> m2_inv3_extrKeyD<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> m2_inv3_extrKeyD map_definedness_contra<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> m2_inv3_extrKeyD not_Cons_self2 prod.inject option.inject<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> m2_inv3_extrKeyD not_Cons_self2 prod.inject option.inject<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> m2_inv3_extrKeyD atom.distinct<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> list.inject option.inject prod.inject<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> m2_inv3_extrKeyD atom.distinct<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> list.inject option.inject prod.inject<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> m2_inv3_extrKeyD<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="comment1">(*
apply (aut dest!: m2_inv3_extrKeyD dest: dom_lemmas)        -- {*SLOW*}
-- {* 18 subgoals; go agressive*}
apply (aut intro!: exI dest: dom_lemmas)
done
*)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv3_extrKey <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m2_inv3_extrKey"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> J<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"m2_inv3a_sesK_compr"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> inv_rule_incr<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> 


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv4: Secure channel and message 2›</span></span>
<span class="comment1">(*inv**************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹inv4: Secure messages to honest agents and server state; one variant 
for each of M2 and M3. Note that the one for M2 is stronger than the 
one for M3.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_inv4_M2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_inv4_M2</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Kab</span><span class="main">.</span>
     Secure Sv <span class="bound">A</span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="bound">Na</span><span class="main">,</span> aAgt <span class="bound">B</span><span class="main">,</span> aKey <span class="bound">Kab</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">⟶</span> <span class="bound">A</span> <span class="main">∈</span> good <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound">Rs</span><span class="main">.</span> <span class="bound">Kab</span> <span class="main">=</span> sesK <span class="main">(</span><span class="bound">Rs</span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span> runs <span class="bound">s</span> <span class="bound">Rs</span> <span class="main">=</span> Some <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="bound">Na</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv4_M2I <span class="main">=</span> m2_inv4_M2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv4_M2E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m2_inv4_M2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv4_M2D <span class="main">=</span> m2_inv4_M2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv4_M2_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m2 <span class="main">⊆</span> m2_inv4_M2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv4_M2I<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv4_M2_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv4_M2<span class="main">}</span> trans m2 <span class="main">{&gt;</span> m2_inv4_M2<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv4_M2I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv4_M2D <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>
<span class="comment1">― ‹5 subgoals›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spec<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spec<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spec<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv4_M2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m2_inv4_M2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv4b: Secure channel and message 3›</span></span>
<span class="comment1">(*inv**************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_inv4_M3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_inv4_M3</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Kab</span><span class="main">.</span>
     Secure Sv <span class="bound">B</span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="bound">Kab</span><span class="main">,</span> aAgt <span class="bound">A</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">⟶</span> <span class="bound">B</span> <span class="main">∈</span> good <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound">Rs</span> <span class="bound">Na</span><span class="main">.</span> <span class="bound">Kab</span> <span class="main">=</span> sesK <span class="main">(</span><span class="bound">Rs</span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span> runs <span class="bound">s</span> <span class="bound">Rs</span> <span class="main">=</span> Some <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="bound">Na</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv4_M3I <span class="main">=</span> m2_inv4_M3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv4_M3E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m2_inv4_M3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv4_M3D <span class="main">=</span> m2_inv4_M3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv4_M3_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m2 <span class="main">⊆</span> m2_inv4_M3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv4_M3I<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv4_M3_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv4_M3<span class="main">}</span> trans m2 <span class="main">{&gt;</span> m2_inv4_M3<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv4_M3I<span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv4_M3D <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>
<span class="comment1">― ‹5 subgoals›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv4_M3 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m2_inv4_M3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_incr<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Consequence needed in proof of inv8/step5›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m2_inv4_M2_M3_unique_names<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> 
  <span class="quoted"><span class="quoted">"Secure Sv <span class="free">A'</span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="free">Na</span><span class="main">,</span> aAgt <span class="free">B'</span><span class="main">,</span> aKey <span class="free">Kab</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="free">s</span>"</span></span> 
  <span class="quoted"><span class="quoted">"Secure Sv <span class="free">B</span>  <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">,</span> aAgt <span class="free">A</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"aKey <span class="free">Kab</span> <span class="main">∉</span> extr ik0 <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span>"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> m2_inv4_M2"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> m2_inv4_M3"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="free">A'</span> <span class="main">∧</span> <span class="free">B</span> <span class="main">=</span> <span class="free">B'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">A'</span> <span class="main">∈</span> bad <span class="main">∨</span> <span class="free">B</span> <span class="main">∈</span> bad"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1-3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>4<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv4_M2D m2_inv4_M3D<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹More consequences of invariants. Needed in ref/step4 and ref/step5 
respectively to show the strengthening of the authorization guards.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m2_inv34_M2_authorized<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Secure Sv <span class="free">A</span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="free">N</span><span class="main">,</span> aAgt <span class="free">B</span><span class="main">,</span> aKey <span class="free">K</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="free">s</span>"</span></span> 
          <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> m2_inv4_M2"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> m2_inv3_extrKey"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> m2_inv2b_corrKey_leaked"</span></span> 
          <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">∉</span> Domain <span class="main">(</span>leak <span class="free">s</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">K</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> azC <span class="main">(</span>runs <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> bad"</span></span> 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"aKey <span class="free">K</span> <span class="main">∈</span> extr ik0 <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∉</span> bad"</span></span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1-2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m2_inv4_M2D<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m2_inv34_M3_authorized<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Secure Sv <span class="free">B</span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="free">K</span><span class="main">,</span> aAgt <span class="free">A</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="free">s</span>"</span></span> 
          <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> m2_inv4_M3"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> m2_inv3_extrKey"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> m2_inv2b_corrKey_leaked"</span></span> 
          <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">∉</span> Domain <span class="main">(</span>leak <span class="free">s</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">K</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> azC <span class="main">(</span>runs <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∈</span> bad"</span></span> 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"aKey <span class="free">K</span> <span class="main">∈</span> extr ik0 <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∉</span> bad"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1-2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m2_inv4_M3D<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv5 (derived): Key secrecy for server›</span></span>
<span class="comment1">(*invd*************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹inv5: Key secrecy from server perspective. This invariant links the 
abstract notion of key secrecy to the intruder key knowledge.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_inv5_ikk_sv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_inv5_ikk_sv</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Rs</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">al</span><span class="main">.</span>
     runs <span class="bound">s</span> <span class="bound">Rs</span> <span class="main">=</span> Some <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> aNon <span class="bound">Na</span> <span class="main">#</span> <span class="bound">al</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">A</span> <span class="main">∈</span> good <span class="main">⟶</span> <span class="bound">B</span> <span class="main">∈</span> good <span class="main">⟶</span>
     aKey <span class="main">(</span>sesK <span class="main">(</span><span class="bound">Rs</span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span> <span class="main">∈</span> extr ik0 <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound">Nb'</span><span class="main">.</span> <span class="main">(</span>sesK <span class="main">(</span><span class="bound">Rs</span><span class="main">$</span>sk<span class="main">)</span><span class="main">,</span> <span class="bound">Na</span><span class="main">,</span> <span class="bound">Nb'</span><span class="main">)</span> <span class="main">∈</span> leak <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv5_ikk_svI <span class="main">=</span> m2_inv5_ikk_sv_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv5_ikk_svE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m2_inv5_ikk_sv_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv5_ikk_svD <span class="main">=</span> m2_inv5_ikk_sv_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof. This invariant follows from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>m2_inv3_extrKey›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m2_inv5_ikk_sv_derived<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> m2_inv3_extrKey <span class="main">⟹</span> <span class="free">s</span> <span class="main">∈</span> m2_inv5_ikk_sv"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_inv3_extrKey_def m2_inv5_ikk_sv_def<span class="main">)</span> <span class="main">(</span><span class="operator">force</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv5_ikk_sv <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m2_inv5_ikk_sv"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m2_inv3_extrKey"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> m2_inv5_ikk_sv"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> m2_inv5_ikk_sv_derived<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*
lemma PO_m2_inv5_ikk_sv_init [iff]:
  "init m2 ⊆ m2_inv5_ikk_sv"
by (auto simp add: m2_defs intro!: m2_inv5_ikk_svI)

lemma PO_m2_inv5_ikk_sv_trans [iff]:
  "{m2_inv5_ikk_sv ∩ m2_inv3a_sesK_compr ∩ m2_inv3_extrKey} 
     trans m2 
   {&gt; m2_inv5_ikk_sv}"
apply (simp add: PO_hoare_defs m2_defs, safe intro!: m2_inv5_ikk_svI)
apply (auto simp add: m2_inv3a_sesK_compr_simps dest: dom_lemmas)
done

lemma PO_m2_inv5_ikk_sv [iff]: "reach m2 ⊆ m2_inv5_ikk_sv"
by (rule_tac J="m2_inv3a_sesK_compr ∩ m2_inv3_extrKey" in inv_rule_incr) (auto)
*)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv6 (derived): Key secrecy for initiator›</span></span>
<span class="comment1">(*invd**************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This invariant is derivable (see below).›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_inv6_ikk_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_inv6_ikk_init</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Ra</span> <span class="bound">K</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">al</span><span class="main">.</span>
     runs <span class="bound">s</span> <span class="bound">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> aKey <span class="bound">K</span> <span class="main">#</span> <span class="bound">al</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">A</span> <span class="main">∈</span> good <span class="main">⟶</span> <span class="bound">B</span> <span class="main">∈</span> good <span class="main">⟶</span>
     aKey <span class="bound">K</span> <span class="main">∈</span> extr ik0 <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound">Nb'</span><span class="main">.</span> <span class="main">(</span><span class="bound">K</span><span class="main">,</span> <span class="bound">Ra</span> <span class="main">$</span> na<span class="main">,</span> <span class="bound">Nb'</span><span class="main">)</span> <span class="main">∈</span> leak <span class="bound">s</span><span class="main">)</span>     
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv6_ikk_initI <span class="main">=</span> m2_inv6_ikk_init_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv6_ikk_initE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m2_inv6_ikk_init_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv6_ikk_initD <span class="main">=</span> m2_inv6_ikk_init_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv7 (derived): Key secrecy for responder›</span></span>
<span class="comment1">(*invd**************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This invariant is derivable (see below).›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_inv7_ikk_resp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_inv7_ikk_resp</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Rb</span> <span class="bound">K</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">al</span><span class="main">.</span>
     runs <span class="bound">s</span> <span class="bound">Rb</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> aKey <span class="bound">K</span> <span class="main">#</span> <span class="bound">al</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">A</span> <span class="main">∈</span> good <span class="main">⟶</span> <span class="bound">B</span> <span class="main">∈</span> good <span class="main">⟶</span>
     aKey <span class="bound">K</span> <span class="main">∈</span> extr ik0 <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="bound">K</span> <span class="main">∈</span> Domain <span class="main">(</span>leak <span class="bound">s</span><span class="main">)</span> 
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv7_ikk_respI <span class="main">=</span> m2_inv7_ikk_resp_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv7_ikk_respE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m2_inv7_ikk_resp_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv7_ikk_respD <span class="main">=</span> m2_inv7_ikk_resp_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv8: Relating M2 and M4 to the responder state›</span></span>
<span class="comment1">(*inv**************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This invariant relates messages M2 and M4 to the responder's state. 
It is required in the refinement of step 6 to prove that the initiator 
agrees with the responder on (A, B, Nb, Kab).›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m2_inv8_M4</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_inv8_M4</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Kab</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Nb</span><span class="main">.</span>
     Secure Sv <span class="bound">A</span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="bound">Na</span><span class="main">,</span> aAgt <span class="bound">B</span><span class="main">,</span> aKey <span class="bound">Kab</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">⟶</span>
     dAuth <span class="bound">Kab</span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="bound">Nb</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">⟶</span>  
     aKey <span class="bound">Kab</span> <span class="main">∉</span> extr ik0 <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound">Rb</span><span class="main">.</span> <span class="bound">Nb</span> <span class="main">=</span> <span class="bound">Rb</span><span class="main">$</span>nb <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">al</span><span class="main">.</span> runs <span class="bound">s</span> <span class="bound">Rb</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> aKey <span class="bound">Kab</span> <span class="main">#</span> <span class="bound">al</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="comment1">(* original open subgoal in refinement proof for step6:

1. ⋀s t. ⟦runs s = runs t; runs t Ra = Some (Init, [A, B], [aKey Kab]);
           dAuth Kab (Msg [aNon Nb]) ∈ chan t; A ∉ bad; B ∉ bad⟧
          ⟹ ∃Rb nl. Nb = Rb $ nb ∧ runs t Rb = Some (Resp, [A, B], aKey Kab # nl)
*)</span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv8_M4I <span class="main">=</span> m2_inv8_M4_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv8_M4E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m2_inv8_M4_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv8_M4D <span class="main">=</span> m2_inv8_M4_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv8_M4_step1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv8_M4<span class="main">}</span> m2_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="main">{&gt;</span> m2_inv8_M4<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv8_M4I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv8_M4D <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv8_M4_step2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv8_M4<span class="main">}</span> m2_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="main">{&gt;</span> m2_inv8_M4<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv8_M4I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv8_M4D <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv8_M4_step3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv8_M4 <span class="main">∩</span> m2_inv2_keys_for<span class="main">}</span> m2_step3 <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span> <span class="main">{&gt;</span> m2_inv8_M4<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv8_M4I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_inv2_keys_for__extr_insert_key <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv8_M4D <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv8_M4_step4<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv8_M4<span class="main">}</span> m2_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span> <span class="main">{&gt;</span> m2_inv8_M4<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv8_M4I<span class="main">)</span>
<span class="comment1">― ‹1 subgoal›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> m2_inv8_M4D<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv8_M4_step5<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv8_M4 <span class="main">∩</span> m2_inv4_M3 <span class="main">∩</span> m2_inv4_M2<span class="main">}</span> 
      m2_step5 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Nb</span> <span class="free">Kab</span> 
   <span class="main">{&gt;</span> m2_inv8_M4<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv8_M4I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m2_inv4_M2_M3_unique_names<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv8_M4D<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv8_M4_step6<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv8_M4<span class="main">}</span> m2_step6 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Nb</span> <span class="free">Kab</span> <span class="main">{&gt;</span> m2_inv8_M4<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv8_M4I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv8_M4D<span class="main">)</span>
<span class="comment1">― ‹1 subgoal›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv8_M4_step7<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv8_M4<span class="main">}</span> m2_step7 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Nb</span> <span class="free">Kab</span> <span class="main">{&gt;</span> m2_inv8_M4<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv8_M4I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv8_M4D<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv8_M4_leak<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv8_M4 <span class="main">∩</span> m2_inv3a_sesK_compr<span class="main">}</span> m2_leak <span class="free">Rs</span> <span class="free">Ra</span> <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="main">{&gt;</span> m2_inv8_M4<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv8_M4I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_inv3a_sesK_compr_simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv8_M4D<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv8_M4_fake<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv8_M4<span class="main">}</span> m2_fake <span class="main">{&gt;</span> m2_inv8_M4<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv8_M4I<span class="main">)</span>
<span class="comment1">― ‹1 subgoal›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> fake.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv8_M4D<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All together now..›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_m2_inv8_M4_lemmas <span class="main">=</span> 
  PO_m2_inv8_M4_step1 PO_m2_inv8_M4_step2 PO_m2_inv8_M4_step3
  PO_m2_inv8_M4_step4 PO_m2_inv8_M4_step5 PO_m2_inv8_M4_step6
  PO_m2_inv8_M4_step7 PO_m2_inv8_M4_leak PO_m2_inv8_M4_fake

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv8_M4_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m2 <span class="main">⊆</span> m2_inv8_M4"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv8_M4I<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv8_M4_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv8_M4 <span class="main">∩</span> m2_inv4_M3 <span class="main">∩</span> m2_inv4_M2 <span class="main">∩</span> m2_inv3a_sesK_compr <span class="main">∩</span> m2_inv2_keys_for<span class="main">}</span> 
      trans m2 
   <span class="main">{&gt;</span> m2_inv8_M4<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_def m2_trans_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_m2_inv8_M4_lemmas<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv8_M4 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m2_inv8_M4"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> J<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"m2_inv4_M3 <span class="main">∩</span> m2_inv4_M2 <span class="main">∩</span>  m2_inv3a_sesK_compr <span class="main">∩</span> m2_inv2_keys_for"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> inv_rule_incr<span class="main">)</span> 
   <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv8a: Relating the initiator state to M2›</span></span>
<span class="comment1">(*inv**************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m2_inv8a_init_M2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_inv8a_init_M2</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Kab</span> <span class="bound">al</span><span class="main">.</span>
     runs <span class="bound">s</span> <span class="bound">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> aKey <span class="bound">Kab</span> <span class="main">#</span> <span class="bound">al</span><span class="main">)</span> <span class="main">⟶</span>
       Secure Sv <span class="bound">A</span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="main">(</span><span class="bound">Ra</span><span class="main">$</span>na<span class="main">)</span><span class="main">,</span> aAgt <span class="bound">B</span><span class="main">,</span> aKey <span class="bound">Kab</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="bound">s</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv8a_init_M2I <span class="main">=</span> m2_inv8a_init_M2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv8a_init_M2E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m2_inv8a_init_M2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv8a_init_M2D <span class="main">=</span> m2_inv8a_init_M2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv8a_init_M2_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m2 <span class="main">⊆</span> m2_inv8a_init_M2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv8a_init_M2I<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv8a_init_M2_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv8a_init_M2<span class="main">}</span>  
      trans m2 
   <span class="main">{&gt;</span> m2_inv8a_init_M2<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv8a_init_M2I<span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span> 

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv8a_init_M2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m2_inv8a_init_M2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_incr<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv9a: Relating the responder state to M3›</span></span>
<span class="comment1">(*inv**************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m2_inv9a_resp_M3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_inv9a_resp_M3</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Kab</span> <span class="bound">al</span><span class="main">.</span>
     runs <span class="bound">s</span> <span class="bound">Rb</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> aKey <span class="bound">Kab</span> <span class="main">#</span> <span class="bound">al</span><span class="main">)</span> <span class="main">⟶</span>
       Secure Sv <span class="bound">B</span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="bound">Kab</span><span class="main">,</span> aAgt <span class="bound">A</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="bound">s</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv9a_resp_M3I <span class="main">=</span> m2_inv9a_resp_M3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv9a_resp_M3E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m2_inv9a_resp_M3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv9a_resp_M3D <span class="main">=</span> m2_inv9a_resp_M3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv9a_resp_M3_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m2 <span class="main">⊆</span> m2_inv9a_resp_M3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv9a_resp_M3I<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv9a_resp_M3_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv9a_resp_M3<span class="main">}</span>  
      trans m2 
   <span class="main">{&gt;</span> m2_inv9a_resp_M3<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv9a_resp_M3I <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m2_inv9a_resp_M3D<span class="main">)</span> 
   <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv9a_resp_M3 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m2_inv9a_resp_M3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_incr<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv9: Relating M3 and M5 to the initiator state›</span></span>
<span class="comment1">(*inv**************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This invariant relates message M5 to the initiator's state. It is 
required in step 7 of the refinement to prove that the initiator agrees with 
the responder on (A, B, Nb, Kab).›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m2_inv9_M5</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_inv9_M5</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Kab</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Nb</span><span class="main">.</span>
     Secure Sv <span class="bound">B</span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="bound">Kab</span><span class="main">,</span> aAgt <span class="bound">A</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">⟶</span>
     dAuth <span class="bound">Kab</span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="bound">Nb</span><span class="main">,</span> aNon <span class="bound">Nb</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">⟶</span> 
     aKey <span class="bound">Kab</span> <span class="main">∉</span> extr ik0 <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound">Ra</span><span class="main">.</span> runs <span class="bound">s</span> <span class="bound">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="bound">Kab</span><span class="main">,</span> aNon <span class="bound">Nb</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="comment1">(* 
 original subgoal in refinement of step 7:

 1. ⋀s t. ⟦runs s = runs t; runs t Rb = Some (Resp, [A, B], [aKey Kab]);
           dAuth Kab (Msg [Rb$nb, Rb$nb]) ∈ chan t; A ∉ bad; B ∉ bad⟧
          ⟹ ∃Ra. runs t Ra = Some (Init, [A, B], [aKey Kab, aNon Nb])
*)</span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv9_M5I <span class="main">=</span> m2_inv9_M5_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv9_M5E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m2_inv9_M5_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv9_M5D <span class="main">=</span> m2_inv9_M5_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv9_M5_step1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv9_M5<span class="main">}</span> m2_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="main">{&gt;</span> m2_inv9_M5<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv9_M5I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv9_M5D <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv9_M5_step2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv9_M5<span class="main">}</span> m2_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="main">{&gt;</span> m2_inv9_M5<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv9_M5I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv9_M5D <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv9_M5_step3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv9_M5 <span class="main">∩</span> m2_inv2_keys_for<span class="main">}</span> m2_step3 <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span> <span class="main">{&gt;</span> m2_inv9_M5<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv9_M5I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_inv2_keys_for__extr_insert_key <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv9_M5D <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv9_M5_step4<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv9_M5<span class="main">}</span> m2_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span> <span class="main">{&gt;</span> m2_inv9_M5<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv9_M5I<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv9_M5D <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>
<span class="comment1">― ‹1 subgoal›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv9_M5_step5<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv9_M5<span class="main">}</span> m2_step5 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Nb</span> <span class="free">Kab</span> <span class="main">{&gt;</span> m2_inv9_M5<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv9_M5I<span class="main">)</span>
<span class="comment1">― ‹1 subgoal›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> m2_inv9_M5D<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv9_M5_step6<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv9_M5 <span class="main">∩</span> m2_inv8a_init_M2 <span class="main">∩</span> m2_inv9a_resp_M3 <span class="main">∩</span> m2_inv4_M2 <span class="main">∩</span> m2_inv4_M3<span class="main">}</span>
     m2_step6 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Nb</span> <span class="free">Kab</span> 
   <span class="main">{&gt;</span> m2_inv9_M5<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv9_M5I<span class="main">)</span>
<span class="comment1">― ‹2 subgoals›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span> 1
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> m2_inv9_M5D<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> Raa<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Raa</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv8a_init_M2D m2_inv9a_resp_M3D m2_inv4_M2_M3_unique_names<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv9_M5_step7<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv9_M5<span class="main">}</span> m2_step7 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Nb</span> <span class="free">Kab</span> <span class="main">{&gt;</span> m2_inv9_M5<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv9_M5I<span class="main">)</span>
<span class="comment1">― ‹1 subgoal›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> m2_inv9_M5D<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv9_M5_leak<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv9_M5 <span class="main">∩</span> m2_inv3a_sesK_compr<span class="main">}</span> m2_leak <span class="free">Rs</span> <span class="free">Ra</span> <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="main">{&gt;</span> m2_inv9_M5<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv9_M5I<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_inv3a_sesK_compr_simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv9_M5D<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv9_M5_fake<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv9_M5<span class="main">}</span> m2_fake <span class="main">{&gt;</span> m2_inv9_M5<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv9_M5I<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv9_M5D<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All together now.›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_m2_inv9_M5_lemmas <span class="main">=</span> 
  PO_m2_inv9_M5_step1 PO_m2_inv9_M5_step2 PO_m2_inv9_M5_step3
  PO_m2_inv9_M5_step4 PO_m2_inv9_M5_step5 PO_m2_inv9_M5_step6
  PO_m2_inv9_M5_step7 PO_m2_inv9_M5_leak PO_m2_inv9_M5_fake

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv9_M5_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m2 <span class="main">⊆</span> m2_inv9_M5"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv9_M5I<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv9_M5_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv9_M5 <span class="main">∩</span> m2_inv8a_init_M2 <span class="main">∩</span> m2_inv9a_resp_M3 <span class="main">∩</span> 
    m2_inv4_M2 <span class="main">∩</span> m2_inv4_M3 <span class="main">∩</span> m2_inv3a_sesK_compr <span class="main">∩</span> m2_inv2_keys_for<span class="main">}</span> 
      trans m2 
   <span class="main">{&gt;</span> m2_inv9_M5<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_def m2_trans_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_m2_inv9_M5_lemmas<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv9_M5 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m2_inv9_M5"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> J<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"m2_inv8a_init_M2 <span class="main">∩</span> m2_inv9a_resp_M3 <span class="main">∩</span> 
                m2_inv4_M2 <span class="main">∩</span> m2_inv4_M3 <span class="main">∩</span> m2_inv3a_sesK_compr <span class="main">∩</span> m2_inv2_keys_for"</span></span> 
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> inv_rule_incr<span class="main">)</span> 
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Int_assoc <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The simulation relation. This is a pure superposition refinement.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R12</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m1_state <span class="main">×</span> m2_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R12</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> runs <span class="bound">s</span> <span class="main">=</span> runs <span class="bound">t</span> <span class="main">∧</span> leak <span class="bound">s</span> <span class="main">=</span> leak <span class="bound">t</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The mediator function projects on the local states.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">med21</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_obs <span class="main">⇒</span> m1_obs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med21</span> <span class="free"><span class="bound"><span class="entity">o2</span></span></span> <span class="main">=</span> <span class="main">⦇</span> runs <span class="main">=</span> runs <span class="free"><span class="bound"><span class="entity">o2</span></span></span><span class="main">,</span> leak <span class="main">=</span> leak <span class="free"><span class="bound"><span class="entity">o2</span></span></span> <span class="main">⦈</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_step1_refines_m1_step1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12<span class="main">}</span> 
     <span class="main">(</span>m1_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m2_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R12<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12_def m2_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_step2_refines_m1_step2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12<span class="main">}</span> 
     <span class="main">(</span>m1_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m2_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span>
   <span class="main">{&gt;</span> R12<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12_def m2_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_step3_refines_m1_step3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12<span class="main">}</span> 
     <span class="main">(</span>m1_step3 <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m2_step3 <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span><span class="main">)</span>
   <span class="main">{&gt;</span> R12<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12_def m2_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_step4_refines_m1_step4<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12 <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">(</span>m2_inv4_M2 <span class="main">∩</span> m2_inv3_extrKey <span class="main">∩</span> m2_inv2b_corrKey_leaked<span class="main">)</span><span class="main">}</span> 
     <span class="main">(</span>m1_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m2_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span><span class="main">)</span>  
   <span class="main">{&gt;</span> R12<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12_def m2_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>     
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m2_inv34_M2_authorized<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_step5_refines_m1_step5<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12 <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">(</span>m2_inv4_M3 <span class="main">∩</span> m2_inv3_extrKey <span class="main">∩</span> m2_inv2b_corrKey_leaked<span class="main">)</span><span class="main">}</span> 
     <span class="main">(</span>m1_step5 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Nb</span> <span class="free">Kab</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m2_step5 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Nb</span> <span class="free">Kab</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R12<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12_def m2_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m2_inv34_M3_authorized<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_step6_refines_m1_step6<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12 <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">(</span>m2_inv8a_init_M2 <span class="main">∩</span> m2_inv8_M4 <span class="main">∩</span> m2_inv6_ikk_init<span class="main">)</span><span class="main">}</span> 
     <span class="main">(</span>m1_step6 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Nb</span> <span class="free">Kab</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m2_step6 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Nb</span> <span class="free">Kab</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R12<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12_def m2_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv8_M4D <span class="main"><span class="main">[</span></span><span class="operator">OF</span> m2_inv8a_init_M2D<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m2_inv6_ikk_initD<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_step7_refines_m1_step7<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12 <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">(</span>m2_inv9_M5 <span class="main">∩</span> m2_inv9a_resp_M3 <span class="main">∩</span> m2_inv7_ikk_resp<span class="main">)</span><span class="main">}</span> 
     <span class="main">(</span>m1_step7 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Nb</span> <span class="free">Kab</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m2_step7 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Nb</span> <span class="free">Kab</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R12<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12_def m2_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv9_M5D <span class="main"><span class="main">[</span></span><span class="operator">OF</span> m2_inv9a_resp_M3D<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m2_inv7_ikk_respD<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_leak_refines_leak<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12<span class="main">}</span> 
     m1_leak <span class="free">Rs</span> <span class="free">Ra</span> <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">,</span> m2_leak <span class="free">Rs</span> <span class="free">Ra</span> <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span>
   <span class="main">{&gt;</span> R12<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12_def m2_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_fake_refines_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12<span class="main">}</span> 
     Id<span class="main">,</span> m2_fake
   <span class="main">{&gt;</span> R12<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12_def m2_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Consequences of simulation relation and invariants.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m2_inv6_ikk_init_derived<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> R12"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> m1_inv2i_serv"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> m2_inv5_ikk_sv"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> m2_inv6_ikk_init"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> m1_inv2i_serv"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R12_def m1_inv2i_serv_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_inv6_ikk_init_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m1_inv2i_servD m2_inv5_ikk_svD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m2_inv7_ikk_resp_derived<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> R12"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> m1_inv2r_serv"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> m2_inv5_ikk_sv"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> m2_inv7_ikk_resp"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> m1_inv2r_serv"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R12_def m1_inv2r_serv_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_inv7_ikk_resp_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m1_inv2r_servD m2_inv5_ikk_svD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All together now...›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_m2_trans_refines_m1_trans <span class="main">=</span> 
  PO_m2_step1_refines_m1_step1 PO_m2_step2_refines_m1_step2
  PO_m2_step3_refines_m1_step3 PO_m2_step4_refines_m1_step4
  PO_m2_step5_refines_m1_step5 PO_m2_step6_refines_m1_step6 
  PO_m2_step7_refines_m1_step7 PO_m2_leak_refines_leak 
  PO_m2_fake_refines_skip 

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_refines_init_m1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m2 <span class="main">⊆</span> R12<span class="main">``</span><span class="main">(</span>init m1<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R12_def m2_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_refines_trans_m1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12 <span class="main">∩</span> 
    <span class="main">(</span>reach m1 <span class="main">×</span> 
     <span class="main">(</span>m2_inv9_M5 <span class="main">∩</span> m2_inv8a_init_M2 <span class="main">∩</span> m2_inv9a_resp_M3 <span class="main">∩</span> m2_inv8_M4 <span class="main">∩</span> 
      m2_inv4_M3 <span class="main">∩</span> m2_inv4_M2 <span class="main">∩</span> m2_inv3a_sesK_compr <span class="main">∩</span> m2_inv3_extrKey <span class="main">∩</span> m2_inv2b_corrKey_leaked<span class="main">)</span><span class="main">)</span><span class="main">}</span> 
     <span class="main">(</span>trans m1<span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans m2<span class="main">)</span> 
   <span class="main">{&gt;</span> R12<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="comment1">― ‹derive the key secrecy invariants from simulation relation and the other invariants›</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?pre'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"R12 <span class="main">∩</span> <span class="main">(</span>UNIV <span class="main">×</span> <span class="main">(</span>m2_inv9_M5 <span class="main">∩</span> m2_inv8a_init_M2 <span class="main">∩</span> m2_inv9a_resp_M3 <span class="main">∩</span> 
               m2_inv8_M4 <span class="main">∩</span> m2_inv7_ikk_resp <span class="main">∩</span> m2_inv6_ikk_init <span class="main">∩</span> m2_inv5_ikk_sv <span class="main">∩</span> 
               m2_inv4_M3 <span class="main">∩</span> m2_inv4_M2 <span class="main">∩</span> m2_inv3a_sesK_compr <span class="main">∩</span> m2_inv3_extrKey <span class="main">∩</span> 
               m2_inv2b_corrKey_leaked<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="var">?pre</span><span class="main">}</span> <span class="var">?t1</span><span class="main">,</span> <span class="var">?t2</span> <span class="main">{&gt;</span><span class="var">?post</span><span class="main">}</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> relhoare_conseq_left<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?pre</span> <span class="main">⊆</span> <span class="var">?pre'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> m2_inv6_ikk_init_derived m2_inv7_ikk_resp_derived m2_inv5_ikk_sv_derived<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="var">?pre'</span><span class="main">}</span> <span class="var">?t1</span><span class="main">,</span> <span class="var">?t2</span> <span class="main">{&gt;</span> <span class="var">?post</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_def m2_trans_def m1_def m1_trans_def<span class="main">)</span>
         <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_m2_trans_refines_m1_trans<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>    

<span class="keyword1"><span class="command">lemma</span></span> PO_obs_consistent_R12 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"obs_consistent R12 med21 m1 m2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R12_def med21_def m2_defs<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement result.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m2_refines_m1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"refines 
     <span class="main">(</span>R12 <span class="main">∩</span> 
      <span class="main">(</span>reach m1 <span class="main">×</span> 
       <span class="main">(</span>m2_inv9_M5 <span class="main">∩</span> m2_inv8a_init_M2 <span class="main">∩</span> m2_inv9a_resp_M3 <span class="main">∩</span> m2_inv8_M4 <span class="main">∩</span> 
        m2_inv4_M3 <span class="main">∩</span> m2_inv4_M2 <span class="main">∩</span> m2_inv3a_sesK_compr <span class="main">∩</span> m2_inv3_extrKey <span class="main">∩</span> 
        m2_inv2b_corrKey_leaked <span class="main">∩</span> m2_inv2_keys_for <span class="main">∩</span> m2_inv1_keys<span class="main">)</span><span class="main">)</span><span class="main">)</span>
     med21 m1 m2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Refinement_using_invariants<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> m2_implements_m1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"implements med21 m1 m2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refinement_soundness<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Inherited and derived invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Show preservation of invariants <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"m1_inv2i_serv"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"m1_inv2r_serv"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>m1›</span></span></span></span>.›</span></span>

<span class="comment1">(*invh*************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_sat_m1_inv2i_serv <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m1_inv2i_serv"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> Pa<span class="main"><span class="main">=</span></span><span class="quoted">m1_inv2i_serv</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Qa<span class="main"><span class="main">=</span></span><span class="quoted">m1_inv2i_serv</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Q<span class="main"><span class="main">=</span></span><span class="quoted">m1_inv2i_serv</span> 
       <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> m2_implements_m1 <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>5<span class="main"><span class="main">]</span></span> internal_invariant_translation<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_loc_defs med21_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m1_inv2i_servI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(*invh*************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_sat_m1_inv2r_serv <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m1_inv2r_serv"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Pa<span class="main"><span class="main">=</span></span><span class="quoted">m1_inv2r_serv</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Qa<span class="main"><span class="main">=</span></span><span class="quoted">m1_inv2r_serv</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Q<span class="main"><span class="main">=</span></span><span class="quoted">m1_inv2r_serv</span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> m2_implements_m1 <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>5<span class="main"><span class="main">]</span></span> internal_invariant_translation<span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_defs med21_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m1_inv2r_servI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now we derive the additional invariants for the initiator and the responder 
(see above for the definitions).›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv6_init_ikk <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m2_inv6_ikk_init"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m1_inv2i_serv <span class="main">∩</span> m2_inv5_ikk_sv"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> m2_inv6_ikk_init"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv6_ikk_initI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m2_inv5_ikk_svD<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv6_resp_ikk <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m2_inv7_ikk_resp"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m1_inv2r_serv <span class="main">∩</span> m2_inv5_ikk_sv"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> m2_inv7_ikk_resp"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv7_ikk_respI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m2_inv5_ikk_svD<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="m3_nssk_par">
<div class="head">
<h1>Theory m3_nssk_par</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Development of Security Protocols by Refinement

  Module:  Key_establish/m3_nssk_par.thy (Isabelle/HOL 2016-1)
  ID:      $Id: m3_nssk_par.thy 132890 2016-12-24 10:25:57Z csprenge $
  Author:  Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;

  Key distribution protocols
  Third refinement: parallel version of Needham-Schroeder Shared Key protocol
  (NSSK, Boyd/Mathuria, Protocol 3.19)

  Copyright (c) 2009-2016 Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Needham-Schroeder Shared Key, "parallel" variant (L3)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> m3_nssk_par <span class="keyword2"><span class="keyword">imports</span></span> <a href="m2_nssk.html">m2_nssk</a> <span class="quoted">"<a href="Message.html">../Refinement/Message</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
We model an abstract version of the Needham-Schroeder Shared Key protocol:
\[
\begin{array}{lll}
  \mathrm{M1.} &amp; A \rightarrow S: &amp; A, B, Na \\ 
  \mathrm{M2.} &amp; S \rightarrow A: &amp; \{Na, B, Kab, \{Kab, A\}_{Kbs} \}_{Kas} \\
  \mathrm{M3.} &amp; A \rightarrow B: &amp; \{Kab, A\}_{Kbs} \\
  \mathrm{M4.} &amp; B \rightarrow A: &amp; \{Nb\}_{Kab} \\ 
  \mathrm{M5.} &amp; A \rightarrow B: &amp; \{Nb - 1 \}_{Kab} \\
\end{array}
\]
We model a "parallel" version of the NSSK protocol:
\[
\begin{array}{lll}
  \mathrm{M1.} &amp; A \rightarrow S: &amp; A, B, Na \\ 
  \mathrm{M2.} &amp; S \rightarrow A: &amp; \{Na, B, Kab\}_{Kas} \\
  \mathrm{M3.} &amp; S \rightarrow B: &amp; \{Kab, A\}_{Kbs} \\
  \mathrm{M4.} &amp; B \rightarrow A: &amp; \{Nb\}_{Kab} \\ 
  \mathrm{M5.} &amp; A \rightarrow B: &amp; \{Nb - 1 \}_{Kab} \\
\end{array}
\]
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Proof tool configuration. Avoid annoying automatic unfolding of
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>dom›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">declare</span></span> domIff <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">iff</span> <span class="quasi_keyword">del</span><span class="main">]</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Setup›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now we can define the initial key knowledge.›</span></span>

<span class="keyword1"><span class="command">overloading</span></span> ltkeySetup' <span class="main">≡</span> <span class="quoted">ltkeySetup</span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> ltkeySetup_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ltkeySetup'</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span>sharK <span class="bound">C</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span> <span class="main">|</span> <span class="bound">C</span> <span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">=</span> <span class="bound">C</span> <span class="main">∨</span> <span class="bound">A</span> <span class="main">=</span> Sv<span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> corrKey_shrK_bad <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"corrKey <span class="main">=</span> shrK<span class="main">`</span>bad"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> keySetup_def ltkeySetup_def corrKey_def<span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹State›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The secure channels are star-shaped to/from the server.  Therefore,
we have only one agent in the relation.›</span></span>

<span class="keyword1"><span class="command">record</span></span> m3_state <span class="main">=</span> <span class="quoted"><span class="quoted">"m1_state"</span></span> <span class="main">+</span>
  IK <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set"</span></span>                                <span class="comment1">― ‹intruder knowledge›</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Observable state: agent's local state.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  m3_obs <span class="main">=</span> <span class="quoted">m2_obs</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_obs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_state <span class="main">⇒</span> m3_obs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_obs</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> runs <span class="main">=</span> runs <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> leak <span class="main">=</span> leak <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  m3_pred <span class="main">=</span> <span class="quoted"><span class="quoted">"m3_state set"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  m3_trans <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m3_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Events›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Protocol events.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">A</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m2_step1"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_step1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step1</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>

    <span class="comment1">― ‹guards:›</span>
    <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>                      <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Ra›</span></span> is fresh›</span>
    <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>na <span class="main">∧</span>                             <span class="comment1">― ‹generate nonce <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Na›</span></span>›</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      IK <span class="main">:=</span> insert <span class="main">⦃</span>Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Nonce <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">⦄</span> <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span>    <span class="comment1">― ‹send msg 1›</span>
    <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">B</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m2_step2"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_step2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step2</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>

    <span class="comment1">― ‹guards:›</span>
    <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>                       <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Rb›</span></span> is fresh›</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="comment1">― ‹create responder thread›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span>
    <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"Server"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m2_step3</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_step3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> key<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step3</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>                           <span class="comment1">― ‹fresh server run›</span>
    <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">=</span> sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span>                          <span class="comment1">― ‹fresh session key›</span>

    <span class="main">⦃</span>Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Nonce <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">⦄</span> <span class="main">∈</span> IK <span class="bound">s</span> <span class="main">∧</span>       <span class="comment1">― ‹recv msg 1›</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="comment1">― ‹record session key and send messages 2 and 3›</span>
    <span class="comment1">― ‹note that last field in server record is for responder nonce›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">↦</span> <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      IK <span class="main">:=</span> <span class="main">{</span>Crypt <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">⦃</span>Nonce <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Key <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">⦄</span><span class="main">,</span>
             Crypt <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">⦃</span>Key <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⦄</span><span class="main">}</span> <span class="main">∪</span> IK <span class="bound">s</span>
    <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">A</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m2_step4</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_step4</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> key<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step4</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>

    <span class="comment1">― ‹guards:›</span>
    runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>na <span class="main">∧</span>

    Crypt <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">⦃</span>Nonce <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Key <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">⦄</span> <span class="main">∈</span> IK <span class="bound">s</span> <span class="main">∧</span>  <span class="comment1">― ‹recv msg 2›</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="comment1">― ‹record session key›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
    <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">B</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m2_step5</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_step5</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> key<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step5</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Nb</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>

    <span class="comment1">― ‹guards:›</span>
    runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">Nb</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>nb <span class="main">∧</span>

    Crypt <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">⦃</span>Key <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⦄</span> <span class="main">∈</span> IK <span class="bound">s</span> <span class="main">∧</span>              <span class="comment1">― ‹recv msg 3›</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="comment1">― ‹record session key›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      IK <span class="main">:=</span> insert <span class="main">(</span>Crypt <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">(</span>Nonce <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span>
    <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">A</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m2_step6</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_step6</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> nonce<span class="main">,</span> key<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step6</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Nb</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span>      <span class="comment1">― ‹key recv'd before›</span>
    <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>na <span class="main">∧</span>

    Crypt <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">(</span>Nonce <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">)</span> <span class="main">∈</span> IK <span class="bound">s</span> <span class="main">∧</span>                      <span class="comment1">― ‹receive <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M4›</span></span>›</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aNon <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      IK <span class="main">:=</span> insert <span class="main">(</span>Crypt <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">⦃</span>Nonce <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">,</span> Nonce <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">⦄</span><span class="main">)</span> <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span>
    <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">B</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m2_step6</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_step7</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> key<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step7</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Nb</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span>       <span class="comment1">― ‹key recv'd before›</span>
    <span class="free"><span class="bound"><span class="entity">Nb</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>nb <span class="main">∧</span>

    Crypt <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">⦃</span>Nonce <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">,</span> Nonce <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">⦄</span> <span class="main">∈</span> IK <span class="bound">s</span> <span class="main">∧</span>               <span class="comment1">― ‹receive <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M5›</span></span>›</span>

    <span class="comment1">― ‹actions: (redundant) update local state marks successful termination›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> END<span class="main">]</span><span class="main">)</span><span class="main">)</span>
    <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Session key compromise.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m2_leak</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_leak</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> rid_t<span class="main">,</span> rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_leak</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>na<span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span>
    runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="main">(</span>sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span><span class="main">,</span> aNon <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>nb<span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span>
    runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="main">(</span>sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span><span class="main">,</span> END<span class="main">]</span><span class="main">)</span> <span class="main">∧</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="comment1">― ‹record session key as leaked and add it to intruder knowledge›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> leak <span class="main">:=</span> insert <span class="main">(</span>sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>na<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>nb<span class="main">)</span> <span class="main">(</span>leak <span class="bound">s</span><span class="main">)</span><span class="main">,</span>
            IK <span class="main">:=</span> insert <span class="main">(</span>Key <span class="main">(</span>sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span> <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Intruder fake event.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m2_fake"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_DY_fake</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_DY_fake</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>

     <span class="comment1">― ‹actions:›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">(|</span>
       IK <span class="main">:=</span> synth <span class="main">(</span>analz <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span><span class="main">)</span>
     <span class="main">|)</span>
  <span class="main">}</span>"</span></span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Transition system›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_init</span> <span class="main">≡</span> <span class="main">{</span> <span class="main">⦇</span>
     runs <span class="main">=</span> Map.empty<span class="main">,</span>
     leak <span class="main">=</span> shrK<span class="main">`</span>bad <span class="main">×</span> <span class="main">{</span>undefined<span class="main">}</span> <span class="main">×</span> <span class="main">{</span>undefined<span class="main">}</span><span class="main">,</span>
     IK <span class="main">=</span> Key<span class="main">`</span>shrK<span class="main">`</span>bad
  <span class="main">⦈</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m3_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_trans</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">Ra</span> <span class="bound">Rb</span> <span class="bound">Rs</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Nb</span> <span class="bound">Kab</span><span class="main">.</span>
     m3_step1 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="main">∪</span>
     m3_step2 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">∪</span>
     m3_step3 <span class="bound">Rs</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Kab</span> <span class="main">∪</span>
     m3_step4 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Kab</span> <span class="main">∪</span>
     m3_step5 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Nb</span> <span class="bound">Kab</span> <span class="main">∪</span>
     m3_step6 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Nb</span> <span class="bound">Kab</span> <span class="main">∪</span>
     m3_step7 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Nb</span> <span class="bound">Kab</span> <span class="main">∪</span>
     m3_leak <span class="bound">Rs</span> <span class="bound">Ra</span> <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">∪</span>
     m3_DY_fake <span class="main">∪</span>
     Id
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m3_state<span class="main">,</span> m3_obs<span class="main">)</span> spec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3</span> <span class="main">≡</span> <span class="main">⦇</span>
    init <span class="main">=</span> m3_init<span class="main">,</span>
    trans <span class="main">=</span> m3_trans<span class="main">,</span>
    obs <span class="main">=</span> m3_obs
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_defs <span class="main">=</span>
  m3_def m3_init_def m3_trans_def m3_obs_def
  m3_step1_def m3_step2_def m3_step3_def m3_step4_def m3_step5_def
  m3_step6_def m3_step7_def m3_leak_def m3_DY_fake_def


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Specialized injection that we can apply more aggressively.›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> analz_Inj_IK <span class="main">=</span> analz.Inj <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"IK <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">s</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> parts_Inj_IK <span class="main">=</span> parts.Inj <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"IK <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">s</span><span class="main">]</span>

<span class="keyword1"><span class="command">declare</span></span> parts_Inj_IK <span class="main">[</span><span class="operator">dest</span><span class="main"><span class="main">!</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">declare</span></span> analz_into_parts <span class="main">[</span><span class="operator">dest</span><span class="main">]</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv1: Secrecy of pre-distributed shared keys›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹inv1: Secrecy of long-term keys›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_inv1_lkeysec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_inv1_lkeysec</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">C</span><span class="main">.</span>
     <span class="main">(</span>Key <span class="main">(</span>shrK <span class="bound">C</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">C</span> <span class="main">∈</span> bad<span class="main">)</span> <span class="main">∧</span>
     <span class="main">(</span><span class="bound">C</span> <span class="main">∈</span> bad <span class="main">⟶</span> Key <span class="main">(</span>shrK <span class="bound">C</span><span class="main">)</span> <span class="main">∈</span> IK <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_inv1_lkeysecI <span class="main">=</span> m3_inv1_lkeysec_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv1_lkeysecE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m3_inv1_lkeysec_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv1_lkeysecD <span class="main">=</span> m3_inv1_lkeysec_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv1_lkeysec_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m3 <span class="main">⊆</span> m3_inv1_lkeysec"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m3_defs m3_inv1_lkeysec_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv1_lkeysec_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m3_inv1_lkeysec<span class="main">}</span> trans m3 <span class="main">{&gt;</span> m3_inv1_lkeysec<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv1_lkeysecI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv1_lkeysec <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m3 <span class="main">⊆</span> m3_inv1_lkeysec"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_incr<span class="main">)</span> <span class="main">(</span><span class="operator">fast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Useful simplifier lemmas›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m3_inv1_lkeysec_for_parts <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">s</span> <span class="main">∈</span> m3_inv1_lkeysec <span class="main">⟧</span> <span class="main">⟹</span> Key <span class="main">(</span>shrK <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>IK <span class="free">s</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">C</span> <span class="main">∈</span> bad"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> m3_inv1_lkeysec_for_analz <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">s</span> <span class="main">∈</span> m3_inv1_lkeysec <span class="main">⟧</span> <span class="main">⟹</span> Key <span class="main">(</span>shrK <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="free">s</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">C</span> <span class="main">∈</span> bad"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv7a: Session keys not used to encrypt other session keys›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Session keys are not used to encrypt other keys. Proof requires
generalization to sets of session keys.

NOTE: This invariant will be derived from the corresponding L2 invariant
using the simulation relation.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_inv7a_sesK_compr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_inv7a_sesK_compr</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">K</span> <span class="bound">KK</span><span class="main">.</span>
     <span class="bound">KK</span> <span class="main">⊆</span> range sesK <span class="main">⟶</span>
     <span class="main">(</span>Key <span class="bound">K</span> <span class="main">∈</span> analz <span class="main">(</span>Key<span class="main">`</span><span class="bound">KK</span> <span class="main">∪</span> <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">K</span> <span class="main">∈</span> <span class="bound">KK</span> <span class="main">∨</span> Key <span class="bound">K</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_inv7a_sesK_comprI <span class="main">=</span> m3_inv7a_sesK_compr_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv7a_sesK_comprE <span class="main">=</span> m3_inv7a_sesK_compr_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv7a_sesK_comprD <span class="main">=</span> m3_inv7a_sesK_compr_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Additional lemma›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> insert_commute_Key <span class="main">=</span> insert_commute <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Key <span class="free">K</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">K</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_inv7a_sesK_compr_simps <span class="main">=</span>
  m3_inv7a_sesK_comprD
  m3_inv7a_sesK_comprD <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">Kab</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">Kab</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  m3_inv7a_sesK_comprD <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"insert <span class="free">Kab</span> <span class="free">KK</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">Kab</span> <span class="free">KK</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  insert_commute_Key


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Message abstraction and simulation relation›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Abstraction function on sets of messages.›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span>
  <span class="entity">abs_msg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set <span class="main">⇒</span> chmsg set"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">H</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  am_M1<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⦃</span>Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Nonce <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">⦄</span> <span class="main">∈</span> <span class="free">H</span>
  <span class="main">⟹</span> Insec <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">abs_msg</span> <span class="free">H</span>"</span></span>
<span class="main">|</span> am_M2<span class="main">:</span>
    <span class="quoted"><span class="quoted">"Crypt <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">⦃</span>Nonce <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Key <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">⦄</span> <span class="main">∈</span> <span class="free">H</span>
  <span class="main">⟹</span> Secure Sv <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> aAgt <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> aKey <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">abs_msg</span> <span class="free">H</span>"</span></span>
<span class="main">|</span> am_M3<span class="main">:</span>
    <span class="quoted"><span class="quoted">"Crypt <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">⦃</span>Key <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⦄</span> <span class="main">∈</span> <span class="free">H</span>
  <span class="main">⟹</span> Secure Sv <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">,</span> aAgt <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">abs_msg</span> <span class="free">H</span>"</span></span>
<span class="main">|</span> am_M4<span class="main">:</span>
    <span class="quoted"><span class="quoted">"Crypt <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">(</span>Nonce <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">H</span>
  <span class="main">⟹</span> dAuth <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">abs_msg</span> <span class="free">H</span>"</span></span>
<span class="main">|</span> am_M5<span class="main">:</span>
    <span class="quoted"><span class="quoted">"Crypt <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">⦃</span>Nonce <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> Nonce <span class="free"><span class="bound"><span class="entity">N'</span></span></span><span class="main">⦄</span> <span class="main">∈</span> <span class="free">H</span>
  <span class="main">⟹</span> dAuth <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> aNon <span class="free"><span class="bound"><span class="entity">N'</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">abs_msg</span> <span class="free">H</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹R23: The simulation relation. This is a data refinement of
the insecure and secure channels of refinement 2.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R23_msgs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R23_msgs</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> abs_msg <span class="main">(</span>parts <span class="main">(</span>IK <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> chan <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R23_keys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>      <span class="comment1">― ‹equivalence!›</span>
  <span class="quoted"><span class="quoted">"<span class="free">R23_keys</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">KK</span> <span class="bound">K</span><span class="main">.</span> <span class="bound">KK</span> <span class="main">⊆</span> range sesK <span class="main">⟶</span>
     Key <span class="bound">K</span> <span class="main">∈</span> analz <span class="main">(</span>Key<span class="main">`</span><span class="bound">KK</span> <span class="main">∪</span> IK <span class="bound">t</span><span class="main">)</span> <span class="main">⟷</span> aKey <span class="bound">K</span> <span class="main">∈</span> extr <span class="main">(</span>aKey<span class="main">`</span><span class="bound">KK</span> <span class="main">∪</span> ik0<span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R23_non</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>      <span class="comment1">― ‹only an implication!›</span>
  <span class="quoted"><span class="quoted">"<span class="free">R23_non</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">KK</span> <span class="bound">N</span><span class="main">.</span> <span class="bound">KK</span> <span class="main">⊆</span> range sesK <span class="main">⟶</span>
     Nonce <span class="bound">N</span> <span class="main">∈</span> analz <span class="main">(</span>Key<span class="main">`</span><span class="bound">KK</span> <span class="main">∪</span> IK <span class="bound">t</span><span class="main">)</span> <span class="main">⟶</span> aNon <span class="bound">N</span> <span class="main">∈</span> extr <span class="main">(</span>aKey<span class="main">`</span><span class="bound">KK</span> <span class="main">∪</span> ik0<span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R23_pres</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R23_pres</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> runs <span class="bound">s</span> <span class="main">=</span> runs <span class="bound">t</span> <span class="main">∧</span> leak <span class="bound">s</span> <span class="main">=</span> leak <span class="bound">t</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R23</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R23</span> <span class="main">≡</span> R23_msgs <span class="main">∩</span> R23_keys <span class="main">∩</span> R23_non <span class="main">∩</span> R23_pres"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_defs <span class="main">=</span>
  R23_def R23_msgs_def R23_keys_def R23_non_def R23_pres_def


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The mediator function is the identity here.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">med32</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_obs <span class="main">⇒</span> m2_obs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med32</span> <span class="main">≡</span> id"</span></span>


<span class="keyword1"><span class="command">lemmas</span></span> R23_msgsI <span class="main">=</span> R23_msgs_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_intro<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_msgsE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> R23_msgs_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_elim<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_keysI <span class="main">=</span> R23_keys_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_intro<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_keysE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> R23_keys_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_elim<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_keysD <span class="main">=</span> R23_keys_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_dest<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_nonI <span class="main">=</span> R23_non_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_intro<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_nonE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> R23_non_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_elim<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_nonD <span class="main">=</span> R23_non_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_dest<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 2<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_presI <span class="main">=</span> R23_pres_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_intro<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_presE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> R23_pres_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_elim<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_intros <span class="main">=</span> R23_msgsI R23_keysI R23_nonI R23_presI


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Further lemmas: general lemma for simplifier and different instantiations.›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_keys_simps <span class="main">=</span>
  R23_keysD
  R23_keysD <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  R23_keysD <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">K'</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">K'</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  R23_keysD <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"insert <span class="free">K'</span> <span class="free">KK</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">K'</span> <span class="free">KK</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> _ conjI<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_non_dests <span class="main">=</span>
  R23_nonD
  R23_nonD <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  R23_nonD <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">K</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">K</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  R23_nonD <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"insert <span class="free">K</span> <span class="free">KK</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">K</span> <span class="free">KK</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> _ _ conjI<span class="main">]</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹General lemmas›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹General facts about <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"abs_msg"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">declare</span></span> abs_msg.intros <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span></span></span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> abs_msg.cases <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main">!</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"abs_msg <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_Un <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"abs_msg <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> abs_msg <span class="free">G</span> <span class="main">∪</span> abs_msg <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_mono <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">m</span> <span class="main">∈</span> abs_msg <span class="free">G</span><span class="main">;</span> <span class="free">G</span> <span class="main">⊆</span> <span class="free">H</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">∈</span> abs_msg <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_insert_mono <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">m</span> <span class="main">∈</span> abs_msg <span class="free">H</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">∈</span> abs_msg <span class="main">(</span>insert <span class="free">m'</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Facts about <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"abs_msg"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> concerning abstraction of fakeable
messages. This is crucial for proving the refinement of the intruder event.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_DY_subset_fakeable<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> R23_msgs<span class="main">;</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> R23_keys<span class="main">;</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> R23_non<span class="main">;</span> <span class="free">t</span> <span class="main">∈</span> m3_inv1_lkeysec <span class="main">⟧</span>
  <span class="main">⟹</span> abs_msg <span class="main">(</span>synth <span class="main">(</span>analz <span class="main">(</span>IK <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> fake ik0 <span class="main">(</span>dom <span class="main">(</span>runs <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="comment1">― ‹9 subgoals, deal with replays first›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 3 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 4 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 5 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
<span class="comment1">― ‹remaining 5 subgoals are real fakes›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> fake_StatCh fake_DynCh<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23_keys_simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> R23_non_dests<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement proof›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Pair decomposition. These were set to \texttt{elim!}, which is too
agressive here.›</span></span>

<span class="keyword1"><span class="command">declare</span></span> MPair_analz <span class="main">[</span><span class="operator">rule</span> <span class="quasi_keyword">del</span><span class="main">,</span> <span class="operator">elim</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> MPair_parts <span class="main">[</span><span class="operator">rule</span> <span class="quasi_keyword">del</span><span class="main">,</span> <span class="operator">elim</span><span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Protocol events.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step1_refines_m2_step1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
     <span class="main">(</span>m2_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m2_defs m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step2_refines_m2_step2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
     <span class="main">(</span>m2_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m2_defs m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step3_refines_m2_step3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23 <span class="main">∩</span> <span class="main">(</span>m2_inv3a_sesK_compr<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>m3_inv7a_sesK_compr <span class="main">∩</span> m3_inv1_lkeysec<span class="main">)</span><span class="main">}</span>
     <span class="main">(</span>m2_step3 <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step3 <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R23_msgs"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R23_keys"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R23_non"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R23_pres"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> m2_inv3a_sesK_compr"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> m3_inv7a_sesK_compr"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> m3_inv1_lkeysec"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">Kab</span> <span class="main">=</span> sesK <span class="main">(</span><span class="free">Rs</span><span class="main">$</span>sk<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Rs</span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">⦃</span> Agent <span class="free">A</span><span class="main">,</span> Agent <span class="free">B</span><span class="main">,</span> Nonce <span class="free">Na</span> <span class="main">⦄</span> <span class="main">∈</span> parts <span class="main">(</span>IK <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span><span class="main">=</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">⦇</span> runs <span class="main">:=</span> runs <span class="skolem">s</span><span class="main">(</span><span class="free">Rs</span> <span class="main">↦</span> <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="free">Na</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
          chan <span class="main">:=</span> insert <span class="main">(</span>Secure Sv <span class="free">A</span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="free">Na</span><span class="main">,</span> aAgt <span class="free">B</span><span class="main">,</span> aKey <span class="free">Kab</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
                 <span class="main">(</span>insert <span class="main">(</span>Secure Sv <span class="free">B</span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">,</span> aAgt <span class="free">A</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chan <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t'</span></span></span><span class="main">=</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">⦇</span> runs <span class="main">:=</span> runs <span class="skolem">t</span><span class="main">(</span><span class="free">Rs</span> <span class="main">↦</span> <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="free">Na</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
          IK <span class="main">:=</span> insert <span class="main">(</span>Crypt <span class="main">(</span>shrK <span class="free">A</span><span class="main">)</span> <span class="main">⦃</span> Nonce <span class="free">Na</span><span class="main">,</span> Agent <span class="free">B</span><span class="main">,</span> Key <span class="free">Kab</span> <span class="main">⦄</span><span class="main">)</span>
                <span class="main">(</span>insert <span class="main">(</span>Crypt <span class="main">(</span>shrK <span class="free">B</span><span class="main">)</span> <span class="main">⦃</span> Key <span class="free">Kab</span><span class="main">,</span> Agent <span class="free">A</span> <span class="main">⦄</span><span class="main">)</span> <span class="main">(</span>IK <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s'</span><span class="main">,</span> <span class="var">?t'</span><span class="main">)</span> <span class="main">∈</span> R23_msgs"</span></span> <span class="keyword1"><span class="command">using</span></span> H
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> R23_intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s'</span><span class="main">,</span> <span class="var">?t'</span><span class="main">)</span> <span class="main">∈</span> R23_keys"</span></span> <span class="keyword1"><span class="command">using</span></span> H
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> R23_intros<span class="main"><span class="keyword3">,</span></span>
            <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_inv3a_sesK_compr_simps m3_inv7a_sesK_compr_simps<span class="main"><span class="keyword3">,</span></span>
            <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23_keys_simps<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s'</span><span class="main">,</span> <span class="var">?t'</span><span class="main">)</span> <span class="main">∈</span> R23_non"</span></span> <span class="keyword1"><span class="command">using</span></span> H
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> R23_intros<span class="main"><span class="keyword3">,</span></span>
            <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_inv3a_sesK_compr_simps m3_inv7a_sesK_compr_simps
                 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> R23_non_dests<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s'</span><span class="main">,</span> <span class="var">?t'</span><span class="main">)</span> <span class="main">∈</span> R23_pres"</span></span> <span class="keyword1"><span class="command">using</span></span> H
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> R23_intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">note</span></span> calculation
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m2_defs m3_defs<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*  with equality in R23_keys [OLD, before adding session key compromise]:

goal (1 subgoal):
 1. ⋀s t. ⟦t ∈ m3_inv3_keyuse; t ∈ m3_inv1_lkeysec; t ∈ m3_inv5_badkeys;
           Kab ∉ dom (runs t); Kab ∉ range shrK;
           ⦃Agent A, Agent B, Nonce Na⦄ ∈ parts (IK t);
           Kab ∉ keysFor (analz (IK t)); Key (shrK A) ∉ analz (IK t);
           (s, t) ∈ R23_msgs; (s, t) ∈ R23_keys; (s, t) ∈ R23_pres; Kab ≠ shrK A;
           Key (shrK B) ∈ analz (IK t); Kab ≠ shrK B; A ∉ bad; B ∈ bad⟧
          ⟹ Key Kab ∈ analz (IK t)

This does NOT hold, since Kab is revealed in abstract model when A ∉ bad; B ∈ bad,
but not in concrete one, since here it is protected by A's encryption.
*)</span>


<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step4_refines_m2_step4<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
     <span class="main">(</span>m2_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m2_defs m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step5_refines_m2_step5<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
     <span class="main">(</span>m2_step5 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Nb</span> <span class="free">Kab</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step5 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Nb</span> <span class="free">Kab</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m2_defs m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step6_refines_m2_step6<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
     <span class="main">(</span>m2_step6 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Nb</span> <span class="free">Kab</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step6 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Nb</span> <span class="free">Kab</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m2_defs m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step7_refines_m2_step7<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
     <span class="main">(</span>m2_step7 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Nb</span> <span class="free">Kab</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step7 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Nb</span> <span class="free">Kab</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m2_defs m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Intruder events.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_leak_refines_m2_leak<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
     <span class="main">(</span>m2_leak <span class="free">Rs</span> <span class="free">Ra</span> <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_leak <span class="free">Rs</span> <span class="free">Ra</span> <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span>
   <span class="main">{&gt;</span>R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m2_defs m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23_keys_simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> R23_non_dests<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_DY_fake_refines_m2_fake<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23 <span class="main">∩</span> UNIV <span class="main">×</span> m3_inv1_lkeysec<span class="main">}</span>
     m2_fake<span class="main">,</span> m3_DY_fake
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m2_defs m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros
            <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> abs_msg.cases<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> abs_msg_DY_subset_fakeable <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span>
            <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> abs_msg.cases<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23_keys_simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> R23_non_dests<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All together now...›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_m3_trans_refines_m2_trans <span class="main">=</span>
  PO_m3_step1_refines_m2_step1 PO_m3_step2_refines_m2_step2
  PO_m3_step3_refines_m2_step3 PO_m3_step4_refines_m2_step4
  PO_m3_step5_refines_m2_step5 PO_m3_step6_refines_m2_step6
  PO_m3_step7_refines_m2_step7 PO_m3_leak_refines_m2_leak
  PO_m3_DY_fake_refines_m2_fake


<span class="keyword1"><span class="command">lemma</span></span> PO_m3_refines_init_m2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m3 <span class="main">⊆</span> R23<span class="main">``</span><span class="main">(</span>init m2<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23_def m2_defs m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_refines_trans_m2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23 <span class="main">∩</span> <span class="main">(</span>m2_inv3a_sesK_compr<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>m3_inv7a_sesK_compr <span class="main">∩</span> m3_inv1_lkeysec<span class="main">)</span><span class="main">}</span>
     <span class="main">(</span>trans m2<span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans m3<span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m3_def m3_trans_def m2_def m2_trans_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_m3_trans_refines_m2_trans<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_observation_consistent <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"obs_consistent R23 med32 m2 m3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R23_def med32_def m2_defs m3_defs<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement result.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m3_refines_m2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"refines <span class="main">(</span>R23 <span class="main">∩</span> m2_inv3a_sesK_compr <span class="main">×</span> m3_inv1_lkeysec<span class="main">)</span>
     med32 m2 m3"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"R23 <span class="main">∩</span> m2_inv3a_sesK_compr <span class="main">×</span> UNIV <span class="main">⊆</span> UNIV <span class="main">×</span> m3_inv7a_sesK_compr"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23_def R23_keys_simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv7a_sesK_comprI<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> Refinement_using_invariants<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> m3_implements_m2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"implements med32 m2 m3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refinement_soundness<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Inherited invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv4 (derived): Key secrecy for initiator›</span></span>
<span class="comment1">(*invh*************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_inv4_ikk_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_inv4_ikk_init</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Ra</span> <span class="bound">K</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">al</span><span class="main">.</span>
     runs <span class="bound">s</span> <span class="bound">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> aKey <span class="bound">K</span> <span class="main">#</span> <span class="bound">al</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">A</span> <span class="main">∈</span> good <span class="main">⟶</span> <span class="bound">B</span> <span class="main">∈</span> good <span class="main">⟶</span>
     Key <span class="bound">K</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound">Nb'</span><span class="main">.</span> <span class="main">(</span><span class="bound">K</span><span class="main">,</span> <span class="bound">Ra</span> <span class="main">$</span> na<span class="main">,</span> <span class="bound">Nb'</span><span class="main">)</span> <span class="main">∈</span> leak <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_inv4_ikk_initI <span class="main">=</span> m3_inv4_ikk_init_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv4_ikk_initE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m3_inv4_ikk_init_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv4_ikk_initD <span class="main">=</span> m3_inv4_ikk_init_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv4_ikk_init<span class="main">:</span> <span class="quoted"><span class="quoted">"reach m3 <span class="main">⊆</span> m3_inv4_ikk_init"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> INV_from_Refinement_using_invariants <span class="main"><span class="main">[</span></span><span class="operator">OF</span> m3_refines_m2<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Range <span class="main">(</span>R23 <span class="main">∩</span> m2_inv3a_sesK_compr <span class="main">×</span> m3_inv1_lkeysec
                   <span class="main">∩</span> m2_inv6_ikk_init <span class="main">×</span> UNIV<span class="main">)</span>
      <span class="main">⊆</span> m3_inv4_ikk_init"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23_def R23_pres_def R23_keys_simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv4_ikk_initI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv5 (derived): Key secrecy for responder›</span></span>
<span class="comment1">(*invh*************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_inv5_ikk_resp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_inv5_ikk_resp</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Rb</span> <span class="bound">K</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">al</span><span class="main">.</span>
     runs <span class="bound">s</span> <span class="bound">Rb</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> aKey <span class="bound">K</span> <span class="main">#</span> <span class="bound">al</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">A</span> <span class="main">∈</span> good <span class="main">⟶</span> <span class="bound">B</span> <span class="main">∈</span> good <span class="main">⟶</span>
     Key <span class="bound">K</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="bound">K</span> <span class="main">∈</span> Domain <span class="main">(</span>leak <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_inv5_ikk_respI <span class="main">=</span> m3_inv5_ikk_resp_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv5_ikk_respE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m3_inv5_ikk_resp_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv5_ikk_respD <span class="main">=</span> m3_inv5_ikk_resp_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv4_ikk_resp<span class="main">:</span> <span class="quoted"><span class="quoted">"reach m3 <span class="main">⊆</span> m3_inv5_ikk_resp"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> INV_from_Refinement_using_invariants <span class="main"><span class="main">[</span></span><span class="operator">OF</span> m3_refines_m2<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Range <span class="main">(</span>R23 <span class="main">∩</span> m2_inv3a_sesK_compr <span class="main">×</span> m3_inv1_lkeysec
                   <span class="main">∩</span> m2_inv7_ikk_resp <span class="main">×</span> UNIV<span class="main">)</span>
      <span class="main">⊆</span> m3_inv5_ikk_resp"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23_def R23_pres_def R23_keys_simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv5_ikk_respI<span class="main">)</span>
       <span class="main">(</span><span class="operator">elim</span> m2_inv7_ikk_respE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>


<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="m3_nssk">
<div class="head">
<h1>Theory m3_nssk</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Development of Security Protocols by Refinement

  Module:  Key_establish/m3_nssk.thy (Isabelle/HOL 2016-1)
  ID:      $Id: m3_nssk.thy 132890 2016-12-24 10:25:57Z csprenge $
  Author:  Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;

  Key distribution protocols
  Third refinement: Needham-Schroeder Shared Key protocol (NSSK)
  (Boyd/Mathuria, Protocol 3.19)

  Copyright (c) 2009-2016 Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Needham-Schroeder Shared Key (L3)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> m3_nssk <span class="keyword2"><span class="keyword">imports</span></span> <a href="m2_nssk.html">m2_nssk</a> <span class="quoted">"<a href="Message.html">../Refinement/Message</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
We model an abstract version of the Needham-Schroeder Shared Key protocol:
\[
\begin{array}{lll}
  \mathrm{M1.} &amp; A \rightarrow S: &amp; A, B, Na \\ 
  \mathrm{M2.} &amp; S \rightarrow A: &amp; \{Na, B, Kab, \{Kab, A\}_{Kbs} \}_{Kas} \\
  \mathrm{M3.} &amp; A \rightarrow B: &amp; \{Kab, A\}_{Kbs} \\
  \mathrm{M4.} &amp; B \rightarrow A: &amp; \{Nb\}_{Kab} \\ 
  \mathrm{M5.} &amp; A \rightarrow B: &amp; \{Nb - 1 \}_{Kab} \\
\end{array}
\]
This refinement works with a single insecure channel and introduces the full
Dolev-Yao intruder.
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Proof tool configuration. Avoid annoying automatic unfolding of
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>dom›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">declare</span></span> domIff <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">iff</span> <span class="quasi_keyword">del</span><span class="main">]</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Setup›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now we can define the initial key knowledge.›</span></span>

<span class="keyword1"><span class="command">overloading</span></span> ltkeySetup' <span class="main">≡</span> <span class="quoted">ltkeySetup</span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> ltkeySetup_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ltkeySetup'</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span>sharK <span class="bound">C</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span> <span class="main">|</span> <span class="bound">C</span> <span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">=</span> <span class="bound">C</span> <span class="main">∨</span> <span class="bound">A</span> <span class="main">=</span> Sv<span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> corrKey_shrK_bad <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"corrKey <span class="main">=</span> shrK<span class="main">`</span>bad"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> keySetup_def ltkeySetup_def corrKey_def<span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹State›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The secure channels are star-shaped to/from the server.  Therefore,
we have only one agent in the relation.›</span></span>

<span class="keyword1"><span class="command">record</span></span> m3_state <span class="main">=</span> <span class="quoted"><span class="quoted">"m1_state"</span></span> <span class="main">+</span>
  IK <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set"</span></span>                                <span class="comment1">― ‹intruder knowledge›</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Observable state: agent's local state.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  m3_obs <span class="main">=</span> <span class="quoted">m2_obs</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_obs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_state <span class="main">⇒</span> m3_obs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_obs</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> runs <span class="main">=</span> runs <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> leak <span class="main">=</span> leak <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  m3_pred <span class="main">=</span> <span class="quoted"><span class="quoted">"m3_state set"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  m3_trans <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m3_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Events›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Protocol events.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">A</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m2_step1"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_step1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step1</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>

    <span class="comment1">― ‹guards:›</span>
    <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>                      <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Ra›</span></span> is fresh›</span>
    <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>na <span class="main">∧</span>                             <span class="comment1">― ‹generate nonce <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Na›</span></span>›</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      IK <span class="main">:=</span> insert <span class="main">⦃</span>Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Nonce <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">⦄</span> <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span>    <span class="comment1">― ‹send msg 1›</span>
    <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">B</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m2_step2"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_step2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step2</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>

    <span class="comment1">― ‹guards:›</span>
    <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>                       <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Rb›</span></span> is fresh›</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="comment1">― ‹create responder thread›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span>
    <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"Server"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m2_step3</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_step3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> key<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step3</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>                           <span class="comment1">― ‹fresh server run›</span>
    <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">=</span> sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span>                          <span class="comment1">― ‹fresh session key›</span>

    <span class="main">⦃</span>Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Nonce <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">⦄</span> <span class="main">∈</span> IK <span class="bound">s</span> <span class="main">∧</span>     <span class="comment1">― ‹recv msg 1›</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="comment1">― ‹record session key and send messages 2 and 3›</span>
    <span class="comment1">― ‹note that last field in server record is for responder nonce›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">↦</span> <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      IK <span class="main">:=</span> insert
              <span class="main">(</span>Crypt <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>
                <span class="main">⦃</span>Nonce <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Key <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span>
                   Crypt <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">⦃</span>Key <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⦄</span><span class="main">⦄</span><span class="main">)</span>
              <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span>
    <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">A</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m2_step4</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_step4</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> key<span class="main">,</span> msg<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step4</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>

    <span class="comment1">― ‹guards:›</span>
    runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>na <span class="main">∧</span>

    Crypt <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">⦃</span>Nonce <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Key <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">⦄</span> <span class="main">∈</span> IK <span class="bound">s</span> <span class="main">∧</span>  <span class="comment1">― ‹recv msg 2›</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="comment1">― ‹record session key, and forward <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>X›</span></span>›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      IK <span class="main">:=</span> insert <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span>
    <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">B</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m2_step5</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_step5</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> key<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step5</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Nb</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>

    <span class="comment1">― ‹guards:›</span>
    runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">Nb</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>nb <span class="main">∧</span>

    Crypt <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">⦃</span>Key <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⦄</span> <span class="main">∈</span> IK <span class="bound">s</span> <span class="main">∧</span>              <span class="comment1">― ‹recv msg 3›</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="comment1">― ‹record session key›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      IK <span class="main">:=</span> insert <span class="main">(</span>Crypt <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">(</span>Nonce <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span>
    <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">A</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m2_step6</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_step6</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> nonce<span class="main">,</span> key<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step6</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="free"><span class="bound"><span class="entity">Nb</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span>      <span class="comment1">― ‹key recv'd before›</span>
    <span class="free"><span class="bound"><span class="entity">Na</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>na <span class="main">∧</span>

    Crypt <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">(</span>Nonce <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">)</span> <span class="main">∈</span> IK <span class="bound">s</span> <span class="main">∧</span>                      <span class="comment1">― ‹receive <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M4›</span></span>›</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aNon <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      IK <span class="main">:=</span> insert <span class="main">(</span>Crypt <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">⦃</span>Nonce <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">,</span> Nonce <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">⦄</span><span class="main">)</span> <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span>
    <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">B</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m2_step6</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_step7</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> nonce<span class="main">,</span> key<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step7</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Nb</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span>       <span class="comment1">― ‹key recv'd before›</span>
    <span class="free"><span class="bound"><span class="entity">Nb</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>nb <span class="main">∧</span>

    Crypt <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">⦃</span>Nonce <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">,</span> Nonce <span class="free"><span class="bound"><span class="entity">Nb</span></span></span><span class="main">⦄</span> <span class="main">∈</span> IK <span class="bound">s</span> <span class="main">∧</span>         <span class="comment1">― ‹receive <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M5›</span></span>›</span>

    <span class="comment1">― ‹actions: (redundant) update local state marks successful termination›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> END<span class="main">]</span><span class="main">)</span><span class="main">)</span>
    <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Session key compromise.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m2_leak</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_leak</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> rid_t<span class="main">,</span> rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_leak</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>na<span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span>
    runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="main">(</span>sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span><span class="main">,</span> aNon <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>nb<span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span>
    runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="main">(</span>sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span><span class="main">,</span> END<span class="main">]</span><span class="main">)</span> <span class="main">∧</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="comment1">― ‹record session key as leaked and add it to intruder knowledge›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> leak <span class="main">:=</span> insert <span class="main">(</span>sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main">$</span>na<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span><span class="main">$</span>nb<span class="main">)</span> <span class="main">(</span>leak <span class="bound">s</span><span class="main">)</span><span class="main">,</span>
            IK <span class="main">:=</span> insert <span class="main">(</span>Key <span class="main">(</span>sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span> <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Intruder fake event.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m2_fake"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_DY_fake</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_DY_fake</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>

     <span class="comment1">― ‹actions:›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">(|</span>
       IK <span class="main">:=</span> synth <span class="main">(</span>analz <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span><span class="main">)</span>
     <span class="main">|)</span>
  <span class="main">}</span>"</span></span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Transition system›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_init</span> <span class="main">≡</span> <span class="main">{</span> <span class="main">⦇</span>
     runs <span class="main">=</span> Map.empty<span class="main">,</span>
     leak <span class="main">=</span> shrK<span class="main">`</span>bad <span class="main">×</span> <span class="main">{</span>undefined<span class="main">}</span> <span class="main">×</span> <span class="main">{</span>undefined<span class="main">}</span><span class="main">,</span>
     IK <span class="main">=</span> Key<span class="main">`</span>shrK<span class="main">`</span>bad
  <span class="main">⦈</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m3_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_trans</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">Ra</span> <span class="bound">Rb</span> <span class="bound">Rs</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Nb</span> <span class="bound">Kab</span> <span class="bound">X</span><span class="main">.</span>
     m3_step1 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="main">∪</span>
     m3_step2 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">∪</span>
     m3_step3 <span class="bound">Rs</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Kab</span> <span class="main">∪</span>
     m3_step4 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Kab</span> <span class="bound">X</span> <span class="main">∪</span>
     m3_step5 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Nb</span> <span class="bound">Kab</span> <span class="main">∪</span>
     m3_step6 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Na</span> <span class="bound">Nb</span> <span class="bound">Kab</span> <span class="main">∪</span>
     m3_step7 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Nb</span> <span class="bound">Kab</span> <span class="main">∪</span>
     m3_leak <span class="bound">Rs</span> <span class="bound">Ra</span> <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">∪</span>
     m3_DY_fake <span class="main">∪</span>
     Id
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m3_state<span class="main">,</span> m3_obs<span class="main">)</span> spec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3</span> <span class="main">≡</span> <span class="main">⦇</span>
    init <span class="main">=</span> m3_init<span class="main">,</span>
    trans <span class="main">=</span> m3_trans<span class="main">,</span>
    obs <span class="main">=</span> m3_obs
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_defs <span class="main">=</span>
  m3_def m3_init_def m3_trans_def m3_obs_def
  m3_step1_def m3_step2_def m3_step3_def m3_step4_def m3_step5_def
  m3_step6_def m3_step7_def m3_leak_def m3_DY_fake_def


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Specialized injection that we can apply more aggressively.›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> analz_Inj_IK <span class="main">=</span> analz.Inj <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"IK <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">s</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> parts_Inj_IK <span class="main">=</span> parts.Inj <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"IK <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">s</span><span class="main">]</span>

<span class="keyword1"><span class="command">declare</span></span> parts_Inj_IK <span class="main">[</span><span class="operator">dest</span><span class="main"><span class="main">!</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">declare</span></span> analz_into_parts <span class="main">[</span><span class="operator">dest</span><span class="main">]</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv1: Secrecy of pre-distributed shared keys›</span></span>
<span class="comment1">(*inv**************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹inv1: Secrecy of long-term keys›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_inv1_lkeysec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_inv1_lkeysec</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">C</span><span class="main">.</span>
     <span class="main">(</span>Key <span class="main">(</span>shrK <span class="bound">C</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">C</span> <span class="main">∈</span> bad<span class="main">)</span> <span class="main">∧</span>
     <span class="main">(</span><span class="bound">C</span> <span class="main">∈</span> bad <span class="main">⟶</span> Key <span class="main">(</span>shrK <span class="bound">C</span><span class="main">)</span> <span class="main">∈</span> IK <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_inv1_lkeysecI <span class="main">=</span> m3_inv1_lkeysec_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv1_lkeysecE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m3_inv1_lkeysec_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv1_lkeysecD <span class="main">=</span> m3_inv1_lkeysec_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv1_lkeysec_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m3 <span class="main">⊆</span> m3_inv1_lkeysec"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m3_defs m3_inv1_lkeysec_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv1_lkeysec_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m3_inv1_lkeysec<span class="main">}</span> trans m3 <span class="main">{&gt;</span> m3_inv1_lkeysec<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv1_lkeysecI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Body<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv1_lkeysec <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m3 <span class="main">⊆</span> m3_inv1_lkeysec"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_incr<span class="main">)</span> <span class="main">(</span><span class="operator">fast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Useful simplifier lemmas›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m3_inv1_lkeysec_for_parts <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">s</span> <span class="main">∈</span> m3_inv1_lkeysec <span class="main">⟧</span> <span class="main">⟹</span> Key <span class="main">(</span>shrK <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>IK <span class="free">s</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">C</span> <span class="main">∈</span> bad"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> m3_inv1_lkeysec_for_analz <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">s</span> <span class="main">∈</span> m3_inv1_lkeysec <span class="main">⟧</span> <span class="main">⟹</span> Key <span class="main">(</span>shrK <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="free">s</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">C</span> <span class="main">∈</span> bad"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv2: Ticket shape for honestly encrypted M2›</span></span>
<span class="comment1">(*inv**************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_inv2_ticket</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_inv2_ticket</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">N</span> <span class="bound">K</span> <span class="bound">X</span><span class="main">.</span>
     <span class="bound">A</span> <span class="main">∉</span> bad <span class="main">⟶</span>
     Crypt <span class="main">(</span>shrK <span class="bound">A</span><span class="main">)</span> <span class="main">⦃</span>Nonce <span class="bound">N</span><span class="main">,</span> Agent <span class="bound">B</span><span class="main">,</span> Key <span class="bound">K</span><span class="main">,</span> <span class="bound">X</span><span class="main">⦄</span> <span class="main">∈</span> parts <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="bound">X</span> <span class="main">=</span> Crypt <span class="main">(</span>shrK <span class="bound">B</span><span class="main">)</span> <span class="main">⦃</span>Key <span class="bound">K</span><span class="main">,</span> Agent <span class="bound">A</span><span class="main">⦄</span> <span class="main">∧</span> <span class="bound">K</span> <span class="main">∈</span> range sesK
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_inv2_ticketI <span class="main">=</span>
  m3_inv2_ticket_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv2_ticketE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span>
  m3_inv2_ticket_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv2_ticketD <span class="main">=</span>
  m3_inv2_ticket_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> -1<span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv2_ticket_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m3 <span class="main">⊆</span> m3_inv2_ticket"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv2_ticketI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv2_ticket_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m3_inv2_ticket <span class="main">∩</span> m3_inv1_lkeysec<span class="main">}</span> trans m3 <span class="main">{&gt;</span> m3_inv2_ticket<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv2_ticketI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m3_inv2_ticketD<span class="main">)</span>
<span class="comment1">― ‹2 subgoals, from step4 [?]›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> Body <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"IK <span class="skolem"><span class="skolem">s</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem"><span class="skolem">s</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> parts_cut<span class="main"><span class="keyword3">,</span></span>
       <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m3_inv2_ticketD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv2_ticket <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m3 <span class="main">⊆</span> m3_inv2_ticket"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_incr<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv3: Session keys not used to encrypt other session keys›</span></span>
<span class="comment1">(*inv**************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Session keys are not used to encrypt other keys. Proof requires
generalization to sets of session keys.

NOTE: For NSSK, this invariant cannot be inherited from the corresponding
L2 invariant. The simulation relation is only an implication not an equivalence.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_inv3_sesK_compr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_inv3_sesK_compr</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">K</span> <span class="bound">KK</span><span class="main">.</span>
     <span class="bound">KK</span> <span class="main">⊆</span> range sesK <span class="main">⟶</span>
     <span class="main">(</span>Key <span class="bound">K</span> <span class="main">∈</span> analz <span class="main">(</span>Key<span class="main">`</span><span class="bound">KK</span> <span class="main">∪</span> <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">K</span> <span class="main">∈</span> <span class="bound">KK</span> <span class="main">∨</span> Key <span class="bound">K</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_inv3_sesK_comprI <span class="main">=</span> m3_inv3_sesK_compr_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv3_sesK_comprE <span class="main">=</span> m3_inv3_sesK_compr_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv3_sesK_comprD <span class="main">=</span> m3_inv3_sesK_compr_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Additional lemma›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> insert_commute_Key <span class="main">=</span> insert_commute <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Key <span class="free">K</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">K</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_inv3_sesK_compr_simps <span class="main">=</span>
  m3_inv3_sesK_comprD
  m3_inv3_sesK_comprD <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">Kab</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">Kab</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  m3_inv3_sesK_comprD <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"insert <span class="free">Kab</span> <span class="free">KK</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">Kab</span> <span class="free">KK</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  insert_commute_Key

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv3_sesK_compr_step4<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m3_inv3_sesK_compr <span class="main">∩</span> m3_inv2_ticket <span class="main">∩</span> m3_inv1_lkeysec<span class="main">}</span>
      m3_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span> <span class="free">X</span>
   <span class="main">{&gt;</span> m3_inv3_sesK_compr<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">K</span> <span class="skolem">KK</span> <span class="skolem">s</span>
    <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> m3_inv1_lkeysec"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> m3_inv3_sesK_compr"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> m3_inv2_ticket"</span></span>
      <span class="quoted"><span class="quoted">"runs <span class="skolem">s</span> <span class="free">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">Na</span> <span class="main">=</span> <span class="free">Ra</span><span class="main">$</span>na"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">KK</span> <span class="main">⊆</span> range sesK"</span></span>
      <span class="quoted"><span class="quoted">"Crypt <span class="main">(</span>shrK <span class="free">A</span><span class="main">)</span> <span class="main">⦃</span>Nonce <span class="free">Na</span><span class="main">,</span> Agent <span class="free">B</span><span class="main">,</span> Key <span class="free">Kab</span><span class="main">,</span> <span class="free">X</span><span class="main">⦄</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>Key <span class="skolem">K</span> <span class="main">∈</span> analz <span class="main">(</span>insert <span class="free">X</span> <span class="main">(</span>Key <span class="main">`</span> <span class="skolem">KK</span> <span class="main">∪</span> IK <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">(</span><span class="skolem">K</span> <span class="main">∈</span> <span class="skolem">KK</span> <span class="main">∨</span> Key <span class="skolem">K</span> <span class="main">∈</span> analz <span class="main">(</span>insert <span class="free">X</span> <span class="main">(</span>IK <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> bad"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Decrypt<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> analz <span class="main">(</span>Key <span class="main">`</span> <span class="skolem">KK</span> <span class="main">∪</span> IK <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> analz_monotonic<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> H
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m3_inv3_sesK_compr_simps analz_insert_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> H
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m3_inv3_sesK_compr_simps
                    <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv2_ticketD <span class="main"><span class="main">[</span></span><span class="operator">OF</span> analz_into_parts<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv3_sesK_comprI <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> analz_Inj_IK<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All together now.›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_m3_inv3_sesK_compr_trans_lemmas <span class="main">=</span>
  PO_m3_inv3_sesK_compr_step4

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv3_sesK_compr_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m3 <span class="main">⊆</span> m3_inv3_sesK_compr"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv3_sesK_comprI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv3_sesK_compr_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m3_inv3_sesK_compr <span class="main">∩</span> m3_inv2_ticket <span class="main">∩</span> m3_inv1_lkeysec<span class="main">}</span>
     trans m3
   <span class="main">{&gt;</span> m3_inv3_sesK_compr<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m3_def m3_trans_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_m3_inv3_sesK_compr_trans_lemmas<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m3_defs m3_inv3_sesK_compr_simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv3_sesK_comprI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv3_sesK_compr <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m3 <span class="main">⊆</span> m3_inv3_sesK_compr"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> J<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"m3_inv2_ticket <span class="main">∩</span> m3_inv1_lkeysec"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> inv_rule_incr<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Message abstraction and simulation relation›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Abstraction function on sets of messages.›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span>
  <span class="entity">abs_msg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set <span class="main">⇒</span> chmsg set"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">H</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  am_M1<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⦃</span>Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Nonce <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">⦄</span> <span class="main">∈</span> <span class="free">H</span>
  <span class="main">⟹</span> Insec <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">Na</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">abs_msg</span> <span class="free">H</span>"</span></span>
<span class="main">|</span> am_M2<span class="main">:</span>
    <span class="quoted"><span class="quoted">"Crypt <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">⦃</span>Nonce <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Key <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">⦄</span> <span class="main">∈</span> <span class="free">H</span>
  <span class="main">⟹</span> Secure Sv <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> aAgt <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> aKey <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">abs_msg</span> <span class="free">H</span>"</span></span>
<span class="main">|</span> am_M3<span class="main">:</span>
    <span class="quoted"><span class="quoted">"Crypt <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">⦃</span>Key <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⦄</span> <span class="main">∈</span> <span class="free">H</span>
  <span class="main">⟹</span> Secure Sv <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">,</span> aAgt <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">abs_msg</span> <span class="free">H</span>"</span></span>
<span class="main">|</span> am_M4<span class="main">:</span>
    <span class="quoted"><span class="quoted">"Crypt <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">(</span>Nonce <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">H</span>
  <span class="main">⟹</span> dAuth <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">abs_msg</span> <span class="free">H</span>"</span></span>
<span class="main">|</span> am_M5<span class="main">:</span>
    <span class="quoted"><span class="quoted">"Crypt <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">⦃</span>Nonce <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> Nonce <span class="free"><span class="bound"><span class="entity">N'</span></span></span><span class="main">⦄</span> <span class="main">∈</span> <span class="free">H</span>
  <span class="main">⟹</span> dAuth <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> aNon <span class="free"><span class="bound"><span class="entity">N'</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">abs_msg</span> <span class="free">H</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹R23: The simulation relation. This is a data refinement of
the insecure and secure channels of refinement 2.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R23_msgs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R23_msgs</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> abs_msg <span class="main">(</span>parts <span class="main">(</span>IK <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> chan <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R23_keys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>     <span class="comment1">― ‹only an implication!›</span>
  <span class="quoted"><span class="quoted">"<span class="free">R23_keys</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">KK</span> <span class="bound">K</span><span class="main">.</span> <span class="bound">KK</span> <span class="main">⊆</span> range sesK <span class="main">⟶</span>
     Key <span class="bound">K</span> <span class="main">∈</span> analz <span class="main">(</span>Key<span class="main">`</span><span class="bound">KK</span> <span class="main">∪</span> IK <span class="bound">t</span><span class="main">)</span> <span class="main">⟶</span> aKey <span class="bound">K</span> <span class="main">∈</span> extr <span class="main">(</span>aKey<span class="main">`</span><span class="bound">KK</span> <span class="main">∪</span> ik0<span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R23_non</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>      <span class="comment1">― ‹only an implication!›</span>
  <span class="quoted"><span class="quoted">"<span class="free">R23_non</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">KK</span> <span class="bound">N</span><span class="main">.</span> <span class="bound">KK</span> <span class="main">⊆</span> range sesK <span class="main">⟶</span>
     Nonce <span class="bound">N</span> <span class="main">∈</span> analz <span class="main">(</span>Key<span class="main">`</span><span class="bound">KK</span> <span class="main">∪</span> IK <span class="bound">t</span><span class="main">)</span> <span class="main">⟶</span> aNon <span class="bound">N</span> <span class="main">∈</span> extr <span class="main">(</span>aKey<span class="main">`</span><span class="bound">KK</span> <span class="main">∪</span> ik0<span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R23_pres</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R23_pres</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> runs <span class="bound">s</span> <span class="main">=</span> runs <span class="bound">t</span> <span class="main">∧</span> leak <span class="bound">s</span> <span class="main">=</span> leak <span class="bound">t</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R23</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R23</span> <span class="main">≡</span> R23_msgs <span class="main">∩</span> R23_keys <span class="main">∩</span> R23_non <span class="main">∩</span> R23_pres"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_defs <span class="main">=</span>
  R23_def R23_msgs_def R23_keys_def R23_non_def R23_pres_def


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The mediator function is the identity here.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">med32</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_obs <span class="main">⇒</span> m2_obs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med32</span> <span class="main">≡</span> id"</span></span>


<span class="keyword1"><span class="command">lemmas</span></span> R23_msgsI <span class="main">=</span> R23_msgs_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_intro<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_msgsE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> R23_msgs_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_elim<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_msgsE' <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span>
  R23_msgs_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_dest<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">THEN</span> subsetD<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_keysI <span class="main">=</span> R23_keys_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_intro<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_keysE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> R23_keys_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_elim<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_keysD <span class="main">=</span> R23_keys_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_dest<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 2<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_nonI <span class="main">=</span> R23_non_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_intro<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_nonE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> R23_non_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_elim<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_nonD <span class="main">=</span> R23_non_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_dest<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 2<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_presI <span class="main">=</span> R23_pres_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_intro<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_presE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> R23_pres_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_elim<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_intros <span class="main">=</span> R23_msgsI R23_keysI R23_nonI R23_presI


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Further lemmas: general lemma for simplifier and different instantiations.›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_keys_dests <span class="main">=</span>
  R23_keysD
  R23_keysD <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  R23_keysD <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">K</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">K</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  R23_keysD <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"insert <span class="free">K</span> <span class="free">KK</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">K</span> <span class="free">KK</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> _ _ conjI<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_non_dests <span class="main">=</span>
  R23_nonD
  R23_nonD <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  R23_nonD <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">K</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">K</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  R23_nonD <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"insert <span class="free">K</span> <span class="free">KK</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">K</span> <span class="free">KK</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> _ _ conjI<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_dests <span class="main">=</span> R23_keys_dests R23_non_dests

<span class="comment1">(* lemmas insert_commute_Key = insert_commute [where x="Key K" for K]  *)</span>
<span class="comment1">(*
lemmas R23_keys_emptyD =
  R23_keysD [where KK="{}", simplified, THEN iffD1, rotated 1]
  R23_keysD [where KK="{}", simplified, THEN iffD2, rotated 1]
*)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹General lemmas›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹General facts about <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"abs_msg"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">declare</span></span> abs_msg.intros <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span></span></span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> abs_msg.cases <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main">!</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"abs_msg <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_Un <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"abs_msg <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> abs_msg <span class="free">G</span> <span class="main">∪</span> abs_msg <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_mono <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">m</span> <span class="main">∈</span> abs_msg <span class="free">G</span><span class="main">;</span> <span class="free">G</span> <span class="main">⊆</span> <span class="free">H</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">∈</span> abs_msg <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_insert_mono <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">m</span> <span class="main">∈</span> abs_msg <span class="free">H</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">∈</span> abs_msg <span class="main">(</span>insert <span class="free">m'</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Facts about <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"abs_msg"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> concerning abstraction of fakeable
messages. This is crucial for proving the refinement of the intruder event.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_DY_subset_fakeable<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> R23_msgs<span class="main">;</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> R23_keys<span class="main">;</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> R23_non<span class="main">;</span> <span class="free">t</span> <span class="main">∈</span> m3_inv1_lkeysec <span class="main">⟧</span>
  <span class="main">⟹</span> abs_msg <span class="main">(</span>synth <span class="main">(</span>analz <span class="main">(</span>IK <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> fake ik0 <span class="main">(</span>dom <span class="main">(</span>runs <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="comment1">― ‹9 subgoals, deal with replays first›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 3 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 4 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 5 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
<span class="comment1">― ‹remaining 5 subgoals are real fakes›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> fake_StatCh fake_DynCh<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> R23_dests<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement proof›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Pair decomposition. These were set to \texttt{elim!}, which is too
agressive here.›</span></span>

<span class="keyword1"><span class="command">declare</span></span> MPair_analz <span class="main">[</span><span class="operator">rule</span> <span class="quasi_keyword">del</span><span class="main">,</span> <span class="operator">elim</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> MPair_parts <span class="main">[</span><span class="operator">rule</span> <span class="quasi_keyword">del</span><span class="main">,</span> <span class="operator">elim</span><span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Protocol events.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step1_refines_m2_step1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
     <span class="main">(</span>m2_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m2_defs m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step2_refines_m2_step2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
     <span class="main">(</span>m2_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m2_defs m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step3_refines_m2_step3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23 <span class="main">∩</span> <span class="main">(</span>m2_inv3a_sesK_compr<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>m3_inv3_sesK_compr <span class="main">∩</span> m3_inv1_lkeysec<span class="main">)</span><span class="main">}</span>
     <span class="main">(</span>m2_step3 <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step3 <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R23_msgs"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R23_keys"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R23_non"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R23_pres"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> m2_inv3a_sesK_compr"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> m3_inv3_sesK_compr"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> m3_inv1_lkeysec"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">Kab</span> <span class="main">=</span> sesK <span class="main">(</span><span class="free">Rs</span><span class="main">$</span>sk<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Rs</span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">⦃</span> Agent <span class="free">A</span><span class="main">,</span> Agent <span class="free">B</span><span class="main">,</span> Nonce <span class="free">Na</span> <span class="main">⦄</span> <span class="main">∈</span> parts <span class="main">(</span>IK <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span><span class="main">=</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">⦇</span> runs <span class="main">:=</span> runs <span class="skolem">s</span><span class="main">(</span><span class="free">Rs</span> <span class="main">↦</span> <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="free">Na</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
          chan <span class="main">:=</span> insert <span class="main">(</span>Secure Sv <span class="free">A</span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="free">Na</span><span class="main">,</span> aAgt <span class="free">B</span><span class="main">,</span> aKey <span class="free">Kab</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
                 <span class="main">(</span>insert <span class="main">(</span>Secure Sv <span class="free">B</span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">,</span> aAgt <span class="free">A</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chan <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t'</span></span></span><span class="main">=</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">⦇</span> runs <span class="main">:=</span> runs <span class="skolem">t</span><span class="main">(</span><span class="free">Rs</span> <span class="main">↦</span> <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNon <span class="free">Na</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
          IK <span class="main">:=</span> insert
                  <span class="main">(</span>Crypt <span class="main">(</span>shrK <span class="free">A</span><span class="main">)</span>
                    <span class="main">⦃</span>Nonce <span class="free">Na</span><span class="main">,</span> Agent <span class="free">B</span><span class="main">,</span> Key <span class="free">Kab</span><span class="main">,</span>
                       Crypt <span class="main">(</span>shrK <span class="free">B</span><span class="main">)</span> <span class="main">⦃</span>Key <span class="free">Kab</span><span class="main">,</span> Agent <span class="free">A</span><span class="main">⦄</span><span class="main">⦄</span><span class="main">)</span>
                  <span class="main">(</span>IK <span class="skolem">t</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s'</span><span class="main">,</span> <span class="var">?t'</span><span class="main">)</span> <span class="main">∈</span> R23_msgs"</span></span> <span class="keyword1"><span class="command">using</span></span> H
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> R23_intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s'</span><span class="main">,</span> <span class="var">?t'</span><span class="main">)</span> <span class="main">∈</span> R23_keys"</span></span> <span class="keyword1"><span class="command">using</span></span> H
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> R23_intros<span class="main"><span class="keyword3">,</span></span>
            <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_inv3a_sesK_compr_simps m3_inv3_sesK_compr_simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> R23_keys_dests<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s'</span><span class="main">,</span> <span class="var">?t'</span><span class="main">)</span> <span class="main">∈</span> R23_non"</span></span> <span class="keyword1"><span class="command">using</span></span> H
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> R23_intros<span class="main"><span class="keyword3">,</span></span>
            <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_inv3a_sesK_compr_simps m3_inv3_sesK_compr_simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> R23_non_dests<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s'</span><span class="main">,</span> <span class="var">?t'</span><span class="main">)</span> <span class="main">∈</span> R23_pres"</span></span> <span class="keyword1"><span class="command">using</span></span> H
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> R23_intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">note</span></span> calculation
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m2_defs m3_defs<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*  with equality in R23_keys [OLD, before adding session key compromise]:

goal (1 subgoal):
 1. ⋀s t. ⟦t ∈ m3_inv3_keyuse; t ∈ m3_inv1_lkeysec; t ∈ m3_inv5_badkeys;
           Kab ∉ dom (runs t); Kab ∈ range sesK;
           ⦃Agent A, Agent B, Nonce Na⦄ ∈ parts (IK t);
           Kab ∉ keysFor (analz (IK t)); Key (shrK A) ∉ analz (IK t);
           (s, t) ∈ R23_msgs; (s, t) ∈ R23_keys; (s, t) ∈ R23_pres; Kab ≠ shrK A;
           Key (shrK B) ∈ analz (IK t); Kab ≠ shrK B; A ∉ bad; B ∈ bad⟧
          ⟹ Key Kab ∈ analz (IK t)

This does NOT hold, since Kab is revealed in abstract model when A ∉ bad; B ∈ bad,
but not in concrete one, since here it is protected by A's encryption.
*)</span>


<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step4_refines_m2_step4<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23 <span class="main">∩</span> <span class="main">(</span>m2_inv3b_sesK_compr_non<span class="main">)</span>
        <span class="main">×</span> <span class="main">(</span>m3_inv3_sesK_compr <span class="main">∩</span> m3_inv2_ticket <span class="main">∩</span> m3_inv1_lkeysec<span class="main">)</span><span class="main">}</span>
     <span class="main">(</span>m2_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Kab</span> <span class="free">X</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R23_msgs"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R23_keys"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R23_non"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R23_pres"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> m2_inv3b_sesK_compr_non"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> m3_inv3_sesK_compr"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> m3_inv2_ticket"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> m3_inv1_lkeysec"</span></span>
      <span class="quoted"><span class="quoted">"runs <span class="skolem">t</span> <span class="free">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">Na</span> <span class="main">=</span> <span class="free">Ra</span><span class="main">$</span>na"</span></span>
      <span class="quoted"><span class="quoted">"Crypt <span class="main">(</span>shrK <span class="free">A</span><span class="main">)</span> <span class="main">⦃</span>Nonce <span class="free">Na</span><span class="main">,</span> Agent <span class="free">B</span><span class="main">,</span> Key <span class="free">Kab</span><span class="main">,</span> <span class="free">X</span><span class="main">⦄</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">⦇</span> runs <span class="main">:=</span> runs <span class="skolem">s</span><span class="main">(</span><span class="free">Ra</span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?t'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">⦇</span> runs <span class="main">:=</span> runs <span class="skolem">t</span><span class="main">(</span><span class="free">Ra</span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
                  IK <span class="main">:=</span> insert <span class="free">X</span> <span class="main">(</span>IK <span class="skolem">t</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> H
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Secure Sv <span class="free">A</span> <span class="main">(</span>Msg <span class="main">[</span>aNon <span class="free">Na</span><span class="main">,</span> aAgt <span class="free">B</span><span class="main">,</span> aKey <span class="free">Kab</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> parts <span class="main">(</span>IK <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Body MPair_parts<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s'</span><span class="main">,</span> <span class="var">?t'</span><span class="main">)</span> <span class="main">∈</span> R23_msgs"</span></span> <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s'</span><span class="main">,</span> <span class="var">?t'</span><span class="main">)</span> <span class="main">∈</span> R23_keys"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> bad"</span></span>
      <span class="keyword1"><span class="command">with</span></span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">drule</span> Decrypt<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> H <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> R23_intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> analz_cut  <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> analz_monotonic<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∉</span> bad"</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">note</span></span> H
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">∉</span> bad›</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> Crypt <span class="main">(</span>shrK <span class="free">B</span><span class="main">)</span> <span class="main">⦃</span>Key <span class="free">Kab</span><span class="main">,</span> Agent <span class="free">A</span><span class="main">⦄</span> <span class="main">∧</span> <span class="free">Kab</span> <span class="main">∈</span> range sesK"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv2_ticketD<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> H1<span class="main">:</span> <span class="quoted"><span class="quoted">"Key <span class="main">(</span>shrK <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="skolem">t</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"aKey <span class="free">Kab</span> <span class="main">∈</span> extr ik0 <span class="main">(</span>chan <span class="skolem">s</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">note</span></span> calculation
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"Secure Sv <span class="free">B</span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">,</span> aAgt <span class="free">A</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="skolem">s</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">drule</span> analz_into_parts<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> Body<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> MPair_parts<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
            <span class="keyword1"><span class="command">ultimately</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> H1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> R23_intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m3_inv3_sesK_compr_simps<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s'</span><span class="main">,</span> <span class="var">?t'</span><span class="main">)</span> <span class="main">∈</span> R23_non"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> bad"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">drule</span> Decrypt<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> H
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> R23_intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> analz_cut <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> analz_monotonic<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∉</span> bad"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> Crypt <span class="main">(</span>shrK <span class="free">B</span><span class="main">)</span> <span class="main">⦃</span>Key <span class="free">Kab</span><span class="main">,</span> Agent <span class="free">A</span> <span class="main">⦄</span> <span class="main">∧</span> <span class="free">Kab</span> <span class="main">∈</span> range sesK"</span></span> <span class="keyword1"><span class="command">using</span></span> H
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv2_ticketD<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> H
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> R23_intros<span class="main"><span class="keyword3">,</span></span>
                <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_inv3b_sesK_compr_non_simps m3_inv3_sesK_compr_simps
                     <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> R23_non_dests<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s'</span><span class="main">,</span> <span class="var">?t'</span><span class="main">)</span> <span class="main">∈</span> R23_pres"</span></span> <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">note</span></span> calculation
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m2_defs m3_defs <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> analz_Inj_IK<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step5_refines_m2_step5<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
     <span class="main">(</span>m2_step5 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Nb</span> <span class="free">Kab</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step5 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Nb</span> <span class="free">Kab</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m2_defs m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step6_refines_m2_step6<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
     <span class="main">(</span>m2_step6 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Nb</span> <span class="free">Kab</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step6 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Na</span> <span class="free">Nb</span> <span class="free">Kab</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m2_defs m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step7_refines_m2_step7<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
     <span class="main">(</span>m2_step7 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Nb</span> <span class="free">Kab</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step7 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Nb</span> <span class="free">Kab</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m2_defs m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Intruder events.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_leak_refines_m2_leak<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
     m2_leak <span class="free">Rs</span> <span class="free">Ra</span> <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">,</span> m3_leak <span class="free">Rs</span> <span class="free">Ra</span> <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m2_defs m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> R23_dests<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_DY_fake_refines_m2_fake<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23 <span class="main">∩</span> UNIV <span class="main">×</span> m3_inv1_lkeysec<span class="main">}</span>
     m2_fake<span class="main">,</span> m3_DY_fake
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m2_defs m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros
            <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> abs_msg.cases<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> abs_msg_DY_subset_fakeable <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span>
            <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> abs_msg.cases<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> R23_dests<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All together now...›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_m3_trans_refines_m2_trans <span class="main">=</span>
  PO_m3_step1_refines_m2_step1 PO_m3_step2_refines_m2_step2
  PO_m3_step3_refines_m2_step3 PO_m3_step4_refines_m2_step4
  PO_m3_step5_refines_m2_step5 PO_m3_step6_refines_m2_step6
  PO_m3_step7_refines_m2_step7 PO_m3_leak_refines_m2_leak
  PO_m3_DY_fake_refines_m2_fake


<span class="keyword1"><span class="command">lemma</span></span> PO_m3_refines_init_m2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m3 <span class="main">⊆</span> R23<span class="main">``</span><span class="main">(</span>init m2<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23_def m2_defs m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_refines_trans_m2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23 <span class="main">∩</span> <span class="main">(</span>m2_inv3a_sesK_compr <span class="main">∩</span> m2_inv3b_sesK_compr_non<span class="main">)</span>
        <span class="main">×</span> <span class="main">(</span>m3_inv3_sesK_compr <span class="main">∩</span> m3_inv2_ticket <span class="main">∩</span> m3_inv1_lkeysec<span class="main">)</span><span class="main">}</span>
     <span class="main">(</span>trans m2<span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans m3<span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m3_def m3_trans_def m2_def m2_trans_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_m3_trans_refines_m2_trans<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_observation_consistent <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"obs_consistent R23 med32 m2 m3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R23_def med32_def m2_defs m3_defs<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement result.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m3_refines_m2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"refines
     <span class="main">(</span>R23 <span class="main">∩</span> <span class="main">(</span>m2_inv3a_sesK_compr <span class="main">∩</span> m2_inv3b_sesK_compr_non<span class="main">)</span>
          <span class="main">×</span> <span class="main">(</span>m3_inv3_sesK_compr <span class="main">∩</span> m3_inv2_ticket <span class="main">∩</span> m3_inv1_lkeysec<span class="main">)</span><span class="main">)</span>
     med32 m2 m3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Refinement_using_invariants<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> m3_implements_m2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"implements med32 m2 m3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refinement_soundness<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Inherited invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv4 (derived): Key secrecy for initiator›</span></span>
<span class="comment1">(*invh*************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_inv4_ikk_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_inv4_ikk_init</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Ra</span> <span class="bound">K</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">al</span><span class="main">.</span>
     runs <span class="bound">s</span> <span class="bound">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> aKey <span class="bound">K</span> <span class="main">#</span> <span class="bound">al</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">A</span> <span class="main">∈</span> good <span class="main">⟶</span> <span class="bound">B</span> <span class="main">∈</span> good <span class="main">⟶</span>
     Key <span class="bound">K</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound">Nb'</span><span class="main">.</span> <span class="main">(</span><span class="bound">K</span><span class="main">,</span> <span class="bound">Ra</span> <span class="main">$</span> na<span class="main">,</span> <span class="bound">Nb'</span><span class="main">)</span> <span class="main">∈</span> leak <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_inv4_ikk_initI <span class="main">=</span> m3_inv4_ikk_init_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv4_ikk_initE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m3_inv4_ikk_init_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv4_ikk_initD <span class="main">=</span> m3_inv4_ikk_init_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv4_ikk_init<span class="main">:</span> <span class="quoted"><span class="quoted">"reach m3 <span class="main">⊆</span> m3_inv4_ikk_init"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> INV_from_Refinement_using_invariants <span class="main"><span class="main">[</span></span><span class="operator">OF</span> m3_refines_m2<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Range <span class="main">(</span>R23 <span class="main">∩</span> <span class="main">(</span>m2_inv3a_sesK_compr <span class="main">∩</span> m2_inv3b_sesK_compr_non<span class="main">)</span>
                   <span class="main">×</span> <span class="main">(</span>m3_inv3_sesK_compr <span class="main">∩</span> m3_inv2_ticket <span class="main">∩</span> m3_inv1_lkeysec<span class="main">)</span>
                   <span class="main">∩</span> m2_inv6_ikk_init <span class="main">×</span> UNIV<span class="main">)</span>
      <span class="main">⊆</span> m3_inv4_ikk_init"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23_def R23_pres_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv4_ikk_initI<span class="main">)</span>
       <span class="main">(</span><span class="operator">elim</span> m2_inv6_ikk_initE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> R23_keys_dests<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv5 (derived): Key secrecy for responder›</span></span>
<span class="comment1">(*invh*************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_inv5_ikk_resp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_inv5_ikk_resp</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Rb</span> <span class="bound">K</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">al</span><span class="main">.</span>
     runs <span class="bound">s</span> <span class="bound">Rb</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> aKey <span class="bound">K</span> <span class="main">#</span> <span class="bound">al</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">A</span> <span class="main">∈</span> good <span class="main">⟶</span> <span class="bound">B</span> <span class="main">∈</span> good <span class="main">⟶</span>
     Key <span class="bound">K</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="bound">K</span> <span class="main">∈</span> Domain <span class="main">(</span>leak <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_inv5_ikk_respI <span class="main">=</span> m3_inv5_ikk_resp_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv5_ikk_respE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m3_inv5_ikk_resp_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv5_ikk_respD <span class="main">=</span> m3_inv5_ikk_resp_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv4_ikk_resp<span class="main">:</span> <span class="quoted"><span class="quoted">"reach m3 <span class="main">⊆</span> m3_inv5_ikk_resp"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> INV_from_Refinement_using_invariants <span class="main"><span class="main">[</span></span><span class="operator">OF</span> m3_refines_m2<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Range <span class="main">(</span>R23 <span class="main">∩</span> <span class="main">(</span>m2_inv3a_sesK_compr <span class="main">∩</span> m2_inv3b_sesK_compr_non<span class="main">)</span>
                   <span class="main">×</span> <span class="main">(</span>m3_inv3_sesK_compr <span class="main">∩</span> m3_inv2_ticket <span class="main">∩</span> m3_inv1_lkeysec<span class="main">)</span>
                   <span class="main">∩</span> m2_inv7_ikk_resp <span class="main">×</span> UNIV<span class="main">)</span>
      <span class="main">⊆</span> m3_inv5_ikk_resp"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23_def R23_pres_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv5_ikk_respI<span class="main">)</span>
       <span class="main">(</span><span class="operator">elim</span> m2_inv7_ikk_respE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> R23_keys_dests<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>


<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="m1_ds">
<div class="head">
<h1>Theory m1_ds</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Development of Security Protocols by Refinement

  Module:   Key_establish/m1_ds.thy (Isabelle/HOL 2016-1)
  ID:       $Id: m1_ds.thy 133856 2017-03-20 18:05:54Z csprenge $
  Author:   Ivano Somaini, ETH Zurich &lt;somainii@student.ethz.ch&gt;
            Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;

  Key distribution protocols
  abstract version of Denning-Sacco with non-injective server authentication 
  using timestamps

  Copyright (c) 2009-2016 Ivano Somaini, Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Abstract Denning-Sacco protocol (L1)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> m1_ds <span class="keyword2"><span class="keyword">imports</span></span> <a href="m1_keydist_inrn.html">m1_keydist_inrn</a> <span class="quoted">"<a href="a0n_agree.html">../Refinement/a0n_agree</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We augment the basic abstract key distribution model such that 
the server sends a timestamp along with the session key. We check the 
timestamp's validity to ensure recentness of the session key. 

We establish one refinement for this model, namely that this model refines
the basic authenticated key transport model <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>m1_keydist_inrn›</span></span></span></span>, 
which guarantees non-injective agreement with the server on the session key
and the server-generated timestamp.
›</span></span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹State›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We extend the basic key distribution by adding timestamps. 
We add a clock variable modeling the current time.  The frames, runs, and 
observations remain the same as in the previous model, but we will use 
the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"nat list"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>'s to store timestamps. 
›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  time <span class="main">=</span> <span class="quoted"><span class="quoted">"nat"</span></span>                     <span class="comment1">― ‹for clock and timestamps›</span>

<span class="keyword1"><span class="command">consts</span></span>
  Ls <span class="main">::</span> <span class="quoted"><span class="quoted">"time"</span></span>                     <span class="comment1">― ‹life time for session keys›</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹State and observations›</span></span>

<span class="keyword1"><span class="command">record</span></span>
  m1_state <span class="main">=</span> <span class="quoted"><span class="quoted">"m1x_state"</span></span> <span class="main">+</span>
    clk <span class="main">::</span> <span class="quoted"><span class="quoted">"time"</span></span> 

<span class="keyword1"><span class="command">type_synonym</span></span>
  m1_obs <span class="main">=</span> <span class="quoted"><span class="quoted">"m1_state"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  <span class="tfree">'x</span> m1_pred <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> m1_state_scheme set"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  <span class="tfree">'x</span> m1_trans <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'x</span> m1_state_scheme <span class="main">×</span> <span class="tfree">'x</span> m1_state_scheme<span class="main">)</span> set"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Instantiate parameters regarding list of freshness identifiers stored
at server.›</span></span>

<span class="keyword1"><span class="command">overloading</span></span> is_len' <span class="main">≡</span> <span class="quoted"><span class="quoted">"is_len"</span></span> rs_len' <span class="main">≡</span> <span class="quoted"><span class="quoted">"rs_len"</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> is_len_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">is_len'</span> <span class="main">≡</span> <span class="main">1</span><span class="main">::</span>nat"</span></span>
<span class="keyword1"><span class="command">definition</span></span> rs_len_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rs_len'</span> <span class="main">≡</span> <span class="main">1</span><span class="main">::</span>nat"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Events›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>         <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">A</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m1x_step1"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1_step1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'x</span> m1_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_step1</span> <span class="main">≡</span> m1a_step1"</span></span>

<span class="keyword1"><span class="command">definition</span></span>       <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">B</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m1x_step2"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1_step2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'x</span> m1_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_step2</span> <span class="main">≡</span> m1a_step2"</span></span>

<span class="keyword1"><span class="command">definition</span></span>       <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"Server"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m1x_step3</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1_step3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> key<span class="main">,</span> time<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'x</span> m1_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_step3</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
     <span class="comment1">― ‹new guards:›</span>
     <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">=</span> clk <span class="bound">s</span> <span class="main">∧</span>                      <span class="comment1">― ‹fresh timestamp›</span>

     <span class="comment1">― ‹rest as before:›</span>
     <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> m1a_step3 <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">[</span>aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">]</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>         <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"A"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m1x_step5</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1_step4</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> key<span class="main">,</span> time<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'x</span> m1_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_step4</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
     <span class="comment1">― ‹new guards:›</span>
     clk <span class="bound">s</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">+</span> Ls <span class="main">∧</span>                <span class="comment1">― ‹ensure session key recentness›</span>

     <span class="comment1">― ‹rest as before›</span>
     <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> m1a_step4 <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">[</span>aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">]</span> 
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>         <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">B</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m1x_step4</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1_step5</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> key<span class="main">,</span> time<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'x</span> m1_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_step5</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span> 
     <span class="comment1">― ‹new guards:›</span>
     <span class="comment1">― ‹ensure freshness of session key›</span>
     clk <span class="bound">s</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">+</span> Ls <span class="main">∧</span>

     <span class="comment1">― ‹rest as before›</span>
     <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> m1a_step5 <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">[</span>aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">]</span> 
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">skip</span></span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1_tick</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"time <span class="main">⇒</span> <span class="tfree">'x</span> m1_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_tick</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
     <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> clk <span class="main">:=</span> clk <span class="bound">s</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">⦈</span> 
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>         <span class="comment1">― ‹by attacker, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m1x_leak</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m1_leak</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'x</span> m1_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_leak</span> <span class="main">≡</span> m1a_leak"</span></span>



<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Specification›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m1_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"unit m1_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_init</span> <span class="main">≡</span> <span class="main">{</span> <span class="main">⦇</span> runs <span class="main">=</span> Map.empty<span class="main">,</span> leak <span class="main">=</span> corrKey<span class="main">,</span> clk <span class="main">=</span> <span class="main">0</span> <span class="main">⦈</span> <span class="main">}</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m1_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> m1_trans"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_trans</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Ra</span> <span class="bound">Rb</span> <span class="bound">Rs</span> <span class="bound">Kab</span> <span class="bound">Ts</span> <span class="bound">T</span><span class="main">.</span>
        m1_step1 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">∪</span>
        m1_step2 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">∪</span>
        m1_step3 <span class="bound">Rs</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Kab</span> <span class="bound">Ts</span> <span class="main">∪</span>
        m1_step4 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Kab</span> <span class="bound">Ts</span> <span class="main">∪</span>
        m1_step5 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Kab</span> <span class="bound">Ts</span> <span class="main">∪</span>
        m1_tick <span class="bound">T</span> <span class="main">∪</span>
        m1_leak <span class="bound">Rs</span> <span class="main">∪</span>
        Id
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m1_state<span class="main">,</span> m1_obs<span class="main">)</span> spec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="main">≡</span> <span class="main">⦇</span>
      init <span class="main">=</span> m1_init<span class="main">,</span>
      trans <span class="main">=</span> m1_trans<span class="main">,</span>
      obs <span class="main">=</span> id
  <span class="main">⦈</span>"</span></span> 

<span class="keyword1"><span class="command">lemmas</span></span> m1_loc_defs <span class="main">=</span> 
  m1_def m1_init_def m1_trans_def
  m1_step1_def m1_step2_def m1_step3_def m1_step4_def m1_step5_def 
  m1_leak_def m1_tick_def

<span class="keyword1"><span class="command">lemmas</span></span> m1_defs <span class="main">=</span> m1_loc_defs m1a_defs

<span class="keyword1"><span class="command">lemma</span></span> m1_obs_id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"obs m1 <span class="main">=</span> id"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1_def<span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv0: Finite domain›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹There are only finitely many runs. This is needed to establish
the responder/initiator agreement.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m1_inv0_fin</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> m1_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m1_inv0_fin</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> finite <span class="main">(</span>dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m1_inv0_finI <span class="main">=</span> m1_inv0_fin_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m1_inv0_finE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m1_inv0_fin_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m1_inv0_finD <span class="main">=</span> m1_inv0_fin_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proofs.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_inv0_fin_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m1 <span class="main">⊆</span> m1_inv0_fin"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m1_inv0_finI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_inv0_fin_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m1_inv0_fin<span class="main">}</span> trans m1 <span class="main">{&gt;</span> m1_inv0_fin<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m1_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m1_inv0_finI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_inv0_fin <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m1 <span class="main">⊆</span> m1_inv0_fin"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_incr<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>m1a›</span></span></span></span>›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Simulation relation›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹R1a1: The simulation relation and mediator function are identities.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">med1a1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m1_obs <span class="main">⇒</span> m1a_obs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med1a1</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> runs <span class="main">=</span> runs <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> leak <span class="main">=</span> leak <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⦈</span>"</span></span>
   
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R1a1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m1a_state <span class="main">×</span> m1_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R1a1</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> med1a1 <span class="bound">t</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> R1a1_defs <span class="main">=</span> R1a1_def med1a1_def 


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement proof›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step1_refines_m1a_step1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R1a1<span class="main">}</span> 
     <span class="main">(</span>m1a_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R1a1<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R1a1_defs m1_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step2_refines_m1a_step2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R1a1<span class="main">}</span> 
     <span class="main">(</span>m1a_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R1a1<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R1a1_defs m1_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step3_refines_m1a_step3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R1a1<span class="main">}</span> 
     <span class="main">(</span>m1a_step3 <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="main">[</span>aNum <span class="free">Ts</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1_step3 <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span><span class="main">)</span>
   <span class="main">{&gt;</span> R1a1<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R1a1_defs m1_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step4_refines_m1a_step4<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R1a1<span class="main">}</span> 
     <span class="main">(</span>m1a_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="main">[</span>aNum <span class="free">Ts</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R1a1<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R1a1_defs m1_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_step5_refines_m1a_step5<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R1a1<span class="main">}</span> 
     <span class="main">(</span>m1a_step5 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="main">[</span>aNum <span class="free">Ts</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1_step5 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R1a1<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R1a1_defs m1_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_leak_refines_m1a_leak<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R1a1<span class="main">}</span> 
     <span class="main">(</span>m1a_leak <span class="free">Rs</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m1_leak <span class="free">Rs</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R1a1<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R1a1_defs m1_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_tick_refines_m1a_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R1a1<span class="main">}</span> 
     Id<span class="main">,</span> <span class="main">(</span>m1_tick <span class="free">T</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R1a1<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R1a1_defs m1_defs<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All together now...›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_m1_trans_refines_m1a_trans <span class="main">=</span> 
  PO_m1_step1_refines_m1a_step1 PO_m1_step2_refines_m1a_step2
  PO_m1_step3_refines_m1a_step3 PO_m1_step4_refines_m1a_step4
  PO_m1_step5_refines_m1a_step5 PO_m1_leak_refines_m1a_leak 
  PO_m1_tick_refines_m1a_skip 

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_refines_init_m1a <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m1 <span class="main">⊆</span>  R1a1<span class="main">``</span><span class="main">(</span>init m1a<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R1a1_defs m1_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> s0g_secrecyI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_refines_trans_m1a <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R1a1<span class="main">}</span> 
     <span class="main">(</span>trans m1a<span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans m1<span class="main">)</span> 
   <span class="main">{&gt;</span> R1a1<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m1_def m1_trans_def m1a_def m1a_trans_def
         <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_m1_trans_refines_m1a_trans<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_m1_trans_refines_m1a_trans<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Observation consistency.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> obs_consistent_med1a1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"obs_consistent R1a1 med1a1 m1a m1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R1a1_def m1a_def m1_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement result.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m1_refines_m1a <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"refines R1a1 med1a1 m1a m1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Refinement_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>  m1_implements_m1<span class="main">:</span> <span class="quoted"><span class="quoted">"implements med1a1 m1a m1"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refinement_soundness<span class="main">)</span> <span class="main">(</span><span class="operator">fast</span><span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="m2_ds">
<div class="head">
<h1>Theory m2_ds</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Development of Security Protocols by Refinement

  Module:  Key_establish/m2_ds.thy (Isabelle/HOL 2016-1)
  ID:      $Id: m2_ds.thy 132890 2016-12-24 10:25:57Z csprenge $
  Author:  Ivano Somaini, ETH Zurich &lt;somainii@student.ethz.ch&gt;
           Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;

  Key distribution protocols
  Level 2: channel protocol, parallel version of Denning-Sacco

  Copyright (c) 2009-2016 Ivano Somaini and Christoph Sprenger
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Abstract Denning-Sacco protocol (L2)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> m2_ds <span class="keyword2"><span class="keyword">imports</span></span> <a href="m1_ds.html">m1_ds</a> <span class="quoted">"<a href="Channels.html">../Refinement/Channels</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
We model an abstract version of the Denning-Sacco protocol:
\[
\begin{array}{lll}
  \mathrm{M1.} &amp; A \rightarrow S: &amp; A, B \\ 
  \mathrm{M2.} &amp; S \rightarrow A: &amp; \{B, Kab, T,\{Kab, A, T\}_{Kbs} \}_{Kas} \\
  \mathrm{M3.} &amp; A \rightarrow B: &amp; \{Kab, A, T\}_{Kbs} \\
\end{array}
\]

This refinement introduces channels with security properties.  We model 
a parallel version of the DS protocol:
\[
\begin{array}{lll}
  \mathrm{M1.} &amp; A \rightarrow S: &amp; A, B \\ 
  \mathrm{M2a.} &amp; S \rightarrow A: &amp; \{B, Kab, T\}_{Kas} \\
  \mathrm{M2b.} &amp; S \rightarrow B: &amp; \{Kab, A, T\}_{Kbs} \\
\end{array}
\]
Message 1 is sent over an insecure channel, the other two message over
secure channels.
›</span></span>

<span class="keyword1"><span class="command">declare</span></span> domIff <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">iff</span> <span class="quasi_keyword">del</span><span class="main">]</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹State›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹State and observations›</span></span>

<span class="keyword1"><span class="command">record</span></span> m2_state <span class="main">=</span> <span class="quoted"><span class="quoted">"m1_state"</span></span> <span class="main">+</span>
  chan <span class="main">::</span> <span class="quoted"><span class="quoted">"chmsg set"</span></span>              <span class="comment1">― ‹channel messages›</span>

<span class="keyword1"><span class="command">type_synonym</span></span> 
  m2_obs <span class="main">=</span> <span class="quoted"><span class="quoted">"m1_state"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_obs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_state <span class="main">⇒</span> m2_obs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_obs</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> 
     runs <span class="main">=</span> runs <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span>
     leak <span class="main">=</span> leak <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span>
     clk <span class="main">=</span> clk <span class="free"><span class="bound"><span class="entity">s</span></span></span>
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  m2_pred <span class="main">=</span> <span class="quoted"><span class="quoted">"m2_state set"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  m2_trans <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m2_state<span class="main">)</span> set"</span></span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Events›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Protocol events.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">A</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m1a_step1"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m2_step1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">]</span> <span class="main">⇒</span> m2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_step1</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>

     <span class="comment1">― ‹guards:›</span>
     <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>                                <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Ra›</span></span> is fresh›</span>

     <span class="comment1">― ‹actions:›</span>
     <span class="comment1">― ‹create initiator thread and send message 1›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
       runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
       chan <span class="main">:=</span> insert <span class="main">(</span>Insec <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Msg <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span>     <span class="comment1">― ‹send M1›</span>
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">B</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">m1e_step2</span>"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m2_step2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">]</span> <span class="main">⇒</span> m2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_step2</span> <span class="main">≡</span> m1_step2"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"Server"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">m1e_step3</span></span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m2_step3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> key<span class="main">,</span> time<span class="main">]</span> <span class="main">⇒</span> m2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_step3</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span> 

     <span class="comment1">― ‹guards:›</span>
     <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>                           <span class="comment1">― ‹fresh server run›</span>
     <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">=</span> sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span>                          <span class="comment1">― ‹fresh session key›</span>
     <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">=</span> clk <span class="bound">s</span> <span class="main">∧</span>                                  <span class="comment1">― ‹fresh timestamp›</span> 

     Insec <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Msg <span class="main">[]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">∧</span>                 <span class="comment1">― ‹recv M1›</span>
   
     <span class="comment1">― ‹actions:›</span>
     <span class="comment1">― ‹record key and send messages 2 and 3›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
       runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">↦</span> <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> 
       chan <span class="main">:=</span> <span class="main">{</span>Secure Sv <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aAgt <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">,</span>    <span class="comment1">― ‹send <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M2a/b›</span></span>›</span>
                Secure Sv <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aAgt <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> chan <span class="bound">s</span>
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">A</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">m1e_step4</span></span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m2_step4</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> key<span class="main">,</span> time<span class="main">]</span> <span class="main">⇒</span> m2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_step4</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>

     <span class="comment1">― ‹guards:›</span>
     runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span> 
     Secure Sv <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aAgt <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">∧</span>  <span class="comment1">― ‹recv <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M2a›</span></span>›</span>

     clk <span class="bound">s</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">+</span> Ls <span class="main">∧</span>                              <span class="comment1">― ‹ensure key freshness›</span>

     <span class="comment1">― ‹actions:›</span>
     <span class="comment1">― ‹record session key›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
       runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">B</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">m1e_step5</span></span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m2_step5</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> key<span class="main">,</span> time<span class="main">]</span> <span class="main">⇒</span> m2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_step5</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span> 

     <span class="comment1">― ‹guards:›</span>
     runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>
     Secure Sv <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aAgt <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">∧</span>  <span class="comment1">― ‹recv <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M2b›</span></span>›</span>

     <span class="comment1">― ‹ensure freshness of session key›</span>
     clk <span class="bound">s</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">+</span> Ls <span class="main">∧</span>

     <span class="comment1">― ‹actions:›</span>
     <span class="comment1">― ‹record session key›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
       runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Clock tick event›</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m1_tick</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m2_tick</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"time <span class="main">⇒</span> m2_trans"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_tick</span> <span class="main">≡</span> m1_tick"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Session key compromise.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m1_leak</span><span class="antiquote">}</span></span>›</span> 
  <span class="entity">m2_leak</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> m2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_leak</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">∈</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
    fst <span class="main">(</span>the <span class="main">(</span>runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Serv <span class="main">∧</span>         <span class="comment1">― ‹compromise server run <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Rs›</span></span>›</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="comment1">― ‹record session key as leaked;›</span>
    <span class="comment1">― ‹intruder sends himself an insecure channel message containing the key›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> leak <span class="main">:=</span> insert <span class="main">(</span>sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span> <span class="main">(</span>leak <span class="bound">s</span><span class="main">)</span><span class="main">,</span> 
            chan <span class="main">:=</span> insert <span class="main">(</span>Insec undefined undefined <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="main">(</span>sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span> <span class="main">⦈</span> 
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Intruder fake event (new).›</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">Id</span><span class="antiquote">}</span></span>›</span> 
  <span class="entity">m2_fake</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_fake</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span> 

     <span class="comment1">― ‹actions:›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
       <span class="comment1">― ‹close under fakeable messages›</span>
       chan <span class="main">:=</span> fake ik0 <span class="main">(</span>dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span> 
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Transition system›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_init</span> <span class="main">≡</span> <span class="main">{</span> <span class="main">⦇</span>
     runs <span class="main">=</span> Map.empty<span class="main">,</span>
     leak <span class="main">=</span> corrKey<span class="main">,</span>
     clk <span class="main">=</span> <span class="main">0</span><span class="main">,</span>
     chan <span class="main">=</span> <span class="main">{}</span>              <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Channels.ik0›</span></span> contains <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>aKey`corrKey›</span></span>›</span>
  <span class="main">⦈</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_trans"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_trans</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Ra</span> <span class="bound">Rb</span> <span class="bound">Rs</span> <span class="bound">Kab</span> <span class="bound">Ts</span> <span class="bound">T</span><span class="main">.</span>
     m2_step1 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">∪</span>
     m2_step2 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">∪</span>
     m2_step3 <span class="bound">Rs</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Kab</span> <span class="bound">Ts</span> <span class="main">∪</span>
     m2_step4 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Kab</span> <span class="bound">Ts</span> <span class="main">∪</span>
     m2_step5 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Kab</span> <span class="bound">Ts</span> <span class="main">∪</span>
     m2_tick <span class="bound">T</span> <span class="main">∪</span>
     m2_leak <span class="bound">Rs</span> <span class="main">∪</span>
     m2_fake <span class="main">∪</span>
     Id
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state<span class="main">,</span> m2_obs<span class="main">)</span> spec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2</span> <span class="main">≡</span> <span class="main">⦇</span>
    init <span class="main">=</span> m2_init<span class="main">,</span>
    trans <span class="main">=</span> m2_trans<span class="main">,</span>
    obs <span class="main">=</span> m2_obs
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_loc_defs <span class="main">=</span> 
  m2_def m2_init_def m2_trans_def m2_obs_def
  m2_step1_def m2_step2_def m2_step3_def m2_step4_def m2_step5_def 
  m2_tick_def m2_leak_def m2_fake_def 

<span class="keyword1"><span class="command">lemmas</span></span> m2_defs <span class="main">=</span> m2_loc_defs m1_defs


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants and simulation relation›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="comment1">(*
subsubsection {* inv1: Key definedness [UNUSED] *}
(******************************************************************************)

text {* All session keys in channel messages stem from existing runs. *}

definition 
  m2_inv1_keys :: "m2_state set"
where 
  "m2_inv1_keys ≡ {s. ∀R.
     aKey (sesK (R$sk)) ∈ atoms (chan s) (* ∨ sesK (R$sk) ∈ leak s *) ⟶ 
       R ∈ dom (runs s)
  }"

lemmas m2_inv1_keysI = 
  m2_inv1_keys_def [THEN setc_def_to_intro, rule_format]
lemmas m2_inv1_keysE [elim] = 
  m2_inv1_keys_def [THEN setc_def_to_elim, rule_format]
lemmas m2_inv1_keysD = 
  m2_inv1_keys_def [THEN setc_def_to_dest, rule_format]


text {* Invariance proof. *}

lemma PO_m2_inv1_keys_init [iff]:
  "init m2 ⊆ m2_inv1_keys"
by (auto simp add: m2_defs intro!: m2_inv1_keysI)

lemma PO_m2_inv1_keys_trans [iff]:
  "{m2_inv1_keys} trans m2 {&gt; m2_inv1_keys}"
by (auto simp add: PO_hoare_defs m2_defs intro!: m2_inv1_keysI)
   (auto simp add: ik0_def dest: m2_inv1_keysD dom_lemmas)

lemma PO_m2_inv1_keys [iff]: "reach m2 ⊆ m2_inv1_keys"
by (rule inv_rule_basic) (auto)


subsubsection {* inv2: Definedness of used keys [UNUSED] *}
(******************************************************************************)

definition 
  m2_inv2_keys_for :: "m2_state set"
where 
  "m2_inv2_keys_for ≡ {s. ∀R.
     sesK (R$sk) ∈ keys_for (chan s) ⟶ R ∈ dom (runs s)
  }"

lemmas m2_inv2_keys_forI = 
  m2_inv2_keys_for_def [THEN setc_def_to_intro, rule_format]
lemmas m2_inv2_keys_forE [elim] = 
  m2_inv2_keys_for_def [THEN setc_def_to_elim, rule_format]
lemmas m2_inv2_keys_forD = 
  m2_inv2_keys_for_def [THEN setc_def_to_dest, rule_format, rotated 1]


text {* Invariance proof. *}

lemma PO_m2_inv2_keys_for_init [iff]:
  "init m2 ⊆ m2_inv2_keys_for"
by (auto simp add: m2_defs intro!: m2_inv2_keys_forI)

lemma PO_m2_inv2_keys_for_trans [iff]:
  "{m2_inv2_keys_for ∩ m2_inv1_keys} trans m2 {&gt; m2_inv2_keys_for}"
apply (auto simp add: PO_hoare_defs m2_defs intro!: m2_inv2_keys_forI) 
-- {* 1 subgoal, from fake *}
apply (auto simp add: keys_for_def ik0_def, erule fake.cases, fastforce+)
done

lemma PO_m2_inv2_keys_for [iff]: "reach m2 ⊆ m2_inv2_keys_for"
by (rule inv_rule_incr) (auto del: subsetI)


text {* Useful application of invariant. *}

lemma m2_inv2_keys_for__extr_insert_key:                   (* OBSOLETE?! *)
  "⟦ R ∉ dom (runs s); s ∈ m2_inv2_keys_for ⟧
 ⟹ extr (insert (aKey (sesK (R$sk))) T) (chan s) 
     = insert (aKey (sesK (R$sk))) (extr T (chan s))"
by (subgoal_tac "sesK (R$sk) ∉ keys_for (chan s)") 
   (auto)
*)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv3a: Session key compromise›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A L2 version of a session key comprise invariant. Roughly, it states
that adding a set of keys <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">KK</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to the parameter <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>T›</span></span></span></span> of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">extr</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
does not help the intruder to extract keys other than those in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">KK</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> or
extractable without adding <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">KK</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_inv3a_sesK_compr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">m2_inv3a_sesK_compr</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">K</span> <span class="bound">KK</span><span class="main">.</span>
     aKey <span class="bound">K</span> <span class="main">∈</span> extr <span class="main">(</span>aKey<span class="main">`</span><span class="bound">KK</span> <span class="main">∪</span> ik0<span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="bound">K</span> <span class="main">∈</span> <span class="bound">KK</span> <span class="main">∨</span> aKey <span class="bound">K</span> <span class="main">∈</span> extr ik0 <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv3a_sesK_comprI <span class="main">=</span> 
  m2_inv3a_sesK_compr_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv3a_sesK_comprE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> 
  m2_inv3a_sesK_compr_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv3a_sesK_comprD <span class="main">=</span> 
  m2_inv3a_sesK_compr_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Additional lemma›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> insert_commute_aKey <span class="main">=</span> insert_commute <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"aKey <span class="free">K</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">K</span><span class="main">]</span> 

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv3a_sesK_compr_simps <span class="main">=</span> 
  m2_inv3a_sesK_comprD
  m2_inv3a_sesK_comprD <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"insert <span class="free">Kab</span> <span class="free">KK</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">Kab</span> <span class="free">KK</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  m2_inv3a_sesK_comprD <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">Kab</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">Kab</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  insert_commute_aKey   <span class="comment1">― ‹to get the keys to the front›</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv3a_sesK_compr_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m2 <span class="main">⊆</span> m2_inv3a_sesK_compr"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv3a_sesK_comprI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv3a_sesK_compr_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv3a_sesK_compr<span class="main">}</span> trans m2 <span class="main">{&gt;</span> m2_inv3a_sesK_compr<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs m2_inv3a_sesK_compr_simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv3a_sesK_comprI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv3a_sesK_compr <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m2_inv3a_sesK_compr"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> 


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv3: Extracted session keys›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹inv3: Extracted non-leaked session keys were generated by the server 
for at least one bad agent. This invariant is needed in the proof of the 
strengthening of the authorization guards in steps 4 and 5 
(e.g., <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">Kab</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">A</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∈</span></span> azC <span class="main"><span class="main">(</span></span>runs <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for the initiator's step4).›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_inv3_extrKey</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_inv3_extrKey</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">K</span><span class="main">.</span>
     aKey <span class="bound">K</span> <span class="main">∈</span> extr ik0 <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span>  <span class="bound">K</span> <span class="main">∉</span> leak <span class="bound">s</span> <span class="main">⟶</span> <span class="comment1">― ‹was: <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>K ∉ corrKey ⟶›</span></span>›</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound">R</span> <span class="bound">A'</span> <span class="bound">B'</span> <span class="bound">Ts'</span><span class="main">.</span> <span class="bound">K</span> <span class="main">=</span> sesK <span class="main">(</span><span class="bound">R</span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span>
          runs <span class="bound">s</span> <span class="bound">R</span> <span class="main">=</span> Some <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="bound">A'</span><span class="main">,</span> <span class="bound">B'</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNum <span class="bound">Ts'</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span> 
                    <span class="main">(</span><span class="bound">A'</span> <span class="main">∈</span> bad <span class="main">∨</span> <span class="bound">B'</span> <span class="main">∈</span> bad<span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv3_extrKeyI <span class="main">=</span> 
  m2_inv3_extrKey_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv3_extrKeyE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> 
  m2_inv3_extrKey_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv3_extrKeyD <span class="main">=</span> 
  m2_inv3_extrKey_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv3_extrKey_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m2 <span class="main">⊆</span> m2_inv3_extrKey"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_defs ik0_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv3_extrKeyI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv3_extrKey_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv3_extrKey <span class="main">∩</span> m2_inv3a_sesK_compr<span class="main">}</span> 
      trans m2 
   <span class="main">{&gt;</span> m2_inv3_extrKey<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_def m2_trans_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Rs</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Kab</span> <span class="skolem">Ts</span>
  <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv3_extrKey <span class="main">∩</span> m2_inv3a_sesK_compr<span class="main">}</span> m2_step3 <span class="skolem">Rs</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Kab</span> <span class="skolem">Ts</span> <span class="main">{&gt;</span> m2_inv3_extrKey<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv3_extrKeyI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_inv3a_sesK_compr_simps 
              <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv3_extrKeyD <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Ra</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Kab</span> <span class="skolem">Ts</span>
  <span class="keyword3"><span class="command">show</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv3_extrKey <span class="main">∩</span> m2_inv3a_sesK_compr<span class="main">}</span> m2_step4 <span class="skolem">Ra</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Kab</span> <span class="skolem">Ts</span> <span class="main">{&gt;</span> m2_inv3_extrKey<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv3_extrKeyI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv3_extrKeyD <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Rb</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Kab</span> <span class="skolem">Ts</span>
  <span class="keyword3"><span class="command">show</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv3_extrKey <span class="main">∩</span> m2_inv3a_sesK_compr<span class="main">}</span> m2_step5 <span class="skolem">Rb</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Kab</span> <span class="skolem">Ts</span> <span class="main">{&gt;</span> m2_inv3_extrKey<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv3_extrKeyI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv3_extrKeyD <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Rs</span>
  <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv3_extrKey <span class="main">∩</span> m2_inv3a_sesK_compr<span class="main">}</span> m2_leak <span class="skolem">Rs</span> <span class="main">{&gt;</span> m2_inv3_extrKey<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv3_extrKeyI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_inv3a_sesK_compr_simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv3_extrKeyI<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv3_extrKeyD <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv3_extrKey <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m2_inv3_extrKey"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> J<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"m2_inv3a_sesK_compr"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> inv_rule_incr<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> 



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv4: Messages M2a/M2b for good agents and server state›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹inv4: Secure messages to honest agents and server state; one variant 
for each of M2a and M2b. These invariants establish guard strengthening for
server authentication by the initiator and the responder.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_inv4_M2a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_inv4_M2a</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Kab</span> <span class="bound">Ts</span><span class="main">.</span>
     Secure Sv <span class="bound">A</span> <span class="main">(</span>Msg <span class="main">[</span>aAgt <span class="bound">B</span><span class="main">,</span> aKey <span class="bound">Kab</span><span class="main">,</span> aNum <span class="bound">Ts</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">⟶</span> <span class="bound">A</span> <span class="main">∈</span> good <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound">Rs</span><span class="main">.</span> <span class="bound">Kab</span> <span class="main">=</span> sesK <span class="main">(</span><span class="bound">Rs</span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span>
          runs <span class="bound">s</span> <span class="bound">Rs</span> <span class="main">=</span> Some <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNum <span class="bound">Ts</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_inv4_M2b</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_inv4_M2b</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Kab</span> <span class="bound">Ts</span><span class="main">.</span>
     Secure Sv <span class="bound">B</span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="bound">Kab</span><span class="main">,</span> aAgt <span class="bound">A</span><span class="main">,</span> aNum <span class="bound">Ts</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="bound">s</span> <span class="main">⟶</span> <span class="bound">B</span> <span class="main">∈</span> good <span class="main">⟶</span>
        <span class="main">(</span><span class="main">∃</span><span class="bound">Rs</span><span class="main">.</span> <span class="bound">Kab</span> <span class="main">=</span> sesK <span class="main">(</span><span class="bound">Rs</span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span>
           runs <span class="bound">s</span> <span class="bound">Rs</span> <span class="main">=</span> Some <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNum <span class="bound">Ts</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv4_M2aI <span class="main">=</span> 
  m2_inv4_M2a_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv4_M2aE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> 
  m2_inv4_M2a_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv4_M2aD <span class="main">=</span> 
  m2_inv4_M2a_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv4_M2bI <span class="main">=</span> m2_inv4_M2b_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv4_M2bE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> 
  m2_inv4_M2b_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv4_M2bD <span class="main">=</span> 
  m2_inv4_M2b_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proofs.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv4_M2a_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m2 <span class="main">⊆</span> m2_inv4_M2a"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv4_M2aI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv4_M2a_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv4_M2a<span class="main">}</span> trans m2 <span class="main">{&gt;</span> m2_inv4_M2a<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv4_M2aI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv4_M2aD <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>
<span class="comment1">― ‹3 subgoals›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spec<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv4_M2a <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m2_inv4_M2a"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv4_M2b_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m2 <span class="main">⊆</span> m2_inv4_M2b"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv4_M2bI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv4_M2b_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv4_M2b<span class="main">}</span> trans m2 <span class="main">{&gt;</span> m2_inv4_M2b<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv4_M2bI<span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv4_M2bD <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>
<span class="comment1">― ‹3 subgoals›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spec<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv4_M2b <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m2_inv4_M2b"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_incr<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Consequence needed in proof of inv8/step5 and inv9/step4: The 
session key uniquely identifies other fields in M2a and M2b, provided it 
is secret.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m2_inv4_M2a_M2b_match<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Secure Sv <span class="free">A'</span> <span class="main">(</span>Msg <span class="main">[</span>aAgt <span class="free">B'</span><span class="main">,</span> aKey <span class="free">Kab</span><span class="main">,</span> aNum <span class="free">Ts'</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="free">s</span><span class="main">;</span> 
     Secure Sv <span class="free">B</span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">,</span> aAgt <span class="free">A</span><span class="main">,</span> aNum <span class="free">Ts</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="free">s</span><span class="main">;</span> 
     aKey <span class="free">Kab</span> <span class="main">∉</span> extr ik0 <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">s</span> <span class="main">∈</span> m2_inv4_M2a<span class="main">;</span> <span class="free">s</span> <span class="main">∈</span> m2_inv4_M2b <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">A</span> <span class="main">=</span> <span class="free">A'</span> <span class="main">∧</span> <span class="free">B</span> <span class="main">=</span> <span class="free">B'</span> <span class="main">∧</span> <span class="free">Ts</span> <span class="main">=</span> <span class="free">Ts'</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">A'</span> <span class="main">∉</span> bad <span class="main">∧</span> <span class="free">B</span> <span class="main">∉</span> bad"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv4_M2aD m2_inv4_M2bD<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹More consequences of invariants. Needed in ref/step4 and ref/step5 
respectively to show the strengthening of the authorization guards.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m2_inv34_M2a_authorized<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Secure Sv <span class="free">A</span> <span class="main">(</span>Msg <span class="main">[</span>aAgt <span class="free">B</span><span class="main">,</span> aKey <span class="free">K</span><span class="main">,</span> aNum <span class="free">T</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="free">s</span>"</span></span> 
          <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> m2_inv3_extrKey"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> m2_inv4_M2a"</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">∉</span> leak <span class="free">s</span>"</span></span>  
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">K</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> azC <span class="main">(</span>runs <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> bad"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True 
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">∈</span> bad›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"aKey <span class="free">K</span> <span class="main">∈</span> extr ik0 <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">∈</span> m2_inv3_extrKey›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">K</span> <span class="main">∉</span> leak <span class="free">s</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False 
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m2_inv4_M2aD<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m2_inv34_M2b_authorized<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Secure Sv <span class="free">B</span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="free">K</span><span class="main">,</span> aAgt <span class="free">A</span><span class="main">,</span> aNum <span class="free">T</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="free">s</span>"</span></span> 
          <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> m2_inv3_extrKey"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> m2_inv4_M2b"</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">∉</span> leak <span class="free">s</span>"</span></span>  
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">K</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> azC <span class="main">(</span>runs <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∈</span> bad"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True 
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">B</span> <span class="main">∈</span> bad›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"aKey <span class="free">K</span> <span class="main">∈</span> extr ik0 <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">∈</span> m2_inv3_extrKey›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">K</span> <span class="main">∉</span> leak <span class="free">s</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False 
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m2_inv4_M2bD<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv5: Key secrecy for server›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹inv5: Key secrecy from server perspective. This invariant links the 
abstract notion of key secrecy to the intruder key knowledge.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_inv5_ikk_sv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_inv5_ikk_sv</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">R</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">al</span><span class="main">.</span>
     runs <span class="bound">s</span> <span class="bound">R</span> <span class="main">=</span> Some <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> <span class="bound">al</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">A</span> <span class="main">∈</span> good <span class="main">⟶</span> <span class="bound">B</span> <span class="main">∈</span> good <span class="main">⟶</span>
     aKey <span class="main">(</span>sesK <span class="main">(</span><span class="bound">R</span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span> <span class="main">∈</span> extr ik0 <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span>
       sesK <span class="main">(</span><span class="bound">R</span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∈</span> leak <span class="bound">s</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv5_ikk_svI <span class="main">=</span> 
  m2_inv5_ikk_sv_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv5_ikk_svE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> 
  m2_inv5_ikk_sv_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv5_ikk_svD <span class="main">=</span> 
  m2_inv5_ikk_sv_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv5_ikk_sv_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m2 <span class="main">⊆</span> m2_inv5_ikk_sv"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv5_ikk_svI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv5_ikk_sv_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m2_inv5_ikk_sv <span class="main">∩</span> m2_inv3a_sesK_compr <span class="main">∩</span> m2_inv3_extrKey<span class="main">}</span> 
     trans m2 
   <span class="main">{&gt;</span> m2_inv5_ikk_sv<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m2_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m2_inv5_ikk_svI<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_inv3a_sesK_compr_simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_lemmas<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_inv5_ikk_sv <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m2 <span class="main">⊆</span> m2_inv5_ikk_sv"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> J<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"m2_inv3_extrKey <span class="main">∩</span> m2_inv3a_sesK_compr"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> inv_rule_incr<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv6/7: Key secrecy for initiator and responder›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹These invariants are derivable.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_inv6_ikk_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_inv6_ikk_init</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Ra</span> <span class="bound">K</span> <span class="bound">Ts</span> <span class="bound">nl</span><span class="main">.</span>
     runs <span class="bound">s</span> <span class="bound">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> aKey <span class="bound">K</span> <span class="main">#</span> aNum <span class="bound">Ts</span> <span class="main">#</span> <span class="bound">nl</span><span class="main">)</span> <span class="main">⟶</span> 
     <span class="bound">A</span> <span class="main">∈</span> good <span class="main">⟶</span> <span class="bound">B</span> <span class="main">∈</span> good <span class="main">⟶</span> aKey <span class="bound">K</span> <span class="main">∈</span> extr ik0 <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span> 
       <span class="bound">K</span> <span class="main">∈</span> leak <span class="bound">s</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv6_ikk_initI <span class="main">=</span> m2_inv6_ikk_init_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv6_ikk_initE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m2_inv6_ikk_init_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv6_ikk_initD <span class="main">=</span> m2_inv6_ikk_init_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>


<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">m2_inv7_ikk_resp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m2_inv7_ikk_resp</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Rb</span> <span class="bound">K</span> <span class="bound">Ts</span> <span class="bound">nl</span><span class="main">.</span>
     runs <span class="bound">s</span> <span class="bound">Rb</span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">]</span><span class="main">,</span> aKey <span class="bound">K</span> <span class="main">#</span> aNum <span class="bound">Ts</span> <span class="main">#</span> <span class="bound">nl</span><span class="main">)</span> <span class="main">⟶</span> 
     <span class="bound">A</span> <span class="main">∈</span> good <span class="main">⟶</span> <span class="bound">B</span> <span class="main">∈</span> good <span class="main">⟶</span> aKey <span class="bound">K</span> <span class="main">∈</span> extr ik0 <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="bound">K</span> <span class="main">∈</span> leak <span class="bound">s</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m2_inv7_ikk_respI <span class="main">=</span> m2_inv7_ikk_resp_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv7_ikk_respE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m2_inv7_ikk_resp_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m2_inv7_ikk_respD <span class="main">=</span> m2_inv7_ikk_resp_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 1<span class="main">]</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The simulation relation. This is a pure superposition refinement.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R12</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m1_state <span class="main">×</span> m2_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R12</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> runs <span class="bound">s</span> <span class="main">=</span> runs <span class="bound">t</span> <span class="main">∧</span> leak <span class="bound">s</span> <span class="main">=</span> leak <span class="bound">t</span> <span class="main">∧</span> clk <span class="bound">s</span> <span class="main">=</span> clk <span class="bound">t</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The mediator function is the identity.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">med21</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m2_obs <span class="main">⇒</span> m1_obs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med21</span> <span class="main">=</span> id"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_step1_refines_m1_step1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12<span class="main">}</span> 
     <span class="main">(</span>m1_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m2_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R12<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12_def m2_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_step2_refines_m1_step2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12<span class="main">}</span> 
     <span class="main">(</span>m1_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m2_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span>
   <span class="main">{&gt;</span> R12<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12_def m2_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_step3_refines_m1_step3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12<span class="main">}</span> 
     <span class="main">(</span>m1_step3 <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m2_step3 <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span><span class="main">)</span>
   <span class="main">{&gt;</span> R12<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12_def m2_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_step4_refines_m1_step4<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12 <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">(</span>m2_inv4_M2a <span class="main">∩</span> m2_inv3_extrKey<span class="main">)</span><span class="main">}</span> 
     <span class="main">(</span>m1_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m2_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span><span class="main">)</span>  
   <span class="main">{&gt;</span> R12<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12_def m2_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m2_inv34_M2a_authorized<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_step5_refines_m1_step5<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12 <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">(</span>m2_inv4_M2b <span class="main">∩</span> m2_inv3_extrKey<span class="main">)</span><span class="main">}</span>          <span class="comment1">― ‹REMOVED!: <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>m2_inv5_ikk_sv›</span></span>›</span>
     <span class="main">(</span>m1_step5 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m2_step5 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span><span class="main">)</span> 
   <span class="main">{&gt;</span> R12<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12_def m2_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m2_inv34_M2b_authorized<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_tick_refines_m1_tick<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12<span class="main">}</span>
    <span class="main">(</span>m1_tick <span class="free">T</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m2_tick <span class="free">T</span><span class="main">)</span>
   <span class="main">{&gt;</span> R12<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12_def m2_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_leak_refines_m1_leak<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12<span class="main">}</span> 
     <span class="main">(</span>m1_leak <span class="free">Rs</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m2_leak <span class="free">Rs</span><span class="main">)</span>
   <span class="main">{&gt;</span> R12<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12_def m2_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_fake_refines_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12<span class="main">}</span> 
     Id<span class="main">,</span> m2_fake
   <span class="main">{&gt;</span> R12<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R12_def m2_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All together now...›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_m2_trans_refines_m1_trans <span class="main">=</span> 
  PO_m2_step1_refines_m1_step1 PO_m2_step2_refines_m1_step2
  PO_m2_step3_refines_m1_step3 PO_m2_step4_refines_m1_step4
  PO_m2_step5_refines_m1_step5 PO_m2_tick_refines_m1_tick 
  PO_m2_leak_refines_m1_leak PO_m2_fake_refines_skip 

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_refines_init_m1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m2 <span class="main">⊆</span> R12<span class="main">``</span><span class="main">(</span>init m1<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R12_def m1_defs m2_loc_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m2_refines_trans_m1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R12 <span class="main">∩</span> 
    UNIV <span class="main">×</span> <span class="main">(</span>m2_inv4_M2b <span class="main">∩</span> m2_inv4_M2a <span class="main">∩</span> m2_inv3_extrKey<span class="main">)</span><span class="main">}</span> 
     <span class="main">(</span>trans m1<span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans m2<span class="main">)</span> 
   <span class="main">{&gt;</span> R12<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_def m2_trans_def m1_def m1_trans_def<span class="main">)</span>
   <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_m2_trans_refines_m1_trans<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>


<span class="keyword1"><span class="command">lemma</span></span> PO_obs_consistent_R12 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"obs_consistent R12 med21 m1 m2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R12_def med21_def m2_defs<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement result.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m2_refines_m1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"refines 
     <span class="main">(</span>R12 <span class="main">∩</span> 
      <span class="main">(</span>UNIV <span class="main">×</span> <span class="main">(</span>m2_inv4_M2b <span class="main">∩</span> m2_inv4_M2a <span class="main">∩</span> m2_inv3_extrKey <span class="main">∩</span> m2_inv3a_sesK_compr<span class="main">)</span><span class="main">)</span><span class="main">)</span>
     med21 m1 m2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Refinement_using_invariants<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> m2_implements_m1 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"implements med21 m1 m2"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refinement_soundness<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Inherited and derived invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>
<span class="comment1">(*
text {* Show preservation of invariants @{term "m1_inv2i_serv"} and
@{term "m1_inv2r_serv"} from @{text "m1"}. *}

lemma PO_m2_sat_m1_inv2i_serv [iff]: "reach m2 ⊆ m1_inv2i_serv"
by (rule_tac Pa=m1_inv2i_serv and Qa=m1_inv2i_serv and Q=m1_inv2i_serv 
       in m2_implements_m1 [THEN [5] internal_invariant_translation])
   (auto simp add: m2_loc_defs med21_def intro!: m1_inv2i_servI)

lemma PO_m2_sat_m1_inv2r_serv [iff]: "reach m2 ⊆ m1_inv2r_serv"
by (rule_tac Pa=m1_inv2r_serv and Qa=m1_inv2r_serv and Q=m1_inv2r_serv
       in m2_implements_m1 [THEN [5] internal_invariant_translation])
   (fastforce simp add: m2_loc_defs med21_def intro!: m1_inv2r_servI)+


text {* Now we derive the L2 key secrecy invariants for the initiator 
and the responder (for definition, see above). *}

lemma PO_m2_inv6_init_ikk [iff]: "reach m2 ⊆ m2_inv6_ikk_init"
apply (rule_tac B=" m1_inv2i_serv ∩ m2_inv5_ikk_sv" in subset_trans, auto)
apply (rule m2_inv6_ikk_initI, auto)
apply (blast dest!: m1_inv2i_servD) 
done

lemma PO_m2_inv6_resp_ikk [iff]: "reach m2 ⊆ m2_inv7_ikk_resp"
apply (rule_tac B=" m1_inv2r_serv ∩ m2_inv5_ikk_sv" in subset_trans, auto)
apply (rule m2_inv7_ikk_respI, auto)
apply (blast dest!: m1_inv2r_servD) 
done
*)</span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="m3_ds_par">
<div class="head">
<h1>Theory m3_ds_par</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Development of Security Protocols by Refinement

  Module:  Key_establish/m3_ds_par.thy (Isabelle/HOL 2016-1)
  ID:      $Id: m3_ds_par.thy 132890 2016-12-24 10:25:57Z csprenge $
  Authors: Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
           Ivano Somaini, ETH Zurich &lt;somainii@student.ethz.ch&gt;

  Key distribution protocols
  Level 3: parallel version of Denning-Sacco protocol

  Copyright (c) 2009-2016 Christoph Sprenger, Ivano Somaini
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Denning-Sacco, direct variant (L3)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> m3_ds_par <span class="keyword2"><span class="keyword">imports</span></span> <a href="m2_ds.html">m2_ds</a> <span class="quoted">"<a href="Message.html">../Refinement/Message</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
We model a direct implementation of the channel-based Denning-Sacco protocol
at Level 2. In this version, there is no ticket forwarding.
\[
\begin{array}{lll}
  \mathrm{M1.} &amp; A \rightarrow S: &amp; A, B \\ 
  \mathrm{M2a.} &amp; S \rightarrow A: &amp; \{Kab, B, Ts\}_{Kas} \\
  \mathrm{M2b.} &amp; S \rightarrow B: &amp; \{Kab, A, Ts\}_{Kbs}
\end{array}
\]
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Proof tool configuration. Avoid annoying automatic unfolding of
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>dom›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">declare</span></span> domIff <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">iff</span> <span class="quasi_keyword">del</span><span class="main">]</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Setup›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now we can define the initial key knowledge.›</span></span>

<span class="keyword1"><span class="command">overloading</span></span> ltkeySetup' <span class="main">≡</span> <span class="quoted">ltkeySetup</span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> ltkeySetup_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ltkeySetup'</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span>sharK <span class="bound">C</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span> <span class="main">|</span> <span class="bound">C</span> <span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">=</span> <span class="bound">C</span> <span class="main">∨</span> <span class="bound">A</span> <span class="main">=</span> Sv<span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> corrKey_shrK_bad <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"corrKey <span class="main">=</span> shrK<span class="main">`</span>bad"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> keySetup_def ltkeySetup_def corrKey_def<span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹State›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The secure channels are star-shaped to/from the server.  Therefore,
we have only one agent in the relation.›</span></span>

<span class="keyword1"><span class="command">record</span></span> m3_state <span class="main">=</span> <span class="quoted"><span class="quoted">"m1_state"</span></span> <span class="main">+</span>
  IK <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set"</span></span>                                <span class="comment1">― ‹intruder knowledge›</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Observable state:
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"runs"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"leak"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"clk"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">cache</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  m3_obs <span class="main">=</span> <span class="quoted"><span class="quoted">"m2_obs"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_obs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_state <span class="main">⇒</span> m3_obs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_obs</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> runs <span class="main">=</span> runs <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> leak <span class="main">=</span> leak <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> clk <span class="main">=</span> clk <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  m3_pred <span class="main">=</span> <span class="quoted"><span class="quoted">"m3_state set"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  m3_trans <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m3_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Events›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Protocol events.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">A</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m2_step1"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_step1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step1</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>                                <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Ra›</span></span> is fresh›</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      IK <span class="main">:=</span> insert <span class="main">⦃</span>Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⦄</span> <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span>        <span class="comment1">― ‹send <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M1›</span></span>›</span>
    <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">B</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m2_step2"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_step2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step2</span> <span class="main">≡</span> m1_step2"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"Server"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m2_step3</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_step3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> key<span class="main">,</span> time<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step3</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>                           <span class="comment1">― ‹fresh server run›</span>
    <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">=</span> sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span>                          <span class="comment1">― ‹fresh session key›</span>

     <span class="main">⦃</span>Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⦄</span> <span class="main">∈</span> IK <span class="bound">s</span> <span class="main">∧</span>                   <span class="comment1">― ‹recv <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M1›</span></span>›</span>
     <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">=</span> clk <span class="bound">s</span> <span class="main">∧</span>                                   <span class="comment1">― ‹fresh timestamp›</span>

     <span class="comment1">― ‹actions:›</span>
     <span class="comment1">― ‹record session key and send <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M2›</span></span>›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
       runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">↦</span> <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>   <span class="comment1">― ‹send <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M2a›</span></span>, <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M2b›</span></span>›</span>
       IK <span class="main">:=</span> insert <span class="main">(</span>Crypt <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">⦃</span>Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Key <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> Number <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">⦄</span><span class="main">)</span>
             <span class="main">(</span>insert <span class="main">(</span>Crypt <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">⦃</span>Key <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Number <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">⦄</span><span class="main">)</span> <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span><span class="main">)</span>
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">A</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m2_step4</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_step4</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> key<span class="main">,</span> time<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step4</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>

     <span class="comment1">― ‹guards:›</span>
     runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>           <span class="comment1">― ‹key not yet recv'd›</span>

     Crypt <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>                                  <span class="comment1">― ‹recv <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M2›</span></span>›</span>
       <span class="main">⦃</span>Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Key <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> Number <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">⦄</span> <span class="main">∈</span> IK <span class="bound">s</span> <span class="main">∧</span>

     <span class="comment1">― ‹check freshness of session key›</span>
     clk <span class="bound">s</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">+</span> Ls <span class="main">∧</span>

     <span class="comment1">― ‹actions:›</span>
     <span class="comment1">― ‹record session key›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
       runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">B</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m2_step5</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_step5</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> key<span class="main">,</span> time<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step5</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>
     <span class="comment1">― ‹guards:›</span>
     runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>             <span class="comment1">― ‹key not yet recv'd›</span>

     Crypt <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">⦃</span>Key <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Number <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">⦄</span> <span class="main">∈</span> IK <span class="bound">s</span> <span class="main">∧</span>    <span class="comment1">― ‹recv <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M3›</span></span>›</span>

     <span class="comment1">― ‹ensure freshness of session key; replays with fresh authenticator ok!›</span>
     clk <span class="bound">s</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">+</span> Ls <span class="main">∧</span>

     <span class="comment1">― ‹actions:›</span>
     <span class="comment1">― ‹record session key›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
       runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Clock tick event›</span></span>

<span class="keyword1"><span class="command">definition</span></span>   <span class="comment1">― ‹refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m2_tick"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_tick</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"time <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_tick</span> <span class="main">≡</span> m1_tick"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Session key compromise.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m2_leak</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_leak</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_leak</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">∈</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
    fst <span class="main">(</span>the <span class="main">(</span>runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Serv <span class="main">∧</span>         <span class="comment1">― ‹compromise server run <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Rs›</span></span>›</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="comment1">― ‹record session key as leaked and add it to intruder knowledge›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> leak <span class="main">:=</span> insert <span class="main">(</span>sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span> <span class="main">(</span>leak <span class="bound">s</span><span class="main">)</span><span class="main">,</span>
            IK <span class="main">:=</span> insert <span class="main">(</span>Key <span class="main">(</span>sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span> <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Intruder fake event. The following "Dolev-Yao" event generates all
intruder-derivable messages.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m2_fake"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_DY_fake</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_DY_fake</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>

     <span class="comment1">― ‹actions:›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> IK <span class="main">:=</span> synth <span class="main">(</span>analz <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span>       <span class="comment1">― ‹take DY closure›</span>
  <span class="main">}</span>"</span></span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Transition system›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_init</span> <span class="main">≡</span> <span class="main">{</span> <span class="main">⦇</span>
     runs <span class="main">=</span> Map.empty<span class="main">,</span>
     leak <span class="main">=</span> shrK<span class="main">`</span>bad<span class="main">,</span>
     clk <span class="main">=</span> <span class="main">0</span><span class="main">,</span>
     IK <span class="main">=</span> Key<span class="main">`</span>shrK<span class="main">`</span>bad
  <span class="main">⦈</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_trans"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_trans</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Ra</span> <span class="bound">Rb</span> <span class="bound">Rs</span> <span class="bound">Kab</span> <span class="bound">Ts</span> <span class="bound">T</span><span class="main">.</span>
     m3_step1 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">∪</span>
     m3_step2 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">∪</span>
     m3_step3 <span class="bound">Rs</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Kab</span> <span class="bound">Ts</span> <span class="main">∪</span>
     m3_step4 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Kab</span> <span class="bound">Ts</span> <span class="main">∪</span>
     m3_step5 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Kab</span> <span class="bound">Ts</span> <span class="main">∪</span>
     m3_tick <span class="bound">T</span> <span class="main">∪</span>
     m3_leak <span class="bound">Rs</span> <span class="main">∪</span>
     m3_DY_fake <span class="main">∪</span>
     Id
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m3_state<span class="main">,</span> m3_obs<span class="main">)</span> spec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3</span> <span class="main">≡</span> <span class="main">⦇</span>
    init <span class="main">=</span> m3_init<span class="main">,</span>
    trans <span class="main">=</span> m3_trans<span class="main">,</span>
    obs <span class="main">=</span> m3_obs
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_loc_defs <span class="main">=</span>
  m3_def m3_init_def m3_trans_def m3_obs_def
  m3_step1_def m3_step2_def m3_step3_def m3_step4_def m3_step5_def
  m3_tick_def m3_leak_def m3_DY_fake_def

<span class="keyword1"><span class="command">lemmas</span></span> m3_defs <span class="main">=</span> m3_loc_defs m2_defs


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Specialized injection that we can apply more aggressively.›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> analz_Inj_IK <span class="main">=</span> analz.Inj <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"IK <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">s</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> parts_Inj_IK <span class="main">=</span> parts.Inj <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"IK <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">s</span><span class="main">]</span>

<span class="keyword1"><span class="command">declare</span></span> parts_Inj_IK <span class="main">[</span><span class="operator">dest</span><span class="main"><span class="main">!</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">declare</span></span> analz_into_parts <span class="main">[</span><span class="operator">dest</span><span class="main">]</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv1: Secrecy of pre-distributed shared keys›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_inv1_lkeysec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_inv1_lkeysec</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">C</span><span class="main">.</span>
     <span class="main">(</span>Key <span class="main">(</span>shrK <span class="bound">C</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">C</span> <span class="main">∈</span> bad<span class="main">)</span> <span class="main">∧</span>
     <span class="main">(</span><span class="bound">C</span> <span class="main">∈</span> bad <span class="main">⟶</span> Key <span class="main">(</span>shrK <span class="bound">C</span><span class="main">)</span> <span class="main">∈</span> IK <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_inv1_lkeysecI <span class="main">=</span> m3_inv1_lkeysec_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv1_lkeysecE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m3_inv1_lkeysec_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv1_lkeysecD <span class="main">=</span> m3_inv1_lkeysec_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv1_lkeysec_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m3 <span class="main">⊆</span> m3_inv1_lkeysec"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv1_lkeysecI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv1_lkeysec_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m3_inv1_lkeysec<span class="main">}</span> trans m3 <span class="main">{&gt;</span> m3_inv1_lkeysec<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv1_lkeysecI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv1_lkeysec <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m3 <span class="main">⊆</span> m3_inv1_lkeysec"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_incr<span class="main">)</span> <span class="main">(</span><span class="operator">fast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Useful simplifier lemmas›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m3_inv1_lkeysec_for_parts <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">s</span> <span class="main">∈</span> m3_inv1_lkeysec <span class="main">⟧</span> <span class="main">⟹</span> Key <span class="main">(</span>shrK <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>IK <span class="free">s</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">C</span> <span class="main">∈</span> bad"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> m3_inv1_lkeysec_for_analz <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">s</span> <span class="main">∈</span> m3_inv1_lkeysec <span class="main">⟧</span> <span class="main">⟹</span> Key <span class="main">(</span>shrK <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="free">s</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">C</span> <span class="main">∈</span> bad"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv3: Session keys not used to encrypt other session keys›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Session keys are not used to encrypt other keys. Proof requires
generalization to sets of session keys.

NOTE: This invariant will be derived from the corresponding L2 invariant
using the simulation relation.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_inv3_sesK_compr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_inv3_sesK_compr</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">K</span> <span class="bound">KK</span><span class="main">.</span>
     <span class="bound">KK</span> <span class="main">⊆</span> range sesK <span class="main">⟶</span>
     <span class="main">(</span>Key <span class="bound">K</span> <span class="main">∈</span> analz <span class="main">(</span>Key<span class="main">`</span><span class="bound">KK</span> <span class="main">∪</span> <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">K</span> <span class="main">∈</span> <span class="bound">KK</span> <span class="main">∨</span> Key <span class="bound">K</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_inv3_sesK_comprI <span class="main">=</span> m3_inv3_sesK_compr_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv3_sesK_comprE <span class="main">=</span> m3_inv3_sesK_compr_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv3_sesK_comprD <span class="main">=</span> m3_inv3_sesK_compr_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Additional lemma›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> insert_commute_Key <span class="main">=</span> insert_commute <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Key <span class="free">K</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">K</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_inv3_sesK_compr_simps <span class="main">=</span>
  m3_inv3_sesK_comprD
  m3_inv3_sesK_comprD <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"insert <span class="free">Kab</span> <span class="free">KK</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">Kab</span> <span class="free">KK</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  m3_inv3_sesK_comprD <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">Kab</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">Kab</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  insert_commute_Key


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Message abstraction and simulation relation›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Abstraction function on sets of messages.›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span>
  <span class="entity">abs_msg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set <span class="main">⇒</span> chmsg set"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">H</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  am_M1<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⦃</span>Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⦄</span> <span class="main">∈</span> <span class="free">H</span>
  <span class="main">⟹</span> Insec <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Msg <span class="main">[]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">abs_msg</span> <span class="free">H</span>"</span></span>
<span class="main">|</span> am_M2a<span class="main">:</span>
    <span class="quoted"><span class="quoted">"Crypt <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">⦃</span>Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Key <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">,</span> Number <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">⦄</span> <span class="main">∈</span> <span class="free">H</span>
  <span class="main">⟹</span> Secure Sv <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aAgt <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> aKey <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">abs_msg</span> <span class="free">H</span>"</span></span>
<span class="main">|</span> am_M2b<span class="main">:</span>
    <span class="quoted"><span class="quoted">"Crypt <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">⦃</span>Key <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Number <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">⦄</span> <span class="main">∈</span> <span class="free">H</span>
  <span class="main">⟹</span> Secure Sv <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">,</span> aAgt <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">abs_msg</span> <span class="free">H</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹R23: The simulation relation. This is a data refinement of
the insecure and secure channels of refinement 2.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R23_msgs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R23_msgs</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> abs_msg <span class="main">(</span>parts <span class="main">(</span>IK <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> chan <span class="bound">s</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R23_keys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R23_keys</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">KK</span> <span class="bound">K</span><span class="main">.</span> <span class="bound">KK</span> <span class="main">⊆</span> range sesK <span class="main">⟶</span>
     Key <span class="bound">K</span> <span class="main">∈</span> analz <span class="main">(</span>Key<span class="main">`</span><span class="bound">KK</span> <span class="main">∪</span> <span class="main">(</span>IK <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> aKey <span class="bound">K</span> <span class="main">∈</span> extr <span class="main">(</span>aKey<span class="main">`</span><span class="bound">KK</span> <span class="main">∪</span> ik0<span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R23_pres</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R23_pres</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> runs <span class="bound">s</span> <span class="main">=</span> runs <span class="bound">t</span> <span class="main">∧</span> leak <span class="bound">s</span> <span class="main">=</span> leak <span class="bound">t</span> <span class="main">∧</span> clk <span class="bound">s</span> <span class="main">=</span> clk <span class="bound">t</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R23</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R23</span> <span class="main">≡</span> R23_msgs <span class="main">∩</span> R23_keys <span class="main">∩</span> R23_pres"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_defs <span class="main">=</span>
  R23_def R23_msgs_def R23_keys_def R23_pres_def


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The mediator function is the identity here.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">med32</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_obs <span class="main">⇒</span> m2_obs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med32</span> <span class="main">≡</span> id"</span></span>


<span class="keyword1"><span class="command">lemmas</span></span> R23_msgsI <span class="main">=</span> R23_msgs_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_intro<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_msgsE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> R23_msgs_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_elim<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_keysI <span class="main">=</span> R23_keys_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_intro<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_keysE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> R23_keys_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_elim<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_presI <span class="main">=</span> R23_pres_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_intro<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_presE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> R23_pres_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_elim<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_intros <span class="main">=</span> R23_msgsI R23_keysI R23_presI


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Simplifier lemmas for various instantiations (for keys).›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_keys_simp <span class="main">=</span> R23_keys_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_dest<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_keys_simps <span class="main">=</span>
  R23_keys_simp
  R23_keys_simp <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  R23_keys_simp <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">K'</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">K'</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  R23_keys_simp <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"insert <span class="free">K'</span> <span class="free">KK</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">K'</span> <span class="free">KK</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> _ conjI<span class="main">]</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹General lemmas›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹General facts about <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"abs_msg"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">declare</span></span> abs_msg.intros <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> abs_msg.cases <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main">!</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"abs_msg <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_Un <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"abs_msg <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> abs_msg <span class="free">G</span> <span class="main">∪</span> abs_msg <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_mono <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">m</span> <span class="main">∈</span> abs_msg <span class="free">G</span><span class="main">;</span> <span class="free">G</span> <span class="main">⊆</span> <span class="free">H</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">∈</span> abs_msg <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_insert_mono <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">m</span> <span class="main">∈</span> abs_msg <span class="free">H</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">∈</span> abs_msg <span class="main">(</span>insert <span class="free">m'</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Facts about <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"abs_msg"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> concerning abstraction of fakeable
messages. This is crucial for proving the refinement of the intruder event.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_DY_subset_fakeable<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> R23_msgs<span class="main">;</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> R23_keys<span class="main">;</span> <span class="free">t</span> <span class="main">∈</span> m3_inv1_lkeysec <span class="main">⟧</span>
  <span class="main">⟹</span> abs_msg <span class="main">(</span>synth <span class="main">(</span>analz <span class="main">(</span>IK <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> fake ik0 <span class="main">(</span>dom <span class="main">(</span>runs <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="comment1">― ‹4 subgoals, deal with replays first›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span> 1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
<span class="comment1">― ‹remaining 2 subgoals are real fakes›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fake_StatCh<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23_keys_simps<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement proof›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Pair decomposition. These were set to \texttt{elim!}, which is too
agressive here.›</span></span>

<span class="keyword1"><span class="command">declare</span></span> MPair_analz <span class="main">[</span><span class="operator">rule</span> <span class="quasi_keyword">del</span><span class="main">,</span> <span class="operator">elim</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> MPair_parts <span class="main">[</span><span class="operator">rule</span> <span class="quasi_keyword">del</span><span class="main">,</span> <span class="operator">elim</span><span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Protocol events.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step1_refines_m2_step1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
     <span class="main">(</span>m2_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step2_refines_m2_step2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
     <span class="main">(</span>m2_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step3_refines_m2_step3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23 <span class="main">∩</span> <span class="main">(</span>m2_inv3a_sesK_compr<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>m3_inv3_sesK_compr <span class="main">∩</span> m3_inv1_lkeysec<span class="main">)</span><span class="main">}</span>
     <span class="main">(</span>m2_step3 <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step3 <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R23_msgs"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R23_keys"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R23_pres"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> m2_inv3a_sesK_compr"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> m3_inv3_sesK_compr"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> m3_inv1_lkeysec"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">Kab</span> <span class="main">=</span> sesK <span class="main">(</span><span class="free">Rs</span><span class="main">$</span>sk<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Rs</span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">⦃</span> Agent <span class="free">A</span><span class="main">,</span> Agent <span class="free">B</span> <span class="main">⦄</span> <span class="main">∈</span> parts <span class="main">(</span>IK <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span><span class="main">=</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">⦇</span> runs <span class="main">:=</span> runs <span class="skolem">s</span><span class="main">(</span><span class="free">Rs</span> <span class="main">↦</span> <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNum <span class="main">(</span>clk <span class="skolem">t</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
          chan <span class="main">:=</span> insert <span class="main">(</span>Secure Sv <span class="free">A</span> <span class="main">(</span>Msg <span class="main">[</span>aAgt <span class="free">B</span><span class="main">,</span> aKey <span class="free">Kab</span><span class="main">,</span> aNum <span class="main">(</span>clk <span class="skolem">t</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
                 <span class="main">(</span>insert <span class="main">(</span>Secure Sv <span class="free">B</span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">,</span> aAgt <span class="free">A</span><span class="main">,</span> aNum <span class="main">(</span>clk <span class="skolem">t</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chan <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t'</span></span></span><span class="main">=</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">⦇</span> runs <span class="main">:=</span> runs <span class="skolem">t</span><span class="main">(</span><span class="free">Rs</span> <span class="main">↦</span> <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNum <span class="main">(</span>clk <span class="skolem">t</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
          IK <span class="main">:=</span> insert
                  <span class="main">(</span>Crypt <span class="main">(</span>shrK <span class="free">A</span><span class="main">)</span> <span class="main">⦃</span> Agent <span class="free">B</span><span class="main">,</span> Key <span class="free">Kab</span><span class="main">,</span> Number <span class="main">(</span>clk <span class="skolem">t</span><span class="main">)</span> <span class="main">⦄</span><span class="main">)</span>
                <span class="main">(</span>insert
                  <span class="main">(</span>Crypt <span class="main">(</span>shrK <span class="free">B</span><span class="main">)</span> <span class="main">⦃</span> Key <span class="free">Kab</span><span class="main">,</span> Agent <span class="free">A</span><span class="main">,</span> Number <span class="main">(</span>clk <span class="skolem">t</span><span class="main">)</span> <span class="main">⦄</span><span class="main">)</span>
                <span class="main">(</span>IK <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s'</span><span class="main">,</span> <span class="var">?t'</span><span class="main">)</span> <span class="main">∈</span> R23_msgs"</span></span> <span class="keyword1"><span class="command">using</span></span> H
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> R23_intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s'</span><span class="main">,</span> <span class="var">?t'</span><span class="main">)</span> <span class="main">∈</span> R23_keys"</span></span> <span class="keyword1"><span class="command">using</span></span> H
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> R23_intros<span class="main"><span class="keyword3">,</span></span>
            <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_inv3a_sesK_compr_simps m3_inv3_sesK_compr_simps<span class="main"><span class="keyword3">,</span></span>
            <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23_keys_simps<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s'</span><span class="main">,</span> <span class="var">?t'</span><span class="main">)</span> <span class="main">∈</span> R23_pres"</span></span> <span class="keyword1"><span class="command">using</span></span> H
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> R23_intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">note</span></span> calculation
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">by</span></span>  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step4_refines_m2_step4<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23 <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">(</span>m3_inv1_lkeysec<span class="main">)</span><span class="main">}</span>
     <span class="main">(</span>m2_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step5_refines_m2_step5<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
     <span class="main">(</span>m2_step5 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step5 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_tick_refines_m2_tick<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
     <span class="main">(</span>m2_tick <span class="free">T</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_tick <span class="free">T</span><span class="main">)</span>
   <span class="main">{&gt;</span>R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Intruder events.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_leak_refines_m2_leak<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
     <span class="main">(</span>m2_leak <span class="free">Rs</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_leak <span class="free">Rs</span><span class="main">)</span>
   <span class="main">{&gt;</span>R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs  <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23_keys_simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_DY_fake_refines_m2_fake<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23 <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">(</span>m3_inv1_lkeysec<span class="main">)</span><span class="main">}</span>
     m2_fake<span class="main">,</span> m3_DY_fake
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros
            <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> abs_msg.cases<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> abs_msg_DY_subset_fakeable <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span>
            <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> abs_msg.cases<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23_keys_simps<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All together now...›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_m3_trans_refines_m2_trans <span class="main">=</span>
  PO_m3_step1_refines_m2_step1 PO_m3_step2_refines_m2_step2
  PO_m3_step3_refines_m2_step3 PO_m3_step4_refines_m2_step4
  PO_m3_step5_refines_m2_step5 PO_m3_tick_refines_m2_tick
  PO_m3_leak_refines_m2_leak PO_m3_DY_fake_refines_m2_fake


<span class="keyword1"><span class="command">lemma</span></span> PO_m3_refines_init_m2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m3 <span class="main">⊆</span> R23<span class="main">``</span><span class="main">(</span>init m2<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_refines_trans_m2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23 <span class="main">∩</span> <span class="main">(</span>m2_inv3a_sesK_compr<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>m3_inv3_sesK_compr <span class="main">∩</span> m3_inv1_lkeysec<span class="main">)</span><span class="main">}</span>
     <span class="main">(</span>trans m2<span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans m3<span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m3_def m3_trans_def m2_def m2_trans_def<span class="main">)</span>
   <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_m3_trans_refines_m2_trans<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_observation_consistent <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"obs_consistent R23 med32 m2 m3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R23_def med32_def m3_defs<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement result.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m3_refines_m2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"refines
     <span class="main">(</span>R23 <span class="main">∩</span> <span class="main">(</span>m2_inv3a_sesK_compr<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>m3_inv1_lkeysec<span class="main">)</span><span class="main">)</span>
     med32 m2 m3"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"R23 <span class="main">∩</span> m2_inv3a_sesK_compr <span class="main">×</span> UNIV <span class="main">⊆</span> UNIV <span class="main">×</span> m3_inv3_sesK_compr"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23_def R23_keys_simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv3_sesK_comprI<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> Refinement_using_invariants<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m3_implements_m2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"implements med32 m2 m3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refinement_soundness<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="m3_ds">
<div class="head">
<h1>Theory m3_ds</h1>
</div>
<pre class="source"><span class="comment1">(*******************************************************************************

  Project: Development of Security Protocols by Refinement

  Module:  Key_establish/m3_ds.thy (Isabelle/HOL 2016-1)
  ID:      $Id: m3_ds.thy 132890 2016-12-24 10:25:57Z csprenge $
  Authors: Christoph Sprenger, ETH Zurich &lt;sprenger@inf.ethz.ch&gt;
           Ivano Somaini, ETH Zurich &lt;somainii@student.ethz.ch&gt;

  Key distribution protocols
  Level 3: Denning-Sacco protocol

  Copyright (c) 2009-2016 Christoph Sprenger, Ivano Somaini
  Licence: LGPL

*******************************************************************************)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Denning-Sacco protocol (L3)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> m3_ds <span class="keyword2"><span class="keyword">imports</span></span> <a href="m2_ds.html">m2_ds</a> <span class="quoted">"<a href="Message.html">../Refinement/Message</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
We model the Denning-Sacco protocol:
\[
\begin{array}{lll}
  \mathrm{M1.} &amp; A \rightarrow S: &amp; A, B \\ 
  \mathrm{M2.} &amp; S \rightarrow A: &amp; \{Kab, B, Ts, Na, \{Kab, A, Ts\}_{Kbs} \}_{Kas} \\
  \mathrm{M3.} &amp; A \rightarrow B: &amp; \{Kab, A, Ts\}_{Kbs}
\end{array}
\]
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Proof tool configuration. Avoid annoying automatic unfolding of
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>dom›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">declare</span></span> domIff <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">iff</span> <span class="quasi_keyword">del</span><span class="main">]</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Setup›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now we can define the initial key knowledge.›</span></span>

<span class="keyword1"><span class="command">overloading</span></span> ltkeySetup' <span class="main">≡</span> <span class="quoted">ltkeySetup</span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> ltkeySetup_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ltkeySetup'</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span>sharK <span class="bound">C</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span> <span class="main">|</span> <span class="bound">C</span> <span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">=</span> <span class="bound">C</span> <span class="main">∨</span> <span class="bound">A</span> <span class="main">=</span> Sv<span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> corrKey_shrK_bad <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"corrKey <span class="main">=</span> shrK<span class="main">`</span>bad"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> keySetup_def ltkeySetup_def corrKey_def<span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹State›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The secure channels are star-shaped to/from the server.  Therefore,
we have only one agent in the relation.›</span></span>

<span class="keyword1"><span class="command">record</span></span> m3_state <span class="main">=</span> <span class="quoted"><span class="quoted">"m1_state"</span></span> <span class="main">+</span>
  IK <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set"</span></span>                                <span class="comment1">― ‹intruder knowledge›</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Observable state:
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"runs"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"leak"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"clk"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">cache</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  m3_obs <span class="main">=</span> <span class="quoted"><span class="quoted">"m2_obs"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_obs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_state <span class="main">⇒</span> m3_obs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_obs</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> runs <span class="main">=</span> runs <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> leak <span class="main">=</span> leak <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> clk <span class="main">=</span> clk <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  m3_pred <span class="main">=</span> <span class="quoted"><span class="quoted">"m3_state set"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  m3_trans <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m3_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Events›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Protocol events.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">A</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m2_step1"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_step1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step1</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>                                 <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Ra›</span></span> is fresh›</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      IK <span class="main">:=</span> insert <span class="main">⦃</span>Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⦄</span> <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span>        <span class="comment1">― ‹send <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M1›</span></span>›</span>
    <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">B</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m2_step2"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_step2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step2</span> <span class="main">≡</span> m1_step2"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"Server"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m2_step3</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_step3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> key<span class="main">,</span> time<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step3</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>                           <span class="comment1">― ‹fresh server run›</span>
    <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="main">=</span> sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span> <span class="main">∧</span>                          <span class="comment1">― ‹fresh session key›</span>

    <span class="main">⦃</span>Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⦄</span> <span class="main">∈</span> IK <span class="bound">s</span> <span class="main">∧</span>                   <span class="comment1">― ‹recv <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M1›</span></span>›</span>
    <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">=</span> clk <span class="bound">s</span> <span class="main">∧</span>                                  <span class="comment1">― ‹fresh timestamp›</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="comment1">― ‹record session key and send <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M2›</span></span>›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">↦</span> <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      IK <span class="main">:=</span> insert <span class="main">(</span>Crypt <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>                        <span class="comment1">― ‹send <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M2›</span></span>›</span>
                     <span class="main">⦃</span>Key <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Number <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span>
                        Crypt <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">⦃</span>Key <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Number <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">⦄</span><span class="main">⦄</span><span class="main">)</span>
                   <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span>
    <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">A</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m2_step4</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_step4</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> key<span class="main">,</span> time<span class="main">,</span> msg<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step4</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>

     <span class="comment1">― ‹guards:›</span>
     runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>           <span class="comment1">― ‹key not yet recv'd›</span>

     Crypt <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>                                  <span class="comment1">― ‹recv <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M2›</span></span>›</span>
       <span class="main">⦃</span>Key <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Number <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">⦄</span> <span class="main">∈</span> IK <span class="bound">s</span> <span class="main">∧</span>

     <span class="comment1">― ‹check freshness of session key›</span>
     clk <span class="bound">s</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">+</span> Ls <span class="main">∧</span>

     <span class="comment1">― ‹actions:›</span>
     <span class="comment1">― ‹record session key and send <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M3›</span></span>›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
       runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
       IK <span class="main">:=</span> insert <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span>                         <span class="comment1">― ‹send <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M3›</span></span>›</span>
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">B</span>"</span><span class="antiquote">}</span></span>, refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m2_step5</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_step5</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>rid_t<span class="main">,</span> agent<span class="main">,</span> agent<span class="main">,</span> key<span class="main">,</span> time<span class="main">]</span> <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_step5</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">Kab</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>
     <span class="comment1">― ‹guards:›</span>
     runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">=</span> Some <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>             <span class="comment1">― ‹key not yet recv'd›</span>

     Crypt <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">⦃</span>Key <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Number <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">⦄</span> <span class="main">∈</span> IK <span class="bound">s</span> <span class="main">∧</span>    <span class="comment1">― ‹recv <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M3›</span></span>›</span>

     <span class="comment1">― ‹ensure freshness of session key; replays with fresh authenticator ok!›</span>
     clk <span class="bound">s</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="main">+</span> Ls <span class="main">∧</span>

     <span class="comment1">― ‹actions:›</span>
     <span class="comment1">― ‹record session key›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
       runs <span class="main">:=</span> <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rb</span></span></span> <span class="main">↦</span> <span class="main">(</span>Resp<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">Kab</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Clock tick event›</span></span>

<span class="keyword1"><span class="command">definition</span></span>   <span class="comment1">― ‹refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m2_tick"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_tick</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"time <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_tick</span> <span class="main">≡</span> m1_tick"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Session key compromise.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">m2_leak</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_leak</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rid_t <span class="main">⇒</span> m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_leak</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards:›</span>
    <span class="free"><span class="bound"><span class="entity">Rs</span></span></span> <span class="main">∈</span> dom <span class="main">(</span>runs <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
    fst <span class="main">(</span>the <span class="main">(</span>runs <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Serv <span class="main">∧</span>         <span class="comment1">― ‹compromise server run <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Rs›</span></span>›</span>

    <span class="comment1">― ‹actions:›</span>
    <span class="comment1">― ‹record session key as leaked and add it to intruder knowledge›</span>
    <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> leak <span class="main">:=</span> insert <span class="main">(</span>sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span> <span class="main">(</span>leak <span class="bound">s</span><span class="main">)</span><span class="main">,</span>
            IK <span class="main">:=</span> insert <span class="main">(</span>Key <span class="main">(</span>sesK <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Rs</span></span></span><span class="main">$</span>sk<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span> <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Intruder fake event. The following "Dolev-Yao" event generates all
intruder-derivable messages.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>     <span class="comment1">― ‹refines <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"m2_fake"</span><span class="antiquote">}</span></span>›</span>
  <span class="entity">m3_DY_fake</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_DY_fake</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s1</span><span class="main">)</span><span class="main">.</span>

     <span class="comment1">― ‹actions:›</span>
     <span class="bound">s1</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> IK <span class="main">:=</span> synth <span class="main">(</span>analz <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span>       <span class="comment1">― ‹take DY closure›</span>
  <span class="main">}</span>"</span></span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Transition system›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_init</span> <span class="main">≡</span> <span class="main">{</span> <span class="main">⦇</span>
     runs <span class="main">=</span> Map.empty<span class="main">,</span>
     leak <span class="main">=</span> shrK<span class="main">`</span>bad<span class="main">,</span>
     clk <span class="main">=</span> <span class="main">0</span><span class="main">,</span>
     IK <span class="main">=</span> Key<span class="main">`</span>shrK<span class="main">`</span>bad
  <span class="main">⦈</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_trans"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_trans</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">Ra</span> <span class="bound">Rb</span> <span class="bound">Rs</span> <span class="bound">Kab</span> <span class="bound">Ts</span> <span class="bound">T</span> <span class="bound">X</span><span class="main">.</span>
     m3_step1 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">∪</span>
     m3_step2 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">∪</span>
     m3_step3 <span class="bound">Rs</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Kab</span> <span class="bound">Ts</span> <span class="main">∪</span>
     m3_step4 <span class="bound">Ra</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Kab</span> <span class="bound">Ts</span> <span class="bound">X</span> <span class="main">∪</span>
     m3_step5 <span class="bound">Rb</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Kab</span> <span class="bound">Ts</span> <span class="main">∪</span>
     m3_tick <span class="bound">T</span> <span class="main">∪</span>
     m3_leak <span class="bound">Rs</span> <span class="main">∪</span>
     m3_DY_fake <span class="main">∪</span>
     Id
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m3_state<span class="main">,</span> m3_obs<span class="main">)</span> spec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3</span> <span class="main">≡</span> <span class="main">⦇</span>
    init <span class="main">=</span> m3_init<span class="main">,</span>
    trans <span class="main">=</span> m3_trans<span class="main">,</span>
    obs <span class="main">=</span> m3_obs
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_loc_defs <span class="main">=</span>
  m3_def m3_init_def m3_trans_def m3_obs_def
  m3_step1_def m3_step2_def m3_step3_def m3_step4_def m3_step5_def
  m3_tick_def m3_leak_def m3_DY_fake_def

<span class="keyword1"><span class="command">lemmas</span></span> m3_defs <span class="main">=</span> m3_loc_defs m2_defs


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Specialized injection that we can apply more aggressively.›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> analz_Inj_IK <span class="main">=</span> analz.Inj <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"IK <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">s</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> parts_Inj_IK <span class="main">=</span> parts.Inj <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> H<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"IK <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">s</span><span class="main">]</span>

<span class="keyword1"><span class="command">declare</span></span> parts_Inj_IK <span class="main">[</span><span class="operator">dest</span><span class="main"><span class="main">!</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">declare</span></span> analz_into_parts <span class="main">[</span><span class="operator">dest</span><span class="main">]</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv1: Secrecy of pre-distributed shared keys›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_inv1_lkeysec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_inv1_lkeysec</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">C</span><span class="main">.</span>
     <span class="main">(</span>Key <span class="main">(</span>shrK <span class="bound">C</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">C</span> <span class="main">∈</span> bad<span class="main">)</span> <span class="main">∧</span>
     <span class="main">(</span><span class="bound">C</span> <span class="main">∈</span> bad <span class="main">⟶</span> Key <span class="main">(</span>shrK <span class="bound">C</span><span class="main">)</span> <span class="main">∈</span> IK <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_inv1_lkeysecI <span class="main">=</span> m3_inv1_lkeysec_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv1_lkeysecE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m3_inv1_lkeysec_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv1_lkeysecD <span class="main">=</span> m3_inv1_lkeysec_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv1_lkeysec_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m3 <span class="main">⊆</span> m3_inv1_lkeysec"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv1_lkeysecI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv1_lkeysec_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m3_inv1_lkeysec<span class="main">}</span> trans m3 <span class="main">{&gt;</span> m3_inv1_lkeysec<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv1_lkeysecI<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Body<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv1_lkeysec <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m3 <span class="main">⊆</span> m3_inv1_lkeysec"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_incr<span class="main">)</span> <span class="main">(</span><span class="operator">fast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Useful simplifier lemmas›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m3_inv1_lkeysec_for_parts <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">s</span> <span class="main">∈</span> m3_inv1_lkeysec <span class="main">⟧</span> <span class="main">⟹</span> Key <span class="main">(</span>shrK <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>IK <span class="free">s</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">C</span> <span class="main">∈</span> bad"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> m3_inv1_lkeysec_for_analz <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">s</span> <span class="main">∈</span> m3_inv1_lkeysec <span class="main">⟧</span> <span class="main">⟹</span> Key <span class="main">(</span>shrK <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="free">s</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">C</span> <span class="main">∈</span> bad"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv2: Ticket shape for honestly encrypted M2›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_inv2_ticket</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_inv2_ticket</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">T</span> <span class="bound">K</span> <span class="bound">X</span><span class="main">.</span>
     <span class="bound">A</span> <span class="main">∉</span> bad <span class="main">⟶</span>
     Crypt <span class="main">(</span>shrK <span class="bound">A</span><span class="main">)</span> <span class="main">⦃</span>Key <span class="bound">K</span><span class="main">,</span> Agent <span class="bound">B</span><span class="main">,</span> Number <span class="bound">T</span><span class="main">,</span> <span class="bound">X</span><span class="main">⦄</span> <span class="main">∈</span> parts <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="bound">X</span> <span class="main">=</span> Crypt <span class="main">(</span>shrK <span class="bound">B</span><span class="main">)</span> <span class="main">⦃</span>Key <span class="bound">K</span><span class="main">,</span> Agent <span class="bound">A</span><span class="main">,</span> Number <span class="bound">T</span><span class="main">⦄</span> <span class="main">∧</span> <span class="bound">K</span> <span class="main">∈</span> range sesK
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_inv2_ticketI <span class="main">=</span> m3_inv2_ticket_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv2_ticketE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> m3_inv2_ticket_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv2_ticketD <span class="main">=</span> m3_inv2_ticket_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> -1<span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv2_ticket_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m3 <span class="main">⊆</span> m3_inv2_ticket"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv2_ticketI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv2_ticket_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m3_inv2_ticket <span class="main">∩</span> m3_inv1_lkeysec<span class="main">}</span> trans m3 <span class="main">{&gt;</span> m3_inv2_ticket<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv2_ticketI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m3_inv2_ticketD<span class="main">)</span>
<span class="comment1">― ‹2 subgoals, from step4›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> parts_cut<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> Body<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> m3_inv2_ticketD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv2_ticket <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m3 <span class="main">⊆</span> m3_inv2_ticket"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_incr<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹inv3: Session keys not used to encrypt other session keys›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Session keys are not used to encrypt other keys. Proof requires
generalization to sets of session keys.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">m3_inv3_sesK_compr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_pred"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m3_inv3_sesK_compr</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">K</span> <span class="bound">KK</span><span class="main">.</span>
     <span class="bound">KK</span> <span class="main">⊆</span> range sesK <span class="main">⟶</span>
     <span class="main">(</span>Key <span class="bound">K</span> <span class="main">∈</span> analz <span class="main">(</span>Key<span class="main">`</span><span class="bound">KK</span> <span class="main">∪</span> <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">K</span> <span class="main">∈</span> <span class="bound">KK</span> <span class="main">∨</span> Key <span class="bound">K</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="bound">s</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_inv3_sesK_comprI <span class="main">=</span> m3_inv3_sesK_compr_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv3_sesK_comprE <span class="main">=</span> m3_inv3_sesK_compr_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> m3_inv3_sesK_comprD <span class="main">=</span> m3_inv3_sesK_compr_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Additional lemma›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> insert_commute_Key <span class="main">=</span> insert_commute <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Key <span class="free">K</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">K</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> m3_inv3_sesK_compr_simps <span class="main">=</span>
  m3_inv3_sesK_comprD
  m3_inv3_sesK_comprD <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">Kab</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">Kab</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  m3_inv3_sesK_comprD <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"insert <span class="free">Kab</span> <span class="free">KK</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">Kab</span> <span class="free">KK</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  insert_commute_Key    <span class="comment1">― ‹to get the keys to the front›</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invariance proof.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv3_sesK_compr_step4<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m3_inv3_sesK_compr <span class="main">∩</span> m3_inv2_ticket <span class="main">∩</span> m3_inv1_lkeysec<span class="main">}</span>
      m3_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">X</span>
   <span class="main">{&gt;</span> m3_inv3_sesK_compr<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">K</span> <span class="skolem">KK</span> <span class="skolem">s</span>
    <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> m3_inv1_lkeysec"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> m3_inv3_sesK_compr"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> m3_inv2_ticket"</span></span>
      <span class="quoted"><span class="quoted">"runs <span class="skolem">s</span> <span class="free">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">KK</span> <span class="main">⊆</span> range sesK"</span></span>
      <span class="quoted"><span class="quoted">"Crypt <span class="main">(</span>shrK <span class="free">A</span><span class="main">)</span> <span class="main">⦃</span>Key <span class="free">Kab</span><span class="main">,</span> Agent <span class="free">B</span><span class="main">,</span> Number <span class="free">Ts</span><span class="main">,</span> <span class="free">X</span><span class="main">⦄</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>Key <span class="skolem">K</span> <span class="main">∈</span> analz <span class="main">(</span>insert <span class="free">X</span> <span class="main">(</span>Key <span class="main">`</span> <span class="skolem">KK</span> <span class="main">∪</span> IK <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">(</span><span class="skolem">K</span> <span class="main">∈</span> <span class="skolem">KK</span> <span class="main">∨</span> Key <span class="skolem">K</span> <span class="main">∈</span> analz <span class="main">(</span>insert <span class="free">X</span> <span class="main">(</span>IK <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> bad"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">note</span></span> H
      <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">∈</span> bad›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Decrypt<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> analz <span class="main">(</span>Key <span class="main">`</span> <span class="skolem">KK</span> <span class="main">∪</span> IK <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> analz_mono <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main"><span class="main">[</span></span></span>2<span class="main"><span class="main"><span class="main">]</span></span></span> rev_subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m3_inv3_sesK_compr_simps analz_insert_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> H
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m3_inv3_sesK_compr_simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv2_ticketD <span class="main"><span class="main">[</span></span><span class="operator">OF</span> analz_into_parts<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv3_sesK_comprI <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> analz_Inj_IK<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All together now.›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_m3_inv3_sesK_compr_trans_lemmas <span class="main">=</span>
  PO_m3_inv3_sesK_compr_step4

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv3_sesK_compr_init <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m3 <span class="main">⊆</span> m3_inv3_sesK_compr"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv3_sesK_comprI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv3_sesK_compr_trans <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>m3_inv3_sesK_compr <span class="main">∩</span> m3_inv2_ticket <span class="main">∩</span> m3_inv1_lkeysec<span class="main">}</span>
     trans m3
   <span class="main">{&gt;</span> m3_inv3_sesK_compr<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m3_def m3_trans_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_m3_inv3_sesK_compr_trans_lemmas<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs m3_defs m3_inv3_sesK_compr_simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv3_sesK_comprI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_inv3_sesK_compr <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach m3 <span class="main">⊆</span> m3_inv3_sesK_compr"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> J<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"m3_inv2_ticket <span class="main">∩</span> m3_inv1_lkeysec"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> inv_rule_incr<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Message abstraction and simulation relation›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Abstraction function on sets of messages.›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span>
  <span class="entity">abs_msg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set <span class="main">⇒</span> chmsg set"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">H</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  am_M1<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⦃</span>Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⦄</span> <span class="main">∈</span> <span class="free">H</span>
  <span class="main">⟹</span> Insec <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>Msg <span class="main">[]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">abs_msg</span> <span class="free">H</span>"</span></span>
<span class="main">|</span> am_M2a<span class="main">:</span>
    <span class="quoted"><span class="quoted">"Crypt <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">⦃</span>Key <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> Number <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">⦄</span> <span class="main">∈</span> <span class="free">H</span>
  <span class="main">⟹</span> Secure Sv <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aAgt <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> aKey <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">abs_msg</span> <span class="free">H</span>"</span></span>
<span class="main">|</span> am_M2b<span class="main">:</span>
    <span class="quoted"><span class="quoted">"Crypt <span class="main">(</span>shrK <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">⦃</span>Key <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">,</span> Agent <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> Number <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">⦄</span> <span class="main">∈</span> <span class="free">H</span>
  <span class="main">⟹</span> Secure Sv <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">,</span> aAgt <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> aNum <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">abs_msg</span> <span class="free">H</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹R23: The simulation relation. This is a data refinement of
the insecure and secure channels of refinement 2.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R23_msgs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R23_msgs</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> abs_msg <span class="main">(</span>parts <span class="main">(</span>IK <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> chan <span class="bound">s</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R23_keys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R23_keys</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">KK</span> <span class="bound">K</span><span class="main">.</span> <span class="bound">KK</span> <span class="main">⊆</span> range sesK <span class="main">⟶</span>
     Key <span class="bound">K</span> <span class="main">∈</span> analz <span class="main">(</span>Key<span class="main">`</span><span class="bound">KK</span> <span class="main">∪</span> <span class="main">(</span>IK <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> aKey <span class="bound">K</span> <span class="main">∈</span> extr <span class="main">(</span>aKey<span class="main">`</span><span class="bound">KK</span> <span class="main">∪</span> ik0<span class="main">)</span> <span class="main">(</span>chan <span class="bound">s</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R23_pres</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R23_pres</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> runs <span class="bound">s</span> <span class="main">=</span> runs <span class="bound">t</span> <span class="main">∧</span> clk <span class="bound">s</span> <span class="main">=</span> clk <span class="bound">t</span> <span class="main">∧</span> leak <span class="bound">s</span> <span class="main">=</span> leak <span class="bound">t</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">R23</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>m2_state <span class="main">×</span> m3_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">R23</span> <span class="main">≡</span> R23_msgs <span class="main">∩</span> R23_keys <span class="main">∩</span> R23_pres"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_defs <span class="main">=</span>
  R23_def R23_msgs_def R23_keys_def R23_pres_def


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The mediator function is the identity here.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">med32</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"m3_obs <span class="main">⇒</span> m2_obs"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">med32</span> <span class="main">≡</span> id"</span></span>


<span class="keyword1"><span class="command">lemmas</span></span> R23_msgsI <span class="main">=</span> R23_msgs_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_intro<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_msgsE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> R23_msgs_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_elim<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_keysI <span class="main">=</span> R23_keys_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_intro<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_keysE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> R23_keys_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_elim<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_presI <span class="main">=</span> R23_pres_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_intro<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_presE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> R23_pres_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_elim<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_intros <span class="main">=</span> R23_msgsI R23_keysI R23_presI


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lemmas for various instantiations (for keys).›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> R23_keys_dest <span class="main">=</span> R23_keys_def <span class="main">[</span><span class="operator">THEN</span> rel_def_to_dest<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">rotated</span> 2<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> R23_keys_dests <span class="main">=</span>
  R23_keys_dest
  R23_keys_dest <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  R23_keys_dest <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">K'</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">K'</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  R23_keys_dest <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> KK<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"insert <span class="free">K'</span> <span class="free">KK</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">K'</span> <span class="free">KK</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> _ _ conjI<span class="main">]</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹General lemmas›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹General facts about <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"abs_msg"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">declare</span></span> abs_msg.intros <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> abs_msg.cases <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main">!</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"abs_msg <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_Un <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"abs_msg <span class="main">(</span><span class="free">G</span> <span class="main">∪</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> abs_msg <span class="free">G</span> <span class="main">∪</span> abs_msg <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_mono <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">m</span> <span class="main">∈</span> abs_msg <span class="free">G</span><span class="main">;</span> <span class="free">G</span> <span class="main">⊆</span> <span class="free">H</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">∈</span> abs_msg <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_insert_mono <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">m</span> <span class="main">∈</span> abs_msg <span class="free">H</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">∈</span> abs_msg <span class="main">(</span>insert <span class="free">m'</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Facts about <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"abs_msg"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> concerning abstraction of fakeable
messages. This is crucial for proving the refinement of the intruder event.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> abs_msg_DY_subset_fakeable<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> R23_msgs<span class="main">;</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> R23_keys<span class="main">;</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R23_non</span><span class="main">;</span> <span class="free">t</span> <span class="main">∈</span> m3_inv1_lkeysec <span class="main">⟧</span>
  <span class="main">⟹</span> abs_msg <span class="main">(</span>synth <span class="main">(</span>analz <span class="main">(</span>IK <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> fake ik0 <span class="main">(</span>dom <span class="main">(</span>runs <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chan <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="comment1">― ‹4 subgoals, deal with replays first›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span> 1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
<span class="comment1">― ‹remaining 2 subgoals are real fakes›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fake_StatCh<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> R23_keys_dests<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement proof›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Pair decomposition. These were set to \texttt{elim!}, which is too
agressive here.›</span></span>

<span class="keyword1"><span class="command">declare</span></span> MPair_analz <span class="main">[</span><span class="operator">rule</span> <span class="quasi_keyword">del</span><span class="main">,</span> <span class="operator">elim</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> MPair_parts <span class="main">[</span><span class="operator">rule</span> <span class="quasi_keyword">del</span><span class="main">,</span> <span class="operator">elim</span><span class="main">]</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Protocol events.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step1_refines_m2_step1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
     <span class="main">(</span>m2_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step1 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step2_refines_m2_step2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
     <span class="main">(</span>m2_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step2 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step3_refines_m2_step3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23 <span class="main">∩</span> <span class="main">(</span>m2_inv3a_sesK_compr<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>m3_inv3_sesK_compr <span class="main">∩</span> m3_inv1_lkeysec<span class="main">)</span><span class="main">}</span>
     <span class="main">(</span>m2_step3 <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step3 <span class="free">Rs</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R23_msgs"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R23_keys"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R23_pres"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> m2_inv3a_sesK_compr"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> m3_inv3_sesK_compr"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> m3_inv1_lkeysec"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">Kab</span> <span class="main">=</span> sesK <span class="main">(</span><span class="free">Rs</span><span class="main">$</span>sk<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Rs</span> <span class="main">∉</span> dom <span class="main">(</span>runs <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">⦃</span>Agent <span class="free">A</span><span class="main">,</span> Agent <span class="free">B</span><span class="main">⦄</span> <span class="main">∈</span> parts <span class="main">(</span>IK <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span><span class="main">=</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">⦇</span> runs <span class="main">:=</span> runs <span class="skolem">s</span><span class="main">(</span><span class="free">Rs</span> <span class="main">↦</span> <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNum <span class="main">(</span>clk <span class="skolem">t</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
          chan <span class="main">:=</span> insert <span class="main">(</span>Secure Sv <span class="free">A</span> <span class="main">(</span>Msg <span class="main">[</span>aAgt <span class="free">B</span><span class="main">,</span> aKey <span class="free">Kab</span><span class="main">,</span> aNum <span class="main">(</span>clk <span class="skolem">t</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
                 <span class="main">(</span>insert <span class="main">(</span>Secure Sv <span class="free">B</span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">,</span> aAgt <span class="free">A</span><span class="main">,</span> aNum <span class="main">(</span>clk <span class="skolem">t</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chan <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t'</span></span></span><span class="main">=</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">⦇</span> runs <span class="main">:=</span> runs <span class="skolem">t</span><span class="main">(</span><span class="free">Rs</span> <span class="main">↦</span> <span class="main">(</span>Serv<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aNum <span class="main">(</span>clk <span class="skolem">t</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
          IK <span class="main">:=</span> insert
                  <span class="main">(</span>Crypt <span class="main">(</span>shrK <span class="free">A</span><span class="main">)</span>
                     <span class="main">⦃</span> Key <span class="free">Kab</span><span class="main">,</span> Agent <span class="free">B</span><span class="main">,</span> Number <span class="main">(</span>clk <span class="skolem">t</span><span class="main">)</span><span class="main">,</span>
                       Crypt <span class="main">(</span>shrK <span class="free">B</span><span class="main">)</span> <span class="main">⦃</span> Key <span class="free">Kab</span><span class="main">,</span> Agent <span class="free">A</span><span class="main">,</span> Number <span class="main">(</span>clk <span class="skolem">t</span><span class="main">)</span> <span class="main">⦄</span><span class="main">⦄</span><span class="main">)</span>
                  <span class="main">(</span>IK <span class="skolem">t</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s'</span><span class="main">,</span> <span class="var">?t'</span><span class="main">)</span> <span class="main">∈</span> R23_msgs"</span></span> <span class="keyword1"><span class="command">using</span></span> H
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> R23_intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s'</span><span class="main">,</span> <span class="var">?t'</span><span class="main">)</span> <span class="main">∈</span> R23_keys"</span></span> <span class="keyword1"><span class="command">using</span></span> H
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> R23_intros<span class="main"><span class="keyword3">,</span></span>
            <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m2_inv3a_sesK_compr_simps m3_inv3_sesK_compr_simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> R23_keys_dests<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s'</span><span class="main">,</span> <span class="var">?t'</span><span class="main">)</span> <span class="main">∈</span> R23_pres"</span></span> <span class="keyword1"><span class="command">using</span></span> H
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> R23_intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">note</span></span> calculation
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step4_refines_m2_step4<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23 <span class="main">∩</span>
    UNIV <span class="main">×</span> <span class="main">(</span>m3_inv3_sesK_compr <span class="main">∩</span> m3_inv2_ticket <span class="main">∩</span> m3_inv1_lkeysec<span class="main">)</span><span class="main">}</span>
     <span class="main">(</span>m2_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step4 <span class="free">Ra</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span> <span class="free">X</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R23_msgs"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R23_keys"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R23_pres"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> m3_inv3_sesK_compr"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> m3_inv2_ticket"</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> m3_inv1_lkeysec"</span></span>
      <span class="quoted"><span class="quoted">"runs <span class="skolem">t</span> <span class="free">Ra</span> <span class="main">=</span> Some <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"Crypt <span class="main">(</span>shrK <span class="free">A</span><span class="main">)</span> <span class="main">⦃</span>Key <span class="free">Kab</span><span class="main">,</span> Agent <span class="free">B</span><span class="main">,</span> Number <span class="free">Ts</span><span class="main">,</span> <span class="free">X</span><span class="main">⦄</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">⦇</span> runs <span class="main">:=</span> runs <span class="skolem">s</span><span class="main">(</span><span class="free">Ra</span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">,</span> aNum <span class="free">Ts</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?t'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">⦇</span> runs <span class="main">:=</span> runs <span class="skolem">t</span><span class="main">(</span><span class="free">Ra</span> <span class="main">↦</span> <span class="main">(</span>Init<span class="main">,</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">,</span> aNum <span class="free">Ts</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
                 IK <span class="main">:=</span> insert <span class="free">X</span>  <span class="main">(</span>IK <span class="skolem">t</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> H <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"Secure Sv <span class="free">A</span> <span class="main">(</span>Msg <span class="main">[</span>aAgt <span class="free">B</span><span class="main">,</span> aKey <span class="free">Kab</span><span class="main">,</span> aNum <span class="free">Ts</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> parts <span class="main">(</span>IK <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> H
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Body MPair_parts<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s'</span><span class="main">,</span> <span class="var">?t'</span><span class="main">)</span> <span class="main">∈</span> R23_msgs"</span></span> <span class="keyword1"><span class="command">using</span></span> H
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s'</span><span class="main">,</span> <span class="var">?t'</span><span class="main">)</span> <span class="main">∈</span> R23_keys"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> bad"</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">note</span></span> H
      <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">∈</span> bad›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">drule</span> Decrypt<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> R23_intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> analz_cut <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> analz_monotonic<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∉</span> bad"</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">note</span></span> H
      <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">∉</span> bad›</span></span> <span class="keyword1"><span class="command">have</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> Crypt <span class="main">(</span>shrK <span class="free">B</span><span class="main">)</span> <span class="main">⦃</span>Key <span class="free">Kab</span><span class="main">,</span> Agent <span class="free">A</span><span class="main">,</span> Number <span class="free">Ts</span> <span class="main">⦄</span> <span class="main">∧</span> <span class="free">Kab</span> <span class="main">∈</span> range sesK"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> m3_inv2_ticketD<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> H1<span class="main">:</span> <span class="quoted"><span class="quoted">"Key <span class="main">(</span>shrK <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> analz <span class="main">(</span>IK <span class="skolem">t</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"aKey <span class="free">Kab</span> <span class="main">∈</span> extr ik0 <span class="main">(</span>chan <span class="skolem">s</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">note</span></span> calculation
          <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"Secure Sv <span class="free">B</span> <span class="main">(</span>Msg <span class="main">[</span>aKey <span class="free">Kab</span><span class="main">,</span> aAgt <span class="free">A</span><span class="main">,</span> aNum <span class="free">Ts</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> chan <span class="skolem">s</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">drule</span> analz_into_parts<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> Body<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> MPair_parts<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> H1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> R23_intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m3_inv3_sesK_compr_simps<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?s'</span><span class="main">,</span> <span class="var">?t'</span><span class="main">)</span> <span class="main">∈</span> R23_pres"</span></span> <span class="keyword1"><span class="command">using</span></span> H
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">note</span></span> calculation
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> analz_Inj_IK<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_step5_refines_m2_step5<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
     <span class="main">(</span>m2_step5 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_step5 <span class="free">Rb</span> <span class="free">A</span> <span class="free">B</span> <span class="free">Kab</span> <span class="free">Ts</span><span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_tick_refines_m2_tick<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
    <span class="main">(</span>m2_tick <span class="free">T</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_tick <span class="free">T</span><span class="main">)</span>
   <span class="main">{&gt;</span>R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Intruder events.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_leak_refines_m2_leak<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23<span class="main">}</span>
    <span class="main">(</span>m2_leak <span class="free">Rs</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>m3_leak <span class="free">Rs</span><span class="main">)</span>
   <span class="main">{&gt;</span>R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> R23_keys_dests<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_DY_fake_refines_m2_fake<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23 <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">(</span>m3_inv1_lkeysec<span class="main">)</span><span class="main">}</span>
     m2_fake<span class="main">,</span> m3_DY_fake
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs R23_def m3_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> abs_msg.cases<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> abs_msg_DY_subset_fakeable <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> abs_msg.cases
            <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> R23_keys_dests<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All together now...›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_m3_trans_refines_m2_trans <span class="main">=</span>
  PO_m3_step1_refines_m2_step1 PO_m3_step2_refines_m2_step2
  PO_m3_step3_refines_m2_step3 PO_m3_step4_refines_m2_step4
  PO_m3_step5_refines_m2_step5 PO_m3_tick_refines_m2_tick
  PO_m3_leak_refines_m2_leak PO_m3_DY_fake_refines_m2_fake


<span class="keyword1"><span class="command">lemma</span></span> PO_m3_refines_init_m2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"init m3 <span class="main">⊆</span> R23<span class="main">``</span><span class="main">(</span>init m2<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R23_def m3_defs ik0_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> R23_intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_refines_trans_m2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>R23 <span class="main">∩</span>
    <span class="main">(</span>m2_inv3a_sesK_compr<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>m3_inv3_sesK_compr <span class="main">∩</span> m3_inv2_ticket <span class="main">∩</span> m3_inv1_lkeysec<span class="main">)</span><span class="main">}</span>
     <span class="main">(</span>trans m2<span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans m3<span class="main">)</span>
   <span class="main">{&gt;</span> R23<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m3_def m3_trans_def m2_def m2_trans_def<span class="main">)</span>
   <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_m3_trans_refines_m2_trans<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_m3_observation_consistent <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"obs_consistent R23 med32 m2 m3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def R23_def med32_def m3_defs<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement result.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m3_refines_m2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"refines
     <span class="main">(</span>R23 <span class="main">∩</span> <span class="main">(</span>m2_inv3a_sesK_compr<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>m3_inv3_sesK_compr <span class="main">∩</span> m3_inv2_ticket <span class="main">∩</span> m3_inv1_lkeysec<span class="main">)</span><span class="main">)</span>
     med32 m2 m3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Refinement_using_invariants<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> m3_implements_m2 <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"implements med32 m2 m3"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refinement_soundness<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div>