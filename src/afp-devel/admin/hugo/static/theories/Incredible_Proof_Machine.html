<div id="Indexed_FSet">
<div class="head">
<h1>Theory Indexed_FSet</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Indexed_FSet
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/FSet.html">HOL-Library.FSet</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹It is convenient to address the members of a finite set by a natural number, and
also to convert a finite set to a list.›</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">includes</span></span> fset.lifting
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> fset_from_list <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">=&gt;</span> <span class="tfree">'a</span> fset"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">set</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_set<span class="main">)</span>
<span class="keyword1" id="Indexed_FSet-mem_fset_from_list"><span class="command">lemma</span></span> mem_fset_from_list<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">|∈|</span> fset_from_list <span class="free">l</span>  <span class="main">⟷</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">rule</span>
<span class="keyword1" id="Indexed_FSet-fimage_fset_from_list"><span class="command">lemma</span></span> fimage_fset_from_list<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">|`|</span> fset_from_list <span class="free">l</span> <span class="main">=</span> fset_from_list <span class="main">(</span>map <span class="free">f</span> <span class="free">l</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1" id="Indexed_FSet-fset_fset_from_list"><span class="command">lemma</span></span> fset_fset_from_list<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fset <span class="main">(</span>fset_from_list <span class="free">l</span><span class="main">)</span> <span class="main">=</span> set <span class="free">l</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemmas</span></span> fset_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> set_simps<span class="main">[</span><span class="operator">Transfer.transferred</span><span class="main">]</span>
<span class="keyword1" id="Indexed_FSet-size_fset_from_list"><span class="command">lemma</span></span> size_fset_from_list<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">l</span> <span class="main">⟹</span> size <span class="main">(</span>fset_from_list <span class="free">l</span><span class="main">)</span> <span class="main">=</span> length <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">list_of_fset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> fset <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">list_of_fset</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">l</span><span class="main">.</span> fset_from_list <span class="bound">l</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> distinct <span class="bound">l</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Indexed_FSet-fset_from_list_of_fset"><span class="command">lemma</span></span> fset_from_list_of_fset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fset_from_list <span class="main">(</span>list_of_fset <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> distinct_list_of_fset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>list_of_fset <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> atomize_conj list_of_fset_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> someI_ex<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> finite_distinct_list<span class="main">)</span>

<span class="keyword1" id="Indexed_FSet-length_list_of_fset"><span class="command">lemma</span></span> length_list_of_fset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>list_of_fset <span class="free">s</span><span class="main">)</span> <span class="main">=</span> size <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> distinct_list_of_fset fset_from_list_of_fset size_fset_from_list<span class="main">)</span>

<span class="keyword1" id="Indexed_FSet-nth_list_of_fset_mem"><span class="command">lemma</span></span> nth_list_of_fset_mem<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> size <span class="free">s</span> <span class="main">⟹</span> list_of_fset <span class="free">s</span> <span class="main">!</span> <span class="free">i</span> <span class="main">|∈|</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fset_from_list_of_fset length_list_of_fset mem_fset_from_list nth_mem<span class="main">)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">indexed_fmember</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> fset <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">|∈|⇘</span>_<span class="keyword1">⇙</span> _"</span> <span class="main">[</span>50<span class="main">,</span>50<span class="main">,</span>50<span class="main">]</span> 50 <span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> size <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> list_of_fset <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> |∈|<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">i</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1" id="Indexed_FSet-indexed_fmember_is_fmember"><span class="command">lemma</span></span> indexed_fmember_is_fmember<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> |∈|<span class="hidden">⇘</span><sub><span class="free">i</span></sub><span class="hidden">⇙</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">|∈|</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> indexed_fmember.induct<span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span> <span class="skolem">s</span><span class="main">)</span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>list_of_fset <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_list_of_fset<span class="main">)</span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"list_of_fset <span class="skolem">s</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∈</span> set <span class="main">(</span>list_of_fset <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nth_mem<span class="main">)</span>
   <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"list_of_fset <span class="skolem">s</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">|∈|</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mem_fset_from_list fset_from_list_of_fset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1" id="Indexed_FSet-fmember_is_indexed_fmember"><span class="command">lemma</span></span> fmember_is_indexed_fmember<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">|∈|</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="free">x</span> |∈|<span class="hidden">⇘</span><sub><span class="bound">i</span></sub><span class="hidden">⇙</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>list_of_fset <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mem_fset_from_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>list_of_fset <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> list_of_fset <span class="free">s</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> |∈|<span class="hidden">⇘</span><sub><span class="skolem">i</span></sub><span class="hidden">⇙</span> <span class="free">s</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> indexed_fmember.simps<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Indexed_FSet-indexed_fmember_unique"><span class="command">lemma</span></span> indexed_fmember_unique<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> |∈|<span class="hidden">⇘</span><sub><span class="free">i</span></sub><span class="hidden">⇙</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">y</span> |∈|<span class="hidden">⇘</span><sub><span class="free">j</span></sub><span class="hidden">⇙</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">i</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> distinct_list_of_fset indexed_fmember.cases length_list_of_fset nth_eq_iff_index_eq<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">indexed_members</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> fset <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">indexed_members</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> zip <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>size <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">]</span> <span class="main">(</span>list_of_fset <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Indexed_FSet-mem_set_indexed_members"><span class="command">lemma</span></span> mem_set_indexed_members<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">x</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>indexed_members <span class="free">s</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">x</span> |∈|<span class="hidden">⇘</span><sub><span class="free">i</span></sub><span class="hidden">⇙</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> indexed_members_def indexed_fmember.simps
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_zip<span class="main">)</span>

<span class="keyword1" id="Indexed_FSet-mem_set_indexed_members'"><span class="command">lemma</span></span> mem_set_indexed_members'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> set <span class="main">(</span>indexed_members <span class="free">s</span><span class="main">)</span> <span class="main">⟷</span> snd <span class="free">t</span> |∈|<span class="hidden">⇘</span><sub>fst <span class="free">t</span></sub><span class="hidden">⇙</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mem_set_indexed_members<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fnth</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">|!|</span>"</span> 100<span class="main">)</span>  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="free">|!|</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> list_of_fset <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>
<span class="keyword1" id="Indexed_FSet-fnth_indexed_fmember"><span class="command">lemma</span></span> fnth_indexed_fmember<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> size <span class="free">s</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">|!|</span> <span class="free">i</span> |∈|<span class="hidden">⇘</span><sub><span class="free">i</span></sub><span class="hidden">⇙</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fnth_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> indexed_fmember.intros<span class="main">)</span>
<span class="keyword1" id="Indexed_FSet-indexed_fmember_fnth"><span class="command">lemma</span></span> indexed_fmember_fnth<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> |∈|<span class="hidden">⇘</span><sub><span class="free">i</span></sub><span class="hidden">⇙</span> <span class="free">s</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">s</span> <span class="main">|!|</span> <span class="free">i</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">&lt;</span> size <span class="free">s</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">unfolding</span></span> fnth_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> indexed_fmember.simps<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fidx</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> fset <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fidx</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">i</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> |∈|<span class="hidden">⇘</span><sub><span class="bound">i</span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Indexed_FSet-fidx_eq"><span class="command">lemma</span></span> fidx_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> |∈|<span class="hidden">⇘</span><sub><span class="free">i</span></sub><span class="hidden">⇙</span> <span class="free">s</span> <span class="main">⟹</span> fidx <span class="free">s</span> <span class="free">x</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fidx_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> someI2<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> indexed_fmember_fnth fnth_def nth_eq_iff_index_eq<span class="main">)</span>

<span class="keyword1" id="Indexed_FSet-fidx_inj"><span class="command">lemma</span></span> fidx_inj<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">|∈|</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">|∈|</span> <span class="free">s</span> <span class="main">⟹</span> fidx <span class="free">s</span> <span class="free">x</span> <span class="main">=</span> fidx <span class="free">s</span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fmember_is_indexed_fmember <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> indexed_fmember_unique<span class="main">)</span>

<span class="keyword1" id="Indexed_FSet-inj_on_fidx"><span class="command">lemma</span></span> inj_on_fidx<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>fidx <span class="free">vertices</span><span class="main">)</span> <span class="main">(</span>fset <span class="free">vertices</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inj_onI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fmember.rep_eq <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Abstract_Formula">
<div class="head">
<h1>Theory Abstract_Formula</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Abstract_Formula
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../../HOL/HOL/Main.html">Main</a>
  <span class="quoted">"<a href="../../HOL/HOL-Library/FSet.html">HOL-Library.FSet</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Stream.html">HOL-Library.Stream</a>"</span>
  <a href="Indexed_FSet.html">Indexed_FSet</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The following locale describes an abstract interface for a set of formulas, without fixing the
concret shape, or set of variables.

The variables mentioned in this locale are only the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">emph</span></span> ‹locally fixed constants›<span class="antiquote"><span class="antiquote">}</span></span></span></span> occurring in
formulas, e.g.\@ in the introduction rule for the universal quantifier. Normal variables are not
something we care about at this point; they are handled completely abstractly by the abstract notion
of a substitution.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Abstract_Formulas <span class="main">=</span>
  <span class="comment1">― ‹Variables can be renamed injectively›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">freshenLC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'var</span>"</span></span>
  <span class="comment1">― ‹A variable-changing function can be mapped over a formula›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">renameLCs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'var</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'form</span> <span class="main">⇒</span> <span class="tfree">'form</span><span class="main">)</span>"</span></span>
  <span class="comment1">― ‹The set of variables occurring in a formula›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">lconsts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> <span class="main">⇒</span> <span class="tfree">'var</span> set"</span></span>
  <span class="comment1">― ‹A closed formula has no variables, and substitions do not affect it.›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">closed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> <span class="main">⇒</span> bool"</span></span>
  <span class="comment1">― ‹A substitution can be applied to a formula.›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'subst</span> <span class="main">⇒</span> <span class="tfree">'form</span> <span class="main">⇒</span> <span class="tfree">'form</span>"</span></span>
  <span class="comment1">― ‹The set of variables occurring (in the image) of a substitution.›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subst_lconsts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'subst</span> <span class="main">⇒</span> <span class="tfree">'var</span> set"</span></span>
  <span class="comment1">― ‹A variable-changing function can be mapped over a substitution›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subst_renameLCs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'var</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'subst</span> <span class="main">⇒</span> <span class="tfree">'subst</span><span class="main">)</span>"</span></span>
  <span class="comment1">― ‹A most generic formula, can be substitutied to anything.›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">anyP</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span>"</span></span>

  <span class="keyword2"><span class="keyword">assumes</span></span> freshenLC_eq_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">freshenLC</span> <span class="free">a</span> <span class="free">v</span> <span class="main">=</span> <span class="free">freshenLC</span> <span class="free">a'</span> <span class="free">v'</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">=</span> <span class="free">a'</span> <span class="main">∧</span> <span class="free">v</span> <span class="main">=</span> <span class="free">v'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lconsts_renameLCs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lconsts</span> <span class="main">(</span><span class="free">renameLCs</span> <span class="free">p</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span> <span class="main">`</span> <span class="free">lconsts</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rename_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lconsts</span> <span class="free">f</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="free">renameLCs</span> <span class="free">p</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> subst_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">closed</span> <span class="free">f</span> <span class="main">⟹</span> <span class="free">subst</span> <span class="free">s</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> closed_no_lconsts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">closed</span> <span class="free">f</span> <span class="main">⟹</span> <span class="free">lconsts</span> <span class="free">f</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fv_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lconsts</span> <span class="main">(</span><span class="free">subst</span> <span class="free">s</span> <span class="free">f</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">lconsts</span> <span class="free">f</span> <span class="main">∪</span> <span class="free">subst_lconsts</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rename_rename<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">renameLCs</span> <span class="free">p1</span> <span class="main">(</span><span class="free">renameLCs</span> <span class="free">p2</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="free">renameLCs</span> <span class="main">(</span><span class="free">p1</span> <span class="main">∘</span> <span class="free">p2</span><span class="main">)</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rename_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">renameLCs</span> <span class="free">p</span> <span class="main">(</span><span class="free">subst</span> <span class="free">s</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="free">subst</span> <span class="main">(</span><span class="free">subst_renameLCs</span> <span class="free">p</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">renameLCs</span> <span class="free">p</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> renameLCs_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">lconsts</span> <span class="free">f</span> <span class="main">⟹</span> <span class="free">f1</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f2</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">renameLCs</span> <span class="free">f1</span> <span class="free">f</span> <span class="main">=</span> <span class="free">renameLCs</span> <span class="free">f2</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> subst_renameLCs_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">subst_lconsts</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">f1</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f2</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">subst_renameLCs</span> <span class="free">f1</span> <span class="free">s</span> <span class="main">=</span> <span class="free">subst_renameLCs</span> <span class="free">f2</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> subst_lconsts_subst_renameLCs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">subst_lconsts</span> <span class="main">(</span><span class="free">subst_renameLCs</span> <span class="free">p</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span> <span class="main">`</span> <span class="free">subst_lconsts</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lconsts_anyP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lconsts</span> <span class="free">anyP</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> empty_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">f</span><span class="main">.</span> <span class="free">subst</span> <span class="bound">s</span> <span class="bound">f</span> <span class="main">=</span> <span class="bound">f</span><span class="main">)</span> <span class="main">∧</span> <span class="free">subst_lconsts</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> anyP_is_any<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">s</span><span class="main">.</span> <span class="free">subst</span> <span class="bound">s</span> <span class="free">anyP</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">freshen</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'form</span> <span class="main">⇒</span> <span class="tfree">'form</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">freshen</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="free">renameLCs</span> <span class="main">(</span><span class="free">freshenLC</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">empty_subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'subst</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">empty_subst</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">f</span><span class="main">.</span> <span class="free">subst</span> <span class="bound">s</span> <span class="bound">f</span> <span class="main">=</span> <span class="bound">f</span><span class="main">)</span> <span class="main">∧</span> <span class="free">subst_lconsts</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="Abstract_Formula-empty_subst_spec"><span class="command">lemma</span></span> empty_subst_spec<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">f</span><span class="main">.</span> <span class="free">subst</span> empty_subst <span class="bound">f</span> <span class="main">=</span> <span class="bound">f</span><span class="main">)</span> <span class="main">∧</span> <span class="free">subst_lconsts</span> empty_subst <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> empty_subst_def <span class="keyword1"><span class="command">using</span></span> empty_subst <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> someI_ex<span class="main">)</span>
  <span class="keyword1" id="Abstract_Formula-subst_empty_subst"><span class="command">lemma</span></span> subst_empty_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> empty_subst <span class="free">f</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> empty_subst_spec<span class="main">)</span>
  <span class="keyword1" id="Abstract_Formula-subst_lconsts_empty_subst"><span class="command">lemma</span></span> subst_lconsts_empty_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">subst_lconsts</span> empty_subst <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> empty_subst_spec<span class="main">)</span>

  <span class="keyword1" id="Abstract_Formula-lconsts_freshen"><span class="command">lemma</span></span> lconsts_freshen<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lconsts</span> <span class="main">(</span>freshen <span class="free">a</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="free">freshenLC</span> <span class="free">a</span> <span class="main">`</span> <span class="free">lconsts</span> <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> freshen_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lconsts_renameLCs<span class="main">)</span>

  <span class="keyword1" id="Abstract_Formula-freshen_closed"><span class="command">lemma</span></span> freshen_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lconsts</span> <span class="free">f</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> freshen <span class="free">a</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> freshen_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rename_closed<span class="main">)</span>
    
  <span class="keyword1" id="Abstract_Formula-closed_eq"><span class="command">lemma</span></span> closed_eq<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">closed</span> <span class="free">f1</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">closed</span> <span class="free">f2</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="free">s1</span> <span class="main">(</span>freshen <span class="free">a1</span> <span class="free">f1</span><span class="main">)</span> <span class="main">=</span> <span class="free">subst</span> <span class="free">s2</span> <span class="main">(</span>freshen <span class="free">a2</span> <span class="free">f2</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">f1</span> <span class="main">=</span> <span class="free">f2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> closed_no_lconsts freshen_def lconsts_freshen subst_closed rename_closed<span class="main">)</span>

  <span class="keyword1" id="Abstract_Formula-freshenLC_range_eq_iff"><span class="command">lemma</span></span> freshenLC_range_eq_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">freshenLC</span> <span class="free">a</span> <span class="free">v</span> <span class="main">∈</span> range <span class="main">(</span><span class="free">freshenLC</span> <span class="free">a'</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">=</span> <span class="free">a'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">rerename</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'var</span> set <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'var</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'var</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">rerename</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">from</span></span></span> <span class="free"><span class="bound"><span class="entity">to</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> <span class="free">freshenLC</span> <span class="free"><span class="bound"><span class="entity">from</span></span></span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="keyword1">then</span> <span class="free">freshenLC</span> <span class="free"><span class="bound"><span class="entity">to</span></span></span> <span class="main">(</span>inv <span class="main">(</span><span class="free">freshenLC</span> <span class="free"><span class="bound"><span class="entity">from</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
  
  <span class="keyword1" id="Abstract_Formula-inj_freshenLC"><span class="command">lemma</span></span> inj_freshenLC<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="main">(</span><span class="free">freshenLC</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> injI<span class="main">)</span> <span class="operator">simp</span>
  
  <span class="keyword1" id="Abstract_Formula-rerename_freshen"><span class="command">lemma</span></span> rerename_freshen<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">⟹</span> rerename  <span class="free">V</span> <span class="free">i</span> <span class="main">(</span><span class="free">isidx</span> <span class="free">is</span><span class="main">)</span> <span class="free">f</span> <span class="main">(</span><span class="free">freshenLC</span> <span class="free">i</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">freshenLC</span> <span class="main">(</span><span class="free">isidx</span> <span class="free">is</span><span class="main">)</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rerename_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1" id="Abstract_Formula-range_rerename"><span class="command">lemma</span></span> range_rerename<span class="main">:</span> <span class="quoted"><span class="quoted">"range <span class="main">(</span>rerename <span class="free">V</span>  <span class="free">from</span> <span class="free">to</span> <span class="free">f</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">freshenLC</span> <span class="free">to</span> <span class="main">`</span> <span class="free">V</span> <span class="main">∪</span> range <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rerename_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

  <span class="keyword1" id="Abstract_Formula-rerename_noop"><span class="command">lemma</span></span> rerename_noop<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">freshenLC</span> <span class="free">from</span> <span class="main">`</span> <span class="free">V</span>  <span class="main">⟹</span> rerename <span class="free">V</span> <span class="free">from</span> <span class="free">to</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rerename_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

  <span class="keyword1" id="Abstract_Formula-rerename_rename_noop"><span class="command">lemma</span></span> rerename_rename_noop<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="free">freshenLC</span> <span class="free">from</span> <span class="main">`</span> <span class="free">V</span> <span class="main">∩</span> <span class="free">lconsts</span> <span class="free">form</span>  <span class="main">=</span> <span class="main">{}</span>  <span class="main">⟹</span> <span class="free">renameLCs</span> <span class="main">(</span>rerename <span class="free">V</span> <span class="free">from</span> <span class="free">to</span> <span class="free">f</span><span class="main">)</span> <span class="free">form</span> <span class="main">=</span> <span class="free">renameLCs</span> <span class="free">f</span> <span class="free">form</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> renameLCs_cong rerename_noop<span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1" id="Abstract_Formula-rerename_subst_noop"><span class="command">lemma</span></span> rerename_subst_noop<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="free">freshenLC</span> <span class="free">from</span> <span class="main">`</span> <span class="free">V</span> <span class="main">∩</span> <span class="free">subst_lconsts</span> <span class="free">s</span>  <span class="main">=</span> <span class="main">{}</span>  <span class="main">⟹</span> <span class="free">subst_renameLCs</span> <span class="main">(</span>rerename <span class="free">V</span> <span class="free">from</span> <span class="free">to</span> <span class="free">f</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="free">subst_renameLCs</span> <span class="free">f</span> <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> subst_renameLCs_cong rerename_noop<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Incredible_Signatures">
<div class="head">
<h1>Theory Incredible_Signatures</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Incredible_Signatures
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../../HOL/HOL/Main.html">Main</a> 
  <span class="quoted">"<a href="../../HOL/HOL-Library/FSet.html">HOL-Library.FSet</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Stream.html">HOL-Library.Stream</a>"</span>
  <a href="Abstract_Formula.html">Abstract_Formula</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This theory contains the definition for proof graph signatures, in the variants
<span class="antiquoted"><span class="antiquoted">▪</span></span> Plain port graph
<span class="antiquoted"><span class="antiquoted">▪</span></span> Port graph with local hypotheses
<span class="antiquoted"><span class="antiquoted">▪</span></span> Labeled port graph
<span class="antiquoted"><span class="antiquoted">▪</span></span> Port graph with local constants
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Port_Graph_Signature <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">nodes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'node</span> stream"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">inPorts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'node</span> <span class="main">⇒</span> <span class="tfree">'inPort</span> fset"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">outPorts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'node</span> <span class="main">⇒</span> <span class="tfree">'outPort</span> fset"</span></span>

<span class="keyword1"><span class="command">locale</span></span> Port_Graph_Signature_Scoped <span class="main">=</span>
  Port_Graph_Signature <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">hyps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'node</span> <span class="main">⇒</span> <span class="tfree">'outPort</span> <span class="main">⇀</span> <span class="tfree">'inPort</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hyps_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">hyps</span> <span class="free">n</span> <span class="free">p1</span> <span class="main">=</span> Some <span class="free">p2</span> <span class="main">⟹</span> <span class="free">p1</span> <span class="main">|∈|</span> <span class="free">outPorts</span> <span class="free">n</span> <span class="main">∧</span> <span class="free">p2</span> <span class="main">|∈|</span> <span class="free">inPorts</span> <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">hyps_for'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'node</span> <span class="main">⇒</span> <span class="tfree">'inPort</span> <span class="main">⇒</span> <span class="tfree">'outPort</span> set"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">n</span> <span class="entity">p</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">hyps</span> <span class="free">n</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">=</span> Some <span class="free">p</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">∈</span> <span class="free">hyps_for'</span> <span class="free">n</span> <span class="free">p</span>"</span></span>

  <span class="keyword1" id="Incredible_Signatures-hyps_for'_subset"><span class="command">lemma</span></span> hyps_for'_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"hyps_for' <span class="free">n</span> <span class="free">p</span> <span class="main">⊆</span> fset <span class="main">(</span><span class="free">outPorts</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> hyps_correct <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> hyps_for'.cases notin_fset subsetI<span class="main">)</span>
 
  <span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">includes</span></span> fset.lifting
  <span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">lift_definition</span></span> hyps_for  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'node</span> <span class="main">⇒</span> <span class="tfree">'inPort</span> <span class="main">⇒</span> <span class="tfree">'outPort</span> fset"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">hyps_for'</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> finite_fset hyps_for'_subset rev_finite_subset<span class="main">)</span>
  <span class="keyword1" id="Incredible_Signatures-hyps_for_simp"><span class="command">lemma</span></span> hyps_for_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">|∈|</span> hyps_for <span class="free">n</span> <span class="free">p</span> <span class="main">⟷</span> <span class="free">hyps</span> <span class="free">n</span> <span class="free">h</span> <span class="main">=</span> Some <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hyps_for'.simps<span class="main">)</span>
  <span class="keyword1" id="Incredible_Signatures-hyps_for_simp'"><span class="command">lemma</span></span> hyps_for_simp'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">∈</span> fset <span class="main">(</span>hyps_for <span class="free">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">hyps</span> <span class="free">n</span> <span class="free">h</span> <span class="main">=</span> Some <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hyps_for'.simps<span class="main">)</span>
  <span class="keyword1" id="Incredible_Signatures-hyps_for_collect"><span class="command">lemma</span></span> hyps_for_collect<span class="main">:</span> <span class="quoted"><span class="quoted">"fset <span class="main">(</span>hyps_for <span class="free">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">h</span> <span class="main">.</span> <span class="free">hyps</span> <span class="free">n</span> <span class="bound">h</span> <span class="main">=</span> Some <span class="free">p</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword1" id="Incredible_Signatures-hyps_for_subset"><span class="command">lemma</span></span> hyps_for_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"hyps_for <span class="free">n</span> <span class="free">p</span> <span class="main">|⊆|</span> <span class="free">outPorts</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> hyps_for'_subset
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmember.rep_eq hyps_for.rep_eq <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> hyps_for_simp hyps_for_simp'<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> Labeled_Signature <span class="main">=</span> 
  Port_Graph_Signature_Scoped <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">labelsIn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'node</span> <span class="main">⇒</span> <span class="tfree">'inPort</span> <span class="main">⇒</span> <span class="tfree">'form</span>"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">labelsOut</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'node</span> <span class="main">⇒</span> <span class="tfree">'outPort</span> <span class="main">⇒</span> <span class="tfree">'form</span>"</span></span> 


<span class="keyword1"><span class="command">locale</span></span> Port_Graph_Signature_Scoped_Vars <span class="main">=</span>
  Port_Graph_Signature <span class="quoted"><span class="free">nodes</span></span> <span class="quoted"><span class="free">inPorts</span></span> <span class="quoted"><span class="free">outPorts</span></span> <span class="main">+</span>
  Abstract_Formulas <span class="quoted"><span class="free">freshenLC</span></span> <span class="quoted"><span class="free">renameLCs</span></span> <span class="quoted"><span class="free">lconsts</span></span> <span class="quoted"><span class="free">closed</span></span> <span class="quoted"><span class="free">subst</span></span> <span class="quoted"><span class="free">subst_lconsts</span></span> <span class="quoted"><span class="free">subst_renameLCs</span></span> <span class="quoted"><span class="free">anyP</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">nodes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'node</span> stream"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">inPorts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'node</span> <span class="main">⇒</span> <span class="tfree">'inPort</span> fset"</span></span>  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">outPorts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'node</span> <span class="main">⇒</span> <span class="tfree">'outPort</span> fset"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>  <span class="free">freshenLC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'var</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">renameLCs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'var</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'form</span> <span class="main">⇒</span> <span class="tfree">'form</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">lconsts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> <span class="main">⇒</span> <span class="tfree">'var</span> set"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">closed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'subst</span> <span class="main">⇒</span> <span class="tfree">'form</span> <span class="main">⇒</span> <span class="tfree">'form</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">subst_lconsts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'subst</span> <span class="main">⇒</span> <span class="tfree">'var</span> set"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">subst_renameLCs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'var</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'subst</span> <span class="main">⇒</span> <span class="tfree">'subst</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">anyP</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span>"</span></span> <span class="main">+</span>

  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">local_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'node</span> <span class="main">⇒</span> <span class="tfree">'inPort</span> <span class="main">⇒</span> <span class="tfree">'var</span> set"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Incredible_Deduction">
<div class="head">
<h1>Theory Incredible_Deduction</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Incredible_Deduction
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../../HOL/HOL/Main.html">Main</a> 
  <span class="quoted">"<a href="../../HOL/HOL-Library/FSet.html">HOL-Library.FSet</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Stream.html">HOL-Library.Stream</a>"</span>
  <a href="Incredible_Signatures.html">Incredible_Signatures</a>
  <span class="quoted">"<a href="../../HOL/HOL-Eisbach/Eisbach.html">HOL-Eisbach.Eisbach</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This theory contains the definition for actual proof graphs, and their various possible
properties.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following locale first defines graphs, without edges.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Vertex_Graph <span class="main">=</span> 
  Port_Graph_Signature <span class="quoted"><span class="free">nodes</span></span> <span class="quoted"><span class="free">inPorts</span></span> <span class="quoted"><span class="free">outPorts</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">nodes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'node</span> stream"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">inPorts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'node</span> <span class="main">⇒</span> <span class="tfree">'inPort</span> fset"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">outPorts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'node</span> <span class="main">⇒</span> <span class="tfree">'outPort</span> fset"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">vertices</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> fset"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">nodeOf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'node</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">valid_out_port</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">valid_out_port</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">|∈|</span> <span class="free">vertices</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">|∈|</span> <span class="free">outPorts</span> <span class="main">(</span><span class="free">nodeOf</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">valid_in_port</span>  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">valid_in_port</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">|∈|</span> <span class="free">vertices</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">|∈|</span> <span class="free">inPorts</span> <span class="main">(</span><span class="free">nodeOf</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span> 

  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">terminal_node</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">terminal_node</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟷</span> <span class="free">outPorts</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">terminal_vertex</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">terminal_vertex</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">|∈|</span> <span class="free">vertices</span> <span class="main">∧</span> terminal_node <span class="main">(</span><span class="free">nodeOf</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹And now we add the edges. This allows us to define paths and scopes.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'v</span><span class="main">,</span> <span class="tfree">'outPort</span><span class="main">,</span> <span class="tfree">'inPort</span><span class="main">)</span> edge <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'v</span> <span class="main">×</span> <span class="tfree">'outPort</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'v</span> <span class="main">×</span> <span class="tfree">'inPort</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> Pre_Port_Graph <span class="main">=</span>
  Vertex_Graph <span class="quoted"><span class="free">nodes</span></span> <span class="quoted"><span class="free">inPorts</span></span> <span class="quoted"><span class="free">outPorts</span></span> <span class="quoted"><span class="free">vertices</span></span> <span class="quoted"><span class="free">nodeOf</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">nodes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'node</span> stream"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">inPorts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'node</span> <span class="main">⇒</span> <span class="tfree">'inPort</span> fset"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">outPorts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'node</span> <span class="main">⇒</span> <span class="tfree">'outPort</span> fset"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">vertices</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> fset"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">nodeOf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'node</span>"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">edges</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span> <span class="tfree">'outPort</span><span class="main">,</span> <span class="tfree">'inPort</span><span class="main">)</span> edge set"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">edge_begin</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'v</span> <span class="main">×</span> <span class="tfree">'outPort</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'v</span> <span class="main">×</span> <span class="tfree">'inPort</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'v</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">edge_begin</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p1</span></span></span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p2</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span>"</span></span>
  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">edge_end</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'v</span> <span class="main">×</span> <span class="tfree">'outPort</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'v</span> <span class="main">×</span> <span class="tfree">'inPort</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'v</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">edge_end</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p1</span></span></span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p2</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span>"</span></span>

  <span class="keyword1" id="Incredible_Deduction-edge_begin_tup"><span class="command">lemma</span></span> edge_begin_tup<span class="main">:</span> <span class="quoted"><span class="quoted">"edge_begin <span class="free">x</span> <span class="main">=</span> fst <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> edge_begin.simps prod.collapse<span class="main">)</span>
  <span class="keyword1" id="Incredible_Deduction-edge_end_tup"><span class="command">lemma</span></span> edge_end_tup<span class="main">:</span> <span class="quoted"><span class="quoted">"edge_end <span class="free">x</span> <span class="main">=</span> fst <span class="main">(</span>snd <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> edge_end.simps prod.collapse<span class="main">)</span>

  <span class="keyword1"><span class="command">inductive</span></span> <span class="entity">path</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'v</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span><span class="main">,</span> <span class="tfree">'outPort</span><span class="main">,</span> <span class="tfree">'inPort</span><span class="main">)</span> edge list <span class="main">⇒</span> bool"</span></span>   <span class="keyword2"><span class="keyword">where</span></span>
    path_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">path</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
    path_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∈</span> <span class="free">edges</span> <span class="main">⟹</span> <span class="free">path</span> <span class="main">(</span>edge_end <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="free"><span class="bound"><span class="entity">pth</span></span></span> <span class="main">⟹</span> <span class="free">path</span> <span class="main">(</span>edge_begin <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">pth</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">inductive_simps</span></span> path_cons_simp'<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">v</span> <span class="free">v'</span> <span class="main">(</span><span class="free">e</span><span class="main">#</span><span class="free">pth</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">inductive_simps</span></span> path_empty_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">v</span> <span class="free">v'</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1" id="Incredible_Deduction-path_cons_simp"><span class="command">lemma</span></span> path_cons_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">v</span> <span class="free">v'</span> <span class="main">(</span><span class="free">e</span> <span class="main">#</span> <span class="free">pth</span><span class="main">)</span> <span class="main">⟷</span> fst <span class="main">(</span>fst <span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span> <span class="main">∧</span> <span class="free">e</span> <span class="main">∈</span> <span class="free">edges</span> <span class="main">∧</span> path <span class="main">(</span>fst <span class="main">(</span>snd <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="free">v'</span> <span class="free">pth</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> path_cons_simp'<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> prod.collapse<span class="main">)</span>

  <span class="keyword1" id="Incredible_Deduction-path_appendI"><span class="command">lemma</span></span> path_appendI<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">v</span> <span class="free">v'</span> <span class="free">pth1</span> <span class="main">⟹</span> path <span class="free">v'</span> <span class="free">v''</span> <span class="free">pth2</span> <span class="main">⟹</span> path <span class="free">v</span> <span class="free">v''</span> <span class="main">(</span><span class="free">pth1</span><span class="main">@</span><span class="free">pth2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">pth1</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> path_cons_simp <span class="main">)</span>

  <span class="keyword1" id="Incredible_Deduction-path_split"><span class="command">lemma</span></span> path_split<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">v</span> <span class="free">v'</span> <span class="main">(</span><span class="free">pth1</span><span class="main">@</span><span class="main">[</span><span class="free">e</span><span class="main">]</span><span class="main">@</span><span class="free">pth2</span><span class="main">)</span> <span class="main">⟷</span> path <span class="free">v</span> <span class="main">(</span>edge_end <span class="free">e</span><span class="main">)</span> <span class="main">(</span><span class="free">pth1</span><span class="main">@</span><span class="main">[</span><span class="free">e</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span> path <span class="main">(</span>edge_end <span class="free">e</span><span class="main">)</span> <span class="free">v'</span> <span class="free">pth2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">pth1</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> path_cons_simp edge_end_tup <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> path_empty<span class="main">)</span>

  <span class="keyword1" id="Incredible_Deduction-path_split2"><span class="command">lemma</span></span> path_split2<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">v</span> <span class="free">v'</span> <span class="main">(</span><span class="free">pth1</span><span class="main">@</span><span class="main">(</span><span class="free">e</span><span class="main">#</span><span class="free">pth2</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> path <span class="free">v</span> <span class="main">(</span>edge_begin <span class="free">e</span><span class="main">)</span> <span class="free">pth1</span> <span class="main">∧</span> path <span class="main">(</span>edge_begin <span class="free">e</span><span class="main">)</span> <span class="free">v'</span> <span class="main">(</span><span class="free">e</span><span class="main">#</span><span class="free">pth2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">pth1</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> path_cons_simp edge_begin_tup <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> path_empty<span class="main">)</span>

  <span class="keyword1" id="Incredible_Deduction-path_snoc"><span class="command">lemma</span></span> path_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">v</span> <span class="free">v'</span> <span class="main">(</span><span class="free">pth1</span><span class="main">@</span><span class="main">[</span><span class="free">e</span><span class="main">]</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">e</span> <span class="main">∈</span> <span class="free">edges</span> <span class="main">∧</span> path <span class="free">v</span> <span class="main">(</span>edge_begin <span class="free">e</span><span class="main">)</span> <span class="free">pth1</span> <span class="main">∧</span> edge_end <span class="free">e</span> <span class="main">=</span> <span class="free">v'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> path_split2 path_cons_simp edge_end_tup edge_begin_tup<span class="main">)</span>

  <span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">scope</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> <span class="main">×</span> <span class="tfree">'inPort</span> <span class="main">⇒</span> <span class="tfree">'v</span> set"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">ps</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">|∈|</span> <span class="free">vertices</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">pth</span> <span class="bound">v'</span><span class="main">.</span>  path <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">v'</span> <span class="bound">pth</span> <span class="main">⟹</span> terminal_vertex <span class="bound">v'</span> <span class="main">⟹</span> <span class="free">ps</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="bound">pth</span><span class="main">)</span>
    <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∈</span> <span class="free">scope</span> <span class="free">ps</span>"</span></span>

  <span class="keyword1" id="Incredible_Deduction-scope_find"><span class="command">lemma</span></span> scope_find<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> scope <span class="free">ps</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"terminal_vertex <span class="free">v'</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"path <span class="free">v</span> <span class="free">v'</span> <span class="free">pth</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">pth</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> scope.simps<span class="main">)</span>

  <span class="keyword1" id="Incredible_Deduction-snd_set_split"><span class="command">lemma</span></span> snd_set_split<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">pth</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">pth1</span> <span class="free">pth2</span> <span class="free">e</span>  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">pth</span> <span class="main">=</span> <span class="free">pth1</span><span class="main">@</span><span class="main">[</span><span class="free">e</span><span class="main">]</span><span class="main">@</span><span class="free">pth2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">e</span> <span class="main">=</span> <span class="free">ps</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">∉</span> snd <span class="main">`</span> set <span class="free">pth1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induction</span> <span class="quoted"><span class="free">pth</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">e</span> <span class="skolem">pth</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">e</span> <span class="main">=</span> <span class="free">ps</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">#</span> <span class="skolem">pth</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">e</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">pth</span> <span class="main">∧</span> snd <span class="skolem">e</span> <span class="main">=</span> <span class="free">ps</span> <span class="main">∧</span> <span class="free">ps</span> <span class="main">∉</span> snd <span class="main">`</span> set <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="skolem">pth</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> Cons.IH<span class="main">[</span><span class="operator">OF</span> this this<span class="main">]</span> 
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pth1</span></span> <span class="skolem"><span class="skolem">e'</span></span> <span class="skolem"><span class="skolem">pth2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pth</span> <span class="main">=</span> <span class="skolem">pth1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">e'</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">pth2</span> <span class="main">∧</span> snd <span class="skolem">e'</span> <span class="main">=</span> <span class="free">ps</span> <span class="main">∧</span> <span class="free">ps</span> <span class="main">∉</span> snd <span class="main">`</span> set <span class="skolem">pth1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> False
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">#</span><span class="skolem">pth</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">e</span><span class="main">#</span> <span class="skolem">pth1</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">e'</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">pth2</span> <span class="main">∧</span> snd <span class="skolem">e'</span> <span class="main">=</span> <span class="free">ps</span> <span class="main">∧</span> <span class="free">ps</span> <span class="main">∉</span> snd <span class="main">`</span> set <span class="main">(</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">pth1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Incredible_Deduction-scope_split"><span class="command">lemma</span></span> scope_split<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> scope <span class="free">ps</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"path <span class="free">v</span> <span class="free">v'</span> <span class="free">pth</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"terminal_vertex <span class="free">v'</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">pth1</span> <span class="free">e</span> <span class="free">pth2</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">pth</span> <span class="main">=</span> <span class="main">(</span><span class="free">pth1</span><span class="main">@</span><span class="main">[</span><span class="free">e</span><span class="main">]</span><span class="main">)</span><span class="main">@</span><span class="free">pth2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"path <span class="free">v</span> <span class="main">(</span>fst <span class="free">ps</span><span class="main">)</span> <span class="main">(</span><span class="free">pth1</span><span class="main">@</span><span class="main">[</span><span class="free">e</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"path <span class="main">(</span>fst <span class="free">ps</span><span class="main">)</span> <span class="free">v'</span> <span class="free">pth2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">e</span> <span class="main">=</span> <span class="free">ps</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">∉</span> snd <span class="main">`</span> set <span class="free">pth1</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> assms
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">pth</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> scope.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pth1</span></span> <span class="skolem"><span class="skolem">pth2</span></span> <span class="skolem"><span class="skolem">e</span></span>  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">pth</span> <span class="main">=</span> <span class="skolem">pth1</span><span class="main">@</span><span class="main">[</span><span class="skolem">e</span><span class="main">]</span><span class="main">@</span><span class="skolem">pth2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">e</span> <span class="main">=</span> <span class="free">ps</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">∉</span> snd <span class="main">`</span> set <span class="skolem">pth1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> snd_set_split<span class="main">)</span>
    
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹path <span class="main">_</span> <span class="main">_</span> <span class="main">_</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">pth</span> <span class="main">=</span> <span class="skolem">pth1</span><span class="main">@</span><span class="main">[</span><span class="skolem">e</span><span class="main">]</span><span class="main">@</span><span class="skolem">pth2</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"path <span class="free">v</span> <span class="main">(</span>edge_end <span class="skolem">e</span><span class="main">)</span> <span class="main">(</span><span class="skolem">pth1</span><span class="main">@</span><span class="main">[</span><span class="skolem">e</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"path <span class="main">(</span>edge_end <span class="skolem">e</span><span class="main">)</span> <span class="free">v'</span> <span class="skolem">pth2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> path_split<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> that<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">pth</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">pth1</span><span class="main">@</span><span class="main">[</span><span class="skolem">e</span><span class="main">]</span><span class="main">)</span><span class="main">@</span><span class="skolem">pth2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">pth</span><span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"path <span class="free">v</span> <span class="main">(</span>fst <span class="free">ps</span><span class="main">)</span> <span class="main">(</span><span class="skolem">pth1</span><span class="main">@</span><span class="main">[</span><span class="skolem">e</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹path <span class="free">v</span> <span class="main">(</span>edge_end <span class="skolem">e</span><span class="main">)</span> <span class="main">(</span><span class="skolem">pth1</span><span class="main">@</span><span class="main">[</span><span class="skolem">e</span><span class="main">]</span><span class="main">)</span>›</span></span>  <span class="quoted"><span class="quoted">‹snd <span class="skolem">e</span> <span class="main">=</span> <span class="free">ps</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edge_end_tup<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"path <span class="main">(</span>fst <span class="free">ps</span><span class="main">)</span> <span class="free">v'</span> <span class="skolem">pth2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹path <span class="main">(</span>edge_end <span class="skolem">e</span><span class="main">)</span> <span class="free">v'</span> <span class="skolem">pth2</span>›</span></span>  <span class="quoted"><span class="quoted">‹snd <span class="skolem">e</span> <span class="main">=</span> <span class="free">ps</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edge_end_tup<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">∉</span> snd <span class="main">`</span> set <span class="skolem">pth1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">e</span> <span class="main">=</span> <span class="free">ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>  
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This adds well-formedness conditions to the edges and vertices.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Port_Graph <span class="main">=</span> Pre_Port_Graph <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> valid_nodes<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nodeOf</span> <span class="main">`</span> fset <span class="free">vertices</span>  <span class="main">⊆</span> sset <span class="free">nodes</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> valid_edges<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">ps1</span><span class="main">,</span><span class="bound">ps2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">edges</span><span class="main">.</span> valid_out_port <span class="bound">ps1</span> <span class="main">∧</span> valid_in_port <span class="bound">ps2</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1" id="Incredible_Deduction-snd_set_path_verties"><span class="command">lemma</span></span> snd_set_path_verties<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">v</span> <span class="free">v'</span> <span class="free">pth</span> <span class="main">⟹</span> fst <span class="main">`</span> snd <span class="main">`</span> set <span class="free">pth</span> <span class="main">⊆</span> fset <span class="free">vertices</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> path.induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> valid_in_port.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> edge_end.simps notin_fset case_prodD valid_edges<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="Incredible_Deduction-fst_set_path_verties"><span class="command">lemma</span></span> fst_set_path_verties<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">v</span> <span class="free">v'</span> <span class="free">pth</span> <span class="main">⟹</span> fst <span class="main">`</span> fst <span class="main">`</span> set <span class="free">pth</span> <span class="main">⊆</span> fset <span class="free">vertices</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> path.induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> valid_out_port.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> edge_begin.simps notin_fset case_prodD valid_edges<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A pruned graph is one where every node has a path to a terminal node (which will be the conclusions).›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Pruned_Port_Graph <span class="main">=</span> Port_Graph <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pruned<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span>  <span class="bound">v</span> <span class="main">|∈|</span> <span class="free">vertices</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">pth</span> <span class="bound">v'</span><span class="main">.</span> path <span class="bound">v</span> <span class="bound">v'</span> <span class="bound">pth</span> <span class="main">∧</span> terminal_vertex <span class="bound">v'</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1" id="Incredible_Deduction-scopes_not_refl"><span class="command">lemma</span></span> scopes_not_refl<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">|∈|</span> <span class="free">vertices</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∉</span> scope <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> notI<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> scope <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">p</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">from</span></span> pruned<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pth</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"terminal_vertex <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"path <span class="free">v</span> <span class="skolem">t</span> <span class="skolem">pth</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> least<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">pth'</span><span class="main">.</span> path <span class="free">v</span> <span class="skolem">t</span> <span class="bound">pth'</span> <span class="main">⟶</span> length <span class="skolem">pth</span> <span class="main">≤</span> length <span class="bound">pth'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> terminal_vertex.simps <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> ex_has_least_nat<span class="main">)</span>
        
    <span class="keyword1"><span class="command">from</span></span> scope_split<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">v</span> <span class="main">∈</span> scope <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">p</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹path <span class="free">v</span> <span class="skolem">t</span> <span class="skolem">pth</span>›</span></span> <span class="quoted"><span class="quoted">‹terminal_vertex <span class="skolem">t</span>›</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pth1</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="skolem"><span class="skolem">pth2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pth</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">pth1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">e</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">pth2</span>"</span></span> <span class="quoted"><span class="quoted">"path <span class="free">v</span> <span class="skolem">t</span> <span class="skolem">pth2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>2<span class="main">)</span> least
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">pth</span> <span class="main">≤</span> length <span class="skolem">pth2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pth</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This lemma can be found in \cite{incredible}, but it is otherwise inconsequential.›</span></span>
  <span class="keyword1" id="Incredible_Deduction-scopes_nest"><span class="command">lemma</span></span> scopes_nest<span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ps1</span> <span class="free">ps2</span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"scope <span class="free">ps1</span> <span class="main">⊆</span> scope <span class="free">ps2</span> <span class="main">∨</span> scope <span class="free">ps2</span> <span class="main">⊆</span> scope <span class="free">ps1</span> <span class="main">∨</span> scope <span class="free">ps1</span> <span class="main">∩</span> scope <span class="free">ps2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">ps1</span> <span class="main">=</span> <span class="free">ps2</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps1</span> <span class="main">≠</span> <span class="free">ps2</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> scope <span class="free">ps1</span> <span class="main">∩</span> scope <span class="free">ps2</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">|∈|</span> <span class="free">vertices</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> scope.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pth</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"path <span class="skolem">v</span> <span class="skolem">t</span> <span class="skolem">pth</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"terminal_vertex <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pruned <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹path <span class="skolem">v</span> <span class="skolem">t</span> <span class="skolem">pth</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹terminal_vertex <span class="skolem">t</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∈</span> scope <span class="free">ps1</span> <span class="main">∩</span> scope <span class="free">ps2</span>›</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pth1a</span></span> <span class="skolem"><span class="skolem">e1</span></span> <span class="skolem"><span class="skolem">pth1b</span></span>  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pth</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">pth1a</span><span class="main">@</span><span class="main">[</span><span class="skolem">e1</span><span class="main">]</span><span class="main">)</span><span class="main">@</span><span class="skolem">pth1b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"path <span class="skolem">v</span> <span class="main">(</span>fst <span class="free">ps1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">pth1a</span><span class="main">@</span><span class="main">[</span><span class="skolem">e1</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">e1</span> <span class="main">=</span> <span class="free">ps1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps1</span> <span class="main">∉</span> snd <span class="main">`</span> set <span class="skolem">pth1a</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> scope_split<span class="main">)</span>
  
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹path <span class="skolem">v</span> <span class="skolem">t</span> <span class="skolem">pth</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹terminal_vertex <span class="skolem">t</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∈</span> scope <span class="free">ps1</span> <span class="main">∩</span> scope <span class="free">ps2</span>›</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pth2a</span></span> <span class="skolem"><span class="skolem">e2</span></span> <span class="skolem"><span class="skolem">pth2b</span></span>  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pth</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">pth2a</span><span class="main">@</span><span class="main">[</span><span class="skolem">e2</span><span class="main">]</span><span class="main">)</span><span class="main">@</span><span class="skolem">pth2b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"path <span class="skolem">v</span> <span class="main">(</span>fst <span class="free">ps2</span><span class="main">)</span> <span class="main">(</span><span class="skolem">pth2a</span><span class="main">@</span><span class="main">[</span><span class="skolem">e2</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">e2</span> <span class="main">=</span> <span class="free">ps2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps2</span> <span class="main">∉</span> snd <span class="main">`</span> set <span class="skolem">pth2a</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> scope_split<span class="main">)</span>
   
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pth</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">pth1a</span><span class="main">@</span><span class="main">[</span><span class="skolem">e1</span><span class="main">]</span><span class="main">)</span><span class="main">@</span><span class="skolem">pth1b</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pth</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">pth2a</span><span class="main">@</span><span class="main">[</span><span class="skolem">e2</span><span class="main">]</span><span class="main">)</span><span class="main">@</span><span class="skolem">pth2b</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">pth1a</span> <span class="main">⊆</span> set <span class="skolem">pth2a</span> <span class="main">∨</span> set <span class="skolem">pth2a</span> <span class="main">⊆</span> set <span class="skolem">pth1a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_eq_append_conv2<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"scope <span class="free">ps1</span> <span class="main">⊆</span> scope <span class="free">ps2</span> <span class="main">∨</span> scope <span class="free">ps2</span> <span class="main">⊆</span> scope <span class="free">ps1</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">pth1a</span> <span class="main">⊆</span> set <span class="skolem">pth2a</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ps2</span> <span class="main">∉</span> <span class="main">_</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps2</span> <span class="main">∉</span> snd <span class="main">`</span> set <span class="main">(</span><span class="skolem">pth1a</span><span class="main">@</span><span class="main">[</span><span class="skolem">e1</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ps1</span> <span class="main">≠</span> <span class="free">ps2</span>›</span></span> <span class="quoted"><span class="quoted">‹snd <span class="skolem">e1</span> <span class="main">=</span> <span class="free">ps1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"scope <span class="free">ps1</span> <span class="main">⊆</span> scope <span class="free">ps2</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v'</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> scope <span class="free">ps1</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">|∈|</span> <span class="free">vertices</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> scope.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> scope <span class="free">ps2</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> scope.intros<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pth'</span> <span class="skolem">t'</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"path <span class="skolem">v'</span> <span class="skolem">t'</span> <span class="skolem">pth'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"terminal_vertex <span class="skolem">t'</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v'</span> <span class="main">∈</span> scope <span class="free">ps1</span>›</span></span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pth3a</span></span> <span class="skolem"><span class="skolem">e3</span></span> <span class="skolem"><span class="skolem">pth3b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pth'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">pth3a</span><span class="main">@</span><span class="main">[</span><span class="skolem">e3</span><span class="main">]</span><span class="main">)</span><span class="main">@</span><span class="skolem">pth3b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"path <span class="main">(</span>fst <span class="free">ps1</span><span class="main">)</span> <span class="skolem">t'</span> <span class="skolem">pth3b</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> scope_split<span class="main">)</span>
  
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"path <span class="skolem">v</span> <span class="skolem">t'</span> <span class="main">(</span><span class="main">(</span><span class="skolem">pth1a</span><span class="main">@</span><span class="main">[</span><span class="skolem">e1</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">pth3b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹path <span class="skolem">v</span> <span class="main">(</span>fst <span class="free">ps1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">pth1a</span><span class="main">@</span><span class="main">[</span><span class="skolem">e1</span><span class="main">]</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹path <span class="main">(</span>fst <span class="free">ps1</span><span class="main">)</span> <span class="skolem">t'</span> <span class="skolem">pth3b</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> path_appendI<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹terminal_vertex <span class="skolem">t'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∈</span> <span class="main">_</span>›</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps2</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="main">(</span><span class="main">(</span><span class="skolem">pth1a</span><span class="main">@</span><span class="main">[</span><span class="skolem">e1</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">pth3b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> IntD2 scope.cases<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps2</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="skolem">pth3b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ps2</span> <span class="main">∉</span> snd <span class="main">`</span> set <span class="main">(</span><span class="skolem">pth1a</span><span class="main">@</span><span class="main">[</span><span class="skolem">e1</span><span class="main">]</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps2</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="skolem">pth'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pth'</span><span class="main">=</span><span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">pth2a</span> <span class="main">⊆</span> set <span class="skolem">pth1a</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ps1</span> <span class="main">∉</span> <span class="main">_</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps1</span> <span class="main">∉</span> snd <span class="main">`</span> set <span class="main">(</span><span class="skolem">pth2a</span><span class="main">@</span><span class="main">[</span><span class="skolem">e2</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ps1</span> <span class="main">≠</span> <span class="free">ps2</span>›</span></span> <span class="quoted"><span class="quoted">‹snd <span class="skolem">e2</span> <span class="main">=</span> <span class="free">ps2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"scope <span class="free">ps2</span> <span class="main">⊆</span> scope <span class="free">ps1</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v'</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> scope <span class="free">ps2</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">|∈|</span> <span class="free">vertices</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> scope.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> scope <span class="free">ps1</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> scope.intros<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pth'</span> <span class="skolem">t'</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"path <span class="skolem">v'</span> <span class="skolem">t'</span> <span class="skolem">pth'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"terminal_vertex <span class="skolem">t'</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v'</span> <span class="main">∈</span> scope <span class="free">ps2</span>›</span></span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pth3a</span></span> <span class="skolem"><span class="skolem">e3</span></span> <span class="skolem"><span class="skolem">pth3b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pth'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">pth3a</span><span class="main">@</span><span class="main">[</span><span class="skolem">e3</span><span class="main">]</span><span class="main">)</span><span class="main">@</span><span class="skolem">pth3b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"path <span class="main">(</span>fst <span class="free">ps2</span><span class="main">)</span> <span class="skolem">t'</span> <span class="skolem">pth3b</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> scope_split<span class="main">)</span>
  
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"path <span class="skolem">v</span> <span class="skolem">t'</span> <span class="main">(</span><span class="main">(</span><span class="skolem">pth2a</span><span class="main">@</span><span class="main">[</span><span class="skolem">e2</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">pth3b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹path <span class="skolem">v</span> <span class="main">(</span>fst <span class="free">ps2</span><span class="main">)</span> <span class="main">(</span><span class="skolem">pth2a</span><span class="main">@</span><span class="main">[</span><span class="skolem">e2</span><span class="main">]</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹path <span class="main">(</span>fst <span class="free">ps2</span><span class="main">)</span> <span class="skolem">t'</span> <span class="skolem">pth3b</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> path_appendI<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹terminal_vertex <span class="skolem">t'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∈</span> <span class="main">_</span>›</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps1</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="main">(</span><span class="main">(</span><span class="skolem">pth2a</span><span class="main">@</span><span class="main">[</span><span class="skolem">e2</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">pth3b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> IntD1 scope.cases<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps1</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="skolem">pth3b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ps1</span> <span class="main">∉</span> snd <span class="main">`</span> set <span class="main">(</span><span class="skolem">pth2a</span><span class="main">@</span><span class="main">[</span><span class="skolem">e2</span><span class="main">]</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps1</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="skolem">pth'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pth'</span><span class="main">=</span><span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A well-scoped graph is one where a port marked to be a local hypothesis is only connected to
the corresponding input port, either directly or via a path. It must not be, however, that there is
a a path from such a hypothesis to a terminal node that does not pass by the dedicated input port;
this is expressed via scopes.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Scoped_Graph <span class="main">=</span> Port_Graph <span class="main">+</span> Port_Graph_Signature_Scoped
<span class="keyword1"><span class="command">locale</span></span> Well_Scoped_Graph <span class="main">=</span> Scoped_Graph <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> well_scoped<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span><span class="free">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span><span class="free">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">edges</span> <span class="main">⟹</span> <span class="free">hyps</span> <span class="main">(</span><span class="free">nodeOf</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Some <span class="free">p'</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span><span class="free">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span><span class="free">p'</span><span class="main">)</span> <span class="main">∨</span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> scope <span class="main">(</span><span class="free">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span><span class="free">p'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> Scoped_Graph
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">hyps_free</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">hyps_free</span> <span class="free"><span class="bound"><span class="entity">pth</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span><span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">pth</span></span></span> <span class="main">⟶</span> <span class="free">hyps</span> <span class="main">(</span><span class="free">nodeOf</span> <span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> None<span class="main">)</span>"</span></span>

<span class="keyword1" id="Incredible_Deduction-hyps_free_Nil"><span class="command">lemma</span></span> hyps_free_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"hyps_free <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hyps_free_def<span class="main">)</span>

<span class="keyword1" id="Incredible_Deduction-hyps_free_Cons"><span class="command">lemma</span></span> hyps_free_Cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"hyps_free <span class="main">(</span><span class="free">e</span><span class="main">#</span><span class="free">pth</span><span class="main">)</span> <span class="main">⟷</span> hyps_free <span class="free">pth</span> <span class="main">∧</span> <span class="free">hyps</span> <span class="main">(</span><span class="free">nodeOf</span> <span class="main">(</span>fst <span class="main">(</span>fst <span class="free">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>fst <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hyps_free_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> prod.collapse<span class="main">)</span>

<span class="keyword1" id="Incredible_Deduction-path_vertices_shift"><span class="command">lemma</span></span> path_vertices_shift<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"path <span class="free">v</span> <span class="free">v'</span> <span class="free">pth</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map fst <span class="main">(</span>map fst <span class="free">pth</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">v'</span><span class="main">]</span> <span class="main">=</span> <span class="free">v</span><span class="main">#</span>map fst <span class="main">(</span>map snd <span class="free">pth</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">terminal_path</span> <span class="keyword2"><span class="keyword">where</span></span>
    terminal_path_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"terminal_vertex <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">⟹</span> <span class="free">terminal_path</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
    terminal_path_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">edges</span> <span class="main">⟹</span> <span class="free">terminal_path</span> <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="free"><span class="bound"><span class="entity">pth</span></span></span> <span class="main">⟹</span> <span class="free">hyps</span> <span class="main">(</span><span class="free">nodeOf</span> <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">=</span> None <span class="main">⟹</span> <span class="free">terminal_path</span> <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">pth</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Incredible_Deduction-terminal_path_is_path"><span class="command">lemma</span></span> terminal_path_is_path<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"terminal_path <span class="free">v</span> <span class="free">v'</span> <span class="free">pth</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"path <span class="free">v</span> <span class="free">v'</span> <span class="free">pth</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> path_cons_simp<span class="main">)</span>

<span class="keyword1" id="Incredible_Deduction-terminal_path_is_hyps_free"><span class="command">lemma</span></span> terminal_path_is_hyps_free<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"terminal_path <span class="free">v</span> <span class="free">v'</span> <span class="free">pth</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hyps_free <span class="free">pth</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hyps_free_def<span class="main">)</span>

<span class="keyword1" id="Incredible_Deduction-terminal_path_end_is_terminal"><span class="command">lemma</span></span> terminal_path_end_is_terminal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"terminal_path <span class="free">v</span> <span class="free">v'</span> <span class="free">pth</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"terminal_vertex <span class="free">v'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span>

<span class="keyword1" id="Incredible_Deduction-terminal_pathI"><span class="command">lemma</span></span> terminal_pathI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"path <span class="free">v</span> <span class="free">v'</span> <span class="free">pth</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hyps_free <span class="free">pth</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"terminal_vertex <span class="free">v'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"terminal_path <span class="free">v</span> <span class="free">v'</span> <span class="free">pth</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminal_path.intros<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹An acyclic graph is one where there are no non-trivial cyclic paths (disregarding
edges that are local hypotheses -- these are naturally and benignly cyclic).›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Acyclic_Graph <span class="main">=</span> Scoped_Graph <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hyps_free_acyclic<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">v</span> <span class="free">v</span> <span class="free">pth</span> <span class="main">⟹</span> hyps_free <span class="free">pth</span> <span class="main">⟹</span> <span class="free">pth</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1" id="Incredible_Deduction-hyps_free_vertices_distinct"><span class="command">lemma</span></span> hyps_free_vertices_distinct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"terminal_path <span class="free">v</span> <span class="free">v'</span> <span class="free">pth</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="main">(</span>map fst <span class="free">pth</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">v'</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">v'</span></span> <span class="quoted"><span class="free">pth</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> terminal_path_empty
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>terminal_path_cons <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">v'</span> <span class="skolem">pth</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> terminal_path_cons.IH
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∉</span> fst <span class="main">`</span> fst <span class="main">`</span> set <span class="skolem">pth</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> fst <span class="main">`</span> fst <span class="main">`</span> set <span class="skolem">pth</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pth1</span></span> <span class="skolem"><span class="skolem">e'</span></span> <span class="skolem"><span class="skolem">pth2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pth</span> <span class="main">=</span> <span class="skolem">pth1</span><span class="main">@</span><span class="main">[</span><span class="skolem">e'</span><span class="main">]</span><span class="main">@</span><span class="skolem">pth2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> fst <span class="main">(</span>fst <span class="skolem">e'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">pth</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹<span class="operator">rule</span> exI<span class="main">[</span><span class="operator">where</span> x <span class="main"><span class="main">=</span></span> <span class="quoted">"<span class="main">[]</span>"</span><span class="main">]</span><span class="keyword3">;</span> <span class="operator">simp</span>›</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Cons_eq_appendI image_eqI prod.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">with</span></span> terminal_path_is_path<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹terminal_path <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">v'</span> <span class="skolem">pth</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"path <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">pth1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  path_split2 edge_begin_tup<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"path <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">pth1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> path_cons_simp<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> terminal_path_is_hyps_free<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹terminal_path <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">v'</span> <span class="skolem">pth</span>›</span></span><span class="main">]</span>
         <span class="quoted"><span class="quoted">‹<span class="free">hyps</span> <span class="main">(</span><span class="free">nodeOf</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> None›</span></span>
         <span class="quoted"><span class="quoted">‹<span class="skolem">pth</span> <span class="main">=</span> <span class="skolem">pth1</span><span class="main">@</span><span class="main">[</span><span class="skolem">e'</span><span class="main">]</span><span class="main">@</span><span class="skolem">pth2</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hyps_free<span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">pth1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hyps_free_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>  <span class="keyword1"><span class="command">using</span></span> hyps_free_acyclic <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="skolem">v'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> hyps_free_acyclic path_cons terminal_path_cons.hyps<span class="main">(</span>1<span class="main">)</span> terminal_path_cons.hyps<span class="main">(</span>2<span class="main">)</span> terminal_path_cons.hyps<span class="main">(</span>3<span class="main">)</span> terminal_path_is_hyps_free terminal_path_is_path <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Incredible_Deduction-hyps_free_vertices_distinct'"><span class="command">lemma</span></span> hyps_free_vertices_distinct'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"terminal_path <span class="free">v</span> <span class="free">v'</span> <span class="free">pth</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">v</span> <span class="main">#</span> map fst <span class="main">(</span>map snd <span class="free">pth</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> hyps_free_vertices_distinct<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> path_vertices_shift<span class="main">[</span><span class="operator">OF</span> terminal_path_is_path<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Incredible_Deduction-hyps_free_limited"><span class="command">lemma</span></span> hyps_free_limited<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"terminal_path <span class="free">v</span> <span class="free">v'</span> <span class="free">pth</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">pth</span> <span class="main">≤</span> fcard <span class="free">vertices</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">pth</span> <span class="main">=</span> length <span class="main">(</span>map fst <span class="main">(</span>map fst <span class="free">pth</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">from</span></span> hyps_free_vertices_distinct<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="main">(</span>map fst <span class="free">pth</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>map fst <span class="main">(</span>map fst <span class="free">pth</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>set <span class="main">(</span>map fst <span class="main">(</span>map fst <span class="free">pth</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> distinct_card<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> card <span class="main">(</span>fset <span class="free">vertices</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> card_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_fset<span class="main"><span class="main">]</span></span><span class="main">)</span>    
    <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map fst <span class="main">(</span>map fst <span class="free">pth</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> fset <span class="free">vertices</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">v'</span></span> <span class="quoted"><span class="free">pth</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> valid_edges notin_fset case_prodD valid_out_port.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fcard <span class="free">vertices</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fcard.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Incredible_Deduction-hyps_free_path_not_in_scope"><span class="command">lemma</span></span> hyps_free_path_not_in_scope<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"terminal_path <span class="free">v</span> <span class="free">t</span> <span class="free">pth</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v'</span><span class="main">,</span><span class="free">p'</span><span class="main">)</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">pth</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">v'</span> <span class="main">∉</span> scope <span class="main">(</span><span class="free">v</span><span class="main">,</span> <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">v'</span> <span class="main">∈</span> scope <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">p</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">v'</span><span class="main">,</span><span class="free">p'</span><span class="main">)</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">pth</span>›</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pth1</span></span> <span class="skolem"><span class="skolem">pth2</span></span> <span class="skolem"><span class="skolem">e</span></span>  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">pth</span> <span class="main">=</span> <span class="skolem">pth1</span><span class="main">@</span><span class="main">[</span><span class="skolem">e</span><span class="main">]</span><span class="main">@</span><span class="skolem">pth2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">e</span> <span class="main">=</span> <span class="main">(</span><span class="free">v'</span><span class="main">,</span><span class="free">p'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> snd_set_split<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> terminal_path_is_path<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="free">pth</span> <span class="main">=</span> <span class="main">_</span> ›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹snd <span class="skolem">e</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"path <span class="free">v</span> <span class="free">v'</span> <span class="main">(</span><span class="skolem">pth1</span><span class="main">@</span><span class="main">[</span><span class="skolem">e</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"path <span class="free">v'</span> <span class="free">t</span> <span class="skolem">pth2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> path_split <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edge_end_tup<span class="main">)</span>
  
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">v'</span> <span class="main">∈</span> scope <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">p</span><span class="main">)</span>›</span></span> terminal_path_end_is_terminal<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹path <span class="free">v'</span> <span class="free">t</span> <span class="skolem">pth2</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">p</span><span class="main">)</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="skolem">pth2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> scope_find<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pth2a</span></span> <span class="skolem"><span class="skolem">e'</span></span> <span class="skolem"><span class="skolem">pth2b</span></span>  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pth2</span> <span class="main">=</span> <span class="skolem">pth2a</span><span class="main">@</span><span class="main">[</span><span class="skolem">e'</span><span class="main">]</span><span class="main">@</span><span class="skolem">pth2b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">e'</span> <span class="main">=</span> <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">p</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> snd_set_split<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹path <span class="free">v'</span> <span class="free">t</span> <span class="skolem">pth2</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="skolem">pth2</span> <span class="main">=</span> <span class="main">_</span> ›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹snd <span class="skolem">e'</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"path <span class="free">v'</span> <span class="free">v</span> <span class="main">(</span><span class="skolem">pth2a</span><span class="main">@</span><span class="main">[</span><span class="skolem">e'</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"path <span class="free">v</span> <span class="free">t</span> <span class="skolem">pth2b</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> path_split <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edge_end_tup<span class="main">)</span>
  
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹path <span class="free">v</span> <span class="free">v'</span> <span class="main">(</span><span class="skolem">pth1</span><span class="main">@</span><span class="main">[</span><span class="skolem">e</span><span class="main">]</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹path <span class="free">v'</span> <span class="free">v</span> <span class="main">(</span><span class="skolem">pth2a</span><span class="main">@</span><span class="main">[</span><span class="skolem">e'</span><span class="main">]</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"path <span class="free">v</span> <span class="free">v</span> <span class="main">(</span><span class="main">(</span><span class="skolem">pth1</span><span class="main">@</span><span class="main">[</span><span class="skolem">e</span><span class="main">]</span><span class="main">)</span><span class="main">@</span><span class="main">(</span><span class="skolem">pth2a</span><span class="main">@</span><span class="main">[</span><span class="skolem">e'</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> path_appendI<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> terminal_path_is_hyps_free<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">pth</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pth2</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hyps_free <span class="main">(</span><span class="main">(</span><span class="skolem">pth1</span><span class="main">@</span><span class="main">[</span><span class="skolem">e</span><span class="main">]</span><span class="main">)</span><span class="main">@</span><span class="main">(</span><span class="skolem">pth2a</span><span class="main">@</span><span class="main">[</span><span class="skolem">e'</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hyps_free_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">pth1</span><span class="main">@</span><span class="main">[</span><span class="skolem">e</span><span class="main">]</span><span class="main">)</span><span class="main">@</span><span class="main">(</span><span class="skolem">pth2a</span><span class="main">@</span><span class="main">[</span><span class="skolem">e'</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> hyps_free_acyclic<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A saturated graph is one where every input port is incident to an edge.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Saturated_Graph <span class="main">=</span> Port_Graph <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> saturated<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_in_port <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">p</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">e</span> <span class="main">∈</span> <span class="free">edges</span> <span class="main">.</span> snd <span class="bound">e</span> <span class="main">=</span> <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">p</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹These four conditions make up a well-shaped graph.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Well_Shaped_Graph <span class="main">=</span>  Well_Scoped_Graph <span class="main">+</span> Acyclic_Graph <span class="main">+</span> Saturated_Graph <span class="main">+</span> Pruned_Port_Graph

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next we demand an instantiation. This consists of a unique natural number per vertex,
in order to rename the local constants apart, and furthermore a substitution per block
which instantiates the schematic formulas given in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Labeled_Signature</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Instantiation <span class="main">=</span>
  Vertex_Graph <span class="quoted"><span class="free">nodes</span></span> _ _ <span class="quoted"><span class="free">vertices</span></span> _ <span class="main">+</span>
  Labeled_Signature <span class="quoted"><span class="free">nodes</span></span>  _ _ _ <span class="quoted"><span class="free">labelsIn</span></span> <span class="quoted"><span class="free">labelsOut</span></span> <span class="main">+</span>
  Abstract_Formulas <span class="quoted"><span class="free">freshenLC</span></span> <span class="quoted"><span class="free">renameLCs</span></span> <span class="quoted"><span class="free">lconsts</span></span> <span class="quoted"><span class="free">closed</span></span> <span class="quoted"><span class="free">subst</span></span> <span class="quoted"><span class="free">subst_lconsts</span></span> <span class="quoted"><span class="free">subst_renameLCs</span></span> <span class="quoted"><span class="free">anyP</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">nodes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'node</span> stream"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">edges</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vertex</span><span class="main">,</span> <span class="tfree">'outPort</span><span class="main">,</span> <span class="tfree">'inPort</span><span class="main">)</span> edge set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">vertices</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'vertex</span> fset"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">labelsIn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'node</span> <span class="main">⇒</span> <span class="tfree">'inPort</span> <span class="main">⇒</span> <span class="tfree">'form</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">labelsOut</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'node</span> <span class="main">⇒</span> <span class="tfree">'outPort</span> <span class="main">⇒</span> <span class="tfree">'form</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span>  <span class="free">freshenLC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'var</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">renameLCs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'var</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'form</span> <span class="main">⇒</span> <span class="tfree">'form</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">lconsts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> <span class="main">⇒</span> <span class="tfree">'var</span> set"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">closed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'subst</span> <span class="main">⇒</span> <span class="tfree">'form</span> <span class="main">⇒</span> <span class="tfree">'form</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">subst_lconsts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'subst</span> <span class="main">⇒</span> <span class="tfree">'var</span> set"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">subst_renameLCs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'var</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'subst</span> <span class="main">⇒</span> <span class="tfree">'subst</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">anyP</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span>"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">vidx</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'vertex</span> <span class="main">⇒</span> nat"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">inst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'vertex</span> <span class="main">⇒</span> <span class="tfree">'subst</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> vidx_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">vidx</span> <span class="main">(</span>fset <span class="free">vertices</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">labelAtIn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'vertex</span> <span class="main">⇒</span> <span class="tfree">'inPort</span> <span class="main">⇒</span> <span class="tfree">'form</span>"</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">labelAtIn</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="free">subst</span> <span class="main">(</span><span class="free">inst</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">(</span>freshen <span class="main">(</span><span class="free">vidx</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">labelsIn</span> <span class="main">(</span><span class="free">nodeOf</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">labelAtOut</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'vertex</span> <span class="main">⇒</span> <span class="tfree">'outPort</span> <span class="main">⇒</span> <span class="tfree">'form</span>"</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">labelAtOut</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="free">subst</span> <span class="main">(</span><span class="free">inst</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">(</span>freshen <span class="main">(</span><span class="free">vidx</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">labelsOut</span> <span class="main">(</span><span class="free">nodeOf</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A solution is an instantiation where on every edge, both incident ports are labeld with
the same formula.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Solution <span class="main">=</span>
  Instantiation _ _ _ _ _ <span class="quoted"><span class="free">edges</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">edges</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'vertex</span> <span class="main">×</span> <span class="tfree">'outPort</span><span class="main">)</span> <span class="main">×</span> <span class="tfree">'vertex</span> <span class="main">×</span> <span class="tfree">'inPort</span><span class="main">)</span> set"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> solved<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span><span class="free">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span><span class="free">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">edges</span> <span class="main">⟹</span> labelAtOut <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> labelAtIn <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> Proof_Graph <span class="main">=</span>  Well_Shaped_Graph <span class="main">+</span> Solution

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If we have locally scoped constants, we demand that only blocks in the scope of the 
corresponding input port may mention such a locally scoped variable in its substitution.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Well_Scoped_Instantiation <span class="main">=</span>
   Pre_Port_Graph  <span class="quoted"><span class="free">nodes</span></span> <span class="quoted"><span class="free">inPorts</span></span> <span class="quoted"><span class="free">outPorts</span></span> <span class="quoted"><span class="free">vertices</span></span> <span class="quoted"><span class="free">nodeOf</span></span> <span class="quoted"><span class="free">edges</span></span> <span class="main">+</span>
   Instantiation  <span class="quoted"><span class="free">inPorts</span></span> <span class="quoted"><span class="free">outPorts</span></span> <span class="quoted"><span class="free">nodeOf</span></span> <span class="quoted"><span class="free">hyps</span></span> <span class="quoted"><span class="free">nodes</span></span> <span class="quoted"><span class="free">edges</span></span>  <span class="quoted"><span class="free">vertices</span></span> <span class="quoted"><span class="free">labelsIn</span></span> <span class="quoted"><span class="free">labelsOut</span></span> <span class="quoted"><span class="free">freshenLC</span></span> <span class="quoted"><span class="free">renameLCs</span></span> <span class="quoted"><span class="free">lconsts</span></span> <span class="quoted"><span class="free">closed</span></span> <span class="quoted"><span class="free">subst</span></span> <span class="quoted"><span class="free">subst_lconsts</span></span> <span class="quoted"><span class="free">subst_renameLCs</span></span> <span class="quoted"><span class="free">anyP</span></span> <span class="quoted"><span class="free">vidx</span></span> <span class="quoted"><span class="free">inst</span></span> <span class="main">+</span>
   Port_Graph_Signature_Scoped_Vars <span class="quoted"><span class="free">nodes</span></span> <span class="quoted"><span class="free">inPorts</span></span> <span class="quoted"><span class="free">outPorts</span></span> <span class="quoted"><span class="free">freshenLC</span></span> <span class="quoted"><span class="free">renameLCs</span></span> <span class="quoted"><span class="free">lconsts</span></span> <span class="quoted"><span class="free">closed</span></span> <span class="quoted"><span class="free">subst</span></span> <span class="quoted"><span class="free">subst_lconsts</span></span> <span class="quoted"><span class="free">subst_renameLCs</span></span> <span class="quoted"><span class="free">anyP</span></span> <span class="quoted"><span class="free">local_vars</span></span>
   <span class="keyword2"><span class="keyword">for</span></span> <span class="free">freshenLC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'var</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">renameLCs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'var</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'form</span> <span class="main">⇒</span> <span class="tfree">'form</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">lconsts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> <span class="main">⇒</span> <span class="tfree">'var</span> set"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">closed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'subst</span> <span class="main">⇒</span> <span class="tfree">'form</span> <span class="main">⇒</span> <span class="tfree">'form</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">subst_lconsts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'subst</span> <span class="main">⇒</span> <span class="tfree">'var</span> set"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">subst_renameLCs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'var</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'subst</span> <span class="main">⇒</span> <span class="tfree">'subst</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">anyP</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">inPorts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'node</span> <span class="main">⇒</span> <span class="tfree">'inPort</span> fset"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">outPorts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'node</span> <span class="main">⇒</span> <span class="tfree">'outPort</span> fset"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">nodeOf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'vertex</span> <span class="main">⇒</span> <span class="tfree">'node</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">hyps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'node</span> <span class="main">⇒</span> <span class="tfree">'outPort</span> <span class="main">⇒</span> <span class="tfree">'inPort</span> option"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">nodes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'node</span> stream"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">vertices</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'vertex</span> fset"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">labelsIn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'node</span> <span class="main">⇒</span> <span class="tfree">'inPort</span> <span class="main">⇒</span> <span class="tfree">'form</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">labelsOut</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'node</span> <span class="main">⇒</span> <span class="tfree">'outPort</span> <span class="main">⇒</span> <span class="tfree">'form</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">vidx</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'vertex</span> <span class="main">⇒</span> nat"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">inst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'vertex</span> <span class="main">⇒</span> <span class="tfree">'subst</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">edges</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vertex</span><span class="main">,</span> <span class="tfree">'outPort</span><span class="main">,</span> <span class="tfree">'inPort</span><span class="main">)</span> edge set"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">local_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'node</span> <span class="main">⇒</span> <span class="tfree">'inPort</span> <span class="main">⇒</span> <span class="tfree">'var</span> set"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> well_scoped_inst<span class="main">:</span>
    <span class="quoted"><span class="quoted">"valid_in_port <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">p</span><span class="main">)</span> <span class="main">⟹</span>
     <span class="free">var</span> <span class="main">∈</span> <span class="free">local_vars</span> <span class="main">(</span><span class="free">nodeOf</span> <span class="free">v</span><span class="main">)</span> <span class="free">p</span> <span class="main">⟹</span>
     <span class="free">v'</span> <span class="main">|∈|</span> <span class="free">vertices</span> <span class="main">⟹</span>
     <span class="free">freshenLC</span> <span class="main">(</span><span class="free">vidx</span> <span class="free">v</span><span class="main">)</span> <span class="free">var</span> <span class="main">∈</span> <span class="free">subst_lconsts</span> <span class="main">(</span><span class="free">inst</span> <span class="free">v'</span><span class="main">)</span> <span class="main">⟹</span>
     <span class="free">v'</span> <span class="main">∈</span> scope <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1" id="Incredible_Deduction-out_of_scope"><span class="command">lemma</span></span> out_of_scope<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_in_port <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">p</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">v'</span> <span class="main">|∈|</span> <span class="free">vertices</span> <span class="main">⟹</span> <span class="free">v'</span> <span class="main">∉</span> scope <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">p</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">freshenLC</span> <span class="main">(</span><span class="free">vidx</span> <span class="free">v</span><span class="main">)</span> <span class="main">`</span> <span class="free">local_vars</span> <span class="main">(</span><span class="free">nodeOf</span> <span class="free">v</span><span class="main">)</span> <span class="free">p</span> <span class="main">∩</span> <span class="free">subst_lconsts</span> <span class="main">(</span><span class="free">inst</span> <span class="free">v'</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> well_scoped_inst <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following locale assembles all these conditions.›</span></span>
  
<span class="keyword1"><span class="command">locale</span></span> Scoped_Proof_Graph <span class="main">=</span>
  Instantiation  <span class="quoted"><span class="free">inPorts</span></span> <span class="quoted"><span class="free">outPorts</span></span> <span class="quoted"><span class="free">nodeOf</span></span> <span class="quoted"><span class="free">hyps</span></span> <span class="quoted"><span class="free">nodes</span></span> <span class="quoted"><span class="free">edges</span></span>  <span class="quoted"><span class="free">vertices</span></span> <span class="quoted"><span class="free">labelsIn</span></span> <span class="quoted"><span class="free">labelsOut</span></span> <span class="quoted"><span class="free">freshenLC</span></span> <span class="quoted"><span class="free">renameLCs</span></span> <span class="quoted"><span class="free">lconsts</span></span> <span class="quoted"><span class="free">closed</span></span> <span class="quoted"><span class="free">subst</span></span> <span class="quoted"><span class="free">subst_lconsts</span></span> <span class="quoted"><span class="free">subst_renameLCs</span></span> <span class="quoted"><span class="free">anyP</span></span> <span class="quoted"><span class="free">vidx</span></span> <span class="quoted"><span class="free">inst</span></span> <span class="main">+</span>
  Well_Shaped_Graph  <span class="quoted"><span class="free">nodes</span></span> <span class="quoted"><span class="free">inPorts</span></span> <span class="quoted"><span class="free">outPorts</span></span> <span class="quoted"><span class="free">vertices</span></span> <span class="quoted"><span class="free">nodeOf</span></span> <span class="quoted"><span class="free">edges</span></span> <span class="quoted"><span class="free">hyps</span></span>  <span class="main">+</span>
  Solution <span class="quoted"><span class="free">inPorts</span></span> <span class="quoted"><span class="free">outPorts</span></span> <span class="quoted"><span class="free">nodeOf</span></span> <span class="quoted"><span class="free">hyps</span></span> <span class="quoted"><span class="free">nodes</span></span> <span class="quoted"><span class="free">vertices</span></span>  <span class="quoted"><span class="free">labelsIn</span></span> <span class="quoted"><span class="free">labelsOut</span></span> <span class="quoted"><span class="free">freshenLC</span></span> <span class="quoted"><span class="free">renameLCs</span></span> <span class="quoted"><span class="free">lconsts</span></span> <span class="quoted"><span class="free">closed</span></span> <span class="quoted"><span class="free">subst</span></span> <span class="quoted"><span class="free">subst_lconsts</span></span> <span class="quoted"><span class="free">subst_renameLCs</span></span> <span class="quoted"><span class="free">anyP</span></span> <span class="quoted"><span class="free">vidx</span></span> <span class="quoted"><span class="free">inst</span></span> <span class="quoted"><span class="free">edges</span></span> <span class="main">+</span>
  Well_Scoped_Instantiation  <span class="quoted"><span class="free">freshenLC</span></span> <span class="quoted"><span class="free">renameLCs</span></span> <span class="quoted"><span class="free">lconsts</span></span> <span class="quoted"><span class="free">closed</span></span> <span class="quoted"><span class="free">subst</span></span> <span class="quoted"><span class="free">subst_lconsts</span></span> <span class="quoted"><span class="free">subst_renameLCs</span></span> <span class="quoted"><span class="free">anyP</span></span> <span class="quoted"><span class="free">inPorts</span></span> <span class="quoted"><span class="free">outPorts</span></span> <span class="quoted"><span class="free">nodeOf</span></span> <span class="quoted"><span class="free">hyps</span></span>  <span class="quoted"><span class="free">nodes</span></span> <span class="quoted"><span class="free">vertices</span></span> <span class="quoted"><span class="free">labelsIn</span></span> <span class="quoted"><span class="free">labelsOut</span></span> <span class="quoted"><span class="free">vidx</span></span> <span class="quoted"><span class="free">inst</span></span> <span class="quoted"><span class="free">edges</span></span> <span class="quoted"><span class="free">local_vars</span></span>
   <span class="keyword2"><span class="keyword">for</span></span> <span class="free">freshenLC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'var</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">renameLCs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'var</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'form</span> <span class="main">⇒</span> <span class="tfree">'form</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">lconsts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> <span class="main">⇒</span> <span class="tfree">'var</span> set"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">closed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'subst</span> <span class="main">⇒</span> <span class="tfree">'form</span> <span class="main">⇒</span> <span class="tfree">'form</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">subst_lconsts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'subst</span> <span class="main">⇒</span> <span class="tfree">'var</span> set"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">subst_renameLCs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'var</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'subst</span> <span class="main">⇒</span> <span class="tfree">'subst</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">anyP</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">inPorts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'node</span> <span class="main">⇒</span> <span class="tfree">'inPort</span> fset"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">outPorts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'node</span> <span class="main">⇒</span> <span class="tfree">'outPort</span> fset"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">nodeOf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'vertex</span> <span class="main">⇒</span> <span class="tfree">'node</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">hyps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'node</span> <span class="main">⇒</span> <span class="tfree">'outPort</span> <span class="main">⇒</span> <span class="tfree">'inPort</span> option"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">nodes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'node</span> stream"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">vertices</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'vertex</span> fset"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">labelsIn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'node</span> <span class="main">⇒</span> <span class="tfree">'inPort</span> <span class="main">⇒</span> <span class="tfree">'form</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">labelsOut</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'node</span> <span class="main">⇒</span> <span class="tfree">'outPort</span> <span class="main">⇒</span> <span class="tfree">'form</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">vidx</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'vertex</span> <span class="main">⇒</span> nat"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">inst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'vertex</span> <span class="main">⇒</span> <span class="tfree">'subst</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">edges</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vertex</span><span class="main">,</span> <span class="tfree">'outPort</span><span class="main">,</span> <span class="tfree">'inPort</span><span class="main">)</span> edge  set"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">local_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'node</span> <span class="main">⇒</span> <span class="tfree">'inPort</span> <span class="main">⇒</span> <span class="tfree">'var</span> set"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Abstract_Rules">
<div class="head">
<h1>Theory Abstract_Rules</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Abstract_Rules
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Abstract_Formula.html">Abstract_Formula</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Next, we can define a logic, by giving a set of rules.

In order to connect to the AFP entry Abstract Completeness, the set of rules is a stream; the only
relevant effect of this is that the set is guaranteed to be non-empty and at most countable. This
has no further significance in our development.

Each antecedent of a rule consists of
 <span class="antiquoted"><span class="antiquoted">▪</span></span> a set of fresh variables
 <span class="antiquoted"><span class="antiquoted">▪</span></span> a set of hypotheses that may be used in proving the conclusion of the antecedent and
 <span class="antiquoted"><span class="antiquoted">▪</span></span> the conclusion of the antecedent.

Our rules allow for multiple conclusions (but must have at least one).

In order to prove the completeness (but incidentally not to prove correctness) of the incredible
proof graphs, there are some extra conditions about the fresh variables in a rule. 
 <span class="antiquoted"><span class="antiquoted">▪</span></span> These need to be disjoint for different antecedents.
 <span class="antiquoted"><span class="antiquoted">▪</span></span> They need to list all local variables occurring in either the hypothesis and the conclusion.
 <span class="antiquoted"><span class="antiquoted">▪</span></span> The conclusions of a rule must not contain any local variables.
›</span></span>


<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> antecedent <span class="main">=</span>
  Antecedent <span class="main">(</span><span class="free"><span class="entity">a_hyps</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> fset"</span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">a_conc</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">a_fresh</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'var</span> set"</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">plain_ant</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> antecedent"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">plain_ant</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> Antecedent <span class="main">{||}</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> Abstract_Rules <span class="main">=</span>
  Abstract_Formulas <span class="quoted"><span class="free">freshenLC</span></span> <span class="quoted"><span class="free">renameLCs</span></span> <span class="quoted"><span class="free">lconsts</span></span> <span class="quoted"><span class="free">closed</span></span> <span class="quoted"><span class="free">subst</span></span> <span class="quoted"><span class="free">subst_lconsts</span></span> <span class="quoted"><span class="free">subst_renameLCs</span></span> <span class="quoted"><span class="free">anyP</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">freshenLC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'var</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">renameLCs</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'var</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'form</span> <span class="main">⇒</span> <span class="tfree">'form</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">lconsts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> <span class="main">⇒</span> <span class="tfree">'var</span> set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">closed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'subst</span> <span class="main">⇒</span> <span class="tfree">'form</span> <span class="main">⇒</span> <span class="tfree">'form</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">subst_lconsts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'subst</span> <span class="main">⇒</span> <span class="tfree">'var</span> set"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">subst_renameLCs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'var</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'subst</span> <span class="main">⇒</span> <span class="tfree">'subst</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">anyP</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span>"</span></span> <span class="main">+</span>

  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">antecedent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'rule</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> antecedent list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">consequent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'rule</span> <span class="main">⇒</span> <span class="tfree">'form</span> list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">rules</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'rule</span> stream"</span></span>

  <span class="keyword2"><span class="keyword">assumes</span></span> no_empty_conclusions<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span><span class="main">∈</span>sset <span class="free">rules</span><span class="main">.</span> <span class="free">consequent</span> <span class="bound">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>

  <span class="keyword2"><span class="keyword">assumes</span></span> no_local_consts_in_consequences<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span><span class="main">∈</span>sset <span class="free">rules</span><span class="main">.</span> <span class="main">⋃</span><span class="main">(</span><span class="free">lconsts</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span><span class="free">consequent</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> no_multiple_local_consts<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">r</span> <span class="bound">i</span> <span class="bound">i'</span> <span class="main">.</span> <span class="bound">r</span> <span class="main">∈</span> sset <span class="free">rules</span> <span class="main">⟹</span>
                 <span class="bound">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">antecedent</span> <span class="bound">r</span><span class="main">)</span> <span class="main">⟹</span>
                 <span class="bound">i'</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">antecedent</span> <span class="bound">r</span><span class="main">)</span> <span class="main">⟹</span>
                 a_fresh <span class="main">(</span><span class="free">antecedent</span> <span class="bound">r</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∩</span> a_fresh <span class="main">(</span><span class="free">antecedent</span> <span class="bound">r</span> <span class="main">!</span> <span class="bound">i'</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">i'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all_local_consts_listed<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">r</span> <span class="main">∈</span> sset <span class="free">rules</span> <span class="main">⟹</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">antecedent</span> <span class="bound">r</span><span class="main">)</span> <span class="main">⟹</span>
        <span class="free">lconsts</span> <span class="main">(</span>a_conc <span class="bound">p</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">lconsts</span> <span class="main">`</span> fset <span class="main">(</span>a_hyps <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> a_fresh <span class="bound">p</span> "</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">f_antecedent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'rule</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> antecedent fset"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">f_antecedent</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> fset_from_list <span class="main">(</span><span class="free">antecedent</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">f_consequent</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> fset_from_list <span class="main">(</span><span class="free">consequent</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Finally, an abstract task specifies what a specific proof should prove. In particular, it gives
a set of assumptions that may be used, and lists the conclusions that need to be proven.

Both assumptions and conclusions are closed expressions that may not be changed by substitutions. 
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Abstract_Task <span class="main">=</span>
  Abstract_Rules <span class="quoted"><span class="free">freshenLC</span></span> <span class="quoted"><span class="free">renameLCs</span></span> <span class="quoted"><span class="free">lconsts</span></span> <span class="quoted"><span class="free">closed</span></span> <span class="quoted"><span class="free">subst</span></span> <span class="quoted"><span class="free">subst_lconsts</span></span> <span class="quoted"><span class="free">subst_renameLCs</span></span> <span class="quoted"><span class="free">anyP</span></span>  <span class="quoted"><span class="free">antecedent</span></span> <span class="quoted"><span class="free">consequent</span></span> <span class="quoted"><span class="free">rules</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">freshenLC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'var</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">renameLCs</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'var</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'form</span> <span class="main">⇒</span> <span class="tfree">'form</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">lconsts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> <span class="main">⇒</span> <span class="tfree">'var</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">closed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'subst</span> <span class="main">⇒</span> <span class="tfree">'form</span> <span class="main">⇒</span> <span class="tfree">'form</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">subst_lconsts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'subst</span> <span class="main">⇒</span> <span class="tfree">'var</span> set"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">subst_renameLCs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'var</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'subst</span> <span class="main">⇒</span> <span class="tfree">'subst</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">anyP</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">antecedent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'rule</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> antecedent list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">consequent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'rule</span> <span class="main">⇒</span> <span class="tfree">'form</span> list"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">rules</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'rule</span> stream"</span></span> <span class="main">+</span>

  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">assumptions</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> list"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">conclusions</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> assumptions_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="free">assumptions</span> <span class="main">⟹</span> <span class="free">closed</span> <span class="bound">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> conclusions_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="free">conclusions</span> <span class="main">⟹</span> <span class="free">closed</span> <span class="bound">c</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">ass_forms</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ass_forms</span> <span class="main">=</span> fset_from_list <span class="free">assumptions</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">conc_forms</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">conc_forms</span> <span class="main">=</span> fset_from_list  <span class="free">conclusions</span>"</span></span>

  <span class="keyword1" id="Abstract_Rules-mem_ass_forms"><span class="command">lemma</span></span> mem_ass_forms<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">|∈|</span> ass_forms <span class="main">⟷</span> <span class="free">a</span> <span class="main">∈</span> set <span class="free">assumptions</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ass_forms_def<span class="main">)</span>
  
  <span class="keyword1" id="Abstract_Rules-mem_conc_forms"><span class="command">lemma</span></span> mem_conc_forms<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">|∈|</span> conc_forms <span class="main">⟷</span> <span class="free">a</span> <span class="main">∈</span> set <span class="free">conclusions</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conc_forms_def<span class="main">)</span>

  <span class="keyword1" id="Abstract_Rules-subst_freshen_assumptions"><span class="command">lemma</span></span> subst_freshen_assumptions<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">pf</span> <span class="main">∈</span> set <span class="free">assumptions</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="free">s</span> <span class="main">(</span>freshen <span class="free">a</span> <span class="free">pf</span><span class="main">)</span> <span class="main">=</span> <span class="free">pf</span> "</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms assumptions_closed 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> closed_no_lconsts freshen_def rename_closed subst_closed<span class="main">)</span>

  <span class="keyword1" id="Abstract_Rules-subst_freshen_conclusions"><span class="command">lemma</span></span> subst_freshen_conclusions<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">pf</span> <span class="main">∈</span> set <span class="free">conclusions</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="free">s</span> <span class="main">(</span>freshen <span class="free">a</span> <span class="free">pf</span><span class="main">)</span> <span class="main">=</span> <span class="free">pf</span> "</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms conclusions_closed 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> closed_no_lconsts freshen_def rename_closed subst_closed<span class="main">)</span>

  <span class="keyword1" id="Abstract_Rules-subst_freshen_in_ass_formsI"><span class="command">lemma</span></span> subst_freshen_in_ass_formsI<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">pf</span> <span class="main">∈</span> set <span class="free">assumptions</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="free">s</span> <span class="main">(</span>freshen <span class="free">a</span> <span class="free">pf</span><span class="main">)</span> <span class="main">|∈|</span> ass_forms"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1" id="Abstract_Rules-subst_freshen_in_conc_formsI"><span class="command">lemma</span></span> subst_freshen_in_conc_formsI<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">pf</span> <span class="main">∈</span> set <span class="free">conclusions</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="free">s</span> <span class="main">(</span>freshen <span class="free">a</span> <span class="free">pf</span><span class="main">)</span> <span class="main">|∈|</span> conc_forms"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Abstract_Rules_To_Incredible">
<div class="head">
<h1>Theory Abstract_Rules_To_Incredible</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Abstract_Rules_To_Incredible
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../../HOL/HOL/Main.html">Main</a> 
  <span class="quoted">"<a href="../../HOL/HOL-Library/FSet.html">HOL-Library.FSet</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Stream.html">HOL-Library.Stream</a>"</span>
  <a href="Incredible_Deduction.html">Incredible_Deduction</a>
  <a href="Abstract_Rules.html">Abstract_Rules</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this theory, the abstract rules given in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> <a href="Abstract_Rules.html"></a><a href="Abstract_Rules.html">Incredible_Proof_Machine.Abstract_Rules</a><span class="antiquote"><span class="antiquote">}</span></span></span></span> are used to
create a proper signature.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Besides the rules given there, we have nodes for assumptions, conclusions, and the helper
block.›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'rule</span><span class="main">)</span> graph_node <span class="main">=</span> Assumption <span class="tfree"><span class="quoted"><span class="tfree">'form</span></span></span> <span class="main">|</span> Conclusion <span class="tfree"><span class="quoted"><span class="tfree">'form</span></span></span> <span class="main">|</span> Rule <span class="tfree"><span class="quoted"><span class="tfree">'rule</span></span></span> <span class="main">|</span> Helper

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> in_port <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> antecedent"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'form</span> reg_out_port <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span>"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'form</span> hyp <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span>"</span></span>
<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> out_port <span class="main">=</span> Reg <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> reg_out_port"</span></span> <span class="main">|</span> Hyp <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> hyp"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> in_port"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'v</span><span class="main">,</span> <span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> edge' <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'v</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> out_port<span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'v</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> in_port<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> Abstract_Task
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">nodes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'rule</span><span class="main">)</span> graph_node stream"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">nodes</span> <span class="main">=</span> Helper <span class="main">##</span> shift <span class="main">(</span>map Assumption <span class="free">assumptions</span><span class="main">)</span> <span class="main">(</span>shift <span class="main">(</span>map Conclusion <span class="free">conclusions</span><span class="main">)</span> <span class="main">(</span>smap Rule <span class="free">rules</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="Abstract_Rules_To_Incredible-Helper_in_nodes"><span class="command">lemma</span></span> Helper_in_nodes<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"Helper <span class="main">∈</span> sset nodes"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nodes_def<span class="main">)</span>
  <span class="keyword1" id="Abstract_Rules_To_Incredible-Assumption_in_nodes"><span class="command">lemma</span></span> Assumption_in_nodes<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"Assumption <span class="free">a</span> <span class="main">∈</span> sset nodes <span class="main">⟷</span> <span class="free">a</span> <span class="main">∈</span> set <span class="free">assumptions</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nodes_def stream.set_map<span class="main">)</span>
  <span class="keyword1" id="Abstract_Rules_To_Incredible-Conclusion_in_nodes"><span class="command">lemma</span></span> Conclusion_in_nodes<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"Conclusion <span class="free">c</span> <span class="main">∈</span> sset nodes <span class="main">⟷</span> <span class="free">c</span> <span class="main">∈</span> set <span class="free">conclusions</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nodes_def stream.set_map<span class="main">)</span>
  <span class="keyword1" id="Abstract_Rules_To_Incredible-Rule_in_nodes"><span class="command">lemma</span></span> Rule_in_nodes<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"Rule <span class="free">r</span> <span class="main">∈</span> sset nodes <span class="main">⟷</span> <span class="free">r</span> <span class="main">∈</span> sset <span class="free">rules</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nodes_def stream.set_map<span class="main">)</span>

  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">inPorts'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'rule</span><span class="main">)</span> graph_node <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> in_port list"</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">inPorts'</span> <span class="main">(</span>Rule <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">antecedent</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
   <span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">inPorts'</span> <span class="main">(</span>Assumption <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
   <span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">inPorts'</span> <span class="main">(</span>Conclusion <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span> plain_ant <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">]</span>"</span></span>
   <span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">inPorts'</span> Helper  <span class="main">=</span> <span class="main">[</span> plain_ant <span class="free">anyP</span> <span class="main">]</span>"</span></span>

  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">inPorts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'rule</span><span class="main">)</span> graph_node <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> in_port fset"</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">inPorts</span> <span class="main">(</span>Rule <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> f_antecedent <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
   <span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">inPorts</span> <span class="main">(</span>Assumption <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
   <span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">inPorts</span> <span class="main">(</span>Conclusion <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{|</span> plain_ant <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">|}</span>"</span></span>
   <span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">inPorts</span> Helper  <span class="main">=</span> <span class="main">{|</span> plain_ant <span class="free">anyP</span> <span class="main">|}</span>"</span></span>

  <span class="keyword1" id="Abstract_Rules_To_Incredible-inPorts_fset_of"><span class="command">lemma</span></span> inPorts_fset_of<span class="main">:</span>
    <span class="quoted"><span class="quoted">"inPorts <span class="free">n</span> <span class="main">=</span> fset_from_list <span class="main">(</span>inPorts' <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> inPorts.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fmember.rep_eq f_antecedent_def<span class="main">)</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">outPortsRule</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">outPortsRule</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> ffUnion <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">h</span><span class="main">.</span> Hyp <span class="bound">h</span> <span class="bound">a</span><span class="main">)</span> <span class="main">|`|</span> a_hyps <span class="bound">a</span><span class="main">)</span> <span class="main">|`|</span> f_antecedent <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">|∪|</span> Reg <span class="main">|`|</span> f_consequent <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

  <span class="keyword1" id="Abstract_Rules_To_Incredible-Reg_in_outPortsRule"><span class="command">lemma</span></span> Reg_in_outPortsRule<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"Reg <span class="free">c</span> <span class="main">|∈|</span> outPortsRule <span class="free">r</span> <span class="main">⟷</span> <span class="free">c</span> <span class="main">|∈|</span> f_consequent <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> outPortsRule_def fmember.rep_eq ffUnion.rep_eq<span class="main">)</span>
  <span class="keyword1" id="Abstract_Rules_To_Incredible-Hyp_in_outPortsRule"><span class="command">lemma</span></span> Hyp_in_outPortsRule<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"Hyp <span class="free">h</span> <span class="free">c</span> <span class="main">|∈|</span> outPortsRule <span class="free">r</span> <span class="main">⟷</span> <span class="free">c</span> <span class="main">|∈|</span> f_antecedent <span class="free">r</span> <span class="main">∧</span> <span class="free">h</span> <span class="main">|∈|</span> a_hyps <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> outPortsRule_def fmember.rep_eq ffUnion.rep_eq<span class="main">)</span>

  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">outPorts</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">outPorts</span> <span class="main">(</span>Rule <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> outPortsRule <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
   <span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">outPorts</span> <span class="main">(</span>Assumption <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{|</span>Reg <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">|}</span>"</span></span>
   <span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">outPorts</span> <span class="main">(</span>Conclusion <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
   <span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">outPorts</span> Helper  <span class="main">=</span> <span class="main">{|</span> Reg <span class="free">anyP</span> <span class="main">|}</span>"</span></span>

  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">labelsIn</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">labelsIn</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> a_conc <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">labelsOut</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">labelsOut</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Reg <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>
   <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">labelsOut</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Hyp <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">hyps</span> <span class="keyword2"><span class="keyword">where</span></span> 
     <span class="quoted"><span class="quoted">"<span class="free">hyps</span> <span class="main">(</span>Rule <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>Hyp <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">|∈|</span> f_antecedent <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">|∈|</span> a_hyps <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
   <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">hyps</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">local_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'rule</span><span class="main">)</span> graph_node <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> in_port <span class="main">⇒</span> <span class="tfree">'var</span> set"</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
     <span class="quoted"><span class="quoted">"<span class="free">local_vars</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> a_fresh <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>


  <span class="keyword1"><span class="command">sublocale</span></span> Labeled_Signature <span class="quoted">nodes</span> <span class="quoted">inPorts</span> <span class="quoted">outPorts</span> <span class="quoted">hyps</span> <span class="quoted">labelsIn</span> <span class="quoted">labelsOut</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span><span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">n</span> <span class="skolem">p1</span> <span class="skolem">p2</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">p1</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> hyps.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span>  <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Abstract_Rules_To_Incredible-hyps_for_conclusion"><span class="command">lemma</span></span> hyps_for_conclusion<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"hyps_for <span class="main">(</span>Conclusion <span class="free">n</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> hyps_for_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Abstract_Rules_To_Incredible-hyps_for_Helper"><span class="command">lemma</span></span> hyps_for_Helper<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"hyps_for Helper <span class="free">p</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> hyps_for_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Abstract_Rules_To_Incredible-hyps_for_Rule"><span class="command">lemma</span></span> hyps_for_Rule<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ip</span> <span class="main">|∈|</span> f_antecedent <span class="free">r</span> <span class="main">⟹</span> hyps_for <span class="main">(</span>Rule <span class="free">r</span><span class="main">)</span> <span class="free">ip</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">h</span><span class="main">.</span> Hyp <span class="bound">h</span> <span class="free">ip</span><span class="main">)</span> <span class="main">|`|</span> a_hyps <span class="free">ip</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> hyps.elims <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Finally, a given proof graph solves the task at hand if all the given conclusions are present
as conclusion blocks in the graph.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Tasked_Proof_Graph <span class="main">=</span>
  Abstract_Task <span class="quoted"><span class="free">freshenLC</span></span> <span class="quoted"><span class="free">renameLCs</span></span> <span class="quoted"><span class="free">lconsts</span></span> <span class="quoted"><span class="free">closed</span></span> <span class="quoted"><span class="free">subst</span></span> <span class="quoted"><span class="free">subst_lconsts</span></span> <span class="quoted"><span class="free">subst_renameLCs</span></span> <span class="quoted"><span class="free">anyP</span></span>  <span class="quoted"><span class="free">antecedent</span></span> <span class="quoted"><span class="free">consequent</span></span> <span class="quoted"><span class="free">rules</span></span> <span class="quoted"><span class="free">assumptions</span></span> <span class="quoted"><span class="free">conclusions</span></span>  <span class="main">+</span>
  Scoped_Proof_Graph <span class="quoted"><span class="free">freshenLC</span></span> <span class="quoted"><span class="free">renameLCs</span></span> <span class="quoted"><span class="free">lconsts</span></span> <span class="quoted"><span class="free">closed</span></span> <span class="quoted"><span class="free">subst</span></span> <span class="quoted"><span class="free">subst_lconsts</span></span> <span class="quoted"><span class="free">subst_renameLCs</span></span> <span class="quoted"><span class="free">anyP</span></span>  <span class="quoted">inPorts</span> <span class="quoted">outPorts</span> <span class="quoted"><span class="free">nodeOf</span></span> <span class="quoted">hyps</span> <span class="quoted">nodes</span> <span class="quoted"><span class="free">vertices</span></span> <span class="quoted">labelsIn</span> <span class="quoted">labelsOut</span> <span class="quoted"><span class="free">vidx</span></span> <span class="quoted"><span class="free">inst</span></span> <span class="quoted"><span class="free">edges</span></span> <span class="quoted">local_vars</span>
   <span class="keyword2"><span class="keyword">for</span></span> <span class="free">freshenLC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'var</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">renameLCs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'var</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'form</span> <span class="main">⇒</span> <span class="tfree">'form</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">lconsts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> <span class="main">⇒</span> <span class="tfree">'var</span> set"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">closed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'subst</span> <span class="main">⇒</span> <span class="tfree">'form</span> <span class="main">⇒</span> <span class="tfree">'form</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">subst_lconsts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'subst</span> <span class="main">⇒</span> <span class="tfree">'var</span> set"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">subst_renameLCs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'var</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'subst</span> <span class="main">⇒</span> <span class="tfree">'subst</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">anyP</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span>"</span></span>

    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">antecedent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'rule</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> antecedent list"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">consequent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'rule</span> <span class="main">⇒</span> <span class="tfree">'form</span> list"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">rules</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'rule</span> stream"</span></span> 

    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">assumptions</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> list"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">conclusions</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> list"</span></span> 

    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">vertices</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'vertex</span> fset"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">nodeOf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'vertex</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'rule</span><span class="main">)</span> graph_node"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">edges</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vertex</span><span class="main">,</span> <span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> edge' set"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">vidx</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'vertex</span> <span class="main">⇒</span> nat"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">inst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'vertex</span> <span class="main">⇒</span> <span class="tfree">'subst</span>"</span></span>  <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> conclusions_present<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map Conclusion <span class="free">conclusions</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">nodeOf</span> <span class="main">`</span> fset <span class="free">vertices</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Entailment">
<div class="head">
<h1>Theory Entailment</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Entailment
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <span class="quoted">"<a href="../../HOL/HOL-Library/FSet.html">HOL-Library.FSet</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'form</span> entailment <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'form</span> fset <span class="main">×</span> <span class="tfree">'form</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">entails</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> fset <span class="main">⇒</span> <span class="tfree">'form</span> <span class="main">⇒</span> <span class="tfree">'form</span> entailment"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊢</span>"</span> 50<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">add_ctxt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> fset <span class="main">⇒</span> <span class="tfree">'form</span> entailment <span class="main">⇒</span> <span class="tfree">'form</span> entailment"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">add_ctxt</span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">|∪|</span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Natural_Deduction">
<div class="head">
<h1>Theory Natural_Deduction</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Natural_Deduction
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../Abstract_Completeness/Abstract_Completeness.html">Abstract_Completeness.Abstract_Completeness</a>
  <a href="Abstract_Rules.html">Abstract_Rules</a>
  <a href="Entailment.html">Entailment</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Our formalization of natural deduction builds on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> <a href="../Abstract_Completeness/Abstract_Completeness.html"></a><a href="../Abstract_Completeness/Abstract_Completeness.html">Abstract_Completeness.Abstract_Completeness</a><span class="antiquote"><span class="antiquote">}</span></span></span></span> and refines and
concretizes the structure given there as follows
 <span class="antiquoted"><span class="antiquoted">▪</span></span> The judgements are entailments consisting of a finite set of assumptions and a conclusion, which
   are abstract formulas in the sense of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> <a href="Abstract_Formula.html"></a><a href="Abstract_Formula.html">Incredible_Proof_Machine.Abstract_Formula</a><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
 <span class="antiquoted"><span class="antiquoted">▪</span></span> The abstract rules given in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> <a href="Abstract_Rules.html"></a><a href="Abstract_Rules.html">Incredible_Proof_Machine.Abstract_Rules</a><span class="antiquote"><span class="antiquote">}</span></span></span></span> are used to decide the validity of a
   step in the derivation.
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A single setep in the derivation can either be the axiom rule, the cut rule, or one
of the given rules in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> <a href="Abstract_Rules.html"></a><a href="Abstract_Rules.html">Incredible_Proof_Machine.Abstract_Rules</a><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'rule</span> NatRule <span class="main">=</span> Axiom <span class="main">|</span> NatRule <span class="tfree"><span class="quoted"><span class="tfree">'rule</span></span></span> <span class="main">|</span> Cut


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following locale is still abstract in the set of rules (<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>nat_rule›</span></span></span></span>), but implements
the bookkeeping logic for assumptions, the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Axiom</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> rule and the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Cut</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> rule.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> ND_Rules_Inst <span class="main">=</span>
  Abstract_Formulas <span class="quoted"><span class="free">freshenLC</span></span> <span class="quoted"><span class="free">renameLCs</span></span> <span class="quoted"><span class="free">lconsts</span></span> <span class="quoted"><span class="free">closed</span></span> <span class="quoted"><span class="free">subst</span></span> <span class="quoted"><span class="free">subst_lconsts</span></span> <span class="quoted"><span class="free">subst_renameLCs</span></span> <span class="quoted"><span class="free">anyP</span></span>
   <span class="keyword2"><span class="keyword">for</span></span> <span class="free">freshenLC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'var</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">renameLCs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'var</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'form</span> <span class="main">⇒</span> <span class="tfree">'form</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">lconsts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> <span class="main">⇒</span> <span class="tfree">'var</span> set"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">closed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'subst</span> <span class="main">⇒</span> <span class="tfree">'form</span> <span class="main">⇒</span> <span class="tfree">'form</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">subst_lconsts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'subst</span> <span class="main">⇒</span> <span class="tfree">'var</span> set"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">subst_renameLCs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'var</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'subst</span> <span class="main">⇒</span> <span class="tfree">'subst</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">anyP</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span>"</span></span> <span class="main">+</span>

  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">nat_rule</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'rule</span> <span class="main">⇒</span> <span class="tfree">'form</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> antecedent fset <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">rules</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'rule</span> stream"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  <span class="antiquoted"><span class="antiquoted">▪</span></span> An application of the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Axiom</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> rule is valid if the conclusion is among the assumptions.
  <span class="antiquoted"><span class="antiquoted">▪</span></span> An application of a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">NatRule</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is more complicated. This requires some natural number
    <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>a›</span></span></span></span> to rename local variables, and some instantiation <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>s›</span></span></span></span>. It checks that
     <span class="antiquoted"><span class="antiquoted">▪</span></span> none of the local variables occur in the context of the judgement.
     <span class="antiquoted"><span class="antiquoted">▪</span></span> none of the local variables occur in the instantiation.
    Together, this implements the usual freshness side-conditions.
    Furthermore, for every antecedent of the rule, the (correctly renamed and instantiated)
    hypotheses need to be added to the context.
  <span class="antiquoted"><span class="antiquoted">▪</span></span> The <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Cut</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> rule is again easy.
  ›</span></span>
  <span class="keyword1"><span class="command">inductive</span></span> <span class="entity">eff</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'rule</span> NatRule <span class="main">⇒</span> <span class="tfree">'form</span> entailment <span class="main">⇒</span> <span class="tfree">'form</span> entailment fset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">con</span></span></span> <span class="main">|∈|</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span>
    <span class="main">⟹</span> <span class="free">eff</span> Axiom <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">con</span></span></span><span class="main">)</span> <span class="main">{||}</span>"</span></span>
   <span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">nat_rule</span> <span class="free"><span class="bound"><span class="entity">rule</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">ants</span></span></span>
    <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">ant</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">ant</span> <span class="main">|∈|</span> <span class="free"><span class="bound"><span class="entity">ants</span></span></span> <span class="main">⟹</span> <span class="bound">f</span> <span class="main">|∈|</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⟹</span> <span class="free">freshenLC</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">`</span> <span class="main">(</span>a_fresh <span class="bound">ant</span><span class="main">)</span> <span class="main">∩</span> <span class="free">lconsts</span> <span class="bound">f</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>
    <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">ant</span><span class="main">.</span> <span class="bound">ant</span> <span class="main">|∈|</span> <span class="free"><span class="bound"><span class="entity">ants</span></span></span> <span class="main">⟹</span> <span class="free">freshenLC</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">`</span> <span class="main">(</span>a_fresh <span class="bound">ant</span><span class="main">)</span> <span class="main">∩</span> <span class="free">subst_lconsts</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>
    <span class="main">⟹</span> <span class="free">eff</span> <span class="main">(</span>NatRule <span class="free"><span class="bound"><span class="entity">rule</span></span></span><span class="main">)</span>
        <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⊢</span> <span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>freshen <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">ant</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>freshen <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">|`|</span> a_hyps <span class="bound">ant</span> <span class="main">|∪|</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⊢</span> <span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>freshen <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>a_conc <span class="bound">ant</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|`|</span> <span class="free"><span class="bound"><span class="entity">ants</span></span></span><span class="main">)</span> "</span></span>
   <span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">eff</span> Cut <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">)</span> <span class="main">{|</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">)</span><span class="main">|}</span>"</span></span>

  <span class="keyword1"><span class="command">inductive_simps</span></span> eff_Cut_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eff Cut <span class="main">(</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="free">c</span><span class="main">)</span> <span class="free">S</span>"</span></span>

  <span class="keyword1"><span class="command">sublocale</span></span> RuleSystem_Defs <span class="keyword2"><span class="keyword">where</span></span>
    eff <span class="main">=</span> <span class="quoted">eff</span> <span class="keyword2"><span class="keyword">and</span></span> rules <span class="main">=</span> <span class="quoted"><span class="quoted">"Cut <span class="main">##</span> Axiom <span class="main">##</span> smap NatRule <span class="free">rules</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now we instantiate the above locale. We duplicate each abstract rule (which can have multiple
consequents) for each consequent, as the natural deduction formulation can only handle a single
consequent per rule›</span></span>

<span class="keyword1"><span class="command">context</span></span> Abstract_Task 
<span class="keyword2"><span class="keyword">begin</span></span>           
  <span class="keyword1"><span class="command">inductive</span></span> <span class="entity">natEff_Inst</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">∈</span> set <span class="main">(</span><span class="free">consequent</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">natEff_Inst</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>f_antecedent <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">n_rules</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">n_rules</span> <span class="main">=</span> flat <span class="main">(</span>smap <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">consequent</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="free">rules</span><span class="main">)</span>"</span></span>
  
  <span class="keyword1"><span class="command">sublocale</span></span> ND_Rules_Inst _ _ _ _ _ _ _ _ <span class="quoted">natEff_Inst</span> <span class="quoted">n_rules</span> <span class="keyword1"><span class="command">..</span></span>
 
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A task is solved if for every conclusion, there is a well-formed and finite tree that proves
  this conclusion, using only assumptions given in the task.›</span></span>
  
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">solved</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">solved</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">|∈|</span> conc_forms <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">Γ</span> <span class="bound">t</span><span class="main">.</span> fst <span class="main">(</span>root <span class="bound">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Γ</span> <span class="main">⊢</span> <span class="bound">c</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">Γ</span> <span class="main">|⊆|</span> ass_forms <span class="main">∧</span> wf <span class="bound">t</span> <span class="main">∧</span> tfinite <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Incredible_Correctness">
<div class="head">
<h1>Theory Incredible_Correctness</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Incredible_Correctness
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Abstract_Rules_To_Incredible.html">Abstract_Rules_To_Incredible</a>
  <a href="Natural_Deduction.html">Natural_Deduction</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
In this theory, we prove that if we have a graph that proves a given abstract task (which is
represented as the context <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Tasked_Proof_Graph</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>), then we can prove <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">solved</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> Tasked_Proof_Graph
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">adjacentTo</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'vertex</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> in_port <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'vertex</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> out_port<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">adjacentTo</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">ps</span><span class="main">.</span> <span class="main">(</span><span class="bound">ps</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">edges</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">isReg</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">isReg</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">of</span> Hyp <span class="bound">h</span> <span class="bound">c</span> <span class="main">⇒</span> False <span class="main">|</span> Reg  <span class="bound">c</span> <span class="main">⇒</span>
      <span class="main">(</span><span class="keyword1">case</span> <span class="free">nodeOf</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">of</span>
        Conclusion <span class="bound">a</span> <span class="main">⇒</span> False
      <span class="main">|</span> Assumption <span class="bound">a</span> <span class="main">⇒</span> False
      <span class="main">|</span> Rule <span class="bound">r</span> <span class="main">⇒</span> True
      <span class="main">|</span> Helper <span class="main">⇒</span> True
      <span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">toNatRule</span>  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">toNatRule</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">of</span> Hyp <span class="bound">h</span> <span class="bound">c</span> <span class="main">⇒</span> Axiom <span class="main">|</span> Reg  <span class="bound">c</span> <span class="main">⇒</span>
      <span class="main">(</span><span class="keyword1">case</span> <span class="free">nodeOf</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">of</span>
        Conclusion <span class="bound">a</span> <span class="main">⇒</span> Axiom <span class="comment1">― ‹a lie›</span>
      <span class="main">|</span> Assumption <span class="bound">a</span> <span class="main">⇒</span> Axiom
      <span class="main">|</span> Rule <span class="bound">r</span> <span class="main">⇒</span> NatRule <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span>
      <span class="main">|</span> Helper <span class="main">⇒</span> Cut
      <span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">global_assms'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'var</span> itself <span class="main">⇒</span> <span class="tfree">'form</span> set"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">i</span>  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">|∈|</span> <span class="free">vertices</span> <span class="main">⟹</span> <span class="free">nodeOf</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> Assumption <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⟹</span> labelAtOut <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Reg <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">global_assms'</span> <span class="free">i</span>"</span></span>

<span class="keyword1" id="Incredible_Correctness-finite_global_assms'"><span class="command">lemma</span></span> finite_global_assms'<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>global_assms' <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>fset <span class="free">vertices</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_fset<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"global_assms' <span class="free">i</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> <span class="keyword1">case</span> <span class="free">nodeOf</span> <span class="bound">v</span> <span class="keyword1">of</span> Assumption <span class="bound">p</span> <span class="main">⇒</span>  labelAtOut <span class="bound">v</span> <span class="main">(</span>Reg <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> fset <span class="free">vertices</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> global_assms'.simps fmember.rep_eq image_iff <span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_surj<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">includes</span></span> fset.lifting
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">lift_definition</span></span> global_assms <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'var</span> itself <span class="main">⇒</span> <span class="tfree">'form</span> fset"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">global_assms'</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_global_assms'<span class="main">)</span>
  <span class="keyword1"><span class="command">lemmas</span></span> global_assmsI <span class="main">=</span> global_assms'.intros<span class="main">[</span><span class="operator">Transfer.transferred</span><span class="main">]</span>
  <span class="keyword1"><span class="command">lemmas</span></span> global_assms_simps <span class="main">=</span> global_assms'.simps<span class="main">[</span><span class="operator">Transfer.transferred</span><span class="main">]</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">extra_assms</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vertex</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> in_port<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'form</span> fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">extra_assms</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> labelAtOut <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="main">|`|</span> hyps_for <span class="main">(</span><span class="free">nodeOf</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">hyps_along</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vertex</span><span class="main">,</span> <span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> edge' list <span class="main">⇒</span> <span class="tfree">'form</span> fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">hyps_along</span> <span class="free"><span class="bound"><span class="entity">pth</span></span></span> <span class="main">=</span> ffUnion <span class="main">(</span>extra_assms <span class="main">|`|</span> snd <span class="main">|`|</span> fset_from_list <span class="free"><span class="bound"><span class="entity">pth</span></span></span><span class="main">)</span> <span class="main">|∪|</span> global_assms <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'var</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Incredible_Correctness-hyps_alongE"><span class="command">lemma</span></span> hyps_alongE<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Hyp Assumption<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">|∈|</span> hyps_along <span class="free">pth</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">v</span> <span class="free">p</span> <span class="free">h</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">p</span><span class="main">)</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">pth</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> labelAtOut <span class="free">v</span> <span class="free">h</span> "</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">|∈|</span> hyps_for <span class="main">(</span><span class="free">nodeOf</span> <span class="free">v</span><span class="main">)</span> <span class="free">p</span>"</span></span>
  <span class="main">|</span> <span class="free">v</span> <span class="free">pf</span>  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">|∈|</span> <span class="free">vertices</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">nodeOf</span> <span class="free">v</span> <span class="main">=</span> Assumption <span class="free">pf</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> labelAtOut <span class="free">v</span> <span class="main">(</span>Reg <span class="free">pf</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmember.rep_eq ffUnion.rep_eq  global_assms_simps<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> fmember.rep_eq<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> image_iff snd_conv<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Here we build the natural deduction tree, by walking the graph.›</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">tree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'vertex</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> in_port <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'vertex</span><span class="main">,</span> <span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> edge' list <span class="main">⇒</span>  <span class="main">(</span><span class="main">(</span><span class="tfree">'form</span> entailment<span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'rule</span> <span class="main">×</span> <span class="tfree">'form</span><span class="main">)</span> NatRule<span class="main">)</span> dtree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"root <span class="main">(</span><span class="free">tree</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">pth</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">(</span>hyps_along <span class="main">(</span><span class="main">(</span>adjacentTo <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">pth</span></span></span><span class="main">)</span> <span class="main">⊢</span> labelAtIn <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="keyword1">case</span> adjacentTo <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">v'</span><span class="main">,</span> <span class="bound">p'</span><span class="main">)</span> <span class="main">⇒</span> toNatRule <span class="bound">v'</span> <span class="bound">p'</span>
    <span class="main">)</span><span class="main">)</span>"</span></span>
 <span class="main">|</span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="free">tree</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">pth</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> adjacentTo <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">v'</span><span class="main">,</span> <span class="bound">p'</span><span class="main">)</span> <span class="main">⇒</span>
    <span class="main">(</span><span class="keyword1">if</span> isReg <span class="bound">v'</span> <span class="bound">p'</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">p''</span><span class="main">.</span> <span class="free">tree</span> <span class="bound">v'</span> <span class="bound">p''</span> <span class="main">(</span><span class="main">(</span>adjacentTo <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">pth</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">|`|</span> inPorts <span class="main">(</span><span class="free">nodeOf</span> <span class="bound">v'</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">{||}</span>
    <span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1" id="Incredible_Correctness-fst_root_tree"><span class="command">lemma</span></span> fst_root_tree<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>root <span class="main">(</span>tree <span class="free">v</span> <span class="free">p</span> <span class="free">pth</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>hyps_along <span class="main">(</span><span class="main">(</span>adjacentTo <span class="free">v</span> <span class="free">p</span><span class="main">,</span><span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">#</span><span class="free">pth</span><span class="main">)</span> <span class="main">⊢</span> labelAtIn <span class="free">v</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Incredible_Correctness-out_port_cases"><span class="command">lemma</span></span> out_port_cases<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Assumption Hyp Rule Helper<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">|∈|</span> outPorts <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span>
    <span class="free">a</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> Assumption <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> Reg <span class="free">a</span>"</span></span>
    <span class="main">|</span> <span class="free">r</span> <span class="free">h</span> <span class="free">c</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> Rule <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> Hyp <span class="free">h</span> <span class="free">c</span>"</span></span>
    <span class="main">|</span> <span class="free">r</span> <span class="free">f</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> Rule <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> Reg <span class="free">f</span>"</span></span>
    <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> Helper"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> Reg <span class="free">anyP</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">p</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Incredible_Correctness-hyps_for_fimage"><span class="command">lemma</span></span> hyps_for_fimage<span class="main">:</span> <span class="quoted"><span class="quoted">"hyps_for <span class="main">(</span>Rule <span class="free">r</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">|∈|</span> f_antecedent <span class="free">r</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">f</span><span class="main">.</span> Hyp <span class="bound">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">|`|</span> <span class="main">(</span>a_hyps <span class="free">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">{||}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fset_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> p'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">p'</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits out_port.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now we prove that the thus produced tree is well-formed.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> wf_tree<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_in_port <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"terminal_path <span class="free">v</span> <span class="free">t</span> <span class="free">pth</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>tree <span class="free">v</span> <span class="free">p</span> <span class="free">pth</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">pth</span></span><span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>wf <span class="skolem">v</span> <span class="skolem">p</span> <span class="skolem">pth</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"tree <span class="skolem">v</span> <span class="skolem">p</span> <span class="skolem">pth</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> saturated<span class="main">[</span><span class="operator">OF</span> wf<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="skolem"><span class="skolem">p'</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> e<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">v'</span><span class="main">,</span><span class="skolem">p'</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="skolem">v</span><span class="main">,</span><span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">edges</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"adjacentTo <span class="skolem">v</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v'</span><span class="main">,</span><span class="skolem">p'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> adjacentTo_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> eq_fst_iff tfl_some<span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">v'</span><span class="main">,</span><span class="skolem">p'</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="skolem">v</span><span class="main">,</span><span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?pth'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?e</span><span class="main">#</span><span class="skolem">pth</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Γ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"hyps_along <span class="var">?pth'</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"labelAtIn <span class="skolem">v</span> <span class="skolem">p</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> e valid_edges <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">|∈|</span> <span class="free">vertices</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">|∈|</span> outPorts <span class="main">(</span><span class="free">nodeOf</span> <span class="skolem">v'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">nodeOf</span> <span class="skolem">v'</span> <span class="main">∈</span> sset nodes"</span></span> <span class="keyword1"><span class="command">using</span></span> valid_nodes <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> image_eqI notin_fset subsetD<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?e</span> <span class="main">∈</span> <span class="free">edges</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"labelAtOut <span class="skolem">v'</span> <span class="skolem">p'</span> <span class="main">=</span> labelAtIn <span class="skolem">v</span> <span class="skolem">p</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> solved<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p'</span> <span class="main">|∈|</span> outPorts <span class="main">(</span><span class="free">nodeOf</span> <span class="skolem">v'</span><span class="main">)</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> out_port_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Hyp <span class="skolem">r</span> <span class="skolem">h</span> <span class="skolem">c</span><span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> Hyp <span class="quoted"><span class="quoted">‹<span class="skolem">p'</span> <span class="main">|∈|</span> outPorts <span class="main">(</span><span class="free">nodeOf</span> <span class="skolem">v'</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">|∈|</span> a_hyps <span class="skolem">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">|∈|</span> f_antecedent <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"hyps <span class="main">(</span><span class="free">nodeOf</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">(</span>Hyp <span class="skolem">h</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Hyp <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">from</span></span> well_scoped<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹ <span class="main">_</span> <span class="main">∈</span> <span class="free">edges</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> Hyp<span class="main"><span class="main">]</span></span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v'</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">v</span> <span class="main">∈</span> scope <span class="main">(</span><span class="skolem">v'</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v'</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> insert <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">`</span> set <span class="skolem">pth</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v'</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> scope <span class="main">(</span><span class="skolem">v'</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> this terminal_path_end_is_terminal<span class="main">[</span><span class="operator">OF</span> wf<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> terminal_path_is_path<span class="main">[</span><span class="operator">OF</span> wf<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v'</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="skolem">pth</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> scope_find<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>


    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹hyps <span class="main">(</span><span class="free">nodeOf</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">(</span>Hyp <span class="skolem">h</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">c</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Hyp <span class="skolem">h</span> <span class="skolem">c</span> <span class="main">|∈|</span> hyps_for <span class="main">(</span><span class="free">nodeOf</span> <span class="skolem">v'</span><span class="main">)</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"labelAtOut <span class="skolem">v'</span> <span class="main">(</span>Hyp <span class="skolem">h</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">|∈|</span> extra_assms <span class="main">(</span><span class="skolem">v'</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"labelAtOut <span class="skolem">v'</span> <span class="main">(</span>Hyp <span class="skolem">h</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">|∈|</span> <span class="var">?Γ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmember.rep_eq ffUnion.rep_eq<span class="main">)</span>

    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"labelAtIn <span class="skolem">v</span> <span class="skolem">p</span> <span class="main">|∈|</span> <span class="var">?Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> Hyp fmember.rep_eq<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Hyp
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eff.simps <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> hyps_along.simps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Assumption <span class="skolem">f</span><span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v'</span> <span class="main">|∈|</span> <span class="free">vertices</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">nodeOf</span> <span class="skolem">v'</span> <span class="main">=</span> Assumption <span class="skolem">f</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"labelAtOut <span class="skolem">v'</span> <span class="main">(</span>Reg <span class="skolem">f</span><span class="main">)</span> <span class="main">|∈|</span> global_assms <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'var</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> global_assmsI<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"labelAtOut <span class="skolem">v'</span> <span class="main">(</span>Reg <span class="skolem">f</span><span class="main">)</span> <span class="main">|∈|</span> <span class="var">?Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"labelAtIn <span class="skolem">v</span> <span class="skolem">p</span> <span class="main">|∈|</span> <span class="var">?Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> Assumption fmember.rep_eq<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Assumption
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eff.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Rule <span class="skolem">r</span> <span class="skolem">f</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">nodeOf</span> <span class="skolem">v'</span> <span class="main">∈</span> sset nodes›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> sset <span class="free">rules</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nodes_def stream.set_map<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> Rule
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hyps <span class="main">(</span><span class="free">nodeOf</span> <span class="skolem">v'</span><span class="main">)</span> <span class="skolem">p'</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> e <span class="quoted"><span class="quoted">‹terminal_path <span class="skolem">v</span> <span class="free">t</span> <span class="skolem">pth</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"terminal_path <span class="skolem">v'</span> <span class="free">t</span> <span class="var">?pth'</span>"</span></span><span class="keyword1"><span class="command">..</span></span>

    <span class="keyword1"><span class="command">from</span></span> Rule  <span class="quoted"><span class="quoted">‹<span class="skolem">p'</span> <span class="main">|∈|</span> outPorts <span class="main">(</span><span class="free">nodeOf</span> <span class="skolem">v'</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">|∈|</span> f_consequent <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">consequent</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_consequent_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">∈</span> sset <span class="free">rules</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"NatRule <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">∈</span> sset <span class="main">(</span>smap NatRule n_rules<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stream.set_map n_rules_def no_empty_conclusions<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>

    <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">|∈|</span> f_consequent <span class="skolem">r</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">consequent</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_consequent_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"natEff_Inst <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span> <span class="skolem">f</span> <span class="main">(</span>f_antecedent <span class="skolem">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> natEff_Inst.intros<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"eff <span class="main">(</span>NatRule <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?Γ</span> <span class="main">⊢</span> <span class="free">subst</span> <span class="main">(</span><span class="free">inst</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">(</span>freshen <span class="main">(</span><span class="free">vidx</span> <span class="skolem">v'</span><span class="main">)</span> <span class="skolem">f</span><span class="main">)</span><span class="main">)</span>
           <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">ant</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="free">subst</span> <span class="main">(</span><span class="free">inst</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">(</span>freshen <span class="main">(</span><span class="free">vidx</span> <span class="skolem">v'</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">|`|</span> a_hyps <span class="bound">ant</span> <span class="main">|∪|</span> <span class="var">?Γ</span> <span class="main">⊢</span> <span class="free">subst</span> <span class="main">(</span><span class="free">inst</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">(</span>freshen <span class="main">(</span><span class="free">vidx</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">(</span>a_conc <span class="bound">ant</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|`|</span> f_antecedent <span class="skolem">r</span><span class="main">)</span>"</span></span>
           <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"eff <span class="main">_</span> <span class="main">_</span> <span class="var">?ants</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> eff.intros<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ant</span> <span class="skolem">f</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ant</span> <span class="main">|∈|</span> f_antecedent <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">v'</span> <span class="main">|∈|</span> <span class="free">vertices</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ant</span> <span class="main">|∈|</span> f_antecedent <span class="skolem">r</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_in_port <span class="main">(</span><span class="skolem">v'</span><span class="main">,</span><span class="skolem">ant</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Rule<span class="main">)</span>

      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">|∈|</span> <span class="var">?Γ</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">freshenLC</span> <span class="main">(</span><span class="free">vidx</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">`</span> a_fresh <span class="skolem">ant</span> <span class="main">∩</span> <span class="free">lconsts</span> <span class="skolem">f</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> hyps_alongE<span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Hyp <span class="skolem">v''</span> <span class="skolem">p''</span> <span class="skolem">h''</span><span class="main">)</span>

        <span class="keyword1"><span class="command">from</span></span> Hyp<span class="main">(</span>1<span class="main">)</span> snd_set_path_verties<span class="main">[</span><span class="operator">OF</span> terminal_path_is_path<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹terminal_path <span class="skolem">v'</span> <span class="free">t</span> <span class="var">?pth'</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v''</span> <span class="main">|∈|</span> <span class="free">vertices</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmember.rep_eq<span class="main">)</span>

        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹terminal_path <span class="skolem">v'</span> <span class="free">t</span> <span class="var">?pth'</span>›</span></span> Hyp<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v''</span> <span class="main">∉</span> scope <span class="main">(</span><span class="skolem">v'</span><span class="main">,</span> <span class="skolem">ant</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> hyps_free_path_not_in_scope<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹valid_in_port <span class="main">(</span><span class="skolem">v'</span><span class="main">,</span><span class="skolem">ant</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v''</span> <span class="main">|∈|</span> <span class="free">vertices</span>›</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">freshenLC</span> <span class="main">(</span><span class="free">vidx</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">`</span> local_vars <span class="main">(</span><span class="free">nodeOf</span> <span class="skolem">v'</span><span class="main">)</span> <span class="skolem">ant</span> <span class="main">∩</span> <span class="free">subst_lconsts</span> <span class="main">(</span><span class="free">inst</span> <span class="skolem">v''</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> out_of_scope<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> hyps_free_vertices_distinct'<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹terminal_path <span class="skolem">v'</span> <span class="free">t</span> <span class="var">?pth'</span>›</span></span><span class="main">]</span> Hyp.hyps<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v''</span> <span class="main">≠</span> <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> distinct.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> fst_conv image_eqI list.set_map<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">vidx</span> <span class="skolem">v''</span> <span class="main">≠</span> <span class="free">vidx</span> <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v'</span> <span class="main">|∈|</span> <span class="free">vertices</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v''</span> <span class="main">|∈|</span> <span class="free">vertices</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> vidx_inj inj_onD notin_fset<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">freshenLC</span> <span class="main">(</span><span class="free">vidx</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">`</span> a_fresh <span class="skolem">ant</span> <span class="main">∩</span> <span class="free">freshenLC</span> <span class="main">(</span><span class="free">vidx</span> <span class="skolem">v''</span><span class="main">)</span> <span class="main">`</span> <span class="free">lconsts</span> <span class="main">(</span>labelsOut <span class="main">(</span><span class="free">nodeOf</span> <span class="skolem">v''</span><span class="main">)</span> <span class="skolem">h''</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">lconsts</span> <span class="skolem">f</span> <span class="main">⊆</span> <span class="free">lconsts</span> <span class="main">(</span>freshen <span class="main">(</span><span class="free">vidx</span> <span class="skolem">v''</span><span class="main">)</span> <span class="main">(</span>labelsOut <span class="main">(</span><span class="free">nodeOf</span> <span class="skolem">v''</span><span class="main">)</span> <span class="skolem">h''</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="free">subst_lconsts</span> <span class="main">(</span><span class="free">inst</span> <span class="skolem">v''</span><span class="main">)</span> "</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> labelAtOut_def fv_subst<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  lconsts_freshen<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Assumption <span class="skolem">v</span> <span class="skolem">pf</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="free">subst</span> <span class="main">(</span><span class="free">inst</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">(</span>freshen <span class="main">(</span><span class="free">vidx</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">pf</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> labelAtOut_def<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> Assumption <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Assumption <span class="skolem">pf</span> <span class="main">∈</span> sset nodes"</span></span> <span class="keyword1"><span class="command">using</span></span> valid_nodes <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmember.rep_eq<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pf</span> <span class="main">∈</span> set <span class="free">assumptions</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> nodes_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stream.set_map<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">closed</span> <span class="skolem">pf</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assumptions_closed<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">lconsts</span> <span class="skolem">f</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> closed_no_lconsts lconsts_freshen subst_closed freshen_closed<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ant</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ant</span> <span class="main">|∈|</span> f_antecedent <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">v'</span> <span class="main">|∈|</span> <span class="free">vertices</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ant</span> <span class="main">|∈|</span> f_antecedent <span class="skolem">r</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_in_port <span class="main">(</span><span class="skolem">v'</span><span class="main">,</span><span class="skolem">ant</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Rule<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v'</span> <span class="main">|∈|</span> <span class="free">vertices</span>›</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∉</span> scope <span class="main">(</span><span class="skolem">v'</span><span class="main">,</span> <span class="skolem">ant</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> scopes_not_refl<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">freshenLC</span> <span class="main">(</span><span class="free">vidx</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">`</span> local_vars <span class="main">(</span><span class="free">nodeOf</span> <span class="skolem">v'</span><span class="main">)</span> <span class="skolem">ant</span> <span class="main">∩</span> <span class="free">subst_lconsts</span> <span class="main">(</span><span class="free">inst</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> out_of_scope<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">freshenLC</span> <span class="main">(</span><span class="free">vidx</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">`</span> a_fresh <span class="skolem">ant</span> <span class="main">∩</span> <span class="free">subst_lconsts</span> <span class="main">(</span><span class="free">inst</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="main">(</span><span class="free">inst</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">(</span>freshen <span class="main">(</span><span class="free">vidx</span> <span class="skolem">v'</span><span class="main">)</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">=</span> labelAtOut <span class="skolem">v'</span> <span class="skolem">p'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Rule <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> labelAtOut_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹labelAtOut <span class="skolem">v'</span> <span class="skolem">p'</span> <span class="main">=</span> labelAtIn <span class="skolem">v</span> <span class="skolem">p</span>›</span></span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ants</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>extra_assms <span class="main">(</span><span class="skolem">v'</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span> <span class="main">|∪|</span> hyps_along <span class="var">?pth'</span> <span class="main">⊢</span> labelAtIn  <span class="skolem">v'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">|`|</span> f_antecedent <span class="skolem">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fimage_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> labelAtIn_def labelAtOut_def Rule hyps_for_fimage fmember.rep_eq ffUnion.rep_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eff <span class="main">(</span>NatRule <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span><span class="var">?Γ</span><span class="main">,</span> labelAtIn <span class="skolem">v</span> <span class="skolem">p</span><span class="main">)</span>
        <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> extra_assms <span class="main">(</span><span class="skolem">v'</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span> <span class="main">|∪|</span> <span class="var">?Γ</span> <span class="main">⊢</span> labelAtIn <span class="skolem">v'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">|`|</span> f_antecedent <span class="skolem">r</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>

    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">|∈|</span> cont <span class="var">?t</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> tree <span class="skolem">v'</span> <span class="skolem">a</span> <span class="var">?pth'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">|∈|</span> f_antecedent <span class="skolem">r</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Rule<span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> this<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>

      <span class="keyword1"><span class="command">from</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">v'</span> <span class="main">|∈|</span> <span class="free">vertices</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">|∈|</span> f_antecedent <span class="skolem">r</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_in_port <span class="main">(</span><span class="skolem">v'</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Rule<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>

      <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹terminal_path <span class="skolem">v'</span> <span class="free">t</span> <span class="var">?pth'</span>›</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="bound">p</span> <span class="bound">pth</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">=</span> tree <span class="bound">v</span> <span class="bound">p</span> <span class="bound">pth</span> <span class="main">∧</span> valid_in_port <span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="bound">p</span><span class="main">)</span> <span class="main">∧</span>  terminal_path <span class="bound">v</span> <span class="free">t</span> <span class="bound">pth</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Rule
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span><span class="main"><span class="main">]</span></span>  <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_def funion_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Helper
    <span class="keyword1"><span class="command">from</span></span> Helper
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hyps <span class="main">(</span><span class="free">nodeOf</span> <span class="skolem">v'</span><span class="main">)</span> <span class="skolem">p'</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> e <span class="quoted"><span class="quoted">‹terminal_path <span class="skolem">v</span> <span class="free">t</span> <span class="skolem">pth</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"terminal_path <span class="skolem">v'</span> <span class="free">t</span> <span class="var">?pth'</span>"</span></span><span class="keyword1"><span class="command">..</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"labelAtIn <span class="skolem">v'</span> <span class="main">(</span>plain_ant <span class="free">anyP</span><span class="main">)</span> <span class="main">=</span> labelAtIn <span class="skolem">v</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> s<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> Helper <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> labelAtIn_def labelAtOut_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">|∈|</span> cont <span class="var">?t</span>"</span></span>

      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> tree <span class="skolem">v'</span> <span class="main">(</span>plain_ant <span class="free">anyP</span><span class="main">)</span> <span class="var">?pth'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Helper<span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> this<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>

      <span class="keyword1"><span class="command">from</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">v'</span> <span class="main">|∈|</span> <span class="free">vertices</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_in_port <span class="main">(</span><span class="skolem">v'</span><span class="main">,</span>plain_ant <span class="free">anyP</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Helper<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>

      <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹terminal_path <span class="skolem">v'</span> <span class="free">t</span> <span class="var">?pth'</span>›</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="bound">p</span> <span class="bound">pth</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">=</span> tree <span class="bound">v</span> <span class="bound">p</span> <span class="bound">pth</span> <span class="main">∧</span> valid_in_port <span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="bound">p</span><span class="main">)</span> <span class="main">∧</span>  terminal_path <span class="bound">v</span> <span class="free">t</span> <span class="bound">pth</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Helper
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span><span class="main"><span class="main">]</span></span>  <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_def funion_assoc <span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Incredible_Correctness-global_in_ass"><span class="command">lemma</span></span> global_in_ass<span class="main">:</span> <span class="quoted"><span class="quoted">"global_assms <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'var</span><span class="main">)</span> <span class="main">|⊆|</span> ass_forms"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">|∈|</span> global_assms <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'var</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">pf</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">|∈|</span> <span class="free">vertices</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">nodeOf</span> <span class="skolem">v</span> <span class="main">=</span> Assumption <span class="skolem">pf</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> labelAtOut <span class="skolem">v</span> <span class="main">(</span>Reg <span class="skolem">pf</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> global_assms_simps<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> valid_nodes
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Assumption <span class="skolem">pf</span> <span class="main">∈</span> sset nodes"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmember.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pf</span> <span class="main">∈</span> set <span class="free">assumptions</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nodes_def stream.set_map<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">closed</span> <span class="skolem">pf</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span>  assumptions_closed<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> labelAtOut <span class="skolem">v</span> <span class="main">(</span>Reg <span class="skolem">pf</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">pf</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> labelAtOut_def lconsts_freshen closed_no_lconsts freshen_closed subst_closed<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">|∈|</span> ass_forms"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pf</span> <span class="main">∈</span> set <span class="free">assumptions</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ass_forms_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">edge_tree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'vertex</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> in_port <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'vertex</span><span class="main">,</span> <span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> edge' tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"root <span class="main">(</span><span class="free">edge_tree</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>adjacentTo <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
 <span class="main">|</span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="free">edge_tree</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> adjacentTo <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">v'</span><span class="main">,</span> <span class="bound">p'</span><span class="main">)</span> <span class="main">⇒</span>
    <span class="main">(</span><span class="keyword1">if</span> isReg <span class="bound">v'</span> <span class="bound">p'</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">edge_tree</span>  <span class="bound">v'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">|`|</span> inPorts <span class="main">(</span><span class="free">nodeOf</span> <span class="bound">v'</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">{||}</span>
    <span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Incredible_Correctness-tfinite_map_tree"><span class="command">lemma</span></span> tfinite_map_tree<span class="main">:</span> <span class="quoted"><span class="quoted">"tfinite <span class="main">(</span>map_tree <span class="free">f</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟷</span> tfinite <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"tfinite <span class="main">(</span>map_tree <span class="free">f</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"tfinite <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"map_tree <span class="free">f</span> <span class="free">t</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tfinite.induct<span class="main">)</span>
       <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>  tfinite.intros <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  tree.map_sel<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"tfinite <span class="free">t</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"tfinite <span class="main">(</span>map_tree <span class="free">f</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tfinite.induct<span class="main">)</span>
       <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>  tfinite.intros <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  tree.map_sel<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Incredible_Correctness-finite_tree_edge_tree"><span class="command">lemma</span></span> finite_tree_edge_tree<span class="main">:</span>
  <span class="quoted"><span class="quoted">"tfinite <span class="main">(</span>tree <span class="free">v</span> <span class="free">p</span> <span class="free">pth</span><span class="main">)</span> <span class="main">⟷</span> tfinite <span class="main">(</span>edge_tree <span class="free">v</span> <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_tree <span class="main">(</span><span class="main">λ</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">()</span><span class="main">)</span>  <span class="main">(</span>tree <span class="free">v</span> <span class="free">p</span> <span class="free">pth</span><span class="main">)</span> <span class="main">=</span> map_tree <span class="main">(</span><span class="main">λ</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">()</span><span class="main">)</span> <span class="main">(</span>edge_tree <span class="free">v</span> <span class="free">p</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">pth</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tree.map_sel rel_fset_def rel_set_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split out_port.split graph_node.split option.split<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> tfinite_map_tree<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">coinductive</span></span> <span class="entity">forbidden_path</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'vertex</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'vertex</span><span class="main">,</span> <span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> edge' stream <span class="main">⇒</span> bool"</span></span>   <span class="keyword2"><span class="keyword">where</span></span>
    forbidden_path<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">edges</span> <span class="main">⟹</span> hyps <span class="main">(</span><span class="free">nodeOf</span> <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">=</span> None <span class="main">⟹</span> <span class="free">forbidden_path</span> <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">pth</span></span></span> <span class="main">⟹</span> <span class="free">forbidden_path</span> <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span><span class="main">)</span><span class="main">##</span><span class="free"><span class="bound"><span class="entity">pth</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Incredible_Correctness-path_is_forbidden"><span class="command">lemma</span></span> path_is_forbidden<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_in_port <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ipath <span class="main">(</span>edge_tree <span class="free">v</span> <span class="free">p</span><span class="main">)</span> <span class="free">es</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"forbidden_path <span class="free">v</span> <span class="free">es</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">es</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> forbidden_path

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?es'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"stl <span class="skolem">es</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> forbidden_path<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"root <span class="main">(</span>edge_tree <span class="skolem">v</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> shd <span class="skolem">es</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">|∈|</span> cont <span class="main">(</span>edge_tree <span class="skolem">v</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ipath <span class="skolem">t'</span> <span class="var">?es'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹root <span class="main">(</span>edge_tree <span class="skolem">v</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> shd <span class="skolem">es</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"shd <span class="skolem">es</span> <span class="main">=</span> <span class="main">(</span>adjacentTo <span class="skolem">v</span> <span class="skolem">p</span><span class="main">,</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span><span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">from</span></span> saturated<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹valid_in_port <span class="main">(</span><span class="skolem">v</span><span class="main">,</span><span class="skolem">p</span><span class="main">)</span>›</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="skolem"><span class="skolem">p'</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> e<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">v'</span><span class="main">,</span><span class="skolem">p'</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="skolem">v</span><span class="main">,</span><span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">edges</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"adjacentTo <span class="skolem">v</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v'</span><span class="main">,</span><span class="skolem">p'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> adjacentTo_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> eq_fst_iff tfl_some<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">v'</span><span class="main">,</span><span class="skolem">p'</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="skolem">v</span><span class="main">,</span><span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> e <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">|∈|</span> outPorts <span class="main">(</span><span class="free">nodeOf</span> <span class="skolem">v'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> valid_edges <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> out_port_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Hyp
    <span class="keyword1"><span class="command">with</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="main">|∈|</span> cont <span class="main">(</span>edge_tree <span class="skolem">v</span> <span class="skolem">p</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Assumption
    <span class="keyword1"><span class="command">with</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="main">|∈|</span> cont <span class="main">(</span>edge_tree <span class="skolem">v</span> <span class="skolem">p</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Rule <span class="skolem">r</span> <span class="skolem">f</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="main">|∈|</span> cont <span class="main">(</span>edge_tree <span class="skolem">v</span> <span class="skolem">p</span><span class="main">)</span>›</span></span> Rule
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> edge_tree <span class="skolem">v'</span> <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">|∈|</span> f_antecedent <span class="skolem">r</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">es</span> <span class="main">=</span> <span class="var">?e</span> <span class="main">##</span> <span class="var">?es'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">es</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> stream.exhaust_sel<span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?e</span> <span class="main">∈</span> <span class="free">edges</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> e <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span>

    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p'</span> <span class="main">=</span> Reg <span class="skolem">f</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">nodeOf</span> <span class="skolem">v'</span> <span class="main">=</span> Rule <span class="skolem">r</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hyps <span class="main">(</span><span class="free">nodeOf</span> <span class="skolem">v'</span><span class="main">)</span> <span class="skolem">p'</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span>

    <span class="keyword1"><span class="command">from</span></span> e valid_edges <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">|∈|</span> <span class="free">vertices</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">nodeOf</span> <span class="skolem">v'</span> <span class="main">=</span> Rule <span class="skolem">r</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">|∈|</span> f_antecedent <span class="skolem">r</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_in_port <span class="main">(</span><span class="skolem">v'</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipath <span class="main">(</span>edge_tree <span class="skolem">v'</span> <span class="skolem">a</span><span class="main">)</span> <span class="var">?es'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹ipath <span class="skolem">t'</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Helper
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="main">|∈|</span> cont <span class="main">(</span>edge_tree <span class="skolem">v</span> <span class="skolem">p</span><span class="main">)</span>›</span></span> Helper
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> edge_tree <span class="skolem">v'</span> <span class="main">(</span>plain_ant <span class="free">anyP</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">es</span> <span class="main">=</span> <span class="var">?e</span> <span class="main">##</span> <span class="var">?es'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">es</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> stream.exhaust_sel<span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?e</span> <span class="main">∈</span> <span class="free">edges</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> e <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span>

    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p'</span> <span class="main">=</span> Reg <span class="free">anyP</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">nodeOf</span> <span class="skolem">v'</span> <span class="main">=</span> Helper›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hyps <span class="main">(</span><span class="free">nodeOf</span> <span class="skolem">v'</span><span class="main">)</span> <span class="skolem">p'</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span>

    <span class="keyword1"><span class="command">from</span></span> e valid_edges <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">|∈|</span> <span class="free">vertices</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">nodeOf</span> <span class="skolem">v'</span> <span class="main">=</span> Helper›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_in_port <span class="main">(</span><span class="skolem">v'</span><span class="main">,</span> plain_ant <span class="free">anyP</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipath <span class="main">(</span>edge_tree <span class="skolem">v'</span> <span class="main">(</span>plain_ant <span class="free">anyP</span><span class="main">)</span><span class="main">)</span> <span class="var">?es'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹ipath <span class="skolem">t'</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Incredible_Correctness-forbidden_path_prefix_is_path"><span class="command">lemma</span></span> forbidden_path_prefix_is_path<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"forbidden_path <span class="free">v</span> <span class="free">es</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">v'</span> <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"path <span class="free">v'</span> <span class="free">v</span> <span class="main">(</span>rev <span class="main">(</span>stake <span class="free">n</span> <span class="free">es</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">es</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> path_snoc<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> forbidden_path.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Incredible_Correctness-forbidden_path_prefix_is_hyp_free"><span class="command">lemma</span></span> forbidden_path_prefix_is_hyp_free<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"forbidden_path <span class="free">v</span> <span class="free">es</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hyps_free <span class="main">(</span>rev <span class="main">(</span>stake <span class="free">n</span> <span class="free">es</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">es</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hyps_free_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> forbidden_path.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hyps_free_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹And now we prove that the tree is finite, which requires the above notion of a
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">forbidden_path</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, i.e.\@ an infinite path.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> finite_tree<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_in_port <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"terminal_vertex <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tfinite <span class="main">(</span>tree <span class="free">v</span> <span class="free">p</span> <span class="free">pth</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>fcard <span class="free">vertices</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> tfinite <span class="main">(</span>tree <span class="free">v</span> <span class="free">p</span> <span class="free">pth</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> tfinite <span class="main">(</span>edge_tree <span class="free">v</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> finite_tree_edge_tree<span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">es</span></span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vertex</span><span class="main">,</span> <span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> edge' stream"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"ipath <span class="main">(</span>edge_tree <span class="free">v</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">es</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Konig <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹valid_in_port <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">p</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"forbidden_path <span class="free">v</span> <span class="skolem">es</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> path_is_forbidden<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> forbidden_path_prefix_is_path<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> forbidden_path_prefix_is_hyp_free<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"path <span class="skolem">v'</span> <span class="free">v</span> <span class="main">(</span>rev <span class="main">(</span>stake <span class="var">?n</span> <span class="skolem">es</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hyps_free <span class="main">(</span>rev <span class="main">(</span>stake <span class="var">?n</span> <span class="skolem">es</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="quoted"><span class="quoted">‹terminal_vertex <span class="free">v</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"terminal_path  <span class="skolem">v'</span> <span class="free">v</span> <span class="main">(</span>rev <span class="main">(</span>stake <span class="var">?n</span> <span class="skolem">es</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> terminal_pathI<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>rev <span class="main">(</span>stake <span class="var">?n</span> <span class="skolem">es</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> fcard <span class="free">vertices</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> hyps_free_limited<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The main result of this theory.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> <span class="quoted">solved</span>
<span class="keyword1"><span class="command">unfolding</span></span> solved_def
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> ballI allI conjI impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">|∈|</span> conc_forms"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> set <span class="free">conclusions</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conc_forms_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>1<span class="main">)</span> conclusions_present
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">|∈|</span> <span class="free">vertices</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">nodeOf</span> <span class="skolem">v</span> <span class="main">=</span> Conclusion <span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> image_iff image_subset_iff notin_fset<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_in_port <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="main">(</span>plain_ant <span class="skolem">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">|∈|</span> <span class="free">vertices</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">nodeOf</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span> ›</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"terminal_vertex <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">|∈|</span> <span class="free">vertices</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">nodeOf</span> <span class="skolem">v</span> <span class="main">=</span> Conclusion <span class="skolem">c</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"tree <span class="skolem">v</span> <span class="main">(</span>plain_ant <span class="skolem">c</span><span class="main">)</span> <span class="main">[]</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>root <span class="var">?t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>global_assms <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'var</span><span class="main">)</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> set <span class="free">conclusions</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">nodeOf</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> labelAtIn_def conclusions_closed closed_no_lconsts  freshen_def rename_closed subst_closed<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"global_assms <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'var</span><span class="main">)</span> <span class="main">|⊆|</span> ass_forms"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> global_in_ass<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>

  <span class="keyword1"><span class="command">from</span></span>  <span class="quoted"><span class="quoted">‹terminal_vertex <span class="skolem">v</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"terminal_path <span class="skolem">v</span> <span class="skolem">v</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> terminal_path_empty<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹valid_in_port <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="main">(</span>plain_ant <span class="skolem">c</span><span class="main">)</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf <span class="var">?t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_tree<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹valid_in_port <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> plain_ant <span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹terminal_vertex <span class="skolem">v</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tfinite <span class="var">?t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_tree<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Γ</span> <span class="bound">t</span><span class="main">.</span> fst <span class="main">(</span>root <span class="bound">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Γ</span> <span class="main">⊢</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">Γ</span> <span class="main">|⊆|</span> ass_forms <span class="main">∧</span> wf <span class="bound">t</span> <span class="main">∧</span> tfinite <span class="bound">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Rose_Tree">
<div class="head">
<h1>Theory Rose_Tree</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Rose_Tree
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <span class="quoted">"<a href="../../HOL/HOL-Library/Sublist.html">HOL-Library.Sublist</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For theory <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Incredible_Trees›</span></span></span></span> we need rose trees; this theory contains
the generally useful part of that development.›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The rose tree data type›</span></span>


<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> rose_tree <span class="main">=</span> RNode <span class="main">(</span><span class="free"><span class="entity">root</span></span><span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">children</span></span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rose_tree list"</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The set of paths in a rose tree›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Too bad that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> inductive_set<span class="antiquote"><span class="antiquote">}</span></span></span></span> does not allow for varying parameters...›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">it_pathsP</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rose_tree <span class="main">⇒</span> nat list <span class="main">⇒</span> bool"</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
   it_paths_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">it_pathsP</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">[]</span>"</span></span>
 <span class="main">|</span> it_paths_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>children <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">⟹</span> children <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">⟹</span> <span class="free">it_pathsP</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="main">⟹</span> <span class="free">it_pathsP</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">is</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> it_pathP_ConsE<span class="main">:</span> <span class="quoted"><span class="quoted">"it_pathsP <span class="free">t</span> <span class="main">(</span><span class="free">i</span><span class="main">#</span><span class="free">is</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> it_pathP_RNodeE<span class="main">:</span> <span class="quoted"><span class="quoted">"it_pathsP <span class="main">(</span>RNode <span class="free">r</span> <span class="free">ants</span><span class="main">)</span> <span class="free">is</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">it_paths</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rose_tree <span class="main">⇒</span> nat list set"</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">it_paths</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> Collect <span class="main">(</span>it_pathsP <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Rose_Tree-it_paths_eq"><span class="command">lemma</span></span> it_paths_eq <span class="main">[</span><span class="operator">pred_set_conv</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"it_pathsP <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> it_paths <span class="free">t</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> it_paths_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> it_paths_intros <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">?</span></span></span><span class="main">]</span> <span class="main">=</span> it_pathsP.intros<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> it_paths_induct <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> it_paths<span class="main">]</span> <span class="main">=</span> it_pathsP.induct<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> it_paths_cases <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">cases</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> it_paths<span class="main">]</span> <span class="main">=</span> it_pathsP.cases<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> it_paths_ConsE <span class="main">=</span> it_pathP_ConsE<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> it_paths_RNodeE <span class="main">=</span> it_pathP_RNodeE<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> it_paths_simps <span class="main">=</span> it_pathsP.simps<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> it_paths_intros<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1" id="Rose_Tree-it_paths_RNode_Nil"><span class="command">lemma</span></span> it_paths_RNode_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"it_paths <span class="main">(</span>RNode <span class="free">r</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> it_paths_cases<span class="main">)</span>

<span class="keyword1" id="Rose_Tree-it_paths_Union"><span class="command">lemma</span></span> it_paths_Union<span class="main">:</span> <span class="quoted"><span class="quoted">"it_paths <span class="free">t</span> <span class="main">⊆</span> insert <span class="main">[]</span> <span class="main">(</span>Union <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(#)</span> <span class="bound">i</span><span class="main">)</span> <span class="main">`</span> it_paths <span class="bound">t</span><span class="main">)</span> <span class="main">`</span> set <span class="main">(</span>List.enumerate <span class="main">(</span><span class="main">0</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">(</span>children <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> it_paths_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bexI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_enumerate_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Rose_Tree-finite_it_paths"><span class="command">lemma</span></span> finite_it_paths<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>it_paths <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>  finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> it_paths_Union<span class="main"><span class="main">]</span></span>  <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_enumerate_eq<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Indexing into a rose tree›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">tree_at</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rose_tree <span class="main">⇒</span> nat list <span class="main">⇒</span> <span class="tfree">'a</span> rose_tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tree_at</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">tree_at</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">is</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">tree_at</span> <span class="main">(</span>children <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">is</span></span></span>"</span></span>

<span class="keyword1" id="Rose_Tree-it_paths_SnocE"><span class="command">lemma</span></span> it_paths_SnocE<span class="main">[</span><span class="operator">elim_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">@</span> <span class="main">[</span><span class="free">i</span><span class="main">]</span> <span class="main">∈</span> it_paths <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">∈</span> it_paths <span class="free">t</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>children <span class="main">(</span>tree_at <span class="free">t</span> <span class="free">is</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="free">is</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> it_paths_intros <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> it_paths_ConsE<span class="main">)</span>


<span class="keyword1" id="Rose_Tree-it_paths_strict_prefix"><span class="command">lemma</span></span> it_paths_strict_prefix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">∈</span> it_paths <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"strict_prefix <span class="free">is'</span> <span class="free">is</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">is'</span> <span class="main">∈</span> it_paths <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">is''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">=</span> <span class="free">is'</span> <span class="main">@</span> <span class="skolem">is''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> strict_prefixE' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">is'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> it_paths_ConsE <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> it_paths_intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Rose_Tree-it_paths_prefix"><span class="command">lemma</span></span> it_paths_prefix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">∈</span> it_paths <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prefix <span class="free">is'</span> <span class="free">is</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">is'</span> <span class="main">∈</span> it_paths <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms it_paths_strict_prefix strict_prefixI <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Rose_Tree-it_paths_butlast"><span class="command">lemma</span></span> it_paths_butlast<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">∈</span> it_paths <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"butlast <span class="free">is</span> <span class="main">∈</span> it_paths <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms prefixeq_butlast <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> it_paths_prefix<span class="main">)</span>

<span class="keyword1" id="Rose_Tree-it_path_SnocI"><span class="command">lemma</span></span> it_path_SnocI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">∈</span> it_paths <span class="free">t</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>children <span class="main">(</span>tree_at <span class="free">t</span> <span class="free">is</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">@</span> <span class="main">[</span><span class="free">i</span><span class="main">]</span> <span class="main">∈</span> it_paths <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span>"</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> 4 4  <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> it_paths_RNodeE <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> it_paths_intros<span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Incredible_Trees">
<div class="head">
<h1>Theory Incredible_Trees</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Incredible_Trees
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Sublist.html">HOL-Library.Sublist</a>"</span> 
  <span class="quoted">"<a href="../../HOL/HOL-Library/Countable.html">HOL-Library.Countable</a>"</span>
  <a href="Entailment.html">Entailment</a>
  <a href="Rose_Tree.html">Rose_Tree</a>
  <a href="Abstract_Rules_To_Incredible.html">Abstract_Rules_To_Incredible</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This theory defines incredible trees, which carry roughly the same information
as a (tree-shaped) incredible graph, but where the structure is still given by the data type, 
and not by a set of edges etc.›</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Tree-shape, but incredible-graph-like content (port names, explicit annotation and substitution)
›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span><span class="tfree">'rule</span><span class="main">,</span><span class="tfree">'subst</span><span class="main">,</span><span class="tfree">'var</span><span class="main">)</span> itnode <span class="main">=</span>
    I <span class="main">(</span><span class="free"><span class="entity">iNodeOf'</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'rule</span><span class="main">)</span> graph_node"</span></span><span class="main">)</span>
      <span class="main">(</span><span class="free"><span class="entity">iOutPort'</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> reg_out_port"</span></span><span class="main">)</span>
      <span class="main">(</span><span class="free"><span class="entity">iAnnot'</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"nat"</span></span><span class="main">)</span>
      <span class="main">(</span><span class="free"><span class="entity">iSubst'</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'subst</span>"</span></span><span class="main">)</span>
  <span class="main">|</span> H <span class="main">(</span>iAnnot'<span class="main">:</span> <span class="quoted"><span class="quoted">"nat"</span></span><span class="main">)</span>
      <span class="main">(</span>iSubst'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'subst</span>"</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">INode</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ants</span></span></span> <span class="main">≡</span> RNode <span class="main">(</span>I <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ants</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">HNode</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ants</span></span></span> <span class="main">≡</span> RNode <span class="main">(</span>H <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ants</span></span></span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span><span class="tfree">'rule</span><span class="main">,</span><span class="tfree">'subst</span><span class="main">,</span><span class="tfree">'var</span><span class="main">)</span> itree <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'form</span><span class="main">,</span><span class="tfree">'rule</span><span class="main">,</span><span class="tfree">'subst</span><span class="main">,</span><span class="tfree">'var</span><span class="main">)</span> itnode rose_tree"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">iNodeOf</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">iNodeOf</span> <span class="main">(</span>INode <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ants</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>
 <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">iNodeOf</span> <span class="main">(</span>HNode <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ants</span></span></span><span class="main">)</span> <span class="main">=</span> Helper"</span></span>

<span class="keyword1"><span class="command">context</span></span> Abstract_Formulas <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">iOutPort</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">iOutPort</span> <span class="main">(</span>INode <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ants</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>
 <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">iOutPort</span> <span class="main">(</span>HNode <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ants</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">anyP</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">iAnnot</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">iAnnot</span> <span class="free"><span class="bound"><span class="entity">it</span></span></span> <span class="main">=</span> iAnnot' <span class="main">(</span>root <span class="free"><span class="bound"><span class="entity">it</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">iSubst</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">iSubst</span> <span class="free"><span class="bound"><span class="entity">it</span></span></span> <span class="main">=</span> iSubst' <span class="main">(</span>root <span class="free"><span class="bound"><span class="entity">it</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">iAnts</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">iAnts</span> <span class="free"><span class="bound"><span class="entity">it</span></span></span> <span class="main">=</span> children <span class="free"><span class="bound"><span class="entity">it</span></span></span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'rule</span><span class="main">,</span> <span class="tfree">'subst</span><span class="main">)</span> fresh_check <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'rule</span><span class="main">)</span> graph_node <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'subst</span> <span class="main">⇒</span> <span class="tfree">'form</span> entailment <span class="main">⇒</span> bool"</span></span>

<span class="keyword1"><span class="command">context</span></span>  Abstract_Task
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The well-formedness of the tree. The first argument can be varied, depending on whether we
  are interested in the local freshness side-conditions or not.›</span></span>

  <span class="keyword1"><span class="command">inductive</span></span> <span class="entity">iwf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'rule</span><span class="main">,</span> <span class="tfree">'subst</span><span class="main">)</span> fresh_check <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span><span class="tfree">'rule</span><span class="main">,</span><span class="tfree">'subst</span><span class="main">,</span><span class="tfree">'var</span><span class="main">)</span> itree <span class="main">⇒</span> <span class="tfree">'form</span> entailment <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">fc</span>
    <span class="keyword2"><span class="keyword">where</span></span>
    iwf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>
       <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∈</span> sset nodes<span class="main">;</span>
       Reg <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">|∈|</span> outPorts <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">;</span>
       list_all2 <span class="main">(</span><span class="main">λ</span> <span class="bound">ip</span> <span class="bound">t</span><span class="main">.</span> <span class="free">iwf</span> <span class="free">fc</span> <span class="bound">t</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">h</span> <span class="main">.</span> <span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>freshen <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>labelsOut <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">h</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|`|</span> hyps_for <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">ip</span> <span class="main">|∪|</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⊢</span> <span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>freshen <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>labelsIn <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">ip</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                <span class="main">(</span>inPorts' <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ants</span></span></span><span class="main">;</span>
       <span class="free">fc</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">;</span>
       <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>freshen <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>
      <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">iwf</span> <span class="free">fc</span> <span class="main">(</span>INode <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ants</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>  
  <span class="main">|</span> iwfH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>
       <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">|∉|</span> ass_forms<span class="main">;</span>
       <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">|∈|</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">;</span>
       <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>freshen <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free">anyP</span><span class="main">)</span>
      <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">iwf</span> <span class="free">fc</span> <span class="main">(</span>HNode <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>  

<span class="keyword1" id="Incredible_Trees-iwf_subst_freshen_outPort"><span class="command">lemma</span></span> iwf_subst_freshen_outPort<span class="main">:</span>
  <span class="quoted"><span class="quoted">"iwf <span class="free">lc</span> <span class="free">ts</span> <span class="free">ent</span> <span class="main">⟹</span>
  snd <span class="free">ent</span> <span class="main">=</span> <span class="free">subst</span> <span class="main">(</span>iSubst <span class="free">ts</span><span class="main">)</span> <span class="main">(</span>freshen <span class="main">(</span>iAnnot <span class="free">ts</span><span class="main">)</span> <span class="main">(</span>iOutPort <span class="free">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> iwf.cases<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">all_local_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'rule</span><span class="main">)</span> graph_node <span class="main">⇒</span> <span class="tfree">'var</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">all_local_vars</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>local_vars <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">`</span> fset <span class="main">(</span>inPorts <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Incredible_Trees-all_local_vars_Helper"><span class="command">lemma</span></span> all_local_vars_Helper<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"all_local_vars Helper <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> all_local_vars_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Incredible_Trees-all_local_vars_Assumption"><span class="command">lemma</span></span> all_local_vars_Assumption<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"all_local_vars <span class="main">(</span>Assumption <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> all_local_vars_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Local freshness side-conditions, corresponding what we have in the
theory <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Natural_Deduction›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">local_fresh_check</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'rule</span><span class="main">,</span> <span class="tfree">'subst</span><span class="main">)</span> fresh_check"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⋀</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">|∈|</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⟹</span> <span class="free">freshenLC</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">`</span> <span class="main">(</span>all_local_vars <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">∩</span> <span class="free">lconsts</span> <span class="bound">f</span> <span class="main">=</span> <span class="main">{}</span><span class="main">;</span>
    <span class="free">freshenLC</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">`</span> <span class="main">(</span>all_local_vars <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">∩</span> <span class="free">subst_lconsts</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">{}</span>
   <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">local_fresh_check</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">local_iwf</span> <span class="main">≡</span> iwf local_fresh_check"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹No freshness side-conditions. Used with the tree that comes out of
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>globalize›</span></span></span></span>, where we establish the (global) freshness conditions
separately.›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">no_fresh_check</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'rule</span><span class="main">,</span> <span class="tfree">'subst</span><span class="main">)</span> fresh_check"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">no_fresh_check</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">plain_iwf</span> <span class="main">≡</span> iwf no_fresh_check"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">isHNode</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">isHNode</span> <span class="main">(</span>HNode <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">)</span> <span class="main">=</span> True"</span></span>
 <span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">isHNode</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1" id="Incredible_Trees-iwf_edge_match"><span class="command">lemma</span></span> iwf_edge_match<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"iwf <span class="free">fc</span> <span class="free">t</span> <span class="free">ent</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span><span class="main">@</span><span class="main">[</span><span class="free">i</span><span class="main">]</span> <span class="main">∈</span> it_paths <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="main">(</span>iSubst <span class="main">(</span>tree_at <span class="free">t</span> <span class="main">(</span><span class="free">is</span><span class="main">@</span><span class="main">[</span><span class="free">i</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>freshen <span class="main">(</span>iAnnot <span class="main">(</span>tree_at <span class="free">t</span> <span class="main">(</span><span class="free">is</span><span class="main">@</span><span class="main">[</span><span class="free">i</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>iOutPort <span class="main">(</span>tree_at <span class="free">t</span> <span class="main">(</span><span class="free">is</span><span class="main">@</span><span class="main">[</span><span class="free">i</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
     <span class="main">=</span> <span class="free">subst</span> <span class="main">(</span>iSubst <span class="main">(</span>tree_at <span class="free">t</span> <span class="free">is</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>freshen <span class="main">(</span>iAnnot <span class="main">(</span>tree_at <span class="free">t</span> <span class="free">is</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>a_conc <span class="main">(</span>inPorts' <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="free">t</span> <span class="free">is</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span>"</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> it_paths_SnocE<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> <span class="quoted">"is"</span> i<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">is</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_all2_nthD2<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">using</span></span> iwf_subst_freshen_outPort
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹(<span class="operator">auto</span>)<span class="keyword3">[</span>1<span class="keyword3">]</span>›</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> it_paths_ConsE <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_all2_nthD2<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
   <span class="keyword1"><span class="command">using</span></span> it_path_SnocI
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Incredible_Trees-iwf_length_inPorts"><span class="command">lemma</span></span> iwf_length_inPorts<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"iwf <span class="free">fc</span> <span class="free">t</span> <span class="free">ent</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">∈</span> it_paths <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>iAnts <span class="main">(</span>tree_at <span class="free">t</span> <span class="free">is</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span>inPorts' <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="free">t</span> <span class="free">is</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> iwf.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> it_paths_RNodeE <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all2_lengthD list_all2_nthD2<span class="main">)</span>

<span class="keyword1" id="Incredible_Trees-iwf_local_not_in_subst"><span class="command">lemma</span></span> iwf_local_not_in_subst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"local_iwf <span class="free">t</span> <span class="free">ent</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">∈</span> it_paths <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">var</span> <span class="main">∈</span> all_local_vars <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="free">t</span> <span class="free">is</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">freshenLC</span> <span class="main">(</span>iAnnot <span class="main">(</span>tree_at <span class="free">t</span> <span class="free">is</span><span class="main">)</span><span class="main">)</span> <span class="free">var</span> <span class="main">∉</span> <span class="free">subst_lconsts</span> <span class="main">(</span>iSubst <span class="main">(</span>tree_at <span class="free">t</span> <span class="free">is</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> iwf.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> it_paths_RNodeE local_fresh_check.cases <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all2_lengthD list_all2_nthD2<span class="main">)</span>
  
<span class="keyword1" id="Incredible_Trees-iwf_length_inPorts_not_HNode"><span class="command">lemma</span></span> iwf_length_inPorts_not_HNode<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"iwf <span class="free">fc</span> <span class="free">t</span> <span class="free">ent</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">∈</span> it_paths <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>isHNode <span class="main">(</span>tree_at <span class="free">t</span> <span class="free">is</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>iAnts <span class="main">(</span>tree_at <span class="free">t</span> <span class="free">is</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>inPorts' <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="free">t</span> <span class="free">is</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> iwf.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> it_paths_RNodeE  <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all2_lengthD list_all2_nthD2<span class="main">)</span>

<span class="keyword1" id="Incredible_Trees-iNodeOf_outPorts"><span class="command">lemma</span></span> iNodeOf_outPorts<span class="main">:</span>
  <span class="quoted"><span class="quoted">"iwf <span class="free">fc</span> <span class="free">t</span> <span class="free">ent</span> <span class="main">⟹</span> <span class="free">is</span> <span class="main">∈</span> it_paths <span class="free">t</span> <span class="main">⟹</span> outPorts <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="free">t</span> <span class="free">is</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{||}</span> <span class="main">⟹</span> False"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> iwf.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> it_paths_RNodeE  <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all2_lengthD list_all2_nthD2<span class="main">)</span>

<span class="keyword1" id="Incredible_Trees-iNodeOf_tree_at"><span class="command">lemma</span></span> iNodeOf_tree_at<span class="main">:</span>
  <span class="quoted"><span class="quoted">"iwf <span class="free">fc</span> <span class="free">t</span> <span class="free">ent</span> <span class="main">⟹</span> <span class="free">is</span> <span class="main">∈</span> it_paths <span class="free">t</span> <span class="main">⟹</span> iNodeOf <span class="main">(</span>tree_at <span class="free">t</span> <span class="free">is</span><span class="main">)</span> <span class="main">∈</span> sset nodes"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> iwf.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> it_paths_RNodeE  <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all2_lengthD list_all2_nthD2<span class="main">)</span>

<span class="keyword1" id="Incredible_Trees-iwf_outPort"><span class="command">lemma</span></span> iwf_outPort<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"iwf <span class="free">fc</span> <span class="free">t</span> <span class="free">ent</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">∈</span> it_paths <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Reg <span class="main">(</span>iOutPort <span class="main">(</span>tree_at <span class="free">t</span> <span class="free">is</span><span class="main">)</span><span class="main">)</span> <span class="main">|∈|</span> outPorts <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="free">t</span> <span class="free">is</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> iwf.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> it_paths_RNodeE  <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all2_lengthD list_all2_nthD2<span class="main">)</span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">hyps_along</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">t</span> <span class="quoted">"<span class="entity">is</span>"</span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"prefix <span class="main">(</span><span class="free"><span class="bound"><span class="entity">is'</span></span></span><span class="main">@</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">]</span><span class="main">)</span> <span class="free">is</span> <span class="main">⟹</span>
  <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>inPorts' <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="free">t</span> <span class="free"><span class="bound"><span class="entity">is'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
  hyps <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="free">t</span> <span class="free"><span class="bound"><span class="entity">is'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">=</span> Some <span class="main">(</span>inPorts' <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="free">t</span> <span class="free"><span class="bound"><span class="entity">is'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">subst</span> <span class="main">(</span>iSubst <span class="main">(</span>tree_at <span class="free">t</span> <span class="free"><span class="bound"><span class="entity">is'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>freshen <span class="main">(</span>iAnnot <span class="main">(</span>tree_at <span class="free">t</span> <span class="free"><span class="bound"><span class="entity">is'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>labelsOut <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="free">t</span> <span class="free"><span class="bound"><span class="entity">is'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">hyps_along</span> <span class="free">t</span> <span class="free">is</span>"</span></span>

<span class="keyword1" id="Incredible_Trees-hyps_along_Nil"><span class="command">lemma</span></span> hyps_along_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"hyps_along <span class="free">t</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hyps_along.simps<span class="main">)</span>

<span class="keyword1" id="Incredible_Trees-prefix_app_Cons_elim"><span class="command">lemma</span></span> prefix_app_Cons_elim<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prefix <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">z</span><span class="main">#</span><span class="free">zs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="free">z</span>"</span></span>
   <span class="main">|</span> <span class="free">xs'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">z</span><span class="main">#</span><span class="free">xs'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"prefix <span class="main">(</span><span class="free">xs'</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="free">zs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Incredible_Trees-hyps_along_Cons"><span class="command">lemma</span></span> hyps_along_Cons<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"iwf <span class="free">fc</span> <span class="free">t</span> <span class="free">ent</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">#</span><span class="free">is</span> <span class="main">∈</span> it_paths <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hyps_along <span class="free">t</span> <span class="main">(</span><span class="free">i</span><span class="main">#</span><span class="free">is</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">h</span><span class="main">.</span> <span class="free">subst</span> <span class="main">(</span>iSubst <span class="free">t</span><span class="main">)</span> <span class="main">(</span>freshen <span class="main">(</span>iAnnot <span class="free">t</span><span class="main">)</span> <span class="main">(</span>labelsOut <span class="main">(</span>iNodeOf <span class="free">t</span><span class="main">)</span> <span class="bound">h</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> fset <span class="main">(</span>hyps_for <span class="main">(</span>iNodeOf <span class="free">t</span><span class="main">)</span> <span class="main">(</span>inPorts' <span class="main">(</span>iNodeOf <span class="free">t</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>
    <span class="main">∪</span> hyps_along <span class="main">(</span>iAnts <span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">is</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S1</span> <span class="main">=</span> <span class="var">?S2</span> <span class="main">∪</span> <span class="var">?S3</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>iAnts <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">∈</span> it_paths <span class="main">(</span>iAnts <span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> it_paths_ConsE<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t'</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"iAnts <span class="free">t</span> <span class="main">!</span> <span class="free">i</span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> hyps_along <span class="free">t</span> <span class="main">(</span><span class="free">i</span> <span class="main">#</span> <span class="free">is</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">is'</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"prefix <span class="main">(</span><span class="skolem">is'</span><span class="main">@</span><span class="main">[</span><span class="skolem">i'</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span><span class="main">#</span><span class="free">is</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> length <span class="main">(</span>inPorts' <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="free">t</span> <span class="skolem">is'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hyps <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="free">t</span> <span class="skolem">is'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">h</span> <span class="main">=</span> Some <span class="main">(</span>inPorts' <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="free">t</span> <span class="skolem">is'</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">subst</span> <span class="main">(</span>iSubst <span class="main">(</span>tree_at <span class="free">t</span> <span class="skolem">is'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>freshen <span class="main">(</span>iAnnot <span class="main">(</span>tree_at <span class="free">t</span> <span class="skolem">is'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>labelsOut <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="free">t</span> <span class="skolem">is'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">h</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> hyps_along.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?S2</span> <span class="main">∪</span> <span class="var">?S3</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> prefix_app_Cons_elim<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is'</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹hyps <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="free">t</span> <span class="skolem">is'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">h</span> <span class="main">=</span> Some <span class="main">_</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?S2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">is''</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">is'</span> <span class="main">=</span> <span class="free">i</span> <span class="main">#</span> <span class="skolem">is''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"prefix <span class="main">(</span><span class="skolem">is''</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i'</span><span class="main">]</span><span class="main">)</span> <span class="free">is</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tree_at <span class="free">t</span> <span class="skolem">is'</span> <span class="main">=</span> tree_at <span class="var">?t'</span> <span class="skolem">is''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹prefix <span class="main">(</span><span class="skolem">is''</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i'</span><span class="main">]</span><span class="main">)</span> <span class="free">is</span>›</span></span>
           <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">&lt;</span> length <span class="main">(</span>inPorts' <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="free">t</span> <span class="skolem">is'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span>
           <span class="quoted"><span class="quoted">‹hyps <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="free">t</span> <span class="skolem">is'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">h</span> <span class="main">=</span> Some <span class="main">(</span>inPorts' <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="free">t</span> <span class="skolem">is'</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">‹tree_at <span class="free"><span class="free"><span class="free">t</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">is'</span></span></span> <span class="main"><span class="main"><span class="main">=</span></span></span> tree_at <span class="var"><span class="var"><span class="var">?t'</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">is''</span></span></span>›</span></span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="main">(</span>iSubst <span class="main">(</span>tree_at <span class="main">(</span>iAnts <span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">is''</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>freshen <span class="main">(</span>iAnnot <span class="main">(</span>tree_at <span class="main">(</span>iAnts <span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">is''</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>labelsOut <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="main">(</span>iAnts <span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">is''</span><span class="main">)</span><span class="main">)</span> <span class="skolem">h</span><span class="main">)</span><span class="main">)</span>
          <span class="main">∈</span> hyps_along <span class="main">(</span>iAnts <span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">is</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> hyps_along.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?S3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?S2</span> <span class="main">∪</span> <span class="var">?S3</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?S1</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefix <span class="main">(</span><span class="main">[]</span><span class="main">@</span><span class="main">[</span><span class="free">i</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span><span class="main">#</span><span class="free">is</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹iwf <span class="main">_</span> <span class="free">t</span> <span class="main">_</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>iAnts <span class="free">t</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span>inPorts' <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="free">t</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> "</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all2_lengthD<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="main">_</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>inPorts' <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="free">t</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?S2</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">|∈|</span> hyps_for <span class="main">(</span>iNodeOf <span class="free">t</span><span class="main">)</span> <span class="main">(</span>inPorts' <span class="main">(</span>iNodeOf <span class="free">t</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">subst</span> <span class="main">(</span>iSubst <span class="free">t</span><span class="main">)</span> <span class="main">(</span>freshen <span class="main">(</span>iAnnot <span class="free">t</span><span class="main">)</span> <span class="main">(</span>labelsOut <span class="main">(</span>iNodeOf <span class="free">t</span><span class="main">)</span> <span class="skolem">h</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hyps <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="free">t</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="skolem">h</span> <span class="main">=</span> Some <span class="main">(</span>inPorts' <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="free">t</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="main">(</span>iSubst <span class="main">(</span>tree_at <span class="free">t</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>freshen <span class="main">(</span>iAnnot <span class="main">(</span>tree_at <span class="free">t</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>labelsOut <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="free">t</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="skolem">h</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> hyps_along <span class="free">t</span> <span class="main">(</span><span class="free">i</span> <span class="main">#</span> <span class="free">is</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> hyps_along.intros<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> hyps_along <span class="free">t</span> <span class="main">(</span><span class="free">i</span> <span class="main">#</span> <span class="free">is</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?S3</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?S1</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hyps_along.simps<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">#</span><span class="improper">is'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Incredible_Trees-iwf_hyps_exist"><span class="command">lemma</span></span> iwf_hyps_exist<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"iwf <span class="free">lc</span> <span class="free">it</span> <span class="free">ent</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">∈</span> it_paths <span class="free">it</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"tree_at <span class="free">it</span> <span class="free">is</span> <span class="main">=</span> <span class="main">(</span>HNode <span class="free">i</span> <span class="free">s</span> <span class="free">ants'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">ent</span> <span class="main">|⊆|</span> ass_forms"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="free">s</span> <span class="main">(</span>freshen <span class="free">i</span> <span class="free">anyP</span><span class="main">)</span> <span class="main">∈</span> hyps_along <span class="free">it</span> <span class="free">is</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="free">s</span> <span class="main">(</span>freshen <span class="free">i</span> <span class="free">anyP</span><span class="main">)</span> <span class="main">∈</span> hyps_along <span class="free">it</span> <span class="free">is</span> 
     <span class="main">∨</span> <span class="free">subst</span> <span class="free">s</span> <span class="main">(</span>freshen <span class="free">i</span> <span class="free">anyP</span><span class="main">)</span> <span class="main">|∈|</span> fst <span class="free">ent</span>
       <span class="main">∧</span> <span class="free">subst</span> <span class="free">s</span> <span class="main">(</span>freshen <span class="free">i</span> <span class="free">anyP</span><span class="main">)</span> <span class="main">|∉|</span> ass_forms"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> iwf.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>iwf <span class="skolem">n</span> <span class="skolem">p</span>  <span class="skolem">s'</span> <span class="skolem">a'</span> <span class="skolem">Γ</span> <span class="skolem">ants</span> <span class="skolem">c</span> <span class="quoted">"<span class="skolem">is</span>"</span><span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"iwf <span class="free">lc</span> <span class="main">(</span>INode <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">a'</span> <span class="skolem">s'</span> <span class="skolem">ants</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> iwf<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">,</span>4<span class="main">,</span>5<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> iwf.intros <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_all2_mono<span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹tree_at <span class="main">(</span>INode <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">a'</span> <span class="skolem">s'</span> <span class="skolem">ants</span><span class="main">)</span> <span class="skolem">is</span> <span class="main">=</span> HNode <span class="free">i</span> <span class="free">s</span> <span class="free">ants'</span>›</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">i'</span> <span class="quoted">"<span class="skolem">is'</span>"</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">∈</span> it_paths <span class="main">(</span>INode <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">a'</span> <span class="skolem">s'</span> <span class="skolem">ants</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> length <span class="skolem">ants</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is'</span> <span class="main">∈</span> it_paths <span class="main">(</span><span class="skolem">ants</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> it_paths_ConsE<span class="main">)</span>

      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Γ'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">h</span><span class="main">.</span> <span class="free">subst</span> <span class="skolem">s'</span> <span class="main">(</span>freshen <span class="skolem">a'</span> <span class="main">(</span>labelsOut <span class="skolem">n</span> <span class="bound">h</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|`|</span> hyps_for <span class="skolem">n</span> <span class="main">(</span>inPorts' <span class="skolem">n</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">)</span>"</span></span>

      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹tree_at <span class="main">(</span>INode <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">a'</span> <span class="skolem">s'</span> <span class="skolem">ants</span><span class="main">)</span> <span class="skolem">is</span> <span class="main">=</span> HNode <span class="free">i</span> <span class="free">s</span> <span class="free">ants'</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tree_at <span class="main">(</span><span class="skolem">ants</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">)</span> <span class="skolem">is'</span> <span class="main">=</span> HNode <span class="free">i</span> <span class="free">s</span> <span class="free">ants'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">from</span></span>  iwf.IH <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">&lt;</span> length <span class="skolem">ants</span>›</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">is'</span> <span class="main">∈</span> it_paths <span class="main">(</span><span class="skolem">ants</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">)</span>›</span></span> this
      <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="free">s</span> <span class="main">(</span>freshen <span class="free">i</span> <span class="free">anyP</span><span class="main">)</span> <span class="main">∈</span> hyps_along <span class="main">(</span><span class="skolem">ants</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">)</span> <span class="skolem">is'</span>
        <span class="main">∨</span> <span class="free">subst</span> <span class="free">s</span> <span class="main">(</span>freshen <span class="free">i</span> <span class="free">anyP</span><span class="main">)</span> <span class="main">|∈|</span> <span class="var">?Γ'</span> <span class="main">|∪|</span> <span class="skolem">Γ</span> <span class="main">∧</span> <span class="free">subst</span> <span class="free">s</span> <span class="main">(</span>freshen <span class="free">i</span> <span class="free">anyP</span><span class="main">)</span> <span class="main">|∉|</span> ass_forms"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all2_nthD2<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">∈</span> it_paths <span class="main">(</span>INode <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">a'</span> <span class="skolem">s'</span> <span class="skolem">ants</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hyps_along <span class="main">(</span>INode <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">a'</span> <span class="skolem">s'</span> <span class="skolem">ants</span><span class="main">)</span> <span class="skolem">is</span> <span class="main">=</span> fset <span class="var">?Γ'</span> <span class="main">∪</span> hyps_along <span class="main">(</span><span class="skolem">ants</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">)</span> <span class="skolem">is'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hyps_along_Cons<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹iwf <span class="free">lc</span> <span class="main">(</span>INode <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">a'</span> <span class="skolem">s'</span> <span class="skolem">ants</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">c</span><span class="main">)</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>iwfH <span class="skolem">c</span>  <span class="skolem">Γ</span> <span class="skolem">s'</span> <span class="skolem">i'</span> <span class="quoted">"<span class="skolem">is</span>"</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">=</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="free">subst</span> <span class="skolem">s'</span> <span class="main">(</span>freshen <span class="skolem">i'</span> <span class="free">anyP</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">|∈|</span> <span class="skolem">Γ</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">|∉|</span> ass_forms›</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>4<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">hyp_port_for'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'rule</span><span class="main">,</span> <span class="tfree">'subst</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> itree <span class="main">⇒</span> nat list <span class="main">⇒</span> <span class="tfree">'form</span> <span class="main">⇒</span> nat list <span class="main">×</span> nat <span class="main">×</span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> out_port"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">hyp_port_for'</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span>
   <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">is'</span><span class="main">,</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">h</span><span class="main">)</span> <span class="main">⇒</span> 
      prefix <span class="main">(</span><span class="bound">is'</span> <span class="main">@</span> <span class="main">[</span><span class="bound">i</span><span class="main">]</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="main">∧</span>
      <span class="bound">i</span> <span class="main">&lt;</span> length <span class="main">(</span>inPorts' <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">is'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      hyps <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">is'</span><span class="main">)</span><span class="main">)</span> <span class="bound">h</span> <span class="main">=</span>  Some <span class="main">(</span>inPorts' <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">is'</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span>
      <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="free">subst</span> <span class="main">(</span>iSubst  <span class="main">(</span>tree_at <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">is'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>freshen <span class="main">(</span>iAnnot <span class="main">(</span>tree_at <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">is'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>labelsOut <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">is'</span><span class="main">)</span><span class="main">)</span> <span class="bound">h</span><span class="main">)</span><span class="main">)</span>
   <span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Incredible_Trees-hyp_port_for_spec'"><span class="command">lemma</span></span> hyp_port_for_spec'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> hyps_along <span class="free">t</span> <span class="free">is</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> hyp_port_for' <span class="free">t</span> <span class="free">is</span> <span class="free">f</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">is'</span><span class="main">,</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">h</span><span class="main">)</span> <span class="main">⇒</span> 
      prefix <span class="main">(</span><span class="bound">is'</span> <span class="main">@</span> <span class="main">[</span><span class="bound">i</span><span class="main">]</span><span class="main">)</span> <span class="free">is</span> <span class="main">∧</span>
      <span class="bound">i</span> <span class="main">&lt;</span> length <span class="main">(</span>inPorts' <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="free">t</span> <span class="bound">is'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      hyps <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="free">t</span> <span class="bound">is'</span><span class="main">)</span><span class="main">)</span> <span class="bound">h</span> <span class="main">=</span>  Some <span class="main">(</span>inPorts' <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="free">t</span> <span class="bound">is'</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span>
      <span class="free">f</span> <span class="main">=</span> <span class="free">subst</span> <span class="main">(</span>iSubst  <span class="main">(</span>tree_at <span class="free">t</span> <span class="bound">is'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>freshen <span class="main">(</span>iAnnot <span class="main">(</span>tree_at <span class="free">t</span> <span class="bound">is'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>labelsOut <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="free">t</span> <span class="bound">is'</span><span class="main">)</span><span class="main">)</span> <span class="bound">h</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> hyps_along.simps hyp_port_for'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span><span class="main">(</span><span class="operator">rule</span> someI_ex<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">hyp_port_path_for</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'rule</span><span class="main">,</span> <span class="tfree">'subst</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> itree <span class="main">⇒</span> nat list <span class="main">⇒</span> <span class="tfree">'form</span> <span class="main">⇒</span> nat list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">hyp_port_path_for</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> fst <span class="main">(</span>hyp_port_for' <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">hyp_port_i_for</span> <span class="main">::</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'rule</span><span class="main">,</span> <span class="tfree">'subst</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> itree <span class="main">⇒</span> nat list <span class="main">⇒</span> <span class="tfree">'form</span> <span class="main">⇒</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">hyp_port_i_for</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> fst <span class="main">(</span>snd <span class="main">(</span>hyp_port_for' <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">hyp_port_h_for</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'rule</span><span class="main">,</span> <span class="tfree">'subst</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> itree <span class="main">⇒</span> nat list <span class="main">⇒</span> <span class="tfree">'form</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> out_port"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">hyp_port_h_for</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> snd <span class="main">(</span>snd <span class="main">(</span>hyp_port_for' <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Incredible_Trees-hyp_port_prefix"><span class="command">lemma</span></span> hyp_port_prefix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> hyps_along <span class="free">t</span> <span class="free">is</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"prefix <span class="main">(</span>hyp_port_path_for <span class="free">t</span> <span class="free">is</span> <span class="free">f</span><span class="main">@</span><span class="main">[</span>hyp_port_i_for <span class="free">t</span> <span class="free">is</span> <span class="free">f</span><span class="main">]</span><span class="main">)</span> <span class="free">is</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> hyp_port_for_spec'<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> hyp_port_path_for_def hyp_port_i_for_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Incredible_Trees-hyp_port_strict_prefix"><span class="command">lemma</span></span> hyp_port_strict_prefix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> hyps_along <span class="free">t</span> <span class="free">is</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"strict_prefix <span class="main">(</span>hyp_port_path_for <span class="free">t</span> <span class="free">is</span> <span class="free">f</span><span class="main">)</span> <span class="free">is</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> hyp_port_prefix<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> strict_prefixI' prefix_order.dual_order.strict_trans1<span class="main">)</span>

<span class="keyword1" id="Incredible_Trees-hyp_port_it_paths"><span class="command">lemma</span></span> hyp_port_it_paths<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">∈</span> it_paths <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> hyps_along <span class="free">t</span> <span class="free">is</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hyp_port_path_for <span class="free">t</span> <span class="free">is</span> <span class="free">f</span> <span class="main">∈</span> it_paths <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> it_paths_strict_prefix<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ hyp_port_strict_prefix<span class="main"><span class="main">]</span></span> <span class="main">)</span>


<span class="keyword1" id="Incredible_Trees-hyp_port_hyps"><span class="command">lemma</span></span> hyp_port_hyps<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> hyps_along <span class="free">t</span> <span class="free">is</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hyps <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="free">t</span> <span class="main">(</span>hyp_port_path_for <span class="free">t</span> <span class="free">is</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>hyp_port_h_for <span class="free">t</span> <span class="free">is</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>inPorts' <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="free">t</span> <span class="main">(</span>hyp_port_path_for <span class="free">t</span> <span class="free">is</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> hyp_port_i_for <span class="free">t</span> <span class="free">is</span> <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> hyp_port_for_spec'<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> hyp_port_path_for_def hyp_port_i_for_def hyp_port_h_for_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Incredible_Trees-hyp_port_outPort"><span class="command">lemma</span></span> hyp_port_outPort<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> hyps_along <span class="free">t</span> <span class="free">is</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>hyp_port_h_for <span class="free">t</span> <span class="free">is</span> <span class="free">f</span><span class="main">)</span> <span class="main">|∈|</span> outPorts <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="free">t</span> <span class="main">(</span>hyp_port_path_for <span class="free">t</span> <span class="free">is</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> hyps_correct<span class="main">[</span><span class="operator">OF</span> hyp_port_hyps<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">..</span></span>

<span class="keyword1" id="Incredible_Trees-hyp_port_eq"><span class="command">lemma</span></span> hyp_port_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> hyps_along <span class="free">t</span> <span class="free">is</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">subst</span> <span class="main">(</span>iSubst <span class="main">(</span>tree_at <span class="free">t</span> <span class="main">(</span>hyp_port_path_for <span class="free">t</span> <span class="free">is</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>freshen <span class="main">(</span>iAnnot <span class="main">(</span>tree_at <span class="free">t</span> <span class="main">(</span>hyp_port_path_for <span class="free">t</span> <span class="free">is</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>labelsOut <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="free">t</span> <span class="main">(</span>hyp_port_path_for <span class="free">t</span> <span class="free">is</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>hyp_port_h_for <span class="free">t</span> <span class="free">is</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> hyp_port_for_spec'<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> hyp_port_path_for_def hyp_port_i_for_def hyp_port_h_for_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">isidx</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">isidx</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> to_nat <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">v_away</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">v_away</span> <span class="main">=</span> to_nat <span class="main">(</span>None <span class="main">::</span> nat list option<span class="main">)</span>"</span></span>
<span class="keyword1" id="Incredible_Trees-isidx_inj"><span class="command">lemma</span></span> isidx_inj<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"isidx <span class="free">xs</span> <span class="main">=</span> isidx <span class="free">ys</span> <span class="main">⟷</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> isidx_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1" id="Incredible_Trees-isidx_v_away"><span class="command">lemma</span></span> isidx_v_away<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"isidx <span class="free">xs</span> <span class="main">≠</span> v_away"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> isidx_def v_away_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mapWithIndex</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">mapWithIndex</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">i</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>List.enumerate <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1" id="Incredible_Trees-mapWithIndex_cong"><span class="command">lemma</span></span> mapWithIndex_cong <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">ys</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">i</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> mapWithIndex <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> mapWithIndex <span class="free">g</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> mapWithIndex_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_enumerate_eq<span class="main">)</span>

<span class="keyword1" id="Incredible_Trees-mapWithIndex_Nil"><span class="command">lemma</span></span> mapWithIndex_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mapWithIndex <span class="free">f</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mapWithIndex_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Incredible_Trees-length_mapWithIndex"><span class="command">lemma</span></span> length_mapWithIndex<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>mapWithIndex <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mapWithIndex_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Incredible_Trees-nth_mapWithIndex"><span class="command">lemma</span></span> nth_mapWithIndex<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> mapWithIndex <span class="free">f</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">f</span> <span class="free">i</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mapWithIndex_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_enumerate_eq<span class="main">)</span>

<span class="keyword1" id="Incredible_Trees-list_all2_mapWithIndex2E"><span class="command">lemma</span></span> list_all2_mapWithIndex2E<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">P</span> <span class="free">as</span> <span class="free">bs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">bs</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">a</span> <span class="main">(</span><span class="free">f</span> <span class="bound">i</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">Q</span> <span class="free">as</span> <span class="main">(</span>mapWithIndex <span class="free">f</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_conv_all_nth mapWithIndex_def nth_enumerate_eq <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The globalize function, which renames all local constants so that they cannot clash with 
local constants occurring anywhere else in the tree.›</span></span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">globalize_node</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'var</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span><span class="tfree">'rule</span><span class="main">,</span><span class="tfree">'subst</span><span class="main">,</span><span class="tfree">'var</span><span class="main">)</span> itnode <span class="main">⇒</span>  <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span><span class="tfree">'rule</span><span class="main">,</span><span class="tfree">'subst</span><span class="main">,</span><span class="tfree">'var</span><span class="main">)</span> itnode"</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">globalize_node</span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>I <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span>  I <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>isidx <span class="free"><span class="bound"><span class="entity">is</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">subst_renameLCs</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">globalize_node</span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>H <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> H <span class="main">(</span>isidx <span class="free"><span class="bound"><span class="entity">is</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">subst_renameLCs</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">globalize</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'var</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span><span class="tfree">'rule</span><span class="main">,</span><span class="tfree">'subst</span><span class="main">,</span><span class="tfree">'var</span><span class="main">)</span> itree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span><span class="tfree">'rule</span><span class="main">,</span><span class="tfree">'subst</span><span class="main">,</span><span class="tfree">'var</span><span class="main">)</span> itree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">globalize</span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>RNode <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">ants</span></span></span><span class="main">)</span> <span class="main">=</span> RNode 
    <span class="main">(</span>globalize_node <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>
    <span class="main">(</span>mapWithIndex <span class="main">(</span><span class="main">λ</span> <span class="bound">i'</span> <span class="bound">t</span><span class="main">.</span>
      <span class="free">globalize</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">is</span></span></span><span class="main">@</span><span class="main">[</span><span class="bound">i'</span><span class="main">]</span><span class="main">)</span>
                <span class="main">(</span>rerename <span class="main">(</span>a_fresh <span class="main">(</span>inPorts' <span class="main">(</span>iNodeOf <span class="main">(</span>RNode <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">ants</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i'</span><span class="main">)</span><span class="main">)</span>
                          <span class="main">(</span>iAnnot <span class="main">(</span>RNode <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">ants</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>isidx <span class="free"><span class="bound"><span class="entity">is</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>
                <span class="bound">t</span>
      <span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ants</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Incredible_Trees-iAnnot'_globalize_node"><span class="command">lemma</span></span> iAnnot'_globalize_node<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"iAnnot' <span class="main">(</span>globalize_node <span class="free">is</span> <span class="free">f</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> isidx <span class="free">is</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Incredible_Trees-iAnnot_globalize"><span class="command">lemma</span></span> iAnnot_globalize<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">is'</span> <span class="main">∈</span> it_paths <span class="main">(</span>globalize <span class="free">is</span> <span class="free">f</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"iAnnot <span class="main">(</span>tree_at <span class="main">(</span>globalize <span class="free">is</span> <span class="free">f</span> <span class="free">t</span><span class="main">)</span> <span class="free">is'</span><span class="main">)</span> <span class="main">=</span> isidx <span class="main">(</span><span class="free">is</span><span class="main">@</span><span class="free">is'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span>"</span></span> <span class="quoted"><span class="free">is'</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> it_paths_RNodeE<span class="main">)</span>

<span class="keyword1" id="Incredible_Trees-all_local_consts_listed'"><span class="command">lemma</span></span> all_local_consts_listed'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> sset nodes"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">|∈|</span> inPorts <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">lconsts</span> <span class="main">(</span>a_conc <span class="free">p</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">lconsts</span> <span class="main">`</span> fset <span class="main">(</span>a_hyps <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> a_fresh <span class="free">p</span> "</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nodes_def stream.set_map lconsts_anyP closed_no_lconsts conclusions_closed fmember.rep_eq f_antecedent_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> all_local_consts_listed<span class="main">)</span>

<span class="keyword1" id="Incredible_Trees-no_local_consts_in_consequences'"><span class="command">lemma</span></span> no_local_consts_in_consequences'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> sset nodes <span class="main">⟹</span> Reg <span class="free">p</span> <span class="main">|∈|</span> outPorts <span class="free">n</span> <span class="main">⟹</span>  <span class="free">lconsts</span> <span class="free">p</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> no_local_consts_in_consequences
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nodes_def lconsts_anyP closed_no_lconsts assumptions_closed stream.set_map f_consequent_def<span class="main">)</span>

<span class="keyword1" id="Incredible_Trees-iwf_globalize"><span class="command">lemma</span></span> iwf_globalize<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"local_iwf <span class="free">t</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"plain_iwf <span class="main">(</span>globalize <span class="free">is</span> <span class="free">f</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="free">renameLCs</span> <span class="free">f</span> <span class="main">|`|</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">renameLCs</span> <span class="free">f</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">c</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span>"</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> iwf.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>iwf <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">s</span> <span class="skolem">i</span> <span class="skolem">Γ</span> <span class="skolem">ants</span> <span class="skolem">c</span> <span class="quoted">"<span class="skolem">is</span>"</span> <span class="skolem">f</span><span class="main">)</span>

  <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">∈</span> sset nodes›</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹Reg <span class="skolem">p</span> <span class="main">|∈|</span> outPorts <span class="skolem">n</span>›</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i'</span> 
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?V</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"a_fresh <span class="main">(</span>inPorts' <span class="skolem">n</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rerename <span class="var">?V</span> <span class="skolem">i</span> <span class="main">(</span>isidx <span class="skolem">is</span><span class="main">)</span> <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"globalize <span class="main">(</span><span class="skolem">is</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i'</span><span class="main">]</span><span class="main">)</span> <span class="var">?f'</span> <span class="main">(</span><span class="skolem">ants</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ip</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"inPorts' <span class="skolem">n</span> <span class="main">!</span> <span class="skolem">i'</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Γ'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">h</span><span class="main">.</span> <span class="free">subst</span> <span class="main">(</span><span class="free">subst_renameLCs</span> <span class="skolem">f</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>freshen <span class="main">(</span>isidx <span class="skolem">is</span><span class="main">)</span> <span class="main">(</span>labelsOut <span class="skolem">n</span> <span class="bound">h</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|`|</span> hyps_for <span class="skolem">n</span> <span class="var">?ip</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="main">(</span><span class="free">subst_renameLCs</span> <span class="skolem">f</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>freshen <span class="main">(</span>isidx <span class="skolem">is</span><span class="main">)</span> <span class="main">(</span>labelsIn <span class="skolem">n</span> <span class="var">?ip</span><span class="main">)</span><span class="main">)</span>"</span></span>

    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> length <span class="main">(</span>inPorts' <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>inPorts' <span class="skolem">n</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">|∈|</span> inPorts <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inPorts_fset_of<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">&lt;</span> length <span class="main">(</span>inPorts' <span class="skolem">n</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> subset_V<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?V</span> <span class="main">⊆</span> all_local_vars <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> all_local_vars_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inPorts_fset_of set_conv_nth<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹local_fresh_check <span class="skolem">n</span> <span class="skolem">i</span> <span class="skolem">s</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">c</span><span class="main">)</span>›</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">freshenLC</span> <span class="skolem">i</span> <span class="main">`</span> all_local_vars <span class="skolem">n</span> <span class="main">∩</span> <span class="free">subst_lconsts</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> local_fresh_check.cases<span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">freshenLC</span> <span class="skolem">i</span> <span class="main">`</span> <span class="var">?V</span> <span class="main">∩</span> <span class="free">subst_lconsts</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> subset_V  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> rerename_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">subst_renameLCs</span> <span class="var">?f'</span> <span class="skolem">s</span> <span class="main">=</span> <span class="free">subst_renameLCs</span> <span class="skolem">f</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rerename_subst_noop<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> all_local_consts_listed'<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹ <span class="skolem">n</span> <span class="main">∈</span> sset nodes›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>inPorts' <span class="skolem">n</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">|∈|</span> inPorts <span class="skolem">n</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> subset_conc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lconsts</span> <span class="main">(</span>a_conc <span class="main">(</span>inPorts' <span class="skolem">n</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="var">?V</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> subset_hyp'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">hyp</span> <span class="main">.</span> <span class="bound">hyp</span> <span class="main">|∈|</span> a_hyps <span class="main">(</span>inPorts' <span class="skolem">n</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">lconsts</span> <span class="bound">hyp</span> <span class="main">⊆</span> <span class="var">?V</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmember.rep_eq<span class="main">)</span>
      
    <span class="keyword1"><span class="command">from</span></span> List.list_all2_nthD<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹list_all2 <span class="main">_</span> <span class="main">_</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">&lt;</span> length <span class="main">(</span>inPorts' <span class="skolem">n</span><span class="main">)</span>›</span></span><span class="main">,</span><span class="operator">simplified</span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"plain_iwf <span class="var">?t</span>
           <span class="main">(</span><span class="free">renameLCs</span> <span class="var">?f'</span> <span class="main">|`|</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">h</span><span class="main">.</span> <span class="free">subst</span> <span class="skolem">s</span> <span class="main">(</span>freshen <span class="skolem">i</span> <span class="main">(</span>labelsOut <span class="skolem">n</span> <span class="bound">h</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|`|</span> hyps_for <span class="skolem">n</span> <span class="var">?ip</span> <span class="main">|∪|</span>  <span class="skolem">Γ</span><span class="main">)</span> <span class="main">⊢</span>
            <span class="free">renameLCs</span> <span class="var">?f'</span> <span class="main">(</span><span class="free">subst</span> <span class="skolem">s</span> <span class="main">(</span>freshen <span class="skolem">i</span> <span class="main">(</span>a_conc <span class="var">?ip</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">renameLCs</span> <span class="var">?f'</span> <span class="main">|`|</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">h</span><span class="main">.</span> <span class="free">subst</span> <span class="skolem">s</span> <span class="main">(</span>freshen <span class="skolem">i</span> <span class="main">(</span>labelsOut <span class="skolem">n</span> <span class="bound">h</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|`|</span> hyps_for <span class="skolem">n</span> <span class="var">?ip</span> <span class="main">|∪|</span>  <span class="skolem">Γ</span><span class="main">)</span>
      <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">subst</span> <span class="main">(</span><span class="free">subst_renameLCs</span> <span class="var">?f'</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span><span class="free">renameLCs</span> <span class="var">?f'</span> <span class="main">(</span>freshen <span class="skolem">i</span> <span class="main">(</span>labelsOut <span class="skolem">n</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|`|</span>  hyps_for <span class="skolem">n</span> <span class="var">?ip</span> <span class="main">|∪|</span> <span class="free">renameLCs</span> <span class="var">?f'</span> <span class="main">|`|</span> <span class="skolem">Γ</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fimage_fimage fimage_funion comp_def rename_subst<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">renameLCs</span> <span class="var">?f'</span> <span class="main">|`|</span> <span class="skolem">Γ</span> <span class="main">=</span>  <span class="free">renameLCs</span> <span class="skolem">f</span> <span class="main">|`|</span> <span class="skolem">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> fimage_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">|∈|</span> <span class="skolem">Γ</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹local_fresh_check <span class="skolem">n</span> <span class="skolem">i</span> <span class="skolem">s</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">c</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">freshenLC</span> <span class="skolem">i</span> <span class="main">`</span> all_local_vars <span class="skolem">n</span> <span class="main">∩</span> <span class="free">lconsts</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> local_fresh_check.cases<span class="main">)</span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">freshenLC</span> <span class="skolem">i</span> <span class="main">`</span> <span class="var">?V</span> <span class="main">∩</span> <span class="free">lconsts</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> subset_V  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">renameLCs</span> <span class="var">?f'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">renameLCs</span> <span class="skolem">f</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rerename_rename_noop<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">subst</span> <span class="main">(</span><span class="free">subst_renameLCs</span> <span class="var">?f'</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span><span class="free">renameLCs</span> <span class="var">?f'</span> <span class="main">(</span>freshen <span class="skolem">i</span> <span class="main">(</span>labelsOut <span class="skolem">n</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|`|</span>  hyps_for <span class="skolem">n</span> <span class="var">?ip</span> <span class="main">=</span> <span class="var">?Γ'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> fimage_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">hyp</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">hyp</span> <span class="main">|∈|</span> hyps_for <span class="skolem">n</span> <span class="main">(</span>inPorts' <span class="skolem">n</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"labelsOut <span class="skolem">n</span> <span class="skolem">hyp</span> <span class="main">|∈|</span> a_hyps <span class="main">(</span>inPorts' <span class="skolem">n</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">hyp</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">from</span></span> subset_hyp'<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> subset_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lconsts</span> <span class="main">(</span>labelsOut <span class="skolem">n</span> <span class="skolem">hyp</span><span class="main">)</span> <span class="main">⊆</span> <span class="var">?V</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
      
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="main">(</span><span class="free">subst_renameLCs</span> <span class="var">?f'</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span><span class="free">renameLCs</span> <span class="var">?f'</span> <span class="main">(</span>freshen <span class="skolem">i</span> <span class="main">(</span>labelsOut <span class="skolem">n</span> <span class="skolem">hyp</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
            <span class="free">subst</span> <span class="main">(</span><span class="free">subst_renameLCs</span> <span class="skolem">f</span> <span class="skolem">s</span><span class="main">)</span>  <span class="main">(</span>freshen <span class="main">(</span>isidx <span class="skolem">is</span><span class="main">)</span> <span class="main">(</span>labelsOut <span class="skolem">n</span> <span class="skolem">hyp</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> freshen_def rename_rename  rerename_subst<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> renameLCs_cong<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> subset_hyp<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">renameLCs</span> <span class="var">?f'</span> <span class="main">(</span><span class="free">subst</span> <span class="skolem">s</span> <span class="main">(</span>freshen <span class="skolem">i</span> <span class="main">(</span>a_conc <span class="var">?ip</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">subst</span> <span class="main">(</span><span class="free">subst_renameLCs</span> <span class="var">?f'</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span><span class="free">renameLCs</span> <span class="var">?f'</span> <span class="main">(</span>freshen <span class="skolem">i</span> <span class="main">(</span>a_conc <span class="var">?ip</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rename_subst<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?c'</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> freshen_def rename_rename  rerename_subst<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> renameLCs_cong<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> subset_conc<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"plain_iwf <span class="var">?t</span> <span class="main">(</span><span class="var">?Γ'</span> <span class="main">|∪|</span> <span class="free">renameLCs</span> <span class="skolem">f</span> <span class="main">|`|</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="var">?c'</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> list_all2_lengthD<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹list_all2 <span class="main">_</span> <span class="main">_</span> <span class="main">_</span>›</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2
     <span class="main">(</span><span class="main">λ</span><span class="bound">ip</span> <span class="bound">t</span><span class="main">.</span> plain_iwf <span class="bound">t</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">h</span><span class="main">.</span> <span class="free">subst</span> <span class="main">(</span><span class="free">subst_renameLCs</span> <span class="skolem">f</span> <span class="skolem">s</span><span class="main">)</span>
       <span class="main">(</span>freshen <span class="main">(</span>isidx <span class="skolem">is</span><span class="main">)</span> <span class="main">(</span>labelsOut <span class="skolem">n</span> <span class="bound">h</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|`|</span> hyps_for <span class="skolem">n</span> <span class="bound">ip</span> <span class="main">|∪|</span>  <span class="free">renameLCs</span> <span class="skolem">f</span> <span class="main">|`|</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="free">subst</span> <span class="main">(</span><span class="free">subst_renameLCs</span> <span class="skolem">f</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>freshen <span class="main">(</span>isidx <span class="skolem">is</span><span class="main">)</span> <span class="main">(</span>labelsIn <span class="skolem">n</span> <span class="bound">ip</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>inPorts' <span class="skolem">n</span><span class="main">)</span>
     <span class="main">(</span>mapWithIndex <span class="main">(</span><span class="main">λ</span> <span class="bound">i'</span> <span class="bound">t</span><span class="main">.</span> globalize <span class="main">(</span><span class="skolem">is</span><span class="main">@</span><span class="main">[</span><span class="bound">i'</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>rerename <span class="main">(</span>a_fresh <span class="main">(</span>inPorts' <span class="skolem">n</span> <span class="main">!</span> <span class="bound">i'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span>isidx <span class="skolem">is</span><span class="main">)</span> <span class="skolem">f</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span> <span class="skolem">ants</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_conv_all_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"no_fresh_check <span class="skolem">n</span> <span class="main">(</span>isidx <span class="skolem">is</span><span class="main">)</span> <span class="main">(</span><span class="free">subst_renameLCs</span> <span class="skolem">f</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span><span class="free">renameLCs</span> <span class="skolem">f</span> <span class="main">|`|</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="free">renameLCs</span> <span class="skolem">f</span> <span class="skolem">c</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">∈</span> sset nodes›</span></span> <span class="quoted"><span class="quoted">‹Reg <span class="skolem">p</span> <span class="main">|∈|</span> outPorts <span class="skolem">n</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">lconsts</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> no_local_consts_in_consequences'<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="free">subst</span> <span class="skolem">s</span> <span class="main">(</span>freshen <span class="skolem">i</span> <span class="skolem">p</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">renameLCs</span> <span class="skolem">f</span> <span class="skolem">c</span> <span class="main">=</span> <span class="free">subst</span> <span class="main">(</span><span class="free">subst_renameLCs</span> <span class="skolem">f</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>freshen <span class="main">(</span>isidx <span class="skolem">is</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rename_subst rename_closed freshen_closed<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> globalize.simps globalize_node.simps iNodeOf.simps iAnnot.simps itnode.sel rose_tree.sel  Let_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iwf.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>iwfH <span class="skolem">c</span> <span class="skolem">Γ</span> <span class="skolem">s</span> <span class="skolem">i</span> <span class="quoted">"<span class="skolem">is</span>"</span> <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">|∉|</span> ass_forms›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">renameLCs</span> <span class="skolem">f</span> <span class="skolem">c</span> <span class="main">|∉|</span> ass_forms"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assumptions_closed closed_no_lconsts lconsts_renameLCs rename_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">|∈|</span> <span class="skolem">Γ</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">renameLCs</span> <span class="skolem">f</span> <span class="skolem">c</span> <span class="main">|∈|</span> <span class="free">renameLCs</span> <span class="skolem">f</span> <span class="main">|`|</span> <span class="skolem">Γ</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="free">subst</span> <span class="skolem">s</span> <span class="main">(</span>freshen <span class="skolem">i</span> <span class="free">anyP</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">renameLCs</span> <span class="skolem">f</span> <span class="skolem">c</span> <span class="main">=</span> <span class="free">subst</span> <span class="main">(</span><span class="free">subst_renameLCs</span> <span class="skolem">f</span> <span class="skolem">s</span><span class="main">)</span>  <span class="main">(</span>freshen <span class="main">(</span>isidx <span class="skolem">is</span><span class="main">)</span> <span class="free">anyP</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> freshen_closed lconsts_anyP rename_closed rename_subst<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"plain_iwf <span class="main">(</span>globalize <span class="skolem">is</span> <span class="skolem">f</span> <span class="main">(</span>HNode <span class="skolem">i</span> <span class="skolem">s</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">renameLCs</span> <span class="skolem">f</span> <span class="main">|`|</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="free">renameLCs</span> <span class="skolem">f</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> globalize.simps globalize_node.simps  mapWithIndex_Nil  Let_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iwf.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fresh_at</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fresh_at</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">case</span> rev <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> <span class="main">{}</span>
                 <span class="main">|</span> <span class="main">(</span><span class="bound">i</span><span class="main">#</span><span class="bound">is'</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">freshenLC</span> <span class="main">(</span>iAnnot <span class="main">(</span>tree_at <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span>rev <span class="bound">is'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>a_fresh <span class="main">(</span>inPorts' <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span>rev <span class="bound">is'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Incredible_Trees-fresh_at_Nil"><span class="command">lemma</span></span> fresh_at_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fresh_at <span class="free">t</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fresh_at_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Incredible_Trees-fresh_at_snoc"><span class="command">lemma</span></span> fresh_at_snoc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fresh_at <span class="free">t</span> <span class="main">(</span><span class="free">is</span><span class="main">@</span><span class="main">[</span><span class="free">i</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free">freshenLC</span> <span class="main">(</span>iAnnot <span class="main">(</span>tree_at <span class="free">t</span> <span class="free">is</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>a_fresh <span class="main">(</span>inPorts' <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="free">t</span> <span class="free">is</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fresh_at_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Incredible_Trees-fresh_at_def'"><span class="command">lemma</span></span> fresh_at_def'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fresh_at <span class="free">t</span> <span class="free">is</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> <span class="free">is</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="main">{}</span>
    <span class="keyword1">else</span> <span class="free">freshenLC</span> <span class="main">(</span>iAnnot <span class="main">(</span>tree_at <span class="free">t</span> <span class="main">(</span>butlast <span class="free">is</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>a_fresh <span class="main">(</span>inPorts' <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="free">t</span> <span class="main">(</span>butlast <span class="free">is</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> last <span class="free">is</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fresh_at_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.split<span class="main">)</span>

<span class="keyword1" id="Incredible_Trees-fresh_at_Cons"><span class="command">lemma</span></span> fresh_at_Cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fresh_at <span class="free">t</span> <span class="main">(</span><span class="free">i</span><span class="main">#</span><span class="free">is</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">is</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="free">freshenLC</span> <span class="main">(</span>iAnnot <span class="free">t</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>a_fresh <span class="main">(</span>inPorts' <span class="main">(</span>iNodeOf <span class="free">t</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">t'</span> <span class="main">=</span> iAnts <span class="free">t</span> <span class="main">!</span> <span class="free">i</span> <span class="keyword1">in</span> fresh_at <span class="bound">t'</span> <span class="free">is</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fresh_at_def'
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fresh_at_path</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fresh_at_path</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>fresh_at <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">`</span> set <span class="main">(</span>prefixes <span class="free"><span class="bound"><span class="entity">is</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Incredible_Trees-fresh_at_path_Nil"><span class="command">lemma</span></span> fresh_at_path_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fresh_at_path <span class="free">t</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fresh_at_path_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Incredible_Trees-fresh_at_path_Cons"><span class="command">lemma</span></span> fresh_at_path_Cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fresh_at_path <span class="free">t</span> <span class="main">(</span><span class="free">i</span><span class="main">#</span><span class="free">is</span><span class="main">)</span> <span class="main">=</span> fresh_at <span class="free">t</span> <span class="main">[</span><span class="free">i</span><span class="main">]</span> <span class="main">∪</span> fresh_at_path <span class="main">(</span>iAnts <span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">is</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fresh_at_path_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  
<span class="keyword1" id="Incredible_Trees-globalize_local_consts"><span class="command">lemma</span></span> globalize_local_consts<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">is'</span> <span class="main">∈</span> it_paths <span class="main">(</span>globalize <span class="free">is</span> <span class="free">f</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">subst_lconsts</span> <span class="main">(</span>iSubst <span class="main">(</span>tree_at <span class="main">(</span>globalize <span class="free">is</span> <span class="free">f</span> <span class="free">t</span><span class="main">)</span> <span class="free">is'</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span>
    fresh_at_path <span class="main">(</span>globalize <span class="free">is</span> <span class="free">f</span> <span class="free">t</span><span class="main">)</span> <span class="free">is'</span> <span class="main">∪</span> range <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="free">is</span>"</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">t</span></span>  <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">is'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>globalize.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> <span class="quoted">"is"</span> f r ants is'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">r</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_lconsts_subst_renameLCs  <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> it_paths_RNodeE<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹<span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main">!</span><span class="main">:</span> subsetD<span class="main">[</span><span class="operator">OF</span> range_rerename<span class="main">]</span>›</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹<span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main">!</span><span class="main">:</span> subsetD<span class="main">[</span><span class="operator">OF</span> range_rerename<span class="main">]</span>›</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1" id="Incredible_Trees-iwf_globalize'"><span class="command">lemma</span></span> iwf_globalize'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"local_iwf <span class="free">t</span> <span class="free">ent</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">|∈|</span> fst <span class="free">ent</span> <span class="main">⟹</span> <span class="free">closed</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">closed</span> <span class="main">(</span>snd <span class="free">ent</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"plain_iwf <span class="main">(</span>globalize <span class="free">is</span> <span class="main">(</span><span class="free">freshenLC</span> v_away<span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="free">ent</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ent</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> prod.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pair <span class="skolem">Γ</span> <span class="skolem">c</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"plain_iwf <span class="main">(</span>globalize <span class="free">is</span> <span class="main">(</span><span class="free">freshenLC</span> v_away<span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="free">renameLCs</span> <span class="main">(</span><span class="free">freshenLC</span> v_away<span class="main">)</span> <span class="main">|`|</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="free">renameLCs</span> <span class="main">(</span><span class="free">freshenLC</span> v_away<span class="main">)</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iwf_globalize<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Pair<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">from</span></span> Pair<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">closed</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">renameLCs</span> <span class="main">(</span><span class="free">freshenLC</span> v_away<span class="main">)</span> <span class="skolem">c</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> closed_no_lconsts rename_closed<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">from</span></span> Pair<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">renameLCs</span> <span class="main">(</span><span class="free">freshenLC</span> v_away<span class="main">)</span> <span class="main">|`|</span> <span class="skolem">Γ</span> <span class="main">=</span> <span class="skolem">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> closed_no_lconsts rename_closed fmember.rep_eq image_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>   

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Build_Incredible_Tree">
<div class="head">
<h1>Theory Build_Incredible_Tree</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Build_Incredible_Tree
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Incredible_Trees.html">Incredible_Trees</a> <a href="Natural_Deduction.html">Natural_Deduction</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This theory constructs an incredible tree (with freshness checked only locally) from a natural
deduction tree.
›</span></span>

<span class="keyword1" id="Build_Incredible_Tree-image_eq_to_f"><span class="command">lemma</span></span> image_eq_to_f<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  <span class="quoted"><span class="quoted">"<span class="free">f1</span> <span class="main">`</span> <span class="free">S1</span> <span class="main">=</span> <span class="free">f2</span> <span class="main">`</span> <span class="free">S2</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">f</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S2</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S1</span> <span class="main">∧</span> <span class="free">f1</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">f2</span> <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S2</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">S1</span> <span class="main">∧</span> <span class="free">f1</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">f2</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> image_iff<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S2</span> <span class="main">⟶</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S1</span> <span class="main">∧</span> <span class="free">f1</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">f2</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">includes</span></span> fset.lifting
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1" id="Build_Incredible_Tree-fimage_eq_to_f"><span class="command">lemma</span></span> fimage_eq_to_f<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  <span class="quoted"><span class="quoted">"<span class="free">f1</span> <span class="main">|`|</span> <span class="free">S1</span> <span class="main">=</span> <span class="free">f2</span> <span class="main">|`|</span> <span class="free">S2</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">f</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">|∈|</span> <span class="free">S2</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">|∈|</span> <span class="free">S1</span> <span class="main">∧</span> <span class="free">f1</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">f2</span> <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span> <span class="keyword1"><span class="command">using</span></span> image_eq_to_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> Abstract_Task
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Build_Incredible_Tree-build_local_iwf"><span class="command">lemma</span></span> build_local_iwf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'form</span> entailment <span class="main">×</span> <span class="main">(</span><span class="tfree">'rule</span> <span class="main">×</span> <span class="tfree">'form</span><span class="main">)</span> NatRule<span class="main">)</span> tree"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"tfinite <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">it</span><span class="main">.</span> local_iwf <span class="bound">it</span> <span class="main">(</span>fst <span class="main">(</span>root <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tfinite <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹wf <span class="skolem">t</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>root <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R"</span></span> <span class="keyword1"><span class="command">using</span></span> wf.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹wf <span class="skolem">t</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eff <span class="main">(</span>snd <span class="main">(</span>root <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>root <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>fst <span class="main">∘</span> root<span class="main">)</span> <span class="main">|`|</span> cont <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wf.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹wf <span class="skolem">t</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">|∈|</span> cont <span class="skolem">t</span> <span class="main">⟹</span> wf <span class="bound">t'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wf.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">Γ'</span> <span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">|∈|</span> cont <span class="skolem">t</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">it'</span><span class="main">.</span> local_iwf <span class="bound">it'</span> <span class="main">(</span>fst <span class="main">(</span>root <span class="bound">t'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tfinite<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">its</span></span> <span class="keyword2"><span class="keyword">where</span></span> its<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">|∈|</span> cont <span class="skolem">t</span> <span class="main">⟹</span> local_iwf <span class="main">(</span><span class="skolem">its</span> <span class="bound">t'</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>root <span class="bound">t'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹eff <span class="main">_</span> <span class="main">_</span> <span class="main">_</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>               
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eff.cases<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> Axiom NatRule Cut<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Axiom <span class="skolem">c</span> <span class="skolem">Γ</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">|∈|</span> ass_forms"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="comment1">(* Global assumption *)</span>
      <span class="keyword1"><span class="command">then</span></span>  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> set <span class="free">assumptions</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  ass_forms_def<span class="main">)</span>

      <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?it</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"INode <span class="main">(</span>Assumption <span class="skolem">c</span><span class="main">)</span> <span class="skolem">c</span> undefined undefined <span class="main">[]</span> <span class="main">::</span>  <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'rule</span><span class="main">,</span> <span class="tfree">'subst</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> itree"</span></span>

      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> set <span class="free">assumptions</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"local_iwf <span class="var">?it</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> iwf local_fresh_check.intros<span class="main">)</span>

      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Axiom<span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="skolem">s</span> <span class="free">anyP</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">rule</span> anyP_is_any<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="skolem">s</span> <span class="main">(</span>freshen undefined <span class="free">anyP</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lconsts_anyP freshen_closed<span class="main">)</span>
  
      <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?it</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"HNode undefined <span class="skolem">s</span> <span class="main">[]</span> <span class="main">::</span>  <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'rule</span><span class="main">,</span> <span class="tfree">'subst</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> itree"</span></span>
  
      <span class="keyword1"><span class="command">from</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">|∈|</span> <span class="skolem">Γ</span>›</span></span> False
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"local_iwf <span class="var">?it</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> iwfH<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Axiom<span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>NatRule <span class="skolem">rule</span> <span class="skolem">c</span> <span class="skolem">ants</span> <span class="skolem">Γ</span> <span class="skolem">i</span> <span class="skolem">s</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹natEff_Inst <span class="skolem">rule</span> <span class="skolem">c</span> <span class="skolem">ants</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">rule</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ants</span> <span class="main">=</span> f_antecedent <span class="main">(</span>fst <span class="skolem">rule</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">consequent</span> <span class="main">(</span>fst <span class="skolem">rule</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> natEff_Inst.simps<span class="main">)</span>  

    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>fst <span class="main">∘</span> root<span class="main">)</span> <span class="main">|`|</span> cont <span class="skolem">t</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ant</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="free">subst</span> <span class="skolem">s</span> <span class="main">(</span>freshen <span class="skolem">i</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">|`|</span> a_hyps <span class="bound">ant</span> <span class="main">|∪|</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="free">subst</span> <span class="skolem">s</span> <span class="main">(</span>freshen <span class="skolem">i</span> <span class="main">(</span>a_conc <span class="bound">ant</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|`|</span> <span class="skolem">ants</span>›</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">to_t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">ant</span><span class="main">.</span> <span class="bound">ant</span> <span class="main">|∈|</span> <span class="skolem">ants</span> <span class="main">⟹</span> <span class="skolem">to_t</span> <span class="bound">ant</span> <span class="main">|∈|</span> cont <span class="skolem">t</span> <span class="main">∧</span> <span class="main">(</span>fst <span class="main">∘</span> root<span class="main">)</span> <span class="main">(</span><span class="skolem">to_t</span> <span class="bound">ant</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="free">subst</span> <span class="skolem">s</span> <span class="main">(</span>freshen <span class="skolem">i</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">|`|</span> a_hyps <span class="bound">ant</span> <span class="main">|∪|</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="free">subst</span> <span class="skolem">s</span> <span class="main">(</span>freshen <span class="skolem">i</span> <span class="main">(</span>a_conc <span class="bound">ant</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fimage_eq_to_f<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> that<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> to_t_in_cont<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">ant</span><span class="main">.</span> <span class="bound">ant</span> <span class="main">|∈|</span> <span class="skolem">ants</span> <span class="main">⟹</span> <span class="skolem">to_t</span> <span class="bound">ant</span> <span class="main">|∈|</span> cont <span class="skolem">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> to_t_root<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">ant</span><span class="main">.</span> <span class="bound">ant</span> <span class="main">|∈|</span> <span class="skolem">ants</span> <span class="main">⟹</span>  fst <span class="main">(</span>root <span class="main">(</span><span class="skolem">to_t</span> <span class="bound">ant</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="free">subst</span> <span class="skolem">s</span> <span class="main">(</span>freshen <span class="skolem">i</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">|`|</span> a_hyps <span class="bound">ant</span> <span class="main">|∪|</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="free">subst</span> <span class="skolem">s</span> <span class="main">(</span>freshen <span class="skolem">i</span> <span class="main">(</span>a_conc <span class="bound">ant</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ants'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="bound">ant</span><span class="main">.</span> <span class="skolem">its</span> <span class="main">(</span><span class="skolem">to_t</span> <span class="bound">ant</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">antecedent</span> <span class="main">(</span>fst <span class="skolem">rule</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?it</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"INode <span class="main">(</span>Rule <span class="main">(</span>fst <span class="skolem">rule</span><span class="main">)</span><span class="main">)</span> <span class="skolem">c</span> <span class="skolem">i</span> <span class="skolem">s</span> <span class="var">?ants'</span> <span class="main">::</span>  <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'rule</span><span class="main">,</span> <span class="tfree">'subst</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> itree"</span></span>

    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹snd <span class="main">(</span>root <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> R›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">rule</span> <span class="main">∈</span> sset <span class="free">rules</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> NatRule
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stream.set_map n_rules_def no_empty_conclusions <span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">consequent</span> <span class="main">(</span>fst <span class="skolem">rule</span><span class="main">)</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">|∈|</span> f_consequent <span class="main">(</span>fst <span class="skolem">rule</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_consequent_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ant</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ant</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">antecedent</span> <span class="main">(</span>fst <span class="skolem">rule</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ant</span> <span class="main">|∈|</span> <span class="skolem">ants</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_antecedent_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> its<span class="main">[</span><span class="operator">OF</span> to_t_in_cont<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"local_iwf <span class="main">(</span><span class="skolem">its</span> <span class="main">(</span><span class="skolem">to_t</span> <span class="skolem">ant</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>root <span class="main">(</span><span class="skolem">to_t</span> <span class="skolem">ant</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>root <span class="main">(</span><span class="skolem">to_t</span> <span class="skolem">ant</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="free">subst</span> <span class="skolem">s</span> <span class="main">(</span>freshen <span class="skolem">i</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">|`|</span> a_hyps <span class="skolem">ant</span> <span class="main">|∪|</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="free">subst</span> <span class="skolem">s</span> <span class="main">(</span>freshen <span class="skolem">i</span> <span class="main">(</span>a_conc <span class="skolem">ant</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> to_t_root<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ant</span> <span class="main">|∈|</span> <span class="skolem">ants</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>
        <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">h</span><span class="main">.</span> <span class="free">subst</span> <span class="skolem">s</span> <span class="main">(</span>freshen <span class="skolem">i</span> <span class="main">(</span>labelsOut <span class="main">(</span>Rule <span class="main">(</span>fst <span class="skolem">rule</span><span class="main">)</span><span class="main">)</span> <span class="bound">h</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|`|</span> hyps_for <span class="main">(</span>Rule <span class="main">(</span>fst <span class="skolem">rule</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ant</span> <span class="main">|∪|</span> <span class="skolem">Γ</span>
         <span class="main">⊢</span> <span class="free">subst</span> <span class="skolem">s</span> <span class="main">(</span>freshen <span class="skolem">i</span> <span class="main">(</span>a_conc <span class="skolem">ant</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
         <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ant</span> <span class="main">|∈|</span> <span class="skolem">ants</span>›</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"local_iwf <span class="main">(</span><span class="skolem">its</span> <span class="main">(</span><span class="skolem">to_t</span> <span class="skolem">ant</span><span class="main">)</span><span class="main">)</span>
           <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">h</span><span class="main">.</span> <span class="free">subst</span> <span class="skolem">s</span> <span class="main">(</span>freshen <span class="skolem">i</span> <span class="main">(</span>labelsOut <span class="main">(</span>Rule <span class="main">(</span>fst <span class="skolem">rule</span><span class="main">)</span><span class="main">)</span> <span class="bound">h</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|`|</span> hyps_for <span class="main">(</span>Rule <span class="main">(</span>fst <span class="skolem">rule</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ant</span> <span class="main">|∪|</span>
            <span class="skolem">Γ</span>  <span class="main">⊢</span> <span class="free">subst</span> <span class="skolem">s</span> <span class="main">(</span>freshen <span class="skolem">i</span> <span class="main">(</span>a_conc <span class="skolem">ant</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> NatRule<span class="main">(</span>5<span class="main">,</span>6<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"local_fresh_check <span class="main">(</span>Rule <span class="main">(</span>fst <span class="skolem">rule</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">s</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊢</span> <span class="free">subst</span> <span class="skolem">s</span> <span class="main">(</span>freshen <span class="skolem">i</span> <span class="skolem">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> local_fresh_check.intros <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> all_local_vars_def fmember.rep_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"local_iwf <span class="var">?it</span> <span class="main">(</span><span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊢</span> <span class="free">subst</span> <span class="skolem">s</span> <span class="main">(</span>freshen <span class="skolem">i</span> <span class="skolem">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> iwf <span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_map2 list_all2_same<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> NatRule<span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cut <span class="skolem">Γ</span> <span class="skolem">con</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="skolem">s</span> <span class="free">anyP</span> <span class="main">=</span> <span class="skolem">con</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">rule</span> anyP_is_any<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span>  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="skolem">s</span> <span class="main">(</span>freshen undefined <span class="free">anyP</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">con</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lconsts_anyP freshen_closed<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>fst <span class="main">∘</span> root<span class="main">)</span> <span class="main">|`|</span> cont <span class="skolem">t</span> <span class="main">=</span> <span class="main">{|</span><span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">con</span><span class="main">|}</span>›</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span>  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">|∈|</span> cont <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>root <span class="skolem">t'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">con</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"cont <span class="skolem">t</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="main">|∈|</span> cont <span class="skolem">t</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted">"<span class="skolem"><span class="skolem">it'</span></span>"</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"local_iwf <span class="skolem">it'</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">con</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?it</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"INode Helper <span class="free">anyP</span> undefined <span class="skolem">s</span> <span class="main">[</span><span class="skolem">it'</span><span class="main">]</span> <span class="main">::</span>  <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'rule</span><span class="main">,</span> <span class="tfree">'subst</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> itree"</span></span>

    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹local_iwf <span class="skolem">it'</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">con</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"local_iwf <span class="var">?it</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">con</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> iwf local_fresh_check.intros<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Cut<span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">to_it</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'form</span> entailment <span class="main">×</span> <span class="main">(</span><span class="tfree">'rule</span> <span class="main">×</span> <span class="tfree">'form</span><span class="main">)</span> NatRule<span class="main">)</span> tree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span><span class="tfree">'rule</span><span class="main">,</span><span class="tfree">'subst</span><span class="main">,</span><span class="tfree">'var</span><span class="main">)</span> itree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">to_it</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">it</span><span class="main">.</span> local_iwf <span class="bound">it</span> <span class="main">(</span>fst <span class="main">(</span>root <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Build_Incredible_Tree-iwf_to_it"><span class="command">lemma</span></span> iwf_to_it<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"tfinite <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"local_iwf <span class="main">(</span>to_it <span class="free">t</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>root <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> to_it_def <span class="keyword1"><span class="command">using</span></span> build_local_iwf<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> someI2_ex<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Incredible_Completeness">
<div class="head">
<h1>Theory Incredible_Completeness</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Incredible_Completeness
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Natural_Deduction.html">Natural_Deduction</a> <a href="Incredible_Deduction.html">Incredible_Deduction</a> <a href="Build_Incredible_Tree.html">Build_Incredible_Tree</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This theory takes the tree produced in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> <a href="Build_Incredible_Tree.html"></a><a href="Build_Incredible_Tree.html">Incredible_Proof_Machine.Build_Incredible_Tree</a><span class="antiquote"><span class="antiquote">}</span></span></span></span>, globalizes it using
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">globalize</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and then builds the incredible proof graph out of it.
›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'form</span> vertex <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'form</span> <span class="main">×</span> nat list<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> edge'' <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'form</span> vertex<span class="main">,</span> <span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> edge'"</span></span>

<span class="keyword1"><span class="command">locale</span></span> Solved_Task <span class="main">=</span>
  Abstract_Task  <span class="quoted"><span class="free">freshenLC</span></span> <span class="quoted"><span class="free">renameLCs</span></span> <span class="quoted"><span class="free">lconsts</span></span> <span class="quoted"><span class="free">closed</span></span> <span class="quoted"><span class="free">subst</span></span> <span class="quoted"><span class="free">subst_lconsts</span></span> <span class="quoted"><span class="free">subst_renameLCs</span></span> <span class="quoted"><span class="free">anyP</span></span> <span class="quoted"><span class="free">antecedent</span></span> <span class="quoted"><span class="free">consequent</span></span> <span class="quoted"><span class="free">rules</span></span> <span class="quoted"><span class="free">assumptions</span></span> <span class="quoted"><span class="free">conclusions</span></span>
   <span class="keyword2"><span class="keyword">for</span></span> <span class="free">freshenLC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'var</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">renameLCs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'var</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'form</span> <span class="main">⇒</span> <span class="tfree">'form</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">lconsts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> <span class="main">⇒</span> <span class="tfree">'var</span> set"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">closed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'subst</span> <span class="main">⇒</span> <span class="tfree">'form</span> <span class="main">⇒</span> <span class="tfree">'form</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">subst_lconsts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'subst</span> <span class="main">⇒</span> <span class="tfree">'var</span> set"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">subst_renameLCs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'var</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'subst</span> <span class="main">⇒</span> <span class="tfree">'subst</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">anyP</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">antecedent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'rule</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> antecedent list"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">consequent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'rule</span> <span class="main">⇒</span> <span class="tfree">'form</span> list"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">rules</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'rule</span> stream"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">assumptions</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> list"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">conclusions</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> list"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> solved<span class="main">:</span> <span class="quoted">solved</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Let us get our hand on concrete trees.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'form</span> entailment<span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'rule</span> <span class="main">×</span> <span class="tfree">'form</span><span class="main">)</span> NatRule<span class="main">)</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">t</span><span class="main">.</span> snd <span class="main">(</span>fst <span class="main">(</span>root <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">∧</span> fst <span class="main">(</span>fst <span class="main">(</span>root <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">|⊆|</span> ass_forms <span class="main">∧</span> wf <span class="bound">t</span> <span class="main">∧</span> tfinite <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">|∈|</span> conc_forms"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> ts_conc<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>fst <span class="main">(</span>root <span class="main">(</span>ts <span class="free">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   ts_context<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>fst <span class="main">(</span>root <span class="main">(</span>ts <span class="free">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|⊆|</span> ass_forms"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   ts_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>ts <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   ts_finite<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"tfinite <span class="main">(</span>ts <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> atomize_conj conj_assoc ts_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> someI_ex<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> solved assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> solved_def<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">it'</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">it'</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> globalize <span class="main">[</span>fidx conc_forms <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="free">freshenLC</span> v_away<span class="main">)</span> <span class="main">(</span>to_it <span class="main">(</span>ts <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Incredible_Completeness-iwf_it"><span class="command">lemma</span></span> iwf_it<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> set <span class="free">conclusions</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"plain_iwf <span class="main">(</span>it' <span class="free">c</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>root <span class="main">(</span>ts <span class="free">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_conc conclusions_closed <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> iwf_globalize' iwf_to_it ts_finite ts_wf<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assumptions_closed fset_mp mem_ass_forms mem_conc_forms ts_context<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">vertices</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> vertex fset"</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vertices</span> <span class="main">=</span> Abs_fset <span class="main">(</span>Union <span class="main">(</span> set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">c</span><span class="main">.</span> insert <span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="main">0</span> <span class="main">#</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>it_paths <span class="main">(</span>it' <span class="bound">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>  <span class="free">conclusions</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Incredible_Completeness-mem_vertices"><span class="command">lemma</span></span> mem_vertices<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">|∈|</span> vertices <span class="main">⟷</span>  <span class="main">(</span>fst <span class="free">v</span> <span class="main">∈</span> set <span class="free">conclusions</span> <span class="main">∧</span> <span class="main">(</span>snd <span class="free">v</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> snd <span class="free">v</span> <span class="main">∈</span> <span class="main">(</span><span class="main">(#)</span> <span class="main">0</span><span class="main">)</span> <span class="main">`</span> it_paths <span class="main">(</span>it' <span class="main">(</span>fst <span class="free">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vertices_def fmember.rep_eq ffUnion.rep_eq 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_fset_inverse Bex_def <span class="main">)</span>

<span class="keyword1" id="Incredible_Completeness-prefixeq_vertices"><span class="command">lemma</span></span> prefixeq_vertices<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">is</span><span class="main">)</span> <span class="main">|∈|</span> vertices <span class="main">⟹</span> prefix <span class="free">is'</span> <span class="free">is</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">is'</span><span class="main">)</span> <span class="main">|∈|</span> vertices"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">is'</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mem_vertices <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> imageI <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> it_paths_prefix<span class="main">)</span>

<span class="keyword1" id="Incredible_Completeness-none_vertices"><span class="command">lemma</span></span> none_vertices<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">|∈|</span> vertices <span class="main">⟷</span> <span class="free">c</span> <span class="main">∈</span> set <span class="free">conclusions</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mem_vertices<span class="main">)</span>

<span class="keyword1" id="Incredible_Completeness-some_vertices"><span class="command">lemma</span></span> some_vertices<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">i</span><span class="main">#</span><span class="free">is</span><span class="main">)</span> <span class="main">|∈|</span> vertices <span class="main">⟷</span> <span class="free">c</span> <span class="main">∈</span> set <span class="free">conclusions</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">is</span> <span class="main">∈</span> it_paths <span class="main">(</span>it' <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mem_vertices<span class="main">)</span>

<span class="keyword1" id="Incredible_Completeness-vertices_cases"><span class="command">lemma</span></span> vertices_cases<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> None Some<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">|∈|</span> vertices"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">c</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> set <span class="free">conclusions</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
      <span class="main">|</span>   <span class="free">c</span> <span class="quoted">"<span class="free">is</span>"</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> set <span class="free">conclusions</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">∈</span> it_paths <span class="main">(</span>it' <span class="free">c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="main">0</span><span class="main">#</span><span class="free">is</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">rename_tac</span> <span class="quoted">"is"</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">is</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Incredible_Completeness-vertices_induct"><span class="command">lemma</span></span> vertices_induct<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> None Some<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">|∈|</span> vertices"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="free">conclusions</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">c</span> <span class="bound">is</span> <span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="free">conclusions</span> <span class="main">⟹</span> <span class="bound">is</span> <span class="main">∈</span> it_paths <span class="main">(</span>it' <span class="bound">c</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="main">0</span><span class="main">#</span><span class="bound">is</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">rename_tac</span> <span class="quoted">"is"</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">is</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nodeOf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> vertex <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'rule</span><span class="main">)</span> graph_node"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nodeOf</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">pf</span></span></span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> Conclusion <span class="free"><span class="bound"><span class="entity">pf</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nodeOf</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">pf</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">is</span></span></span><span class="main">)</span> <span class="main">=</span> iNodeOf <span class="main">(</span>tree_at <span class="main">(</span>it' <span class="free"><span class="bound"><span class="entity">pf</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">is</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">inst</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inst</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="main">[]</span><span class="main">)</span> <span class="main">=</span> empty_subst"</span></span>
 <span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">inst</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">is</span></span></span><span class="main">)</span> <span class="main">=</span> iSubst <span class="main">(</span>tree_at <span class="main">(</span>it' <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">is</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1" id="Incredible_Completeness-terminal_is_nil"><span class="command">lemma</span></span> terminal_is_nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">|∈|</span> vertices <span class="main">⟹</span> outPorts <span class="main">(</span>nodeOf <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">{||}</span> <span class="main">⟷</span> snd <span class="free">v</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nodeOf.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> iNodeOf_outPorts<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> iwf_it<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> Vertex_Graph <span class="quoted">nodes</span> <span class="quoted">inPorts</span> <span class="quoted">outPorts</span> <span class="quoted">vertices</span> <span class="quoted">nodeOf</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">edge_from</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> <span class="main">⇒</span> nat list <span class="main">=&gt;</span> <span class="main">(</span><span class="tfree">'form</span> vertex <span class="main">×</span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span><span class="tfree">'var</span><span class="main">)</span> out_port<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">edge_from</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="main">0</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">is</span></span></span><span class="main">)</span><span class="main">,</span>  Reg <span class="main">(</span>iOutPort <span class="main">(</span>tree_at <span class="main">(</span>it' <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">is</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Incredible_Completeness-fst_edge_from"><span class="command">lemma</span></span> fst_edge_from<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>edge_from <span class="free">c</span> <span class="free">is</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="main">0</span> <span class="main">#</span> <span class="free">is</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edge_from_def<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">in_port_at</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'form</span> <span class="main">×</span> nat list<span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span><span class="tfree">'var</span><span class="main">)</span> in_port"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">in_port_at</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>  <span class="main"><span class="bound"><span class="entity">_</span></span></span>  <span class="main">=</span> plain_ant <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">in_port_at</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">is</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> inPorts' <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="main">(</span>it' <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">is</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">edge_to</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> <span class="main">⇒</span> nat list <span class="main">=&gt;</span> <span class="main">(</span><span class="tfree">'form</span> vertex <span class="main">×</span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span><span class="tfree">'var</span><span class="main">)</span> in_port<span class="main">)</span>"</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">edge_to</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> rev <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="keyword1">of</span>   <span class="main">[]</span>   <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span>           in_port_at <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>
                    <span class="main">|</span> <span class="bound">i</span><span class="main">#</span><span class="bound">is</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="main">0</span> <span class="main">#</span> <span class="main">(</span>rev <span class="bound">is</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> in_port_at <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="main">(</span><span class="main">0</span><span class="main">#</span>rev <span class="bound">is</span><span class="main">)</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Incredible_Completeness-edge_to_Nil"><span class="command">lemma</span></span> edge_to_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"edge_to <span class="free">c</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> plain_ant <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edge_to_def<span class="main">)</span>

<span class="keyword1" id="Incredible_Completeness-edge_to_Snoc"><span class="command">lemma</span></span> edge_to_Snoc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"edge_to <span class="free">c</span> <span class="main">(</span><span class="free">is</span><span class="main">@</span><span class="main">[</span><span class="free">i</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="main">0</span> <span class="main">#</span> <span class="free">is</span><span class="main">)</span><span class="main">,</span> in_port_at <span class="main">(</span><span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="main">0</span> <span class="main">#</span> <span class="free">is</span><span class="main">)</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edge_to_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">edge_at</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> <span class="main">⇒</span> nat list <span class="main">=&gt;</span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> edge''"</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">edge_at</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="main">=</span> <span class="main">(</span>edge_from <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">is</span></span></span><span class="main">,</span> edge_to <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">is</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Incredible_Completeness-fst_edge_at"><span class="command">lemma</span></span> fst_edge_at<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>edge_at <span class="free">c</span> <span class="free">is</span><span class="main">)</span> <span class="main">=</span> edge_from <span class="free">c</span> <span class="free">is</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edge_at_def<span class="main">)</span>
<span class="keyword1" id="Incredible_Completeness-snd_edge_at"><span class="command">lemma</span></span> snd_edge_at<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>edge_at <span class="free">c</span> <span class="free">is</span><span class="main">)</span> <span class="main">=</span> edge_to <span class="free">c</span> <span class="free">is</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edge_at_def<span class="main">)</span>


<span class="keyword1" id="Incredible_Completeness-hyps_exist'"><span class="command">lemma</span></span> hyps_exist'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> set <span class="free">conclusions</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">∈</span> it_paths <span class="main">(</span>it' <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"tree_at <span class="main">(</span>it' <span class="free">c</span><span class="main">)</span> <span class="free">is</span> <span class="main">=</span> <span class="main">(</span>HNode <span class="free">i</span> <span class="free">s</span> <span class="free">ants</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="free">s</span> <span class="main">(</span>freshen <span class="free">i</span> <span class="free">anyP</span><span class="main">)</span> <span class="main">∈</span> hyps_along <span class="main">(</span>it' <span class="free">c</span><span class="main">)</span> <span class="free">is</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"plain_iwf <span class="main">(</span>it' <span class="free">c</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>root <span class="main">(</span>ts <span class="free">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iwf_it<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>fst <span class="main">(</span>root <span class="main">(</span>ts <span class="free">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|⊆|</span> ass_forms"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ts_context<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iwf_hyps_exist<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">hyp_edge_to</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> <span class="main">⇒</span> nat list <span class="main">=&gt;</span> <span class="main">(</span><span class="tfree">'form</span> vertex <span class="main">×</span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span><span class="tfree">'var</span><span class="main">)</span> in_port<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">hyp_edge_to</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="main">0</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">is</span></span></span><span class="main">)</span><span class="main">,</span>  plain_ant <span class="free">anyP</span><span class="main">)</span>"</span></span>

<span class="comment1">(* TODO: Replace n and s by "subst s (freshen n anyP)" *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">hyp_edge_from</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> <span class="main">⇒</span> nat list <span class="main">=&gt;</span> nat <span class="main">⇒</span> <span class="tfree">'subst</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'form</span> vertex <span class="main">×</span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span><span class="tfree">'var</span><span class="main">)</span> out_port<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">hyp_edge_from</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> 
    <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="main">0</span> <span class="main">#</span> hyp_port_path_for <span class="main">(</span>it' <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="main">(</span><span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>freshen <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free">anyP</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
     hyp_port_h_for <span class="main">(</span>it' <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="main">(</span><span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>freshen <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free">anyP</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">hyp_edge_at</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> <span class="main">⇒</span> nat list <span class="main">=&gt;</span> nat <span class="main">⇒</span> <span class="tfree">'subst</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> edge''"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">hyp_edge_at</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span>hyp_edge_from <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> hyp_edge_to <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">is</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Incredible_Completeness-fst_hyp_edge_at"><span class="command">lemma</span></span> fst_hyp_edge_at<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fst <span class="main">(</span>hyp_edge_at <span class="free">c</span> <span class="free">is</span> <span class="free">n</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> hyp_edge_from <span class="free">c</span> <span class="free">is</span> <span class="free">n</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>hyp_edge_at_def<span class="main">)</span> 
<span class="keyword1" id="Incredible_Completeness-snd_hyp_edge_at"><span class="command">lemma</span></span> snd_hyp_edge_at<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"snd <span class="main">(</span>hyp_edge_at <span class="free">c</span> <span class="free">is</span> <span class="free">n</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> hyp_edge_to <span class="free">c</span> <span class="free">is</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>hyp_edge_at_def<span class="main">)</span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">edges</span> <span class="keyword2"><span class="keyword">where</span></span>
  regular_edge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">∈</span> set <span class="free">conclusions</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="main">∈</span> it_paths <span class="main">(</span>it' <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">⟹</span> edge_at <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="main">∈</span> <span class="free">edges</span>"</span></span>
  <span class="main">|</span> hyp_edge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">∈</span> set <span class="free">conclusions</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="main">∈</span> it_paths <span class="main">(</span>it' <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">⟹</span> tree_at <span class="main">(</span>it' <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="main">=</span> HNode <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">ants</span></span></span> <span class="main">⟹</span> hyp_edge_at <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∈</span> <span class="free">edges</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> Pre_Port_Graph <span class="quoted">nodes</span> <span class="quoted">inPorts</span> <span class="quoted">outPorts</span> <span class="quoted">vertices</span> <span class="quoted">nodeOf</span> <span class="quoted">edges</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Incredible_Completeness-edge_from_valid_out_port"><span class="command">lemma</span></span> edge_from_valid_out_port<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> it_paths <span class="main">(</span>it' <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> set <span class="free">conclusions</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valid_out_port <span class="main">(</span>edge_from <span class="free">c</span> <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edge_from_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> iwf_outPort iwf_it<span class="main">)</span>

<span class="keyword1" id="Incredible_Completeness-edge_to_valid_in_port"><span class="command">lemma</span></span> edge_to_valid_in_port<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> it_paths <span class="main">(</span>it' <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> set <span class="free">conclusions</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valid_in_port <span class="main">(</span>edge_to <span class="free">c</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edge_to_def inPorts_fset_of <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.split <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> it_paths_SnocE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nth_mem<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> iwf_length_inPorts<span class="main"><span class="main">[</span></span><span class="operator">OF</span> iwf_it<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Incredible_Completeness-hyp_edge_from_valid_out_port"><span class="command">lemma</span></span> hyp_edge_from_valid_out_port<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">∈</span> it_paths <span class="main">(</span>it' <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> set <span class="free">conclusions</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"tree_at <span class="main">(</span>it' <span class="free">c</span><span class="main">)</span> <span class="free">is</span> <span class="main">=</span> HNode <span class="free">n</span> <span class="free">s</span> <span class="free">ants</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valid_out_port <span class="main">(</span>hyp_edge_from <span class="free">c</span> <span class="free">is</span> <span class="free">n</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hyp_edge_from_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> hyp_port_outPort it_paths_strict_prefix hyp_port_strict_prefix hyps_exist'<span class="main">)</span>

<span class="keyword1" id="Incredible_Completeness-hyp_edge_to_valid_in_port"><span class="command">lemma</span></span> hyp_edge_to_valid_in_port<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">∈</span> it_paths <span class="main">(</span>it' <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> set <span class="free">conclusions</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"tree_at <span class="main">(</span>it' <span class="free">c</span><span class="main">)</span> <span class="free">is</span> <span class="main">=</span> HNode <span class="free">n</span> <span class="free">s</span> <span class="free">ants</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valid_in_port <span class="main">(</span>hyp_edge_to <span class="free">c</span> <span class="free">is</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hyp_edge_to_def<span class="main">)</span>


<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">scope'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> vertex <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span><span class="tfree">'var</span><span class="main">)</span> in_port <span class="main">⇒</span> <span class="tfree">'form</span> <span class="main">×</span> nat list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">∈</span> set <span class="free">conclusions</span> <span class="main">⟹</span>
   <span class="free"><span class="bound"><span class="entity">is'</span></span></span> <span class="main">∈</span> <span class="main">(</span><span class="main">(#)</span> <span class="main">0</span><span class="main">)</span> <span class="main">`</span> it_paths <span class="main">(</span>it' <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   prefix <span class="main">(</span><span class="free"><span class="bound"><span class="entity">is</span></span></span><span class="main">@</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">]</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">is'</span></span></span> <span class="main">⟹</span> 
   <span class="free"><span class="bound"><span class="entity">ip</span></span></span> <span class="main">=</span> in_port_at <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">is</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">⟹</span>
   <span class="free">scope'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">is</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ip</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">is'</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive_simps</span></span> scope_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"scope' <span class="free">v</span> <span class="free">i</span> <span class="free">v'</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> scope_cases<span class="main">:</span> <span class="quoted"><span class="quoted">"scope' <span class="free">v</span> <span class="free">i</span> <span class="free">v'</span>"</span></span>

<span class="keyword1" id="Incredible_Completeness-scope_valid"><span class="command">lemma</span></span> scope_valid<span class="main">:</span>
  <span class="quoted"><span class="quoted">"scope' <span class="free">v</span> <span class="free">i</span> <span class="free">v'</span> <span class="main">⟹</span> <span class="free">v'</span> <span class="main">|∈|</span> vertices"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> scope_cases<span class="main">)</span>

<span class="keyword1" id="Incredible_Completeness-scope_valid_inport"><span class="command">lemma</span></span> scope_valid_inport<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">v'</span> <span class="main">|∈|</span> vertices <span class="main">⟹</span> scope' <span class="free">v</span> <span class="free">ip</span>  <span class="free">v'</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> fst <span class="free">v</span> <span class="main">=</span> fst <span class="free">v'</span> <span class="main">∧</span> prefix <span class="main">(</span>snd <span class="free">v</span><span class="main">@</span><span class="main">[</span><span class="bound">i</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">v'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">ip</span> <span class="main">=</span> in_port_at <span class="free">v</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">v'</span></span><span class="main">)</span>  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> scope'.simps mem_vertices<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">terminal_path_from</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> <span class="main">⇒</span> nat list <span class="main">=&gt;</span> <span class="main">(</span><span class="tfree">'form</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">)</span> edge'' list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">terminal_path_from</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="main">=</span> map <span class="main">(</span>edge_at <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">(</span>rev <span class="main">(</span>prefixes <span class="free"><span class="bound"><span class="entity">is</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Incredible_Completeness-terminal_path_from_Nil"><span class="command">lemma</span></span> terminal_path_from_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"terminal_path_from <span class="free">c</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[</span>edge_at <span class="free">c</span> <span class="main">[]</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminal_path_from_def<span class="main">)</span>

<span class="keyword1" id="Incredible_Completeness-terminal_path_from_Snoc"><span class="command">lemma</span></span> terminal_path_from_Snoc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"terminal_path_from <span class="free">c</span> <span class="main">(</span><span class="free">is</span> <span class="main">@</span> <span class="main">[</span><span class="free">i</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> edge_at  <span class="free">c</span> <span class="main">(</span><span class="free">is</span><span class="main">@</span><span class="main">[</span><span class="free">i</span><span class="main">]</span><span class="main">)</span> <span class="main">#</span> terminal_path_from <span class="free">c</span> <span class="free">is</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminal_path_from_def<span class="main">)</span>

<span class="keyword1" id="Incredible_Completeness-path_terminal_path_from"><span class="command">lemma</span></span> path_terminal_path_from<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> set <span class="free">conclusions</span> <span class="main">⟹</span>
  <span class="free">is</span> <span class="main">∈</span> it_paths <span class="main">(</span>it' <span class="free">c</span><span class="main">)</span> <span class="main">⟹</span>
  path <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="main">0</span> <span class="main">#</span> <span class="free">is</span><span class="main">)</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span>terminal_path_from <span class="free">c</span> <span class="free">is</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="free">is</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> path_cons_simp <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> regular_edge <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> it_paths_SnocE<span class="main">)</span>

<span class="keyword1" id="Incredible_Completeness-edge_step"><span class="command">lemma</span></span> edge_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span><span class="main">,</span> <span class="free">ba</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="free">aa</span><span class="main">,</span> <span class="free">bb</span><span class="main">)</span><span class="main">,</span> <span class="free">bc</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> edges"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> 
    <span class="free">i</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">aa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="free">bb</span><span class="main">@</span><span class="main">[</span><span class="free">i</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">bc</span> <span class="main">=</span> in_port_at <span class="main">(</span><span class="free">aa</span><span class="main">,</span><span class="free">bb</span><span class="main">)</span> <span class="free">i</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hyps <span class="main">(</span>nodeOf <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="free">ba</span> <span class="main">=</span> None"</span></span>
  <span class="main">|</span> <span class="free">i</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">aa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"prefix <span class="main">(</span><span class="free">b</span><span class="main">@</span><span class="main">[</span><span class="free">i</span><span class="main">]</span><span class="main">)</span> <span class="free">bb</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hyps <span class="main">(</span>nodeOf <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="free">ba</span> <span class="main">=</span> Some <span class="main">(</span>in_port_at <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> edges.cases<span class="main"><span class="main">[</span></span><span class="operator">consumes</span> 1<span class="main"><span class="main">,</span></span> <span class="operator">case_names</span> Reg Hyp<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Reg <span class="skolem">c</span> <span class="quoted">"<span class="skolem">is</span>"</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">aa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="free">bb</span><span class="main">@</span><span class="main">[</span><span class="skolem">i</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">bc</span> <span class="main">=</span> in_port_at <span class="main">(</span><span class="free">aa</span><span class="main">,</span><span class="free">bb</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hyps <span class="main">(</span>nodeOf <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="free">ba</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> edges.cases <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edge_at_def edge_from_def edge_to_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.split list.split_asm<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Hyp <span class="skolem">c</span> <span class="quoted">"<span class="skolem">is</span>"</span> <span class="skolem">n</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"hyp_port_i_for <span class="main">(</span>it' <span class="skolem">c</span><span class="main">)</span> <span class="skolem">is</span> <span class="main">(</span><span class="free">subst</span> <span class="skolem">s</span> <span class="main">(</span>freshen <span class="skolem">n</span> <span class="free">anyP</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> Hyp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">aa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"prefix <span class="main">(</span><span class="free">b</span><span class="main">@</span><span class="main">[</span><span class="var">?i</span><span class="main">]</span><span class="main">)</span> <span class="free">bb</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"hyps <span class="main">(</span>nodeOf <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="free">ba</span> <span class="main">=</span> Some <span class="main">(</span>in_port_at <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="var">?i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edge_at_def edge_from_def edge_to_def hyp_edge_at_def hyp_edge_to_def hyp_edge_from_def
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> hyp_port_prefix hyps_exist' hyp_port_hyps<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Incredible_Completeness-path_has_prefixes"><span class="command">lemma</span></span> path_has_prefixes<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"path <span class="free">v</span> <span class="free">v'</span> <span class="free">pth</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">v'</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prefix <span class="main">(</span><span class="free">is'</span> <span class="main">@</span> <span class="main">[</span><span class="free">i</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>fst <span class="free">v</span><span class="main">,</span> <span class="free">is'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>in_port_at <span class="main">(</span>fst <span class="free">v</span><span class="main">,</span> <span class="free">is'</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">pth</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> path.induct<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> edge_step <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prefix_snocD<span class="main">)</span>
  
<span class="keyword1" id="Incredible_Completeness-in_scope"><span class="command">lemma</span></span> in_scope<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_in_port <span class="main">(</span><span class="free">v'</span><span class="main">,</span> <span class="free">p'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">∈</span> scope <span class="main">(</span><span class="free">v'</span><span class="main">,</span> <span class="free">p'</span><span class="main">)</span> <span class="main">⟷</span> scope' <span class="free">v'</span> <span class="free">p'</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> scope <span class="main">(</span><span class="free">v'</span><span class="main">,</span> <span class="free">p'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">|∈|</span> vertices"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">pth</span> <span class="bound">t</span><span class="main">.</span>  path <span class="free">v</span> <span class="bound">t</span> <span class="bound">pth</span> <span class="main">⟹</span> terminal_vertex <span class="bound">t</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">v'</span><span class="main">,</span> <span class="free">p'</span><span class="main">)</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="bound">pth</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> scope.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"scope' <span class="free">v'</span> <span class="free">p'</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span>  <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> vertices_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>None <span class="skolem">c</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> None<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> None<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span><span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"scope' <span class="free">v'</span> <span class="free">p'</span> <span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">c</span> <span class="quoted">"<span class="skolem">is</span>"</span><span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> set <span class="free">conclusions</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">∈</span> it_paths <span class="main">(</span>it' <span class="skolem">c</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"path <span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="main">0</span><span class="main">#</span><span class="skolem">is</span><span class="main">)</span> <span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span>terminal_path_from <span class="skolem">c</span> <span class="skolem">is</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> path_terminal_path_from<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> set <span class="free">conclusions</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"terminal_vertex <span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v'</span><span class="main">,</span> <span class="free">p'</span><span class="main">)</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="main">(</span>terminal_path_from <span class="skolem">c</span> <span class="skolem">is</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Some<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v'</span><span class="main">,</span><span class="free">p'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span>edge_to <span class="skolem">c</span><span class="main">)</span> <span class="main">(</span>prefixes <span class="skolem">is</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> terminal_path_from_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">is'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"prefix <span class="skolem">is'</span> <span class="skolem">is</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v'</span><span class="main">,</span><span class="free">p'</span><span class="main">)</span> <span class="main">=</span> edge_to <span class="skolem">c</span> <span class="skolem">is'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"scope' <span class="free">v'</span> <span class="free">p'</span> <span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="main">0</span><span class="main">#</span><span class="skolem">is</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">is'</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">v'</span><span class="main">,</span><span class="free">p'</span><span class="main">)</span> <span class="main">=</span> edge_to <span class="skolem">c</span> <span class="skolem">is'</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">=</span> plain_ant <span class="skolem">c</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edge_to_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> set <span class="free">conclusions</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">∈</span> it_paths <span class="main">(</span>it' <span class="skolem">c</span><span class="main">)</span>›</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> scope'.intros<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">is''</span> <span class="skolem">i</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">v'</span><span class="main">,</span><span class="free">p'</span><span class="main">)</span> <span class="main">=</span> edge_to <span class="skolem">c</span> <span class="skolem">is'</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="main">0</span> <span class="main">#</span> <span class="skolem">is''</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">=</span> in_port_at <span class="free">v'</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edge_to_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> set <span class="free">conclusions</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">∈</span> it_paths <span class="main">(</span>it' <span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹prefix <span class="skolem">is'</span> <span class="skolem">is</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> snoc<span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> scope'.intros<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"valid_in_port <span class="main">(</span><span class="free">v'</span><span class="main">,</span> <span class="free">p'</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"scope' <span class="free">v'</span> <span class="free">p'</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="skolem"><span class="skolem">is'</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="quoted">"<span class="skolem"><span class="skolem">is</span></span>"</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">v'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">is'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">is</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> set <span class="free">conclusions</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">=</span> in_port_at <span class="free">v'</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">∈</span> <span class="main">(#)</span> <span class="main">0</span> <span class="main">`</span> it_paths <span class="main">(</span>it' <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"prefix <span class="main">(</span><span class="skolem">is'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span> <span class="skolem">is</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> scope'.simps<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹scope' <span class="free">v'</span> <span class="free">p'</span> <span class="free">v</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">is</span><span class="main">)</span> <span class="main">|∈|</span> vertices"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="free">v</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> scope_valid<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">is</span><span class="main">)</span> <span class="main">∈</span> scope <span class="main">(</span><span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">is'</span><span class="main">)</span><span class="main">,</span> <span class="free">p'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> scope.intros<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pth</span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"path <span class="main">(</span><span class="skolem">c</span><span class="main">,</span><span class="skolem">is</span><span class="main">)</span> <span class="skolem">t</span> <span class="skolem">pth</span>"</span></span>
    
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"terminal_vertex <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">t</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">from</span></span> path_has_prefixes<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹path <span class="main">(</span><span class="skolem">c</span><span class="main">,</span><span class="skolem">is</span><span class="main">)</span> <span class="skolem">t</span> <span class="skolem">pth</span>›</span></span> <span class="quoted"><span class="quoted">‹snd <span class="skolem">t</span> <span class="main">=</span> <span class="main">[]</span>›</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹prefix <span class="main">(</span><span class="skolem">is'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span> <span class="skolem">is</span>›</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">is'</span><span class="main">)</span><span class="main">,</span> <span class="free">p'</span><span class="main">)</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="skolem">pth</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p'</span> <span class="main">=</span> <span class="main">_</span> ›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">v'</span> <span class="main">=</span> <span class="main">_</span> ›</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> scope <span class="main">(</span><span class="free">v'</span><span class="main">,</span> <span class="free">p'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">v</span> <span class="main">=</span><span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">v'</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> Port_Graph <span class="quoted">nodes</span> <span class="quoted">inPorts</span> <span class="quoted">outPorts</span> <span class="quoted">vertices</span> <span class="quoted">nodeOf</span> <span class="quoted">edges</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nodeOf <span class="main">`</span> fset vertices <span class="main">⊆</span> sset nodes"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmember.rep_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> mem_vertices<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stream.set_map <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> iNodeOf_tree_at<span class="main"><span class="main">[</span></span><span class="operator">OF</span> iwf_it<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">e</span> <span class="main">∈</span> edges<span class="main">.</span> valid_out_port <span class="main">(</span>fst <span class="bound">e</span><span class="main">)</span> <span class="main">∧</span> valid_in_port <span class="main">(</span>snd <span class="bound">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> edges.cases <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edge_at_def
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> edge_from_valid_out_port edge_to_valid_in_port
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> hyp_edge_from_valid_out_port hyp_edge_to_valid_in_port<span class="main">)</span>
    
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">ps1</span><span class="main">,</span> <span class="bound">ps2</span><span class="main">)</span><span class="main">∈</span>edges<span class="main">.</span> valid_out_port <span class="bound">ps1</span> <span class="main">∧</span> valid_in_port <span class="bound">ps2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
  

<span class="keyword1"><span class="command">sublocale</span></span> Scoped_Graph <span class="quoted">nodes</span> <span class="quoted">inPorts</span> <span class="quoted">outPorts</span> <span class="quoted">vertices</span> <span class="quoted">nodeOf</span> <span class="quoted">edges</span> <span class="quoted">hyps</span><span class="keyword1"><span class="command">..</span></span>

<span class="keyword1" id="Incredible_Completeness-hyps_free_path_length"><span class="command">lemma</span></span> hyps_free_path_length<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"path <span class="free">v</span> <span class="free">v'</span> <span class="free">pth</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hyps_free <span class="free">pth</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">pth</span> <span class="main">+</span> length <span class="main">(</span>snd <span class="free">v'</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>snd <span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> edge_step <span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">vidx</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'form</span> vertex <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">vidx</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>   <span class="main">=</span> isidx <span class="main">[</span>fidx conc_forms <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">]</span>"</span></span>
  <span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">vidx</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">is</span></span></span><span class="main">)</span> <span class="main">=</span> iAnnot <span class="main">(</span>tree_at <span class="main">(</span>it' <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">is</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Incredible_Completeness-my_vidx_inj"><span class="command">lemma</span></span> my_vidx_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on vidx <span class="main">(</span>fset vertices<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inj_onI<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  mem_vertices<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> fmember.rep_eq<span class="main"><span class="main">]</span></span> iAnnot_globalize <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> iAnnot.simps<span class="main">)</span>

<span class="keyword1" id="Incredible_Completeness-vidx_not_v_away"><span class="command">lemma</span></span> vidx_not_v_away<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">|∈|</span> vertices <span class="main">⟹</span> vidx <span class="free">v</span> <span class="main">≠</span> v_away"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>vidx.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iAnnot_globalize  <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> iAnnot.simps<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> Instantiation <span class="quoted">inPorts</span> <span class="quoted">outPorts</span> <span class="quoted">nodeOf</span> <span class="quoted">hyps</span>  <span class="quoted">nodes</span> <span class="quoted">edges</span> <span class="quoted">vertices</span> <span class="quoted">labelsIn</span> <span class="quoted">labelsOut</span> <span class="quoted"><span class="free">freshenLC</span></span> <span class="quoted"><span class="free">renameLCs</span></span> <span class="quoted"><span class="free">lconsts</span></span> <span class="quoted"><span class="free">closed</span></span> <span class="quoted"><span class="free">subst</span></span> <span class="quoted"><span class="free">subst_lconsts</span></span> <span class="quoted"><span class="free">subst_renameLCs</span></span> <span class="quoted"><span class="free">anyP</span></span> <span class="quoted">vidx</span> <span class="quoted">inst</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inj_on vidx <span class="main">(</span>fset vertices<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> my_vidx_inj<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span>  Well_Scoped_Graph <span class="quoted">nodes</span> <span class="quoted">inPorts</span> <span class="quoted">outPorts</span> <span class="quoted">vertices</span> <span class="quoted">nodeOf</span> <span class="quoted">edges</span> <span class="quoted">hyps</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">p'</span>
  <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> edges"</span></span> <span class="quoted"><span class="quoted">"hyps <span class="main">(</span>nodeOf <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Some <span class="skolem">p'</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> hyps_correct<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_out_port <span class="main">(</span><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"valid_in_port <span class="main">(</span><span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"valid_in_port <span class="main">(</span><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">p'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">|∈|</span> vertices"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_edges <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> assms
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> fst <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> fst <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> prefix <span class="main">(</span>snd <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">@</span><span class="main">[</span><span class="bound">i</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">p'</span> <span class="main">=</span> in_port_at <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> edge_step<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"scope' <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">p'</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> scope_valid_inport<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">|∈|</span> vertices›</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> scope <span class="main">(</span><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">p'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> in_scope<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹valid_in_port <span class="main">(</span><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">p'</span><span class="main">)</span>›</span></span><span class="main">]</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">p'</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> scope <span class="main">(</span><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">p'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> Acyclic_Graph <span class="quoted">nodes</span> <span class="quoted">inPorts</span> <span class="quoted">outPorts</span> <span class="quoted">vertices</span> <span class="quoted">nodeOf</span> <span class="quoted">edges</span> <span class="quoted">hyps</span> 
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">pth</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"path <span class="skolem">v</span> <span class="skolem">v</span> <span class="skolem">pth</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"hyps_free <span class="skolem">pth</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> hyps_free_path_length<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pth</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> Saturated_Graph <span class="quoted">nodes</span> <span class="quoted">inPorts</span> <span class="quoted">outPorts</span> <span class="quoted">vertices</span> <span class="quoted">nodeOf</span> <span class="quoted">edges</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">p</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"valid_in_port <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">e</span><span class="main">∈</span>edges<span class="main">.</span> snd <span class="bound">e</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">v</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="skolem">cis</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"valid_in_port <span class="main">(</span><span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">cis</span><span class="main">)</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> set <span class="free">conclusions</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mem_vertices<span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">e</span><span class="main">∈</span>edges<span class="main">.</span> snd <span class="bound">e</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">cis</span><span class="main">)</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">cis</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹valid_in_port <span class="main">(</span><span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">cis</span><span class="main">)</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> plain_ant <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> it_paths <span class="main">(</span>it' <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> set <span class="free">conclusions</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"edge_at <span class="skolem">c</span> <span class="main">[]</span> <span class="main">∈</span> edges"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> regular_edge<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>edge_at <span class="skolem">c</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span> plain_ant <span class="skolem">c</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edge_to_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Nil <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> snd_edge_at<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">c'</span> <span class="quoted">"<span class="skolem">is</span>"</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹valid_in_port <span class="main">(</span><span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">cis</span><span class="main">)</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">∈</span> it_paths <span class="main">(</span>it' <span class="skolem">c</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">|∈|</span> inPorts <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="main">(</span>it' <span class="skolem">c</span><span class="main">)</span> <span class="skolem">is</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       
      <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>inPorts' <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="main">(</span>it' <span class="skolem">c</span><span class="main">)</span> <span class="skolem">is</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> inPorts' <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="main">(</span>it' <span class="skolem">c</span><span class="main">)</span> <span class="skolem">is</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inPorts_fset_of in_set_conv_nth<span class="main">)</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"tree_at <span class="main">(</span>it' <span class="skolem">c</span><span class="main">)</span> <span class="skolem">is</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>RNode <span class="skolem">r</span> <span class="skolem">ants</span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> I
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> isHNode <span class="main">(</span>tree_at <span class="main">(</span>it' <span class="skolem">c</span><span class="main">)</span> <span class="skolem">is</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">from</span></span> iwf_length_inPorts_not_HNode<span class="main">[</span><span class="operator">OF</span> iwf_it<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> set <span class="free">conclusions</span>›</span></span><span class="main"><span class="main">]</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">∈</span> it_paths <span class="main">(</span>it' <span class="skolem">c</span><span class="main">)</span>›</span></span> this<span class="main">]</span>
               <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>inPorts' <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="main">(</span>it' <span class="skolem">c</span><span class="main">)</span> <span class="skolem">is</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>children <span class="main">(</span>tree_at <span class="main">(</span>it' <span class="skolem">c</span><span class="main">)</span> <span class="skolem">is</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">∈</span> it_paths <span class="main">(</span>it' <span class="skolem">c</span><span class="main">)</span>›</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span><span class="main">@</span><span class="main">[</span><span class="skolem">i</span><span class="main">]</span> <span class="main">∈</span> it_paths <span class="main">(</span>it' <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> it_path_SnocI<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> set <span class="free">conclusions</span>›</span></span> this
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"edge_at <span class="skolem">c</span> <span class="main">(</span><span class="skolem">is</span><span class="main">@</span><span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> edges"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> regular_edge<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>edge_at <span class="skolem">c</span> <span class="main">(</span><span class="skolem">is</span><span class="main">@</span><span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="main">0</span> <span class="main">#</span> <span class="skolem">is</span><span class="main">)</span><span class="main">,</span>  inPorts' <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="main">(</span>it' <span class="skolem">c</span><span class="main">)</span> <span class="skolem">is</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edge_to_def<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> snd_edge_at<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>H <span class="skolem">n</span> <span class="skolem">s</span><span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"tree_at <span class="main">(</span>it' <span class="skolem">c</span><span class="main">)</span> <span class="skolem">is</span> <span class="main">=</span> HNode <span class="skolem">n</span> <span class="skolem">s</span> <span class="skolem">ants</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> set <span class="free">conclusions</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">∈</span> it_paths <span class="main">(</span>it' <span class="skolem">c</span><span class="main">)</span>›</span></span>  this
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hyp_edge_at <span class="skolem">c</span> <span class="skolem">is</span> <span class="skolem">n</span> <span class="skolem">s</span> <span class="main">∈</span> edges"</span></span><span class="keyword1"><span class="command">..</span></span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">from</span></span> H <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">|∈|</span> inPorts <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="main">(</span>it' <span class="skolem">c</span><span class="main">)</span> <span class="skolem">is</span><span class="main">)</span><span class="main">)</span>›</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> plain_ant <span class="free">anyP</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>hyp_edge_at <span class="skolem">c</span> <span class="skolem">is</span> <span class="skolem">n</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="main">0</span> <span class="main">#</span> <span class="skolem">is</span><span class="main">)</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hyp_edge_to_def<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> snd_hyp_edge_at<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
     <span class="keyword1"><span class="command">qed</span></span>
   <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> Pruned_Port_Graph <span class="quoted">nodes</span> <span class="quoted">inPorts</span> <span class="quoted">outPorts</span> <span class="quoted">vertices</span> <span class="quoted">nodeOf</span> <span class="quoted">edges</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">|∈|</span> vertices"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">pth</span> <span class="bound">v'</span><span class="main">.</span> path <span class="skolem">v</span> <span class="bound">v'</span> <span class="bound">pth</span> <span class="main">∧</span> terminal_vertex <span class="bound">v'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> vertices_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>None <span class="skolem">c</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"terminal_vertex <span class="main">(</span><span class="skolem">c</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> path.intros<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">c</span> <span class="quoted">"<span class="skolem">is</span>"</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"path <span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="main">0</span> <span class="main">#</span> <span class="skolem">is</span><span class="main">)</span> <span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span>terminal_path_from <span class="skolem">c</span> <span class="skolem">is</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> path_terminal_path_from<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"terminal_vertex <span class="main">(</span><span class="skolem">c</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Some<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> Well_Shaped_Graph  <span class="quoted">nodes</span> <span class="quoted">inPorts</span> <span class="quoted">outPorts</span> <span class="quoted">vertices</span> <span class="quoted">nodeOf</span> <span class="quoted">edges</span> <span class="quoted">hyps</span><span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> sol<span class="main">:</span>Solution <span class="quoted">inPorts</span> <span class="quoted">outPorts</span> <span class="quoted">nodeOf</span> <span class="quoted">hyps</span> <span class="quoted">nodes</span> <span class="quoted">vertices</span>  <span class="quoted">labelsIn</span> <span class="quoted">labelsOut</span> <span class="quoted"><span class="free">freshenLC</span></span> <span class="quoted"><span class="free">renameLCs</span></span> <span class="quoted"><span class="free">lconsts</span></span> <span class="quoted"><span class="free">closed</span></span> <span class="quoted"><span class="free">subst</span></span> <span class="quoted"><span class="free">subst_lconsts</span></span> <span class="quoted"><span class="free">subst_renameLCs</span></span> <span class="quoted"><span class="free">anyP</span></span> <span class="quoted">vidx</span> <span class="quoted">inst</span> <span class="quoted">edges</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> edges"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"labelAtOut <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> labelAtIn <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>edges.cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>regular_edge <span class="skolem">c</span> <span class="quoted">"<span class="skolem">is</span>"</span><span class="main">)</span>
   
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">,</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> edge_at <span class="skolem">c</span> <span class="skolem">is</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> edge_from <span class="skolem">c</span> <span class="skolem">is</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fst_edge_at <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="main">0</span> <span class="main">#</span> <span class="skolem">is</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edge_from_def<span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>rev_cases<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t'</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"it' <span class="skolem">c</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"labelAtOut <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">subst</span> <span class="main">(</span>iSubst <span class="var">?t'</span><span class="main">)</span> <span class="main">(</span>freshen <span class="main">(</span>vidx <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>iOutPort <span class="var">?t'</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> regular_edge Nil <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> labelAtOut_def edge_at_def edge_from_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vidx <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> iAnnot <span class="var">?t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  Nil<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="main">(</span>iSubst <span class="var">?t'</span><span class="main">)</span> <span class="main">(</span>freshen <span class="main">(</span>iAnnot <span class="var">?t'</span><span class="main">)</span> <span class="main">(</span>iOutPort <span class="var">?t'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span>fst <span class="main">(</span>root <span class="main">(</span>ts <span class="skolem">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> iwf_subst_freshen_outPort<span class="main">[</span><span class="operator">OF</span> iwf_it<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> set <span class="free">conclusions</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span><span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> set <span class="free">conclusions</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_conc<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> labelAtIn <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> set <span class="free">conclusions</span>›</span></span>  regular_edge Nil
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> labelAtIn_def edge_at_def freshen_closed conclusions_closed closed_no_lconsts<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">is'</span> <span class="skolem">i</span><span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t1</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"tree_at <span class="main">(</span>it' <span class="skolem">c</span><span class="main">)</span> <span class="main">(</span><span class="skolem">is'</span><span class="main">@</span><span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t2</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"tree_at <span class="main">(</span>it' <span class="skolem">c</span><span class="main">)</span> <span class="skolem">is'</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"labelAtOut <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">subst</span> <span class="main">(</span>iSubst <span class="var">?t1</span><span class="main">)</span> <span class="main">(</span>freshen <span class="main">(</span>vidx <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>iOutPort <span class="var">?t1</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> regular_edge snoc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> labelAtOut_def edge_at_def edge_from_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vidx <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> iAnnot <span class="var">?t1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> snoc regular_edge<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="main">(</span>iSubst <span class="var">?t1</span><span class="main">)</span> <span class="main">(</span>freshen <span class="main">(</span>iAnnot <span class="var">?t1</span><span class="main">)</span> <span class="main">(</span>iOutPort <span class="var">?t1</span><span class="main">)</span><span class="main">)</span>
          <span class="main">=</span> <span class="free">subst</span> <span class="main">(</span>iSubst <span class="var">?t2</span><span class="main">)</span> <span class="main">(</span>freshen <span class="main">(</span>iAnnot <span class="var">?t2</span><span class="main">)</span> <span class="main">(</span>a_conc <span class="main">(</span>inPorts' <span class="main">(</span>iNodeOf <span class="var">?t2</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iwf_edge_match<span class="main"><span class="main">[</span></span><span class="operator">OF</span> iwf_it<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> set <span class="free">conclusions</span>›</span></span><span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">∈</span> it_paths <span class="main">(</span>it' <span class="skolem">c</span><span class="main">)</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> snoc<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"iAnnot <span class="var">?t2</span> <span class="main">=</span> vidx <span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="main">0</span> <span class="main">#</span> <span class="skolem">is'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="main">(</span>iSubst <span class="var">?t2</span><span class="main">)</span> <span class="main">(</span>freshen <span class="main">(</span>vidx <span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="main">0</span> <span class="main">#</span> <span class="skolem">is'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>a_conc <span class="main">(</span>inPorts' <span class="main">(</span>iNodeOf <span class="var">?t2</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> labelAtIn <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> regular_edge snoc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> labelAtIn_def edge_at_def<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>hyp_edge <span class="skolem">c</span> <span class="quoted">"<span class="skolem">is</span>"</span> <span class="skolem">n</span> <span class="skolem">s</span> <span class="skolem">ants</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="skolem">s</span> <span class="main">(</span>freshen <span class="skolem">n</span> <span class="free">anyP</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"hyp_port_h_for <span class="main">(</span>it' <span class="skolem">c</span><span class="main">)</span> <span class="skolem">is</span> <span class="var">?f</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?his</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"hyp_port_path_for <span class="main">(</span>it' <span class="skolem">c</span><span class="main">)</span> <span class="skolem">is</span> <span class="var">?f</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t1</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"tree_at <span class="main">(</span>it' <span class="skolem">c</span><span class="main">)</span> <span class="var">?his</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t2</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"tree_at <span class="main">(</span>it' <span class="skolem">c</span><span class="main">)</span> <span class="skolem">is</span>"</span></span>

    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> set <span class="free">conclusions</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">∈</span> it_paths <span class="main">(</span>it' <span class="skolem">c</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹tree_at <span class="main">(</span>it' <span class="skolem">c</span><span class="main">)</span> <span class="skolem">is</span> <span class="main">=</span> HNode <span class="skolem">n</span> <span class="skolem">s</span> <span class="skolem">ants</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">∈</span> hyps_along <span class="main">(</span>it' <span class="skolem">c</span><span class="main">)</span> <span class="skolem">is</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> hyps_exist'<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">,</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> hyp_edge_at <span class="skolem">c</span> <span class="skolem">is</span> <span class="skolem">n</span> <span class="skolem">s</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> hyp_edge_from <span class="skolem">c</span> <span class="skolem">is</span> <span class="skolem">n</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fst_hyp_edge_at <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="main">0</span> <span class="main">#</span> <span class="var">?his</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hyp_edge_from_def<span class="main">)</span>


    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"labelAtOut <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">subst</span> <span class="main">(</span>iSubst <span class="var">?t1</span><span class="main">)</span> <span class="main">(</span>freshen <span class="main">(</span>vidx <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>labelsOut <span class="main">(</span>iNodeOf <span class="var">?t1</span><span class="main">)</span> <span class="var">?h</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> hyp_edge <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hyp_edge_at_def hyp_edge_from_def labelAtOut_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vidx <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> iAnnot <span class="var">?t1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="main">(</span>iSubst <span class="var">?t1</span><span class="main">)</span> <span class="main">(</span>freshen <span class="main">(</span>iAnnot <span class="var">?t1</span><span class="main">)</span> <span class="main">(</span>labelsOut <span class="main">(</span>iNodeOf <span class="var">?t1</span><span class="main">)</span> <span class="var">?h</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="var">?f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="main">∈</span> hyps_along <span class="main">(</span>it' <span class="skolem">c</span><span class="main">)</span> <span class="skolem">is</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> local.hyp_port_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">subst</span> <span class="main">(</span>iSubst <span class="var">?t2</span><span class="main">)</span> <span class="main">(</span>freshen <span class="main">(</span>iAnnot <span class="var">?t2</span><span class="main">)</span> <span class="free">anyP</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> hyp_edge <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="main">(</span>iSubst <span class="var">?t2</span><span class="main">)</span> <span class="main">(</span>freshen <span class="main">(</span>iAnnot <span class="var">?t2</span><span class="main">)</span> <span class="free">anyP</span><span class="main">)</span> <span class="main">=</span> labelAtIn <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> hyp_edge <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> labelAtIn_def  hyp_edge_at_def hyp_edge_to_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Incredible_Completeness-node_disjoint_fresh_vars"><span class="command">lemma</span></span> node_disjoint_fresh_vars<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> sset nodes"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>inPorts' <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i'</span> <span class="main">&lt;</span> length <span class="main">(</span>inPorts' <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"a_fresh <span class="main">(</span>inPorts' <span class="free">n</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">∩</span> a_fresh <span class="main">(</span>inPorts' <span class="free">n</span> <span class="main">!</span> <span class="free">i'</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="free">i</span> <span class="main">=</span> <span class="free">i'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms no_multiple_local_consts
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nodes_def stream.set_map<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> Well_Scoped_Instantiation  <span class="quoted"><span class="free">freshenLC</span></span> <span class="quoted"><span class="free">renameLCs</span></span> <span class="quoted"><span class="free">lconsts</span></span> <span class="quoted"><span class="free">closed</span></span> <span class="quoted"><span class="free">subst</span></span> <span class="quoted"><span class="free">subst_lconsts</span></span> <span class="quoted"><span class="free">subst_renameLCs</span></span> <span class="quoted"><span class="free">anyP</span></span> <span class="quoted">inPorts</span> <span class="quoted">outPorts</span> <span class="quoted">nodeOf</span> <span class="quoted">hyps</span>  <span class="quoted">nodes</span> <span class="quoted">vertices</span> <span class="quoted">labelsIn</span> <span class="quoted">labelsOut</span> <span class="quoted">vidx</span> <span class="quoted">inst</span> <span class="quoted">edges</span> <span class="quoted">local_vars</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">p</span> <span class="skolem">var</span> <span class="skolem">v'</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"valid_in_port <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">|∈|</span> vertices"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="quoted">"<span class="skolem"><span class="skolem">is</span></span>"</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c</span><span class="main">,</span><span class="skolem">is</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">v</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹valid_in_port <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span><span class="main">=</span> <span class="main">_</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span><span class="skolem">is</span><span class="main">)</span> <span class="main">|∈|</span> vertices"</span></span>  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">|∈|</span> inPorts <span class="main">(</span>nodeOf <span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">is</span><span class="main">)</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> set <span class="free">conclusions</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mem_vertices<span class="main">)</span>
  
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">|∈|</span> <span class="main">_</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>inPorts' <span class="main">(</span>nodeOf <span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">is</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> inPorts' <span class="main">(</span>nodeOf <span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">is</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inPorts_fset_of in_set_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> in_port_at <span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">is</span><span class="main">)</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">|∈|</span> vertices"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c'</span></span> <span class="skolem"><span class="skolem">is'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c'</span><span class="main">,</span><span class="skolem">is'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">v'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">var</span> <span class="main">∈</span> local_vars <span class="main">(</span>nodeOf <span class="skolem">v</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">var</span> <span class="main">∈</span> a_fresh <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">freshenLC</span> <span class="main">(</span>vidx <span class="skolem">v</span><span class="main">)</span> <span class="skolem">var</span> <span class="main">∈</span> <span class="free">subst_lconsts</span> <span class="main">(</span>inst <span class="skolem">v'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">is''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is'</span> <span class="main">=</span> <span class="main">0</span><span class="main">#</span><span class="skolem">is''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is''</span> <span class="main">∈</span> it_paths <span class="main">(</span>it' <span class="skolem">c'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v'</span> <span class="main">|∈|</span> vertices›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">is'</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v'</span><span class="main">=</span><span class="main">_</span>›</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹<span class="free">freshenLC</span> <span class="main">(</span>vidx <span class="skolem">v</span><span class="main">)</span> <span class="skolem">var</span> <span class="main">∈</span> <span class="free">subst_lconsts</span> <span class="main">(</span>inst <span class="skolem">v'</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">subst_lconsts</span> <span class="main">(</span>inst <span class="skolem">v'</span><span class="main">)</span> <span class="main">=</span> <span class="free">subst_lconsts</span> <span class="main">(</span>iSubst <span class="main">(</span>tree_at <span class="main">(</span>it' <span class="skolem">c'</span><span class="main">)</span> <span class="skolem">is''</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v'</span><span class="main">=</span><span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is'</span><span class="main">=</span><span class="main">_</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is''</span> <span class="main">∈</span> it_paths <span class="main">(</span>it' <span class="skolem">c'</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> fresh_at_path <span class="main">(</span>it' <span class="skolem">c'</span><span class="main">)</span> <span class="skolem">is''</span> <span class="main">∪</span> range <span class="main">(</span><span class="free">freshenLC</span> v_away<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> globalize_local_consts<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">freshenLC</span> <span class="main">(</span>vidx <span class="skolem">v</span><span class="main">)</span> <span class="skolem">var</span> <span class="main">∈</span> fresh_at_path <span class="main">(</span>it' <span class="skolem">c'</span><span class="main">)</span> <span class="skolem">is''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">|∈|</span> vertices›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">is'''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"prefix <span class="skolem">is'''</span> <span class="skolem">is''</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">freshenLC</span> <span class="main">(</span>vidx <span class="skolem">v</span><span class="main">)</span> <span class="skolem">var</span> <span class="main">∈</span> fresh_at <span class="main">(</span>it' <span class="skolem">c'</span><span class="main">)</span> <span class="skolem">is'''</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fresh_at_path_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">is''''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"prefix <span class="main">(</span><span class="skolem">is''''</span><span class="main">@</span><span class="main">[</span><span class="skolem">i'</span><span class="main">]</span><span class="main">)</span> <span class="skolem">is''</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">freshenLC</span> <span class="main">(</span>vidx <span class="skolem">v</span><span class="main">)</span> <span class="skolem">var</span> <span class="main">∈</span> fresh_at <span class="main">(</span>it' <span class="skolem">c'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">is''''</span><span class="main">@</span><span class="main">[</span><span class="skolem">i'</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> append_butlast_last_id<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">is'''</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">is'''</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fresh_at_snoc append_butlast_last_id<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">from</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">is''</span> <span class="main">∈</span> it_paths <span class="main">(</span>it' <span class="skolem">c'</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹prefix <span class="main">(</span><span class="skolem">is''''</span><span class="main">@</span><span class="main">[</span><span class="skolem">i'</span><span class="main">]</span><span class="main">)</span> <span class="skolem">is''</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">is''''</span><span class="main">@</span><span class="main">[</span><span class="skolem">i'</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> it_paths <span class="main">(</span>it' <span class="skolem">c'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> it_paths_prefix<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is''''</span> <span class="main">∈</span> it_paths <span class="main">(</span>it' <span class="skolem">c'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> append_prefixD it_paths_prefix <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">from</span></span> this <span class="quoted"><span class="quoted">‹<span class="free">freshenLC</span> <span class="main">(</span>vidx <span class="skolem">v</span><span class="main">)</span> <span class="skolem">var</span> <span class="main">∈</span> fresh_at <span class="main">(</span>it' <span class="skolem">c'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">is''''</span><span class="main">@</span><span class="main">[</span><span class="skolem">i'</span><span class="main">]</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="skolem">c'</span> <span class="main">∧</span> <span class="skolem">is</span> <span class="main">=</span> <span class="main">0</span> <span class="main">#</span> <span class="skolem">is''''</span> <span class="main">∧</span> <span class="skolem">var</span> <span class="main">∈</span> a_fresh <span class="main">(</span>inPorts' <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="main">(</span>it' <span class="skolem">c'</span><span class="main">)</span> <span class="skolem">is''''</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fresh_at_def' <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">|∈|</span> vertices›</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">v'</span> <span class="main">|∈|</span> vertices›</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  iAnnot_globalize it_paths_butlast <span class="quoted"><span class="quoted">‹<span class="skolem">v</span><span class="main">=</span><span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v'</span><span class="main">=</span><span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is'</span><span class="main">=</span><span class="main">_</span>›</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> iAnnot.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">=</span> <span class="main">0</span> <span class="main">#</span> <span class="skolem">is''''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">var</span> <span class="main">∈</span> a_fresh <span class="main">(</span>inPorts' <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="main">(</span>it' <span class="skolem">c'</span><span class="main">)</span> <span class="skolem">is''''</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">is''''</span><span class="main">@</span><span class="main">[</span><span class="skolem">i'</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> it_paths <span class="main">(</span>it' <span class="skolem">c'</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> length <span class="main">(</span>inPorts' <span class="main">(</span>nodeOf <span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">is</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> iwf_length_inPorts<span class="main">[</span><span class="operator">OF</span> iwf_it<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> set <span class="free">conclusions</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> it_paths_SnocE <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span><span class="main">=</span><span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c'</span> <span class="main">=</span> <span class="main">_</span>›</span></span> order.strict_trans2<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nodeOf <span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">is</span><span class="main">)</span> <span class="main">∈</span> sset nodes"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c'</span> <span class="main">=</span> <span class="main">_</span>›</span></span> nodeOf.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iNodeOf_tree_at<span class="main"><span class="main">[</span></span><span class="operator">OF</span> iwf_it<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> set <span class="free">conclusions</span>›</span></span><span class="main"><span class="main">]</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">is''''</span> <span class="main">∈</span> it_paths <span class="main">(</span>it' <span class="skolem">c'</span><span class="main">)</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="skolem">c'</span> <span class="main">=</span> <span class="main">_</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">var</span> <span class="main">∈</span> a_fresh <span class="main">(</span>inPorts' <span class="main">(</span>iNodeOf <span class="main">(</span>tree_at <span class="main">(</span>it' <span class="skolem">c'</span><span class="main">)</span> <span class="skolem">is''''</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">)</span>›</span></span>
       <span class="quoted"><span class="quoted">‹<span class="skolem">var</span> <span class="main">∈</span> a_fresh <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> inPorts' <span class="main">(</span>nodeOf <span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">is</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span>›</span></span>
       node_disjoint_fresh_vars<span class="main">[</span><span class="operator">OF</span>
          <span class="quoted"><span class="quoted">‹nodeOf <span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">is</span><span class="main">)</span> <span class="main">∈</span> sset nodes›</span></span>
          <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>inPorts' <span class="main">(</span>nodeOf <span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">is</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">&lt;</span> length <span class="main">(</span>inPorts' <span class="main">(</span>nodeOf <span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">is</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span><span class="main">=</span><span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c'</span><span class="main">=</span><span class="skolem">c</span>›</span></span><span class="main">)</span>
   
  <span class="keyword1"><span class="command">from</span></span>  <span class="quoted"><span class="quoted">‹prefix <span class="main">(</span><span class="skolem">is''''</span><span class="main">@</span><span class="main">[</span><span class="skolem">i'</span><span class="main">]</span><span class="main">)</span> <span class="skolem">is''</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefix <span class="main">(</span><span class="skolem">is</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i'</span><span class="main">]</span><span class="main">)</span> <span class="skolem">is'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is'</span><span class="main">=</span><span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span><span class="main">=</span><span class="main">_</span>›</span></span><span class="main">)</span>

 
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> set <span class="free">conclusions</span>›</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">is''</span> <span class="main">∈</span> it_paths <span class="main">(</span>it' <span class="skolem">c'</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹prefix <span class="main">(</span><span class="skolem">is</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i'</span><span class="main">]</span><span class="main">)</span> <span class="skolem">is'</span>›</span></span>
      <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> in_port_at <span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">is</span><span class="main">)</span> <span class="skolem">i</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"scope' <span class="skolem">v</span> <span class="skolem">p</span> <span class="skolem">v'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span><span class="main">=</span><span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v'</span><span class="main">=</span><span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c'</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is'</span> <span class="main">=</span> <span class="main">_</span>›</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span><span class="main">=</span><span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> scope'.intros<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> scope <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹valid_in_port <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_scope<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> Scoped_Proof_Graph <span class="quoted"><span class="free">freshenLC</span></span> <span class="quoted"><span class="free">renameLCs</span></span> <span class="quoted"><span class="free">lconsts</span></span> <span class="quoted"><span class="free">closed</span></span> <span class="quoted"><span class="free">subst</span></span> <span class="quoted"><span class="free">subst_lconsts</span></span> <span class="quoted"><span class="free">subst_renameLCs</span></span> <span class="quoted"><span class="free">anyP</span></span>  <span class="quoted">inPorts</span> <span class="quoted">outPorts</span> <span class="quoted">nodeOf</span> <span class="quoted">hyps</span> <span class="quoted">nodes</span> <span class="quoted">vertices</span> <span class="quoted">labelsIn</span> <span class="quoted">labelsOut</span> <span class="quoted">vidx</span> <span class="quoted">inst</span> <span class="quoted">edges</span> <span class="quoted">local_vars</span><span class="keyword1"><span class="command">..</span></span>

<span class="comment1">(* interpretation of @{term Tasked_Proof_Graph} has to be named to avoid name clashes in @{term Abstract_Task}. *)</span>
<span class="keyword1"><span class="command">sublocale</span></span> tpg<span class="main">:</span>Tasked_Proof_Graph <span class="quoted"><span class="free">freshenLC</span></span> <span class="quoted"><span class="free">renameLCs</span></span> <span class="quoted"><span class="free">lconsts</span></span> <span class="quoted"><span class="free">closed</span></span> <span class="quoted"><span class="free">subst</span></span> <span class="quoted"><span class="free">subst_lconsts</span></span> <span class="quoted"><span class="free">subst_renameLCs</span></span> <span class="quoted"><span class="free">anyP</span></span> <span class="quoted"><span class="free">antecedent</span></span> <span class="quoted"><span class="free">consequent</span></span> <span class="quoted"><span class="free">rules</span></span> <span class="quoted"><span class="free">assumptions</span></span> <span class="quoted"><span class="free">conclusions</span></span>
  <span class="quoted">vertices</span> <span class="quoted">nodeOf</span> <span class="quoted">edges</span> <span class="quoted">vidx</span> <span class="quoted">inst</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map Conclusion <span class="free">conclusions</span><span class="main">)</span> <span class="main">⊆</span> nodeOf <span class="main">`</span> fset vertices"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> set <span class="free">conclusions</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">|∈|</span> vertices"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"nodeOf <span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∈</span> nodeOf <span class="main">`</span> fset vertices"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> fmember.rep_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> imageI<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Conclusion <span class="skolem">c</span> <span class="main">∈</span> nodeOf <span class="main">`</span> fset vertices"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Incredible_Everything">
<div class="head">
<h1>Theory Incredible_Everything</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Incredible_Everything
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Incredible_Correctness.html">Incredible_Correctness</a> <a href="Incredible_Completeness.html">Incredible_Completeness</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* This file depends on all theory, to have a single entry point. *)</span>

<span class="comment1">(* It can be used to pretty-print Isabelle output into the proof document.
   This is not used at the moment. *)</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Propositional_Formulas">
<div class="head">
<h1>Theory Propositional_Formulas</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Propositional_Formulas
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Abstract_Formula.html">Abstract_Formula</a>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Countable.html">HOL-Library.Countable</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Infinite_Set.html">HOL-Library.Infinite_Set</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">class</span></span> infinite <span class="main">=</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> infinite_UNIV<span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> nat <span class="main">::</span> <span class="quoted">infinite</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">instance</span></span> prod <span class="main">::</span> <span class="main">(</span><span class="quoted">infinite</span><span class="main">,</span> <span class="quoted">type</span><span class="main">)</span> <span class="quoted">infinite</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">intro_classes</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_prod infinite_UNIV<span class="main">)</span>
<span class="keyword1"><span class="command">instance</span></span> list <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">infinite</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">intro_classes</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> infinite_UNIV_listI<span class="main">)</span>

<span class="keyword1" id="Propositional_Formulas-countable_infinite_ex_bij"><span class="command">lemma</span></span> countable_infinite_ex_bij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>countable<span class="main">,</span>infinite<span class="main">}</span><span class="main">⇒</span><span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>countable<span class="main">,</span>infinite<span class="main">}</span><span class="main">)</span><span class="main">.</span> bij <span class="bound">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>range <span class="main">(</span>to_nat<span class="main">::</span><span class="tfree">'a</span> <span class="main">⇒</span> nat<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_imageD infinite_UNIV <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>range <span class="main">(</span>to_nat<span class="main">::</span><span class="tfree">'b</span> <span class="main">⇒</span> nat<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_imageD infinite_UNIV <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span><span class="main">.</span> bij_betw <span class="bound">f</span> <span class="main">(</span>range <span class="main">(</span>to_nat<span class="main">::</span><span class="tfree">'a</span> <span class="main">⇒</span> nat<span class="main">)</span><span class="main">)</span> <span class="main">(</span>range <span class="main">(</span>to_nat<span class="main">::</span><span class="tfree">'b</span> <span class="main">⇒</span> nat<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> bij_betw_inv bij_betw_trans bij_enumerate<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f_def<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="skolem">f</span> <span class="main">(</span>range <span class="main">(</span>to_nat<span class="main">::</span><span class="tfree">'a</span> <span class="main">⇒</span> nat<span class="main">)</span><span class="main">)</span> <span class="main">(</span>range <span class="main">(</span>to_nat<span class="main">::</span><span class="tfree">'b</span> <span class="main">⇒</span> nat<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f_range_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">`</span> <span class="main">(</span>range <span class="main">(</span>to_nat<span class="main">::</span><span class="tfree">'a</span> <span class="main">⇒</span> nat<span class="main">)</span><span class="main">)</span> <span class="main">=</span> range <span class="main">(</span>to_nat<span class="main">::</span><span class="tfree">'b</span> <span class="main">⇒</span> nat<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"surj <span class="main">(</span><span class="main">(</span>from_nat<span class="main">::</span>nat <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">∘</span> <span class="skolem">f</span> <span class="main">∘</span> <span class="main">(</span>to_nat<span class="main">::</span><span class="tfree">'a</span> <span class="main">⇒</span> nat<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> surjI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"to_nat <span class="main">(</span><span class="skolem">a</span><span class="main">::</span><span class="tfree">'b</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> range <span class="main">(</span>to_nat<span class="main">::</span><span class="tfree">'b</span> <span class="main">⇒</span> nat<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> f_range_trans <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="skolem">f</span> <span class="main">`</span> <span class="main">(</span>range <span class="main">(</span>to_nat<span class="main">::</span><span class="tfree">'a</span> <span class="main">⇒</span> nat<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> imageE <span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">c</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> range <span class="main">(</span>to_nat<span class="main">::</span><span class="tfree">'a</span> <span class="main">⇒</span> nat<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> f_def <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inv_into <span class="main">(</span>range <span class="main">(</span>to_nat<span class="main">::</span><span class="tfree">'a</span> <span class="main">⇒</span> nat<span class="main">)</span><span class="main">)</span> <span class="skolem">f</span> <span class="skolem">b</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> bij_betw_def inv_into_f_f<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> cd<span class="main">:</span> <span class="quoted"><span class="quoted">"from_nat <span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">d</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">∈</span> range to_nat›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"to_nat <span class="skolem">d</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹to_nat <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">b</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"from_nat <span class="skolem">b</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> from_nat_to_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>from_nat <span class="main">∘</span> <span class="skolem">f</span> <span class="main">∘</span> to_nat<span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>from_nat<span class="main">::</span>nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">∘</span> inv_into <span class="main">(</span>range <span class="main">(</span>to_nat<span class="main">::</span><span class="tfree">'a</span> <span class="main">⇒</span> nat<span class="main">)</span><span class="main">)</span> <span class="skolem">f</span> <span class="main">∘</span> <span class="main">(</span>to_nat<span class="main">::</span><span class="tfree">'b</span> <span class="main">⇒</span> nat<span class="main">)</span><span class="main">)</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cd<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj <span class="main">(</span><span class="main">(</span>from_nat<span class="main">::</span>nat <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">∘</span> <span class="skolem">f</span> <span class="main">∘</span> <span class="main">(</span>to_nat<span class="main">::</span><span class="tfree">'a</span> <span class="main">⇒</span> nat<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> injI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> bij_betw_inv_into_left f_def f_inv_into_f f_range_trans from_nat_def image_eqI rangeI to_nat_split<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> bijI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Propositional formulas are either a variable from an infinite but countable set,
  or a function given by a name and the arguments.›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'cname</span><span class="main">)</span> pform <span class="main">=</span>
    Var <span class="quoted"><span class="quoted">"<span class="tfree">'var</span><span class="main">::</span><span class="main">{</span>countable<span class="main">,</span>infinite<span class="main">}</span>"</span></span>
  <span class="main">|</span> Fun <span class="main">(</span><span class="free"><span class="entity">name</span></span><span class="main">:</span><span class="tfree"><span class="quoted"><span class="tfree">'cname</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">params</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'cname</span><span class="main">)</span> pform list"</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Substitution on and closedness of propositional formulas is straight forward.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span><span class="main">::</span><span class="main">{</span>countable<span class="main">,</span>infinite<span class="main">}</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'cname</span><span class="main">)</span> pform<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'cname</span><span class="main">)</span> pform <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'cname</span><span class="main">)</span> pform"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">=</span> Fun <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>map <span class="main">(</span><span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">closed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span><span class="main">::</span><span class="main">{</span>countable<span class="main">,</span>infinite<span class="main">}</span><span class="main">,</span><span class="tfree">'cname</span><span class="main">)</span> pform <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">closed</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">⟷</span> False"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">closed</span> <span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">⟷</span> list_all <span class="free">closed</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now we can interpret <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Abstract_Formulas</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
  As there are no locally fixed constants in propositional formulas, most of the locale parameters 
  are dummy values›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> propositional<span class="main">:</span> Abstract_Formulas
  <span class="comment1">― ‹No need to freshen locally fixed constants›</span>
  <span class="quoted"><span class="quoted">"curry <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">f</span><span class="main">.</span> bij <span class="bound">f</span><span class="main">)</span><span class="main">::</span> nat <span class="main">⇒</span> <span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'var</span>"</span></span>
  <span class="comment1">― ‹also no renaming needed as there are no locally fixed constants›</span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> id"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">{}</span>"</span></span>
  <span class="comment1">― ‹closedness and substitution as defined above›</span>
  <span class="quoted"><span class="quoted">"closed <span class="main">::</span> <span class="main">(</span><span class="tfree">'var</span><span class="main">::</span><span class="main">{</span>countable<span class="main">,</span>infinite<span class="main">}</span><span class="main">,</span><span class="tfree">'cname</span><span class="main">)</span> pform <span class="main">⇒</span> bool"</span></span> <span class="quoted">subst</span>
  <span class="comment1">― ‹no substitution and renaming of locally fixed constants›</span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> id"</span></span>
  <span class="comment1">― ‹most generic formula›</span>
  <span class="quoted"><span class="quoted">"Var undefined"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">v</span> <span class="skolem">a'</span> <span class="skolem">v'</span>
  <span class="keyword1"><span class="command">from</span></span> countable_infinite_ex_bij <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"bij <span class="main">(</span><span class="skolem">f</span><span class="main">::</span>nat <span class="main">×</span> <span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'var</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>curry <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">f</span><span class="main">.</span> bij <span class="main">(</span><span class="bound">f</span><span class="main">::</span>nat <span class="main">×</span> <span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'var</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">a</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">(</span><span class="skolem">v</span><span class="main">::</span><span class="tfree">'var</span><span class="main">)</span> <span class="main">=</span> curry <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">f</span><span class="main">.</span> bij <span class="bound">f</span><span class="main">)</span> <span class="main">(</span><span class="skolem">a'</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">(</span><span class="skolem">v'</span><span class="main">::</span><span class="tfree">'var</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
       <span class="main">(</span><span class="skolem">a</span> <span class="main">=</span> <span class="skolem">a'</span> <span class="main">∧</span> <span class="skolem">v</span> <span class="main">=</span> <span class="skolem">v'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> someI2 <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Q<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">f</span></span><span class="main"><span class="main">.</span></span> curry <span class="bound"><span class="bound">f</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="main"><span class="main">=</span></span> curry <span class="bound"><span class="bound">f</span></span> <span class="skolem"><span class="skolem">a'</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="main"><span class="main">⟷</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="main"><span class="main">=</span></span> <span class="skolem"><span class="skolem">a'</span></span> <span class="main"><span class="main">∧</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="main"><span class="main">=</span></span> <span class="skolem"><span class="skolem">v'</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> bij_pointE prod.inject<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"closed <span class="main">(</span><span class="skolem">f</span><span class="main">::</span><span class="main">(</span><span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'cname</span><span class="main">)</span> pform<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subst <span class="skolem">s</span> <span class="skolem">f</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subst.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">s</span> <span class="skolem">n</span> <span class="skolem">ps</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">ps</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst Var <span class="skolem">f</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'cname</span><span class="main">)</span> pform"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> map_idI<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">f</span><span class="main">.</span> subst <span class="bound">s</span> <span class="main">(</span><span class="bound">f</span><span class="main">::</span><span class="main">(</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'cname</span><span class="main">)</span> pform<span class="main">)</span> <span class="main">=</span> <span class="bound">f</span><span class="main">)</span> <span class="main">∧</span> <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted">Var</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">declare</span></span> propositional.subst_lconsts_empty_subst <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Incredible_Propositional">
<div class="head">
<h1>Theory Incredible_Propositional</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Incredible_Propositional <span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Abstract_Rules_To_Incredible.html">Abstract_Rules_To_Incredible</a>
  <a href="Propositional_Formulas.html">Propositional_Formulas</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Our concrete interpretation with propositional logic will cover conjunction and implication
  as well as constant symbols. The type for variables will be <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">string</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> prop_funs <span class="main">=</span> <span class="quoted">"and"</span> <span class="main">|</span> imp <span class="main">|</span> Const <span class="quoted"><span class="quoted">"string"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The rules are introduction and elimination of conjunction and implication.›</span></span>
<span class="keyword1"><span class="command">datatype</span></span> prop_rule <span class="main">=</span> andI <span class="main">|</span> andE <span class="main">|</span> impI <span class="main">|</span> impE

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">prop_rules</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"prop_rule stream"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">prop_rules</span> <span class="main">=</span> cycle <span class="main">[</span>andI<span class="main">,</span> andE<span class="main">,</span> impI<span class="main">,</span> impE<span class="main">]</span>"</span></span>

<span class="keyword1" id="Incredible_Propositional-iR_prop_rules"><span class="command">lemma</span></span> iR_prop_rules <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sset prop_rules <span class="main">=</span> <span class="main">{</span>andI<span class="main">,</span> andE<span class="main">,</span> impI<span class="main">,</span> impE<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> prop_rules_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Just some short notation.›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>string<span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> pform"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≡</span> Var <span class="inner_quoted">''X''</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>string<span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> pform"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">≡</span> Var <span class="inner_quoted">''Y''</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Finally the right- and left-hand sides of the rules.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">consequent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"prop_rule <span class="main">⇒</span> <span class="main">(</span>string<span class="main">,</span> prop_funs<span class="main">)</span> pform list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">consequent</span> andI <span class="main">=</span> <span class="main">[</span>Fun and <span class="main">[</span>X<span class="main">,</span> Y<span class="main">]</span><span class="main">]</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">consequent</span> andE <span class="main">=</span> <span class="main">[</span>X<span class="main">,</span> Y<span class="main">]</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">consequent</span> impI <span class="main">=</span> <span class="main">[</span>Fun imp <span class="main">[</span>X<span class="main">,</span> Y<span class="main">]</span><span class="main">]</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">consequent</span> impE <span class="main">=</span> <span class="main">[</span>Y<span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">antecedent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"prop_rule <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span>string<span class="main">,</span>prop_funs<span class="main">)</span> pform<span class="main">,</span>string<span class="main">)</span> antecedent list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">antecedent</span> andI <span class="main">=</span> <span class="main">[</span>plain_ant X<span class="main">,</span> plain_ant Y<span class="main">]</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">antecedent</span> andE <span class="main">=</span> <span class="main">[</span>plain_ant <span class="main">(</span>Fun and <span class="main">[</span>X<span class="main">,</span> Y<span class="main">]</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">antecedent</span> impI <span class="main">=</span> <span class="main">[</span>Antecedent <span class="main">{|</span>X<span class="main">|}</span> Y <span class="main">{}</span><span class="main">]</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">antecedent</span> impE <span class="main">=</span> <span class="main">[</span>plain_ant <span class="main">(</span>Fun imp <span class="main">[</span>X<span class="main">,</span> Y<span class="main">]</span><span class="main">)</span><span class="main">,</span> plain_ant X<span class="main">]</span>"</span></span>


<span class="keyword1"><span class="command">interpretation</span></span> propositional<span class="main">:</span> Abstract_Rules
  <span class="quoted"><span class="quoted">"curry <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">f</span><span class="main">.</span> bij <span class="bound">f</span><span class="main">)</span><span class="main">::</span> nat <span class="main">⇒</span> string <span class="main">⇒</span> string"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> id"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">{}</span>"</span></span>
  <span class="quoted"><span class="quoted">"closed <span class="main">::</span> <span class="main">(</span>string<span class="main">,</span> prop_funs<span class="main">)</span> pform <span class="main">⇒</span> bool"</span></span>
  <span class="quoted">subst</span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">{}</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> id"</span></span>
  <span class="quoted"><span class="quoted">"Var undefined"</span></span>
  <span class="quoted">antecedent</span>
  <span class="quoted">consequent</span>
  <span class="quoted">prop_rules</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span><span class="main">∈</span>sset prop_rules<span class="main">.</span> consequent <span class="bound">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> prop_rules_def
    <span class="keyword1"><span class="command">using</span></span> consequent.elims <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span><span class="main">∈</span>sset prop_rules<span class="main">.</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">{}</span><span class="main">)</span> <span class="main">`</span> set <span class="main">(</span>consequent <span class="bound">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i'</span> <span class="skolem">r</span> <span class="skolem">i</span> <span class="skolem">ia</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> sset prop_rules"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span> <span class="main">&lt;</span> length <span class="main">(</span>antecedent <span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> length <span class="main">(</span>antecedent <span class="skolem">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"a_fresh <span class="main">(</span>antecedent <span class="skolem">r</span> <span class="main">!</span> <span class="skolem">ia</span><span class="main">)</span> <span class="main">∩</span> a_fresh <span class="main">(</span>antecedent <span class="skolem">r</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="skolem">ia</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∪</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">{}</span><span class="main">)</span> <span class="main">`</span> fset <span class="main">(</span>a_hyps <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> a_fresh <span class="skolem">p</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Incredible_Propositional_Tasks">
<div class="head">
<h1>Theory Incredible_Propositional_Tasks</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Incredible_Propositional_Tasks
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Incredible_Completeness.html">Incredible_Completeness</a>
  <a href="Incredible_Propositional.html">Incredible_Propositional</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> ND_Rules_Inst <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1" id="Incredible_Propositional_Tasks-eff_NatRuleI"><span class="command">lemma</span></span> eff_NatRuleI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">nat_rule</span> <span class="free">rule</span> <span class="free">c</span> <span class="free">ants</span>
    <span class="main">⟹</span> <span class="free">entail</span> <span class="main">=</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="free">subst</span> <span class="free">s</span> <span class="main">(</span>freshen <span class="free">a</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span>
    <span class="main">⟹</span> <span class="free">hyps</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">ant</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="free">subst</span> <span class="free">s</span> <span class="main">(</span>freshen <span class="free">a</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">|`|</span> a_hyps <span class="bound">ant</span> <span class="main">|∪|</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">subst</span> <span class="free">s</span> <span class="main">(</span>freshen <span class="free">a</span> <span class="main">(</span>a_conc <span class="bound">ant</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|`|</span> <span class="free">ants</span><span class="main">)</span>
    <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">ant</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">ant</span> <span class="main">|∈|</span> <span class="free">ants</span> <span class="main">⟹</span> <span class="bound">f</span> <span class="main">|∈|</span> <span class="free">Γ</span> <span class="main">⟹</span> <span class="free">freshenLC</span> <span class="free">a</span> <span class="main">`</span> <span class="main">(</span>a_fresh <span class="bound">ant</span><span class="main">)</span> <span class="main">∩</span> <span class="free">lconsts</span> <span class="bound">f</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>
    <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">ant</span><span class="main">.</span> <span class="bound">ant</span> <span class="main">|∈|</span> <span class="free">ants</span> <span class="main">⟹</span> <span class="free">freshenLC</span> <span class="free">a</span> <span class="main">`</span> <span class="main">(</span>a_fresh <span class="bound">ant</span><span class="main">)</span> <span class="main">∩</span> <span class="free">subst_lconsts</span> <span class="free">s</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>
    <span class="main">⟹</span> eff <span class="main">(</span>NatRule <span class="free">rule</span><span class="main">)</span> <span class="free">entail</span> <span class="free">hyps</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> eff.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> Abstract_Task <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1" id="Incredible_Propositional_Tasks-natEff_InstI"><span class="command">lemma</span></span>  natEff_InstI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">rule</span> <span class="main">=</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>
  <span class="main">⟹</span> <span class="free">c</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">consequent</span> <span class="free">r</span><span class="main">)</span>
  <span class="main">⟹</span> <span class="free">antec</span> <span class="main">=</span> f_antecedent <span class="free">r</span>
  <span class="main">⟹</span> natEff_Inst <span class="free">rule</span> <span class="free">c</span> <span class="free">antec</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> natEff_Inst.intros<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Task 1.1›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This is the very first task of the Incredible Proof Machine: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span> <span class="main"><span class="main">⟶</span></span> <span class="free"><span class="free">A</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>string<span class="main">,</span>prop_funs<span class="main">)</span> pform"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≡</span> Fun <span class="main">(</span>Const <span class="inner_quoted">''A''</span><span class="main">)</span> <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹First the task is defined as an <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Abstract_Task</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> task1_1<span class="main">:</span> Abstract_Task
  <span class="quoted"><span class="quoted">"curry <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">f</span><span class="main">.</span> bij <span class="bound">f</span><span class="main">)</span><span class="main">::</span> nat <span class="main">⇒</span> string <span class="main">⇒</span> string"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> id"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">{}</span>"</span></span>
  <span class="quoted"><span class="quoted">"closed <span class="main">::</span> <span class="main">(</span>string<span class="main">,</span> prop_funs<span class="main">)</span> pform <span class="main">⇒</span> bool"</span></span>
  <span class="quoted">subst</span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">{}</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> id"</span></span>
  <span class="quoted"><span class="quoted">"Var undefined"</span></span>
  <span class="quoted">antecedent</span>
  <span class="quoted">consequent</span>
  <span class="quoted">prop_rules</span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span>A<span class="main">]</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span>A<span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Then we show, that this task has a proof within our formalization of natural deduction
  by giving a concrete proof tree.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"task1_1.solved"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> task1_1.solved_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{|</span>A<span class="main">|}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Node <span class="main">(</span><span class="main">{|</span>A<span class="main">|}</span> <span class="main">⊢</span> A<span class="main">,</span> Axiom<span class="main">)</span> <span class="main">{||}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> task1_1.wf<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> task1_1.eff.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="operator">simp</span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="operator">clarsimp</span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> tfinite.intros<span class="main">)</span>


<span class="keyword1"><span class="command">print_locale</span></span> Vertex_Graph
<span class="keyword1"><span class="command">interpretation</span></span> task1_1<span class="main">:</span> Vertex_Graph <span class="quoted">task1_1.nodes</span> <span class="quoted">task1_1.inPorts</span> <span class="quoted">task1_1.outPorts</span> <span class="quoted"><span class="quoted">"<span class="main">{|</span><span class="main">0</span><span class="main">::</span>nat<span class="main">,</span><span class="main">1</span><span class="main">|}</span>"</span></span>
  <span class="quoted"><span class="quoted">"undefined<span class="main">(</span><span class="main">0</span> <span class="main">:=</span> Assumption A<span class="main">,</span> <span class="main">1</span> <span class="main">:=</span> Conclusion A<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">print_locale</span></span> Pre_Port_Graph
<span class="keyword1"><span class="command">interpretation</span></span> task1_1<span class="main">:</span> Pre_Port_Graph <span class="quoted">task1_1.nodes</span> <span class="quoted">task1_1.inPorts</span> <span class="quoted">task1_1.outPorts</span> <span class="quoted"><span class="quoted">"<span class="main">{|</span><span class="main">0</span><span class="main">::</span>nat<span class="main">,</span><span class="main">1</span><span class="main">|}</span>"</span></span>
  <span class="quoted"><span class="quoted">"undefined<span class="main">(</span><span class="main">0</span> <span class="main">:=</span> Assumption A<span class="main">,</span> <span class="main">1</span> <span class="main">:=</span> Conclusion A<span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="main">0</span><span class="main">,</span>Reg A<span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">1</span><span class="main">,</span>plain_ant A<span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">print_locale</span></span> Instantiation
<span class="keyword1"><span class="command">interpretation</span></span> task1_1<span class="main">:</span> Instantiation
  <span class="quoted">task1_1.inPorts</span>
  <span class="quoted">task1_1.outPorts</span>
  <span class="quoted"><span class="quoted">"undefined<span class="main">(</span><span class="main">0</span> <span class="main">:=</span> Assumption A<span class="main">,</span> <span class="main">1</span> <span class="main">:=</span> Conclusion A<span class="main">)</span>"</span></span>
  <span class="quoted">task1_1.hyps</span>
  <span class="quoted">task1_1.nodes</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="main">0</span><span class="main">,</span>Reg A<span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">1</span><span class="main">,</span>plain_ant A<span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">{|</span><span class="main">0</span><span class="main">::</span>nat<span class="main">,</span><span class="main">1</span><span class="main">|}</span>"</span></span>
  <span class="quoted">task1_1.labelsIn</span>
  <span class="quoted">task1_1.labelsOut</span>
  <span class="quoted"><span class="quoted">"curry <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">f</span><span class="main">.</span> bij <span class="bound">f</span><span class="main">)</span><span class="main">::</span> nat <span class="main">⇒</span> string <span class="main">⇒</span> string"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> id"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">{}</span>"</span></span>
  <span class="quoted"><span class="quoted">"closed <span class="main">::</span> <span class="main">(</span>string<span class="main">,</span> prop_funs<span class="main">)</span> pform <span class="main">⇒</span> bool"</span></span>
  <span class="quoted">subst</span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">{}</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> id"</span></span>
  <span class="quoted"><span class="quoted">"Var undefined"</span></span>
  <span class="quoted"><span class="quoted">"id"</span></span>
  <span class="quoted"><span class="quoted">"undefined"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">declare</span></span> One_nat_def <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1" id="Incredible_Propositional_Tasks-path_one_edge"><span class="command">lemma</span></span> path_one_edge<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"task1_1.path <span class="free">v1</span> <span class="free">v2</span> <span class="free">pth</span> <span class="main">⟷</span>
    <span class="main">(</span><span class="free">v1</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">v2</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="free">pth</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="main">0</span><span class="main">,</span>Reg A<span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">1</span><span class="main">,</span>plain_ant A<span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">∨</span>
    <span class="free">pth</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">v1</span> <span class="main">=</span> <span class="free">v2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">pth</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> task1_1.path_cons_simp'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> list<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">list</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> task1_1.path_cons_simp'<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Finally we can also show that there is a proof graph for this task.›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> Tasked_Proof_Graph
  <span class="quoted"><span class="quoted">"curry <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">f</span><span class="main">.</span> bij <span class="bound">f</span><span class="main">)</span><span class="main">::</span> nat <span class="main">⇒</span> string <span class="main">⇒</span> string"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> id"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">{}</span>"</span></span>
  <span class="quoted"><span class="quoted">"closed <span class="main">::</span> <span class="main">(</span>string<span class="main">,</span> prop_funs<span class="main">)</span> pform <span class="main">⇒</span> bool"</span></span>
  <span class="quoted">subst</span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">{}</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> id"</span></span>
  <span class="quoted"><span class="quoted">"Var undefined"</span></span>
  <span class="quoted">antecedent</span>
  <span class="quoted">consequent</span>
  <span class="quoted">prop_rules</span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span>A<span class="main">]</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span>A<span class="main">]</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">{|</span><span class="main">0</span><span class="main">::</span>nat<span class="main">,</span><span class="main">1</span><span class="main">|}</span>"</span></span>
  <span class="quoted"><span class="quoted">"undefined<span class="main">(</span><span class="main">0</span> <span class="main">:=</span> Assumption A<span class="main">,</span> <span class="main">1</span> <span class="main">:=</span> Conclusion A<span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="main">0</span><span class="main">,</span>Reg A<span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">1</span><span class="main">,</span>plain_ant A<span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="quoted"><span class="quoted">"id"</span></span>
  <span class="quoted"><span class="quoted">"undefined"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="operator">simp</span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="operator">clarsimp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="operator">clarsimp</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="operator">fastforce</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="operator">fastforce</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹<span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> task1_1.labelAtOut_def task1_1.labelAtIn_def›</span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="operator">clarsimp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="operator">clarsimp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Task 2.11›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This is a slightly more interesting task as it involves both our connectives: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">P</span></span> <span class="main"><span class="main">∧</span></span> <span class="free"><span class="free">Q</span></span> <span class="main"><span class="main">⟶</span></span> <span class="free"><span class="free">R</span></span> <span class="main"><span class="main">⟹</span></span> <span class="free"><span class="free">P</span></span> <span class="main"><span class="main">⟶</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">Q</span></span> <span class="main"><span class="main">⟶</span></span> <span class="free"><span class="free">R</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>string<span class="main">,</span>prop_funs<span class="main">)</span> pform"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">≡</span> Fun <span class="main">(</span>Const <span class="inner_quoted">''B''</span><span class="main">)</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">C</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>string<span class="main">,</span>prop_funs<span class="main">)</span> pform"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≡</span> Fun <span class="main">(</span>Const <span class="inner_quoted">''C''</span><span class="main">)</span> <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> task2_11<span class="main">:</span> Abstract_Task
  <span class="quoted"><span class="quoted">"curry <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">f</span><span class="main">.</span> bij <span class="bound">f</span><span class="main">)</span><span class="main">::</span> nat <span class="main">⇒</span> string <span class="main">⇒</span> string"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> id"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">{}</span>"</span></span>
  <span class="quoted"><span class="quoted">"closed <span class="main">::</span> <span class="main">(</span>string<span class="main">,</span> prop_funs<span class="main">)</span> pform <span class="main">⇒</span> bool"</span></span>
  <span class="quoted">subst</span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">{}</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> id"</span></span>
  <span class="quoted"><span class="quoted">"Var undefined"</span></span>
  <span class="quoted">antecedent</span>
  <span class="quoted">consequent</span>
  <span class="quoted">prop_rules</span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span>Fun imp <span class="main">[</span>Fun and <span class="main">[</span>A<span class="main">,</span>B<span class="main">]</span><span class="main">,</span>C<span class="main">]</span><span class="main">]</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span>Fun imp <span class="main">[</span>A<span class="main">,</span>Fun imp <span class="main">[</span>B<span class="main">,</span>C<span class="main">]</span><span class="main">]</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">n_andI</span> <span class="main">≡</span> task2_11.n_rules <span class="main">!!</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">n_andE1</span> <span class="main">≡</span> task2_11.n_rules <span class="main">!!</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">n_andE2</span> <span class="main">≡</span> task2_11.n_rules <span class="main">!!</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">n_impI</span> <span class="main">≡</span> task2_11.n_rules <span class="main">!!</span> <span class="numeral">3</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">n_impE</span> <span class="main">≡</span> task2_11.n_rules <span class="main">!!</span> <span class="numeral">4</span>"</span></span>

<span class="keyword1" id="Incredible_Propositional_Tasks-n_andI"><span class="command">lemma</span></span> n_andI <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"n_andI <span class="main">=</span> <span class="main">(</span>andI<span class="main">,</span> Fun and <span class="main">[</span>X<span class="main">,</span>Y<span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> task2_11.n_rules_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prop_rules_def<span class="main">)</span>
<span class="keyword1" id="Incredible_Propositional_Tasks-n_andE1"><span class="command">lemma</span></span> n_andE1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"n_andE1 <span class="main">=</span> <span class="main">(</span>andE<span class="main">,</span> X<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> task2_11.n_rules_def One_nat_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prop_rules_def<span class="main">)</span>
<span class="keyword1" id="Incredible_Propositional_Tasks-n_andE2"><span class="command">lemma</span></span> n_andE2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"n_andE2 <span class="main">=</span> <span class="main">(</span>andE<span class="main">,</span> Y<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> task2_11.n_rules_def numeral_2_eq_2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prop_rules_def<span class="main">)</span>
<span class="keyword1" id="Incredible_Propositional_Tasks-n_impI"><span class="command">lemma</span></span> n_impI <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"n_impI <span class="main">=</span> <span class="main">(</span>impI<span class="main">,</span> Fun imp <span class="main">[</span>X<span class="main">,</span>Y<span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> task2_11.n_rules_def numeral_3_eq_3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prop_rules_def<span class="main">)</span>
<span class="keyword1" id="Incredible_Propositional_Tasks-n_impE"><span class="command">lemma</span></span> n_impE <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"n_impE <span class="main">=</span> <span class="main">(</span>impE<span class="main">,</span> Y<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"n_impE <span class="main">=</span> task2_11.n_rules <span class="main">!!</span> Suc <span class="numeral">3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>impE<span class="main">,</span> Y<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> task2_11.n_rules_def numeral_3_eq_3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prop_rules_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Incredible_Propositional_Tasks-subst_Var_eq_id"><span class="command">lemma</span></span> subst_Var_eq_id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"subst Var <span class="main">=</span> id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">x</span></span></span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_idI<span class="main">)</span>

<span class="keyword1" id="Incredible_Propositional_Tasks-xy_update"><span class="command">lemma</span></span> xy_update<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> undefined<span class="main">(</span><span class="inner_quoted">''X''</span> <span class="main">:=</span> <span class="free">x</span><span class="main">,</span> <span class="inner_quoted">''Y''</span> <span class="main">:=</span> <span class="free">y</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">f</span> <span class="inner_quoted">''X''</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">=</span> <span class="free">f</span> <span class="inner_quoted">''Y''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1" id="Incredible_Propositional_Tasks-y_update"><span class="command">lemma</span></span> y_update<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> undefined<span class="main">(</span><span class="inner_quoted">''Y''</span><span class="main">:=</span><span class="free">y</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">=</span> <span class="free">f</span> <span class="inner_quoted">''Y''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">declare</span></span> snth.simps<span class="main">(</span>1<span class="main">)</span> <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹By interpreting <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Solved_Task</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> we show that there is a proof tree for the task.
  We get the existence of the proof graph for free by using the completeness theorem.›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> task2_11<span class="main">:</span> Solved_Task
  <span class="quoted"><span class="quoted">"curry <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">f</span><span class="main">.</span> bij <span class="bound">f</span><span class="main">)</span><span class="main">::</span> nat <span class="main">⇒</span> string <span class="main">⇒</span> string"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> id"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">{}</span>"</span></span>
  <span class="quoted"><span class="quoted">"closed <span class="main">::</span> <span class="main">(</span>string<span class="main">,</span> prop_funs<span class="main">)</span> pform <span class="main">⇒</span> bool"</span></span>
  <span class="quoted">subst</span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">{}</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> id"</span></span>
  <span class="quoted"><span class="quoted">"Var undefined"</span></span>
  <span class="quoted">antecedent</span>
  <span class="quoted">consequent</span>
  <span class="quoted">prop_rules</span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span>Fun imp <span class="main">[</span>Fun and <span class="main">[</span>A<span class="main">,</span>B<span class="main">]</span><span class="main">,</span>C<span class="main">]</span><span class="main">]</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span>Fun imp <span class="main">[</span>A<span class="main">,</span>Fun imp <span class="main">[</span>B<span class="main">,</span>C<span class="main">]</span><span class="main">]</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command">unfolding</span></span> task2_11.solved_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{|</span>Fun imp <span class="main">[</span>Fun and <span class="main">[</span>A<span class="main">,</span>B<span class="main">]</span><span class="main">,</span>C<span class="main">]</span><span class="main">|}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
<span class="comment1">― ‹The actual proof tree for this task.›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Node <span class="main">(</span><span class="main">{|</span>Fun imp <span class="main">[</span>Fun and <span class="main">[</span>A<span class="main">,</span> B<span class="main">]</span><span class="main">,</span> C<span class="main">]</span><span class="main">|}</span> <span class="main">⊢</span> Fun imp <span class="main">[</span>A<span class="main">,</span> Fun imp <span class="main">[</span>B<span class="main">,</span> C<span class="main">]</span><span class="main">]</span><span class="main">,</span>NatRule n_impI<span class="main">)</span>
  <span class="main">{|</span>Node <span class="main">(</span><span class="main">{|</span>Fun imp <span class="main">[</span>Fun and <span class="main">[</span>A<span class="main">,</span> B<span class="main">]</span><span class="main">,</span> C<span class="main">]</span><span class="main">,</span> A<span class="main">|}</span> <span class="main">⊢</span> Fun imp <span class="main">[</span>B<span class="main">,</span>C<span class="main">]</span><span class="main">,</span>NatRule n_impI<span class="main">)</span>
    <span class="main">{|</span>Node <span class="main">(</span><span class="main">{|</span>Fun imp <span class="main">[</span>Fun and <span class="main">[</span>A<span class="main">,</span> B<span class="main">]</span><span class="main">,</span> C<span class="main">]</span><span class="main">,</span> A<span class="main">,</span> B<span class="main">|}</span> <span class="main">⊢</span> C<span class="main">,</span>NatRule n_impE<span class="main">)</span>
      <span class="main">{|</span>Node <span class="main">(</span><span class="main">{|</span>Fun imp <span class="main">[</span>Fun and <span class="main">[</span>A<span class="main">,</span> B<span class="main">]</span><span class="main">,</span> C<span class="main">]</span><span class="main">,</span> A<span class="main">,</span> B<span class="main">|}</span> <span class="main">⊢</span> Fun imp <span class="main">[</span>Fun and <span class="main">[</span>A<span class="main">,</span>B<span class="main">]</span><span class="main">,</span> C<span class="main">]</span><span class="main">,</span>Axiom<span class="main">)</span> <span class="main">{||}</span><span class="main">,</span>
        Node <span class="main">(</span><span class="main">{|</span>Fun imp <span class="main">[</span>Fun and <span class="main">[</span>A<span class="main">,</span> B<span class="main">]</span><span class="main">,</span> C<span class="main">]</span><span class="main">,</span> A<span class="main">,</span> B<span class="main">|}</span> <span class="main">⊢</span> Fun and <span class="main">[</span>A<span class="main">,</span>B<span class="main">]</span><span class="main">,</span>NatRule n_andI<span class="main">)</span> 
          <span class="main">{|</span>Node <span class="main">(</span><span class="main">{|</span>Fun imp <span class="main">[</span>Fun and <span class="main">[</span>A<span class="main">,</span> B<span class="main">]</span><span class="main">,</span> C<span class="main">]</span><span class="main">,</span> A<span class="main">,</span> B<span class="main">|}</span> <span class="main">⊢</span> A<span class="main">,</span>Axiom<span class="main">)</span> <span class="main">{||}</span><span class="main">,</span>
            Node <span class="main">(</span><span class="main">{|</span>Fun imp <span class="main">[</span>Fun and <span class="main">[</span>A<span class="main">,</span> B<span class="main">]</span><span class="main">,</span> C<span class="main">]</span><span class="main">,</span> A<span class="main">,</span> B<span class="main">|}</span> <span class="main">⊢</span> B<span class="main">,</span>Axiom<span class="main">)</span> <span class="main">{||}</span>
          <span class="main">|}</span>
      <span class="main">|}</span>
    <span class="main">|}</span>
  <span class="main">|}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>

 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> task1_1.wf<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹<span class="operator">clarsimp</span><span class="keyword3">;</span> <span class="operator">metis</span> n_impI snth_smap snth_sset›</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> task1_1.eff_NatRuleI <span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> propositional.freshen_def<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">[</span></span>4<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> task2_11.natEff_InstI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="operator">simp</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="operator">simp</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> xy_update<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹<span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main">:</span> propositional.f_antecedent_def›</span><span class="main">)</span>

 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> task1_1.wf<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹<span class="operator">clarsimp</span><span class="keyword3">;</span> <span class="operator">metis</span> n_impI snth_smap snth_sset›</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> task1_1.eff_NatRuleI <span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> propositional.freshen_def<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">[</span></span>4<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> task2_11.natEff_InstI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="operator">simp</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="operator">simp</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> xy_update<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹<span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main">:</span> propositional.f_antecedent_def›</span><span class="main">)</span>

 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> task1_1.wf<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹<span class="operator">clarsimp</span><span class="keyword3">;</span> <span class="operator">metis</span> n_impE snth_smap snth_sset›</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> task1_1.eff_NatRuleI <span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> propositional.freshen_def<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"undefined<span class="main">(</span><span class="inner_quoted">''Y''</span><span class="main">:=</span>C<span class="main">,</span><span class="inner_quoted">''X''</span><span class="main">:=</span>Fun and <span class="main">[</span>A<span class="main">,</span>B<span class="main">]</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">[</span></span>4<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> task2_11.natEff_InstI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="operator">simp</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="operator">simp</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹<span class="operator">intro</span> conjI<span class="keyword3">;</span> <span class="operator">simp</span>›</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹<span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> propositional.f_antecedent_def›</span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> task1_1.wf <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> task1_1.eff.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>

 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> task1_1.wf<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹<span class="operator">clarsimp</span><span class="keyword3">;</span> <span class="operator">metis</span> n_andI snth_smap snth_sset›</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> task1_1.eff_NatRuleI <span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> propositional.freshen_def<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">[</span></span>4<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> task2_11.natEff_InstI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="operator">simp</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="operator">simp</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> xy_update<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹<span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> propositional.f_antecedent_def›</span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>

 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹<span class="operator">rule</span> task1_1.wf<span class="keyword3">;</span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main">:</span> task1_1.eff.intros<span class="main">(</span>1<span class="main">)</span>›</span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹<span class="operator">rule</span> task1_1.wf<span class="keyword3">;</span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main">:</span> task1_1.eff.intros<span class="main">(</span>1<span class="main">)</span>›</span><span class="main">)</span>
  
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tfinite.intros<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>


<span class="keyword1"><span class="command">interpretation</span></span> Tasked_Proof_Graph
  <span class="quoted"><span class="quoted">"curry <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">f</span><span class="main">.</span> bij <span class="bound">f</span><span class="main">)</span><span class="main">::</span> nat <span class="main">⇒</span> string <span class="main">⇒</span> string"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> id"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">{}</span>"</span></span>
  <span class="quoted"><span class="quoted">"closed <span class="main">::</span> <span class="main">(</span>string<span class="main">,</span> prop_funs<span class="main">)</span> pform <span class="main">⇒</span> bool"</span></span>
  <span class="quoted">subst</span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">{}</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> id"</span></span>
  <span class="quoted"><span class="quoted">"Var undefined"</span></span>
  <span class="quoted">antecedent</span>
  <span class="quoted">consequent</span>
  <span class="quoted">prop_rules</span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span>Fun imp <span class="main">[</span>Fun and <span class="main">[</span>A<span class="main">,</span>B<span class="main">]</span><span class="main">,</span>C<span class="main">]</span><span class="main">]</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span>Fun imp <span class="main">[</span>A<span class="main">,</span>Fun imp <span class="main">[</span>B<span class="main">,</span>C<span class="main">]</span><span class="main">]</span><span class="main">]</span>"</span></span>
  <span class="quoted">task2_11.vertices</span> 
  <span class="quoted">task2_11.nodeOf</span> 
  <span class="quoted">task2_11.edges</span>
  <span class="quoted">task2_11.vidx</span>
  <span class="quoted">task2_11.inst</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Predicate_Formulas">
<div class="head">
<h1>Theory Predicate_Formulas</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Predicate_Formulas
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Countable.html">HOL-Library.Countable</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Infinite_Set.html">HOL-Library.Infinite_Set</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Eisbach/Eisbach.html">HOL-Eisbach.Eisbach</a>"</span>
  <a href="Abstract_Formula.html">Abstract_Formula</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This theory contains an example instantiation of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Abstract_Formulas</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with an 
formula type with local constants. It is a rather ad-hoc type that may not be very useful to
work with, though.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> var <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> lconst <span class="main">=</span> <span class="quoted">nat</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
We support higher order variables, in order to express <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>∀x.?P x›</span></span></span></span>. But we stay first order,
i.e. the parameters of such a variables will only be instantiated with ground terms.
›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> form <span class="main">=</span>
    Var <span class="main">(</span><span class="free"><span class="entity">var</span></span><span class="main">:</span><span class="quoted">var</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">params</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"form list"</span></span><span class="main">)</span>
  <span class="main">|</span> LC <span class="main">(</span>var<span class="main">:</span><span class="quoted">lconst</span><span class="main">)</span>
  <span class="main">|</span> Op <span class="main">(</span><span class="free"><span class="entity">name</span></span><span class="main">:</span><span class="quoted">string</span><span class="main">)</span> <span class="main">(</span>params<span class="main">:</span> <span class="quoted"><span class="quoted">"form list"</span></span><span class="main">)</span>
  <span class="main">|</span> Quant <span class="main">(</span>name<span class="main">:</span><span class="quoted">string</span><span class="main">)</span> <span class="main">(</span>var<span class="main">:</span><span class="quoted">nat</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">body</span></span><span class="main">:</span> <span class="quoted">form</span><span class="main">)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> schema <span class="main">=</span> <span class="quoted"><span class="quoted">"var list <span class="main">×</span> form"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> subst <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">×</span> schema<span class="main">)</span> list"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"form <span class="main">⇒</span> var set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">fv</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> insert <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Union <span class="main">(</span><span class="free">fv</span> <span class="main">`</span> set <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
 <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fv</span> <span class="main">(</span>LC <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
 <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fv</span> <span class="main">(</span>Op <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> Union <span class="main">(</span><span class="free">fv</span> <span class="main">`</span> set <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>
 <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fv</span> <span class="main">(</span>Quant <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">fv</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fresh_for</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var set <span class="main">⇒</span> var"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fresh_for</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Predicate_Formulas-fresh_for_fresh"><span class="command">lemma</span></span> fresh_for_fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">V</span> <span class="main">⟹</span> fresh_for <span class="free">V</span> <span class="main">∉</span> <span class="free">V</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fresh_for_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> someI2_ex<span class="main">)</span>
   <span class="keyword1"><span class="command">using</span></span> infinite_nat_iff_unbounded_le
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Free variables›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fv_schema</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"schema <span class="main">⇒</span> var set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fv_schema</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">=</span> fv <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">-</span> set <span class="free"><span class="bound"><span class="entity">ps</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fv_subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"subst <span class="main">⇒</span> var set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fv_subst</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>fv_schema <span class="main">`</span> ran <span class="main">(</span>map_of <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fv_subst1</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fv_subst1</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>fv <span class="main">`</span> snd <span class="main">`</span> set <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Predicate_Formulas-fv_subst_Nil"><span class="command">lemma</span></span> fv_subst_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fv_subst1 <span class="main">[]</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fv_subst1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Local constants, separate from free variables.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"form <span class="main">⇒</span> lconst set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">lc</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> Union <span class="main">(</span><span class="free">lc</span> <span class="main">`</span> set <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>
 <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lc</span> <span class="main">(</span>LC <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">}</span>"</span></span>
 <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lc</span> <span class="main">(</span>Op <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> Union <span class="main">(</span><span class="free">lc</span> <span class="main">`</span> set <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>
 <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lc</span> <span class="main">(</span>Quant <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">lc</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lc_schema</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"schema <span class="main">⇒</span> lconst set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lc_schema</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">=</span> lc <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lc_subst1</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lc_subst1</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>lc <span class="main">`</span> snd <span class="main">`</span> set <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lc_subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"subst <span class="main">⇒</span> lconst set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lc_subst</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>lc_schema <span class="main">`</span> snd <span class="main">`</span> set <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">map_lc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lconst <span class="main">⇒</span> lconst<span class="main">)</span> <span class="main">⇒</span> form <span class="main">⇒</span> form"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">map_lc</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> Var <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>map <span class="main">(</span><span class="free">map_lc</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">map_lc</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>LC <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> LC <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">map_lc</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Op <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> Op <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>map <span class="main">(</span><span class="free">map_lc</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">map_lc</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Quant <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">f'</span></span></span><span class="main">)</span> <span class="main">=</span> Quant <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span><span class="free">map_lc</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">f'</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Predicate_Formulas-fv_map_lc"><span class="command">lemma</span></span> fv_map_lc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>map_lc <span class="free">p</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> fv <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Predicate_Formulas-lc_map_lc"><span class="command">lemma</span></span> lc_map_lc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span>map_lc <span class="free">p</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span> <span class="main">`</span> lc <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Predicate_Formulas-map_lc_map_lc"><span class="command">lemma</span></span> map_lc_map_lc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_lc <span class="free">p1</span> <span class="main">(</span>map_lc <span class="free">p2</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> map_lc <span class="main">(</span><span class="free">p1</span> <span class="main">∘</span> <span class="free">p2</span><span class="main">)</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">map_lc_subst1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lconst <span class="main">⇒</span> lconst<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>var <span class="main">×</span> form<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span>var <span class="main">×</span> form<span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">map_lc_subst1</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> map <span class="main">(</span>apsnd <span class="main">(</span>map_lc <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">map_lc_subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lconst <span class="main">⇒</span> lconst<span class="main">)</span> <span class="main">⇒</span> subst <span class="main">⇒</span> subst"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">map_lc_subst</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> map <span class="main">(</span>apsnd <span class="main">(</span>apsnd <span class="main">(</span>map_lc <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1" id="Predicate_Formulas-map_lc_noop"><span class="command">lemma</span></span> map_lc_noop<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lc <span class="free">f</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> map_lc <span class="free">p</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_idI<span class="main">)</span>

<span class="keyword1" id="Predicate_Formulas-map_lc_cong"><span class="command">lemma</span></span> map_lc_cong<span class="main">[</span><span class="operator">cong</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> lc <span class="free">f</span> <span class="main">⟹</span> <span class="free">f1</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f2</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> map_lc <span class="free">f1</span> <span class="free">f</span> <span class="main">=</span> map_lc <span class="free">f2</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fv_subst1 <span class="main">(</span>map <span class="main">(</span>apsnd <span class="main">(</span>map_lc <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> fv_subst1 <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fv_subst1_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Predicate_Formulas-map_lc_subst_cong"><span class="command">lemma</span></span> map_lc_subst_cong<span class="main">[</span><span class="operator">cong</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> lc_subst <span class="free">s</span> <span class="main">⟹</span> <span class="free">f1</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f2</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map_lc_subst <span class="free">f1</span> <span class="free">s</span> <span class="main">=</span> map_lc_subst <span class="free">f2</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_lc_cong assms<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In order to make the termination checker happy, we define substitution in two stages: One
that substitutes only ground terms for variables, and the real one that can substitute schematic
terms (or lambda expression, if you want).›</span></span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">subst1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>var <span class="main">×</span> form<span class="main">)</span> list <span class="main">⇒</span> form <span class="main">⇒</span> form"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">subst1</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> map_of <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">of</span> Some <span class="bound">f</span> <span class="main">⇒</span> <span class="bound">f</span> <span class="main">|</span> None <span class="main">⇒</span> Var <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst1</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> Var <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst1</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>LC <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> LC <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst1</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Op <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> Op <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>map <span class="main">(</span><span class="free">subst1</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst1</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Quant <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∈</span> fv_subst1 <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span>
      <span class="main">(</span><span class="keyword1">let</span> <span class="bound">v'</span> <span class="main">=</span> fresh_for <span class="main">(</span>fv_subst1 <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>
      <span class="keyword1">in</span> Quant <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">v'</span> <span class="main">(</span><span class="free">subst1</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span> Var <span class="bound">v'</span> <span class="main">[]</span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="keyword1">else</span> Quant <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span><span class="free">subst1</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Predicate_Formulas-subst1_Nil"><span class="command">lemma</span></span> subst1_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"subst1 <span class="main">[]</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span><span class="main">::</span><span class="main">(</span>var <span class="main">×</span> form<span class="main">)</span> list"</span></span> <span class="quoted"><span class="free">f</span></span>  <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>subst1.induct<span class="main">)</span> 
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_idI <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
 
<span class="keyword1" id="Predicate_Formulas-lc_subst1"><span class="command">lemma</span></span> lc_subst1<span class="main">:</span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span>subst1 <span class="free">s</span> <span class="free">f</span><span class="main">)</span> <span class="main">⊆</span> lc <span class="free">f</span> <span class="main">∪</span> <span class="main">⋃</span><span class="main">(</span>lc <span class="main">`</span> snd <span class="main">`</span> set <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subst1.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> map_of_SomeD <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1" id="Predicate_Formulas-apsnd_def'"><span class="command">lemma</span></span> apsnd_def'<span class="main">:</span> <span class="quoted"><span class="quoted">"apsnd <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="free">f</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Predicate_Formulas-map_of_map_apsnd"><span class="command">lemma</span></span> map_of_map_apsnd<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_of <span class="main">(</span>map <span class="main">(</span>apsnd <span class="free">f</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> map_option <span class="free">f</span> <span class="main">∘</span> map_of <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> apsnd_def' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> map_of_map<span class="main">)</span>

<span class="keyword1" id="Predicate_Formulas-map_lc_subst1"><span class="command">lemma</span></span> map_lc_subst1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_lc <span class="free">p</span> <span class="main">(</span>subst1 <span class="free">s</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> subst1 <span class="main">(</span>map_lc_subst1 <span class="free">p</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>map_lc <span class="free">p</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subst1.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_of_map_apsnd Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> subst1.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> subst1.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> subst1.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> subst1.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> subst1.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Let_def map_lc.simps<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> subst1.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span> 


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">subst'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"subst <span class="main">⇒</span> form <span class="main">⇒</span> form"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">subst'</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">case</span> map_of <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>map <span class="main">(</span><span class="free">subst'</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>
                 <span class="main">|</span> Some <span class="main">(</span><span class="bound">ps</span><span class="main">,</span><span class="bound">rhs</span><span class="main">)</span> <span class="main">⇒</span>
                     <span class="keyword1">if</span> length <span class="bound">ps</span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span>
                     <span class="keyword1">then</span> subst1 <span class="main">(</span>zip <span class="bound">ps</span> <span class="main">(</span>map <span class="main">(</span><span class="free">subst'</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">rhs</span>
                     <span class="keyword1">else</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>map <span class="main">(</span><span class="free">subst'</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst'</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>LC <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> LC <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst'</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Op <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> Op <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>map <span class="main">(</span><span class="free">subst'</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst'</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Quant <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∈</span> fv_subst <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span>
      <span class="main">(</span><span class="keyword1">let</span> <span class="bound">v'</span> <span class="main">=</span> fresh_for <span class="main">(</span>fv_subst <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>
       <span class="keyword1">in</span> Quant <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">v'</span> <span class="main">(</span><span class="free">subst'</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> Var <span class="bound">v'</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="keyword1">else</span> Quant <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span><span class="free">subst'</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Predicate_Formulas-subst'_Nil"><span class="command">lemma</span></span> subst'_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"subst' <span class="main">[]</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_idI fv_subst_def<span class="main">)</span>

<span class="keyword1" id="Predicate_Formulas-lc_subst'"><span class="command">lemma</span></span> lc_subst'<span class="main">:</span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span>subst' <span class="free">s</span> <span class="free">f</span><span class="main">)</span> <span class="main">⊆</span> lc <span class="free">f</span> <span class="main">∪</span> lc_subst <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subst'.induct<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> map_of_SomeD  <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lc_subst1<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_subst_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> set_zip_rightD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Predicate_Formulas-ran_map_option_comp"><span class="command">lemma</span></span> ran_map_option_comp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ran <span class="main">(</span>map_option <span class="free">f</span> <span class="main">∘</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">`</span> ran <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> comp_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ran_map_option<span class="main">)</span>

<span class="keyword1" id="Predicate_Formulas-fv_schema_apsnd_map_lc"><span class="command">lemma</span></span> fv_schema_apsnd_map_lc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fv_schema <span class="main">(</span>apsnd <span class="main">(</span>map_lc <span class="free">p</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> fv_schema <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Predicate_Formulas-fv_subst_map_apsnd_map_lc"><span class="command">lemma</span></span> fv_subst_map_apsnd_map_lc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fv_subst <span class="main">(</span>map <span class="main">(</span>apsnd <span class="main">(</span>apsnd <span class="main">(</span>map_lc <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> fv_subst <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> fv_subst_def 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_of_map_apsnd<span class="main">)</span>

<span class="keyword1" id="Predicate_Formulas-map_apsnd_zip"><span class="command">lemma</span></span> map_apsnd_zip<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>apsnd <span class="free">f</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> zip <span class="free">a</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apsnd_def' zip_map2<span class="main">)</span>

<span class="keyword1" id="Predicate_Formulas-map_lc_subst'"><span class="command">lemma</span></span> map_lc_subst'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_lc <span class="free">p</span> <span class="main">(</span>subst' <span class="free">s</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> subst' <span class="main">(</span>map_lc_subst <span class="free">p</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>map_lc <span class="free">p</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subst'.induct<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> map_of_SomeD <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_of_map_apsnd Let_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹(<span class="operator">subst</span> subst'.simps<span class="keyword3">,</span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main">:</span> option.splits)<span class="keyword3">[</span>1<span class="keyword3">]</span>›</span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹(<span class="operator">subst</span> subst'.simps<span class="keyword3">,</span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main">:</span> option.splits <span class="quasi_keyword">cong</span><span class="main">:</span> map_cong)<span class="keyword3">[</span>1<span class="keyword3">]</span>›</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹(<span class="operator">subst</span> subst'.simps<span class="keyword3">,</span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main">:</span> option.splits)<span class="keyword3">[</span>1<span class="keyword3">]</span>›</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹(<span class="operator">subst</span> subst'.simps<span class="keyword3">,</span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main">:</span> option.splits)<span class="keyword3">[</span>1<span class="keyword3">]</span>›</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹(<span class="operator">subst</span> subst'.simps<span class="keyword3">,</span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main">:</span> option.splits)<span class="keyword3">[</span>1<span class="keyword3">]</span>›</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹(<span class="operator">subst</span> subst'.simps<span class="keyword3">,</span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main">:</span> option.splits<span class="keyword3">,</span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main">:</span> Let_def map_lc.simps)<span class="keyword3">[</span>1<span class="keyword3">]</span>›</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹(<span class="operator">subst</span> subst'.simps<span class="keyword3">,</span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main">:</span> option.splits)<span class="keyword3">[</span>1<span class="keyword3">]</span>›</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Since subst' happily renames quantified variables, we have a simple wrapper that
ensures that the substitution is minimal, and is empty if <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f›</span></span></span></span> is closed. This is 
a hack to support lemma  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>subst_noop›</span></span></span></span>. ›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"subst <span class="main">⇒</span> form <span class="main">⇒</span> form"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> subst' <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> fv <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1" id="Predicate_Formulas-subst_Nil"><span class="command">lemma</span></span> subst_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"subst <span class="main">[]</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Predicate_Formulas-subst_noop"><span class="command">lemma</span></span> subst_noop<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="free">f</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> subst <span class="free">s</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Predicate_Formulas-lc_subst"><span class="command">lemma</span></span> lc_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span>subst <span class="free">s</span> <span class="free">f</span><span class="main">)</span> <span class="main">⊆</span> lc <span class="free">f</span> <span class="main">∪</span> lc_subst <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lc_subst'<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Predicate_Formulas-lc_subst_map_lc_subst"><span class="command">lemma</span></span> lc_subst_map_lc_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lc_subst <span class="main">(</span>map_lc_subst <span class="free">p</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span> <span class="main">`</span> lc_subst <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Predicate_Formulas-map_lc_subst"><span class="command">lemma</span></span> map_lc_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_lc <span class="free">p</span> <span class="main">(</span>subst <span class="free">s</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> subst <span class="main">(</span>map_lc_subst <span class="free">p</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>map_lc <span class="free">p</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst.simps
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_map <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> filter_cong<span class="main"><span class="main">]</span></span> <span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">closed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"form <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">closed</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟷</span> fv <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> lc <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> predicate<span class="main">:</span> Abstract_Formulas
  <span class="quoted"><span class="quoted">"curry to_nat <span class="main">::</span> nat <span class="main">⇒</span> var <span class="main">⇒</span> var"</span></span>
  <span class="quoted">map_lc</span>
  <span class="quoted">lc</span>
  <span class="quoted"><span class="quoted">"closed"</span></span>
  <span class="quoted">subst</span>
  <span class="quoted">lc_subst</span>
  <span class="quoted">map_lc_subst</span>
  <span class="quoted"><span class="quoted">"Var <span class="main">0</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="operator">fastforce</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="operator">fastforce</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="operator">fastforce</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="operator">fastforce</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="operator">fastforce</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹<span class="operator">rule</span> lc_subst›</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="operator">fastforce</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="operator">fastforce</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="operator">fastforce</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹<span class="operator">metis</span> map_lc_subst_cong›</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹<span class="operator">rule</span> lc_subst_map_lc_subst›</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹<span class="operator">rule</span> exI<span class="main">[</span><span class="operator">where</span> x <span class="main"><span class="main">=</span></span> <span class="quoted">"<span class="main">[]</span>"</span><span class="main">]</span><span class="keyword3">,</span> <span class="operator">simp</span>›</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹<span class="operator">rename_tac</span> f<span class="keyword3">,</span> <span class="operator">rule_tac</span> x <span class="main">=</span> <span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="improper">f</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span> <span class="quasi_keyword">in</span> exI<span class="keyword3">,</span> <span class="operator">simp</span>›</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">declare</span></span> predicate.subst_lconsts_empty_subst <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Incredible_Predicate">
<div class="head">
<h1>Theory Incredible_Predicate</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Incredible_Predicate <span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Abstract_Rules_To_Incredible.html">Abstract_Rules_To_Incredible</a>
  <a href="Predicate_Formulas.html">Predicate_Formulas</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Our example interpretation with predicate logic will cover implication and the
  universal quantifier.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The rules are introduction and elimination of implication and universal quantifiers.›</span></span>
<span class="keyword1"><span class="command">datatype</span></span> prop_rule <span class="main">=</span> allI <span class="main">|</span> allE <span class="main">|</span> impI <span class="main">|</span> impE

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">prop_rules</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"prop_rule stream"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">prop_rules</span> <span class="main">=</span> cycle <span class="main">[</span>allI<span class="main">,</span> allE<span class="main">,</span> impI<span class="main">,</span> impE<span class="main">]</span>"</span></span>

<span class="keyword1" id="Incredible_Predicate-iR_prop_rules"><span class="command">lemma</span></span> iR_prop_rules <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sset prop_rules <span class="main">=</span> <span class="main">{</span>allI<span class="main">,</span> allE<span class="main">,</span> impI<span class="main">,</span> impE<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> prop_rules_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Just some short notation.›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"form"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≡</span> Var <span class="numeral">10</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"form"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">≡</span> Var <span class="numeral">11</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"form"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≡</span> Var <span class="numeral">9</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"form"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≡</span> Var <span class="numeral">13</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"form <span class="main">⇒</span> form"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> Var <span class="numeral">12</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Q</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"form <span class="main">⇒</span> form"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> Op <span class="inner_quoted">''Q''</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">imp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"form <span class="main">⇒</span> form <span class="main">⇒</span> form"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">imp</span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="main">≡</span> Op <span class="inner_quoted">''imp''</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">f1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ForallX</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"form <span class="main">⇒</span> form"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ForallX</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> Quant <span class="inner_quoted">''all''</span> <span class="numeral">9</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Finally the right- and left-hand sides of the rules.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">consequent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"prop_rule <span class="main">⇒</span> form list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">consequent</span> allI <span class="main">=</span> <span class="main">[</span>ForallX <span class="main">(</span>P x<span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">consequent</span> allE <span class="main">=</span> <span class="main">[</span>P t<span class="main">]</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">consequent</span> impI <span class="main">=</span> <span class="main">[</span>imp X Y<span class="main">]</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">consequent</span> impE <span class="main">=</span> <span class="main">[</span>Y<span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">allI_input</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">allI_input</span> <span class="main">≡</span> Antecedent <span class="main">{||}</span> <span class="main">(</span>P <span class="main">(</span>LC <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">impI_input</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">impI_input</span> <span class="main">≡</span> Antecedent <span class="main">{|</span>X<span class="main">|}</span> Y <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">antecedent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"prop_rule <span class="main">⇒</span> <span class="main">(</span>form<span class="main">,</span> lconst<span class="main">)</span> antecedent list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">antecedent</span> allI <span class="main">=</span> <span class="main">[</span>allI_input<span class="main">]</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">antecedent</span> allE <span class="main">=</span> <span class="main">[</span>plain_ant <span class="main">(</span>ForallX <span class="main">(</span>P x<span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">antecedent</span> impI <span class="main">=</span> <span class="main">[</span>impI_input<span class="main">]</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">antecedent</span> impE <span class="main">=</span> <span class="main">[</span>plain_ant <span class="main">(</span>imp X Y<span class="main">)</span><span class="main">,</span> plain_ant X<span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> predicate<span class="main">:</span> Abstract_Rules
  <span class="quoted"><span class="quoted">"curry to_nat <span class="main">::</span> nat <span class="main">⇒</span> var <span class="main">⇒</span> var"</span></span>
  <span class="quoted">map_lc</span>
  <span class="quoted">lc</span>
  <span class="quoted"><span class="quoted">"closed"</span></span>
  <span class="quoted">subst</span>
  <span class="quoted">lc_subst</span>
  <span class="quoted">map_lc_subst</span>
  <span class="quoted"><span class="quoted">"Var <span class="main">0</span> <span class="main">[]</span>"</span></span>
  <span class="quoted">antecedent</span>
  <span class="quoted">consequent</span>
  <span class="quoted">prop_rules</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span><span class="main">∈</span>sset prop_rules<span class="main">.</span> consequent <span class="bound">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> prop_rules_def
    <span class="keyword1"><span class="command">using</span></span> consequent.elims <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span><span class="main">∈</span>sset prop_rules<span class="main">.</span> <span class="main">⋃</span><span class="main">(</span>lc <span class="main">`</span> set <span class="main">(</span>consequent <span class="bound">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i'</span> <span class="skolem">r</span> <span class="skolem">i</span> <span class="skolem">ia</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> sset prop_rules"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span> <span class="main">&lt;</span> length <span class="main">(</span>antecedent <span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> length <span class="main">(</span>antecedent <span class="skolem">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"a_fresh <span class="main">(</span>antecedent <span class="skolem">r</span> <span class="main">!</span> <span class="skolem">ia</span><span class="main">)</span> <span class="main">∩</span> a_fresh <span class="main">(</span>antecedent <span class="skolem">r</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="skolem">ia</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i'</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">p</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> sset prop_rules"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> set <span class="main">(</span>antecedent <span class="skolem">r</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"lc <span class="main">(</span>a_conc <span class="skolem">p</span><span class="main">)</span> <span class="main">∪</span> <span class="main">⋃</span><span class="main">(</span>lc <span class="main">`</span> fset <span class="main">(</span>a_hyps <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> a_fresh <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Incredible_Predicate_Tasks">
<div class="head">
<h1>Theory Incredible_Predicate_Tasks</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Incredible_Predicate_Tasks
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Incredible_Completeness.html">Incredible_Completeness</a>
  <a href="Incredible_Predicate.html">Incredible_Predicate</a>
  <span class="quoted">"<a href="../../HOL/HOL-Eisbach/Eisbach.html">HOL-Eisbach.Eisbach</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">declare</span></span> One_nat_def <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">context</span></span> ND_Rules_Inst <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1" id="Incredible_Predicate_Tasks-eff_NatRuleI"><span class="command">lemma</span></span> eff_NatRuleI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">nat_rule</span> <span class="free">rule</span> <span class="free">c</span> <span class="free">ants</span>
    <span class="main">⟹</span> <span class="free">entail</span> <span class="main">=</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="free">subst</span> <span class="free">s</span> <span class="main">(</span>freshen <span class="free">a</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span>
    <span class="main">⟹</span> <span class="free">hyps</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">ant</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="free">subst</span> <span class="free">s</span> <span class="main">(</span>freshen <span class="free">a</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">|`|</span> a_hyps <span class="bound">ant</span> <span class="main">|∪|</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">subst</span> <span class="free">s</span> <span class="main">(</span>freshen <span class="free">a</span> <span class="main">(</span>a_conc <span class="bound">ant</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|`|</span> <span class="free">ants</span><span class="main">)</span>
    <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">ant</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">ant</span> <span class="main">|∈|</span> <span class="free">ants</span> <span class="main">⟹</span> <span class="bound">f</span> <span class="main">|∈|</span> <span class="free">Γ</span> <span class="main">⟹</span> <span class="free">freshenLC</span> <span class="free">a</span> <span class="main">`</span> <span class="main">(</span>a_fresh <span class="bound">ant</span><span class="main">)</span> <span class="main">∩</span> <span class="free">lconsts</span> <span class="bound">f</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>
    <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">ant</span><span class="main">.</span> <span class="bound">ant</span> <span class="main">|∈|</span> <span class="free">ants</span> <span class="main">⟹</span> <span class="free">freshenLC</span> <span class="free">a</span> <span class="main">`</span> <span class="main">(</span>a_fresh <span class="bound">ant</span><span class="main">)</span> <span class="main">∩</span> <span class="free">subst_lconsts</span> <span class="free">s</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>
    <span class="main">⟹</span> eff <span class="main">(</span>NatRule <span class="free">rule</span><span class="main">)</span> <span class="free">entail</span> <span class="free">hyps</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> eff.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> Abstract_Task <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1" id="Incredible_Predicate_Tasks-natEff_InstI"><span class="command">lemma</span></span>  natEff_InstI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">rule</span> <span class="main">=</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">c</span><span class="main">)</span>
  <span class="main">⟹</span> <span class="free">c</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">consequent</span> <span class="free">r</span><span class="main">)</span>
  <span class="main">⟹</span> <span class="free">antec</span> <span class="main">=</span> f_antecedent <span class="free">r</span>
  <span class="main">⟹</span> natEff_Inst <span class="free">rule</span> <span class="free">c</span> <span class="free">antec</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> natEff_Inst.intros<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A typical task with local constants:: <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>∀x. Q x ⟶ Q x›</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹First the task is defined as an <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Abstract_Task</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> task<span class="main">:</span> Abstract_Task
  <span class="quoted"><span class="quoted">"curry to_nat <span class="main">::</span> nat <span class="main">⇒</span> var <span class="main">⇒</span> var"</span></span>
  <span class="quoted">map_lc</span>
  <span class="quoted">lc</span>
  <span class="quoted"><span class="quoted">"closed"</span></span>
  <span class="quoted">subst</span>
  <span class="quoted">lc_subst</span>
  <span class="quoted">map_lc_subst</span>
  <span class="quoted"><span class="quoted">"Var <span class="main">0</span> <span class="main">[]</span>"</span></span>
  <span class="quoted">antecedent</span>
  <span class="quoted">consequent</span>
  <span class="quoted">prop_rules</span>
  <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span>ForallX <span class="main">(</span>imp <span class="main">(</span>Q x<span class="main">)</span> <span class="main">(</span>Q x<span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Then we show, that this task has a proof within our formalization of natural deduction
  by giving a concrete proof tree.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">lx</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">lx</span> <span class="main">≡</span> to_nat <span class="main">(</span><span class="main">1</span><span class="main">::</span>nat<span class="main">,</span><span class="main">0</span><span class="main">::</span>nat<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">base_tree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>form fset <span class="main">×</span> form<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>prop_rule <span class="main">×</span> form<span class="main">)</span> NatRule<span class="main">)</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">base_tree</span> <span class="main">≡</span> Node <span class="main">(</span><span class="main">{|</span>Q <span class="main">(</span>LC lx<span class="main">)</span><span class="main">|}</span> <span class="main">⊢</span> Q <span class="main">(</span>LC lx<span class="main">)</span><span class="main">,</span> Axiom<span class="main">)</span> <span class="main">{||}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">imp_tree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>form fset <span class="main">×</span> form<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>prop_rule <span class="main">×</span> form<span class="main">)</span> NatRule<span class="main">)</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">imp_tree</span> <span class="main">≡</span> Node <span class="main">(</span><span class="main">{||}</span> <span class="main">⊢</span> imp <span class="main">(</span>Q <span class="main">(</span>LC lx<span class="main">)</span><span class="main">)</span> <span class="main">(</span>Q <span class="main">(</span>LC lx<span class="main">)</span><span class="main">)</span><span class="main">,</span> NatRule <span class="main">(</span>impI<span class="main">,</span> imp X Y<span class="main">)</span><span class="main">)</span> <span class="main">{|</span>base_tree<span class="main">|}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">solution_tree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>form fset <span class="main">×</span> form<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>prop_rule <span class="main">×</span> form<span class="main">)</span> NatRule<span class="main">)</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">solution_tree</span> <span class="main">≡</span> Node <span class="main">(</span><span class="main">{||}</span> <span class="main">⊢</span> ForallX <span class="main">(</span>imp <span class="main">(</span>Q x<span class="main">)</span> <span class="main">(</span>Q x<span class="main">)</span><span class="main">)</span><span class="main">,</span> NatRule <span class="main">(</span>allI<span class="main">,</span> ForallX <span class="main">(</span>P x<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{|</span>imp_tree<span class="main">|}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">s1</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">≡</span> <span class="main">[</span><span class="main">(</span><span class="numeral">12</span><span class="main">,</span> <span class="main">(</span><span class="main">[</span><span class="numeral">9</span><span class="main">]</span><span class="main">,</span> imp <span class="main">(</span>Q x<span class="main">)</span> <span class="main">(</span>Q x<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> "</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">s2</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">s2</span> <span class="main">≡</span> <span class="main">[</span><span class="main">(</span><span class="numeral">10</span><span class="main">,</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> Q <span class="main">(</span>LC lx<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="numeral">11</span><span class="main">,</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> Q <span class="main">(</span>LC lx<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> "</span></span>

<span class="keyword1" id="Incredible_Predicate_Tasks-fv_subst_s1"><span class="command">lemma</span></span> fv_subst_s1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fv_subst s1 <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_subst_def<span class="main">)</span>

<span class="keyword1" id="Incredible_Predicate_Tasks-subst1_simps"><span class="command">lemma</span></span> subst1_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"subst s1 <span class="main">(</span>P <span class="main">(</span>LC <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> imp <span class="main">(</span>Q <span class="main">(</span>LC <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Q <span class="main">(</span>LC <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"subst s1 <span class="main">(</span>ForallX <span class="main">(</span>P x<span class="main">)</span><span class="main">)</span> <span class="main">=</span> ForallX <span class="main">(</span>imp <span class="main">(</span>Q x<span class="main">)</span> <span class="main">(</span>Q x<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="Incredible_Predicate_Tasks-subst2_simps"><span class="command">lemma</span></span> subst2_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"subst s2 X <span class="main">=</span> Q <span class="main">(</span>LC lx<span class="main">)</span>"</span></span> 
    <span class="quoted"><span class="quoted">"subst s2 Y <span class="main">=</span> Q <span class="main">(</span>LC lx<span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"subst s2 <span class="main">(</span>imp X Y<span class="main">)</span> <span class="main">=</span> imp <span class="main">(</span>subst s2 X<span class="main">)</span> <span class="main">(</span>subst s2 Y<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="Incredible_Predicate_Tasks-substI1"><span class="command">lemma</span></span> substI1<span class="main">:</span> <span class="quoted"><span class="quoted">"ForallX <span class="main">(</span>imp <span class="main">(</span>Q x<span class="main">)</span> <span class="main">(</span>Q x<span class="main">)</span><span class="main">)</span> <span class="main">=</span> subst s1 <span class="main">(</span>predicate.freshen <span class="main">1</span> <span class="main">(</span>ForallX <span class="main">(</span>P x<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> predicate.freshen_def Let_def<span class="main">)</span>

<span class="keyword1" id="Incredible_Predicate_Tasks-substI2"><span class="command">lemma</span></span> substI2<span class="main">:</span> <span class="quoted"><span class="quoted">"imp <span class="main">(</span>Q <span class="main">(</span>LC lx<span class="main">)</span><span class="main">)</span> <span class="main">(</span>Q <span class="main">(</span>LC lx<span class="main">)</span><span class="main">)</span> <span class="main">=</span> subst s2 <span class="main">(</span>predicate.freshen <span class="numeral">2</span> <span class="main">(</span>imp X Y<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> predicate.freshen_def Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> subst.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"task.solved"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> task.solved_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{||}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"solution_tree"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>

 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> task.wf<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹(<span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> stream.set_map task.n_rules_def)<span class="keyword3">[</span>1<span class="keyword3">]</span>›</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> task.eff_NatRuleI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹<span class="operator">rule</span> task.natEff_Inst.intros<span class="keyword3">;</span><span class="operator">simp</span>›</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>     
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹<span class="operator">simp</span>›</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹<span class="operator">rule</span> substI1›</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> predicate.f_antecedent_def predicate.freshen_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> antecedent.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹<span class="operator">simp</span>›</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹<span class="operator">simp</span>›</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹<span class="operator">simp</span>›</span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>

 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> task.wf<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹(<span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> stream.set_map task.n_rules_def)<span class="keyword3">[</span>1<span class="keyword3">]</span>›</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> task.eff_NatRuleI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹<span class="operator">rule</span> task.natEff_Inst.intros<span class="keyword3">;</span> <span class="operator">simp</span>›</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>     
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹<span class="operator">simp</span>›</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹<span class="operator">rule</span> substI2›</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹<span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> predicate.f_antecedent_def predicate.freshen_def›</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹<span class="operator">simp</span>›</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹<span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> predicate.f_antecedent_def›</span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>

 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹(<span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main">:</span> task.wf <span class="quasi_keyword">intro</span><span class="main">!</span><span class="main">:</span> task.eff.intros<span class="main">(</span>1<span class="main">)</span>)<span class="keyword3">[</span>1<span class="keyword3">]</span>›</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">solves</span> <span class="quoted">‹(<span class="operator">rule</span> tfinite.intros<span class="keyword3">,</span> <span class="operator">simp</span>)<span class="keyword3">+</span>›</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">vertices</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">vertices</span> <span class="main">≡</span> <span class="main">{|</span><span class="main">0</span><span class="main">::</span>nat<span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span> <span class="main">|}</span>"</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nodeOf</span>  <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">nodeOf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">[</span>Conclusion <span class="main">(</span>ForallX <span class="main">(</span>imp <span class="main">(</span>Q x<span class="main">)</span> <span class="main">(</span>Q x<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> 
                 Rule allI<span class="main">,</span> 
                 Rule impI<span class="main">]</span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> "</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">inst</span>  <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">inst</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">[</span><span class="main">[]</span><span class="main">,</span>s1<span class="main">,</span>s2<span class="main">]</span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>


<span class="keyword1"><span class="command">interpretation</span></span> task<span class="main">:</span> Vertex_Graph <span class="quoted">task.nodes</span> <span class="quoted">task.inPorts</span> <span class="quoted">task.outPorts</span> <span class="quoted">vertices</span> <span class="quoted">nodeOf</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">e1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat<span class="main">,</span> form<span class="main">,</span> nat<span class="main">)</span> edge'"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">≡</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">,</span>Reg <span class="main">(</span>ForallX <span class="main">(</span>P x<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span>plain_ant <span class="main">(</span>ForallX <span class="main">(</span>imp <span class="main">(</span>Q x<span class="main">)</span> <span class="main">(</span>Q x<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">e2</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat<span class="main">,</span> form<span class="main">,</span> nat<span class="main">)</span> edge'"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">e2</span> <span class="main">≡</span> <span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">,</span>Reg <span class="main">(</span>imp X Y<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span>allI_input<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">e3</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat<span class="main">,</span> form<span class="main">,</span> nat<span class="main">)</span> edge'"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">e3</span> <span class="main">≡</span> <span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">,</span>Hyp X <span class="main">(</span>impI_input<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="numeral">2</span><span class="main">,</span>impI_input<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">task_edges</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat<span class="main">,</span> form<span class="main">,</span> nat<span class="main">)</span> edge' set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">task_edges</span> <span class="main">≡</span> <span class="main">{</span>e1<span class="main">,</span> e2<span class="main">,</span> e3<span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">interpretation</span></span> task<span class="main">:</span> Scoped_Graph <span class="quoted">task.nodes</span> <span class="quoted">task.inPorts</span> <span class="quoted">task.outPorts</span> <span class="quoted">vertices</span> <span class="quoted">nodeOf</span> <span class="quoted">task_edges</span> <span class="quoted">task.hyps</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> predicate.f_consequent_def predicate.f_antecedent_def<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> task<span class="main">:</span> Instantiation
  <span class="quoted">task.inPorts</span>
  <span class="quoted">task.outPorts</span>
  <span class="quoted">nodeOf</span>
  <span class="quoted">task.hyps</span>
  <span class="quoted">task.nodes</span>
  <span class="quoted">task_edges</span>
  <span class="quoted">vertices</span>
  <span class="quoted">task.labelsIn</span>
  <span class="quoted">task.labelsOut</span>
  <span class="quoted"><span class="quoted">"curry to_nat <span class="main">::</span> nat <span class="main">⇒</span> var <span class="main">⇒</span> var"</span></span>
  <span class="quoted">map_lc</span>
  <span class="quoted">lc</span>
  <span class="quoted"><span class="quoted">"closed"</span></span>
  <span class="quoted">subst</span>
  <span class="quoted">lc_subst</span>
  <span class="quoted">map_lc_subst</span>
  <span class="quoted"><span class="quoted">"Var <span class="main">0</span> <span class="main">[]</span>"</span></span>
  <span class="quoted"><span class="quoted">"id"</span></span>
  <span class="quoted"><span class="quoted">"inst"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Finally we can also show that there is a proof graph for this task.›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> Well_Scoped_Graph
  <span class="quoted">task.nodes</span>
  <span class="quoted">task.inPorts</span>
  <span class="quoted">task.outPorts</span>
  <span class="quoted">vertices</span>
  <span class="quoted">nodeOf</span>
  <span class="quoted">task_edges</span>
  <span class="quoted">task.hyps</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1" id="Incredible_Predicate_Tasks-no_path_01"><span class="command">lemma</span></span> no_path_01<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"task.path <span class="main">0</span> <span class="free">v</span> <span class="free">pth</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">pth</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">v</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">pth</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> task.path_cons_simp<span class="main">)</span>
<span class="keyword1" id="Incredible_Predicate_Tasks-no_path_12"><span class="command">lemma</span></span> no_path_12<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> task.path <span class="main">1</span> <span class="numeral">2</span> <span class="free">pth</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">pth</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> task.path_cons_simp<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> Acyclic_Graph
  <span class="quoted">task.nodes</span>
  <span class="quoted">task.inPorts</span>
  <span class="quoted">task.outPorts</span>
  <span class="quoted">vertices</span>
  <span class="quoted">nodeOf</span>
  <span class="quoted">task_edges</span>
  <span class="quoted">task.hyps</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">pth</span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"task.path <span class="skolem">v</span> <span class="skolem">v</span> <span class="skolem">pth</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"task.hyps_free <span class="skolem">pth</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pth</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">pth</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> task.path_cons_simp predicate.f_antecedent_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> Saturated_Graph
  <span class="quoted">task.nodes</span>
  <span class="quoted">task.inPorts</span>
  <span class="quoted">task.outPorts</span>
  <span class="quoted">vertices</span>
  <span class="quoted">nodeOf</span>
  <span class="quoted">task_edges</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> predicate.f_consequent_def predicate.f_antecedent_def<span class="main">)</span> 

<span class="keyword1"><span class="command">interpretation</span></span> Pruned_Port_Graph
  <span class="quoted">task.nodes</span>
  <span class="quoted">task.inPorts</span>
  <span class="quoted">task.outPorts</span>
  <span class="quoted">vertices</span>
  <span class="quoted">nodeOf</span>
  <span class="quoted">task_edges</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">|∈|</span> vertices"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">pth</span><span class="main">.</span> task.path <span class="skolem">v</span> <span class="main">0</span> <span class="bound">pth</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>e1<span class="main">]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> task.path_cons_simp<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>e2<span class="main">,</span>e1<span class="main">]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> task.path_cons_simp<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"task.terminal_vertex <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">pth</span> <span class="bound">v'</span><span class="main">.</span> task.path <span class="skolem">v</span> <span class="bound">v'</span> <span class="bound">pth</span> <span class="main">∧</span> task.terminal_vertex <span class="bound">v'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> Well_Shaped_Graph
  <span class="quoted">task.nodes</span>
  <span class="quoted">task.inPorts</span>
  <span class="quoted">task.outPorts</span>
  <span class="quoted">vertices</span>
  <span class="quoted">nodeOf</span> <span class="quoted">task_edges</span>
  <span class="quoted">task.hyps</span>
<span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> Solution
  <span class="quoted">task.inPorts</span>
  <span class="quoted">task.outPorts</span>
  <span class="quoted">nodeOf</span>
  <span class="quoted">task.hyps</span>
  <span class="quoted">task.nodes</span>
  <span class="quoted">vertices</span>
  <span class="quoted">task.labelsIn</span>
  <span class="quoted">task.labelsOut</span>
  <span class="quoted"><span class="quoted">"curry to_nat <span class="main">::</span> nat <span class="main">⇒</span> var <span class="main">⇒</span> var"</span></span>
  <span class="quoted">map_lc</span>
  <span class="quoted">lc</span>
  <span class="quoted"><span class="quoted">"closed"</span></span>
  <span class="quoted">subst</span>
  <span class="quoted">lc_subst</span>
  <span class="quoted">map_lc_subst</span>
  <span class="quoted"><span class="quoted">"Var <span class="main">0</span> <span class="main">[]</span>"</span></span>
  <span class="quoted">id</span>
  <span class="quoted">inst</span>
  <span class="quoted">task_edges</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> task.labelAtOut_def task.labelAtIn_def predicate.freshen_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> antecedent.sel<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> Proof_Graph
  <span class="quoted">task.nodes</span>
  <span class="quoted">task.inPorts</span>
  <span class="quoted">task.outPorts</span>
  <span class="quoted">vertices</span>
  <span class="quoted">nodeOf</span>
  <span class="quoted">task_edges</span>
  <span class="quoted">task.hyps</span>
  <span class="quoted">task.labelsIn</span>
  <span class="quoted">task.labelsOut</span>
  <span class="quoted"><span class="quoted">"curry to_nat <span class="main">::</span> nat <span class="main">⇒</span> var <span class="main">⇒</span> var"</span></span>
  <span class="quoted">map_lc</span>
  <span class="quoted">lc</span>
  <span class="quoted"><span class="quoted">"closed"</span></span>
  <span class="quoted">subst</span>
  <span class="quoted">lc_subst</span>
  <span class="quoted">map_lc_subst</span>
  <span class="quoted"><span class="quoted">"Var <span class="main">0</span> <span class="main">[]</span>"</span></span>
  <span class="quoted">id</span>
  <span class="quoted">inst</span>
<span class="keyword1"><span class="command">..</span></span>

<span class="keyword1" id="Incredible_Predicate_Tasks-path_20"><span class="command">lemma</span></span> path_20<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"task.path <span class="numeral">2</span> <span class="main">0</span> <span class="free">pth</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span><span class="main">,</span> allI_input<span class="main">)</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">pth</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"task.path <span class="skolem">v</span> <span class="main">0</span> <span class="free">pth</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">v</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span> allI_input<span class="main">)</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">pth</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">::</span>nat"</span></span> <span class="quoted"><span class="free">pth</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> task.path.induct<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Incredible_Predicate_Tasks-scope_21"><span class="command">lemma</span></span> scope_21<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">∈</span> task.scope <span class="main">(</span><span class="main">1</span><span class="main">,</span> allI_input<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> task.scope.intros <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> path_20 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> task.outPortsRule_def predicate.f_antecedent_def predicate.f_consequent_def<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> Scoped_Proof_Graph
  <span class="quoted"><span class="quoted">"curry to_nat <span class="main">::</span> nat <span class="main">⇒</span> var <span class="main">⇒</span> var"</span></span>
  <span class="quoted">map_lc</span>
  <span class="quoted">lc</span>
  <span class="quoted"><span class="quoted">"closed"</span></span>
  <span class="quoted">subst</span>
  <span class="quoted">lc_subst</span>
  <span class="quoted">map_lc_subst</span>
  <span class="quoted"><span class="quoted">"Var <span class="main">0</span> <span class="main">[]</span>"</span></span>
  <span class="quoted">task.inPorts</span>
  <span class="quoted">task.outPorts</span>
  <span class="quoted">nodeOf</span>
  <span class="quoted">task.hyps</span>
  <span class="quoted">task.nodes</span>
  <span class="quoted">vertices</span>
  <span class="quoted">task.labelsIn</span>
  <span class="quoted">task.labelsOut</span>
  <span class="quoted">id</span>
  <span class="quoted">inst</span>
  <span class="quoted">task_edges</span>
  <span class="quoted">task.local_vars</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> predicate.f_antecedent_def scope_21<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> Tasked_Proof_Graph
  <span class="quoted"><span class="quoted">"curry to_nat <span class="main">::</span> nat <span class="main">⇒</span> var <span class="main">⇒</span> var"</span></span>
  <span class="quoted">map_lc</span>
  <span class="quoted">lc</span>
  <span class="quoted"><span class="quoted">"closed"</span></span>
  <span class="quoted">subst</span>
  <span class="quoted">lc_subst</span>
  <span class="quoted">map_lc_subst</span>
  <span class="quoted"><span class="quoted">"Var <span class="main">0</span> <span class="main">[]</span>"</span></span>
  <span class="quoted">antecedent</span>
  <span class="quoted">consequent</span>
  <span class="quoted">prop_rules</span>
  <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span>ForallX <span class="main">(</span>imp <span class="main">(</span>Q x<span class="main">)</span> <span class="main">(</span>Q x<span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="quoted">vertices</span>
  <span class="quoted">nodeOf</span>
  <span class="quoted">task_edges</span>
  <span class="quoted">id</span>
  <span class="quoted">inst</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>