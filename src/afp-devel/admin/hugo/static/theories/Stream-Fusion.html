<div id="LazyList">
<div class="head">
<h1>Theory LazyList</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Lazy Lists›</span></span>

<span class="keyword1"><span class="command">theory</span></span> LazyList
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOLCF/HOLCF.html">HOLCF</a> <span class="quoted">"<a href="../../HOL/HOLCF-Library/Int_Discrete.html">HOLCF-Library.Int_Discrete</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">domain</span></span> <span class="tfree">'a</span> LList <span class="main">=</span> LNil <span class="main">|</span> LCons <span class="main">(</span><span class="keyword2"><span class="keyword">lazy</span></span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span><span class="main">)</span> <span class="main">(</span><span class="keyword2"><span class="keyword">lazy</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> LList"</span></span><span class="main">)</span>
 
<span class="keyword1"><span class="command">fixrec</span></span>
  <span class="entity">mapL</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">→</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">→</span> <span class="tfree">'a</span> LList <span class="main">→</span> <span class="tfree">'b</span> LList"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mapL</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span>LNil <span class="main">=</span> LNil"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mapL</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="main">(</span>LCons<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> LCons<span class="main">⋅</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="free">mapL</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="LazyList-mapL_strict"><span class="command">lemma</span></span> mapL_strict <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mapL<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">fixrec_simp</span>

<span class="keyword1"><span class="command">fixrec</span></span>
  <span class="entity">filterL</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">→</span> tr<span class="main">)</span> <span class="main">→</span> <span class="tfree">'a</span> LList <span class="main">→</span> <span class="tfree">'a</span> LList"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">filterL</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">⋅</span>LNil <span class="main">=</span> LNil"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">filterL</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">⋅</span><span class="main">(</span>LCons<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">If</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> LCons<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">⋅</span><span class="main">(</span><span class="free">filterL</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">filterL</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="LazyList-filterL_strict"><span class="command">lemma</span></span> filterL_strict <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"filterL<span class="main">⋅</span><span class="free">p</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">fixrec_simp</span>

<span class="keyword1"><span class="command">fixrec</span></span>
  <span class="entity">foldrL</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">→</span> <span class="tfree">'b</span> <span class="main">→</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">→</span> <span class="tfree">'b</span> <span class="main">→</span> <span class="tfree">'a</span> LList <span class="main">→</span> <span class="tfree">'b</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">foldrL</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">⋅</span>LNil <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">foldrL</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">⋅</span><span class="main">(</span>LCons<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">⋅</span><span class="main">(</span><span class="free">foldrL</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="LazyList-foldrL_strict"><span class="command">lemma</span></span> foldrL_strict <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"foldrL<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="free">z</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">fixrec_simp</span>

<span class="keyword1"><span class="command">fixrec</span></span>
  <span class="entity">enumFromToL</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int<span class="main"><span class="hidden">⇩</span><sub>⊥</sub></span> <span class="main">→</span> int<span class="main"><span class="hidden">⇩</span><sub>⊥</sub></span> <span class="main">→</span> <span class="main">(</span>int<span class="main"><span class="hidden">⇩</span><sub>⊥</sub></span><span class="main">)</span> LList"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">enumFromToL</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> LCons<span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="free">enumFromToL</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> LNil<span class="main">)</span>"</span></span>

<span class="keyword1" id="LazyList-enumFromToL_simps'"><span class="command">lemma</span></span> enumFromToL_simps' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span>
    enumFromToL<span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="free">x</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="free">y</span><span class="main">)</span> <span class="main">=</span> LCons<span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="free">x</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>enumFromToL<span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="main">(</span><span class="free">x</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> enumFromToL<span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="free">x</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="free">y</span><span class="main">)</span> <span class="main">=</span> LNil"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">declare</span></span> enumFromToL.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1" id="LazyList-enumFromToL_strict"><span class="command">lemma</span></span> enumFromToL_strict <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"enumFromToL<span class="main">⋅</span><span class="main">⊥</span><span class="main">⋅</span><span class="free">y</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="quoted"><span class="quoted">"enumFromToL<span class="main">⋅</span><span class="free">x</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> enumFromToL.unfold<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> enumFromToL.unfold<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">fixrec</span></span>
  <span class="entity">appendL</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> LList <span class="main">→</span> <span class="tfree">'a</span> LList <span class="main">→</span> <span class="tfree">'a</span> LList"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">appendL</span><span class="main">⋅</span>LNil<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">appendL</span><span class="main">⋅</span><span class="main">(</span>LCons<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> LCons<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">⋅</span><span class="main">(</span><span class="free">appendL</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="LazyList-appendL_strict"><span class="command">lemma</span></span> appendL_strict <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"appendL<span class="main">⋅</span><span class="main">⊥</span><span class="main">⋅</span><span class="free">ys</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">fixrec_simp</span>

<span class="keyword1" id="LazyList-appendL_LNil_right"><span class="command">lemma</span></span> appendL_LNil_right<span class="main">:</span> <span class="quoted"><span class="quoted">"appendL<span class="main">⋅</span><span class="free">xs</span><span class="main">⋅</span>LNil <span class="main">=</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">fixrec</span></span>
  <span class="entity">zipWithL</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">→</span> <span class="tfree">'b</span> <span class="main">→</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">→</span> <span class="tfree">'a</span> LList <span class="main">→</span> <span class="tfree">'b</span> LList <span class="main">→</span> <span class="tfree">'c</span> LList"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">zipWithL</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span>LNil<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> LNil"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">zipWithL</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="main">(</span>LCons<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">⋅</span>LNil <span class="main">=</span> LNil"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">zipWithL</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="main">(</span>LCons<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>LCons<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> LCons<span class="main">⋅</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="free">zipWithL</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="LazyList-zipWithL_strict"><span class="command">lemma</span></span> zipWithL_strict <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"zipWithL<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="main">⊥</span><span class="main">⋅</span><span class="free">ys</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="quoted"><span class="quoted">"zipWithL<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="main">(</span>LCons<span class="main">⋅</span><span class="free">x</span><span class="main">⋅</span><span class="free">xs</span><span class="main">)</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">fixrec_simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">fixrec</span></span>
  <span class="entity">concatMapL</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">→</span> <span class="tfree">'b</span> LList<span class="main">)</span> <span class="main">→</span> <span class="tfree">'a</span> LList <span class="main">→</span> <span class="tfree">'b</span> LList"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">concatMapL</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span>LNil <span class="main">=</span> LNil"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">concatMapL</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="main">(</span>LCons<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> appendL<span class="main">⋅</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="free">concatMapL</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="LazyList-concatMapL_strict"><span class="command">lemma</span></span> concatMapL_strict <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"concatMapL<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">fixrec_simp</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Stream">
<div class="head">
<h1>Theory Stream</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Stream Iterators›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Stream
<span class="keyword2"><span class="keyword">imports</span></span> <a href="LazyList.html">LazyList</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Type definitions for streams›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Note that everything is strict in the state type.›</span></span>

<span class="keyword1"><span class="command">domain</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'s</span><span class="main">)</span> Step <span class="main">=</span> Done <span class="main">|</span> Skip <span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span> <span class="main">|</span> Yield <span class="main">(</span><span class="keyword2"><span class="keyword">lazy</span></span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span><span class="main">)</span> <span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> Stepper <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> Step"</span></span>

<span class="keyword1"><span class="command">domain</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'s</span><span class="main">)</span> Stream <span class="main">=</span> Stream <span class="main">(</span><span class="keyword2"><span class="keyword">lazy</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> Stepper"</span></span><span class="main">)</span> <span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Converting from streams to lists›</span></span>

<span class="keyword1"><span class="command">fixrec</span></span>
  <span class="entity">unfold</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> Stepper <span class="main">-&gt;</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">-&gt;</span> <span class="tfree">'a</span> LList<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">unfold</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span>
    <span class="free">unfold</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
        Done <span class="main">⇒</span> LNil
      <span class="main">|</span> Skip<span class="main">⋅</span><span class="bound">s'</span> <span class="main">⇒</span> <span class="free">unfold</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">⋅</span><span class="bound">s'</span>
      <span class="main">|</span> Yield<span class="main">⋅</span><span class="bound">x</span><span class="main">⋅</span><span class="bound">s'</span> <span class="main">⇒</span> LCons<span class="main">⋅</span><span class="bound">x</span><span class="main">⋅</span><span class="main">(</span><span class="free">unfold</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">⋅</span><span class="bound">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fixrec</span></span>
  <span class="entity">unfoldF</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> Stepper <span class="main">→</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">→</span> <span class="tfree">'a</span> LList<span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">→</span> <span class="tfree">'a</span> LList<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">unfoldF</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span>
    <span class="free">unfoldF</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
        Done <span class="main">⇒</span> LNil
      <span class="main">|</span> Skip<span class="main">⋅</span><span class="bound">s'</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">⋅</span><span class="bound">s'</span>
      <span class="main">|</span> Yield<span class="main">⋅</span><span class="bound">x</span><span class="main">⋅</span><span class="bound">s'</span> <span class="main">⇒</span> LCons<span class="main">⋅</span><span class="bound">x</span><span class="main">⋅</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">⋅</span><span class="bound">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Stream-unfold_eq_fix"><span class="command">lemma</span></span> unfold_eq_fix<span class="main">:</span> <span class="quoted"><span class="quoted">"unfold<span class="main">⋅</span><span class="free">h</span> <span class="main">=</span> fix<span class="main">⋅</span><span class="main">(</span>unfoldF<span class="main">⋅</span><span class="free">h</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> below_antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"unfold<span class="main">⋅</span><span class="free">h</span> <span class="main">⊑</span> fix<span class="main">⋅</span><span class="main">(</span>unfoldF<span class="main">⋅</span><span class="free">h</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> unfold.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fix_eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_belowI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> s<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">s</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> monofun_cfun monofun_LAM below_refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fix<span class="main">⋅</span><span class="main">(</span>unfoldF<span class="main">⋅</span><span class="free">h</span><span class="main">)</span> <span class="main">⊑</span> unfold<span class="main">⋅</span><span class="free">h</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fix_ind<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> unfold.unfold<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_belowI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> s<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">s</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> monofun_cfun monofun_LAM below_refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Stream-unfold_ind"><span class="command">lemma</span></span> unfold_ind<span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">→</span> <span class="tfree">'a</span> LList<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"adm <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊥</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">u</span><span class="main">.</span> <span class="free">P</span> <span class="bound">u</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>unfoldF<span class="main">⋅</span><span class="free">h</span><span class="main">⋅</span><span class="bound">u</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>unfold<span class="main">⋅</span><span class="free">h</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> unfold_eq_fix <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fix_ind <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">fixrec</span></span>
  <span class="entity">unfold2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">→</span> <span class="tfree">'a</span> LList<span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> Step <span class="main">→</span> <span class="tfree">'a</span> LList"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">unfold2</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">⋅</span>Done <span class="main">=</span> LNil"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free">unfold2</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">⋅</span><span class="main">(</span>Skip<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free">unfold2</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">⋅</span><span class="main">(</span>Yield<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> LCons<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">⋅</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Stream-unfold2_strict"><span class="command">lemma</span></span> unfold2_strict <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"unfold2<span class="main">⋅</span><span class="free">u</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">fixrec_simp</span>

<span class="keyword1" id="Stream-unfold"><span class="command">lemma</span></span> unfold<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> unfold<span class="main">⋅</span><span class="free">h</span><span class="main">⋅</span><span class="free">s</span> <span class="main">=</span> unfold2<span class="main">⋅</span><span class="main">(</span>unfold<span class="main">⋅</span><span class="free">h</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="free">h</span><span class="main">⋅</span><span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">h</span><span class="main">⋅</span><span class="free">s</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="Stream-unfoldF"><span class="command">lemma</span></span> unfoldF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> unfoldF<span class="main">⋅</span><span class="free">h</span><span class="main">⋅</span><span class="free">u</span><span class="main">⋅</span><span class="free">s</span> <span class="main">=</span> unfold2<span class="main">⋅</span><span class="free">u</span><span class="main">⋅</span><span class="main">(</span><span class="free">h</span><span class="main">⋅</span><span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">h</span><span class="main">⋅</span><span class="free">s</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> unfold.simps<span class="main">(</span>2<span class="main">)</span> <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> unfoldF.simps<span class="main">(</span>2<span class="main">)</span> <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> unfoldF <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">fixrec</span></span>
  <span class="entity">unstream</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> Stream <span class="main">→</span> <span class="tfree">'a</span> LList"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free">unstream</span><span class="main">⋅</span><span class="main">(</span>Stream<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> unfold<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1" id="Stream-unstream_strict"><span class="command">lemma</span></span> unstream_strict <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"unstream<span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">fixrec_simp</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Converting from lists to streams›</span></span>

<span class="keyword1"><span class="command">fixrec</span></span>
  <span class="entity">streamStep</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> LList<span class="main">)</span><span class="main"><span class="hidden">⇩</span><sub>⊥</sub></span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'a</span> LList<span class="main">)</span><span class="main"><span class="hidden">⇩</span><sub>⊥</sub></span><span class="main">)</span> Step"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">streamStep</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span>LNil<span class="main">)</span> <span class="main">=</span> Done"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">streamStep</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="main">(</span>LCons<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Yield<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Stream-streamStep_strict"><span class="command">lemma</span></span> streamStep_strict <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"streamStep<span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="main">⊥</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">fixrec_simp</span>

<span class="keyword1"><span class="command">fixrec</span></span>
  <span class="entity">stream</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> LList <span class="main">→</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'a</span> LList<span class="main">)</span><span class="main"><span class="hidden">⇩</span><sub>⊥</sub></span><span class="main">)</span> Stream"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">stream</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> Stream<span class="main">⋅</span>streamStep<span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Stream-stream_defined"><span class="command">lemma</span></span> stream_defined <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"stream<span class="main">⋅</span><span class="free">xs</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Stream-unstream_stream"><span class="command">lemma</span></span> unstream_stream <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> LList"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"unstream<span class="main">⋅</span><span class="main">(</span>stream<span class="main">⋅</span><span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unfold<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> stream.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Bisimilarity relation on streams›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">bisimilar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> Stream <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> Stream <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≈</span>"</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free">≈</span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟷</span> unstream<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> unstream<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span>

<span class="keyword1" id="Stream-unstream_cong"><span class="command">lemma</span></span> unstream_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≈</span> <span class="free">b</span> <span class="main">⟹</span> unstream<span class="main">⋅</span><span class="free">a</span> <span class="main">=</span> unstream<span class="main">⋅</span><span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bisimilar_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Stream-stream_cong"><span class="command">lemma</span></span> stream_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">⟹</span> stream<span class="main">⋅</span><span class="free">xs</span> <span class="main">≈</span> stream<span class="main">⋅</span><span class="free">ys</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bisimilar_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Stream-stream_unstream_cong"><span class="command">lemma</span></span> stream_unstream_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≈</span> <span class="free">b</span> <span class="main">⟹</span> stream<span class="main">⋅</span><span class="main">(</span>unstream<span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="main">≈</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bisimilar_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="StreamFusion">
<div class="head">
<h1>Theory StreamFusion</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Stream Fusion›</span></span>

<span class="keyword1"><span class="command">theory</span></span> StreamFusion
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Stream.html">Stream</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Type constructors for state types›</span></span>

<span class="keyword1"><span class="command">domain</span></span> Switch <span class="main">=</span> S1 <span class="main">|</span> S2

<span class="keyword1"><span class="command">domain</span></span> <span class="tfree">'a</span> Maybe <span class="main">=</span> Nothing <span class="main">|</span> Just <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> Left Right

<span class="keyword1"><span class="command">domain</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> Either <span class="main">=</span> Left <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="main">|</span> Right <span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span>

<span class="keyword1"><span class="command">domain</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> Both  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1">:!:</span></span></span>"</span> 25<span class="main">)</span> <span class="main">=</span> Both <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">:!:</span>"</span> 75<span class="main">)</span>

<span class="keyword1"><span class="command">domain</span></span> <span class="tfree">'a</span> L <span class="main">=</span> L <span class="main">(</span><span class="keyword2"><span class="keyword">lazy</span></span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Map function›</span></span>

<span class="keyword1"><span class="command">fixrec</span></span>
  <span class="entity">mapStep</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">→</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> Step<span class="main">)</span> <span class="main">→</span> <span class="tfree">'s</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> Step"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mapStep</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free">mapStep</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
    Done <span class="main">⇒</span> Done
  <span class="main">|</span> Skip<span class="main">⋅</span><span class="bound">s'</span> <span class="main">⇒</span> Skip<span class="main">⋅</span><span class="bound">s'</span>
  <span class="main">|</span> Yield<span class="main">⋅</span><span class="bound">x</span><span class="main">⋅</span><span class="bound">s'</span> <span class="main">⇒</span> Yield<span class="main">⋅</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="bound">x</span><span class="main">)</span><span class="main">⋅</span><span class="bound">s'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fixrec</span></span>
  <span class="entity">mapS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">→</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> Stream <span class="main">→</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> Stream"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free">mapS</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="main">(</span>Stream<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Stream<span class="main">⋅</span><span class="main">(</span>mapStep<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1" id="StreamFusion-unfold_mapStep"><span class="command">lemma</span></span> unfold_mapStep<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">→</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> Step"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"unfold<span class="main">⋅</span><span class="main">(</span>mapStep<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="free">h</span><span class="main">)</span><span class="main">⋅</span><span class="free">s</span> <span class="main">=</span> mapL<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="main">(</span>unfold<span class="main">⋅</span><span class="free">h</span><span class="main">⋅</span><span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> below_antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"unfold<span class="main">⋅</span><span class="main">(</span>mapStep<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="free">h</span><span class="main">)</span><span class="main">⋅</span><span class="free">s</span> <span class="main">⊑</span> mapL<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="main">(</span>unfold<span class="main">⋅</span><span class="free">h</span><span class="main">⋅</span><span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">≠</span> <span class="main">⊥</span>›</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unfold_ind <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"mapStep<span class="main"><span class="main">⋅</span></span><span class="free"><span class="free">f</span></span><span class="main"><span class="main">⋅</span></span><span class="free"><span class="free">h</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">h</span><span class="main">⋅</span><span class="improper">s</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unfold<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mapL<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="main">(</span>unfold<span class="main">⋅</span><span class="free">h</span><span class="main">⋅</span><span class="free">s</span><span class="main">)</span> <span class="main">⊑</span> unfold<span class="main">⋅</span><span class="main">(</span>mapStep<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="free">h</span><span class="main">)</span><span class="main">⋅</span><span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">≠</span> <span class="main">⊥</span>›</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unfold_ind <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">h</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">h</span><span class="main">⋅</span><span class="improper">s</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unfold<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="StreamFusion-unstream_mapS"><span class="command">lemma</span></span> unstream_mapS<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">→</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> Stream"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> unstream<span class="main">⋅</span><span class="main">(</span>mapS<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="main">=</span> mapL<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="main">(</span>unstream<span class="main">⋅</span><span class="free">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unfold_mapStep<span class="main">)</span>

<span class="keyword1" id="StreamFusion-mapS_defined"><span class="command">lemma</span></span> mapS_defined<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> mapS<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="free">a</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="StreamFusion-mapS_cong"><span class="command">lemma</span></span> mapS_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">→</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> Stream"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">b</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> Stream"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">g</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">≈</span> <span class="free">b</span> <span class="main">⟹</span> mapS<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="free">a</span> <span class="main">≈</span> mapS<span class="main">⋅</span><span class="free">g</span><span class="main">⋅</span><span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> bisimilar_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unstream_mapS mapS_defined<span class="main">)</span>

<span class="keyword1" id="StreamFusion-mapL_eq"><span class="command">lemma</span></span> mapL_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"mapL<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="free">xs</span> <span class="main">=</span> unstream<span class="main">⋅</span><span class="main">(</span>mapS<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="main">(</span>stream<span class="main">⋅</span><span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unstream_mapS<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Filter function›</span></span>

<span class="keyword1"><span class="command">fixrec</span></span>
  <span class="entity">filterStep</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">→</span> tr<span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> Step<span class="main">)</span> <span class="main">→</span> <span class="tfree">'s</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> Step"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">filterStep</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free">filterStep</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
    Done <span class="main">⇒</span> Done
  <span class="main">|</span> Skip<span class="main">⋅</span><span class="bound">s'</span> <span class="main">⇒</span> Skip<span class="main">⋅</span><span class="bound">s'</span>
  <span class="main">|</span> Yield<span class="main">⋅</span><span class="bound">x</span><span class="main">⋅</span><span class="bound">s'</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">If</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">⋅</span><span class="bound">x</span> <span class="keyword1">then</span> Yield<span class="main">⋅</span><span class="bound">x</span><span class="main">⋅</span><span class="bound">s'</span> <span class="keyword1">else</span> Skip<span class="main">⋅</span><span class="bound">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fixrec</span></span>
  <span class="entity">filterS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">→</span> tr<span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> Stream <span class="main">→</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> Stream"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free">filterS</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">⋅</span><span class="main">(</span>Stream<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Stream<span class="main">⋅</span><span class="main">(</span>filterStep<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1" id="StreamFusion-unfold_filterStep"><span class="command">lemma</span></span> unfold_filterStep<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">→</span> tr"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> Step"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"unfold<span class="main">⋅</span><span class="main">(</span>filterStep<span class="main">⋅</span><span class="free">p</span><span class="main">⋅</span><span class="free">h</span><span class="main">)</span><span class="main">⋅</span><span class="free">s</span> <span class="main">=</span> filterL<span class="main">⋅</span><span class="free">p</span><span class="main">⋅</span><span class="main">(</span>unfold<span class="main">⋅</span><span class="free">h</span><span class="main">⋅</span><span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> below_antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"unfold<span class="main">⋅</span><span class="main">(</span>filterStep<span class="main">⋅</span><span class="free">p</span><span class="main">⋅</span><span class="free">h</span><span class="main">)</span><span class="main">⋅</span><span class="free">s</span> <span class="main">⊑</span> filterL<span class="main">⋅</span><span class="free">p</span><span class="main">⋅</span><span class="main">(</span>unfold<span class="main">⋅</span><span class="free">h</span><span class="main">⋅</span><span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">≠</span> <span class="main">⊥</span>›</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unfold_ind <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"filterStep<span class="main"><span class="main">⋅</span></span><span class="free"><span class="free">p</span></span><span class="main"><span class="main">⋅</span></span><span class="free"><span class="free">h</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">h</span><span class="main">⋅</span><span class="improper">s</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unfold<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">⋅</span><span class="improper">a</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"filterL<span class="main">⋅</span><span class="free">p</span><span class="main">⋅</span><span class="main">(</span>unfold<span class="main">⋅</span><span class="free">h</span><span class="main">⋅</span><span class="free">s</span><span class="main">)</span> <span class="main">⊑</span> unfold<span class="main">⋅</span><span class="main">(</span>filterStep<span class="main">⋅</span><span class="free">p</span><span class="main">⋅</span><span class="free">h</span><span class="main">)</span><span class="main">⋅</span><span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">≠</span> <span class="main">⊥</span>›</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unfold_ind <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">h</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">h</span><span class="main">⋅</span><span class="improper">s</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unfold<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">⋅</span><span class="improper">a</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unfold<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="StreamFusion-unstream_filterS"><span class="command">lemma</span></span> unstream_filterS<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> unstream<span class="main">⋅</span><span class="main">(</span>filterS<span class="main">⋅</span><span class="free">p</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="main">=</span> filterL<span class="main">⋅</span><span class="free">p</span><span class="main">⋅</span><span class="main">(</span>unstream<span class="main">⋅</span><span class="free">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unfold_filterStep<span class="main">)</span>

<span class="keyword1" id="StreamFusion-filterS_defined"><span class="command">lemma</span></span> filterS_defined<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> filterS<span class="main">⋅</span><span class="free">p</span><span class="main">⋅</span><span class="free">a</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="StreamFusion-filterS_cong"><span class="command">lemma</span></span> filterS_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">→</span> tr"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> Stream"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">b</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> Stream"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="free">q</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">≈</span> <span class="free">b</span> <span class="main">⟹</span> filterS<span class="main">⋅</span><span class="free">p</span><span class="main">⋅</span><span class="free">a</span> <span class="main">≈</span> filterS<span class="main">⋅</span><span class="free">q</span><span class="main">⋅</span><span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> bisimilar_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unstream_filterS filterS_defined<span class="main">)</span>

<span class="keyword1" id="StreamFusion-filterL_eq"><span class="command">lemma</span></span> filterL_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"filterL<span class="main">⋅</span><span class="free">p</span><span class="main">⋅</span><span class="free">xs</span> <span class="main">=</span> unstream<span class="main">⋅</span><span class="main">(</span>filterS<span class="main">⋅</span><span class="free">p</span><span class="main">⋅</span><span class="main">(</span>stream<span class="main">⋅</span><span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unstream_filterS<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Foldr function›</span></span>

<span class="keyword1"><span class="command">fixrec</span></span>
  <span class="entity">foldrS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">→</span> <span class="tfree">'b</span> <span class="main">→</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">→</span> <span class="tfree">'b</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> Stream <span class="main">→</span> <span class="tfree">'b</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  foldrS_Stream<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free">foldrS</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">⋅</span><span class="main">(</span>Stream<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span> Done <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span>
               <span class="main">|</span> Skip<span class="main">⋅</span><span class="bound">s'</span> <span class="main">⇒</span> <span class="free">foldrS</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">⋅</span><span class="main">(</span>Stream<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">⋅</span><span class="bound">s'</span><span class="main">)</span>
               <span class="main">|</span> Yield<span class="main">⋅</span><span class="bound">x</span><span class="main">⋅</span><span class="bound">s'</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="bound">x</span><span class="main">⋅</span><span class="main">(</span><span class="free">foldrS</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">⋅</span><span class="main">(</span>Stream<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">⋅</span><span class="bound">s'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="StreamFusion-unfold_foldrS"><span class="command">lemma</span></span> unfold_foldrS<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"foldrS<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="free">z</span><span class="main">⋅</span><span class="main">(</span>Stream<span class="main">⋅</span><span class="free">h</span><span class="main">⋅</span><span class="free">s</span><span class="main">)</span> <span class="main">=</span> foldrL<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="free">z</span><span class="main">⋅</span><span class="main">(</span>unfold<span class="main">⋅</span><span class="free">h</span><span class="main">⋅</span><span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> below_antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"foldrS<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="free">z</span><span class="main">⋅</span><span class="main">(</span>Stream<span class="main">⋅</span><span class="free">h</span><span class="main">⋅</span><span class="free">s</span><span class="main">)</span> <span class="main">⊑</span> foldrL<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="free">z</span><span class="main">⋅</span><span class="main">(</span>unfold<span class="main">⋅</span><span class="free">h</span><span class="main">⋅</span><span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">≠</span> <span class="main">⊥</span>›</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> foldrS.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">h</span><span class="main">⋅</span><span class="improper">s</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monofun_cfun unfold<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"foldrL<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="free">z</span><span class="main">⋅</span><span class="main">(</span>unfold<span class="main">⋅</span><span class="free">h</span><span class="main">⋅</span><span class="free">s</span><span class="main">)</span> <span class="main">⊑</span> foldrS<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="free">z</span><span class="main">⋅</span><span class="main">(</span>Stream<span class="main">⋅</span><span class="free">h</span><span class="main">⋅</span><span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">≠</span> <span class="main">⊥</span>›</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unfold_ind<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">h</span><span class="main">⋅</span><span class="improper">s</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monofun_cfun unfold<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="StreamFusion-unstream_foldrS"><span class="command">lemma</span></span> unstream_foldrS<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> foldrS<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="free">z</span><span class="main">⋅</span><span class="free">a</span> <span class="main">=</span> foldrL<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="free">z</span><span class="main">⋅</span><span class="main">(</span>unstream<span class="main">⋅</span><span class="free">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> foldrS_Stream <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unfold_foldrS<span class="main">)</span>

<span class="keyword1" id="StreamFusion-foldrS_cong"><span class="command">lemma</span></span> foldrS_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> Stream"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">b</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> Stream"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">g</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">=</span> <span class="free">w</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">≈</span> <span class="free">b</span> <span class="main">⟹</span> foldrS<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="free">z</span><span class="main">⋅</span><span class="free">a</span> <span class="main">=</span> foldrS<span class="main">⋅</span><span class="free">g</span><span class="main">⋅</span><span class="free">w</span><span class="main">⋅</span><span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bisimilar_def unstream_foldrS<span class="main">)</span>

<span class="keyword1" id="StreamFusion-foldrL_eq"><span class="command">lemma</span></span> foldrL_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"foldrL<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="free">z</span><span class="main">⋅</span><span class="free">xs</span> <span class="main">=</span> foldrS<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="free">z</span><span class="main">⋅</span><span class="main">(</span>stream<span class="main">⋅</span><span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unstream_foldrS<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹EnumFromTo function›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> int' <span class="main">=</span> <span class="quoted"><span class="quoted">"int<span class="main"><span class="hidden">⇩</span><sub>⊥</sub></span>"</span></span>

<span class="keyword1"><span class="command">fixrec</span></span>
  <span class="entity">enumFromToStep</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int' <span class="main">→</span> <span class="main">(</span>int'<span class="main">)</span><span class="main"><span class="hidden">⇩</span><sub>⊥</sub></span> <span class="main">→</span> <span class="main">(</span>int'<span class="main">,</span> <span class="main">(</span>int'<span class="main">)</span><span class="main"><span class="hidden">⇩</span><sub>⊥</sub></span><span class="main">)</span> Step"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">enumFromToStep</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> Yield<span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> Done<span class="main">)</span>"</span></span>

<span class="keyword1" id="StreamFusion-enumFromToStep_strict"><span class="command">lemma</span></span> enumFromToStep_strict <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"enumFromToStep<span class="main">⋅</span><span class="main">⊥</span><span class="main">⋅</span><span class="free">x''</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="quoted"><span class="quoted">"enumFromToStep<span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="free">y</span><span class="main">)</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="quoted"><span class="quoted">"enumFromToStep<span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="free">y</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="main">⊥</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">fixrec_simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="StreamFusion-enumFromToStep_simps'"><span class="command">lemma</span></span> enumFromToStep_simps' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> enumFromToStep<span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="free">y</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    Yield<span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="free">x</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="main">(</span><span class="free">x</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> enumFromToStep<span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="free">y</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Done"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">declare</span></span> enumFromToStep.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">fixrec</span></span>
  <span class="entity">enumFromToS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int' <span class="main">→</span> int' <span class="main">→</span> <span class="main">(</span>int'<span class="main">,</span> <span class="main">(</span>int'<span class="main">)</span><span class="main"><span class="hidden">⇩</span><sub>⊥</sub></span><span class="main">)</span> Stream"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">enumFromToS</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> Stream<span class="main">⋅</span><span class="main">(</span>enumFromToStep<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> enumFromToS.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1" id="StreamFusion-unfold_enumFromToStep"><span class="command">lemma</span></span> unfold_enumFromToStep<span class="main">:</span>
  <span class="quoted"><span class="quoted">"unfold<span class="main">⋅</span><span class="main">(</span>enumFromToStep<span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> enumFromToL<span class="main">⋅</span><span class="free">n</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> below_antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"unfold<span class="main">⋅</span><span class="main">(</span>enumFromToStep<span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="free">n</span><span class="main">)</span> <span class="main">⊑</span> enumFromToL<span class="main">⋅</span><span class="free">n</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unfold_ind <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"enumFromToStep<span class="main"><span class="main">⋅</span></span><span class="main"><span class="main">(</span></span>up<span class="main"><span class="main">⋅</span></span><span class="free"><span class="free">y</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">x</span> <span class="main">≤</span> <span class="free">y</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"enumFromToL<span class="main">⋅</span><span class="free">n</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="free">y</span><span class="main">)</span> <span class="main">⊑</span> unfold<span class="main">⋅</span><span class="main">(</span>enumFromToStep<span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>up<span class="main">⋅</span><span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> enumFromToL.induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> e n<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">x</span> <span class="main">≤</span> <span class="free">y</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unfold<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="StreamFusion-unstream_enumFromToS"><span class="command">lemma</span></span> unstream_enumFromToS<span class="main">:</span>
  <span class="quoted"><span class="quoted">"unstream<span class="main">⋅</span><span class="main">(</span>enumFromToS<span class="main">⋅</span><span class="free">x</span><span class="main">⋅</span><span class="free">y</span><span class="main">)</span> <span class="main">=</span> enumFromToL<span class="main">⋅</span><span class="free">x</span><span class="main">⋅</span><span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enumFromToS.simps<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unfold<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unfold<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unfold_enumFromToStep<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="StreamFusion-enumFromToS_defined"><span class="command">lemma</span></span> enumFromToS_defined<span class="main">:</span> <span class="quoted"><span class="quoted">"enumFromToS<span class="main">⋅</span><span class="free">x</span><span class="main">⋅</span><span class="free">y</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enumFromToS.simps<span class="main">)</span>

<span class="keyword1" id="StreamFusion-enumFromToS_cong"><span class="command">lemma</span></span> enumFromToS_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">x'</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y'</span> <span class="main">⟹</span> enumFromToS<span class="main">⋅</span><span class="free">x</span><span class="main">⋅</span><span class="free">y</span> <span class="main">≈</span> enumFromToS<span class="main">⋅</span><span class="free">x'</span><span class="main">⋅</span><span class="free">y'</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> bisimilar_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enumFromToS_defined<span class="main">)</span>

<span class="keyword1" id="StreamFusion-enumFromToL_eq"><span class="command">lemma</span></span> enumFromToL_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"enumFromToL<span class="main">⋅</span><span class="free">x</span><span class="main">⋅</span><span class="free">y</span> <span class="main">=</span> unstream<span class="main">⋅</span><span class="main">(</span>enumFromToS<span class="main">⋅</span><span class="free">x</span><span class="main">⋅</span><span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unstream_enumFromToS<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Append function›</span></span>

<span class="keyword1"><span class="command">fixrec</span></span>
  <span class="entity">appendStep</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> Step<span class="main">)</span> <span class="main">→</span>
     <span class="main">(</span><span class="tfree">'t</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> Step<span class="main">)</span> <span class="main">→</span>
     <span class="tfree">'t</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> Either <span class="main">→</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> Either<span class="main">)</span> Step"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">sa</span></span></span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free">appendStep</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">ha</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">hb</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">sb0</span></span></span><span class="main">⋅</span><span class="main">(</span>Left<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">sa</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ha</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">sa</span></span></span> <span class="keyword1">of</span>
      Done <span class="main">⇒</span> Skip<span class="main">⋅</span><span class="main">(</span>Right<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">sb0</span></span></span><span class="main">)</span>
    <span class="main">|</span> Skip<span class="main">⋅</span><span class="bound">sa'</span> <span class="main">⇒</span> Skip<span class="main">⋅</span><span class="main">(</span>Left<span class="main">⋅</span><span class="bound">sa'</span><span class="main">)</span>
    <span class="main">|</span> Yield<span class="main">⋅</span><span class="bound">x</span><span class="main">⋅</span><span class="bound">sa'</span> <span class="main">⇒</span> Yield<span class="main">⋅</span><span class="bound">x</span><span class="main">⋅</span><span class="main">(</span>Left<span class="main">⋅</span><span class="bound">sa'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">sb</span></span></span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free">appendStep</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">ha</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">hb</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">sb0</span></span></span><span class="main">⋅</span><span class="main">(</span>Right<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">sb</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">hb</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">sb</span></span></span> <span class="keyword1">of</span>
      Done <span class="main">⇒</span> Done
    <span class="main">|</span> Skip<span class="main">⋅</span><span class="bound">sb'</span> <span class="main">⇒</span> Skip<span class="main">⋅</span><span class="main">(</span>Right<span class="main">⋅</span><span class="bound">sb'</span><span class="main">)</span>
    <span class="main">|</span> Yield<span class="main">⋅</span><span class="bound">x</span><span class="main">⋅</span><span class="bound">sb'</span> <span class="main">⇒</span> Yield<span class="main">⋅</span><span class="bound">x</span><span class="main">⋅</span><span class="main">(</span>Right<span class="main">⋅</span><span class="bound">sb'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="StreamFusion-appendStep_strict"><span class="command">lemma</span></span> appendStep_strict <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"appendStep<span class="main">⋅</span><span class="free">ha</span><span class="main">⋅</span><span class="free">hb</span><span class="main">⋅</span><span class="free">sb0</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">fixrec_simp</span>

<span class="keyword1"><span class="command">fixrec</span></span>
  <span class="entity">appendS</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> Stream <span class="main">→</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> Stream <span class="main">→</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> Either<span class="main">)</span> Stream"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">sa0</span></span></span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">sb0</span></span></span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span>
    <span class="free">appendS</span><span class="main">⋅</span><span class="main">(</span>Stream<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">ha</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">sa0</span></span></span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>Stream<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">hb</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">sb0</span></span></span><span class="main">)</span> <span class="main">=</span>
      Stream<span class="main">⋅</span><span class="main">(</span>appendStep<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">ha</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">hb</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">sb0</span></span></span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>Left<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">sa0</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="StreamFusion-unfold_appendStep"><span class="command">lemma</span></span> unfold_appendStep<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ha</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> Step"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">hb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> Step"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sb0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sb0</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">sa</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟶</span> unfold<span class="main">⋅</span><span class="main">(</span>appendStep<span class="main">⋅</span><span class="free">ha</span><span class="main">⋅</span><span class="free">hb</span><span class="main">⋅</span><span class="free">sb0</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>Left<span class="main">⋅</span><span class="bound">sa</span><span class="main">)</span> <span class="main">=</span>
         appendL<span class="main">⋅</span><span class="main">(</span>unfold<span class="main">⋅</span><span class="free">ha</span><span class="main">⋅</span><span class="bound">sa</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>unfold<span class="main">⋅</span><span class="free">hb</span><span class="main">⋅</span><span class="free">sb0</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
   <span class="main">(</span><span class="main">∀</span><span class="bound">sb</span><span class="main">.</span> <span class="bound">sb</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟶</span> unfold<span class="main">⋅</span><span class="main">(</span>appendStep<span class="main">⋅</span><span class="free">ha</span><span class="main">⋅</span><span class="free">hb</span><span class="main">⋅</span><span class="free">sb0</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>Right<span class="main">⋅</span><span class="bound">sb</span><span class="main">)</span> <span class="main">=</span>
         unfold<span class="main">⋅</span><span class="free">hb</span><span class="main">⋅</span><span class="bound">sb</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> unfold <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"appendStep<span class="main">⋅</span><span class="free">ha</span><span class="main">⋅</span><span class="free">hb</span><span class="main">⋅</span><span class="free">sb0</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">sa</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟶</span>
         unfold<span class="main">⋅</span><span class="var">?h</span><span class="main">⋅</span><span class="main">(</span>Left<span class="main">⋅</span><span class="bound">sa</span><span class="main">)</span> <span class="main">⊑</span>
         appendL<span class="main">⋅</span><span class="main">(</span>unfold<span class="main">⋅</span><span class="free">ha</span><span class="main">⋅</span><span class="bound">sa</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>unfold<span class="main">⋅</span><span class="free">hb</span><span class="main">⋅</span><span class="free">sb0</span><span class="main">)</span><span class="main">)</span>
   <span class="main">∧</span>
   <span class="main">(</span><span class="main">∀</span><span class="bound">sb</span><span class="main">.</span> <span class="bound">sb</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟶</span> unfold<span class="main">⋅</span><span class="var">?h</span><span class="main">⋅</span><span class="main">(</span>Right<span class="main">⋅</span><span class="bound">sb</span><span class="main">)</span> <span class="main">⊑</span> unfold<span class="main">⋅</span><span class="free">hb</span><span class="main">⋅</span><span class="bound">sb</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> unfold_ind <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?h</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI allI impI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">ha</span><span class="main">⋅</span><span class="improper">sa</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">hb</span><span class="main">⋅</span><span class="improper">sb</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ua</span> <span class="bound">ub</span><span class="main">.</span> <span class="main">∀</span><span class="bound">sa</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟶</span>
        appendL<span class="main">⋅</span><span class="main">(</span><span class="bound">ua</span><span class="main">⋅</span><span class="bound">sa</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="bound">ub</span><span class="main">⋅</span><span class="free">sb0</span><span class="main">)</span> <span class="main">⊑</span> unfold<span class="main">⋅</span><span class="var">?h</span><span class="main">⋅</span><span class="main">(</span>Left<span class="main">⋅</span><span class="bound">sa</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ub</span><span class="main">.</span> <span class="main">∀</span><span class="bound">sb</span><span class="main">.</span> <span class="bound">sb</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟶</span> <span class="bound">ub</span><span class="main">⋅</span><span class="bound">sb</span> <span class="main">⊑</span> unfold<span class="main">⋅</span><span class="var">?h</span><span class="main">⋅</span><span class="main">(</span>Right<span class="main">⋅</span><span class="bound">sb</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> P_base<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ub</span><span class="main">.</span> <span class="var">?P</span> <span class="main">⊥</span> <span class="bound">ub</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> Q_base<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">⊥</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> P_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ua</span> <span class="bound">ub</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">ua</span> <span class="bound">ub</span> <span class="main">⟹</span> <span class="var">?Q</span> <span class="bound">ub</span> <span class="main">⟹</span> <span class="var">?P</span> <span class="main">(</span>unfoldF<span class="main">⋅</span><span class="free">ha</span><span class="main">⋅</span><span class="bound">ua</span><span class="main">)</span> <span class="bound">ub</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">ha</span><span class="main">⋅</span><span class="improper">sa</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> Q_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ua</span> <span class="bound">ub</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">ub</span> <span class="main">⟹</span> <span class="var">?Q</span> <span class="main">(</span>unfoldF<span class="main">⋅</span><span class="free">hb</span><span class="main">⋅</span><span class="bound">ub</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">hb</span><span class="main">⋅</span><span class="improper">sb</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">(</span>unfold<span class="main">⋅</span><span class="free">hb</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> unfold_ind <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">hb</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Q_base<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> Q_step<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>unfold<span class="main">⋅</span><span class="free">ha</span><span class="main">)</span> <span class="main">(</span>unfold<span class="main">⋅</span><span class="free">hb</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> unfold_ind <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">ha</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> P_base<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> P_step<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Q<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>unfold<span class="main">⋅</span><span class="free">ha</span><span class="main">)</span> <span class="main">(</span>unfold<span class="main">⋅</span><span class="free">hb</span><span class="main">)</span> <span class="main">∧</span> <span class="var">?Q</span> <span class="main">(</span>unfold<span class="main">⋅</span><span class="free">hb</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> P Q <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> 1 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> po_eq_conv <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> LList"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="StreamFusion-appendS_defined"><span class="command">lemma</span></span> appendS_defined<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free">ys</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> appendS<span class="main">⋅</span><span class="free">xs</span><span class="main">⋅</span><span class="free">ys</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">ys</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="StreamFusion-unstream_appendS"><span class="command">lemma</span></span> unstream_appendS<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span>
    unstream<span class="main">⋅</span><span class="main">(</span>appendS<span class="main">⋅</span><span class="free">a</span><span class="main">⋅</span><span class="free">b</span><span class="main">)</span> <span class="main">=</span> appendL<span class="main">⋅</span><span class="main">(</span>unstream<span class="main">⋅</span><span class="free">a</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>unstream<span class="main">⋅</span><span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">b</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unfold_appendStep<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="StreamFusion-appendS_cong"><span class="command">lemma</span></span> appendS_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">→</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> Stream"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">b</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> Stream"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≈</span> <span class="free">a'</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">≈</span> <span class="free">b'</span> <span class="main">⟹</span> appendS<span class="main">⋅</span><span class="free">a</span><span class="main">⋅</span><span class="free">b</span> <span class="main">≈</span> appendS<span class="main">⋅</span><span class="free">a'</span><span class="main">⋅</span><span class="free">b'</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> bisimilar_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unstream_appendS appendS_defined<span class="main">)</span>

<span class="keyword1" id="StreamFusion-appendL_eq"><span class="command">lemma</span></span> appendL_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"appendL<span class="main">⋅</span><span class="free">xs</span><span class="main">⋅</span><span class="free">ys</span> <span class="main">=</span> unstream<span class="main">⋅</span><span class="main">(</span>appendS<span class="main">⋅</span><span class="main">(</span>stream<span class="main">⋅</span><span class="free">xs</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>stream<span class="main">⋅</span><span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unstream_appendS<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ZipWith function›</span></span>

<span class="keyword1"><span class="command">fixrec</span></span>
  <span class="entity">zipWithStep</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">→</span> <span class="tfree">'b</span> <span class="main">→</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">→</span>
     <span class="main">(</span><span class="tfree">'s</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> Step<span class="main">)</span> <span class="main">→</span>
     <span class="main">(</span><span class="tfree">'t</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> Step<span class="main">)</span> <span class="main">→</span>
      <span class="tfree">'s</span> <span class="main">:!:</span> <span class="tfree">'t</span> <span class="main">:!:</span> <span class="tfree">'a</span> L Maybe <span class="main">→</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'s</span> <span class="main">:!:</span> <span class="tfree">'t</span> <span class="main">:!:</span> <span class="tfree">'a</span> L Maybe<span class="main">)</span> Step"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">sa</span></span></span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">sb</span></span></span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span>
   <span class="free">zipWithStep</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">ha</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">hb</span></span></span><span class="main">⋅</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">sa</span></span></span> <span class="main">:!:</span> <span class="free"><span class="bound"><span class="entity">sb</span></span></span> <span class="main">:!:</span> Nothing<span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ha</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">sa</span></span></span> <span class="keyword1">of</span>
     Done <span class="main">⇒</span> Done
   <span class="main">|</span> Skip<span class="main">⋅</span><span class="bound">sa'</span> <span class="main">⇒</span> Skip<span class="main">⋅</span><span class="main">(</span><span class="bound">sa'</span> <span class="main">:!:</span> <span class="free"><span class="bound"><span class="entity">sb</span></span></span> <span class="main">:!:</span> Nothing<span class="main">)</span>
   <span class="main">|</span> Yield<span class="main">⋅</span><span class="bound">a</span><span class="main">⋅</span><span class="bound">sa'</span> <span class="main">⇒</span> Skip<span class="main">⋅</span><span class="main">(</span><span class="bound">sa'</span> <span class="main">:!:</span> <span class="free"><span class="bound"><span class="entity">sb</span></span></span> <span class="main">:!:</span> Just<span class="main">⋅</span><span class="main">(</span>L<span class="main">⋅</span><span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">sa</span></span></span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">sb</span></span></span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span>
   <span class="free">zipWithStep</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">ha</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">hb</span></span></span><span class="main">⋅</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">sa</span></span></span> <span class="main">:!:</span> <span class="free"><span class="bound"><span class="entity">sb</span></span></span> <span class="main">:!:</span> Just<span class="main">⋅</span><span class="main">(</span>L<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">hb</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">sb</span></span></span> <span class="keyword1">of</span>
     Done <span class="main">⇒</span> Done
   <span class="main">|</span> Skip<span class="main">⋅</span><span class="bound">sb'</span> <span class="main">⇒</span> Skip<span class="main">⋅</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">sa</span></span></span> <span class="main">:!:</span> <span class="bound">sb'</span> <span class="main">:!:</span> Just<span class="main">⋅</span><span class="main">(</span>L<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span>
   <span class="main">|</span> Yield<span class="main">⋅</span><span class="bound">b</span><span class="main">⋅</span><span class="bound">sb'</span> <span class="main">⇒</span> Yield<span class="main">⋅</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">⋅</span><span class="bound">b</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">sa</span></span></span> <span class="main">:!:</span> <span class="bound">sb'</span> <span class="main">:!:</span> Nothing<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="StreamFusion-zipWithStep_strict"><span class="command">lemma</span></span> zipWithStep_strict <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"zipWithStep<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="free">ha</span><span class="main">⋅</span><span class="free">hb</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">fixrec_simp</span>

<span class="keyword1"><span class="command">fixrec</span></span>
  <span class="entity">zipWithS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">→</span> <span class="tfree">'b</span> <span class="main">→</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">→</span>
      <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> Stream <span class="main">→</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> Stream <span class="main">→</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'s</span> <span class="main">:!:</span> <span class="tfree">'t</span> <span class="main">:!:</span> <span class="tfree">'a</span> L Maybe<span class="main">)</span> Stream"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">sa0</span></span></span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">sb0</span></span></span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free">zipWithS</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="main">(</span>Stream<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">ha</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">sa0</span></span></span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>Stream<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">hb</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">sb0</span></span></span><span class="main">)</span> <span class="main">=</span>
    Stream<span class="main">⋅</span><span class="main">(</span>zipWithStep<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">ha</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">hb</span></span></span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">sa0</span></span></span> <span class="main">:!:</span> <span class="free"><span class="bound"><span class="entity">sb0</span></span></span> <span class="main">:!:</span> Nothing<span class="main">)</span>"</span></span>

<span class="keyword1" id="StreamFusion-zipWithS_fix_ind_lemma"><span class="command">lemma</span></span> zipWithS_fix_ind_lemma<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="free">Q</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> P_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="free">P</span> <span class="main">0</span> <span class="bound">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> P_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="bound">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Q_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">i</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Q_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">i</span> <span class="main">(</span>Suc <span class="bound">j</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">i</span> <span class="free">j</span> <span class="main">∧</span> <span class="free">Q</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="skolem">n</span> <span class="main"><span class="main">≡</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">+</span> <span class="free">j</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P_0 Q_0<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P_0<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P_Suc<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">j</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Q_0<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Q_Suc<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="StreamFusion-zipWithS_fix_ind"><span class="command">lemma</span></span> zipWithS_fix_ind<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> fix<span class="main">⋅</span><span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> fix<span class="main">⋅</span><span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> adm_P<span class="main">:</span> <span class="quoted"><span class="quoted">"adm <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> adm_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"adm <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> P_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> <span class="free">P</span> <span class="main">⊥</span> <span class="bound">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> P_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span> <span class="bound">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Q_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">a</span> <span class="main">⊥</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Q_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">a</span> <span class="main">(</span><span class="free">g</span><span class="main">⋅</span><span class="bound">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span> <span class="free">y</span> <span class="main">∧</span> <span class="free">Q</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>iterate <span class="bound">i</span><span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="main">⊥</span><span class="main">)</span> <span class="main">(</span>iterate <span class="bound">j</span><span class="main">⋅</span><span class="free">g</span><span class="main">⋅</span><span class="main">⊥</span><span class="main">)</span> <span class="main">∧</span> <span class="free">Q</span> <span class="main">(</span>iterate <span class="bound">i</span><span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="main">⊥</span><span class="main">)</span> <span class="main">(</span>iterate <span class="bound">j</span><span class="main">⋅</span><span class="free">g</span><span class="main">⋅</span><span class="main">⊥</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">j</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> zipWithS_fix_ind_lemma<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P_0<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Q_0<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Q_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"case_prod <span class="free">P</span> <span class="main">(</span><span class="main">⨆</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span>iterate <span class="bound">i</span><span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="main">⊥</span><span class="main">,</span> iterate <span class="bound">i</span><span class="main">⋅</span><span class="free">g</span><span class="main">⋅</span><span class="main">⊥</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> admD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def adm_P<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> x y fix_def2
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lub_prod<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"case_prod <span class="free">Q</span> <span class="main">(</span><span class="main">⨆</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span>iterate <span class="bound">i</span><span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="main">⊥</span><span class="main">,</span> iterate <span class="bound">i</span><span class="main">⋅</span><span class="free">g</span><span class="main">⋅</span><span class="main">⊥</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> admD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def adm_Q<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> x y fix_def2
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lub_prod<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> P Q <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="StreamFusion-unfold_zipWithStep"><span class="command">lemma</span></span> unfold_zipWithStep<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">→</span> <span class="tfree">'b</span> <span class="main">→</span> <span class="tfree">'c</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ha</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> Step"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">hb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> Step"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> h_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">≡</span> zipWithStep<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="free">ha</span><span class="main">⋅</span><span class="free">hb</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">sa</span> <span class="bound">sb</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟶</span> <span class="bound">sb</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟶</span>
    unfold<span class="main">⋅</span><span class="free">h</span><span class="main">⋅</span><span class="main">(</span><span class="bound">sa</span> <span class="main">:!:</span> <span class="bound">sb</span> <span class="main">:!:</span> Nothing<span class="main">)</span> <span class="main">=</span>
      zipWithL<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="main">(</span>unfold<span class="main">⋅</span><span class="free">ha</span><span class="main">⋅</span><span class="bound">sa</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>unfold<span class="main">⋅</span><span class="free">hb</span><span class="main">⋅</span><span class="bound">sb</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
   <span class="main">(</span><span class="main">∀</span><span class="bound">sa</span> <span class="bound">sb</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟶</span> <span class="bound">sb</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟶</span>
    unfold<span class="main">⋅</span><span class="free">h</span><span class="main">⋅</span><span class="main">(</span><span class="bound">sa</span> <span class="main">:!:</span> <span class="bound">sb</span> <span class="main">:!:</span> Just<span class="main">⋅</span><span class="main">(</span>L<span class="main">⋅</span><span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      zipWithL<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="main">(</span>LCons<span class="main">⋅</span><span class="bound">a</span><span class="main">⋅</span><span class="main">(</span>unfold<span class="main">⋅</span><span class="free">ha</span><span class="main">⋅</span><span class="bound">sa</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>unfold<span class="main">⋅</span><span class="free">hb</span><span class="main">⋅</span><span class="bound">sb</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> unfold <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> h_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">sa</span> <span class="bound">sb</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="bound">sb</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free">h</span><span class="main">⋅</span><span class="main">(</span><span class="bound">sa</span> <span class="main">:!:</span> <span class="bound">sb</span> <span class="main">:!:</span> Nothing<span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">case</span> <span class="free">ha</span><span class="main">⋅</span><span class="bound">sa</span> <span class="keyword1">of</span>
        Done <span class="main">⇒</span> Done
      <span class="main">|</span> Skip<span class="main">⋅</span><span class="bound">sa'</span> <span class="main">⇒</span> Skip<span class="main">⋅</span><span class="main">(</span><span class="bound">sa'</span> <span class="main">:!:</span> <span class="bound">sb</span> <span class="main">:!:</span> Nothing<span class="main">)</span>
      <span class="main">|</span> Yield<span class="main">⋅</span><span class="bound">a</span><span class="main">⋅</span><span class="bound">sa'</span> <span class="main">⇒</span> Skip<span class="main">⋅</span><span class="main">(</span><span class="bound">sa'</span> <span class="main">:!:</span> <span class="bound">sb</span> <span class="main">:!:</span> Just<span class="main">⋅</span><span class="main">(</span>L<span class="main">⋅</span><span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">sa</span> <span class="bound">sb</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="bound">sb</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free">h</span><span class="main">⋅</span><span class="main">(</span><span class="bound">sa</span> <span class="main">:!:</span> <span class="bound">sb</span> <span class="main">:!:</span> Just<span class="main">⋅</span><span class="main">(</span>L<span class="main">⋅</span><span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">case</span> <span class="free">hb</span><span class="main">⋅</span><span class="bound">sb</span> <span class="keyword1">of</span>
        Done <span class="main">⇒</span> Done
      <span class="main">|</span> Skip<span class="main">⋅</span><span class="bound">sb'</span> <span class="main">⇒</span> Skip<span class="main">⋅</span><span class="main">(</span><span class="bound">sa</span> <span class="main">:!:</span> <span class="bound">sb'</span> <span class="main">:!:</span> Just<span class="main">⋅</span><span class="main">(</span>L<span class="main">⋅</span><span class="bound">a</span><span class="main">)</span><span class="main">)</span>
      <span class="main">|</span> Yield<span class="main">⋅</span><span class="bound">b</span><span class="main">⋅</span><span class="bound">sb'</span> <span class="main">⇒</span> Yield<span class="main">⋅</span><span class="main">(</span><span class="free">f</span><span class="main">⋅</span><span class="bound">a</span><span class="main">⋅</span><span class="bound">b</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="bound">sa</span> <span class="main">:!:</span> <span class="bound">sb'</span> <span class="main">:!:</span> Nothing<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">h</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> h_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">sa</span> <span class="bound">sb</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟶</span> <span class="bound">sb</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟶</span>
    unfold<span class="main">⋅</span><span class="free">h</span><span class="main">⋅</span><span class="main">(</span><span class="bound">sa</span> <span class="main">:!:</span> <span class="bound">sb</span> <span class="main">:!:</span> Nothing<span class="main">)</span> <span class="main">⊑</span>
      zipWithL<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="main">(</span>unfold<span class="main">⋅</span><span class="free">ha</span><span class="main">⋅</span><span class="bound">sa</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>unfold<span class="main">⋅</span><span class="free">hb</span><span class="main">⋅</span><span class="bound">sb</span><span class="main">)</span><span class="main">)</span>
   <span class="main">∧</span>
   <span class="main">(</span><span class="main">∀</span><span class="bound">sa</span> <span class="bound">sb</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟶</span> <span class="bound">sb</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟶</span>
    unfold<span class="main">⋅</span><span class="free">h</span><span class="main">⋅</span><span class="main">(</span><span class="bound">sa</span> <span class="main">:!:</span> <span class="bound">sb</span> <span class="main">:!:</span> Just<span class="main">⋅</span><span class="main">(</span>L<span class="main">⋅</span><span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span>
      zipWithL<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="main">(</span>LCons<span class="main">⋅</span><span class="bound">a</span><span class="main">⋅</span><span class="main">(</span>unfold<span class="main">⋅</span><span class="free">ha</span><span class="main">⋅</span><span class="bound">sa</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>unfold<span class="main">⋅</span><span class="free">hb</span><span class="main">⋅</span><span class="bound">sb</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> unfold_ind <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">h</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI allI impI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">ha</span><span class="main">⋅</span><span class="improper">sa</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">hb</span><span class="main">⋅</span><span class="improper">sb</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ua</span> <span class="bound">ub</span><span class="main">.</span> <span class="main">∀</span><span class="bound">sa</span> <span class="bound">sb</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟶</span> <span class="bound">sb</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟶</span>
        zipWithL<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="main">(</span><span class="bound">ua</span><span class="main">⋅</span><span class="bound">sa</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="bound">ub</span><span class="main">⋅</span><span class="bound">sb</span><span class="main">)</span> <span class="main">⊑</span> unfold<span class="main">⋅</span><span class="free">h</span><span class="main">⋅</span><span class="main">(</span><span class="bound">sa</span> <span class="main">:!:</span> <span class="bound">sb</span> <span class="main">:!:</span> Nothing<span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ua</span> <span class="bound">ub</span><span class="main">.</span> <span class="main">∀</span><span class="bound">sa</span> <span class="bound">sb</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟶</span> <span class="bound">sb</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟶</span>
        zipWithL<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="main">(</span>LCons<span class="main">⋅</span><span class="bound">a</span><span class="main">⋅</span><span class="main">(</span><span class="bound">ua</span><span class="main">⋅</span><span class="bound">sa</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="bound">ub</span><span class="main">⋅</span><span class="bound">sb</span><span class="main">)</span> <span class="main">⊑</span>
          unfold<span class="main">⋅</span><span class="free">h</span><span class="main">⋅</span><span class="main">(</span><span class="bound">sa</span> <span class="main">:!:</span> <span class="bound">sb</span> <span class="main">:!:</span> Just<span class="main">⋅</span><span class="main">(</span>L<span class="main">⋅</span><span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> P_base<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ub</span><span class="main">.</span> <span class="var">?P</span> <span class="main">⊥</span> <span class="bound">ub</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> Q_base<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ua</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">ua</span> <span class="main">⊥</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> P_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ua</span> <span class="bound">ub</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">ua</span> <span class="bound">ub</span> <span class="main">⟹</span> <span class="var">?Q</span> <span class="bound">ua</span> <span class="bound">ub</span> <span class="main">⟹</span> <span class="var">?P</span> <span class="main">(</span>unfoldF<span class="main">⋅</span><span class="free">ha</span><span class="main">⋅</span><span class="bound">ua</span><span class="main">)</span> <span class="bound">ub</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">ha</span><span class="main">⋅</span><span class="improper">sa</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> Q_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ua</span> <span class="bound">ub</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">ua</span> <span class="bound">ub</span> <span class="main">⟹</span> <span class="var">?Q</span> <span class="bound">ua</span> <span class="bound">ub</span> <span class="main">⟹</span> <span class="var">?Q</span> <span class="bound">ua</span> <span class="main">(</span>unfoldF<span class="main">⋅</span><span class="free">hb</span><span class="main">⋅</span><span class="bound">ub</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">hb</span><span class="main">⋅</span><span class="improper">sb</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>unfold<span class="main">⋅</span><span class="free">ha</span><span class="main">)</span> <span class="main">(</span>unfold<span class="main">⋅</span><span class="free">hb</span><span class="main">)</span> <span class="main">∧</span> <span class="var">?Q</span> <span class="main">(</span>unfold<span class="main">⋅</span><span class="free">ha</span><span class="main">)</span> <span class="main">(</span>unfold<span class="main">⋅</span><span class="free">hb</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> zipWithS_fix_ind <span class="main"><span class="main">[</span></span><span class="operator">OF</span> unfold_eq_fix <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">ha</span></span></span></span><span class="main"><span class="main">]</span></span> unfold_eq_fix <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">hb</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span> <span class="comment1">(* admissibility *)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> P_base<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> P_step<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Q_base<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Q_step<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">from</span></span> 1 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> po_eq_conv <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="tfree">'c</span> LList"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="StreamFusion-zipWithS_defined"><span class="command">lemma</span></span> zipWithS_defined<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> zipWithS<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="free">a</span><span class="main">⋅</span><span class="free">b</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">b</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="StreamFusion-unstream_zipWithS"><span class="command">lemma</span></span> unstream_zipWithS<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span>
    unstream<span class="main">⋅</span><span class="main">(</span>zipWithS<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="free">a</span><span class="main">⋅</span><span class="free">b</span><span class="main">)</span> <span class="main">=</span> zipWithL<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="main">(</span>unstream<span class="main">⋅</span><span class="free">a</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>unstream<span class="main">⋅</span><span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">b</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unfold_zipWithStep<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="StreamFusion-zipWithS_cong"><span class="command">lemma</span></span> zipWithS_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">f'</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">≈</span> <span class="free">a'</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">≈</span> <span class="free">b'</span> <span class="main">⟹</span>
    zipWithS<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="free">a</span><span class="main">⋅</span><span class="free">b</span> <span class="main">≈</span> zipWithS<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="free">a'</span><span class="main">⋅</span><span class="free">b'</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> bisimilar_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unstream_zipWithS zipWithS_defined<span class="main">)</span>

<span class="keyword1" id="StreamFusion-zipWithL_eq"><span class="command">lemma</span></span> zipWithL_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"zipWithL<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="free">xs</span><span class="main">⋅</span><span class="free">ys</span> <span class="main">=</span> unstream<span class="main">⋅</span><span class="main">(</span>zipWithS<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="main">(</span>stream<span class="main">⋅</span><span class="free">xs</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>stream<span class="main">⋅</span><span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unstream_zipWithS<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ConcatMap function›</span></span>

<span class="keyword1"><span class="command">fixrec</span></span>
  <span class="entity">concatMapStep</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> Stream<span class="main">)</span> <span class="main">→</span>
     <span class="main">(</span><span class="tfree">'s</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> Step<span class="main">)</span> <span class="main">→</span>
     <span class="tfree">'s</span> <span class="main">:!:</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> Stream Maybe <span class="main">→</span>
     <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s</span> <span class="main">:!:</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> Stream Maybe<span class="main">)</span> Step"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">sa</span></span></span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free">concatMapStep</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">ha</span></span></span><span class="main">⋅</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">sa</span></span></span> <span class="main">:!:</span> Nothing<span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ha</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">sa</span></span></span> <span class="keyword1">of</span>
      Done <span class="main">⇒</span> Done
    <span class="main">|</span> Skip<span class="main">⋅</span><span class="bound">sa'</span> <span class="main">⇒</span> Skip<span class="main">⋅</span><span class="main">(</span><span class="bound">sa'</span> <span class="main">:!:</span> Nothing<span class="main">)</span>
    <span class="main">|</span> Yield<span class="main">⋅</span><span class="bound">a</span><span class="main">⋅</span><span class="bound">sa'</span> <span class="main">⇒</span> Skip<span class="main">⋅</span><span class="main">(</span><span class="bound">sa'</span> <span class="main">:!:</span> Just<span class="main">⋅</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">sa</span></span></span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">sb</span></span></span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span>
    <span class="free">concatMapStep</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">ha</span></span></span><span class="main">⋅</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">sa</span></span></span> <span class="main">:!:</span> Just<span class="main">⋅</span><span class="main">(</span>Stream<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">hb</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">sb</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">hb</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">sb</span></span></span> <span class="keyword1">of</span>
      Done <span class="main">⇒</span> Skip<span class="main">⋅</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">sa</span></span></span> <span class="main">:!:</span> Nothing<span class="main">)</span>
    <span class="main">|</span> Skip<span class="main">⋅</span><span class="bound">sb'</span> <span class="main">⇒</span> Skip<span class="main">⋅</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">sa</span></span></span> <span class="main">:!:</span> Just<span class="main">⋅</span><span class="main">(</span>Stream<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">hb</span></span></span><span class="main">⋅</span><span class="bound">sb'</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> Yield<span class="main">⋅</span><span class="bound">b</span><span class="main">⋅</span><span class="bound">sb'</span> <span class="main">⇒</span> Yield<span class="main">⋅</span><span class="bound">b</span><span class="main">⋅</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">sa</span></span></span> <span class="main">:!:</span> Just<span class="main">⋅</span><span class="main">(</span>Stream<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">hb</span></span></span><span class="main">⋅</span><span class="bound">sb'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="StreamFusion-concatMapStep_strict"><span class="command">lemma</span></span> concatMapStep_strict <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"concatMapStep<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="free">ha</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">fixrec_simp</span>

<span class="keyword1"><span class="command">fixrec</span></span>
  <span class="entity">concatMapS</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> Stream<span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> Stream <span class="main">→</span>
     <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s</span> <span class="main">:!:</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> Stream Maybe<span class="main">)</span> Stream"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free">concatMapS</span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="main">(</span>Stream<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Stream<span class="main">⋅</span><span class="main">(</span>concatMapStep<span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⋅</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">:!:</span> Nothing<span class="main">)</span>"</span></span>

<span class="keyword1" id="StreamFusion-concatMapS_strict"><span class="command">lemma</span></span> concatMapS_strict <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"concatMapS<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">fixrec_simp</span>

<span class="keyword1" id="StreamFusion-unfold_concatMapStep"><span class="command">lemma</span></span> unfold_concatMapStep<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ha</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> Step"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">→</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> Stream"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> h_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">≡</span> concatMapStep<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="free">ha</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> f'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f'</span> <span class="main">≡</span> unstream <span class="keyword1">oo</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">sa</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟶</span>
      unfold<span class="main">⋅</span><span class="free">h</span><span class="main">⋅</span><span class="main">(</span><span class="bound">sa</span> <span class="main">:!:</span> Nothing<span class="main">)</span> <span class="main">=</span> concatMapL<span class="main">⋅</span><span class="free">f'</span><span class="main">⋅</span><span class="main">(</span>unfold<span class="main">⋅</span><span class="free">ha</span><span class="main">⋅</span><span class="bound">sa</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
   <span class="main">(</span><span class="main">∀</span><span class="bound">sa</span> <span class="bound">hb</span> <span class="bound">sb</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟶</span> <span class="bound">sb</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟶</span>
      unfold<span class="main">⋅</span><span class="free">h</span><span class="main">⋅</span><span class="main">(</span><span class="bound">sa</span> <span class="main">:!:</span> Just<span class="main">⋅</span><span class="main">(</span>Stream<span class="main">⋅</span><span class="bound">hb</span><span class="main">⋅</span><span class="bound">sb</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        appendL<span class="main">⋅</span><span class="main">(</span>unfold<span class="main">⋅</span><span class="bound">hb</span><span class="main">⋅</span><span class="bound">sb</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>concatMapL<span class="main">⋅</span><span class="free">f'</span><span class="main">⋅</span><span class="main">(</span>unfold<span class="main">⋅</span><span class="free">ha</span><span class="main">⋅</span><span class="bound">sa</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> unfold <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> h_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">sa</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free">h</span><span class="main">⋅</span><span class="main">(</span><span class="bound">sa</span> <span class="main">:!:</span> Nothing<span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">case</span> <span class="free">ha</span><span class="main">⋅</span><span class="bound">sa</span> <span class="keyword1">of</span> Done <span class="main">⇒</span> Done
      <span class="main">|</span> Skip<span class="main">⋅</span><span class="bound">sa'</span> <span class="main">⇒</span> Skip<span class="main">⋅</span><span class="main">(</span><span class="bound">sa'</span> <span class="main">:!:</span> Nothing<span class="main">)</span>
      <span class="main">|</span> Yield<span class="main">⋅</span><span class="bound">a</span><span class="main">⋅</span><span class="bound">sa'</span> <span class="main">⇒</span> Skip<span class="main">⋅</span><span class="main">(</span><span class="bound">sa'</span> <span class="main">:!:</span> Just<span class="main">⋅</span><span class="main">(</span><span class="free">f</span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">sa</span> <span class="bound">hb</span> <span class="bound">sb</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="bound">sb</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free">h</span><span class="main">⋅</span><span class="main">(</span><span class="bound">sa</span> <span class="main">:!:</span> Just<span class="main">⋅</span><span class="main">(</span>Stream<span class="main">⋅</span><span class="bound">hb</span><span class="main">⋅</span><span class="bound">sb</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">case</span> <span class="bound">hb</span><span class="main">⋅</span><span class="bound">sb</span> <span class="keyword1">of</span> Done <span class="main">⇒</span> Skip<span class="main">⋅</span><span class="main">(</span><span class="bound">sa</span> <span class="main">:!:</span> Nothing<span class="main">)</span>
      <span class="main">|</span> Skip<span class="main">⋅</span><span class="bound">sb'</span> <span class="main">⇒</span> Skip<span class="main">⋅</span><span class="main">(</span><span class="bound">sa</span> <span class="main">:!:</span> Just<span class="main">⋅</span><span class="main">(</span>Stream<span class="main">⋅</span><span class="bound">hb</span><span class="main">⋅</span><span class="bound">sb'</span><span class="main">)</span><span class="main">)</span>
      <span class="main">|</span> Yield<span class="main">⋅</span><span class="bound">b</span><span class="main">⋅</span><span class="bound">sb'</span> <span class="main">⇒</span> Yield<span class="main">⋅</span><span class="bound">b</span><span class="main">⋅</span><span class="main">(</span><span class="bound">sa</span> <span class="main">:!:</span> Just<span class="main">⋅</span><span class="main">(</span>Stream<span class="main">⋅</span><span class="bound">hb</span><span class="main">⋅</span><span class="bound">sb'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">h</span><span class="main">⋅</span><span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> h_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

  <span class="keyword1"><span class="command">have</span></span> f'_beta <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="free">f'</span><span class="main">⋅</span><span class="bound">a</span> <span class="main">=</span> unstream<span class="main">⋅</span><span class="main">(</span><span class="free">f</span><span class="main">⋅</span><span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> f'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">sa</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟶</span>
      unfold<span class="main">⋅</span><span class="free">h</span><span class="main">⋅</span><span class="main">(</span><span class="bound">sa</span> <span class="main">:!:</span> Nothing<span class="main">)</span> <span class="main">⊑</span> concatMapL<span class="main">⋅</span><span class="free">f'</span><span class="main">⋅</span><span class="main">(</span>unfold<span class="main">⋅</span><span class="free">ha</span><span class="main">⋅</span><span class="bound">sa</span><span class="main">)</span><span class="main">)</span>
   <span class="main">∧</span>
   <span class="main">(</span><span class="main">∀</span><span class="bound">sa</span> <span class="bound">hb</span> <span class="bound">sb</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟶</span> <span class="bound">sb</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟶</span>
      unfold<span class="main">⋅</span><span class="free">h</span><span class="main">⋅</span><span class="main">(</span><span class="bound">sa</span> <span class="main">:!:</span> Just<span class="main">⋅</span><span class="main">(</span>Stream<span class="main">⋅</span><span class="bound">hb</span><span class="main">⋅</span><span class="bound">sb</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span>
        appendL<span class="main">⋅</span><span class="main">(</span>unfold<span class="main">⋅</span><span class="bound">hb</span><span class="main">⋅</span><span class="bound">sb</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>concatMapL<span class="main">⋅</span><span class="free">f'</span><span class="main">⋅</span><span class="main">(</span>unfold<span class="main">⋅</span><span class="free">ha</span><span class="main">⋅</span><span class="bound">sa</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> unfold_ind <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">h</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI allI impI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">ha</span><span class="main">⋅</span><span class="improper">sa</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> a sa'<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⋅</span><span class="improper">a</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">hb</span><span class="main">⋅</span><span class="improper">sb</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ua</span><span class="main">.</span> <span class="main">∀</span><span class="bound">sa</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟶</span>
        concatMapL<span class="main">⋅</span><span class="free">f'</span><span class="main">⋅</span><span class="main">(</span><span class="bound">ua</span><span class="main">⋅</span><span class="bound">sa</span><span class="main">)</span> <span class="main">⊑</span> unfold<span class="main">⋅</span><span class="free">h</span><span class="main">⋅</span><span class="main">(</span><span class="bound">sa</span> <span class="main">:!:</span> Nothing<span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">hb</span> <span class="bound">ua</span> <span class="bound">ub</span><span class="main">.</span> <span class="main">∀</span><span class="bound">sa</span> <span class="bound">sb</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟶</span> <span class="bound">sb</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟶</span>
        appendL<span class="main">⋅</span><span class="main">(</span><span class="bound">ub</span><span class="main">⋅</span><span class="bound">sb</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>concatMapL<span class="main">⋅</span><span class="free">f'</span><span class="main">⋅</span><span class="main">(</span><span class="bound">ua</span><span class="main">⋅</span><span class="bound">sa</span><span class="main">)</span><span class="main">)</span> <span class="main">⊑</span>
            unfold<span class="main">⋅</span><span class="free">h</span><span class="main">⋅</span><span class="main">(</span><span class="bound">sa</span> <span class="main">:!:</span> Just<span class="main">⋅</span><span class="main">(</span>Stream<span class="main">⋅</span><span class="bound">hb</span><span class="main">⋅</span><span class="bound">sb</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> P_base<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">⊥</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> P_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ua</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">ua</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">hb</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">hb</span> <span class="bound">ua</span> <span class="main">(</span>unfold<span class="main">⋅</span><span class="bound">hb</span><span class="main">)</span> <span class="main">⟹</span> <span class="var">?P</span> <span class="main">(</span>unfoldF<span class="main">⋅</span><span class="free">ha</span><span class="main">⋅</span><span class="bound">ua</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">ha</span><span class="main">⋅</span><span class="improper">sa</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> a sa'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⋅</span><span class="improper">a</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> Q_base<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ua</span> <span class="bound">hb</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">hb</span> <span class="bound">ua</span> <span class="main">⊥</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> Q_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">hb</span> <span class="bound">ua</span> <span class="bound">ub</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">ua</span> <span class="main">⟹</span> <span class="var">?Q</span> <span class="bound">hb</span> <span class="bound">ua</span> <span class="bound">ub</span> <span class="main">⟹</span> <span class="var">?Q</span> <span class="bound">hb</span> <span class="bound">ua</span> <span class="main">(</span>unfoldF<span class="main">⋅</span><span class="bound">hb</span><span class="main">⋅</span><span class="bound">ub</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">hb</span><span class="main">⋅</span><span class="improper">sb</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>unfold<span class="main">⋅</span><span class="free">ha</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">hb</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">hb</span> <span class="main">(</span>unfold<span class="main">⋅</span><span class="free">ha</span><span class="main">)</span> <span class="main">(</span>unfold<span class="main">⋅</span><span class="bound">hb</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> unfold_ind <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">ha</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> P_base<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> h<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">hb</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> unfold_ind<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Q_base<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> Q_step <span class="main"><span class="main">[</span></span><span class="operator">OF</span> P_base<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> P_step<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> h<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">hb</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> unfold_ind<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Q_base<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Q_step <span class="main"><span class="main">[</span></span><span class="operator">OF</span> P_step<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">from</span></span> 1 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> po_eq_conv <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="tfree">'b</span> LList"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="StreamFusion-unstream_concatMapS"><span class="command">lemma</span></span> unstream_concatMapS<span class="main">:</span>
  <span class="quoted"><span class="quoted">"unstream<span class="main">⋅</span><span class="main">(</span>concatMapS<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="free">a</span><span class="main">)</span> <span class="main">=</span> concatMapL<span class="main">⋅</span><span class="main">(</span>unstream <span class="keyword1">oo</span> <span class="free">f</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>unstream<span class="main">⋅</span><span class="free">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unfold_concatMapStep<span class="main">)</span>

<span class="keyword1" id="StreamFusion-concatMapS_defined"><span class="command">lemma</span></span> concatMapS_defined<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="main">⊥</span> <span class="main">⟹</span> concatMapS<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="free">a</span> <span class="main">≠</span> <span class="main">⊥</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="StreamFusion-concatMapS_cong"><span class="command">lemma</span></span> concatMapS_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> Stream"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">)</span> Stream"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'u</span><span class="main">)</span> Stream"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">b</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> Stream"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≈</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">≈</span> <span class="free">b</span> <span class="main">⟹</span> cont <span class="free">f</span> <span class="main">⟹</span> cont <span class="free">g</span> <span class="main">⟹</span>
    concatMapS<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> x<span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">⋅</span><span class="free">a</span> <span class="main">≈</span> concatMapS<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> x<span class="main">.</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">⋅</span><span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> bisimilar_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unstream_concatMapS oo_def concatMapS_defined<span class="main">)</span>

<span class="keyword1" id="StreamFusion-concatMapL_eq"><span class="command">lemma</span></span> concatMapL_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"concatMapL<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="free">xs</span> <span class="main">=</span> unstream<span class="main">⋅</span><span class="main">(</span>concatMapS<span class="main">⋅</span><span class="main">(</span>stream <span class="keyword1">oo</span> <span class="free">f</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>stream<span class="main">⋅</span><span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unstream_concatMapS oo_def eta_cfun<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Examples›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> stream_eqs <span class="main">=</span>
  mapL_eq
  filterL_eq
  foldrL_eq
  enumFromToL_eq
  appendL_eq
  zipWithL_eq
  concatMapL_eq

<span class="keyword1"><span class="command">lemmas</span></span> stream_congs <span class="main">=</span>
  unstream_cong
  stream_cong
  stream_unstream_cong
  mapS_cong
  filterS_cong
  foldrS_cong
  enumFromToS_cong
  appendS_cong
  zipWithS_cong
  concatMapS_cong

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="quoted"><span class="quoted">"mapL<span class="main">⋅</span><span class="free">f</span> <span class="keyword1">oo</span> filterL<span class="main">⋅</span><span class="free">p</span> <span class="keyword1">oo</span> mapL<span class="main">⋅</span><span class="free">g</span> <span class="main">=</span>
   unstream <span class="keyword1">oo</span> mapS<span class="main">⋅</span><span class="free">f</span> <span class="keyword1">oo</span> filterS<span class="main">⋅</span><span class="free">p</span> <span class="keyword1">oo</span> mapS<span class="main">⋅</span><span class="free">g</span> <span class="keyword1">oo</span> stream"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cfun_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> stream_eqs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> stream_congs refl<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="quoted"><span class="quoted">"foldrL<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="free">z</span><span class="main">⋅</span><span class="main">(</span>mapL<span class="main">⋅</span><span class="free">g</span><span class="main">⋅</span><span class="main">(</span>filterL<span class="main">⋅</span><span class="free">p</span><span class="main">⋅</span><span class="main">(</span>enumFromToL<span class="main">⋅</span><span class="free">x</span><span class="main">⋅</span><span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    foldrS<span class="main">⋅</span><span class="free">f</span><span class="main">⋅</span><span class="free">z</span><span class="main">⋅</span><span class="main">(</span>mapS<span class="main">⋅</span><span class="free">g</span><span class="main">⋅</span><span class="main">(</span>filterS<span class="main">⋅</span><span class="free">p</span><span class="main">⋅</span><span class="main">(</span>enumFromToS<span class="main">⋅</span><span class="free">x</span><span class="main">⋅</span><span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> stream_eqs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> stream_congs refl<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="StreamFusion-oo_LAM"><span class="command">lemma</span></span> oo_LAM <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cont <span class="free">g</span> <span class="main">⟹</span> <span class="free">f</span> <span class="keyword1">oo</span> <span class="main">(</span><span class="keyword1">Λ</span> x<span class="main">.</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ</span> x<span class="main">.</span> <span class="free">f</span><span class="main">⋅</span><span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> oo_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="quoted"><span class="quoted">"concatMapL<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> k<span class="main">.</span>
    mapL<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> m<span class="main">.</span> <span class="free">f</span><span class="main">⋅</span><span class="bound">k</span><span class="main">⋅</span><span class="bound">m</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>enumFromToL<span class="main">⋅</span><span class="free">one</span><span class="main">⋅</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>enumFromToL<span class="main">⋅</span><span class="free">one</span><span class="main">⋅</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span>
   unstream<span class="main">⋅</span><span class="main">(</span>concatMapS<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> k<span class="main">.</span>
    mapS<span class="main">⋅</span><span class="main">(</span><span class="keyword1">Λ</span> m<span class="main">.</span> <span class="free">f</span><span class="main">⋅</span><span class="bound">k</span><span class="main">⋅</span><span class="bound">m</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>enumFromToS<span class="main">⋅</span><span class="free">one</span><span class="main">⋅</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">⋅</span><span class="main">(</span>enumFromToS<span class="main">⋅</span><span class="free">one</span><span class="main">⋅</span><span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> stream_eqs
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stream_congs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>