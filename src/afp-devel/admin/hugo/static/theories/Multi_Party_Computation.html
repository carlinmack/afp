<div id="Cyclic_Group_Ext">
<div class="head">
<h1>Theory Cyclic_Group_Ext</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Cyclic_Group_Ext <span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../CryptHOL/CryptHOL.html">CryptHOL.CryptHOL</a>
  <span class="quoted">"<a href="../../HOL/HOL-Number_Theory/Cong.html">HOL-Number_Theory.Cong</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> cyclic_group <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> generator_pow_order<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> order <span class="free">G</span> <span class="main">=</span> <span class="main">ùü≠</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"order <span class="free">G</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">hence</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>carrier <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> order_gt_0_iff_finite<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span><span class="main">)</span> <span class="main">`</span> carrier <span class="free">G</span> <span class="main">=</span> carrier <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> endo_inj_surj<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_multc<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"carrier <span class="free">G</span> <span class="main">=</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">n</span><span class="main">.</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> Suc <span class="bound">n</span><span class="main">)</span> <span class="main">`</span> <span class="main">{..&lt;</span>order <span class="free">G</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> fin <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> carrier_conv_generator image_image<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">ùü≠</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> Suc <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> order <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> order <span class="free">G</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n inj_onD<span class="main">[</span><span class="operator">OF</span> inj_on_generator<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">with</span></span> True n <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
                        
<span class="keyword1"><span class="command">lemma</span></span> pow_generator_mod<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">mod</span> order <span class="free">G</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"order <span class="free">G</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">*</span> order <span class="free">G</span> <span class="main">+</span> <span class="free">k</span> <span class="keyword1">mod</span> order <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> div_mult_mod_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">k</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> order <span class="free">G</span><span class="main">)</span> <span class="main">[^]</span> <span class="skolem">n</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">mod</span> order <span class="free">G</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> n<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nat_pow_mult nat_pow_pow mult_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generator_pow_order<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> int_nat_pow<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">‚â•</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span>int <span class="main">(</span><span class="free">a</span> <span class="main">::</span>nat<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="main">(</span><span class="free">b</span><span class="main">::</span>int<span class="main">)</span>  <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms 
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> int_pow_pow <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span>int <span class="main">(</span><span class="free">a</span> <span class="main">::</span>nat<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="main">(</span><span class="free">b</span><span class="main">::</span>int<span class="main">)</span> <span class="main">=</span> <span class="main">ùü≠</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">ùü≠</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pow_generator_mod_int<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="main">(</span><span class="free">k</span> <span class="main">::</span> int<span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">G</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"order <span class="free">G</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="main">::</span> <span class="quoted">int</span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> order <span class="free">G</span> <span class="main">*</span> <span class="skolem">n</span> <span class="main">+</span> <span class="free">k</span> <span class="keyword1">mod</span> order <span class="free">G</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> div_mult_mod_eq mult.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">k</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span>order <span class="free">G</span> <span class="main">*</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">mod</span> order <span class="free">G</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> int_pow_mult nat_pow_mult <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> generator_closed<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">k</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> order <span class="free">G</span><span class="main">)</span> <span class="main">[^]</span> <span class="skolem">n</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">mod</span> order <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> int_nat_pow <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> int_pow_int<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generator_pow_order<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> pow_gen_mod_mult<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">a</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">b</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="main">(</span><span class="main">(</span><span class="free">c</span><span class="main">::</span>int<span class="main">)</span><span class="main">*</span> int <span class="main">(</span><span class="free">d</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">a</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">b</span><span class="main">)</span> <span class="main">[^]</span> <span class="main">(</span><span class="main">(</span><span class="free">c</span><span class="main">*</span>int <span class="free">d</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">a</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">b</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">‚àà</span> carrier <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">a</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">b</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monoid.nat_pow_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="free">c</span><span class="main">*</span>int <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">a</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">b</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="main">(</span><span class="main">(</span><span class="free">c</span><span class="main">::</span>int<span class="main">)</span><span class="main">*</span>int <span class="main">(</span><span class="free">d</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">[^]</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n r <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span><span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">r</span> <span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pow_generator_mod_int pow_generator_mod 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> int_nat_pow int_pow_int mod_mult_right_eq zero_le<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">a</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">b</span><span class="main">)</span> <span class="main">[^]</span> <span class="main">(</span><span class="main">(</span><span class="free">c</span><span class="main">*</span>int <span class="free">d</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r n <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pow_generator_eq_iff_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>carrier <span class="free">G</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">x</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">y</span> <span class="main">‚ü∑</span> <span class="main">[</span><span class="free">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> pow_generator_mod<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def order_gt_0_iff_finite <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inj_onD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inj_on_generator<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cyclic_group_commute<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">‚àà</span> carrier <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">‚àà</span> carrier <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">‚äó</span> <span class="free">b</span> <span class="main">=</span> <span class="free">b</span> <span class="main">‚äó</span> <span class="free">a</span>"</span></span>
<span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> generatorE assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span>  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> generatorE assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span>  <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">n</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nat_pow_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nat_pow_mult n k<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cyclic_group_assoc<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">‚àà</span> carrier <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">‚àà</span> carrier <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">‚àà</span> carrier <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">‚äó</span> <span class="free">b</span><span class="main">)</span> <span class="main">‚äó</span> <span class="free">c</span> <span class="main">=</span> <span class="free">a</span> <span class="main">‚äó</span> <span class="main">(</span><span class="free">b</span> <span class="main">‚äó</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> generatorE assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> generatorE assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> generatorE assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">n</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n k j <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nat_pow_mult add.assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nat_pow_mult n k j<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
 
<span class="keyword1"><span class="command">lemma</span></span> l_cancel_inv<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">‚àà</span> carrier <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">a</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="free">h</span> <span class="main">=</span> <span class="free">h</span>"</span></span>
<span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> int <span class="free">a</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> int <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="free">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> int <span class="free">a</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="main">-</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="free">h</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> int_pow_neg<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span>int <span class="free">a</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span>  <span class="main">‚äó</span> <span class="free">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> int_pow_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="main">(</span><span class="main">0</span><span class="main">::</span> int<span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="free">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inverse_split<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">‚àà</span> carrier <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">‚àà</span> carrier <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">inv</span> <span class="main">(</span><span class="free">a</span> <span class="main">‚äó</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">inv</span> <span class="free">a</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  assms comm_group.inv_mult cyclic_group_commute group_comm_groupI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inverse_pow_pow<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">‚àà</span> carrier <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">inv</span> <span class="main">(</span><span class="free">a</span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">inv</span> <span class="free">a</span><span class="main">)</span> <span class="main">[^]</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">[^]</span> <span class="free">r</span> <span class="main">‚àà</span> carrier <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms nat_pow_inv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> l_neq_1_exp_neq_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">‚àà</span> carrier <span class="free">G</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">‚â†</span> <span class="main">ùü≠</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">t</span><span class="main">::</span>nat<span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">‚â†</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬¨</span> <span class="main">(</span><span class="free">t</span> <span class="main">‚â†</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">t</span> <span class="main">=</span> <span class="main">ùü≠</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> order_gt_1_gen_not_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"order <span class="free">G</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">‚â†</span> <span class="main">ùü≠</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬¨</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">‚â†</span> <span class="main">ùü≠</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">=</span> <span class="main">ùü≠</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> g_pow_eq_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">ùü≠</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"range <span class="main">(</span><span class="main">Œª</span><span class="bound">n</span> <span class="main">::</span> nat<span class="main">.</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">ùü≠</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"carrier <span class="free">G</span> <span class="main">‚äÜ</span> <span class="main">{</span><span class="main">ùü≠</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> generator <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"order <span class="free">G</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def assms g_pow_eq_1 inj_onD inj_on_generator lessThan_iff not_gr_zero zero_less_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> power_swap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">Œ±0</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">r</span><span class="main">)</span> <span class="main">[^]</span> <span class="free">Œ±0</span><span class="main">)</span>"</span></span>
<span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">Œ±0</span> <span class="main">*</span> <span class="free">r</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> nat_pow_pow mult.commute <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±0</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> mult.commute<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> nat_pow_pow <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> 

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Number_Theory_Aux">
<div class="head">
<h1>Theory Number_Theory_Aux</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Number_Theory_Aux <span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Number_Theory/Cong.html">HOL-Number_Theory.Cong</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Number_Theory/Residues.html">HOL-Number_Theory.Residues</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bezw_inverse<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gcd <span class="main">(</span><span class="free">e</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">(</span><span class="free">N</span> <span class="main">::</span>nat<span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>nat <span class="free">e</span> <span class="main">*</span> nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">e</span> <span class="free">N</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> nat <span class="free">N</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">e</span> <span class="free">N</span><span class="main">)</span> <span class="main">*</span> <span class="free">e</span> <span class="main">+</span> snd <span class="main">(</span>bezw <span class="free">e</span> <span class="free">N</span><span class="main">)</span> <span class="main">*</span> <span class="free">N</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">N</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">mod</span> <span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms bezw_aux zmod_int<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">e</span> <span class="free">N</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">N</span> <span class="main">*</span> <span class="free">e</span> <span class="keyword1">mod</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">mod</span> <span class="free">N</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mod_mult_right_eq mult.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> cong_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">e</span> <span class="free">N</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">N</span> <span class="main">*</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">N</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_nat_1 zmod_int cong_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>nat <span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">e</span> <span class="free">N</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">N</span><span class="main">)</span> <span class="main">*</span> <span class="free">e</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">N</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"int <span class="main">(</span>nat <span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">e</span> <span class="free">N</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="free">N</span><span class="main">)</span><span class="main">)</span> <span class="main">‚â†</span> fst <span class="main">(</span>bezw <span class="free">e</span> <span class="free">N</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="free">N</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> <span class="main">0</span> <span class="main">‚ü∂</span> <span class="main">0</span> <span class="main">‚â§</span> fst <span class="main">(</span>bezw <span class="free">e</span> <span class="free">N</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="free">N</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"int <span class="main">(</span>nat <span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">e</span> <span class="free">N</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="free">N</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>bezw <span class="free">e</span> <span class="free">N</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="free">N</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>int <span class="main">(</span>nat <span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">e</span> <span class="free">N</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="free">N</span><span class="main">)</span> <span class="main">*</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> int <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> int <span class="free">N</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cong_eq of_nat_1 of_nat_mult<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> cong_int_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inverse<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gcd <span class="free">x</span> <span class="main">(</span><span class="free">q</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">*</span> <span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">x</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> int_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>bezw  <span class="free">x</span> <span class="free">q</span><span class="main">)</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> snd <span class="main">(</span>bezw <span class="free">x</span> <span class="free">q</span><span class="main">)</span> <span class="main">*</span> int <span class="free">q</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> bezw_aux of_nat_1<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> int_eq'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>bezw  <span class="free">x</span> <span class="free">q</span><span class="main">)</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> snd <span class="main">(</span>bezw <span class="free">x</span> <span class="free">q</span><span class="main">)</span> <span class="main">*</span> int <span class="free">q</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_nat_1 zmod_int<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">x</span> <span class="free">q</span><span class="main">)</span> <span class="main">*</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">x</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">x</span>  <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> cong_def int_eq int_eq' <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prod_not_prime<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="main">(</span><span class="free">x</span><span class="main">::</span>nat<span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">y</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬¨</span> prime <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="free">y</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms One_nat_def Suc_diff_1 nat_neq_iff numeral_2_eq_2 prime_gt_0_nat prime_product<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ex_inverse<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> coprime<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span><span class="free">e</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">P</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="free">Q</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">P</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">Q</span>"</span></span>   
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">‚â†</span> <span class="free">Q</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">‚àÉ</span> <span class="bound">d</span><span class="main">.</span> <span class="main">[</span><span class="free">e</span><span class="main">*</span><span class="bound">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span><span class="free">P</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">‚àß</span> <span class="bound">d</span> <span class="main">‚â†</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">e</span> <span class="main">(</span><span class="free">P</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">e</span><span class="main">*</span><span class="skolem">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span><span class="free">P</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> cong_solve_coprime_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cong_0_1_nat cong_1 mult_0_right zero_neq_one<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ex_k1_k2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> coprime<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span><span class="free">e</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">P</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="free">Q</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">e</span><span class="main">*</span><span class="free">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span><span class="free">P</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">‚àÉ</span> <span class="bound">k1</span> <span class="bound">k2</span><span class="main">.</span> <span class="free">e</span><span class="main">*</span><span class="free">d</span> <span class="main">+</span> <span class="bound">k1</span><span class="main">*</span><span class="main">(</span><span class="free">P</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="bound">k2</span><span class="main">*</span><span class="main">(</span><span class="free">P</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> cong_iff_lin_nat<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ex_k_mod<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> coprime<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span><span class="free">e</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">P</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="free">Q</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">‚â†</span> <span class="free">Q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">P</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">Q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">‚â†</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">" <span class="main">[</span><span class="free">e</span><span class="main">*</span><span class="free">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span><span class="free">P</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">‚àÉ</span> <span class="bound">k</span><span class="main">.</span> <span class="free">e</span><span class="main">*</span><span class="free">d</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="bound">k</span><span class="main">*</span><span class="main">(</span><span class="free">P</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>  
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> prime_gt_0_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span><span class="main">*</span><span class="free">d</span> <span class="main">‚â•</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span><span class="main">*</span><span class="free">d</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">*</span><span class="main">(</span><span class="free">P</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>6<span class="main">)</span> cong_to_1'_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fermat_little<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="main">(</span><span class="free">P</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span><span class="main">^</span><span class="free">P</span> <span class="main">=</span> <span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">dvd</span> <span class="free">x</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">mod</span> <span class="free">P</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">^</span> <span class="free">P</span> <span class="keyword1">mod</span> <span class="free">P</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> True assms prime_dvd_power_nat_iff prime_gt_0_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> fermat_theorem assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms cong_def diff_diff_cancel diff_is_0_eq' diff_zero mod_mult_right_eq power_eq_if power_one_right prime_ge_1_nat zero_le_one<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Uniform_Sampling">
<div class="head">
<h1>Theory Uniform_Sampling</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‚ÄπUniform Sampling‚Ä∫</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‚ÄπHere we prove different one time pad lemmas based on uniform sampling we require throughout our proofs.‚Ä∫</span></span>

<span class="keyword1"><span class="command">theory</span></span> Uniform_Sampling
  <span class="keyword2"><span class="keyword">imports</span></span> 
    <a href="../CryptHOL/Cyclic_Group_SPMF.html">CryptHOL.Cyclic_Group_SPMF</a> 
    <span class="quoted">"<a href="../../HOL/HOL-Number_Theory/Cong.html">HOL-Number_Theory.Cong</a>"</span>
    <a href="../CryptHOL/List_Bits.html">CryptHOL.List_Bits</a>
<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπIf q is a prime we can sample from the units.‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sample_uniform_units</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">‚áí</span> nat spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">sample_uniform_units</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> spmf_of_set <span class="main">(</span><span class="main">{..&lt;</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_spmf_sampl_uni_units <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set_spmf <span class="main">(</span>sample_uniform_units <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">{..&lt;</span> <span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sample_uniform_units_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lossless_sample_uniform_units<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span>sample_uniform_units <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sample_uniform_units_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπGeneral lemma for mapping using uniform sampling from units.‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> one_time_pad_units<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> inj_on<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> sur<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>  
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map_spmf <span class="free">f</span> <span class="main">(</span>sample_uniform_units <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>sample_uniform_units <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> rhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> spmf_of_set <span class="main">(</span><span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sample_uniform_units_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_spmf<span class="main">(</span><span class="main">Œª</span><span class="bound">s</span><span class="main">.</span> <span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>spmf_of_set <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> spmf_of_set <span class="main">(</span><span class="main">(</span><span class="main">Œª</span><span class="bound">s</span><span class="main">.</span> <span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> endo_inj_surj<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sur<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rhs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπGeneral lemma for mapping using uniform sampling.‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> one_time_pad<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> inj_on<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> sur<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">=</span> <span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span>"</span></span>  
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map_spmf <span class="free">f</span> <span class="main">(</span>sample_uniform <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>sample_uniform <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> rhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> spmf_of_set <span class="main">(</span><span class="main">{..&lt;</span> <span class="free">q</span><span class="main">}</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sample_uniform_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_spmf<span class="main">(</span><span class="main">Œª</span><span class="bound">s</span><span class="main">.</span> <span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>spmf_of_set <span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> spmf_of_set <span class="main">(</span><span class="main">(</span><span class="main">Œª</span><span class="bound">s</span><span class="main">.</span> <span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">=</span> <span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> endo_inj_surj<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sur<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rhs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπThe addition map case.‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inj_add<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> x'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x'</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> map<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">x'</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span>  
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">x'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> aa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">x'</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">‚üπ</span> <span class="free">x</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="free">x'</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">y</span><span class="main">::</span> nat<span class="main">)</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">x'</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">‚üπ</span> <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">y</span><span class="main">::</span> nat<span class="main">)</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">x'</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">y</span><span class="main">::</span> nat<span class="main">)</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">x'</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="main">[</span><span class="free">x</span> <span class="main">=</span> <span class="free">x'</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_add_lcancel_nat<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">=</span> <span class="free">x'</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="free">x</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="free">x'</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map 4 5 6<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> bb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="free">x'</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">‚üπ</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x x'<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inj_uni_samp_add<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">b</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="bound">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">)</span> <span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> inj_add<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> surj_uni_samp<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on  <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">b</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="bound">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">)</span> <span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">b</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="bound">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">`</span> <span class="main">{..&lt;</span> <span class="free">q</span><span class="main">}</span> <span class="main">=</span>  <span class="main">{..&lt;</span> <span class="free">q</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> endo_inj_surj<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> inj <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> samp_uni_plus_one_time_pad<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map_spmf <span class="main">(</span><span class="main">Œª</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="bound">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span>sample_uniform <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>sample_uniform <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inj_uni_samp_add surj_uni_samp one_time_pad <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπThe multiplicaton map case.‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inj_mult<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> coprime<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="free">x</span> <span class="main">(</span><span class="free">q</span><span class="main">::</span>nat<span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> y'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y'</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> map<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="free">x</span> <span class="main">*</span> <span class="free">y'</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="free">y'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="free">x</span><span class="main">*</span><span class="free">y'</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">‚üπ</span> <span class="free">y</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="free">y'</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="free">x</span><span class="main">*</span><span class="free">y'</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">‚üπ</span> <span class="main">[</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">=</span> <span class="free">x</span><span class="main">*</span><span class="free">y'</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">=</span> <span class="free">x</span><span class="main">*</span><span class="free">y'</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free">y</span> <span class="main">=</span> <span class="free">y'</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_mult_lcancel_nat coprime<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">y</span> <span class="main">=</span> <span class="free">y'</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="free">y</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="free">y'</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="free">y'</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">‚üπ</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> y y'<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inj_on_mult<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> coprime<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="free">x</span> <span class="main">(</span><span class="free">q</span><span class="main">::</span>nat<span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">Œª</span> <span class="bound">b</span><span class="main">.</span> <span class="free">x</span><span class="main">*</span><span class="bound">b</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> coprime <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> inj_mult<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> surj_on_mult<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> coprime<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="free">x</span> <span class="main">(</span><span class="free">q</span><span class="main">::</span>nat<span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">Œª</span> <span class="bound">b</span><span class="main">.</span> <span class="free">x</span><span class="main">*</span><span class="bound">b</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">Œª</span> <span class="bound">b</span><span class="main">.</span> <span class="free">x</span><span class="main">*</span><span class="bound">b</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">`</span> <span class="main">{..&lt;</span> <span class="free">q</span><span class="main">}</span> <span class="main">=</span> <span class="main">{..&lt;</span> <span class="free">q</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> endo_inj_surj<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> coprime inj <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mult_one_time_pad<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> coprime<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="free">x</span> <span class="free">q</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map_spmf <span class="main">(</span><span class="main">Œª</span> <span class="bound">b</span><span class="main">.</span> <span class="free">x</span><span class="main">*</span><span class="bound">b</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span>sample_uniform <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>sample_uniform <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inj_on_mult surj_on_mult one_time_pad coprime <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπThe multiplication map for sampling from units.‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inj_on_mult_units<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="free">x</span> <span class="main">(</span><span class="free">q</span><span class="main">::</span>nat<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">Œª</span> <span class="bound">b</span><span class="main">.</span> <span class="free">x</span><span class="main">*</span><span class="bound">b</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> inj_mult<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> surj_on_mult_units<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> coprime<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="free">x</span> <span class="main">(</span><span class="free">q</span><span class="main">::</span>nat<span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">Œª</span> <span class="bound">b</span><span class="main">.</span> <span class="free">x</span><span class="main">*</span><span class="bound">b</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">Œª</span> <span class="bound">b</span><span class="main">.</span> <span class="free">x</span><span class="main">*</span><span class="bound">b</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> endo_inj_surj<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> coprime inj <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">Œª</span><span class="bound">b</span><span class="main">.</span> <span class="free">x</span> <span class="main">*</span> <span class="bound">b</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set <span class="main">‚áí</span> <span class="main">(</span>nat <span class="main">‚áí</span> nat<span class="main">)</span> <span class="main">‚áí</span> nat set <span class="main">‚áí</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">‚àÄ</span><span class="bound">x0</span> <span class="bound">x1</span> <span class="bound">x2</span><span class="main">.</span> <span class="main">(</span><span class="main">‚àÉ</span><span class="bound">v3</span><span class="main">.</span> <span class="bound">v3</span> <span class="main">‚àà</span> <span class="bound">x2</span> <span class="main">‚àß</span> <span class="bound">x1</span> <span class="bound">v3</span> <span class="main">‚àâ</span> <span class="bound">x0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span> <span class="bound">x0</span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="main">‚àà</span> <span class="bound">x2</span> <span class="main">‚àß</span> <span class="bound">x1</span> <span class="main">(</span><span class="skolem">n</span> <span class="bound">x0</span> <span class="bound">x1</span> <span class="bound">x2</span><span class="main">)</span> <span class="main">‚àâ</span> <span class="bound">x0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">moura</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">‚àÄ</span><span class="bound">N</span> <span class="bound">f</span> <span class="bound">Na</span><span class="main">.</span> <span class="skolem">n</span> <span class="bound">Na</span> <span class="bound">f</span> <span class="bound">N</span> <span class="main">‚àà</span> <span class="bound">N</span> <span class="main">‚àß</span> <span class="bound">f</span> <span class="main">(</span><span class="skolem">n</span> <span class="bound">Na</span> <span class="bound">f</span> <span class="bound">N</span><span class="main">)</span> <span class="main">‚àâ</span> <span class="bound">Na</span> <span class="main">‚à®</span> <span class="bound">f</span> <span class="main">`</span> <span class="bound">N</span> <span class="main">‚äÜ</span> <span class="bound">Na</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> image_subsetI<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> mem_insert<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">*</span> <span class="skolem">n</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">n</span><span class="main">.</span> <span class="free">x</span> <span class="main">*</span> <span class="bound">n</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">‚àâ</span> <span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">‚à®</span> <span class="free">x</span> <span class="main">*</span> <span class="skolem">n</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">n</span><span class="main">.</span> <span class="free">x</span> <span class="main">*</span> <span class="bound">n</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">‚àà</span> insert <span class="main">0</span> <span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> map_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="skolem">n</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">n</span><span class="main">.</span> <span class="free">x</span> <span class="main">*</span> <span class="bound">n</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">‚àà</span> insert <span class="main">0</span> <span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="skolem">n</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">n</span><span class="main">.</span> <span class="free">x</span> <span class="main">*</span> <span class="bound">n</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">‚àà</span> <span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">*</span> <span class="skolem">n</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">n</span><span class="main">.</span> <span class="free">x</span> <span class="main">*</span> <span class="bound">n</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="free">x</span> <span class="main">*</span> <span class="main">0</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span> <span class="main">‚â§</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span> <span class="main">=</span> <span class="free">q</span><span class="main">)</span> <span class="main">‚à®</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">n</span><span class="main">.</span> <span class="free">x</span> <span class="main">*</span> <span class="bound">n</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">‚àâ</span> <span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">‚à®</span> <span class="skolem">n</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">n</span><span class="main">.</span> <span class="free">x</span> <span class="main">*</span> <span class="bound">n</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">‚àà</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">‚à®</span> <span class="skolem">n</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">n</span><span class="main">.</span> <span class="free">x</span> <span class="main">*</span> <span class="bound">n</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">‚àâ</span> <span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">‚à®</span> <span class="free">x</span> <span class="main">*</span> <span class="skolem">n</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">n</span><span class="main">.</span> <span class="free">x</span> <span class="main">*</span> <span class="bound">n</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">‚àà</span> <span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> antisym_conv1 insertCI lessThan_iff local.coprime inj_mult<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">‚â†</span> <span class="free">x</span> <span class="main">*</span> <span class="skolem">n</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">n</span><span class="main">.</span> <span class="free">x</span> <span class="main">*</span> <span class="bound">n</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">*</span> <span class="skolem">n</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">n</span><span class="main">.</span> <span class="free">x</span> <span class="main">*</span> <span class="bound">n</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">‚àà</span> insert <span class="main">0</span> <span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">‚àß</span> <span class="free">x</span> <span class="main">*</span> <span class="skolem">n</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">n</span><span class="main">.</span> <span class="free">x</span> <span class="main">*</span> <span class="bound">n</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">‚àâ</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">Œª</span><span class="bound">n</span><span class="main">.</span> <span class="free">x</span> <span class="main">*</span> <span class="bound">n</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> map_eq subset <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Diff_iff<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">Œª</span><span class="bound">n</span><span class="main">.</span> <span class="free">x</span> <span class="main">*</span> <span class="bound">n</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">‚à®</span> <span class="main">(</span><span class="main">0</span> <span class="main">‚â§</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span> <span class="main">=</span> <span class="free">q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> mem_insert <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> antisym_conv1 lessThan_iff mod_less_divisor singletonD<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">Œª</span><span class="bound">n</span><span class="main">.</span> <span class="free">x</span> <span class="main">*</span> <span class="bound">n</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">‚à®</span> <span class="skolem">n</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">n</span><span class="main">.</span> <span class="free">x</span> <span class="main">*</span> <span class="bound">n</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">‚àâ</span> <span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">‚à®</span> <span class="free">x</span> <span class="main">*</span> <span class="skolem">n</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">n</span><span class="main">.</span> <span class="free">x</span> <span class="main">*</span> <span class="bound">n</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">‚àà</span> <span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">Œª</span><span class="bound">n</span><span class="main">.</span> <span class="free">x</span> <span class="main">*</span> <span class="bound">n</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">‚äÜ</span> <span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">Œª</span><span class="bound">b</span><span class="main">.</span> <span class="free">x</span> <span class="main">*</span> <span class="bound">b</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mult_one_time_pad_units<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> coprime<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="free">x</span> <span class="free">q</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map_spmf <span class="main">(</span><span class="main">Œª</span> <span class="bound">b</span><span class="main">.</span> <span class="free">x</span><span class="main">*</span><span class="bound">b</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span>sample_uniform_units <span class="free">q</span><span class="main">)</span> <span class="main">=</span> sample_uniform_units <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inj_on_mult_units surj_on_mult_units one_time_pad_units coprime <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπAddition and multiplication map.‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> samp_uni_add_mult<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> coprime<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="free">x</span> <span class="main">(</span><span class="free">q</span><span class="main">::</span>nat<span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> xa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xa</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> ya<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ya</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> map<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span> <span class="free">ya</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xa</span> <span class="main">=</span> <span class="free">ya</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span> <span class="free">ya</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">‚üπ</span> <span class="free">xa</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="free">ya</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span> <span class="free">ya</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">‚üπ</span> <span class="main">[</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="free">xa</span> <span class="main">=</span> <span class="free">y</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span><span class="free">ya</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cong_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="free">xa</span> <span class="main">=</span> <span class="free">y</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span><span class="free">ya</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="main">[</span><span class="free">xa</span> <span class="main">=</span> <span class="free">ya</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_add_lcancel_nat<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coprime cong_mult_lcancel_nat<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def map<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xa</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="free">ya</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">‚üπ</span> <span class="free">xa</span> <span class="main">=</span> <span class="free">ya</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> xa ya<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inj_on_add_mult<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> coprime<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="free">x</span> <span class="main">(</span><span class="free">q</span><span class="main">::</span>nat<span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">Œª</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="bound">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> coprime <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> samp_uni_add_mult<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> surj_on_add_mult<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> coprime<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="free">x</span> <span class="main">(</span><span class="free">q</span><span class="main">::</span>nat<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">Œª</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="bound">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">Œª</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="bound">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">`</span> <span class="main">{..&lt;</span> <span class="free">q</span><span class="main">}</span> <span class="main">=</span> <span class="main">{..&lt;</span> <span class="free">q</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> endo_inj_surj<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> coprime inj <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> add_mult_one_time_pad<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> coprime<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="free">x</span> <span class="free">q</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map_spmf <span class="main">(</span><span class="main">Œª</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="bound">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span>sample_uniform <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>sample_uniform <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inj_on_add_mult surj_on_add_mult one_time_pad coprime <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπSubtraction Map.‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inj_minus<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> ya<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ya</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> map<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">ya</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">ya</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">ya</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">‚üπ</span> <span class="free">x</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="free">ya</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">ya</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">‚üπ</span> <span class="main">[</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">ya</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cong_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">ya</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="main">[</span><span class="free">q</span> <span class="main">-</span> <span class="free">x</span> <span class="main">=</span> <span class="free">q</span> <span class="main">-</span> <span class="free">ya</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x ya cong_add_lcancel_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">ya</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="main">[</span><span class="free">q</span> <span class="main">+</span> <span class="free">x</span> <span class="main">=</span> <span class="free">q</span> <span class="main">+</span> <span class="free">ya</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_diff_inverse_nat calculation<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> cong_add_lcancel_nat cong_add_rcancel_nat cong_sym less_imp_le_nat not_le x ya<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def map<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="free">ya</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">‚üπ</span> <span class="free">x</span> <span class="main">=</span> <span class="free">ya</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x ya<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inj_on_minus<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on  <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">b</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">)</span> <span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def inj_minus<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> surj_on_minus<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on  <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">b</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">)</span> <span class="main">{..&lt;</span><span class="free">q</span><span class="main">}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">b</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">`</span> <span class="main">{..&lt;</span> <span class="free">q</span><span class="main">}</span> <span class="main">=</span> <span class="main">{..&lt;</span> <span class="free">q</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> endo_inj_surj<span class="main">)</span> 
  <span class="keyword1"><span class="command">using</span></span> inj <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> samp_uni_minus_one_time_pad<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map_spmf<span class="main">(</span><span class="main">Œª</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span>sample_uniform <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>sample_uniform <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inj_on_minus surj_on_minus one_time_pad <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> not_coin_flip<span class="main">:</span> <span class="quoted"><span class="quoted">"map_spmf <span class="main">(</span><span class="main">Œª</span> <span class="bound">a</span><span class="main">.</span> <span class="main">¬¨</span> <span class="bound">a</span><span class="main">)</span> coin_spmf <span class="main">=</span> coin_spmf"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on Not <span class="main">{</span>True<span class="main">,</span> False<span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"Not <span class="main">`</span> <span class="main">{</span>True<span class="main">,</span> False<span class="main">}</span> <span class="main">=</span> <span class="main">{</span>True<span class="main">,</span> False<span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> one_time_pad 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> UNIV_bool<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> xor_uni_samp<span class="main">:</span> <span class="quoted"><span class="quoted">"map_spmf<span class="main">(</span><span class="main">Œª</span> <span class="bound">b</span><span class="main">.</span> <span class="free">y</span> <span class="main">‚äï</span> <span class="bound">b</span><span class="main">)</span> <span class="main">(</span>coin_spmf<span class="main">)</span> <span class="main">=</span> map_spmf<span class="main">(</span><span class="main">Œª</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">b</span><span class="main">)</span> <span class="main">(</span>coin_spmf<span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> rhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> spmf_of_set <span class="main">{</span>True<span class="main">,</span> False<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> UNIV_bool insert_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_spmf<span class="main">(</span><span class="main">Œª</span> <span class="bound">b</span><span class="main">.</span> <span class="free">y</span> <span class="main">‚äï</span> <span class="bound">b</span><span class="main">)</span> <span class="main">(</span>spmf_of_set <span class="main">{</span>True<span class="main">,</span> False<span class="main">}</span><span class="main">)</span> <span class="main">=</span> spmf_of_set<span class="main">(</span><span class="main">(</span><span class="main">Œª</span> <span class="bound">b</span><span class="main">.</span> <span class="free">y</span> <span class="main">‚äï</span> <span class="bound">b</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span>True<span class="main">,</span> False<span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> xor_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">Œª</span> <span class="bound">b</span><span class="main">.</span> xor <span class="free">y</span> <span class="bound">b</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span>True<span class="main">,</span> False<span class="main">}</span> <span class="main">=</span> <span class="main">{</span>True<span class="main">,</span> False<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> xor_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rhs <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Semi_Honest_Def">
<div class="head">
<h1>Theory Semi_Honest_Def</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‚ÄπSemi-Honest Security‚Ä∫</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπWe follow the security definitions for the semi honest setting as described in \cite{DBLP:books/sp/17/Lindell17}.
In the semi honest model the parties are assumed not to deviate from the protocol transcript. 
Semi honest security guarantees that no information is leaked during the running of the protocol.‚Ä∫</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπSecurity definitions‚Ä∫</span></span>

<span class="keyword1"><span class="command">theory</span></span> Semi_Honest_Def <span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../CryptHOL/CryptHOL.html">CryptHOL.CryptHOL</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπSecurity for deterministic functionalities‚Ä∫</span></span>

<span class="keyword1"><span class="command">locale</span></span> sim_det_def <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">R1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'msg1</span> <span class="main">‚áí</span> <span class="tfree">'msg2</span> <span class="main">‚áí</span> <span class="tfree">'view1</span> spmf"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">S1</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'msg1</span> <span class="main">‚áí</span> <span class="tfree">'out1</span> <span class="main">‚áí</span> <span class="tfree">'view1</span> spmf"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">R2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'msg1</span> <span class="main">‚áí</span> <span class="tfree">'msg2</span> <span class="main">‚áí</span> <span class="tfree">'view2</span> spmf"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">S2</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'msg2</span> <span class="main">‚áí</span> <span class="tfree">'out2</span> <span class="main">‚áí</span> <span class="tfree">'view2</span> spmf"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">funct</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'msg1</span> <span class="main">‚áí</span> <span class="tfree">'msg2</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'out1</span> <span class="main">√ó</span> <span class="tfree">'out2</span><span class="main">)</span> spmf"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">protocol</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'msg1</span> <span class="main">‚áí</span> <span class="tfree">'msg2</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'out1</span> <span class="main">√ó</span> <span class="tfree">'out2</span><span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lossless_R1<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span><span class="free">R1</span> <span class="free">m1</span> <span class="free">m2</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> lossless_S1<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span><span class="free">S1</span> <span class="free">m1</span> <span class="free">out1</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> lossless_R2<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span><span class="free">R2</span> <span class="free">m1</span> <span class="free">m2</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> lossless_S2<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span><span class="free">S2</span> <span class="free">m2</span> <span class="free">out2</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> lossless_funct<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span><span class="free">funct</span> <span class="free">m1</span> <span class="free">m2</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'view'</span> adversary_det <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'view'</span> <span class="main">‚áí</span> bool spmf"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">correctness</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">‚â°</span> <span class="main">(</span><span class="free">protocol</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">=</span> <span class="free">funct</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">adv_P1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'msg1</span> <span class="main">‚áí</span> <span class="tfree">'msg2</span> <span class="main">‚áí</span> <span class="tfree">'view1</span> adversary_det <span class="main">‚áí</span> real"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">adv_P1</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">‚â°</span> <span class="main">¬¶</span><span class="main">(</span>spmf <span class="main">(</span><span class="free">R1</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">‚§ú</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> True<span class="main">)</span> 
            <span class="main">-</span> spmf <span class="main">(</span><span class="free">funct</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">o1</span><span class="main">,</span> <span class="bound">o2</span><span class="main">)</span><span class="main">.</span> <span class="free">S1</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="bound">o1</span> <span class="main">‚§ú</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">perfect_sec_P1</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">‚â°</span> <span class="main">(</span><span class="free">R1</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">=</span> <span class="free">funct</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">s1</span><span class="main">,</span> <span class="bound">s2</span><span class="main">)</span><span class="main">.</span> <span class="free">S1</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="bound">s1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">adv_P2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'msg1</span> <span class="main">‚áí</span> <span class="tfree">'msg2</span> <span class="main">‚áí</span> <span class="tfree">'view2</span> adversary_det <span class="main">‚áí</span> real"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">adv_P2</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">=</span> <span class="main">¬¶</span>spmf <span class="main">(</span><span class="free">R2</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="bound">view</span><span class="main">)</span><span class="main">)</span> True 
            <span class="main">-</span> spmf <span class="main">(</span><span class="free">funct</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">o1</span><span class="main">,</span> <span class="bound">o2</span><span class="main">)</span><span class="main">.</span> <span class="free">S2</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="bound">o2</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="bound">view</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">perfect_sec_P2</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">‚â°</span> <span class="main">(</span><span class="free">R2</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">=</span> <span class="free">funct</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">s1</span><span class="main">,</span> <span class="bound">s2</span><span class="main">)</span><span class="main">.</span> <span class="free">S2</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="bound">s2</span><span class="main">)</span><span class="main">)</span>"</span></span>
 
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπWe also define the security games (for Party 1 and 2) used in EasyCrypt to define semi honest security for Party 1. 
We then show the two definitions are equivalent.‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">P1_game_alt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'msg1</span> <span class="main">‚áí</span> <span class="tfree">'msg2</span> <span class="main">‚áí</span> <span class="tfree">'view1</span> adversary_det <span class="main">‚áí</span> bool spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">P1_game_alt</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">b</span> <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="main">(</span><span class="bound">out1</span><span class="main">,</span> <span class="bound">out2</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="free">funct</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">;</span>
    <span class="bound">rview</span> <span class="main">::</span> <span class="tfree">'view1</span> <span class="main">‚Üê</span> <span class="free">R1</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">;</span>
    <span class="bound">sview</span> <span class="main">::</span> <span class="tfree">'view1</span> <span class="main">‚Üê</span> <span class="free">S1</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="bound">out1</span><span class="main">;</span>
    <span class="bound">b'</span> <span class="main">‚Üê</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="bound">rview</span> <span class="keyword1">else</span> <span class="bound">sview</span><span class="main">)</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="bound">b</span> <span class="main">=</span> <span class="bound">b'</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">adv_P1_game</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'msg1</span> <span class="main">‚áí</span> <span class="tfree">'msg2</span> <span class="main">‚áí</span> <span class="tfree">'view1</span> adversary_det <span class="main">‚áí</span> real"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">adv_P1_game</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">=</span> <span class="main">¬¶</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span>spmf <span class="main">(</span>P1_game_alt <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">)</span> True<span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">¬¶</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπWe show the two definitions are equivalent‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> equiv_defs_P1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lossless_D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">‚àÄ</span> <span class="bound">view</span><span class="main">.</span> lossless_spmf <span class="main">(</span><span class="main">(</span><span class="free">D</span><span class="main">::</span> <span class="tfree">'view1</span> adversary_det<span class="main">)</span> <span class="bound">view</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"adv_P1_game <span class="free">m1</span> <span class="free">m2</span> <span class="free">D</span> <span class="main">=</span> adv_P1 <span class="free">m1</span> <span class="free">m2</span> <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">including</span></span> monad_normalisation
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> return_True_not_False<span class="main">:</span> <span class="quoted"><span class="quoted">"spmf <span class="main">(</span>return_spmf <span class="main">(</span><span class="skolem">b</span><span class="main">)</span><span class="main">)</span> True <span class="main">=</span> spmf <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">¬¨</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span> False"</span></span> 
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">b</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> lossless_ideal<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span><span class="main">(</span><span class="free">funct</span> <span class="free">m1</span> <span class="free">m2</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">out1</span><span class="main">,</span> <span class="bound">out2</span><span class="main">)</span><span class="main">.</span> <span class="free">S1</span> <span class="free">m1</span> <span class="bound">out1</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">sview</span><span class="main">.</span> <span class="free">D</span> <span class="bound">sview</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">b'</span><span class="main">.</span> return_spmf <span class="main">(</span>False <span class="main">=</span> <span class="bound">b'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lossless_S1 lossless_funct lossless_weight_spmfD split_def lossless_D<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> return<span class="main">:</span> <span class="quoted"><span class="quoted">"spmf <span class="main">(</span><span class="free">funct</span> <span class="free">m1</span> <span class="free">m2</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">o1</span><span class="main">,</span> <span class="bound">o2</span><span class="main">)</span><span class="main">.</span> <span class="free">S1</span> <span class="free">m1</span> <span class="bound">o1</span> <span class="main">‚§ú</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span> True 
                  <span class="main">=</span> spmf <span class="main">(</span><span class="free">funct</span> <span class="free">m1</span> <span class="free">m2</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">o1</span><span class="main">,</span> <span class="bound">o2</span><span class="main">)</span><span class="main">.</span> <span class="free">S1</span> <span class="free">m1</span> <span class="bound">o1</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="free">D</span> <span class="bound">view</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">b</span><span class="main">.</span> return_spmf <span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">*</span><span class="main">(</span>spmf <span class="main">(</span>P1_game_alt <span class="free">m1</span> <span class="free">m2</span> <span class="free">D</span> <span class="main">)</span> True<span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="main">(</span>spmf <span class="main">(</span><span class="free">R1</span> <span class="free">m1</span> <span class="free">m2</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">rview</span><span class="main">.</span> <span class="free">D</span> <span class="bound">rview</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">b'</span><span class="main">::</span> bool<span class="main">)</span><span class="main">.</span> return_spmf <span class="main">(</span>True <span class="main">=</span> <span class="bound">b'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True
        <span class="main">-</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span>spmf <span class="main">(</span><span class="free">funct</span> <span class="free">m1</span> <span class="free">m2</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">out1</span><span class="main">,</span> <span class="bound">out2</span><span class="main">)</span><span class="main">.</span> <span class="free">S1</span> <span class="free">m1</span> <span class="bound">out1</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">sview</span><span class="main">.</span> <span class="free">D</span> <span class="bound">sview</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">b'</span><span class="main">.</span> return_spmf <span class="main">(</span>False <span class="main">=</span> <span class="bound">b'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_bind integral_spmf_of_set adv_P1_game_def P1_game_alt_def spmf_of_set
          UNIV_bool bind_spmf_const lossless_R1 lossless_S1 lossless_funct lossless_weight_spmfD<span class="main">)</span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"adv_P1_game <span class="free">m1</span> <span class="free">m2</span> <span class="free">D</span> <span class="main">=</span> <span class="main">¬¶</span><span class="main">(</span>spmf <span class="main">(</span><span class="free">R1</span> <span class="free">m1</span> <span class="free">m2</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">rview</span><span class="main">.</span> <span class="free">D</span> <span class="bound">rview</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">b'</span><span class="main">::</span> bool<span class="main">)</span><span class="main">.</span> return_spmf <span class="main">(</span>True <span class="main">=</span> <span class="bound">b'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True
        <span class="main">-</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span>spmf <span class="main">(</span><span class="free">funct</span> <span class="free">m1</span> <span class="free">m2</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">out1</span><span class="main">,</span> <span class="bound">out2</span><span class="main">)</span><span class="main">.</span> <span class="free">S1</span> <span class="free">m1</span> <span class="bound">out1</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">sview</span><span class="main">.</span> <span class="free">D</span> <span class="bound">sview</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">b'</span><span class="main">.</span> return_spmf <span class="main">(</span>False <span class="main">=</span> <span class="bound">b'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">)</span><span class="main">¬¶</span>"</span></span> 
     <span class="keyword1"><span class="command">using</span></span> adv_P1_game_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬¶</span><span class="main">(</span>spmf <span class="main">(</span><span class="free">R1</span> <span class="free">m1</span> <span class="free">m2</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">rview</span><span class="main">.</span> <span class="free">D</span> <span class="bound">rview</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">b'</span><span class="main">::</span> bool<span class="main">)</span><span class="main">.</span> return_spmf <span class="main">(</span>True <span class="main">=</span> <span class="bound">b'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True
                      <span class="main">-</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span>spmf <span class="main">(</span><span class="free">funct</span> <span class="free">m1</span> <span class="free">m2</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">out1</span><span class="main">,</span> <span class="bound">out2</span><span class="main">)</span><span class="main">.</span> <span class="free">S1</span> <span class="free">m1</span> <span class="bound">out1</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">sview</span><span class="main">.</span> <span class="free">D</span> <span class="bound">sview</span> 
                            <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">b'</span><span class="main">.</span> return_spmf <span class="main">(</span>False <span class="main">=</span> <span class="bound">b'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">)</span><span class="main">¬¶</span> <span class="main">=</span> adv_P1 <span class="free">m1</span> <span class="free">m2</span> <span class="free">D</span>"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> adv_P1_def spmf_False_conv_True<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> lossless_ideal<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> return<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> split_def spmf_bind return_True_not_False<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">P2_game_alt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'msg1</span> <span class="main">‚áí</span> <span class="tfree">'msg2</span> <span class="main">‚áí</span> <span class="tfree">'view2</span> adversary_det <span class="main">‚áí</span> bool spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">P2_game_alt</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">b</span> <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="main">(</span><span class="bound">out1</span><span class="main">,</span> <span class="bound">out2</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="free">funct</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">;</span>
    <span class="bound">rview</span> <span class="main">::</span> <span class="tfree">'view2</span> <span class="main">‚Üê</span> <span class="free">R2</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">;</span>
    <span class="bound">sview</span> <span class="main">::</span> <span class="tfree">'view2</span> <span class="main">‚Üê</span> <span class="free">S2</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="bound">out2</span><span class="main">;</span>
    <span class="bound">b'</span> <span class="main">‚Üê</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="bound">rview</span> <span class="keyword1">else</span> <span class="bound">sview</span><span class="main">)</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="bound">b</span> <span class="main">=</span> <span class="bound">b'</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">adv_P2_game</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'msg1</span> <span class="main">‚áí</span> <span class="tfree">'msg2</span> <span class="main">‚áí</span> <span class="tfree">'view2</span> adversary_det <span class="main">‚áí</span> real"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">adv_P2_game</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">=</span> <span class="main">¬¶</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span>spmf <span class="main">(</span>P2_game_alt <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">)</span> True<span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">¬¶</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> equiv_defs_P2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lossless_D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">‚àÄ</span> <span class="bound">view</span><span class="main">.</span> lossless_spmf <span class="main">(</span><span class="main">(</span><span class="free">D</span><span class="main">::</span> <span class="tfree">'view2</span> adversary_det<span class="main">)</span> <span class="bound">view</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"adv_P2_game <span class="free">m1</span> <span class="free">m2</span> <span class="free">D</span> <span class="main">=</span> adv_P2 <span class="free">m1</span> <span class="free">m2</span> <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">including</span></span> monad_normalisation
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> return_True_not_False<span class="main">:</span> <span class="quoted"><span class="quoted">"spmf <span class="main">(</span>return_spmf <span class="main">(</span><span class="skolem">b</span><span class="main">)</span><span class="main">)</span> True <span class="main">=</span> spmf <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">¬¨</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span> False"</span></span> 
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">b</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> lossless_ideal<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span><span class="main">(</span><span class="free">funct</span> <span class="free">m1</span> <span class="free">m2</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">out1</span><span class="main">,</span> <span class="bound">out2</span><span class="main">)</span><span class="main">.</span> <span class="free">S2</span> <span class="free">m2</span> <span class="bound">out2</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">sview</span><span class="main">.</span> <span class="free">D</span> <span class="bound">sview</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">b'</span><span class="main">.</span> return_spmf <span class="main">(</span>False <span class="main">=</span> <span class="bound">b'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lossless_S2 lossless_funct lossless_weight_spmfD split_def lossless_D<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> return<span class="main">:</span> <span class="quoted"><span class="quoted">"spmf <span class="main">(</span><span class="free">funct</span> <span class="free">m1</span> <span class="free">m2</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">o1</span><span class="main">,</span> <span class="bound">o2</span><span class="main">)</span><span class="main">.</span> <span class="free">S2</span> <span class="free">m2</span> <span class="bound">o2</span> <span class="main">‚§ú</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span> True <span class="main">=</span> spmf <span class="main">(</span><span class="free">funct</span> <span class="free">m1</span> <span class="free">m2</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">o1</span><span class="main">,</span> <span class="bound">o2</span><span class="main">)</span><span class="main">.</span> <span class="free">S2</span> <span class="free">m2</span> <span class="bound">o2</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="free">D</span> <span class="bound">view</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">b</span><span class="main">.</span> return_spmf <span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">*</span><span class="main">(</span>spmf <span class="main">(</span>P2_game_alt <span class="free">m1</span> <span class="free">m2</span> <span class="free">D</span> <span class="main">)</span> True<span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="main">(</span>spmf <span class="main">(</span><span class="free">R2</span> <span class="free">m1</span> <span class="free">m2</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">rview</span><span class="main">.</span> <span class="free">D</span> <span class="bound">rview</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">b'</span><span class="main">::</span> bool<span class="main">)</span><span class="main">.</span> return_spmf <span class="main">(</span>True <span class="main">=</span> <span class="bound">b'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True
        <span class="main">-</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span>spmf <span class="main">(</span><span class="free">funct</span> <span class="free">m1</span> <span class="free">m2</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">out1</span><span class="main">,</span> <span class="bound">out2</span><span class="main">)</span><span class="main">.</span> <span class="free">S2</span> <span class="free">m2</span> <span class="bound">out2</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">sview</span><span class="main">.</span> <span class="free">D</span> <span class="bound">sview</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">b'</span><span class="main">.</span> return_spmf <span class="main">(</span>False <span class="main">=</span> <span class="bound">b'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_bind integral_spmf_of_set adv_P1_game_def P2_game_alt_def spmf_of_set 
          UNIV_bool bind_spmf_const lossless_R2 lossless_S2 lossless_funct lossless_weight_spmfD<span class="main">)</span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"adv_P2_game <span class="free">m1</span> <span class="free">m2</span> <span class="free">D</span> <span class="main">=</span> <span class="main">¬¶</span><span class="main">(</span>spmf <span class="main">(</span><span class="free">R2</span> <span class="free">m1</span> <span class="free">m2</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">rview</span><span class="main">.</span> <span class="free">D</span> <span class="bound">rview</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">b'</span><span class="main">::</span> bool<span class="main">)</span><span class="main">.</span> return_spmf <span class="main">(</span>True <span class="main">=</span> <span class="bound">b'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True
        <span class="main">-</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span>spmf <span class="main">(</span><span class="free">funct</span> <span class="free">m1</span> <span class="free">m2</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">out1</span><span class="main">,</span> <span class="bound">out2</span><span class="main">)</span><span class="main">.</span> <span class="free">S2</span> <span class="free">m2</span> <span class="bound">out2</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">sview</span><span class="main">.</span> <span class="free">D</span> <span class="bound">sview</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">b'</span><span class="main">.</span> return_spmf <span class="main">(</span>False <span class="main">=</span> <span class="bound">b'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">)</span><span class="main">¬¶</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> adv_P2_game_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬¶</span><span class="main">(</span>spmf <span class="main">(</span><span class="free">R2</span> <span class="free">m1</span> <span class="free">m2</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">rview</span><span class="main">.</span> <span class="free">D</span> <span class="bound">rview</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">b'</span><span class="main">::</span> bool<span class="main">)</span><span class="main">.</span> return_spmf <span class="main">(</span>True <span class="main">=</span> <span class="bound">b'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True
        <span class="main">-</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span>spmf <span class="main">(</span><span class="free">funct</span> <span class="free">m1</span> <span class="free">m2</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">out1</span><span class="main">,</span> <span class="bound">out2</span><span class="main">)</span><span class="main">.</span> <span class="free">S2</span> <span class="free">m2</span> <span class="bound">out2</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">sview</span><span class="main">.</span> <span class="free">D</span> <span class="bound">sview</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">b'</span><span class="main">.</span> return_spmf <span class="main">(</span>False <span class="main">=</span> <span class="bound">b'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">)</span><span class="main">¬¶</span> <span class="main">=</span> adv_P2 <span class="free">m1</span> <span class="free">m2</span> <span class="free">D</span>"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> adv_P2_def spmf_False_conv_True<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> lossless_ideal<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> return<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> split_def spmf_bind return_True_not_False<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> 

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‚Äπ Security definitions for non deterministic functionalities ‚Ä∫</span></span>

<span class="keyword1"><span class="command">locale</span></span> sim_non_det_def <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">R1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'msg1</span> <span class="main">‚áí</span> <span class="tfree">'msg2</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'view1</span> <span class="main">√ó</span> <span class="main">(</span><span class="tfree">'out1</span> <span class="main">√ó</span> <span class="tfree">'out2</span><span class="main">)</span><span class="main">)</span> spmf"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">S1</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'msg1</span> <span class="main">‚áí</span> <span class="tfree">'out1</span> <span class="main">‚áí</span> <span class="tfree">'view1</span> spmf"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Out1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'msg1</span> <span class="main">‚áí</span> <span class="tfree">'msg2</span> <span class="main">‚áí</span> <span class="tfree">'out1</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'out1</span> <span class="main">√ó</span> <span class="tfree">'out2</span><span class="main">)</span> spmf"</span></span> <span class="comment1">‚Äï ‚Äπtakes the input of the other party so can form the outputs of parties‚Ä∫</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">R2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'msg1</span> <span class="main">‚áí</span> <span class="tfree">'msg2</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'view2</span> <span class="main">√ó</span> <span class="main">(</span><span class="tfree">'out1</span> <span class="main">√ó</span> <span class="tfree">'out2</span><span class="main">)</span><span class="main">)</span> spmf"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">S2</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'msg2</span> <span class="main">‚áí</span> <span class="tfree">'out2</span> <span class="main">‚áí</span> <span class="tfree">'view2</span> spmf"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Out2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'msg2</span> <span class="main">‚áí</span> <span class="tfree">'msg1</span> <span class="main">‚áí</span> <span class="tfree">'out2</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'out1</span> <span class="main">√ó</span> <span class="tfree">'out2</span><span class="main">)</span> spmf"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">funct</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'msg1</span> <span class="main">‚áí</span> <span class="tfree">'msg2</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'out1</span> <span class="main">√ó</span> <span class="tfree">'out2</span><span class="main">)</span> spmf"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'view'</span><span class="main">,</span> <span class="tfree">'out1'</span><span class="main">,</span> <span class="tfree">'out2'</span><span class="main">)</span> adversary_non_det <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'view'</span> <span class="main">√ó</span> <span class="main">(</span><span class="tfree">'out1'</span> <span class="main">√ó</span> <span class="tfree">'out2'</span><span class="main">)</span><span class="main">)</span> <span class="main">‚áí</span> bool spmf"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Ideal1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'msg1</span> <span class="main">‚áí</span> <span class="tfree">'msg2</span> <span class="main">‚áí</span> <span class="tfree">'out1</span>  <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'view1</span> <span class="main">√ó</span> <span class="main">(</span><span class="tfree">'out1</span> <span class="main">√ó</span> <span class="tfree">'out2</span><span class="main">)</span><span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ideal1</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">out1</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">view1</span> <span class="main">::</span> <span class="tfree">'view1</span> <span class="main">‚Üê</span> <span class="free">S1</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">out1</span></span></span><span class="main">;</span>
    <span class="bound">out1</span> <span class="main">‚Üê</span> <span class="free">Out1</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">out1</span></span></span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="bound">view1</span><span class="main">,</span> <span class="bound">out1</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Ideal2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'msg2</span> <span class="main">‚áí</span> <span class="tfree">'msg1</span> <span class="main">‚áí</span> <span class="tfree">'out2</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'view2</span> <span class="main">√ó</span> <span class="main">(</span><span class="tfree">'out1</span> <span class="main">√ó</span> <span class="tfree">'out2</span><span class="main">)</span><span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ideal2</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">out2</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">view2</span> <span class="main">::</span> <span class="tfree">'view2</span> <span class="main">‚Üê</span> <span class="free">S2</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">out2</span></span></span><span class="main">;</span>
    <span class="bound">out2</span> <span class="main">‚Üê</span> <span class="free">Out2</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">out2</span></span></span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="bound">view2</span><span class="main">,</span> <span class="bound">out2</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">adv_P1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'msg1</span> <span class="main">‚áí</span> <span class="tfree">'msg2</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'view1</span><span class="main">,</span> <span class="tfree">'out1</span><span class="main">,</span> <span class="tfree">'out2</span><span class="main">)</span> adversary_non_det <span class="main">‚áí</span> real"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">adv_P1</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">‚â°</span> <span class="main">¬¶</span><span class="main">(</span>spmf <span class="main">(</span><span class="free">R1</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="bound">view</span><span class="main">)</span><span class="main">)</span> True<span class="main">)</span> <span class="main">-</span> spmf <span class="main">(</span><span class="free">funct</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">o1</span><span class="main">,</span> <span class="bound">o2</span><span class="main">)</span><span class="main">.</span> Ideal1 <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="bound">o1</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="bound">view</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">perfect_sec_P1</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">‚â°</span> <span class="main">(</span><span class="free">R1</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">=</span> <span class="free">funct</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">s1</span><span class="main">,</span> <span class="bound">s2</span><span class="main">)</span><span class="main">.</span> Ideal1 <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="bound">s1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">adv_P2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'msg1</span> <span class="main">‚áí</span> <span class="tfree">'msg2</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'view2</span><span class="main">,</span> <span class="tfree">'out1</span><span class="main">,</span> <span class="tfree">'out2</span><span class="main">)</span> adversary_non_det <span class="main">‚áí</span> real"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">adv_P2</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">=</span> <span class="main">¬¶</span>spmf <span class="main">(</span><span class="free">R2</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="bound">view</span><span class="main">)</span><span class="main">)</span> True <span class="main">-</span> spmf <span class="main">(</span><span class="free">funct</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">o1</span><span class="main">,</span> <span class="bound">o2</span><span class="main">)</span><span class="main">.</span> Ideal2 <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="bound">o2</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="bound">view</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">perfect_sec_P2</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">‚â°</span> <span class="main">(</span><span class="free">R2</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">=</span> <span class="free">funct</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">s1</span><span class="main">,</span> <span class="bound">s2</span><span class="main">)</span><span class="main">.</span> Ideal2 <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="bound">s2</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span> 

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‚Äπ Secret sharing schemes ‚Ä∫</span></span>

<span class="keyword1"><span class="command">locale</span></span> secret_sharing_scheme <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">share</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'input_out</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'share</span> <span class="main">√ó</span> <span class="tfree">'share</span><span class="main">)</span> spmf"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">reconstruct</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'share</span> <span class="main">√ó</span> <span class="tfree">'share</span><span class="main">)</span> <span class="main">‚áí</span> <span class="tfree">'input_out</span> spmf"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">F</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'input_out</span> <span class="main">‚áí</span> <span class="tfree">'input_out</span> <span class="main">‚áí</span> <span class="tfree">'input_out</span> spmf<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">sharing_correct</span> <span class="free"><span class="bound"><span class="entity">input</span></span></span> <span class="main">‚â°</span> <span class="main">(</span><span class="free">share</span> <span class="free"><span class="bound"><span class="entity">input</span></span></span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">s1</span><span class="main">,</span><span class="bound">s2</span><span class="main">)</span><span class="main">.</span> <span class="free">reconstruct</span> <span class="main">(</span><span class="bound">s1</span><span class="main">,</span><span class="bound">s2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> return_spmf <span class="free"><span class="bound"><span class="entity">input</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">correct_share_eval</span> <span class="free"><span class="bound"><span class="entity">input1</span></span></span> <span class="free"><span class="bound"><span class="entity">input2</span></span></span> <span class="main">‚â°</span> <span class="main">(</span><span class="main">‚àÄ</span> <span class="bound">gate_eval</span> <span class="main">‚àà</span> <span class="free">F</span><span class="main">.</span> 
              <span class="main">‚àÉ</span> <span class="bound">gate_protocol</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'share</span> <span class="main">√ó</span> <span class="tfree">'share</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'share</span> <span class="main">√ó</span> <span class="tfree">'share</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'share</span> <span class="main">√ó</span> <span class="tfree">'share</span><span class="main">)</span> spmf<span class="main">.</span> 
                  <span class="free">share</span> <span class="free"><span class="bound"><span class="entity">input1</span></span></span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">s1</span><span class="main">,</span><span class="bound">s2</span><span class="main">)</span><span class="main">.</span> <span class="free">share</span> <span class="free"><span class="bound"><span class="entity">input2</span></span></span> 
                      <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">s3</span><span class="main">,</span><span class="bound">s4</span><span class="main">)</span><span class="main">.</span> <span class="bound">gate_protocol</span> <span class="main">(</span><span class="bound">s1</span><span class="main">,</span><span class="bound">s3</span><span class="main">)</span> <span class="main">(</span><span class="bound">s2</span><span class="main">,</span><span class="bound">s4</span><span class="main">)</span> 
                          <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">S1</span><span class="main">,</span><span class="bound">S2</span><span class="main">)</span><span class="main">.</span> <span class="free">reconstruct</span> <span class="main">(</span><span class="bound">S1</span><span class="main">,</span><span class="bound">S2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="bound">gate_eval</span> <span class="free"><span class="bound"><span class="entity">input1</span></span></span> <span class="free"><span class="bound"><span class="entity">input2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="OT_Functionalities">
<div class="head">
<h1>Theory OT_Functionalities</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπOblivious Transfer functionalities‚Ä∫</span></span> 

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‚ÄπHere we define the functionalities for 1-out-of-2 and 1-out-of-4 OT.‚Ä∫</span></span>

<span class="keyword1"><span class="command">theory</span></span> OT_Functionalities <span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../CryptHOL/CryptHOL.html">CryptHOL.CryptHOL</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">funct_OT_12</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">√ó</span>  <span class="tfree">'a</span><span class="main">)</span> <span class="main">‚áí</span> bool <span class="main">‚áí</span> <span class="main">(</span>unit <span class="main">√ó</span> <span class="tfree">'a</span><span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">funct_OT_12</span> <span class="free"><span class="bound"><span class="entity">input<span class="hidden">‚á©</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="main">=</span> return_spmf <span class="main">(</span><span class="main">()</span> <span class="main">,</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="keyword1">then</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">input<span class="hidden">‚á©</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">input<span class="hidden">‚á©</span><sub>1</sub></span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lossless_funct_OT_12<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span>funct_OT_12 <span class="free">msgs</span> <span class="free">œÉ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> funct_OT_12_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">funct_OT_14</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">√ó</span> <span class="tfree">'a</span> <span class="main">√ó</span> <span class="tfree">'a</span> <span class="main">√ó</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span>unit <span class="main">√ó</span> <span class="tfree">'a</span><span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">funct_OT_14</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">c0</span><span class="main">,</span><span class="bound">c1</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">m00</span><span class="main">,</span> <span class="bound">m01</span><span class="main">,</span> <span class="bound">m10</span><span class="main">,</span> <span class="bound">m11</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">()</span><span class="main">,</span><span class="keyword1">if</span> <span class="bound">c0</span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">c1</span> <span class="keyword1">then</span> <span class="bound">m11</span> <span class="keyword1">else</span> <span class="bound">m10</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">c1</span> <span class="keyword1">then</span> <span class="bound">m01</span> <span class="keyword1">else</span> <span class="bound">m00</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lossless_funct_14_OT<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span>funct_OT_14 <span class="free">M</span> <span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> funct_OT_14_def split_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="ETP">
<div class="head">
<h1>Theory ETP</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚Äπ ETP definitions ‚Ä∫</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚Äπ We define Extended Trapdoor Permutations (ETPs) following \cite{DBLP:books/sp/17/Lindell17} and \cite{DBLP:books/cu/Goldreich2004}. 
In particular we consider the property of Hard Core Predicates (HCPs). ‚Ä∫</span></span>

<span class="keyword1"><span class="command">theory</span></span> ETP <span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../CryptHOL/CryptHOL.html">CryptHOL.CryptHOL</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'index</span><span class="main">,</span><span class="tfree">'range</span><span class="main">)</span> dist2 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool <span class="main">√ó</span> <span class="tfree">'index</span> <span class="main">√ó</span> bool <span class="main">√ó</span> bool<span class="main">)</span> <span class="main">‚áí</span> bool spmf"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'index</span><span class="main">,</span><span class="tfree">'range</span><span class="main">)</span> advP2 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'index</span> <span class="main">‚áí</span> bool <span class="main">‚áí</span> bool <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'index</span><span class="main">,</span><span class="tfree">'range</span><span class="main">)</span> dist2 <span class="main">‚áí</span> <span class="tfree">'range</span> <span class="main">‚áí</span> bool spmf"</span></span>

<span class="keyword1"><span class="command">locale</span></span> etp <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'index</span> <span class="main">√ó</span> <span class="tfree">'trap</span><span class="main">)</span> spmf"</span></span> <span class="comment1">‚Äï ‚Äπsamples index and trapdoor‚Ä∫</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">domain</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'index</span> <span class="main">‚áí</span> <span class="tfree">'range</span> set"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">range</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'index</span> <span class="main">‚áí</span> <span class="tfree">'range</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">F</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'index</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'range</span> <span class="main">‚áí</span> <span class="tfree">'range</span><span class="main">)</span>"</span></span> <span class="comment1">‚Äï ‚Äπpermutation‚Ä∫</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">F<span class="hidden">‚á©</span><sub>i</sub><span class="hidden">‚á©</span><sub>n</sub><span class="hidden">‚á©</span><sub>v</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'index</span> <span class="main">‚áí</span> <span class="tfree">'trap</span> <span class="main">‚áí</span> <span class="tfree">'range</span> <span class="main">‚áí</span> <span class="tfree">'range</span>"</span></span> <span class="comment1">‚Äï ‚Äπmust be efficiently computable‚Ä∫</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'index</span> <span class="main">‚áí</span> <span class="tfree">'range</span> <span class="main">‚áí</span> bool"</span></span> <span class="comment1">‚Äï ‚Äπhard core predicate‚Ä∫</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dom_eq_ran<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">‚àà</span> set_spmf <span class="free">I</span> <span class="main">‚ü∂</span> <span class="free">domain</span> <span class="main">(</span>fst <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">range</span> <span class="main">(</span>fst <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> finite_range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">‚àà</span> set_spmf <span class="free">I</span> <span class="main">‚ü∂</span> finite <span class="main">(</span><span class="free">range</span> <span class="main">(</span>fst <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> non_empty_range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">‚àà</span> set_spmf <span class="free">I</span> <span class="main">‚ü∂</span> <span class="free">range</span> <span class="main">(</span>fst <span class="free">y</span><span class="main">)</span> <span class="main">‚â†</span> <span class="main">{}</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> bij_betw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">‚àà</span> set_spmf <span class="free">I</span> <span class="main">‚ü∂</span> bij_betw <span class="main">(</span><span class="free">F</span> <span class="main">(</span>fst <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">domain</span> <span class="main">(</span>fst <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">range</span> <span class="main">(</span>fst <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> lossless_I<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="free">I</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> F_f_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">‚àà</span> set_spmf <span class="free">I</span> <span class="main">‚ü∂</span> <span class="free">x</span> <span class="main">‚àà</span> <span class="free">range</span> <span class="main">(</span>fst <span class="free">y</span><span class="main">)</span> <span class="main">‚ü∂</span> <span class="free">F<span class="hidden">‚á©</span><sub>i</sub><span class="hidden">‚á©</span><sub>n</sub><span class="hidden">‚á©</span><sub>v</sub></span> <span class="main">(</span>fst <span class="free">y</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="free">F</span> <span class="main">(</span>fst <span class="free">y</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'index</span> <span class="main">‚áí</span> <span class="tfree">'range</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="free"><span class="bound"><span class="entity">Œ±</span></span></span> <span class="main">=</span> spmf_of_set <span class="main">(</span><span class="free">range</span> <span class="free"><span class="bound"><span class="entity">Œ±</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lossless_S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">‚àà</span> set_spmf <span class="free">I</span> <span class="main">‚ü∂</span>  lossless_spmf <span class="main">(</span>S <span class="main">(</span>fst <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lossless_spmf_def S_def finite_range non_empty_range<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_spmf_S <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">‚àà</span> set_spmf <span class="free">I</span> <span class="main">‚ü∂</span> set_spmf <span class="main">(</span>S <span class="main">(</span>fst <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">range</span> <span class="main">(</span>fst <span class="free">y</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_def finite_range<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> f_inj_on<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">‚àà</span> set_spmf <span class="free">I</span> <span class="main">‚ü∂</span> inj_on <span class="main">(</span><span class="free">F</span> <span class="main">(</span>fst <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">range</span> <span class="main">(</span>fst <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> bij_betw_def bij_betw dom_eq_ran bij_betw_def bij_betw dom_eq_ran<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> range_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">‚àà</span> set_spmf <span class="free">I</span> <span class="main">‚ü∂</span>  <span class="free">x</span> <span class="main">‚àà</span> <span class="free">range</span> <span class="main">(</span>fst <span class="free">y</span><span class="main">)</span> <span class="main">‚ü∂</span> <span class="free">F</span> <span class="main">(</span>fst <span class="free">y</span><span class="main">)</span> <span class="free">x</span> <span class="main">‚àà</span> <span class="free">range</span> <span class="main">(</span>fst <span class="free">y</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bij_betw bij_betw dom_eq_ran bij_betwE<span class="main">)</span>   

<span class="keyword1"><span class="command">lemma</span></span> f_inv_f <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">‚àà</span> set_spmf <span class="free">I</span> <span class="main">‚ü∂</span> <span class="free">x</span> <span class="main">‚àà</span> <span class="free">range</span> <span class="main">(</span>fst <span class="free">y</span><span class="main">)</span> <span class="main">‚ü∂</span> <span class="free">F<span class="hidden">‚á©</span><sub>i</sub><span class="hidden">‚á©</span><sub>n</sub><span class="hidden">‚á©</span><sub>v</sub></span> <span class="main">(</span>fst <span class="free">y</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="free">F</span> <span class="main">(</span>fst <span class="free">y</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bij_betw bij_betw_inv_into_left dom_eq_ran F_f_inv<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> f_inv_f' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">‚àà</span> set_spmf <span class="free">I</span> <span class="main">‚ü∂</span> <span class="free">x</span> <span class="main">‚àà</span> <span class="free">range</span> <span class="main">(</span>fst <span class="free">y</span><span class="main">)</span> <span class="main">‚ü∂</span> Hilbert_Choice.inv_into <span class="main">(</span><span class="free">range</span> <span class="main">(</span>fst <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">F</span> <span class="main">(</span>fst <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">F</span> <span class="main">(</span>fst <span class="free">y</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bij_betw bij_betw_inv_into_left bij_betw dom_eq_ran<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> B_F_inv_rewrite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">B</span> <span class="free">Œ±</span> <span class="main">(</span><span class="free">F<span class="hidden">‚á©</span><sub>i</sub><span class="hidden">‚á©</span><sub>n</sub><span class="hidden">‚á©</span><sub>v</sub></span> <span class="free">Œ±</span> <span class="free">œÑ</span> <span class="free">y<span class="hidden">‚á©</span><sub>œÉ</sub>'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">B</span> <span class="free">Œ±</span> <span class="main">(</span><span class="free">F<span class="hidden">‚á©</span><sub>i</sub><span class="hidden">‚á©</span><sub>n</sub><span class="hidden">‚á©</span><sub>v</sub></span> <span class="free">Œ±</span> <span class="free">œÑ</span> <span class="free">y<span class="hidden">‚á©</span><sub>œÉ</sub>'</span><span class="main">)</span> <span class="main">=</span> <span class="free">m1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">m1</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> uni_set_samp<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">‚àà</span> set_spmf <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map_spmf <span class="main">(</span><span class="main">Œª</span> <span class="bound">x</span><span class="main">.</span> <span class="free">F</span> <span class="main">(</span>fst <span class="free">y</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>S <span class="main">(</span>fst <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>S <span class="main">(</span>fst <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> rhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> spmf_of_set <span class="main">(</span><span class="free">range</span> <span class="main">(</span>fst <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> S_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_spmf <span class="main">(</span><span class="main">Œª</span> <span class="bound">x</span><span class="main">.</span> <span class="free">F</span> <span class="main">(</span>fst <span class="free">y</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>spmf_of_set <span class="main">(</span><span class="free">range</span> <span class="main">(</span>fst <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> spmf_of_set <span class="main">(</span><span class="main">(</span><span class="main">Œª</span> <span class="bound">x</span><span class="main">.</span> <span class="free">F</span> <span class="main">(</span>fst <span class="free">y</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">range</span> <span class="main">(</span>fst <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f_inj_on assms 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> map_spmf_of_set_inj_on<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">Œª</span> <span class="bound">x</span><span class="main">.</span> <span class="free">F</span> <span class="main">(</span>fst <span class="free">y</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">range</span> <span class="main">(</span>fst <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">range</span> <span class="main">(</span>fst <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> endo_inj_surj<span class="main">)</span> 
    <span class="keyword1"><span class="command">using</span></span> bij_betw
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_betw_def dom_eq_ran f_inj_on bij_betw finite_range assms<span class="main">)</span>  
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rhs<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‚ÄπWe define the security property of the hard core predicate (HCP) using a game.‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">HCP_game</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'index</span><span class="main">,</span><span class="tfree">'range</span><span class="main">)</span> advP2 <span class="main">‚áí</span>  bool <span class="main">‚áí</span> bool <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'index</span><span class="main">,</span><span class="tfree">'range</span><span class="main">)</span> dist2 <span class="main">‚áí</span> bool spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">HCP_game</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">œÉ</span> <span class="bound">b<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="bound">D</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="main">(</span><span class="bound">Œ±</span><span class="main">,</span> <span class="bound">œÑ</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="free">I</span><span class="main">;</span>
    <span class="bound">x</span> <span class="main">‚Üê</span> S <span class="bound">Œ±</span><span class="main">;</span>
    <span class="bound">b'</span> <span class="main">‚Üê</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">Œ±</span> <span class="bound">œÉ</span> <span class="bound">b<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="bound">D</span> <span class="bound">x</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">b</span> <span class="main">=</span> <span class="free">B</span> <span class="bound">Œ±</span> <span class="main">(</span><span class="free">F<span class="hidden">‚á©</span><sub>i</sub><span class="hidden">‚á©</span><sub>n</sub><span class="hidden">‚á©</span><sub>v</sub></span> <span class="bound">Œ±</span> <span class="bound">œÑ</span> <span class="bound">x</span><span class="main">)</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="bound">b</span> <span class="main">=</span> <span class="bound">b'</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">HCP_adv</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="free"><span class="bound"><span class="entity">b<span class="hidden">‚á©</span><sub>œÉ</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">=</span> <span class="main">¬¶</span><span class="main">(</span><span class="main">(</span>spmf <span class="main">(</span>HCP_game <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="free"><span class="bound"><span class="entity">b<span class="hidden">‚á©</span><sub>œÉ</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> True<span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">¬¶</span>"</span></span> 

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>



</pre>
</div><div id="ETP_OT">
<div class="head">
<h1>Theory ETP_OT</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚Äπ Oblivious transfer constructed from ETPs ‚Ä∫</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‚ÄπHere we construct the OT protocol based on ETPs given in \cite{DBLP:books/sp/17/Lindell17} (Chapter 4) and prove
semi honest security for both parties. We show information theoretic security for Party 1 and reduce the security of 
Party 2 to the HCP assumption.‚Ä∫</span></span>

<span class="keyword1"><span class="command">theory</span></span> ETP_OT <span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Number_Theory/Cong.html">HOL-Number_Theory.Cong</a>"</span>
  <a href="ETP.html">ETP</a>
  <a href="OT_Functionalities.html">OT_Functionalities</a>
  <a href="Semi_Honest_Def.html">Semi_Honest_Def</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'range</span> viewP1 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span> <span class="main">√ó</span> <span class="tfree">'range</span> <span class="main">√ó</span> <span class="tfree">'range</span><span class="main">)</span> spmf"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'range</span> dist1 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span> <span class="main">√ó</span> <span class="tfree">'range</span> <span class="main">√ó</span> <span class="tfree">'range</span><span class="main">)</span> <span class="main">‚áí</span> bool spmf"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'index</span> viewP2 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool <span class="main">√ó</span> <span class="tfree">'index</span> <span class="main">√ó</span> <span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span><span class="main">)</span> spmf"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'index</span> dist2 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool <span class="main">√ó</span> <span class="tfree">'index</span> <span class="main">√ó</span> bool <span class="main">√ó</span> bool<span class="main">)</span> <span class="main">‚áí</span> bool spmf"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'index</span><span class="main">,</span> <span class="tfree">'range</span><span class="main">)</span> advP2 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'index</span> <span class="main">‚áí</span> bool <span class="main">‚áí</span> bool <span class="main">‚áí</span> <span class="tfree">'index</span> dist2 <span class="main">‚áí</span> <span class="tfree">'range</span> <span class="main">‚áí</span> bool spmf"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> if_False_True<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="keyword1">then</span> False <span class="keyword1">else</span> <span class="main">¬¨</span> False<span class="main">)</span> <span class="main">‚ü∑</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="keyword1">then</span> False <span class="keyword1">else</span> True<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> if_then_True <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> True <span class="keyword1">else</span> <span class="free">x</span><span class="main">)</span> <span class="main">‚ü∑</span> <span class="main">(</span><span class="main">¬¨</span> <span class="free">b</span> <span class="main">‚ü∂</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> if_else_True <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="free">x</span> <span class="keyword1">else</span> True<span class="main">)</span> <span class="main">‚ü∑</span> <span class="main">(</span><span class="free">b</span> <span class="main">‚ü∂</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> inj_on_Not <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on Not <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>

<span class="keyword1"><span class="command">locale</span></span> ETP_base <span class="main">=</span> etp<span class="main">:</span> etp <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">domain</span></span> <span class="quoted"><span class="free">range</span></span> <span class="quoted"><span class="free">F</span></span> <span class="quoted"><span class="free">F<span class="hidden">‚á©</span><sub>i</sub><span class="hidden">‚á©</span><sub>n</sub><span class="hidden">‚á©</span><sub>v</sub></span></span> <span class="quoted"><span class="free">B</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">I</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'index</span> <span class="main">√ó</span> <span class="tfree">'trap</span><span class="main">)</span> spmf"</span></span> <span class="comment1">‚Äï ‚Äπsamples index and trapdoor‚Ä∫</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">domain</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'index</span> <span class="main">‚áí</span> <span class="tfree">'range</span> set"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">range</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'index</span> <span class="main">‚áí</span> <span class="tfree">'range</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'index</span> <span class="main">‚áí</span> <span class="tfree">'range</span> <span class="main">‚áí</span> bool"</span></span> <span class="comment1">‚Äï ‚Äπhard core predicate‚Ä∫</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">F</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'index</span> <span class="main">‚áí</span> <span class="tfree">'range</span> <span class="main">‚áí</span> <span class="tfree">'range</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">F<span class="hidden">‚á©</span><sub>i</sub><span class="hidden">‚á©</span><sub>n</sub><span class="hidden">‚á©</span><sub>v</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'index</span> <span class="main">‚áí</span> <span class="tfree">'trap</span> <span class="main">‚áí</span> <span class="tfree">'range</span> <span class="main">‚áí</span> <span class="tfree">'range</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‚ÄπThe probabilistic program that defines the protocol.‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">protocol</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span> <span class="main">‚áí</span> bool <span class="main">‚áí</span> <span class="main">(</span>unit <span class="main">√ó</span> bool<span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">protocol</span> <span class="free"><span class="bound"><span class="entity">input<span class="hidden">‚á©</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>  
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">b<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">,</span> <span class="bound">b<span class="hidden">‚á©</span><sub>œÉ</sub>'</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">input<span class="hidden">‚á©</span><sub>1</sub></span></span></span><span class="main">;</span>
    <span class="main">(</span><span class="bound">Œ±</span> <span class="main">::</span> <span class="tfree">'index</span><span class="main">,</span> <span class="bound">œÑ</span> <span class="main">::</span> <span class="tfree">'trap</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="free">I</span><span class="main">;</span>
    <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="main">::</span> <span class="tfree">'range</span> <span class="main">‚Üê</span> etp.S <span class="bound">Œ±</span><span class="main">;</span>
    <span class="bound">y<span class="hidden">‚á©</span><sub>œÉ</sub>'</span> <span class="main">::</span> <span class="tfree">'range</span> <span class="main">‚Üê</span> etp.S <span class="bound">Œ±</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">y<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="main">::</span> <span class="tfree">'range</span><span class="main">)</span> <span class="main">=</span> <span class="free">F</span> <span class="bound">Œ±</span> <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="main">::</span> <span class="tfree">'range</span><span class="main">)</span> <span class="main">=</span> <span class="free">F<span class="hidden">‚á©</span><sub>i</sub><span class="hidden">‚á©</span><sub>n</sub><span class="hidden">‚á©</span><sub>v</sub></span> <span class="bound">Œ±</span> <span class="bound">œÑ</span> <span class="bound">y<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub>'</span> <span class="main">::</span> <span class="tfree">'range</span><span class="main">)</span> <span class="main">=</span> <span class="free">F<span class="hidden">‚á©</span><sub>i</sub><span class="hidden">‚á©</span><sub>n</sub><span class="hidden">‚á©</span><sub>v</sub></span> <span class="bound">Œ±</span> <span class="bound">œÑ</span> <span class="bound">y<span class="hidden">‚á©</span><sub>œÉ</sub>'</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="main">::</span> bool<span class="main">)</span> <span class="main">=</span> xor <span class="main">(</span><span class="free">B</span> <span class="bound">Œ±</span> <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">)</span> <span class="bound">b<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub>'</span> <span class="main">::</span> bool<span class="main">)</span> <span class="main">=</span> xor <span class="main">(</span><span class="free">B</span> <span class="bound">Œ±</span> <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub>'</span><span class="main">)</span> <span class="bound">b<span class="hidden">‚á©</span><sub>œÉ</sub>'</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="keyword1">then</span> xor <span class="main">(</span><span class="free">B</span> <span class="bound">Œ±</span> <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub>'</span><span class="main">)</span> <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub>'</span> <span class="keyword1">else</span> xor <span class="main">(</span><span class="free">B</span> <span class="bound">Œ±</span> <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">)</span> <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> correctness<span class="main">:</span> <span class="quoted"><span class="quoted">"protocol <span class="main">(</span><span class="free">m0</span><span class="main">,</span><span class="free">m1</span><span class="main">)</span> <span class="free">c</span> <span class="main">=</span> funct_OT_12 <span class="main">(</span><span class="free">m0</span><span class="main">,</span><span class="free">m1</span><span class="main">)</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">B</span> <span class="skolem">Œ±</span> <span class="main">(</span><span class="free">F<span class="hidden">‚á©</span><sub>i</sub><span class="hidden">‚á©</span><sub>n</sub><span class="hidden">‚á©</span><sub>v</sub></span> <span class="skolem">Œ±</span> <span class="skolem">œÑ</span> <span class="skolem">y<span class="hidden">‚á©</span><sub>œÉ</sub>'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">B</span> <span class="skolem">Œ±</span> <span class="main">(</span><span class="free">F<span class="hidden">‚á©</span><sub>i</sub><span class="hidden">‚á©</span><sub>n</sub><span class="hidden">‚á©</span><sub>v</sub></span> <span class="skolem">Œ±</span> <span class="skolem">œÑ</span> <span class="skolem">y<span class="hidden">‚á©</span><sub>œÉ</sub>'</span><span class="main">)</span> <span class="main">=</span> <span class="free">m1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">m1</span>"</span></span> 
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">Œ±</span> <span class="skolem">œÑ</span> <span class="skolem">y<span class="hidden">‚á©</span><sub>œÉ</sub>'</span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> protocol_def funct_OT_12_def Let_def etp.B_F_inv_rewrite bind_spmf_const etp.lossless_S local.etp.lossless_I lossless_weight_spmfD split_def <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> bind_spmf_cong<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚Äπ Party 1 views ‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">R1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span> <span class="main">‚áí</span> bool <span class="main">‚áí</span> <span class="tfree">'range</span> viewP1"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">R1</span> <span class="free"><span class="bound"><span class="entity">input<span class="hidden">‚á©</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">b<span class="hidden">‚á©</span><sub>0</sub></span><span class="main">,</span> <span class="bound">b<span class="hidden">‚á©</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">input<span class="hidden">‚á©</span><sub>1</sub></span></span></span><span class="main">;</span>
    <span class="main">(</span><span class="bound">Œ±</span><span class="main">,</span> <span class="bound">œÑ</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="free">I</span><span class="main">;</span>
    <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="main">‚Üê</span> etp.S <span class="bound">Œ±</span><span class="main">;</span>
    <span class="bound">y<span class="hidden">‚á©</span><sub>œÉ</sub>'</span> <span class="main">‚Üê</span> etp.S <span class="bound">Œ±</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">y<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="main">=</span> <span class="free">F</span> <span class="bound">Œ±</span> <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">(</span><span class="bound">b<span class="hidden">‚á©</span><sub>0</sub></span><span class="main">,</span> <span class="bound">b<span class="hidden">‚á©</span><sub>1</sub></span><span class="main">)</span><span class="main">,</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="keyword1">then</span> <span class="bound">y<span class="hidden">‚á©</span><sub>œÉ</sub>'</span> <span class="keyword1">else</span> <span class="bound">y<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">,</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="keyword1">then</span> <span class="bound">y<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="keyword1">else</span> <span class="bound">y<span class="hidden">‚á©</span><sub>œÉ</sub>'</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lossless_R1<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span>R1 <span class="free">msgs</span> <span class="free">œÉ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R1_def local.etp.lossless_I split_def etp.lossless_S Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">S1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span> <span class="main">‚áí</span> unit <span class="main">‚áí</span> <span class="tfree">'range</span> viewP1"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">S1</span> <span class="main">==</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">input<span class="hidden">‚á©</span><sub>1</sub></span> <span class="main">()</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">b<span class="hidden">‚á©</span><sub>0</sub></span><span class="main">,</span> <span class="bound">b<span class="hidden">‚á©</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> <span class="bound">input<span class="hidden">‚á©</span><sub>1</sub></span><span class="main">;</span>
    <span class="main">(</span><span class="bound">Œ±</span><span class="main">,</span> <span class="bound">œÑ</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="free">I</span><span class="main">;</span>
    <span class="bound">y<span class="hidden">‚á©</span><sub>0</sub></span> <span class="main">::</span> <span class="tfree">'range</span> <span class="main">‚Üê</span> etp.S <span class="bound">Œ±</span><span class="main">;</span>
    <span class="bound">y<span class="hidden">‚á©</span><sub>1</sub></span> <span class="main">‚Üê</span> etp.S <span class="bound">Œ±</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">(</span><span class="bound">b<span class="hidden">‚á©</span><sub>0</sub></span><span class="main">,</span> <span class="bound">b<span class="hidden">‚á©</span><sub>1</sub></span><span class="main">)</span><span class="main">,</span> <span class="bound">y<span class="hidden">‚á©</span><sub>0</sub></span><span class="main">,</span> <span class="bound">y<span class="hidden">‚á©</span><sub>1</sub></span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> lossless_S1<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span>S1 <span class="free">msgs</span> <span class="main">()</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S1_def local.etp.lossless_I split_def etp.lossless_S<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚Äπ Party 2 views ‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">R2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span> <span class="main">‚áí</span> bool <span class="main">‚áí</span> <span class="tfree">'index</span> viewP2"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">R2</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">b0</span><span class="main">,</span><span class="bound">b1</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">;</span>
    <span class="main">(</span><span class="bound">Œ±</span><span class="main">,</span> <span class="bound">œÑ</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="free">I</span><span class="main">;</span>
    <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="main">‚Üê</span> etp.S <span class="bound">Œ±</span><span class="main">;</span>
    <span class="bound">y<span class="hidden">‚á©</span><sub>œÉ</sub>'</span> <span class="main">‚Üê</span> etp.S <span class="bound">Œ±</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">y<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="main">=</span> <span class="free">F</span> <span class="bound">Œ±</span> <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="main">=</span> <span class="free">F<span class="hidden">‚á©</span><sub>i</sub><span class="hidden">‚á©</span><sub>n</sub><span class="hidden">‚á©</span><sub>v</sub></span> <span class="bound">Œ±</span> <span class="bound">œÑ</span> <span class="bound">y<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub>'</span> <span class="main">=</span> <span class="free">F<span class="hidden">‚á©</span><sub>i</sub><span class="hidden">‚á©</span><sub>n</sub><span class="hidden">‚á©</span><sub>v</sub></span> <span class="bound">Œ±</span> <span class="bound">œÑ</span> <span class="bound">y<span class="hidden">‚á©</span><sub>œÉ</sub>'</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="main">=</span> <span class="main">(</span><span class="free">B</span> <span class="bound">Œ±</span> <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">)</span> <span class="main">‚äï</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="keyword1">then</span> <span class="bound">b1</span> <span class="keyword1">else</span> <span class="bound">b0</span><span class="main">)</span> <span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub>'</span> <span class="main">=</span> <span class="main">(</span><span class="free">B</span> <span class="bound">Œ±</span> <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub>'</span><span class="main">)</span> <span class="main">‚äï</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="keyword1">then</span> <span class="bound">b0</span> <span class="keyword1">else</span> <span class="bound">b1</span><span class="main">)</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="free"><span class="bound"><span class="entity">œÉ</span></span></span><span class="main">,</span> <span class="bound">Œ±</span><span class="main">,</span><span class="main">(</span><span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">,</span> <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub>'</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lossless_R2<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span>R2 <span class="free">msgs</span> <span class="free">œÉ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R2_def split_def local.etp.lossless_I etp.lossless_S<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">S2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">‚áí</span> bool <span class="main">‚áí</span> <span class="tfree">'index</span> viewP2"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">S2</span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="free"><span class="bound"><span class="entity">b<span class="hidden">‚á©</span><sub>œÉ</sub></span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="main">(</span><span class="bound">Œ±</span><span class="main">,</span> <span class="bound">œÑ</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="free">I</span><span class="main">;</span>
    <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="main">‚Üê</span> etp.S <span class="bound">Œ±</span><span class="main">;</span>
    <span class="bound">y<span class="hidden">‚á©</span><sub>œÉ</sub>'</span> <span class="main">‚Üê</span> etp.S <span class="bound">Œ±</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub>'</span> <span class="main">=</span> <span class="free">F<span class="hidden">‚á©</span><sub>i</sub><span class="hidden">‚á©</span><sub>n</sub><span class="hidden">‚á©</span><sub>v</sub></span> <span class="bound">Œ±</span> <span class="bound">œÑ</span> <span class="bound">y<span class="hidden">‚á©</span><sub>œÉ</sub>'</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="main">=</span> <span class="main">(</span><span class="free">B</span> <span class="bound">Œ±</span> <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">)</span> <span class="main">‚äï</span> <span class="free"><span class="bound"><span class="entity">b<span class="hidden">‚á©</span><sub>œÉ</sub></span></span></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub>'</span> <span class="main">=</span> <span class="free">B</span> <span class="bound">Œ±</span> <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub>'</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="free"><span class="bound"><span class="entity">œÉ</span></span></span><span class="main">,</span> <span class="bound">Œ±</span><span class="main">,</span> <span class="main">(</span><span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">,</span> <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub>'</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lossless_S2<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span>S2 <span class="free">œÉ</span> <span class="free">b<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S2_def local.etp.lossless_I etp.lossless_S split_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚Äπ Security for Party 1 ‚Ä∫</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‚ÄπWe have information theoretic security for Party 1.‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P1_security<span class="main">:</span> <span class="quoted"><span class="quoted">"R1 <span class="free">input<span class="hidden">‚á©</span><sub>1</sub></span> <span class="free">œÉ</span> <span class="main">=</span> funct_OT_12 <span class="free">x</span> <span class="free">y</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">s1</span><span class="main">,</span> <span class="bound">s2</span><span class="main">)</span><span class="main">.</span> S1 <span class="free">input<span class="hidden">‚á©</span><sub>1</sub></span> <span class="bound">s1</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">including</span></span> monad_normalisation
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"R1 <span class="free">input<span class="hidden">‚á©</span><sub>1</sub></span> <span class="free">œÉ</span> <span class="main">=</span>  <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">b0</span><span class="main">,</span><span class="bound">b1</span><span class="main">)</span> <span class="main">=</span> <span class="free">input<span class="hidden">‚á©</span><sub>1</sub></span><span class="main">;</span>
    <span class="main">(</span><span class="bound">Œ±</span><span class="main">,</span> <span class="bound">œÑ</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="free">I</span><span class="main">;</span>
    <span class="bound">y<span class="hidden">‚á©</span><sub>œÉ</sub>'</span> <span class="main">::</span> <span class="tfree">'range</span> <span class="main">‚Üê</span> etp.S <span class="bound">Œ±</span><span class="main">;</span>
    <span class="bound">y<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="main">‚Üê</span> map_spmf <span class="main">(</span><span class="main">Œª</span> <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">.</span> <span class="free">F</span> <span class="bound">Œ±</span> <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">)</span> <span class="main">(</span>etp.S <span class="bound">Œ±</span><span class="main">)</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">(</span><span class="bound">b0</span><span class="main">,</span><span class="bound">b1</span><span class="main">)</span><span class="main">,</span> <span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="bound">y<span class="hidden">‚á©</span><sub>œÉ</sub>'</span> <span class="keyword1">else</span> <span class="bound">y<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">,</span> <span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="bound">y<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="keyword1">else</span> <span class="bound">y<span class="hidden">‚á©</span><sub>œÉ</sub>'</span><span class="main">)</span><span class="main">}</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_map_spmf o_def Let_def R1_def<span class="main">)</span>
   <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">b0</span><span class="main">,</span><span class="bound">b1</span><span class="main">)</span> <span class="main">=</span> <span class="free">input<span class="hidden">‚á©</span><sub>1</sub></span><span class="main">;</span>
    <span class="main">(</span><span class="bound">Œ±</span><span class="main">,</span> <span class="bound">œÑ</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="free">I</span><span class="main">;</span>
    <span class="bound">y<span class="hidden">‚á©</span><sub>œÉ</sub>'</span> <span class="main">::</span> <span class="tfree">'range</span> <span class="main">‚Üê</span> etp.S <span class="bound">Œ±</span><span class="main">;</span>
    <span class="bound">y<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="main">‚Üê</span> etp.S <span class="bound">Œ±</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">(</span><span class="bound">b0</span><span class="main">,</span><span class="bound">b1</span><span class="main">)</span><span class="main">,</span> <span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="bound">y<span class="hidden">‚á©</span><sub>œÉ</sub>'</span> <span class="keyword1">else</span> <span class="bound">y<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">,</span> <span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="bound">y<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="keyword1">else</span> <span class="bound">y<span class="hidden">‚á©</span><sub>œÉ</sub>'</span><span class="main">)</span><span class="main">}</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> etp.uni_set_samp Let_def split_def <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> bind_spmf_cong<span class="main">)</span>
   <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> funct_OT_12 <span class="free">x</span> <span class="free">y</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">s1</span><span class="main">,</span> <span class="bound">s2</span><span class="main">)</span><span class="main">.</span> S1 <span class="free">input<span class="hidden">‚á©</span><sub>1</sub></span> <span class="bound">s1</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">œÉ</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S1_def R1_def Let_def funct_OT_12_def<span class="main">)</span>
   <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚Äπ The adversary used in proof of security for party 2 ‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ùíú</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'index</span><span class="main">,</span> <span class="tfree">'range</span><span class="main">)</span> advP2"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ùíú</span> <span class="free"><span class="bound"><span class="entity">Œ±</span></span></span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="free"><span class="bound"><span class="entity">b<span class="hidden">‚á©</span><sub>œÉ</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">D2</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub>'</span> <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="main">‚Üê</span> etp.S <span class="free"><span class="bound"><span class="entity">Œ±</span></span></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="main">=</span> <span class="main">(</span><span class="free">B</span> <span class="free"><span class="bound"><span class="entity">Œ±</span></span></span> <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">)</span> <span class="main">‚äï</span> <span class="free"><span class="bound"><span class="entity">b<span class="hidden">‚á©</span><sub>œÉ</sub></span></span></span><span class="main">;</span>
    <span class="bound">d</span> <span class="main">‚Üê</span> <span class="free"><span class="bound"><span class="entity">D2</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">œÉ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Œ±</span></span></span><span class="main">,</span> <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">,</span> <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub>'</span><span class="main">)</span><span class="main">;</span>
    return_spmf<span class="main">(</span><span class="keyword1">if</span> <span class="bound">d</span> <span class="keyword1">then</span> <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub>'</span> <span class="keyword1">else</span> <span class="main">¬¨</span> <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub>'</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lossless_ùíú<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">‚àÄ</span> <span class="bound">view</span><span class="main">.</span> lossless_spmf <span class="main">(</span><span class="free">D2</span> <span class="bound">view</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">‚àà</span> set_spmf <span class="free">I</span> <span class="main">‚ü∂</span>  lossless_spmf <span class="main">(</span>ùíú <span class="main">(</span>fst <span class="free">y</span><span class="main">)</span> <span class="free">œÉ</span> <span class="free">b<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="free">D2</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ùíú_def etp.lossless_S assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> assm_bound_funct_OT_12<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"etp.HCP_adv ùíú <span class="free">œÉ</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="free">b1</span> <span class="keyword1">else</span> <span class="free">b0</span><span class="main">)</span> <span class="free">D</span> <span class="main">‚â§</span> <span class="free">HCP_ad</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬¶</span>spmf <span class="main">(</span>funct_OT_12 <span class="main">(</span><span class="free">b0</span><span class="main">,</span><span class="free">b1</span><span class="main">)</span> <span class="free">œÉ</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">out1</span><span class="main">,</span><span class="bound">out2</span><span class="main">)</span><span class="main">.</span> 
              etp.HCP_game ùíú <span class="free">œÉ</span> <span class="bound">out2</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span> True <span class="main">-</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">¬¶</span> <span class="main">‚â§</span> <span class="free">HCP_ad</span>"</span></span>
<span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">‚â§</span> <span class="free">HCP_ad</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="main">¬¶</span>spmf <span class="main">(</span>etp.HCP_game ùíú <span class="free">œÉ</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="free">b1</span> <span class="keyword1">else</span> <span class="free">b0</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> True <span class="main">-</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">¬¶</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> funct_OT_12_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms etp.HCP_adv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> assm_bound_funct_OT_12_collapse<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">‚àÄ</span> <span class="bound">b<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">.</span> etp.HCP_adv ùíú <span class="free">œÉ</span> <span class="bound">b<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="free">D</span> <span class="main">‚â§</span> <span class="free">HCP_ad</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬¶</span>spmf <span class="main">(</span>funct_OT_12 <span class="free">m1</span> <span class="free">œÉ</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">out1</span><span class="main">,</span><span class="bound">out2</span><span class="main">)</span><span class="main">.</span> etp.HCP_game ùíú <span class="free">œÉ</span> <span class="bound">out2</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span> True <span class="main">-</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">¬¶</span> <span class="main">‚â§</span> <span class="free">HCP_ad</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assm_bound_funct_OT_12 surj_pair assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚Äπ To prove security for party 2 we split the proof on the cases on party 2's input ‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> R2_S2_False<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="free">b0</span> <span class="keyword1">else</span> <span class="free">b1</span><span class="main">)</span> <span class="main">=</span> False<span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"spmf <span class="main">(</span>R2 <span class="main">(</span><span class="free">b0</span><span class="main">,</span><span class="free">b1</span><span class="main">)</span> <span class="free">œÉ</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="free">D2</span> <span class="main">::</span> <span class="main">(</span>bool <span class="main">√ó</span> <span class="tfree">'index</span> <span class="main">√ó</span> bool <span class="main">√ó</span> bool<span class="main">)</span> <span class="main">‚áí</span> bool spmf<span class="main">)</span><span class="main">)</span> True 
                <span class="main">=</span> spmf <span class="main">(</span>funct_OT_12 <span class="main">(</span><span class="free">b0</span><span class="main">,</span><span class="free">b1</span><span class="main">)</span> <span class="free">œÉ</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">out1</span><span class="main">,</span><span class="bound">out2</span><span class="main">)</span><span class="main">.</span> S2 <span class="free">œÉ</span> <span class="bound">out2</span> <span class="main">‚§ú</span> <span class="free">D2</span><span class="main">)</span><span class="main">)</span> True"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">œÉ</span> <span class="main">‚üπ</span> <span class="main">¬¨</span> <span class="free">b0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬¨</span> <span class="free">œÉ</span> <span class="main">‚üπ</span> <span class="main">¬¨</span> <span class="free">b1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R2_def S2_def split_def local.etp.F_f_inv assms funct_OT_12_def <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> bind_spmf_cong_simp<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> R2_S2_True<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="free">b0</span> <span class="keyword1">else</span> <span class="free">b1</span><span class="main">)</span> <span class="main">=</span> True<span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> lossless_D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">‚àÄ</span> <span class="bound">a</span><span class="main">.</span> lossless_spmf <span class="main">(</span><span class="free">D2</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬¶</span><span class="main">(</span>spmf <span class="main">(</span>bind_spmf <span class="main">(</span>R2 <span class="main">(</span><span class="free">b0</span><span class="main">,</span><span class="free">b1</span><span class="main">)</span> <span class="free">œÉ</span><span class="main">)</span> <span class="free">D2</span><span class="main">)</span> True<span class="main">)</span> <span class="main">-</span> spmf <span class="main">(</span>funct_OT_12 <span class="main">(</span><span class="free">b0</span><span class="main">,</span><span class="free">b1</span><span class="main">)</span> <span class="free">œÉ</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">out1</span><span class="main">,</span> <span class="bound">out2</span><span class="main">)</span><span class="main">.</span> S2 <span class="free">œÉ</span> <span class="bound">out2</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="free">D2</span> <span class="bound">view</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span>
                         <span class="main">=</span> <span class="main">¬¶</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="main">(</span>spmf <span class="main">(</span>etp.HCP_game ùíú <span class="free">œÉ</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="free">b1</span> <span class="keyword1">else</span> <span class="free">b0</span><span class="main">)</span> <span class="free">D2</span><span class="main">)</span> True<span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">¬¶</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span>spmf <span class="main">(</span>funct_OT_12 <span class="main">(</span><span class="free">b0</span><span class="main">,</span><span class="free">b1</span><span class="main">)</span> <span class="free">œÉ</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">out1</span><span class="main">,</span> <span class="bound">out2</span><span class="main">)</span><span class="main">.</span> S2 <span class="free">œÉ</span> <span class="bound">out2</span> <span class="main">‚§ú</span> <span class="free">D2</span><span class="main">)</span><span class="main">)</span> True
              <span class="main">-</span> spmf <span class="main">(</span>bind_spmf <span class="main">(</span>R2 <span class="main">(</span><span class="free">b0</span><span class="main">,</span><span class="free">b1</span><span class="main">)</span> <span class="free">œÉ</span><span class="main">)</span> <span class="free">D2</span><span class="main">)</span> True<span class="main">)</span> 
                    <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>spmf <span class="main">(</span>etp.HCP_game ùíú <span class="free">œÉ</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="free">b1</span> <span class="keyword1">else</span> <span class="free">b0</span><span class="main">)</span> <span class="free">D2</span><span class="main">)</span> True<span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>spmf <span class="main">(</span>etp.HCP_game ùíú <span class="free">œÉ</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="free">b1</span> <span class="keyword1">else</span> <span class="free">b0</span><span class="main">)</span> <span class="free">D2</span><span class="main">)</span> True<span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span>  <span class="main">=</span> 
                  <span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span>spmf <span class="main">(</span>bind_spmf <span class="main">(</span>S2 <span class="free">œÉ</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="free">b1</span> <span class="keyword1">else</span> <span class="free">b0</span><span class="main">)</span><span class="main">)</span> <span class="free">D2</span><span class="main">)</span> True
                        <span class="main">-</span> spmf <span class="main">(</span>bind_spmf <span class="main">(</span>R2 <span class="main">(</span><span class="free">b0</span><span class="main">,</span><span class="free">b1</span><span class="main">)</span> <span class="free">œÉ</span><span class="main">)</span> <span class="free">D2</span><span class="main">)</span> True<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">including</span></span> monad_normalisation
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span> 
      <span class="keyword1"><span class="command">have</span></span> œÉ_true_b0_true<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">œÉ</span> <span class="main">‚üπ</span> <span class="free">b0</span> <span class="main">=</span> True"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> œÉ_false_b1_true<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬¨</span> <span class="free">œÉ</span> <span class="main">‚üπ</span> <span class="free">b1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
      <span class="keyword1"><span class="command">have</span></span> return_True_False<span class="main">:</span> <span class="quoted"><span class="quoted">"spmf <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">¬¨</span> <span class="skolem">d</span><span class="main">)</span><span class="main">)</span> True <span class="main">=</span> spmf <span class="main">(</span>return_spmf <span class="skolem">d</span><span class="main">)</span> False"</span></span>
        <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">d</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">d</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">HCP_game_true</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">HCP_game_true</span> <span class="main">==</span> <span class="main">Œª</span> <span class="bound">œÉ</span> <span class="bound">b<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="main">(</span><span class="bound">Œ±</span><span class="main">,</span> <span class="bound">œÑ</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="free">I</span><span class="main">;</span>
    <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="main">‚Üê</span> etp.S <span class="bound">Œ±</span><span class="main">;</span>
    <span class="bound">x</span> <span class="main">‚Üê</span> <span class="main">(</span>etp.S <span class="bound">Œ±</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="main">=</span> <span class="main">(</span><span class="free">B</span> <span class="bound">Œ±</span> <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">)</span> <span class="main">‚äï</span> <span class="bound">b<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub>'</span> <span class="main">=</span> <span class="free">B</span> <span class="bound">Œ±</span> <span class="main">(</span><span class="free">F<span class="hidden">‚á©</span><sub>i</sub><span class="hidden">‚á©</span><sub>n</sub><span class="hidden">‚á©</span><sub>v</sub></span> <span class="bound">Œ±</span> <span class="bound">œÑ</span> <span class="bound">x</span><span class="main">)</span><span class="main">;</span> 
    <span class="bound">d</span> <span class="main">‚Üê</span> <span class="free">D2</span><span class="main">(</span><span class="bound">œÉ</span><span class="main">,</span> <span class="bound">Œ±</span><span class="main">,</span> <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">,</span> <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub>'</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">b'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">d</span> <span class="keyword1">then</span> <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub>'</span> <span class="keyword1">else</span> <span class="main">¬¨</span> <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub>'</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">b</span> <span class="main">=</span> <span class="free">B</span> <span class="bound">Œ±</span> <span class="main">(</span><span class="free">F<span class="hidden">‚á©</span><sub>i</sub><span class="hidden">‚á©</span><sub>n</sub><span class="hidden">‚á©</span><sub>v</sub></span> <span class="bound">Œ±</span> <span class="bound">œÑ</span> <span class="bound">x</span><span class="main">)</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="bound">b</span> <span class="main">=</span> <span class="bound">b'</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">HCP_game_false</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">HCP_game_false</span> <span class="main">==</span> <span class="main">Œª</span> <span class="bound">œÉ</span> <span class="bound">b<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="main">(</span><span class="bound">Œ±</span><span class="main">,</span> <span class="bound">œÑ</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="free">I</span><span class="main">;</span>
    <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="main">‚Üê</span> etp.S <span class="bound">Œ±</span><span class="main">;</span>
    <span class="bound">x</span> <span class="main">‚Üê</span> <span class="main">(</span>etp.S <span class="bound">Œ±</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="main">=</span> <span class="main">(</span><span class="free">B</span> <span class="bound">Œ±</span> <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">)</span> <span class="main">‚äï</span> <span class="bound">b<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub>'</span> <span class="main">=</span> <span class="main">¬¨</span> <span class="free">B</span> <span class="bound">Œ±</span> <span class="main">(</span><span class="free">F<span class="hidden">‚á©</span><sub>i</sub><span class="hidden">‚á©</span><sub>n</sub><span class="hidden">‚á©</span><sub>v</sub></span> <span class="bound">Œ±</span> <span class="bound">œÑ</span> <span class="bound">x</span><span class="main">)</span><span class="main">;</span> 
    <span class="bound">d</span> <span class="main">‚Üê</span> <span class="free">D2</span><span class="main">(</span><span class="bound">œÉ</span><span class="main">,</span> <span class="bound">Œ±</span><span class="main">,</span> <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">,</span> <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub>'</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">b'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">d</span> <span class="keyword1">then</span> <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub>'</span> <span class="keyword1">else</span> <span class="main">¬¨</span> <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub>'</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">b</span> <span class="main">=</span> <span class="free">B</span> <span class="bound">Œ±</span> <span class="main">(</span><span class="free">F<span class="hidden">‚á©</span><sub>i</sub><span class="hidden">‚á©</span><sub>n</sub><span class="hidden">‚á©</span><sub>v</sub></span> <span class="bound">Œ±</span> <span class="bound">œÑ</span> <span class="bound">x</span><span class="main">)</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="bound">b</span> <span class="main">=</span> <span class="bound">b'</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">HCP_game_ùíú</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">HCP_game_ùíú</span> <span class="main">==</span> <span class="main">Œª</span> <span class="bound">œÉ</span> <span class="bound">b<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub>'</span> <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="main">(</span><span class="bound">Œ±</span><span class="main">,</span> <span class="bound">œÑ</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="free">I</span><span class="main">;</span>
    <span class="bound">x</span> <span class="main">‚Üê</span> etp.S <span class="bound">Œ±</span><span class="main">;</span>
    <span class="bound">x'</span> <span class="main">‚Üê</span> etp.S <span class="bound">Œ±</span><span class="main">;</span>
    <span class="bound">d</span> <span class="main">‚Üê</span> <span class="free">D2</span> <span class="main">(</span><span class="bound">œÉ</span><span class="main">,</span> <span class="bound">Œ±</span><span class="main">,</span> <span class="main">(</span><span class="free">B</span> <span class="bound">Œ±</span> <span class="bound">x</span><span class="main">)</span> <span class="main">‚äï</span> <span class="bound">b<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">,</span> <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub>'</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">b'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">d</span> <span class="keyword1">then</span>  <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub>'</span> <span class="keyword1">else</span> <span class="main">¬¨</span> <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub>'</span><span class="main">)</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="free">B</span> <span class="bound">Œ±</span> <span class="main">(</span><span class="free">F<span class="hidden">‚á©</span><sub>i</sub><span class="hidden">‚á©</span><sub>n</sub><span class="hidden">‚á©</span><sub>v</sub></span> <span class="bound">Œ±</span> <span class="bound">œÑ</span> <span class="bound">x'</span><span class="main">)</span> <span class="main">=</span> <span class="bound">b'</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">S2D</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S2D</span> <span class="main">==</span> <span class="main">Œª</span> <span class="bound">œÉ</span> <span class="bound">b<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="main">(</span><span class="bound">Œ±</span><span class="main">,</span> <span class="bound">œÑ</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="free">I</span><span class="main">;</span>
      <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="main">‚Üê</span> etp.S <span class="bound">Œ±</span><span class="main">;</span>
      <span class="bound">y<span class="hidden">‚á©</span><sub>œÉ</sub>'</span> <span class="main">‚Üê</span> etp.S <span class="bound">Œ±</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub>'</span> <span class="main">=</span> <span class="free">F<span class="hidden">‚á©</span><sub>i</sub><span class="hidden">‚á©</span><sub>n</sub><span class="hidden">‚á©</span><sub>v</sub></span> <span class="bound">Œ±</span> <span class="bound">œÑ</span> <span class="bound">y<span class="hidden">‚á©</span><sub>œÉ</sub>'</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="main">=</span> <span class="main">(</span><span class="free">B</span> <span class="bound">Œ±</span> <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">)</span> <span class="main">‚äï</span> <span class="bound">b<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub>'</span> <span class="main">=</span> <span class="free">B</span> <span class="bound">Œ±</span> <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub>'</span><span class="main">;</span>
      <span class="bound">d</span> <span class="main">::</span> bool <span class="main">‚Üê</span> <span class="free">D2</span><span class="main">(</span><span class="bound">œÉ</span><span class="main">,</span> <span class="bound">Œ±</span><span class="main">,</span> <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">,</span> <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub>'</span><span class="main">)</span><span class="main">;</span>
      return_spmf <span class="bound">d</span><span class="main">}</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">R2D</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R2D</span> <span class="main">==</span> <span class="main">Œª</span> <span class="bound">msgs</span> <span class="bound">œÉ</span><span class="main">.</span>  <span class="keyword1">do</span> <span class="main">{</span>
      <span class="keyword1">let</span> <span class="main">(</span><span class="bound">b0</span><span class="main">,</span><span class="bound">b1</span><span class="main">)</span> <span class="main">=</span> <span class="bound">msgs</span><span class="main">;</span>
      <span class="main">(</span><span class="bound">Œ±</span><span class="main">,</span> <span class="bound">œÑ</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="free">I</span><span class="main">;</span>
      <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="main">‚Üê</span> etp.S <span class="bound">Œ±</span><span class="main">;</span>
      <span class="bound">y<span class="hidden">‚á©</span><sub>œÉ</sub>'</span> <span class="main">‚Üê</span> etp.S <span class="bound">Œ±</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">y<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="main">=</span> <span class="free">F</span> <span class="bound">Œ±</span> <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="main">=</span> <span class="free">F<span class="hidden">‚á©</span><sub>i</sub><span class="hidden">‚á©</span><sub>n</sub><span class="hidden">‚á©</span><sub>v</sub></span> <span class="bound">Œ±</span> <span class="bound">œÑ</span> <span class="bound">y<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub>'</span> <span class="main">=</span> <span class="free">F<span class="hidden">‚á©</span><sub>i</sub><span class="hidden">‚á©</span><sub>n</sub><span class="hidden">‚á©</span><sub>v</sub></span> <span class="bound">Œ±</span> <span class="bound">œÑ</span> <span class="bound">y<span class="hidden">‚á©</span><sub>œÉ</sub>'</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="main">=</span> <span class="main">(</span><span class="free">B</span> <span class="bound">Œ±</span> <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">)</span> <span class="main">‚äï</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">œÉ</span> <span class="keyword1">then</span> <span class="bound">b1</span> <span class="keyword1">else</span> <span class="bound">b0</span><span class="main">)</span> <span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub>'</span> <span class="main">=</span> <span class="main">(</span><span class="free">B</span> <span class="bound">Œ±</span> <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub>'</span><span class="main">)</span> <span class="main">‚äï</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">œÉ</span> <span class="keyword1">then</span> <span class="bound">b0</span> <span class="keyword1">else</span> <span class="bound">b1</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">b</span> <span class="main">::</span> bool <span class="main">‚Üê</span> <span class="free">D2</span><span class="main">(</span><span class="bound">œÉ</span><span class="main">,</span> <span class="bound">Œ±</span><span class="main">,</span><span class="main">(</span><span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">,</span> <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub>'</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
      return_spmf <span class="bound">b</span><span class="main">}</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">D_true</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D_true</span>  <span class="main">==</span> <span class="main">Œª</span><span class="bound">œÉ</span> <span class="bound">b<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="main">(</span><span class="bound">Œ±</span><span class="main">,</span> <span class="bound">œÑ</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="free">I</span><span class="main">;</span>
    <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="main">‚Üê</span> etp.S <span class="bound">Œ±</span><span class="main">;</span>
    <span class="bound">x</span> <span class="main">‚Üê</span> <span class="main">(</span>etp.S <span class="bound">Œ±</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="main">=</span> <span class="main">(</span><span class="free">B</span> <span class="bound">Œ±</span> <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">)</span> <span class="main">‚äï</span> <span class="bound">b<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub>'</span> <span class="main">=</span> <span class="free">B</span> <span class="bound">Œ±</span> <span class="main">(</span><span class="free">F<span class="hidden">‚á©</span><sub>i</sub><span class="hidden">‚á©</span><sub>n</sub><span class="hidden">‚á©</span><sub>v</sub></span> <span class="bound">Œ±</span> <span class="bound">œÑ</span> <span class="bound">x</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">d</span> <span class="main">::</span> bool <span class="main">‚Üê</span> <span class="free">D2</span><span class="main">(</span><span class="bound">œÉ</span><span class="main">,</span> <span class="bound">Œ±</span><span class="main">,</span> <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">,</span> <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub>'</span><span class="main">)</span><span class="main">;</span>
    return_spmf <span class="bound">d</span><span class="main">}</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">D_false</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D_false</span> <span class="main">==</span> <span class="main">Œª</span> <span class="bound">œÉ</span> <span class="bound">b<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="main">(</span><span class="bound">Œ±</span><span class="main">,</span> <span class="bound">œÑ</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="free">I</span><span class="main">;</span>
    <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="main">‚Üê</span> etp.S <span class="bound">Œ±</span><span class="main">;</span>
    <span class="bound">x</span> <span class="main">‚Üê</span> etp.S <span class="bound">Œ±</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="main">=</span> <span class="main">(</span><span class="free">B</span> <span class="bound">Œ±</span> <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">)</span> <span class="main">‚äï</span> <span class="bound">b<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub>'</span> <span class="main">=</span> <span class="main">¬¨</span> <span class="free">B</span> <span class="bound">Œ±</span> <span class="main">(</span><span class="free">F<span class="hidden">‚á©</span><sub>i</sub><span class="hidden">‚á©</span><sub>n</sub><span class="hidden">‚á©</span><sub>v</sub></span> <span class="bound">Œ±</span> <span class="bound">œÑ</span> <span class="bound">x</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">d</span> <span class="main">::</span> bool <span class="main">‚Üê</span> <span class="free">D2</span><span class="main">(</span><span class="bound">œÉ</span><span class="main">,</span> <span class="bound">Œ±</span><span class="main">,</span> <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">,</span> <span class="bound">Œ≤<span class="hidden">‚á©</span><sub>œÉ</sub>'</span><span class="main">)</span><span class="main">;</span>
    return_spmf <span class="bound">d</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> lossless_D_false<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span><span class="skolem">D_false</span> <span class="free">œÉ</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="free">b1</span> <span class="keyword1">else</span> <span class="free">b0</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> D_false_def lossless_D local.etp.lossless_I<span class="main">)</span> 
        <span class="keyword1"><span class="command">using</span></span> local.etp.lossless_S <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"spmf <span class="main">(</span>etp.HCP_game ùíú <span class="free">œÉ</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="free">b1</span> <span class="keyword1">else</span> <span class="free">b0</span><span class="main">)</span> <span class="free">D2</span><span class="main">)</span> True <span class="main">=</span>  spmf <span class="main">(</span><span class="skolem">HCP_game_ùíú</span> <span class="free">œÉ</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="free">b1</span> <span class="keyword1">else</span> <span class="free">b0</span><span class="main">)</span><span class="main">)</span> True"</span></span> 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> etp.HCP_game_def HCP_game_ùíú_def ùíú_def split_def etp.F_f_inv<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rewrite</span> bind_commute_spmf<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> q <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"coin_spmf"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">rewrite</span> bind_commute_spmf<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> q <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"coin_spmf"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">rewrite</span> bind_commute_spmf<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> q <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"coin_spmf"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> spmf <span class="main">(</span>bind_spmf <span class="main">(</span>map_spmf Not coin_spmf<span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">b</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="skolem">HCP_game_true</span> <span class="free">œÉ</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="free">b1</span> <span class="keyword1">else</span> <span class="free">b0</span><span class="main">)</span> <span class="keyword1">else</span> <span class="skolem">HCP_game_false</span> <span class="free">œÉ</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="free">b1</span> <span class="keyword1">else</span> <span class="free">b0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> HCP_game_ùíú_def HCP_game_true_def HCP_game_false_def ùíú_def Let_def
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> if_cong<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> monad_normalisation<span class="main">]</span><span class="main">]</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> if_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"bind_spmf <span class="main">_</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">f</span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> bind_spmf_cong <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> if_distribR <span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span>  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">‚åë</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">‚åë</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">‚åë</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fold</span> map_spmf_conv_bind_spmf<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span> 
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> spmf_bind<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> Bochner_Integration.integral_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> r r<span class="hidden">‚á©</span><sub>œÉ</sub> Œ± œÑ 
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> UNIV_bool spmf_of_set integral_spmf_of_set<span class="main">)</span> 
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> if_cong <span class="quasi_keyword">split</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> if_split<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="skolem">r</span> <span class="main">(</span><span class="free">F<span class="hidden">‚á©</span><sub>i</sub><span class="hidden">‚á©</span><sub>n</sub><span class="hidden">‚á©</span><sub>v</sub></span> <span class="skolem">r</span> <span class="skolem">r<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="skolem">œÑ</span><span class="main">)</span>"</span></span><span class="main">)</span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span>  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">‚åë</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">‚åë</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">‚åë</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> spmf_bind<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> Bochner_Integration.integral_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> r r<span class="hidden">‚á©</span><sub>œÉ</sub> Œ± œÑ 
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> UNIV_bool spmf_of_set integral_spmf_of_set<span class="main">)</span> 
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> if_cong <span class="quasi_keyword">split</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> if_split<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">" <span class="free">B</span> <span class="skolem">r</span> <span class="main">(</span><span class="free">F<span class="hidden">‚á©</span><sub>i</sub><span class="hidden">‚á©</span><sub>n</sub><span class="hidden">‚á©</span><sub>v</sub></span> <span class="skolem">r</span> <span class="skolem">r<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="skolem">œÑ</span><span class="main">)</span>"</span></span><span class="main">)</span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span>spmf <span class="main">(</span><span class="skolem">HCP_game_true</span> <span class="free">œÉ</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="free">b1</span> <span class="keyword1">else</span> <span class="free">b0</span><span class="main">)</span><span class="main">)</span> True<span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span>spmf <span class="main">(</span><span class="skolem">HCP_game_false</span> <span class="free">œÉ</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="free">b1</span> <span class="keyword1">else</span> <span class="free">b0</span><span class="main">)</span><span class="main">)</span> True<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_bind UNIV_bool spmf_of_set integral_spmf_of_set<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span>spmf <span class="main">(</span><span class="skolem">D_true</span> <span class="free">œÉ</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="free">b1</span> <span class="keyword1">else</span> <span class="free">b0</span><span class="main">)</span><span class="main">)</span> True<span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span>spmf <span class="main">(</span><span class="skolem">D_false</span> <span class="free">œÉ</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="free">b1</span> <span class="keyword1">else</span> <span class="free">b0</span><span class="main">)</span><span class="main">)</span> False<span class="main">)</span>"</span></span>   
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"spmf <span class="main">(</span><span class="free">I</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">Œ±</span><span class="main">,</span> <span class="bound">œÑ</span><span class="main">)</span><span class="main">.</span> etp.S <span class="bound">Œ±</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">.</span> etp.S <span class="bound">Œ±</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> <span class="free">D2</span> <span class="main">(</span><span class="free">œÉ</span><span class="main">,</span> <span class="bound">Œ±</span><span class="main">,</span> <span class="free">B</span> <span class="bound">Œ±</span> <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="main">=</span> <span class="main">(</span><span class="main">¬¨</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="free">b1</span> <span class="keyword1">else</span> <span class="free">b0</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">¬¨</span> <span class="free">B</span> <span class="bound">Œ±</span> <span class="main">(</span><span class="free">F<span class="hidden">‚á©</span><sub>i</sub><span class="hidden">‚á©</span><sub>n</sub><span class="hidden">‚á©</span><sub>v</sub></span> <span class="bound">Œ±</span> <span class="bound">œÑ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">d</span><span class="main">.</span> return_spmf <span class="main">(</span><span class="main">¬¨</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True 
                <span class="main">=</span> spmf <span class="main">(</span><span class="free">I</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">Œ±</span><span class="main">,</span> <span class="bound">œÑ</span><span class="main">)</span><span class="main">.</span> etp.S <span class="bound">Œ±</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">.</span> etp.S <span class="bound">Œ±</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> <span class="free">D2</span> <span class="main">(</span><span class="free">œÉ</span><span class="main">,</span> <span class="bound">Œ±</span><span class="main">,</span> <span class="free">B</span> <span class="bound">Œ±</span> <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="main">=</span> <span class="main">(</span><span class="main">¬¨</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="free">b1</span> <span class="keyword1">else</span> <span class="free">b0</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">¬¨</span> <span class="free">B</span> <span class="bound">Œ±</span> <span class="main">(</span><span class="free">F<span class="hidden">‚á©</span><sub>i</sub><span class="hidden">‚á©</span><sub>n</sub><span class="hidden">‚á©</span><sub>v</sub></span> <span class="bound">Œ±</span> <span class="bound">œÑ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> False"</span></span>
          <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> spmf <span class="main">(</span><span class="free">I</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">Œ±</span><span class="main">,</span> <span class="bound">œÑ</span><span class="main">)</span><span class="main">.</span> etp.S <span class="bound">Œ±</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">.</span> etp.S <span class="bound">Œ±</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> <span class="free">D2</span> <span class="main">(</span><span class="free">œÉ</span><span class="main">,</span> <span class="bound">Œ±</span><span class="main">,</span> <span class="free">B</span> <span class="bound">Œ±</span> <span class="bound">x<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="main">=</span> <span class="main">(</span><span class="main">¬¨</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="free">b1</span> <span class="keyword1">else</span> <span class="free">b0</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">¬¨</span> <span class="free">B</span> <span class="bound">Œ±</span> <span class="main">(</span><span class="free">F<span class="hidden">‚á©</span><sub>i</sub><span class="hidden">‚á©</span><sub>n</sub><span class="hidden">‚á©</span><sub>v</sub></span> <span class="bound">Œ±</span> <span class="bound">œÑ</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">d</span><span class="main">.</span> return_spmf <span class="main">(</span><span class="bound">d</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> False"</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> split_def return_True_False spmf_bind<span class="main">)</span> 
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HCP_game_true_def HCP_game_false_def Let_def D_true_def D_false_def if_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> if_cong<span class="main">)</span>   
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  <span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="main">(</span>spmf <span class="main">(</span><span class="skolem">D_true</span> <span class="free">œÉ</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="free">b1</span> <span class="keyword1">else</span> <span class="free">b0</span><span class="main">)</span> <span class="main">)</span> True<span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> spmf <span class="main">(</span><span class="skolem">D_false</span> <span class="free">œÉ</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="free">b1</span> <span class="keyword1">else</span> <span class="free">b0</span><span class="main">)</span> <span class="main">)</span> True<span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_False_conv_True lossless_D_false<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">*</span> <span class="main">(</span>spmf <span class="main">(</span><span class="skolem">D_true</span> <span class="free">œÉ</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="free">b1</span> <span class="keyword1">else</span> <span class="free">b0</span><span class="main">)</span><span class="main">)</span> True<span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span>spmf <span class="main">(</span><span class="skolem">D_false</span> <span class="free">œÉ</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="free">b1</span> <span class="keyword1">else</span> <span class="free">b0</span><span class="main">)</span><span class="main">)</span> True<span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>     
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  <span class="main">1</span><span class="main">/</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">*</span> <span class="main">(</span>spmf <span class="main">(</span><span class="skolem">S2D</span> <span class="free">œÉ</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="free">b1</span> <span class="keyword1">else</span> <span class="free">b0</span><span class="main">)</span> <span class="main">)</span> True<span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span>spmf <span class="main">(</span><span class="skolem">R2D</span> <span class="main">(</span><span class="free">b0</span><span class="main">,</span><span class="free">b1</span><span class="main">)</span> <span class="free">œÉ</span> <span class="main">)</span> True<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span>  <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.etp.F_f_inv S2D_def R2D_def D_true_def D_false_def  assms split_def <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> bind_spmf_cong_simp<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> œÉ_true_b0_true<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> œÉ_false_b1_true<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S2D_def R2D_def R2_def S2_def split_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> funct_OT_12_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P2_adv_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lossless_D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">‚àÄ</span> <span class="bound">a</span><span class="main">.</span> lossless_spmf <span class="main">(</span><span class="free">D2</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬¶</span><span class="main">(</span>spmf <span class="main">(</span>bind_spmf <span class="main">(</span>R2 <span class="main">(</span><span class="free">b0</span><span class="main">,</span><span class="free">b1</span><span class="main">)</span> <span class="free">œÉ</span><span class="main">)</span> <span class="free">D2</span><span class="main">)</span> True<span class="main">)</span> <span class="main">-</span> spmf <span class="main">(</span>funct_OT_12 <span class="main">(</span><span class="free">b0</span><span class="main">,</span><span class="free">b1</span><span class="main">)</span> <span class="free">œÉ</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">out1</span><span class="main">,</span> <span class="bound">out2</span><span class="main">)</span><span class="main">.</span> S2 <span class="free">œÉ</span> <span class="bound">out2</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="free">D2</span> <span class="bound">view</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span>
                         <span class="main">‚â§</span> <span class="main">¬¶</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="main">(</span>spmf <span class="main">(</span>etp.HCP_game ùíú <span class="free">œÉ</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="free">b1</span> <span class="keyword1">else</span> <span class="free">b0</span><span class="main">)</span> <span class="free">D2</span><span class="main">)</span> True<span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">¬¶</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="free">b0</span> <span class="keyword1">else</span> <span class="free">b1</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R2_S2_False R2_S2_True assms<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> OT_12<span class="main">:</span> sim_det_def <span class="quoted">R1</span> <span class="quoted">S1</span> <span class="quoted">R2</span> <span class="quoted">S2</span> <span class="quoted">funct_OT_12</span> <span class="quoted">protocol</span> 
  <span class="keyword1"><span class="command">unfolding</span></span> sim_det_def_def 
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lossless_R1 lossless_S1 lossless_R2 lossless_S2 funct_OT_12_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> correct<span class="main">:</span> <span class="quoted"><span class="quoted">"OT_12.correctness <span class="free">m1</span> <span class="free">m2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> OT_12.correctness_def  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.collapse correctness<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> P1_security_inf_the<span class="main">:</span> <span class="quoted"><span class="quoted">"OT_12.perfect_sec_P1 <span class="free">m1</span> <span class="free">m2</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> OT_12.perfect_sec_P1_def <span class="keyword1"><span class="command">using</span></span> P1_security <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 

<span class="keyword1"><span class="command">lemma</span></span> P2_security<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">‚àÄ</span> <span class="bound">a</span><span class="main">.</span> lossless_spmf <span class="main">(</span><span class="free">D</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">‚àÄ</span> <span class="bound">b<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">.</span> etp.HCP_adv ùíú <span class="free">m2</span> <span class="bound">b<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="free">D</span> <span class="main">‚â§</span> <span class="free">HCP_ad</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"OT_12.adv_P2 <span class="free">m1</span> <span class="free">m2</span> <span class="free">D</span> <span class="main">‚â§</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">HCP_ad</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"spmf <span class="main">(</span>etp.HCP_game ùíú <span class="skolem">œÉ</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">œÉ</span> <span class="keyword1">then</span> <span class="skolem">b1</span> <span class="keyword1">else</span> <span class="skolem">b0</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> True <span class="main">=</span> spmf <span class="main">(</span>funct_OT_12 <span class="main">(</span><span class="skolem">b0</span><span class="main">,</span><span class="skolem">b1</span><span class="main">)</span> <span class="skolem">œÉ</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">out1</span><span class="main">,</span> <span class="bound">out2</span><span class="main">)</span><span class="main">.</span> etp.HCP_game ùíú <span class="skolem">œÉ</span> <span class="bound">out2</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span> True"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">œÉ</span> <span class="skolem">b0</span> <span class="skolem">b1</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> funct_OT_12_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"OT_12.adv_P2 <span class="free">m1</span> <span class="free">m2</span> <span class="free">D</span> <span class="main">‚â§</span> <span class="main">¬¶</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="main">(</span>spmf <span class="main">(</span>funct_OT_12 <span class="free">m1</span> <span class="free">m2</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">out1</span><span class="main">,</span> <span class="bound">out2</span><span class="main">)</span><span class="main">.</span> etp.HCP_game ùíú <span class="free">m2</span> <span class="bound">out2</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span> True<span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">¬¶</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> OT_12.adv_P2_def <span class="keyword1"><span class="command">using</span></span> P2_adv_bound assms surj_pair prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬¶</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="main">(</span>spmf <span class="main">(</span>funct_OT_12 <span class="free">m1</span> <span class="free">m2</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">out1</span><span class="main">,</span> <span class="bound">out2</span><span class="main">)</span><span class="main">.</span> etp.HCP_game ùíú <span class="free">m2</span> <span class="bound">out2</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span> True<span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">¬¶</span> <span class="main">‚â§</span> <span class="main">¬¶</span><span class="numeral">2</span><span class="main">*</span><span class="free">HCP_ad</span><span class="main">¬¶</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">‚àÉ</span><span class="bound">r</span><span class="main">.</span> <span class="main">¬¶</span><span class="main">(</span><span class="main">1</span><span class="main">::</span>real<span class="main">)</span> <span class="main">/</span> <span class="bound">r</span><span class="main">¬¶</span> <span class="main">‚â†</span> <span class="main">1</span> <span class="main">/</span> <span class="main">¬¶</span><span class="bound">r</span><span class="main">¬¶</span><span class="main">)</span> <span class="main">‚à®</span> <span class="numeral">2</span> <span class="main">/</span> <span class="main">¬¶</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span>spmf <span class="main">(</span>funct_OT_12 <span class="free">m1</span> <span class="free">m2</span> 
                <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">Œª</span><span class="bound">u</span> <span class="bound">b</span><span class="main">.</span> etp.HCP_game ùíú <span class="free">m2</span> <span class="bound">b</span> <span class="free">D</span><span class="main">)</span><span class="main">::</span>unit <span class="main">‚áí</span> bool <span class="main">‚áí</span> bool spmf<span class="main">)</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> True <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span><span class="main">¬¶</span> 
                      <span class="main">‚â§</span> <span class="free">HCP_ad</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assm_bound_funct_OT_12_collapse assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">HCP_ad</span> <span class="main">‚â•</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>  local.etp.HCP_adv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚Äπ We also consider the asymptotic case for security proofs ‚Ä∫</span></span>

<span class="keyword1"><span class="command">locale</span></span> ETP_sec_para <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'index</span> <span class="main">√ó</span> <span class="tfree">'trap</span><span class="main">)</span> spmf"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">domain</span> <span class="main">::</span>  <span class="quoted"><span class="quoted">"<span class="tfree">'index</span> <span class="main">‚áí</span> <span class="tfree">'range</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">range</span> <span class="main">::</span>  <span class="quoted"><span class="quoted">"<span class="tfree">'index</span> <span class="main">‚áí</span> <span class="tfree">'range</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'index</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'range</span> <span class="main">‚áí</span> <span class="tfree">'range</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">F</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'index</span> <span class="main">‚áí</span> <span class="tfree">'range</span> <span class="main">‚áí</span> <span class="tfree">'range</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">F<span class="hidden">‚á©</span><sub>i</sub><span class="hidden">‚á©</span><sub>n</sub><span class="hidden">‚á©</span><sub>v</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'index</span> <span class="main">‚áí</span> <span class="tfree">'trap</span> <span class="main">‚áí</span> <span class="tfree">'range</span> <span class="main">‚áí</span> <span class="tfree">'range</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'index</span> <span class="main">‚áí</span> <span class="tfree">'range</span> <span class="main">‚áí</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ETP_base<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">‚ãÄ</span> <span class="bound">n</span><span class="main">.</span> ETP_base <span class="main">(</span><span class="free">I</span> <span class="bound">n</span><span class="main">)</span> <span class="free">domain</span> <span class="free">range</span> <span class="free">F</span> <span class="free">F<span class="hidden">‚á©</span><sub>i</sub><span class="hidden">‚á©</span><sub>n</sub><span class="hidden">‚á©</span><sub>v</sub></span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> ETP_base <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">I</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">domain</span></span> <span class="quoted"><span class="free">range</span></span> 
  <span class="keyword1"><span class="command">using</span></span> ETP_base  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> correct_asym<span class="main">:</span> <span class="quoted"><span class="quoted">"OT_12.correctness <span class="free">n</span> <span class="free">m1</span> <span class="free">m2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> correct<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> P1_sec_asym<span class="main">:</span> <span class="quoted"><span class="quoted">"OT_12.perfect_sec_P1 <span class="free">n</span> <span class="free">m1</span> <span class="free">m2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> P1_security_inf_the <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>                                                                

<span class="keyword1"><span class="command">lemma</span></span> P2_sec_asym<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">‚àÄ</span> <span class="bound">a</span><span class="main">.</span> lossless_spmf <span class="main">(</span><span class="free">D</span> <span class="bound">a</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> HCP_adv_neg<span class="main">:</span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">Œª</span> <span class="bound">n</span><span class="main">.</span> <span class="free">etp_advantage</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> etp_adv_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">‚àÄ</span> <span class="bound">b<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="bound">n</span><span class="main">.</span> etp.HCP_adv <span class="bound">n</span> ùíú <span class="free">m2</span> <span class="bound">b<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="free">D</span> <span class="main">‚â§</span> <span class="free">etp_advantage</span> <span class="bound">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">Œª</span> <span class="bound">n</span><span class="main">.</span> OT_12.adv_P2 <span class="bound">n</span> <span class="free">m1</span> <span class="free">m2</span> <span class="free">D</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">Œª</span> <span class="bound">n</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">etp_advantage</span> <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> HCP_adv_neg 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> negligible_cmultI<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬¶</span>OT_12.adv_P2 <span class="skolem">n</span> <span class="free">m1</span> <span class="free">m2</span> <span class="free">D</span><span class="main">¬¶</span> <span class="main">=</span> OT_12.adv_P2 <span class="skolem">n</span> <span class="free">m1</span> <span class="free">m2</span> <span class="free">D</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="keyword1"><span class="command">unfolding</span></span> OT_12.adv_P2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"OT_12.adv_P2 <span class="skolem">n</span> <span class="free">m1</span> <span class="free">m2</span> <span class="free">D</span> <span class="main">‚â§</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">etp_advantage</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="keyword1"><span class="command">using</span></span> assms P2_security <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms negligible_le HCP_adv_neg P2_security <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="ETP_RSA_OT">
<div class="head">
<h1>Theory ETP_RSA_OT</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‚Äπ RSA instantiation ‚Ä∫</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‚ÄπIt is known that the RSA collection forms an ETP. Here we instantitate our proof of security for OT 
that uses a general ETP for RSA. We use the proof of the general construction of OT. The main proof effort 
here is in showing the RSA collection meets the requirements of an ETP, mainly this involves showing the 
RSA mapping is a bijection.‚Ä∫</span></span>

<span class="keyword1"><span class="command">theory</span></span> ETP_RSA_OT <span class="keyword2"><span class="keyword">imports</span></span>
  <a href="ETP_OT.html">ETP_OT</a>
  <a href="Number_Theory_Aux.html">Number_Theory_Aux</a>
  <a href="Uniform_Sampling.html">Uniform_Sampling</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> index <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">√ó</span> nat<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> trap <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> range <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> domain <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> viewP1 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span> <span class="main">√ó</span> nat <span class="main">√ó</span> nat<span class="main">)</span> spmf"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> viewP2 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool <span class="main">√ó</span> index <span class="main">√ó</span> <span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span><span class="main">)</span> spmf"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> dist2 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool <span class="main">√ó</span> index <span class="main">√ó</span> bool <span class="main">√ó</span> bool<span class="main">)</span> <span class="main">‚áí</span> bool spmf"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> advP2 <span class="main">=</span> <span class="quoted"><span class="quoted">"index <span class="main">‚áí</span> bool <span class="main">‚áí</span> bool <span class="main">‚áí</span> dist2 <span class="main">‚áí</span> bool spmf"</span></span>

<span class="keyword1"><span class="command">locale</span></span> rsa_base <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">prime_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set"</span></span> <span class="comment1">‚Äï ‚Äπthe set of primes used‚Ä∫</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"index <span class="main">‚áí</span> nat <span class="main">‚áí</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> prime_set_ass<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prime_set</span> <span class="main">‚äÜ</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> prime <span class="bound">x</span> <span class="main">‚àß</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="numeral">2</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> finite_prime_set<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">prime_set</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> prime_set_gt_2<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="free">prime_set</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prime_set_non_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prime_set</span> <span class="main">‚â†</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> prime_set_gt_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">coprime_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">‚áí</span> nat set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">coprime_set</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">‚â°</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> coprime <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">‚àß</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">‚àß</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> coprime_set_non_empty<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"coprime_set <span class="free">N</span> <span class="main">‚â†</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coprime_set_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Suc_lessE coprime_Suc_right_nat lessI numeral_2_eq_2<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sample_coprime</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">‚áí</span> nat spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">sample_coprime</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">=</span> spmf_of_set <span class="main">(</span>coprime_set <span class="main">(</span><span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> sample_coprime_e_gt_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">‚àà</span> set_spmf <span class="main">(</span>sample_coprime <span class="free">N</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sample_coprime_def coprime_set_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lossless_sample_coprime<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬¨</span> prime <span class="free">N</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span>sample_coprime <span class="free">N</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime_set <span class="free">N</span> <span class="main">‚â†</span> <span class="main">{}</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coprime_set_non_empty assms<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>coprime_set <span class="free">N</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coprime_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sample_coprime_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_spmf_sample_coprime<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set_spmf <span class="main">(</span>sample_coprime <span class="free">N</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> coprime <span class="bound">x</span> <span class="free">N</span> <span class="main">‚àß</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">‚àß</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">N</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sample_coprime_def coprime_set_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sample_primes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">sample_primes</span> <span class="main">=</span> spmf_of_set <span class="free">prime_set</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lossless_sample_primes<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lossless_spmf sample_primes"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sample_primes_def prime_set_non_empty finite_prime_set<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_spmf_sample_primes<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set_spmf sample_primes <span class="main">‚äÜ</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> prime <span class="bound">x</span> <span class="main">‚àß</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="numeral">2</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sample_primes_def prime_set_ass finite_prime_set<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> mem_samp_primes_gt_2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">‚àà</span> set_spmf sample_primes <span class="main">‚üπ</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_prime_set sample_primes_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> prime_set_ass <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> mem_samp_primes_prime<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">‚àà</span> set_spmf sample_primes <span class="main">‚üπ</span> prime <span class="free">x</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_prime_set sample_primes_def prime_set_ass<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> prime_set_ass <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sample_primes_excl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set <span class="main">‚áí</span> nat spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">sample_primes_excl</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> spmf_of_set <span class="main">(</span><span class="free">prime_set</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lossless_sample_primes_excl<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span>sample_primes_excl <span class="main">{</span><span class="free">P</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sample_primes_excl_def finite_prime_set<span class="main">)</span> 
  <span class="keyword1"><span class="command">using</span></span> prime_set_gt_2 subset_singletonD <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sample_set_excl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set <span class="main">‚áí</span> nat set <span class="main">‚áí</span> nat spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">sample_set_excl</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> spmf_of_set <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_spmf_sample_set_excl <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">Q</span> <span class="main">-</span> <span class="free">P</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set_spmf <span class="main">(</span>sample_set_excl <span class="free">Q</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Q</span> <span class="main">-</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span>  sample_set_excl_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> set_spmf_of_set assms<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lossless_sample_set_excl<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Q</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="free">Q</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span>sample_set_excl <span class="free">Q</span> <span class="main">{</span><span class="free">P</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sample_set_excl_def
  <span class="keyword1"><span class="command">using</span></span> assms subset_singletonD <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> mem_samp_primes_excl_gt_2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">‚àà</span> set_spmf <span class="main">(</span>sample_set_excl <span class="free">prime_set</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_prime_set sample_set_excl_def  prime_set_ass <span class="main">)</span> 
  <span class="keyword1"><span class="command">using</span></span> prime_set_ass <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> mem_samp_primes_excl_prime <span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">‚àà</span> set_spmf <span class="main">(</span>sample_set_excl <span class="free">prime_set</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span> <span class="main">‚üπ</span> prime <span class="free">x</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_prime_set sample_set_excl_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> prime_set_ass <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> sample_coprime_lem<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">‚àà</span> set_spmf sample_primes"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">" <span class="free">y</span> <span class="main">‚àà</span> set_spmf <span class="main">(</span>sample_set_excl <span class="free">prime_set</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> "</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span>sample_coprime <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">y</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> gt_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> mem_samp_primes_gt_2 assms mem_samp_primes_excl_gt_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬¨</span> prime <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="free">y</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">y</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> mem_samp_primes_prime mem_samp_primes_excl_prime assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> prod_not_prime gt_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="free">y</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> gt_2 One_nat_def Suc_diff_1 assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> calculation 
          divisors_zero less_2_cases nat_1_eq_mult_iff nat_neq_iff not_numeral_less_one numeral_2_eq_2 
              prime_gt_0_nat rsa_base.mem_samp_primes_excl_prime rsa_base.mem_samp_primes_prime rsa_base_axioms two_is_prime_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> lossless_sample_coprime <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>    

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">I</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>index <span class="main">√ó</span> trap<span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">P</span> <span class="main">‚Üê</span> sample_primes<span class="main">;</span>  
    <span class="bound">Q</span> <span class="main">‚Üê</span> sample_set_excl <span class="free">prime_set</span> <span class="main">{</span><span class="bound">P</span><span class="main">}</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">N</span> <span class="main">=</span> <span class="bound">P</span><span class="main">*</span><span class="bound">Q</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">N'</span> <span class="main">=</span> <span class="main">(</span><span class="bound">P</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="bound">Q</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">e</span> <span class="main">‚Üê</span> sample_coprime <span class="bound">N'</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">d</span> <span class="main">=</span> nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="bound">e</span> <span class="bound">N'</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="bound">N'</span><span class="main">)</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">(</span><span class="bound">N</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lossless_I<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf I"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> I_def lossless_sample_primes lossless_sample_set_excl finite_prime_set prime_set_gt_2 Let_def sample_coprime_lem<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_spmf_I_N<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">N</span><span class="main">,</span><span class="free">e</span><span class="main">)</span><span class="main">,</span><span class="free">d</span><span class="main">)</span> <span class="main">‚àà</span> set_spmf I"</span></span> 
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">P</span> <span class="free">Q</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> <span class="free">P</span> <span class="main">*</span> <span class="free">Q</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">‚â†</span> <span class="free">Q</span>"</span></span>  
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">P</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">Q</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">e</span> <span class="main">(</span><span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="free">Q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">=</span> nat <span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">e</span> <span class="main">(</span><span class="main">(</span><span class="free">P</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="free">Q</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="main">(</span><span class="main">(</span><span class="free">P</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="free">Q</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> I_def Let_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">using</span></span> finite_prime_set mem_samp_primes_prime sample_set_excl_def rsa_base_axioms sample_primes_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_spmf_sample_coprime<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_spmf_I_e_d<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">N</span><span class="main">,</span><span class="free">e</span><span class="main">)</span><span class="main">,</span><span class="free">d</span><span class="main">)</span> <span class="main">‚àà</span> set_spmf I"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms sample_coprime_e_gt_1  
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> I_def Let_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Euclidean_Division.pos_mod_sign Num.of_nat_simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> Suc_diff_1 bezw_inverse cong_def coprime_imp_gcd_eq_1 gr0I less_1_mult less_numeral_extra<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> mem_Collect_eq mod_by_0 mod_less more_arith_simps<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> nat_0 nat_0_less_mult_iff nat_int nat_neq_iff numerals<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> of_nat_0_le_iff of_nat_1 rsa_base.mem_samp_primes_gt_2 rsa_base_axioms set_spmf_sample_coprime zero_less_diff<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">domain</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"index <span class="main">‚áí</span> nat set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">domain</span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="main">‚â°</span> <span class="main">{..&lt;</span> fst <span class="free"><span class="bound"><span class="entity">index</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">range</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"index <span class="main">‚áí</span> nat set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">range</span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="main">‚â°</span> <span class="main">{..&lt;</span> fst <span class="free"><span class="bound"><span class="entity">index</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_range<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="free">index</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> range_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dom_eq_ran<span class="main">:</span> <span class="quoted"><span class="quoted">"domain <span class="free">index</span> <span class="main">=</span> range <span class="free">index</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> range_def domain_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">F</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"index <span class="main">‚áí</span> <span class="main">(</span>nat <span class="main">‚áí</span> nat<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">^</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">index</span></span></span><span class="main">)</span> <span class="keyword1">mod</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">index</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">F<span class="hidden">‚á©</span><sub>i</sub><span class="hidden">‚á©</span><sub>n</sub><span class="hidden">‚á©</span><sub>v</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"index <span class="main">‚áí</span> trap <span class="main">‚áí</span> nat <span class="main">‚áí</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">F<span class="hidden">‚á©</span><sub>i</sub><span class="hidden">‚á©</span><sub>n</sub><span class="hidden">‚á©</span><sub>v</sub></span> <span class="free"><span class="bound"><span class="entity">Œ±</span></span></span> <span class="free"><span class="bound"><span class="entity">œÑ</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">^</span> <span class="free"><span class="bound"><span class="entity">œÑ</span></span></span> <span class="keyword1">mod</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">Œ±</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚Äπ We must prove the RSA function is a bijection ‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rsa_bijection<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> coprime<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="free">e</span> <span class="main">(</span><span class="main">(</span><span class="free">P</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="free">Q</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> prime_P<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="main">(</span><span class="free">P</span><span class="main">::</span>nat<span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> prime_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="free">Q</span>"</span></span>   
    <span class="keyword2"><span class="keyword">and</span></span> P_neq_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">‚â†</span> <span class="free">Q</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> x_lt_pq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">P</span> <span class="main">*</span> <span class="free">Q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> y_lt_pd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&lt;</span> <span class="free">P</span> <span class="main">*</span> <span class="free">Q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> rsa_map_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">^</span> <span class="free">e</span> <span class="keyword1">mod</span> <span class="main">(</span><span class="free">P</span> <span class="main">*</span> <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span> <span class="main">^</span> <span class="free">e</span> <span class="keyword1">mod</span> <span class="main">(</span><span class="free">P</span> <span class="main">*</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> flt_xP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">^</span> <span class="free">P</span> <span class="main">=</span> <span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> fermat_little prime_P <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> flt_yP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">y</span> <span class="main">^</span> <span class="free">P</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> fermat_little prime_P <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> flt_xQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">^</span> <span class="free">Q</span> <span class="main">=</span> <span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">Q</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> fermat_little prime_Q <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> flt_yQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">y</span> <span class="main">^</span> <span class="free">Q</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">Q</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> fermat_little prime_Q <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">‚â•</span> <span class="free">x</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> ye_gt_xe<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main">^</span><span class="free">e</span> <span class="main">‚â•</span> <span class="free">x</span><span class="main">^</span><span class="free">e</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> x_y_exp_e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span><span class="main">^</span><span class="free">e</span> <span class="main">=</span> <span class="free">y</span><span class="main">^</span><span class="free">e</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cong_modulus_mult_nat  cong_altdef_nat True ye_gt_xe cong_sym cong_def assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> d<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">e</span><span class="main">*</span><span class="skolem">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span><span class="free">P</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">‚àß</span> <span class="skolem">d</span> <span class="main">‚â†</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> ex_inverse assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span><span class="main">*</span><span class="skolem">d</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">*</span><span class="main">(</span><span class="free">P</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> ex_k_mod assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">hence</span></span> xk_yk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span><span class="main">^</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">*</span><span class="main">(</span><span class="free">P</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span><span class="main">^</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">*</span><span class="main">(</span><span class="free">P</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> k power_mult x_y_exp_e cong_pow<span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> xk_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span><span class="main">^</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">*</span><span class="main">(</span><span class="free">P</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span>  asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> exp_rewrite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> add.assoc add.commute le_add_diff_inverse nat_le_linear not_add_less1 prime_P prime_gt_1_nat semiring_normalization_rules<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">*</span> <span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> asm <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">x</span> <span class="main">^</span> <span class="free">P</span> <span class="main">=</span> <span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> flt_xP
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cong_scalar_right cong_trans mult.commute<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_add<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span>  
          <span class="keyword1"><span class="command">using</span></span> exp_rewrite <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> 
    <span class="keyword1"><span class="command">have</span></span> yk_y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">y</span><span class="main">^</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">*</span><span class="main">(</span><span class="free">P</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span>  asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">y</span> <span class="main">^</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> exp_rewrite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> add.assoc add.commute le_add_diff_inverse nat_le_linear not_add_less1 prime_P prime_gt_1_nat semiring_normalization_rules<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">y</span> <span class="main">*</span> <span class="free">y</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> asm <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">y</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">y</span> <span class="main">^</span> <span class="free">P</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> flt_yP
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cong_scalar_right cong_trans mult.commute<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">y</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_add<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">y</span> <span class="main">^</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span>  
          <span class="keyword1"><span class="command">using</span></span> exp_rewrite <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span><span class="main">^</span><span class="free">e</span> <span class="main">=</span> <span class="free">y</span><span class="main">^</span><span class="free">e</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rsa_map_eq cong_modulus_mult_nat cong_def mult.commute<span class="main">)</span> 
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d'</span></span> <span class="keyword2"><span class="keyword">where</span></span> d'<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">e</span><span class="main">*</span><span class="skolem">d'</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span><span class="free">Q</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">‚àß</span> <span class="skolem">d'</span> <span class="main">‚â†</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult.commute ex_inverse prime_P prime_Q P_neq_Q coprime<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> k'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span><span class="main">*</span><span class="skolem">d'</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="skolem">k'</span><span class="main">*</span><span class="main">(</span><span class="free">Q</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> ex_k_mod mult.commute prime_P prime_Q P_neq_Q coprime<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> xk_yk'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span><span class="main">^</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">k'</span><span class="main">*</span><span class="main">(</span><span class="free">Q</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span><span class="main">^</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">k'</span><span class="main">*</span><span class="main">(</span><span class="free">Q</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> k' power_mult <span class="quoted"><span class="quoted">‚Äπ<span class="main">[</span><span class="free">x</span> <span class="main">^</span> <span class="free">e</span> <span class="main">=</span> <span class="free">y</span> <span class="main">^</span> <span class="free">e</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">Q</span><span class="main">)</span>‚Ä∫</span></span> cong_pow<span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> xk_x'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span><span class="main">^</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">k'</span><span class="main">*</span><span class="main">(</span><span class="free">Q</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">Q</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">k'</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k'</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span>  asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">k'</span> <span class="main">*</span> <span class="main">(</span><span class="free">Q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> exp_rewrite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">k'</span> <span class="main">*</span> <span class="main">(</span><span class="free">Q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">k'</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">Q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> add.assoc add.commute le_add_diff_inverse nat_le_linear not_add_less1 prime_Q prime_gt_1_nat semiring_normalization_rules<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">*</span> <span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">k'</span> <span class="main">*</span> <span class="main">(</span><span class="free">Q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> asm <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">k'</span> <span class="main">*</span> <span class="main">(</span><span class="free">Q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">x</span> <span class="main">^</span> <span class="free">Q</span> <span class="main">=</span> <span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> flt_xQ
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cong_scalar_right cong_trans mult.commute<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">k'</span> <span class="main">*</span> <span class="main">(</span><span class="free">Q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_add<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">k'</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">Q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">Q</span><span class="main">)</span>"</span></span>  
          <span class="keyword1"><span class="command">using</span></span> exp_rewrite <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> 
    <span class="keyword1"><span class="command">have</span></span> yk_y'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">y</span><span class="main">^</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">k'</span><span class="main">*</span><span class="main">(</span><span class="free">Q</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">Q</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">k'</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k'</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span>  asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">y</span> <span class="main">^</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">k'</span> <span class="main">*</span> <span class="main">(</span><span class="free">Q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> exp_rewrite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">k'</span> <span class="main">*</span> <span class="main">(</span><span class="free">Q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">k'</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">Q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> add.assoc add.commute le_add_diff_inverse nat_le_linear not_add_less1 prime_Q prime_gt_1_nat semiring_normalization_rules<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">y</span> <span class="main">*</span> <span class="free">y</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">k'</span> <span class="main">*</span> <span class="main">(</span><span class="free">Q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> asm <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">y</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">k'</span> <span class="main">*</span> <span class="main">(</span><span class="free">Q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">y</span> <span class="main">^</span> <span class="free">Q</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> flt_yQ
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cong_scalar_right cong_trans mult.commute<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">y</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">k'</span> <span class="main">*</span> <span class="main">(</span><span class="free">Q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_add<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">y</span> <span class="main">^</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">k'</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">Q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">Q</span><span class="main">)</span>"</span></span>  
          <span class="keyword1"><span class="command">using</span></span> exp_rewrite <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> 
    <span class="keyword1"><span class="command">have</span></span> P_dvd_xy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="free">y</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> xk_x yk_y xk_yk 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> cong_altdef_nat cong_sym True <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> Q_dvd_xy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="free">y</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> xk_x' yk_y' xk_yk'  
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> cong_altdef_nat cong_sym True <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span><span class="main">*</span><span class="free">Q</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="free">y</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P_dvd_xy  Q_dvd_xy  
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms divides_mult primes_coprime<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">*</span><span class="free">Q</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_altdef_nat cong_sym True<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">mod</span> <span class="free">P</span><span class="main">*</span><span class="free">Q</span> <span class="main">=</span> <span class="free">y</span> <span class="keyword1">mod</span> <span class="free">P</span><span class="main">*</span><span class="free">Q</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span>  cong_def xk_x xk_yk yk_y <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">[</span><span class="free">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span> <span class="main">*</span> <span class="free">Q</span><span class="main">)</span>‚Ä∫</span></span> cong_less_modulus_unique_nat x_lt_pq y_lt_pd <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> ye_gt_xe<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">^</span><span class="free">e</span> <span class="main">‚â•</span> <span class="free">y</span><span class="main">^</span><span class="free">e</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> pow_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span><span class="main">^</span><span class="free">e</span> <span class="main">=</span> <span class="free">y</span><span class="main">^</span><span class="free">e</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">*</span><span class="free">Q</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def assms<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> PQ_dvd_ye_xe<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span><span class="main">*</span><span class="free">Q</span><span class="main">)</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="free">x</span><span class="main">^</span><span class="free">e</span> <span class="main">-</span> <span class="free">y</span><span class="main">^</span><span class="free">e</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> cong_altdef_nat False ye_gt_xe cong_sym <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span><span class="main">^</span><span class="free">e</span> <span class="main">=</span> <span class="free">y</span><span class="main">^</span><span class="free">e</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cong_modulus_mult_nat pow_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> d<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">e</span><span class="main">*</span><span class="skolem">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span><span class="free">P</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">‚àß</span> <span class="skolem">d</span> <span class="main">‚â†</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ex_inverse assms
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span><span class="main">*</span><span class="skolem">d</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">*</span><span class="main">(</span><span class="free">P</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ex_k_mod assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">have</span></span> xk_yk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span><span class="main">^</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">*</span><span class="main">(</span><span class="free">P</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span><span class="main">^</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">*</span><span class="main">(</span><span class="free">P</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">x</span><span class="main">^</span><span class="free">e</span><span class="main">)</span><span class="main">^</span><span class="skolem">d</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span><span class="main">^</span><span class="free">e</span><span class="main">)</span><span class="main">^</span><span class="skolem">d</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">[</span><span class="free">x</span> <span class="main">^</span> <span class="free">e</span> <span class="main">=</span> <span class="free">y</span> <span class="main">^</span> <span class="free">e</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>‚Ä∫</span></span> cong_pow <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span><span class="main">^</span><span class="main">(</span><span class="free">e</span><span class="main">*</span><span class="skolem">d</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span><span class="main">^</span><span class="main">(</span><span class="free">e</span><span class="main">*</span><span class="skolem">d</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_mult<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> k <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> xk_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span><span class="main">^</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">*</span><span class="main">(</span><span class="free">P</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span>  
   <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span>  asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> exp_rewrite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> add.assoc add.commute le_add_diff_inverse nat_le_linear not_add_less1 prime_P prime_gt_1_nat semiring_normalization_rules<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">*</span> <span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> asm <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">x</span> <span class="main">^</span> <span class="free">P</span> <span class="main">=</span> <span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> flt_xP
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cong_scalar_right cong_trans mult.commute<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_add<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span>  
          <span class="keyword1"><span class="command">using</span></span> exp_rewrite <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> 
    <span class="keyword1"><span class="command">have</span></span> yk_y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">y</span><span class="main">^</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">*</span><span class="main">(</span><span class="free">P</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span> 
   <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span>  asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">y</span> <span class="main">^</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> exp_rewrite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> add.assoc add.commute le_add_diff_inverse nat_le_linear not_add_less1 prime_P prime_gt_1_nat semiring_normalization_rules<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">y</span> <span class="main">*</span> <span class="free">y</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> asm <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">y</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">y</span> <span class="main">^</span> <span class="free">P</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> flt_yP
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cong_scalar_right cong_trans mult.commute<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">y</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_add<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">y</span> <span class="main">^</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span>  
          <span class="keyword1"><span class="command">using</span></span> exp_rewrite <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> 
    <span class="keyword1"><span class="command">have</span></span> P_dvd_xy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> xk_x yk_y xk_yk 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> cong_altdef_nat cong_sym False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span><span class="main">^</span><span class="free">e</span> <span class="main">=</span> <span class="free">y</span><span class="main">^</span><span class="free">e</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cong_modulus_mult_nat pow_eq PQ_dvd_ye_xe cong_dvd_modulus_nat dvd_triv_right <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d'</span></span> <span class="keyword2"><span class="keyword">where</span></span> d'<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">e</span><span class="main">*</span><span class="skolem">d'</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span><span class="free">Q</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">‚àß</span> <span class="skolem">d'</span> <span class="main">‚â†</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult.commute ex_inverse prime_P prime_Q coprime P_neq_Q<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> k'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span><span class="main">*</span><span class="skolem">d'</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="skolem">k'</span><span class="main">*</span><span class="main">(</span><span class="free">Q</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> ex_k_mod mult.commute prime_P prime_Q coprime P_neq_Q<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> xk_yk'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span><span class="main">^</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">k'</span><span class="main">*</span><span class="main">(</span><span class="free">Q</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span><span class="main">^</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">k'</span><span class="main">*</span><span class="main">(</span><span class="free">Q</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">x</span><span class="main">^</span><span class="free">e</span><span class="main">)</span><span class="main">^</span><span class="skolem">d'</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span><span class="main">^</span><span class="free">e</span><span class="main">)</span><span class="main">^</span><span class="skolem">d'</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">Q</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">[</span><span class="free">x</span> <span class="main">^</span> <span class="free">e</span> <span class="main">=</span> <span class="free">y</span> <span class="main">^</span> <span class="free">e</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">Q</span><span class="main">)</span>‚Ä∫</span></span> cong_pow <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span><span class="main">^</span><span class="main">(</span><span class="free">e</span><span class="main">*</span><span class="skolem">d'</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span><span class="main">^</span><span class="main">(</span><span class="free">e</span><span class="main">*</span><span class="skolem">d'</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">Q</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_mult<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> k'
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> xk_x'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span><span class="main">^</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">k'</span><span class="main">*</span><span class="main">(</span><span class="free">Q</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">Q</span><span class="main">)</span>"</span></span>  
   <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">k'</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k'</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span>  asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">k'</span> <span class="main">*</span> <span class="main">(</span><span class="free">Q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> exp_rewrite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">k'</span> <span class="main">*</span> <span class="main">(</span><span class="free">Q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">k'</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">Q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> add.assoc add.commute le_add_diff_inverse nat_le_linear not_add_less1 prime_Q prime_gt_1_nat semiring_normalization_rules<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">*</span> <span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">k'</span> <span class="main">*</span> <span class="main">(</span><span class="free">Q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> asm <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">k'</span> <span class="main">*</span> <span class="main">(</span><span class="free">Q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">x</span> <span class="main">^</span> <span class="free">Q</span> <span class="main">=</span> <span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> flt_xQ
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cong_scalar_right cong_trans mult.commute<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">k'</span> <span class="main">*</span> <span class="main">(</span><span class="free">Q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_add<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">k'</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">Q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">Q</span><span class="main">)</span>"</span></span>  
          <span class="keyword1"><span class="command">using</span></span> exp_rewrite <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> 
    <span class="keyword1"><span class="command">have</span></span> yk_y'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">y</span><span class="main">^</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">k'</span><span class="main">*</span><span class="main">(</span><span class="free">Q</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">Q</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">k'</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k'</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span>  asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">y</span> <span class="main">^</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">k'</span> <span class="main">*</span> <span class="main">(</span><span class="free">Q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> exp_rewrite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">k'</span> <span class="main">*</span> <span class="main">(</span><span class="free">Q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">k'</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">Q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> add.assoc add.commute le_add_diff_inverse nat_le_linear not_add_less1 prime_Q prime_gt_1_nat semiring_normalization_rules<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">y</span> <span class="main">*</span> <span class="free">y</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">k'</span> <span class="main">*</span> <span class="main">(</span><span class="free">Q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> asm <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">y</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">k'</span> <span class="main">*</span> <span class="main">(</span><span class="free">Q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">y</span> <span class="main">^</span> <span class="free">Q</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> flt_yQ
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cong_scalar_right cong_trans mult.commute<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">y</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">k'</span> <span class="main">*</span> <span class="main">(</span><span class="free">Q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_add<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">y</span> <span class="main">^</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">k'</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">Q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">Q</span><span class="main">)</span>"</span></span>  
          <span class="keyword1"><span class="command">using</span></span> exp_rewrite <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> 
    <span class="keyword1"><span class="command">have</span></span> Q_dvd_xy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">Q</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> xk_x' yk_y' xk_yk' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> cong_altdef_nat cong_sym False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span><span class="main">*</span><span class="free">Q</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> P_dvd_xy Q_dvd_xy <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms divides_mult primes_coprime<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">*</span><span class="free">Q</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> False cong_altdef_nat linear <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">mod</span> <span class="free">P</span><span class="main">*</span><span class="free">Q</span> <span class="main">=</span> <span class="free">y</span> <span class="keyword1">mod</span> <span class="free">P</span><span class="main">*</span><span class="free">Q</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> cong_less_modulus_unique_nat x_lt_pq y_lt_pd <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> 1 cong_less_modulus_unique_nat x_lt_pq y_lt_pd <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rsa_bij_betw<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">e</span> <span class="main">(</span><span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="free">Q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">P</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">Q</span>"</span></span>   
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">‚â†</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span>F <span class="main">(</span><span class="main">(</span><span class="free">P</span> <span class="main">*</span> <span class="free">Q</span><span class="main">)</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>range <span class="main">(</span><span class="main">(</span><span class="free">P</span> <span class="main">*</span> <span class="free">Q</span><span class="main">)</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>range <span class="main">(</span><span class="main">(</span><span class="free">P</span> <span class="main">*</span> <span class="free">Q</span><span class="main">)</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> PQ_not_0<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="free">P</span> <span class="main">‚ü∂</span> prime <span class="free">Q</span> <span class="main">‚ü∂</span> <span class="free">P</span> <span class="main">*</span> <span class="free">Q</span> <span class="main">‚â†</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">^</span> snd <span class="main">(</span><span class="free">P</span> <span class="main">*</span> <span class="free">Q</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="keyword1">mod</span> fst <span class="main">(</span><span class="free">P</span> <span class="main">*</span> <span class="free">Q</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span>fst <span class="main">(</span><span class="free">P</span> <span class="main">*</span> <span class="free">Q</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span> 
    <span class="keyword1"><span class="command">using</span></span> rsa_bijection assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">^</span> snd <span class="main">(</span><span class="free">P</span> <span class="main">*</span> <span class="free">Q</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="keyword1">mod</span> fst <span class="main">(</span><span class="free">P</span> <span class="main">*</span> <span class="free">Q</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{..&lt;</span>fst <span class="main">(</span><span class="free">P</span> <span class="main">*</span> <span class="free">Q</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{..&lt;</span>fst <span class="main">(</span><span class="free">P</span> <span class="main">*</span> <span class="free">Q</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> prime_gt_0_nat PQ_not_0<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> endo_inj_surj<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> image_subsetI prime_gt_0_nat PQ_not_0 inj_on_def<span class="main">)</span> 
    <span class="keyword1"><span class="command">using</span></span> rsa_bijection assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def F_def range_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bij_betw1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">N</span><span class="main">,</span><span class="free">e</span><span class="main">)</span><span class="main">,</span><span class="free">d</span><span class="main">)</span> <span class="main">‚àà</span> set_spmf I"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span>F <span class="main">(</span><span class="main">(</span><span class="free">N</span><span class="main">)</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>range <span class="main">(</span><span class="main">(</span><span class="free">N</span><span class="main">)</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>range <span class="main">(</span><span class="main">(</span><span class="free">N</span><span class="main">)</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> <span class="skolem">P</span> <span class="main">*</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span>F <span class="main">(</span><span class="main">(</span><span class="skolem">P</span><span class="main">*</span><span class="skolem">Q</span><span class="main">)</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>range <span class="main">(</span><span class="main">(</span><span class="skolem">P</span><span class="main">*</span><span class="skolem">Q</span><span class="main">)</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>range <span class="main">(</span><span class="main">(</span><span class="skolem">P</span><span class="main">*</span><span class="skolem">Q</span><span class="main">)</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> <span class="skolem">P</span> <span class="main">*</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">‚â†</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">e</span> <span class="main">(</span><span class="main">(</span><span class="skolem">P</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="skolem">Q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> set_spmf_I_N assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> rsa_bij_betw that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">dvd</span> <span class="free">x</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms cong_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> rsa_inv<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">=</span> nat <span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">e</span> <span class="main">(</span><span class="main">(</span><span class="free">P</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="free">Q</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="main">(</span><span class="main">(</span><span class="free">P</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="free">Q</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> coprime<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="free">e</span> <span class="main">(</span><span class="main">(</span><span class="free">P</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="free">Q</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> prime_P<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="main">(</span><span class="free">P</span><span class="main">::</span>nat<span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> prime_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="free">Q</span>"</span></span>   
    <span class="keyword2"><span class="keyword">and</span></span> P_neq_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">‚â†</span> <span class="free">Q</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> e_gt_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> d_gt_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">)</span> <span class="main">^</span> <span class="free">e</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="main">(</span><span class="free">P</span><span class="main">*</span><span class="free">Q</span><span class="main">)</span><span class="main">)</span> <span class="main">^</span> <span class="free">d</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="main">(</span><span class="free">P</span><span class="main">*</span><span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">mod</span> <span class="main">(</span><span class="free">P</span><span class="main">*</span><span class="free">Q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">‚à®</span> <span class="free">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> le_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> nat_power_eq_Suc_0_iff neq0_conv not_one_le_zero numeral_nat<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> power_eq_0_iff power_mod<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> x_gt_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">^</span> <span class="free">e</span><span class="main">)</span> <span class="main">^</span> <span class="free">d</span> <span class="main">-</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> z_gt_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">^</span> <span class="free">e</span><span class="main">)</span> <span class="main">^</span> <span class="free">d</span> <span class="main">-</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="free">e</span> <span class="main">*</span> <span class="free">d</span><span class="main">)</span> <span class="main">-</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_mult<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> x_gt_1 e_gt_1 d_gt_1 le_neq_implies_less less_one linorder_not_less n_less_m_mult_n not_less_zero numeral_nat<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> power_increasing_iff power_one_right zero_less_diff<span class="main">)</span> 
    <span class="keyword1"><span class="command">ultimately</span></span>  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> z_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">z</span> <span class="main">=</span> <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">‚â†</span> <span class="free">d</span> <span class="main">*</span> <span class="free">e</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> assms assms mult_is_0 not_one_less_zero<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Groups.add_ac<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> True add_diff_inverse_nat cong_def cong_dvd_iff cong_mult_self_right dvd_0_right dvd_def dvd_trans mod_add_self2 more_arith_simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> nat_diff_split power_eq_if power_mult semiring_normalization_rules<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> z_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">e</span> <span class="main">*</span> <span class="free">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span><span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">Q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> d bezw_inverse coprime coprime_imp_gcd_eq_1 nat_int<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">e</span> <span class="main">*</span> <span class="free">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms cong_modulus_mult_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span><span class="main">*</span><span class="free">d</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">*</span><span class="main">(</span><span class="free">P</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> ex_k_mod assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="free">e</span> <span class="main">*</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> power_add power_one_right mult.commute power_mult<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="free">e</span> <span class="main">*</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">k</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> cong_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> prime_P fermat_theorem False
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_0_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="free">e</span> <span class="main">*</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">k</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="free">e</span> <span class="main">*</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">k</span>‚Ä∫</span></span> calculation<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> cong_pow cong_scalar_left<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="free">e</span> <span class="main">*</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> z_def z_gt_0 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_diff_iff_cong_0_nat power_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">z</span> <span class="main">=</span> <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">Q</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">Q</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">‚â†</span> <span class="free">d</span> <span class="main">*</span> <span class="free">e</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> assms mult_is_0 not_one_less_zero<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Groups.add_ac<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> True add_diff_inverse_nat cong_def cong_dvd_iff cong_mult_self_right dvd_0_right dvd_def dvd_trans mod_add_self2 more_arith_simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> nat_diff_split power_eq_if power_mult semiring_normalization_rules<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> z_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">e</span> <span class="main">*</span> <span class="free">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span><span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">Q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> d bezw_inverse coprime coprime_imp_gcd_eq_1 nat_int<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">e</span> <span class="main">*</span> <span class="free">d</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span><span class="free">Q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms cong_modulus_mult_nat mult.commute <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span><span class="main">*</span><span class="free">d</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">*</span><span class="main">(</span><span class="free">Q</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> ex_k_mod assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="free">e</span> <span class="main">*</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="free">Q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> power_add power_one_right mult.commute power_mult<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="free">e</span> <span class="main">*</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="free">Q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">k</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">P</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> cong_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="free">Q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> prime_Q fermat_theorem False
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_0_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="free">e</span> <span class="main">*</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">k</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="free">e</span> <span class="main">*</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="free">Q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">k</span>‚Ä∫</span></span> calculation<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> cong_pow cong_scalar_left<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="free">e</span> <span class="main">*</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> z_def z_gt_0 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_diff_iff_cong_0_nat power_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="free">x</span> <span class="main">^</span> <span class="free">e</span><span class="main">)</span> <span class="main">^</span> <span class="free">d</span> <span class="main">-</span> <span class="free">x</span>"</span></span>
                  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="free">x</span> <span class="main">^</span> <span class="free">e</span><span class="main">)</span> <span class="main">^</span> <span class="free">d</span> <span class="main">-</span> <span class="free">x</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> z_def assms cong_0_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">*</span> <span class="free">Q</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">^</span> <span class="free">e</span><span class="main">)</span> <span class="main">^</span> <span class="free">d</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms divides_mult primes_coprime_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">x</span> <span class="main">^</span> <span class="free">e</span><span class="main">)</span> <span class="main">^</span> <span class="free">d</span> <span class="main">=</span> <span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span><span class="free">P</span> <span class="main">*</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> z_gt_0 cong_altdef_nat z_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def power_mod<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> rsa_inv_set_spmf_I<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">N</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span><span class="main">,</span> <span class="free">d</span><span class="main">)</span> <span class="main">‚àà</span> set_spmf I"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">^</span> <span class="free">e</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">N</span><span class="main">)</span> <span class="main">^</span> <span class="free">d</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">N</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">mod</span> <span class="free">N</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> <span class="skolem">P</span> <span class="main">*</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">=</span> nat <span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">e</span> <span class="main">(</span><span class="main">(</span><span class="skolem">P</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="skolem">Q</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="main">(</span><span class="main">(</span><span class="skolem">P</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="skolem">Q</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>  
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">P</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">Q</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">e</span> <span class="main">(</span><span class="main">(</span><span class="skolem">P</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="skolem">Q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">‚â†</span> <span class="skolem">Q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms set_spmf_I_N 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> set_spmf_I_e_d assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rsa_inv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">sublocale</span></span> etp_rsa<span class="main">:</span> etp <span class="quoted">I</span> <span class="quoted">domain</span> <span class="quoted">range</span> <span class="quoted">F</span> <span class="quoted">F<span class="hidden">‚á©</span><sub>i</sub><span class="hidden">‚á©</span><sub>n</sub><span class="hidden">‚á©</span><sub>v</sub></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> etp_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> etp_def dom_eq_ran finite_range bij_betw1 lossless_I<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv lessThan_iff mem_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> nat_0_less_mult_iff prime_gt_0_nat range_def set_spmf_I_N<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> F_def F<span class="hidden">‚á©</span><sub>i</sub><span class="hidden">‚á©</span><sub>n</sub><span class="hidden">‚á©</span><sub>v</sub>_def<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> rsa_inv_set_spmf_I 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> range_def<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> etp<span class="main">:</span> ETP_base <span class="quoted">I</span> <span class="quoted">domain</span> <span class="quoted">range</span> <span class="quoted"><span class="free">B</span></span> <span class="quoted">F</span> <span class="quoted">F<span class="hidden">‚á©</span><sub>i</sub><span class="hidden">‚á©</span><sub>n</sub><span class="hidden">‚á©</span><sub>v</sub></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ETP_base_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> etp_rsa.etp_axioms<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‚ÄπAfter proving the RSA collection is an ETP the proofs of security come easily from the general proofs.‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> correctness_rsa<span class="main">:</span> <span class="quoted"><span class="quoted">"etp.OT_12.correctness <span class="free">m1</span> <span class="free">m2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> local.etp.correct<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> P1_security_rsa<span class="main">:</span> <span class="quoted"><span class="quoted">"etp.OT_12.perfect_sec_P1 <span class="free">m1</span> <span class="free">m2</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> local.etp.P1_security_inf_the<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> P2_security_rsa<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">‚àÄ</span> <span class="bound">a</span><span class="main">.</span> lossless_spmf <span class="main">(</span><span class="free">D</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">‚ãÄ</span><span class="bound">b<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">.</span> local.etp_rsa.HCP_adv etp.ùíú <span class="free">m2</span> <span class="bound">b<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="free">D</span> <span class="main">‚â§</span> <span class="free">HCP_ad</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"etp.OT_12.adv_P2 <span class="free">m1</span> <span class="free">m2</span> <span class="free">D</span> <span class="main">‚â§</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">HCP_ad</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.etp.P2_security assms<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span> 

<span class="keyword1"><span class="command">locale</span></span> rsa_asym <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">prime_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">‚áí</span> nat set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"index <span class="main">‚áí</span> nat <span class="main">‚áí</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rsa_proof_assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">‚ãÄ</span> <span class="bound">n</span><span class="main">.</span> rsa_base <span class="main">(</span><span class="free">prime_set</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> rsa_base <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">prime_set</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">B</span></span>  
  <span class="keyword1"><span class="command">using</span></span> local.rsa_proof_assm  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> correctness_rsa_asymp<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"etp.OT_12.correctness <span class="free">n</span> <span class="free">m1</span> <span class="free">m2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> correctness_rsa<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> P1_sec_asymp<span class="main">:</span> <span class="quoted"><span class="quoted">"etp.OT_12.perfect_sec_P1 <span class="free">n</span> <span class="free">m1</span> <span class="free">m2</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> local.P1_security_rsa<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> P2_sec_asym<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">‚àÄ</span> <span class="bound">a</span><span class="main">.</span> lossless_spmf <span class="main">(</span><span class="free">D</span> <span class="bound">a</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> HCP_adv_neg<span class="main">:</span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">Œª</span> <span class="bound">n</span><span class="main">.</span> <span class="free">hcp_advantage</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> hcp_adv_bound<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">‚àÄ</span><span class="bound">b<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="bound">n</span><span class="main">.</span> local.etp_rsa.HCP_adv <span class="bound">n</span> etp.ùíú <span class="free">m2</span> <span class="bound">b<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="free">D</span> <span class="main">‚â§</span> <span class="free">hcp_advantage</span> <span class="bound">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">Œª</span> <span class="bound">n</span><span class="main">.</span> etp.OT_12.adv_P2 <span class="bound">n</span> <span class="free">m1</span> <span class="free">m2</span> <span class="free">D</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">Œª</span> <span class="bound">n</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">hcp_advantage</span> <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> HCP_adv_neg 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> negligible_cmultI<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬¶</span>etp.OT_12.adv_P2 <span class="skolem">n</span> <span class="free">m1</span> <span class="free">m2</span> <span class="free">D</span><span class="main">¬¶</span> <span class="main">=</span> etp.OT_12.adv_P2 <span class="skolem">n</span> <span class="free">m1</span> <span class="free">m2</span> <span class="free">D</span>"</span></span> 
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="keyword1"><span class="command">unfolding</span></span> sim_det_def.adv_P2_def local.etp.OT_12.adv_P2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"etp.OT_12.adv_P2 <span class="skolem">n</span> <span class="free">m1</span> <span class="free">m2</span> <span class="free">D</span> <span class="main">‚â§</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">hcp_advantage</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">using</span></span> P2_security_rsa assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms negligible_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Noar_Pinkas_OT">
<div class="head">
<h1>Theory Noar_Pinkas_OT</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπNoar Pinkas OT‚Ä∫</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‚ÄπHere we prove security for the Noar Pinkas OT from \cite{DBLP:conf/soda/NaorP01}.‚Ä∫</span></span>

<span class="keyword1"><span class="command">theory</span></span> Noar_Pinkas_OT <span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Cyclic_Group_Ext.html">Cyclic_Group_Ext</a> 
  <a href="../Game_Based_Crypto/Diffie_Hellman.html">Game_Based_Crypto.Diffie_Hellman</a>
  <a href="OT_Functionalities.html">OT_Functionalities</a> 
  <a href="Semi_Honest_Def.html">Semi_Honest_Def</a>
  <a href="Uniform_Sampling.html">Uniform_Sampling</a> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">locale</span></span> np_base <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ùí¢</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'grp</span> cyclic_group"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">structure</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite_group<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>carrier <span class="free">ùí¢</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> or_gt_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> order <span class="free">ùí¢</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> prime_order<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prime_field<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="free">a</span> <span class="main">‚â†</span> <span class="main">0</span> <span class="main">‚üπ</span> coprime <span class="free">a</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> dvd_imp_le neq0_conv not_le prime_imp_coprime prime_order coprime_commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> weight_sample_uniform_units<span class="main">:</span> <span class="quoted"><span class="quoted">"weight_spmf <span class="main">(</span>sample_uniform_units <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>  lossless_spmf_def lossless_sample_uniform_units prime_order  prime_gt_1_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">protocol</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span><span class="main">)</span> <span class="main">‚áí</span> bool <span class="main">‚áí</span> <span class="main">(</span>unit <span class="main">√ó</span> <span class="tfree">'grp</span><span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">protocol</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">;</span>
    <span class="bound">a</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">b</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">c<span class="hidden">‚á©</span><sub>v</sub></span> <span class="main">=</span> <span class="main">(</span><span class="bound">a</span><span class="main">*</span><span class="bound">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">c<span class="hidden">‚á©</span><sub>v</sub>'</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">r0</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform_units <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">s0</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform_units <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w0</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">a</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">s0</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">r0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z0'</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">then</span> <span class="bound">c<span class="hidden">‚á©</span><sub>v</sub>'</span> <span class="keyword1">else</span> <span class="bound">c<span class="hidden">‚á©</span><sub>v</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">s0</span><span class="main">)</span> <span class="main">‚äó</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">b</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">r0</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">r1</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform_units <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">s1</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform_units <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w1</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">a</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">s1</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">r1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z1'</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">then</span> <span class="bound">c<span class="hidden">‚á©</span><sub>v</sub></span> <span class="keyword1">else</span> <span class="bound">c<span class="hidden">‚á©</span><sub>v</sub>'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">s1</span><span class="main">)</span> <span class="main">‚äó</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">b</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">r1</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">enc_m0</span> <span class="main">=</span> <span class="bound">z0'</span> <span class="main">‚äó</span> <span class="bound">m0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">enc_m1</span> <span class="main">=</span> <span class="bound">z1'</span> <span class="main">‚äó</span> <span class="bound">m1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">out_2</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">then</span> <span class="bound">enc_m1</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="main">(</span><span class="bound">w1</span> <span class="main">[^]</span> <span class="bound">b</span><span class="main">)</span> <span class="keyword1">else</span> <span class="bound">enc_m0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="main">(</span><span class="bound">w0</span> <span class="main">[^]</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="bound">out_2</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lossless_protocol<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span>protocol <span class="free">M</span> <span class="free">œÉ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> protocol_def Let_def split_def lossless_sample_uniform_units or_gt_0<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> prime_order prime_gt_1_nat lossless_sample_uniform_units <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'grp'</span> view1 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'grp'</span> <span class="main">√ó</span> <span class="tfree">'grp'</span><span class="main">)</span> <span class="main">√ó</span> <span class="main">(</span><span class="tfree">'grp'</span> <span class="main">√ó</span> <span class="tfree">'grp'</span> <span class="main">√ó</span> <span class="tfree">'grp'</span> <span class="main">√ó</span> <span class="tfree">'grp'</span><span class="main">)</span><span class="main">)</span> spmf"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'grp'</span> dist_adversary <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'grp'</span> <span class="main">√ó</span> <span class="tfree">'grp'</span><span class="main">)</span> <span class="main">√ó</span> <span class="tfree">'grp'</span> <span class="main">√ó</span> <span class="tfree">'grp'</span> <span class="main">√ó</span> <span class="tfree">'grp'</span> <span class="main">√ó</span> <span class="tfree">'grp'</span><span class="main">)</span> <span class="main">‚áí</span> bool spmf"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">R1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span><span class="main">)</span> <span class="main">‚áí</span> bool <span class="main">‚áí</span> <span class="tfree">'grp</span> view1"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">R1</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">;</span>
    <span class="bound">a</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">b</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">c<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="main">=</span> <span class="bound">a</span><span class="main">*</span><span class="bound">b</span><span class="main">;</span>
    <span class="bound">c<span class="hidden">‚á©</span><sub>œÉ</sub>'</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">,</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">a</span><span class="main">,</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">b</span><span class="main">,</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="keyword1">then</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">c<span class="hidden">‚á©</span><sub>œÉ</sub>'</span> <span class="keyword1">else</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">c<span class="hidden">‚á©</span><sub>œÉ</sub></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="keyword1">then</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">c<span class="hidden">‚á©</span><sub>œÉ</sub></span> <span class="keyword1">else</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">c<span class="hidden">‚á©</span><sub>œÉ</sub>'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>  

<span class="keyword1"><span class="command">lemma</span></span> lossless_R1<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span>R1 <span class="free">M</span> <span class="free">œÉ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R1_def Let_def lossless_sample_uniform_units or_gt_0<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span><span class="main">)</span> <span class="main">‚áí</span> <span class="tfree">'grp</span> view1"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">inter</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">a</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">b</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>  
    <span class="bound">c</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">d</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">,</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">a</span><span class="main">,</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">b</span><span class="main">,</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">c</span><span class="main">,</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">d</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">S1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span><span class="main">)</span> <span class="main">‚áí</span> unit <span class="main">‚áí</span> <span class="tfree">'grp</span> view1"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">S1</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">out1</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">;</span>
    <span class="bound">a</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">b</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">c</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">,</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">a</span><span class="main">,</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">b</span><span class="main">,</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">c</span><span class="main">,</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="bound">a</span><span class="main">*</span><span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>  

<span class="keyword1"><span class="command">lemma</span></span> lossless_S1<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span>S1 <span class="free">M</span> <span class="free">out1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S1_def Let_def lossless_sample_uniform_units or_gt_0<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">R1_inter_adversary</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'grp</span> dist_adversary <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span><span class="main">)</span> <span class="main">‚áí</span> <span class="tfree">'grp</span> <span class="main">‚áí</span> <span class="tfree">'grp</span> <span class="main">‚áí</span> <span class="tfree">'grp</span> <span class="main">‚áí</span> bool spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">R1_inter_adversary</span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">Œ±</span></span></span> <span class="free"><span class="bound"><span class="entity">Œ≤</span></span></span> <span class="free"><span class="bound"><span class="entity">Œ≥</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">c</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Œ±</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Œ≤</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Œ≥</span></span></span><span class="main">,</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">c</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">inter_S1_adversary</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'grp</span> dist_adversary <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span><span class="main">)</span> <span class="main">‚áí</span> <span class="tfree">'grp</span> <span class="main">‚áí</span> <span class="tfree">'grp</span> <span class="main">‚áí</span> <span class="tfree">'grp</span> <span class="main">‚áí</span> bool spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">inter_S1_adversary</span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">Œ±</span></span></span> <span class="free"><span class="bound"><span class="entity">Œ≤</span></span></span> <span class="free"><span class="bound"><span class="entity">Œ≥</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">c</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Œ±</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Œ≤</span></span></span><span class="main">,</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">c</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Œ≥</span></span></span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> ddh<span class="main">:</span> ddh <span class="quoted"><span class="free">ùí¢</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">R2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span><span class="main">)</span> <span class="main">‚áí</span> bool <span class="main">‚áí</span> <span class="main">(</span>bool <span class="main">√ó</span> <span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span> <span class="main">√ó</span>  <span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span><span class="main">)</span> spmf"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">R2</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>  <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="keyword1">let</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">;</span>
  <span class="bound">a</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
  <span class="bound">b</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">c<span class="hidden">‚á©</span><sub>v</sub></span> <span class="main">=</span> <span class="main">(</span><span class="bound">a</span><span class="main">*</span><span class="bound">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
  <span class="bound">c<span class="hidden">‚á©</span><sub>v</sub>'</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
  <span class="bound">r0</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform_units <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
  <span class="bound">s0</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform_units <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">w0</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">a</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">s0</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">r0</span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">z</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">c<span class="hidden">‚á©</span><sub>v</sub>'</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">s0</span><span class="main">)</span> <span class="main">‚äó</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">b</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">r0</span><span class="main">)</span><span class="main">;</span>
  <span class="bound">r1</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform_units <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
  <span class="bound">s1</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform_units <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">w1</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">a</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">s1</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">r1</span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">z'</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="bound">c<span class="hidden">‚á©</span><sub>v</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">s1</span><span class="main">)</span> <span class="main">‚äó</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">b</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">r1</span><span class="main">)</span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">enc_m</span> <span class="main">=</span> <span class="bound">z</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">then</span> <span class="bound">m0</span> <span class="keyword1">else</span> <span class="bound">m1</span><span class="main">)</span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">enc_m'</span> <span class="main">=</span> <span class="bound">z'</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">then</span> <span class="bound">m1</span> <span class="keyword1">else</span> <span class="bound">m0</span><span class="main">)</span> <span class="main">;</span>
  return_spmf<span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">a</span><span class="main">,</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">b</span><span class="main">,</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">c<span class="hidden">‚á©</span><sub>v</sub></span><span class="main">,</span> <span class="bound">w0</span><span class="main">,</span> <span class="bound">enc_m</span><span class="main">,</span> <span class="bound">w1</span><span class="main">,</span> <span class="bound">enc_m'</span><span class="main">)</span><span class="main">}</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> lossless_R2<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span>R2 <span class="free">M</span> <span class="free">œÉ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R2_def Let_def split_def lossless_sample_uniform_units or_gt_0<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> prime_order prime_gt_1_nat lossless_sample_uniform_units <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">S2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">‚áí</span> <span class="tfree">'grp</span> <span class="main">‚áí</span> <span class="main">(</span>bool <span class="main">√ó</span> <span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span><span class="main">)</span> spmf"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">S2</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span>  <span class="keyword1">do</span> <span class="main">{</span>
  <span class="bound">a</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
  <span class="bound">b</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">c<span class="hidden">‚á©</span><sub>v</sub></span> <span class="main">=</span> <span class="main">(</span><span class="bound">a</span><span class="main">*</span><span class="bound">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
  <span class="bound">r0</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform_units <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
  <span class="bound">s0</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform_units <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">w0</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">a</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">s0</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">r0</span><span class="main">;</span>
  <span class="bound">r1</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform_units <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
  <span class="bound">s1</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform_units <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">w1</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">a</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">s1</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">r1</span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">z'</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="bound">c<span class="hidden">‚á©</span><sub>v</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">s1</span><span class="main">)</span> <span class="main">‚äó</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">b</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">r1</span><span class="main">)</span><span class="main">;</span>
  <span class="bound">s'</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">enc_m</span> <span class="main">=</span>  <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">s'</span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">enc_m'</span> <span class="main">=</span> <span class="bound">z'</span> <span class="main">‚äó</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">;</span>
  return_spmf<span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">a</span><span class="main">,</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">b</span><span class="main">,</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">c<span class="hidden">‚á©</span><sub>v</sub></span><span class="main">,</span> <span class="bound">w0</span><span class="main">,</span> <span class="bound">enc_m</span><span class="main">,</span> <span class="bound">w1</span><span class="main">,</span> <span class="bound">enc_m'</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lossless_S2<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span>S2 <span class="free">œÉ</span> <span class="free">out2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S2_def Let_def lossless_sample_uniform_units or_gt_0<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> prime_order prime_gt_1_nat lossless_sample_uniform_units <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">sublocale</span></span> sim_def<span class="main">:</span> sim_det_def <span class="quoted">R1</span> <span class="quoted">S1</span> <span class="quoted">R2</span> <span class="quoted">S2</span> <span class="quoted">funct_OT_12</span> <span class="quoted">protocol</span>
  <span class="keyword1"><span class="command">unfolding</span></span> sim_det_def_def 
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lossless_R1 lossless_S1 lossless_R2 lossless_S2 lossless_protocol lossless_funct_OT_12<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> np <span class="main">=</span> np_base <span class="main">+</span> cyclic_group <span class="quoted"><span class="free">ùí¢</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> protocol_inverse<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m0</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span><span class="quoted"><span class="quoted">" <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="free">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="main">(</span><span class="free">s1</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">b</span><span class="main">)</span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r1</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">v</span> <span class="keyword1">then</span> <span class="free">m0</span> <span class="keyword1">else</span> <span class="free">m1</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">a</span><span class="main">)</span> <span class="main">[^]</span> <span class="free">s1</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">r1</span><span class="main">)</span> <span class="main">[^]</span> <span class="free">b</span><span class="main">)</span> 
        <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">v</span> <span class="keyword1">then</span> <span class="free">m0</span> <span class="keyword1">else</span> <span class="free">m1</span><span class="main">)</span>"</span></span>
<span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span>  1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="free">b</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="free">s1</span><span class="main">)</span> <span class="main">+</span> <span class="free">b</span><span class="main">*</span><span class="free">r1</span> <span class="main">=</span><span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">::</span>nat<span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="free">s1</span><span class="main">)</span> <span class="main">+</span> <span class="free">r1</span><span class="main">)</span><span class="main">*</span><span class="free">b</span> "</span></span> <span class="keyword1"><span class="command">using</span></span> mult.commute mult.assoc  add_mult_distrib <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> 
 <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="free">s1</span><span class="main">)</span> <span class="main">‚äó</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">b</span><span class="main">)</span> <span class="main">[^]</span> <span class="free">r1</span><span class="main">)</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">v</span> <span class="keyword1">then</span> <span class="free">m0</span> <span class="keyword1">else</span> <span class="free">m1</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">a</span><span class="main">)</span> <span class="main">[^]</span> <span class="free">s1</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">r1</span><span class="main">)</span> <span class="main">[^]</span> <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pow_generator_mod<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="free">b</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="free">s1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">b</span><span class="main">*</span><span class="free">r1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> <span class="free">v</span> <span class="keyword1">then</span> <span class="free">m0</span> <span class="keyword1">else</span> <span class="free">m1</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="main">(</span><span class="free">s1</span><span class="main">)</span> <span class="main">+</span> <span class="free">r1</span><span class="main">)</span><span class="main">*</span><span class="free">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nat_pow_pow nat_pow_mult assms cyclic_group_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="free">b</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="free">s1</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">b</span><span class="main">*</span><span class="free">r1</span><span class="main">)</span> <span class="main">‚äó</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">inv</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="main">(</span><span class="free">s1</span><span class="main">)</span> <span class="main">+</span> <span class="free">r1</span><span class="main">)</span><span class="main">*</span><span class="free">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">v</span> <span class="keyword1">then</span> <span class="free">m0</span> <span class="keyword1">else</span> <span class="free">m1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nat_pow_mult cyclic_group_commute assms<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="free">b</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="free">s1</span><span class="main">)</span> <span class="main">+</span> <span class="free">b</span><span class="main">*</span><span class="free">r1</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="main">(</span><span class="free">s1</span><span class="main">)</span> <span class="main">+</span> <span class="free">r1</span><span class="main">)</span><span class="main">*</span><span class="free">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">v</span> <span class="keyword1">then</span> <span class="free">m0</span> <span class="keyword1">else</span> <span class="free">m1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nat_pow_mult cyclic_group_assoc assms<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="free">b</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="free">s1</span><span class="main">)</span> <span class="main">+</span> <span class="free">b</span><span class="main">*</span><span class="free">r1</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="free">b</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="free">s1</span><span class="main">)</span> <span class="main">+</span> <span class="free">r1</span><span class="main">*</span><span class="free">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">v</span> <span class="keyword1">then</span> <span class="free">m0</span> <span class="keyword1">else</span> <span class="free">m1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> l_cancel_inv assms  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> correctness<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m0</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sim_def.correctness <span class="main">(</span><span class="free">m0</span><span class="main">,</span><span class="free">m1</span><span class="main">)</span> <span class="free">œÉ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"protocol <span class="main">(</span><span class="free">m0</span><span class="main">,</span> <span class="free">m1</span><span class="main">)</span> <span class="free">œÉ</span> <span class="main">=</span> funct_OT_12 <span class="main">(</span><span class="free">m0</span><span class="main">,</span> <span class="free">m1</span><span class="main">)</span> <span class="free">œÉ</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"protocol <span class="main">(</span><span class="free">m0</span><span class="main">,</span> <span class="free">m1</span><span class="main">)</span> <span class="free">œÉ</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">a</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">b</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">r1</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform_units <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">s1</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform_units <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">out_2</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="main">(</span><span class="bound">a</span><span class="main">*</span><span class="bound">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">s1</span><span class="main">)</span> <span class="main">‚äó</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">b</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">r1</span><span class="main">)</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="free">m1</span> <span class="keyword1">else</span> <span class="free">m0</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">a</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">s1</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">r1</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">b</span><span class="main">)</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="bound">out_2</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> protocol_def lossless_sample_uniform_units bind_spmf_const weight_sample_uniform_units or_gt_0<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>   
    <span class="keyword1">let</span> <span class="bound">out_2</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="free">m1</span> <span class="keyword1">else</span> <span class="free">m0</span><span class="main">)</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="bound">out_2</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> protocol_inverse assms lossless_sample_uniform_units bind_spmf_const weight_sample_uniform_units or_gt_0<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def funct_OT_12_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sim_def.correctness_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> security_P1<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sim_def.adv_P1 <span class="free">msgs</span> <span class="free">œÉ</span> <span class="free">D</span> <span class="main">‚â§</span> ddh.advantage <span class="main">(</span>R1_inter_adversary <span class="free">D</span> <span class="free">msgs</span><span class="main">)</span> <span class="main">+</span> ddh.advantage <span class="main">(</span>inter_S1_adversary <span class="free">D</span> <span class="free">msgs</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">‚â§</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">œÉ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"R1 <span class="free">msgs</span> <span class="free">œÉ</span> <span class="main">=</span> S1 <span class="free">msgs</span> <span class="skolem">out1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">out1</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R1_def S1_def True<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sim_def.adv_P1 <span class="free">msgs</span> <span class="free">œÉ</span> <span class="free">D</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sim_def.adv_P1_def funct_OT_12_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ddh.advantage <span class="skolem">A</span> <span class="main">‚â•</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span> <span class="keyword1"><span class="command">using</span></span> ddh.advantage_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">have</span></span> bounded_advantage<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬¶</span><span class="main">(</span><span class="skolem">a</span> <span class="main">::</span> real<span class="main">)</span> <span class="main">-</span> <span class="skolem">b</span><span class="main">¬¶</span> <span class="main">=</span> <span class="skolem">e1</span> <span class="main">‚üπ</span> <span class="main">¬¶</span><span class="skolem">b</span> <span class="main">-</span> <span class="skolem">c</span><span class="main">¬¶</span> <span class="main">=</span> <span class="skolem">e2</span> <span class="main">‚üπ</span> <span class="main">¬¶</span><span class="skolem">a</span> <span class="main">-</span> <span class="skolem">c</span><span class="main">¬¶</span> <span class="main">‚â§</span> <span class="skolem">e1</span> <span class="main">+</span> <span class="skolem">e2</span>"</span></span> 
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">e1</span> <span class="skolem">c</span> <span class="skolem">e2</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> R1_inter_dist<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬¶</span>spmf <span class="main">(</span>R1 <span class="free">msgs</span> False <span class="main">‚§ú</span> <span class="free">D</span><span class="main">)</span> True <span class="main">-</span> spmf <span class="main">(</span><span class="main">(</span>inter <span class="free">msgs</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="free">D</span><span class="main">)</span> True<span class="main">¬¶</span> <span class="main">=</span> ddh.advantage <span class="main">(</span>R1_inter_adversary <span class="free">D</span> <span class="free">msgs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> R1_def inter_def ddh.advantage_def ddh.ddh_0_def ddh.ddh_1_def Let_def split_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>  <span class="keyword1"><span class="command">have</span></span> inter_S1_dist<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬¶</span>spmf <span class="main">(</span><span class="main">(</span>inter <span class="free">msgs</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="free">D</span><span class="main">)</span> True <span class="main">-</span> spmf <span class="main">(</span>S1 <span class="free">msgs</span> <span class="skolem">out1</span> <span class="main">‚§ú</span> <span class="free">D</span><span class="main">)</span> True<span class="main">¬¶</span> <span class="main">=</span> ddh.advantage <span class="main">(</span>inter_S1_adversary <span class="free">D</span> <span class="free">msgs</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">out1</span> <span class="keyword1"><span class="command">including</span></span> monad_normalisation
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S1_def inter_def ddh.advantage_def ddh.ddh_0_def ddh.ddh_1_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬¶</span>spmf <span class="main">(</span>R1 <span class="free">msgs</span> False <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">view</span><span class="main">.</span> <span class="free">D</span> <span class="bound">view</span><span class="main">)</span><span class="main">)</span> True <span class="main">-</span> spmf <span class="main">(</span>S1 <span class="free">msgs</span> <span class="skolem">out1</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">view</span><span class="main">.</span> <span class="free">D</span> <span class="bound">view</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span> <span class="main">‚â§</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">out1</span> <span class="keyword1"><span class="command">using</span></span> R1_inter_dist <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sim_def.adv_P1_def funct_OT_12_def False<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> add_mult_one_time_pad<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s0</span> <span class="main">&lt;</span> order <span class="free">ùí¢</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s0</span> <span class="main">‚â†</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map_spmf <span class="main">(</span><span class="main">Œª</span> <span class="bound">c<span class="hidden">‚á©</span><sub>v</sub>'</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">b</span><span class="main">*</span> <span class="free">r0</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">s0</span> <span class="main">*</span> <span class="bound">c<span class="hidden">‚á©</span><sub>v</sub>'</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span><span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gcd <span class="free">s0</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms prime_field <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> add_mult_one_time_pad <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> security_P2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m0</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sim_def.perfect_sec_P2 <span class="main">(</span><span class="free">m0</span><span class="main">,</span><span class="free">m1</span><span class="main">)</span> <span class="free">œÉ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"R2 <span class="main">(</span><span class="free">m0</span><span class="main">,</span> <span class="free">m1</span><span class="main">)</span> <span class="free">œÉ</span> <span class="main">=</span> S2 <span class="free">œÉ</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="free">m1</span> <span class="keyword1">else</span> <span class="free">m0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">including</span></span> monad_normalisation
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"R2 <span class="main">(</span><span class="free">m0</span><span class="main">,</span> <span class="free">m1</span><span class="main">)</span> <span class="free">œÉ</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">a</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">b</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">c<span class="hidden">‚á©</span><sub>v</sub></span> <span class="main">=</span> <span class="main">(</span><span class="bound">a</span><span class="main">*</span><span class="bound">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">c<span class="hidden">‚á©</span><sub>v</sub>'</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">r0</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform_units <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">s0</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform_units <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">w0</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">a</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">s0</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">r0</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">s'</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">b</span><span class="main">*</span> <span class="bound">r0</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">(</span><span class="bound">c<span class="hidden">‚á©</span><sub>v</sub>'</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="bound">s0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span><span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">z</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">s'</span> <span class="main">;</span>
      <span class="bound">r1</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform_units <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">s1</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform_units <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">w1</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">a</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">s1</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">r1</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">z'</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="bound">c<span class="hidden">‚á©</span><sub>v</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">s1</span><span class="main">)</span> <span class="main">‚äó</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">b</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">r1</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">enc_m</span> <span class="main">=</span> <span class="bound">z</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="free">m0</span> <span class="keyword1">else</span> <span class="free">m1</span><span class="main">)</span><span class="main">;</span> 
      <span class="keyword1">let</span> <span class="bound">enc_m'</span> <span class="main">=</span> <span class="bound">z'</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="free">m1</span> <span class="keyword1">else</span> <span class="free">m0</span><span class="main">)</span> <span class="main">;</span>
      return_spmf<span class="main">(</span><span class="free">œÉ</span><span class="main">,</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">a</span><span class="main">,</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">b</span><span class="main">,</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">c<span class="hidden">‚á©</span><sub>v</sub></span><span class="main">,</span> <span class="bound">w0</span><span class="main">,</span> <span class="bound">enc_m</span><span class="main">,</span> <span class="bound">w1</span><span class="main">,</span> <span class="bound">enc_m'</span><span class="main">)</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R2_def nat_pow_pow nat_pow_mult pow_generator_mod add.commute<span class="main">)</span> 
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">a</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">b</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">c<span class="hidden">‚á©</span><sub>v</sub></span> <span class="main">=</span> <span class="main">(</span><span class="bound">a</span><span class="main">*</span><span class="bound">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">r0</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform_units <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">s0</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform_units <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">w0</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">a</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">s0</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">r0</span><span class="main">;</span>
      <span class="bound">s'</span> <span class="main">‚Üê</span> map_spmf <span class="main">(</span><span class="main">Œª</span> <span class="bound">c<span class="hidden">‚á©</span><sub>v</sub>'</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">b</span><span class="main">*</span> <span class="bound">r0</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">(</span><span class="bound">c<span class="hidden">‚á©</span><sub>v</sub>'</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="bound">s0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span><span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">z</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">s'</span><span class="main">;</span>
      <span class="bound">r1</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform_units <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">s1</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform_units <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">w1</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">a</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">s1</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">r1</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">z'</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="bound">c<span class="hidden">‚á©</span><sub>v</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">s1</span><span class="main">)</span> <span class="main">‚äó</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">b</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">r1</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">enc_m</span> <span class="main">=</span> <span class="bound">z</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="free">m0</span> <span class="keyword1">else</span> <span class="free">m1</span><span class="main">)</span><span class="main">;</span> 
      <span class="keyword1">let</span> <span class="bound">enc_m'</span> <span class="main">=</span> <span class="bound">z'</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="free">m1</span> <span class="keyword1">else</span> <span class="free">m0</span><span class="main">)</span> <span class="main">;</span>
      return_spmf<span class="main">(</span><span class="free">œÉ</span><span class="main">,</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">a</span><span class="main">,</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">b</span><span class="main">,</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">c<span class="hidden">‚á©</span><sub>v</sub></span><span class="main">,</span> <span class="bound">w0</span><span class="main">,</span> <span class="bound">enc_m</span><span class="main">,</span> <span class="bound">w1</span><span class="main">,</span> <span class="bound">enc_m'</span><span class="main">)</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_map_spmf o_def Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">a</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">b</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">c<span class="hidden">‚á©</span><sub>v</sub></span> <span class="main">=</span> <span class="main">(</span><span class="bound">a</span><span class="main">*</span><span class="bound">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">r0</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform_units <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">s0</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform_units <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">w0</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">a</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">s0</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">r0</span><span class="main">;</span>
      <span class="bound">s'</span> <span class="main">‚Üê</span>  <span class="main">(</span>sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">z</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">s'</span><span class="main">;</span>
      <span class="bound">r1</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform_units <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">s1</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform_units <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">w1</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">a</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">s1</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">r1</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">z'</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="bound">c<span class="hidden">‚á©</span><sub>v</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">s1</span><span class="main">)</span> <span class="main">‚äó</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">b</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">r1</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">enc_m</span> <span class="main">=</span> <span class="bound">z</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="free">m0</span> <span class="keyword1">else</span> <span class="free">m1</span><span class="main">)</span><span class="main">;</span> 
      <span class="keyword1">let</span> <span class="bound">enc_m'</span> <span class="main">=</span> <span class="bound">z'</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="free">m1</span> <span class="keyword1">else</span> <span class="free">m0</span><span class="main">)</span> <span class="main">;</span>
      return_spmf<span class="main">(</span><span class="free">œÉ</span><span class="main">,</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">a</span><span class="main">,</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">b</span><span class="main">,</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">c<span class="hidden">‚á©</span><sub>v</sub></span><span class="main">,</span> <span class="bound">w0</span><span class="main">,</span> <span class="bound">enc_m</span><span class="main">,</span> <span class="bound">w1</span><span class="main">,</span> <span class="bound">enc_m'</span><span class="main">)</span><span class="main">}</span>"</span></span>  
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_mult_one_time_pad Let_def mult.commute <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> bind_spmf_cong_simp<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">a</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">b</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">c<span class="hidden">‚á©</span><sub>v</sub></span> <span class="main">=</span> <span class="main">(</span><span class="bound">a</span><span class="main">*</span><span class="bound">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">r0</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform_units <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">s0</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform_units <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">w0</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">a</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">s0</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">r0</span><span class="main">;</span>
      <span class="bound">r1</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform_units <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">s1</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform_units <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">w1</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">a</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">s1</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">r1</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">z'</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="bound">c<span class="hidden">‚á©</span><sub>v</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">s1</span><span class="main">)</span> <span class="main">‚äó</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">b</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">r1</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">enc_m</span> <span class="main">‚Üê</span> map_spmf <span class="main">(</span><span class="main">Œª</span> <span class="bound">s'</span><span class="main">.</span>  <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">s'</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="free">m0</span> <span class="keyword1">else</span> <span class="free">m1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> 
      <span class="keyword1">let</span> <span class="bound">enc_m'</span> <span class="main">=</span> <span class="bound">z'</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="free">m1</span> <span class="keyword1">else</span> <span class="free">m0</span><span class="main">)</span> <span class="main">;</span>
      return_spmf<span class="main">(</span><span class="free">œÉ</span><span class="main">,</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">a</span><span class="main">,</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">b</span><span class="main">,</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">c<span class="hidden">‚á©</span><sub>v</sub></span><span class="main">,</span> <span class="bound">w0</span><span class="main">,</span> <span class="bound">enc_m</span><span class="main">,</span> <span class="bound">w1</span><span class="main">,</span> <span class="bound">enc_m'</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_map_spmf o_def Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">a</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">b</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">c<span class="hidden">‚á©</span><sub>v</sub></span> <span class="main">=</span> <span class="main">(</span><span class="bound">a</span><span class="main">*</span><span class="bound">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">r0</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform_units <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">s0</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform_units <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">w0</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">a</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">s0</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">r0</span><span class="main">;</span>
      <span class="bound">r1</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform_units <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">s1</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform_units <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">w1</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">a</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">s1</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">r1</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">z'</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="bound">c<span class="hidden">‚á©</span><sub>v</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">s1</span><span class="main">)</span> <span class="main">‚äó</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">b</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">r1</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">enc_m</span> <span class="main">‚Üê</span> map_spmf <span class="main">(</span><span class="main">Œª</span> <span class="bound">s'</span><span class="main">.</span>  <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">(</span>sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> 
      <span class="keyword1">let</span> <span class="bound">enc_m'</span> <span class="main">=</span> <span class="bound">z'</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">œÉ</span> <span class="keyword1">then</span> <span class="free">m1</span> <span class="keyword1">else</span> <span class="free">m0</span><span class="main">)</span> <span class="main">;</span>
      return_spmf<span class="main">(</span><span class="free">œÉ</span><span class="main">,</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">a</span><span class="main">,</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">b</span><span class="main">,</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">c<span class="hidden">‚á©</span><sub>v</sub></span><span class="main">,</span> <span class="bound">w0</span><span class="main">,</span> <span class="bound">enc_m</span><span class="main">,</span> <span class="bound">w1</span><span class="main">,</span> <span class="bound">enc_m'</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sample_uniform_one_time_pad assms<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S2_def Let_def bind_map_spmf o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sim_def.perfect_sec_P2_def funct_OT_12_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> 

<span class="keyword1"><span class="command">locale</span></span> np_asymp <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ùí¢</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">‚áí</span> <span class="tfree">'grp</span> cyclic_group"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> np<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">‚ãÄ</span><span class="bound">Œ∑</span><span class="main">.</span> np <span class="main">(</span><span class="free">ùí¢</span> <span class="bound">Œ∑</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">sublocale</span></span> np <span class="quoted"><span class="quoted">"<span class="free">ùí¢</span> <span class="free">Œ∑</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">Œ∑</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> np<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> correctness_asymp<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m0</span> <span class="main">‚àà</span> carrier <span class="main">(</span><span class="free">ùí¢</span> <span class="free">Œ∑</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="main">‚àà</span> carrier <span class="main">(</span><span class="free">ùí¢</span> <span class="free">Œ∑</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sim_def.correctness <span class="free">Œ∑</span> <span class="main">(</span><span class="free">m0</span><span class="main">,</span> <span class="free">m1</span><span class="main">)</span> <span class="free">œÉ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> correctness assms<span class="main">)</span> 

<span class="keyword1"><span class="command">theorem</span></span> security_P1_asymp<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">Œª</span> <span class="bound">Œ∑</span><span class="main">.</span> ddh.advantage <span class="bound">Œ∑</span> <span class="main">(</span>inter_S1_adversary <span class="bound">Œ∑</span> <span class="free">D</span> <span class="free">msgs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">Œª</span> <span class="bound">Œ∑</span><span class="main">.</span> ddh.advantage <span class="bound">Œ∑</span> <span class="main">(</span>R1_inter_adversary <span class="bound">Œ∑</span>  <span class="free">D</span> <span class="free">msgs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">Œª</span> <span class="bound">Œ∑</span><span class="main">.</span> sim_def.adv_P1 <span class="bound">Œ∑</span> <span class="free">msgs</span> <span class="free">œÉ</span> <span class="free">D</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sim_def.adv_P1 <span class="skolem">Œ∑</span> <span class="free">msgs</span> <span class="free">œÉ</span> <span class="free">D</span> <span class="main">‚â§</span> ddh.advantage <span class="skolem">Œ∑</span> <span class="main">(</span>R1_inter_adversary <span class="skolem">Œ∑</span>  <span class="free">D</span> <span class="free">msgs</span><span class="main">)</span> <span class="main">+</span> ddh.advantage <span class="skolem">Œ∑</span> <span class="main">(</span>inter_S1_adversary <span class="skolem">Œ∑</span> <span class="free">D</span> <span class="free">msgs</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">Œ∑</span>
    <span class="keyword1"><span class="command">using</span></span> security_P1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">Œª</span> <span class="bound">Œ∑</span><span class="main">.</span> ddh.advantage <span class="bound">Œ∑</span> <span class="main">(</span>R1_inter_adversary <span class="bound">Œ∑</span>  <span class="free">D</span> <span class="free">msgs</span><span class="main">)</span> <span class="main">+</span> ddh.advantage <span class="bound">Œ∑</span> <span class="main">(</span>inter_S1_adversary <span class="bound">Œ∑</span> <span class="free">D</span> <span class="free">msgs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> negligible_plus<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> negligible_le sim_def.adv_P1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> security_P2_asymp<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m0</span> <span class="main">‚àà</span> carrier <span class="main">(</span><span class="free">ùí¢</span> <span class="free">Œ∑</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="main">‚àà</span> carrier <span class="main">(</span><span class="free">ùí¢</span> <span class="free">Œ∑</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sim_def.perfect_sec_P2 <span class="free">Œ∑</span> <span class="main">(</span><span class="free">m0</span><span class="main">,</span><span class="free">m1</span><span class="main">)</span> <span class="free">œÉ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> security_P2 assms<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="OT14">
<div class="head">
<h1>Theory OT14</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚Äπ1-out-of-2 OT to 1-out-of-4 OT‚Ä∫</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπHere we construct a protocol that achieves 1-out-of-4 OT from 1-out-of-2 OT. We follow the protocol
for constructing 1-out-of-n OT from 1-out-of-2 OT from \cite{DBLP:books/cu/Goldreich2004}. We assume the security
properties on 1-out-of-2 OT.‚Ä∫</span></span>

<span class="keyword1"><span class="command">theory</span></span> OT14 <span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Semi_Honest_Def.html">Semi_Honest_Def</a>
  <a href="OT_Functionalities.html">OT_Functionalities</a>
  <a href="Uniform_Sampling.html">Uniform_Sampling</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> input1 <span class="main">=</span> <span class="quoted"><span class="quoted">"bool <span class="main">√ó</span> bool <span class="main">√ó</span> bool <span class="main">√ó</span> bool"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> input2 <span class="main">=</span> <span class="quoted"><span class="quoted">"bool <span class="main">√ó</span> bool"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'v_OT121'</span> view1 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>input1 <span class="main">√ó</span> <span class="main">(</span>bool <span class="main">√ó</span> bool <span class="main">√ó</span> bool <span class="main">√ó</span> bool <span class="main">√ó</span> bool <span class="main">√ó</span> bool<span class="main">)</span> <span class="main">√ó</span> <span class="tfree">'v_OT121'</span> <span class="main">√ó</span> <span class="tfree">'v_OT121'</span> <span class="main">√ó</span> <span class="tfree">'v_OT121'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'v_OT122'</span> view2 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>input2 <span class="main">√ó</span> <span class="main">(</span>bool <span class="main">√ó</span> bool <span class="main">√ó</span> bool <span class="main">√ó</span> bool<span class="main">)</span> <span class="main">√ó</span> <span class="tfree">'v_OT122'</span> <span class="main">√ó</span> <span class="tfree">'v_OT122'</span> <span class="main">√ó</span> <span class="tfree">'v_OT122'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> ot14_base <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S1_OT12</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span> <span class="main">‚áí</span> unit <span class="main">‚áí</span> <span class="tfree">'v_OT121</span> spmf"</span></span> <span class="comment1">‚Äï ‚Äπsimulator for party 1 in OT12‚Ä∫</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">R1_OT12</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span> <span class="main">‚áí</span> bool <span class="main">‚áí</span> <span class="tfree">'v_OT121</span> spmf"</span></span> <span class="comment1">‚Äï ‚Äπreal view for party 1 in OT12‚Ä∫</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">adv_OT12</span> <span class="main">::</span> <span class="quoted">real</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">S2_OT12</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">‚áí</span> bool <span class="main">‚áí</span> <span class="tfree">'v_OT122</span> spmf"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">R2_OT12</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span> <span class="main">‚áí</span> bool <span class="main">‚áí</span> <span class="tfree">'v_OT122</span> spmf"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">protocol_OT12</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span> <span class="main">‚áí</span> bool <span class="main">‚áí</span> <span class="main">(</span>unit <span class="main">√ó</span> bool<span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ass_adv_OT12<span class="main">:</span> <span class="quoted"><span class="quoted">"sim_det_def.adv_P1 <span class="free">R1_OT12</span> <span class="free">S1_OT12</span> <span class="free">funct_OT12</span> <span class="main">(</span><span class="free">m0</span><span class="main">,</span><span class="free">m1</span><span class="main">)</span> <span class="free">c</span> <span class="free">D</span> <span class="main">‚â§</span> <span class="free">adv_OT12</span>"</span></span> <span class="comment1">‚Äï ‚Äπbound the advantage of OT12 for party 1‚Ä∫</span> 
    <span class="keyword2"><span class="keyword">and</span></span> inf_th_OT12_P2<span class="main">:</span>  <span class="quoted"><span class="quoted">"sim_det_def.perfect_sec_P2 <span class="free">R2_OT12</span> <span class="free">S2_OT12</span> <span class="free">funct_OT12</span> <span class="main">(</span><span class="free">m0</span><span class="main">,</span><span class="free">m1</span><span class="main">)</span> <span class="free">œÉ</span>"</span></span> <span class="comment1">‚Äï ‚Äπinformation theoretic security for party 2‚Ä∫</span>
    <span class="keyword2"><span class="keyword">and</span></span> correct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">protocol_OT12</span> <span class="free">msgs</span> <span class="free">b</span> <span class="main">=</span> funct_OT_12 <span class="free">msgs</span> <span class="free">b</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> lossless_R1_12<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span><span class="free">R1_OT12</span> <span class="free">m</span> <span class="free">c</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> lossless_S1_12<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span><span class="free">S1_OT12</span> <span class="free">m</span> <span class="free">out1</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> lossless_S2_12<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span><span class="free">S2_OT12</span> <span class="free">c</span> <span class="free">out2</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> lossless_R2_12<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span><span class="free">R2_OT12</span> <span class="free">M</span> <span class="free">c</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> lossless_funct_OT12<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span><span class="free">funct_OT12</span> <span class="main">(</span><span class="free">m0</span><span class="main">,</span><span class="free">m1</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> lossless_protocol_OT12<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span><span class="free">protocol_OT12</span> <span class="free">M</span> <span class="free">C</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> OT_12_sim<span class="main">:</span> sim_det_def <span class="quoted"><span class="free">R1_OT12</span></span> <span class="quoted"><span class="free">S1_OT12</span></span> <span class="quoted"><span class="free">R2_OT12</span></span> <span class="quoted"><span class="free">S2_OT12</span></span> <span class="quoted">funct_OT_12</span> <span class="quoted"><span class="free">protocol_OT12</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sim_det_def_def 
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lossless_R1_12 lossless_S1_12 lossless_funct_OT12 lossless_R2_12 lossless_S2_12<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> OT_12_P1_assms_bound'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬¶</span>spmf <span class="main">(</span>bind_spmf <span class="main">(</span><span class="free">R1_OT12</span> <span class="main">(</span><span class="free">m0</span><span class="main">,</span><span class="free">m1</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">D</span><span class="main">::</span><span class="tfree">'v_OT121</span> <span class="main">‚áí</span> bool spmf<span class="main">)</span> <span class="bound">view</span> <span class="main">)</span><span class="main">)</span><span class="main">)</span> True 
                <span class="main">-</span> spmf <span class="main">(</span>bind_spmf <span class="main">(</span><span class="free">S1_OT12</span> <span class="main">(</span><span class="free">m0</span><span class="main">,</span><span class="free">m1</span><span class="main">)</span> <span class="main">()</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="bound">view</span> <span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span> <span class="main">‚â§</span> <span class="free">adv_OT12</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sim_det_def.adv_P1 <span class="free">R1_OT12</span> <span class="free">S1_OT12</span> funct_OT_12 <span class="main">(</span><span class="free">m0</span><span class="main">,</span><span class="free">m1</span><span class="main">)</span> <span class="free">c</span> <span class="free">D</span> <span class="main">=</span>
                      <span class="main">¬¶</span>spmf <span class="main">(</span>bind_spmf <span class="main">(</span><span class="free">R1_OT12</span> <span class="main">(</span><span class="free">m0</span><span class="main">,</span><span class="free">m1</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="bound">view</span> <span class="main">)</span><span class="main">)</span><span class="main">)</span> True 
                                    <span class="main">-</span> spmf <span class="main">(</span>funct_OT_12 <span class="main">(</span><span class="free">m0</span><span class="main">,</span><span class="free">m1</span><span class="main">)</span> <span class="free">c</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="main">(</span><span class="bound">out1</span><span class="main">::</span>unit<span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">out2</span><span class="main">::</span>bool<span class="main">)</span><span class="main">)</span><span class="main">.</span> 
                                              <span class="free">S1_OT12</span> <span class="main">(</span><span class="free">m0</span><span class="main">,</span><span class="free">m1</span><span class="main">)</span> <span class="bound">out1</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="free">D</span> <span class="bound">view</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sim_det_def.adv_P1_def 
    <span class="keyword1"><span class="command">using</span></span>  OT_12_sim.adv_P1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">¬¶</span>spmf <span class="main">(</span>bind_spmf <span class="main">(</span><span class="free">R1_OT12</span> <span class="main">(</span><span class="free">m0</span><span class="main">,</span><span class="free">m1</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">D</span><span class="main">::</span><span class="tfree">'v_OT121</span> <span class="main">‚áí</span> bool spmf<span class="main">)</span> <span class="bound">view</span> <span class="main">)</span><span class="main">)</span><span class="main">)</span> True 
                <span class="main">-</span> spmf <span class="main">(</span>bind_spmf <span class="main">(</span><span class="free">S1_OT12</span> <span class="main">(</span><span class="free">m0</span><span class="main">,</span><span class="free">m1</span><span class="main">)</span> <span class="main">()</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="bound">view</span> <span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> funct_OT_12_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> ass_adv_OT12<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> OT_12_P2_assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R2_OT12</span> <span class="main">(</span><span class="free">m0</span><span class="main">,</span><span class="free">m1</span><span class="main">)</span> <span class="free">œÉ</span> <span class="main">=</span> funct_OT_12 <span class="main">(</span><span class="free">m0</span><span class="main">,</span><span class="free">m1</span><span class="main">)</span> <span class="free">œÉ</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">out1</span><span class="main">,</span> <span class="bound">out2</span><span class="main">)</span><span class="main">.</span> <span class="free">S2_OT12</span> <span class="free">œÉ</span> <span class="bound">out2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inf_th_OT12_P2 OT_12_sim.perfect_sec_P2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">protocol_14_OT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"input1 <span class="main">‚áí</span> input2 <span class="main">‚áí</span> <span class="main">(</span>unit <span class="main">√ó</span> bool<span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">protocol_14_OT</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">c0</span><span class="main">,</span><span class="bound">c1</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">m00</span><span class="main">,</span> <span class="bound">m01</span><span class="main">,</span> <span class="bound">m10</span><span class="main">,</span> <span class="bound">m11</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">;</span>
    <span class="bound">S0</span> <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S1</span> <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S2</span> <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S3</span> <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S4</span> <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S5</span> <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a0</span> <span class="main">=</span> <span class="bound">S0</span> <span class="main">‚äï</span> <span class="bound">S2</span> <span class="main">‚äï</span> <span class="bound">m00</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a1</span> <span class="main">=</span> <span class="bound">S0</span> <span class="main">‚äï</span> <span class="bound">S3</span> <span class="main">‚äï</span> <span class="bound">m01</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a2</span> <span class="main">=</span> <span class="bound">S1</span> <span class="main">‚äï</span> <span class="bound">S4</span> <span class="main">‚äï</span> <span class="bound">m10</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a3</span> <span class="main">=</span> <span class="bound">S1</span> <span class="main">‚äï</span> <span class="bound">S5</span> <span class="main">‚äï</span> <span class="bound">m11</span><span class="main">;</span>
    <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">Si</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="free">protocol_OT12</span> <span class="main">(</span><span class="bound">S0</span><span class="main">,</span> <span class="bound">S1</span><span class="main">)</span> <span class="bound">c0</span><span class="main">;</span>
    <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">Sj</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="free">protocol_OT12</span> <span class="main">(</span><span class="bound">S2</span><span class="main">,</span> <span class="bound">S3</span><span class="main">)</span> <span class="bound">c1</span><span class="main">;</span>
    <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">Sk</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="free">protocol_OT12</span> <span class="main">(</span><span class="bound">S4</span><span class="main">,</span> <span class="bound">S5</span><span class="main">)</span> <span class="bound">c1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">s2</span> <span class="main">=</span> <span class="bound">Si</span> <span class="main">‚äï</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">c0</span> <span class="keyword1">then</span> <span class="bound">Sk</span> <span class="keyword1">else</span> <span class="bound">Sj</span><span class="main">)</span> <span class="main">‚äï</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">c0</span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">c1</span> <span class="keyword1">then</span> <span class="bound">a3</span> <span class="keyword1">else</span> <span class="bound">a2</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">c1</span> <span class="keyword1">then</span> <span class="bound">a1</span> <span class="keyword1">else</span> <span class="bound">a0</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="bound">s2</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lossless_protocol_14_OT<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span>protocol_14_OT <span class="free">M</span> <span class="free">C</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> protocol_14_OT_def lossless_protocol_OT12 split_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">R1_14</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"input1 <span class="main">‚áí</span> input2 <span class="main">‚áí</span> <span class="tfree">'v_OT121</span> view1 spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">R1_14</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">choice</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">m00</span><span class="main">,</span> <span class="bound">m01</span><span class="main">,</span> <span class="bound">m10</span><span class="main">,</span> <span class="bound">m11</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">c0</span><span class="main">,</span> <span class="bound">c1</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">choice</span></span></span><span class="main">;</span>
    <span class="bound">S0</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S1</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S2</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S3</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S4</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S5</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">a</span> <span class="main">::</span> <span class="tfree">'v_OT121</span> <span class="main">‚Üê</span> <span class="free">R1_OT12</span> <span class="main">(</span><span class="bound">S0</span><span class="main">,</span> <span class="bound">S1</span><span class="main">)</span> <span class="bound">c0</span><span class="main">;</span> 
    <span class="bound">b</span> <span class="main">::</span> <span class="tfree">'v_OT121</span> <span class="main">‚Üê</span> <span class="free">R1_OT12</span> <span class="main">(</span><span class="bound">S2</span><span class="main">,</span> <span class="bound">S3</span><span class="main">)</span> <span class="bound">c1</span><span class="main">;</span>
    <span class="bound">c</span> <span class="main">::</span> <span class="tfree">'v_OT121</span> <span class="main">‚Üê</span> <span class="free">R1_OT12</span> <span class="main">(</span><span class="bound">S4</span><span class="main">,</span> <span class="bound">S5</span><span class="main">)</span> <span class="bound">c1</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">,</span> <span class="main">(</span><span class="bound">S0</span><span class="main">,</span> <span class="bound">S1</span><span class="main">,</span> <span class="bound">S2</span><span class="main">,</span> <span class="bound">S3</span><span class="main">,</span> <span class="bound">S4</span><span class="main">,</span> <span class="bound">S5</span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lossless_R1_14<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span>R1_14 <span class="free">msgs</span> <span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R1_14_def split_def lossless_R1_12<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">R1_14_interm1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"input1 <span class="main">‚áí</span> input2 <span class="main">‚áí</span> <span class="tfree">'v_OT121</span> view1 spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">R1_14_interm1</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">choice</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">m00</span><span class="main">,</span> <span class="bound">m01</span><span class="main">,</span> <span class="bound">m10</span><span class="main">,</span> <span class="bound">m11</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">c0</span><span class="main">,</span> <span class="bound">c1</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">choice</span></span></span><span class="main">;</span>
    <span class="bound">S0</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S1</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S2</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S3</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S4</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S5</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">a</span> <span class="main">::</span> <span class="tfree">'v_OT121</span> <span class="main">‚Üê</span> <span class="free">S1_OT12</span> <span class="main">(</span><span class="bound">S0</span><span class="main">,</span> <span class="bound">S1</span><span class="main">)</span> <span class="main">()</span><span class="main">;</span> 
    <span class="bound">b</span> <span class="main">::</span> <span class="tfree">'v_OT121</span> <span class="main">‚Üê</span> <span class="free">R1_OT12</span> <span class="main">(</span><span class="bound">S2</span><span class="main">,</span> <span class="bound">S3</span><span class="main">)</span> <span class="bound">c1</span><span class="main">;</span>
    <span class="bound">c</span> <span class="main">::</span> <span class="tfree">'v_OT121</span> <span class="main">‚Üê</span> <span class="free">R1_OT12</span> <span class="main">(</span><span class="bound">S4</span><span class="main">,</span> <span class="bound">S5</span><span class="main">)</span> <span class="bound">c1</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">,</span> <span class="main">(</span><span class="bound">S0</span><span class="main">,</span> <span class="bound">S1</span><span class="main">,</span> <span class="bound">S2</span><span class="main">,</span> <span class="bound">S3</span><span class="main">,</span> <span class="bound">S4</span><span class="main">,</span> <span class="bound">S5</span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lossless_R1_14_interm1<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span>R1_14_interm1 <span class="free">msgs</span> <span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R1_14_interm1_def split_def lossless_R1_12 lossless_S1_12<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">R1_14_interm2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"input1 <span class="main">‚áí</span> input2 <span class="main">‚áí</span> <span class="tfree">'v_OT121</span> view1 spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">R1_14_interm2</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">choice</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">m00</span><span class="main">,</span> <span class="bound">m01</span><span class="main">,</span> <span class="bound">m10</span><span class="main">,</span> <span class="bound">m11</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">c0</span><span class="main">,</span> <span class="bound">c1</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">choice</span></span></span><span class="main">;</span>
    <span class="bound">S0</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S1</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S2</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S3</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S4</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S5</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">a</span> <span class="main">::</span> <span class="tfree">'v_OT121</span> <span class="main">‚Üê</span> <span class="free">S1_OT12</span> <span class="main">(</span><span class="bound">S0</span><span class="main">,</span> <span class="bound">S1</span><span class="main">)</span> <span class="main">()</span><span class="main">;</span> 
    <span class="bound">b</span> <span class="main">::</span> <span class="tfree">'v_OT121</span> <span class="main">‚Üê</span> <span class="free">S1_OT12</span> <span class="main">(</span><span class="bound">S2</span><span class="main">,</span> <span class="bound">S3</span><span class="main">)</span> <span class="main">()</span><span class="main">;</span>
    <span class="bound">c</span> <span class="main">::</span> <span class="tfree">'v_OT121</span> <span class="main">‚Üê</span> <span class="free">R1_OT12</span> <span class="main">(</span><span class="bound">S4</span><span class="main">,</span> <span class="bound">S5</span><span class="main">)</span> <span class="bound">c1</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">,</span> <span class="main">(</span><span class="bound">S0</span><span class="main">,</span> <span class="bound">S1</span><span class="main">,</span> <span class="bound">S2</span><span class="main">,</span> <span class="bound">S3</span><span class="main">,</span> <span class="bound">S4</span><span class="main">,</span> <span class="bound">S5</span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lossless_R1_14_interm2<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span>R1_14_interm2 <span class="free">msgs</span> <span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R1_14_interm2_def split_def lossless_R1_12 lossless_S1_12<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">S1_14</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"input1 <span class="main">‚áí</span> unit <span class="main">‚áí</span> <span class="tfree">'v_OT121</span> view1 spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">S1_14</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>   
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">m00</span><span class="main">,</span> <span class="bound">m01</span><span class="main">,</span> <span class="bound">m10</span><span class="main">,</span> <span class="bound">m11</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">;</span>    
    <span class="bound">S0</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S1</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S2</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S3</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S4</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S5</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">a</span> <span class="main">::</span> <span class="tfree">'v_OT121</span> <span class="main">‚Üê</span> <span class="free">S1_OT12</span> <span class="main">(</span><span class="bound">S0</span><span class="main">,</span> <span class="bound">S1</span><span class="main">)</span> <span class="main">()</span><span class="main">;</span> 
    <span class="bound">b</span> <span class="main">::</span> <span class="tfree">'v_OT121</span> <span class="main">‚Üê</span> <span class="free">S1_OT12</span> <span class="main">(</span><span class="bound">S2</span><span class="main">,</span> <span class="bound">S3</span><span class="main">)</span> <span class="main">()</span><span class="main">;</span>
    <span class="bound">c</span> <span class="main">::</span> <span class="tfree">'v_OT121</span> <span class="main">‚Üê</span> <span class="free">S1_OT12</span> <span class="main">(</span><span class="bound">S4</span><span class="main">,</span> <span class="bound">S5</span><span class="main">)</span> <span class="main">()</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">,</span> <span class="main">(</span><span class="bound">S0</span><span class="main">,</span> <span class="bound">S1</span><span class="main">,</span> <span class="bound">S2</span><span class="main">,</span> <span class="bound">S3</span><span class="main">,</span> <span class="bound">S4</span><span class="main">,</span> <span class="bound">S5</span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lossless_S1_14<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span>S1_14 <span class="free">m</span> <span class="free">out</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S1_14_def lossless_S1_12<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> reduction_step1<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">‚àÉ</span> <span class="bound">A1</span><span class="main">.</span> <span class="main">¬¶</span>spmf <span class="main">(</span>bind_spmf <span class="main">(</span>R1_14 <span class="free">M</span> <span class="main">(</span><span class="free">c0</span><span class="main">,</span> <span class="free">c1</span><span class="main">)</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> True <span class="main">-</span> spmf <span class="main">(</span>bind_spmf <span class="main">(</span>R1_14_interm1 <span class="free">M</span> <span class="main">(</span><span class="free">c0</span><span class="main">,</span> <span class="free">c1</span><span class="main">)</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> True<span class="main">¬¶</span> <span class="main">=</span>
              <span class="main">¬¶</span>spmf <span class="main">(</span>bind_spmf <span class="main">(</span>pair_spmf coin_spmf coin_spmf<span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span><span class="main">.</span> bind_spmf <span class="main">(</span><span class="free">R1_OT12</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span> <span class="free">c0</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="bound">A1</span> <span class="bound">view</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True <span class="main">-</span>
                  spmf <span class="main">(</span>bind_spmf <span class="main">(</span>pair_spmf coin_spmf coin_spmf<span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span><span class="main">.</span> bind_spmf <span class="main">(</span><span class="free">S1_OT12</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span> <span class="main">()</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="bound">A1</span> <span class="bound">view</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span>"</span></span>
  <span class="keyword1"><span class="command">including</span></span> monad_normalisation
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A1'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A1'</span> <span class="main">==</span> <span class="main">Œª</span> <span class="main">(</span><span class="bound">view</span> <span class="main">::</span> <span class="tfree">'v_OT121</span><span class="main">)</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">S2</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S3</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S4</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S5</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">b</span> <span class="main">::</span> <span class="tfree">'v_OT121</span> <span class="main">‚Üê</span> <span class="free">R1_OT12</span> <span class="main">(</span><span class="bound">S2</span><span class="main">,</span> <span class="bound">S3</span><span class="main">)</span> <span class="free">c1</span><span class="main">;</span>
    <span class="bound">c</span> <span class="main">::</span> <span class="tfree">'v_OT121</span> <span class="main">‚Üê</span> <span class="free">R1_OT12</span> <span class="main">(</span><span class="bound">S4</span><span class="main">,</span> <span class="bound">S5</span><span class="main">)</span> <span class="free">c1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">R</span> <span class="main">=</span> <span class="main">(</span><span class="free">M</span><span class="main">,</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">,</span> <span class="bound">S2</span><span class="main">,</span> <span class="bound">S3</span><span class="main">,</span> <span class="bound">S4</span><span class="main">,</span> <span class="bound">S5</span><span class="main">)</span><span class="main">,</span> <span class="bound">view</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">;</span>
    <span class="free">D</span> <span class="bound">R</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬¶</span>spmf <span class="main">(</span>bind_spmf <span class="main">(</span>R1_14 <span class="free">M</span> <span class="main">(</span><span class="free">c0</span><span class="main">,</span> <span class="free">c1</span><span class="main">)</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> True <span class="main">-</span> spmf <span class="main">(</span>bind_spmf <span class="main">(</span>R1_14_interm1 <span class="free">M</span> <span class="main">(</span><span class="free">c0</span><span class="main">,</span> <span class="free">c1</span><span class="main">)</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> True<span class="main">¬¶</span> <span class="main">=</span>
       <span class="main">¬¶</span>spmf <span class="main">(</span>bind_spmf <span class="main">(</span>pair_spmf coin_spmf coin_spmf<span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span><span class="main">.</span> bind_spmf <span class="main">(</span><span class="free">R1_OT12</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span> <span class="free">c0</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="skolem">A1'</span> <span class="bound">view</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True <span class="main">-</span>
        spmf <span class="main">(</span>bind_spmf <span class="main">(</span>pair_spmf coin_spmf coin_spmf<span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span><span class="main">.</span> bind_spmf <span class="main">(</span><span class="free">S1_OT12</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span> <span class="main">()</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="skolem">A1'</span> <span class="bound">view</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pair_spmf_alt_def R1_14_def R1_14_interm1_def A1'_def Let_def split_def<span class="main">)</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> bind_commute_spmf<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">S1_OT12</span> <span class="main">_</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> bind_commute_spmf<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">S1_OT12</span> <span class="main">_</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> bind_commute_spmf<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">S1_OT12</span> <span class="main">_</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> bind_commute_spmf<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">S1_OT12</span> <span class="main">_</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> bind_commute_spmf<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">S1_OT12</span> <span class="main">_</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> reduction_step1'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬¶</span>spmf <span class="main">(</span>bind_spmf <span class="main">(</span>pair_spmf coin_spmf coin_spmf<span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span><span class="main">.</span> bind_spmf <span class="main">(</span><span class="free">R1_OT12</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span> <span class="free">c0</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="free">A1</span> <span class="bound">view</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True <span class="main">-</span>
                  spmf <span class="main">(</span>bind_spmf <span class="main">(</span>pair_spmf coin_spmf coin_spmf<span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span><span class="main">.</span> bind_spmf <span class="main">(</span><span class="free">S1_OT12</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span> <span class="main">()</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="free">A1</span> <span class="bound">view</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span> 
                        <span class="main">‚â§</span> <span class="free">adv_OT12</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">‚â§</span> <span class="free">adv_OT12</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> int1<span class="main">:</span> <span class="quoted"><span class="quoted">"integrable <span class="main">(</span>measure_spmf <span class="main">(</span>pair_spmf coin_spmf coin_spmf<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> spmf <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span> <span class="main">‚áí</span> <span class="free">R1_OT12</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span> <span class="free">c0</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">view</span><span class="main">.</span> <span class="free">A1</span> <span class="bound">view</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> int2<span class="main">:</span> <span class="quoted"><span class="quoted">"integrable <span class="main">(</span>measure_spmf <span class="main">(</span>pair_spmf coin_spmf coin_spmf<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> spmf <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span> <span class="main">‚áí</span> <span class="free">S1_OT12</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span> <span class="main">()</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">view</span><span class="main">.</span> <span class="free">A1</span> <span class="bound">view</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> measure_spmf.integrable_const_bound<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pmf_le_1<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> 
            <span class="main">¬¶</span><span class="keyword1">LINT</span> <span class="bound">x</span><span class="main">|</span>measure_spmf <span class="main">(</span>pair_spmf coin_spmf coin_spmf<span class="main">)</span><span class="main">.</span> spmf <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span> <span class="main">‚áí</span> <span class="free">R1_OT12</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span> <span class="free">c0</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">view</span><span class="main">.</span> <span class="free">A1</span> <span class="bound">view</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True 
              <span class="main">-</span> spmf <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span> <span class="main">‚áí</span> <span class="free">S1_OT12</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span> <span class="main">()</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">view</span><span class="main">.</span> <span class="free">A1</span> <span class="bound">view</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> spmf_bind<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> int1 int2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">‚â§</span> <span class="keyword1">LINT</span> <span class="bound">x</span><span class="main">|</span>measure_spmf <span class="main">(</span>pair_spmf coin_spmf coin_spmf<span class="main">)</span><span class="main">.</span> 
               <span class="main">¬¶</span>spmf <span class="main">(</span><span class="free">R1_OT12</span> <span class="bound">x</span> <span class="free">c0</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">view</span><span class="main">.</span> <span class="free">A1</span> <span class="bound">view</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> True <span class="main">-</span> spmf <span class="main">(</span><span class="free">S1_OT12</span> <span class="bound">x</span> <span class="main">()</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">view</span><span class="main">.</span> <span class="free">A1</span> <span class="bound">view</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> integral_abs_bound<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> order_trans<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">‚â§</span> <span class="keyword1">LINT</span> <span class="bound">x</span><span class="main">|</span>measure_spmf <span class="main">(</span>pair_spmf coin_spmf coin_spmf<span class="main">)</span><span class="main">.</span> 
                      <span class="main">¬¶</span>spmf <span class="main">(</span><span class="free">R1_OT12</span> <span class="bound">x</span> <span class="free">c0</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">view</span><span class="main">.</span> <span class="free">A1</span> <span class="bound">view</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> True <span class="main">-</span> spmf <span class="main">(</span><span class="free">S1_OT12</span> <span class="bound">x</span> <span class="main">()</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">view</span><span class="main">.</span> <span class="free">A1</span> <span class="bound">view</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">LINT</span> <span class="bound">x</span><span class="main">|</span>measure_spmf <span class="main">(</span>pair_spmf coin_spmf coin_spmf<span class="main">)</span><span class="main">.</span> 
                <span class="main">¬¶</span>spmf <span class="main">(</span><span class="free">R1_OT12</span> <span class="bound">x</span> <span class="free">c0</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">view</span><span class="main">::</span><span class="tfree">'v_OT121</span><span class="main">.</span> <span class="free">A1</span> <span class="bound">view</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> True 
                    <span class="main">-</span> spmf <span class="main">(</span><span class="free">S1_OT12</span> <span class="bound">x</span> <span class="main">()</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">view</span><span class="main">::</span><span class="tfree">'v_OT121</span><span class="main">.</span> <span class="free">A1</span> <span class="bound">view</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span> <span class="main">‚â§</span> <span class="free">adv_OT12</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> integral_mono<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> order_trans<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> measure_spmf.integrable_const_bound<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="numeral">2</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> abs_triangle_ineq4<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> order_trans<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> m0 m1
      <span class="keyword1"><span class="command">using</span></span> pmf_le_1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">R1_OT12</span> <span class="main">(</span><span class="skolem">m0</span><span class="main">,</span> <span class="skolem">m1</span><span class="main">)</span> <span class="free">c0</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">view</span><span class="main">.</span> <span class="free">A1</span> <span class="bound">view</span> <span class="main">(</span><span class="skolem">m0</span><span class="main">,</span> <span class="skolem">m1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Some True"</span></span><span class="main">]</span>
        pmf_le_1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">S1_OT12</span> <span class="main">(</span><span class="skolem">m0</span><span class="main">,</span> <span class="skolem">m1</span><span class="main">)</span> <span class="main">()</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">view</span><span class="main">.</span> <span class="free">A1</span> <span class="bound">view</span> <span class="main">(</span><span class="skolem">m0</span><span class="main">,</span> <span class="skolem">m1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Some True"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> measure_spmf.integrable_const<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> OT_12_P1_assms_bound'<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> reduction_step2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">‚àÉ</span> <span class="bound">A1</span><span class="main">.</span> <span class="main">¬¶</span>spmf <span class="main">(</span>bind_spmf <span class="main">(</span>R1_14_interm1 <span class="free">M</span> <span class="main">(</span><span class="free">c0</span><span class="main">,</span> <span class="free">c1</span><span class="main">)</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> True <span class="main">-</span> spmf <span class="main">(</span>bind_spmf <span class="main">(</span>R1_14_interm2 <span class="free">M</span> <span class="main">(</span><span class="free">c0</span><span class="main">,</span> <span class="free">c1</span><span class="main">)</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> True<span class="main">¬¶</span> <span class="main">=</span>
          <span class="main">¬¶</span>spmf <span class="main">(</span>bind_spmf <span class="main">(</span>pair_spmf coin_spmf coin_spmf<span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span><span class="main">.</span> bind_spmf <span class="main">(</span><span class="free">R1_OT12</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span> <span class="free">c1</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="bound">A1</span> <span class="bound">view</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True <span class="main">-</span>
            spmf <span class="main">(</span>bind_spmf <span class="main">(</span>pair_spmf coin_spmf coin_spmf<span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span><span class="main">.</span> bind_spmf <span class="main">(</span><span class="free">S1_OT12</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span> <span class="main">()</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="bound">A1</span> <span class="bound">view</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A1'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A1'</span> <span class="main">==</span> <span class="main">Œª</span> <span class="main">(</span><span class="bound">view</span> <span class="main">::</span> <span class="tfree">'v_OT121</span><span class="main">)</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">S2</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S3</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S4</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S5</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">a</span> <span class="main">::</span> <span class="tfree">'v_OT121</span> <span class="main">‚Üê</span> <span class="free">S1_OT12</span> <span class="main">(</span><span class="bound">S2</span><span class="main">,</span><span class="bound">S3</span><span class="main">)</span> <span class="main">()</span><span class="main">;</span>
    <span class="bound">c</span> <span class="main">::</span> <span class="tfree">'v_OT121</span> <span class="main">‚Üê</span> <span class="free">R1_OT12</span> <span class="main">(</span><span class="bound">S4</span><span class="main">,</span> <span class="bound">S5</span><span class="main">)</span> <span class="free">c1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">R</span> <span class="main">=</span> <span class="main">(</span><span class="free">M</span><span class="main">,</span> <span class="main">(</span><span class="bound">S2</span><span class="main">,</span><span class="bound">S3</span><span class="main">,</span> <span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">,</span> <span class="bound">S4</span><span class="main">,</span> <span class="bound">S5</span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">view</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">;</span>
    <span class="free">D</span> <span class="bound">R</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬¶</span>spmf <span class="main">(</span>bind_spmf <span class="main">(</span>R1_14_interm1 <span class="free">M</span> <span class="main">(</span><span class="free">c0</span><span class="main">,</span> <span class="free">c1</span><span class="main">)</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> True <span class="main">-</span> spmf <span class="main">(</span>bind_spmf <span class="main">(</span>R1_14_interm2 <span class="free">M</span> <span class="main">(</span><span class="free">c0</span><span class="main">,</span> <span class="free">c1</span><span class="main">)</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> True<span class="main">¬¶</span> <span class="main">=</span>
       <span class="main">¬¶</span>spmf <span class="main">(</span>bind_spmf <span class="main">(</span>pair_spmf coin_spmf coin_spmf<span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span><span class="main">.</span> bind_spmf <span class="main">(</span><span class="free">R1_OT12</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span> <span class="free">c1</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="skolem">A1'</span> <span class="bound">view</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True <span class="main">-</span>
        spmf <span class="main">(</span>bind_spmf <span class="main">(</span>pair_spmf coin_spmf coin_spmf<span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span><span class="main">.</span> bind_spmf <span class="main">(</span><span class="free">S1_OT12</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span> <span class="main">()</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="skolem">A1'</span> <span class="bound">view</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bind_spmf <span class="main">(</span>R1_14_interm1 <span class="free">M</span> <span class="main">(</span><span class="free">c0</span><span class="main">,</span> <span class="free">c1</span><span class="main">)</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>bind_spmf <span class="main">(</span>pair_spmf coin_spmf coin_spmf<span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span><span class="main">.</span> bind_spmf <span class="main">(</span><span class="free">R1_OT12</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span> <span class="free">c1</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="skolem">A1'</span> <span class="bound">view</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> R1_14_interm1_def R1_14_interm2_def A1'_def Let_def split_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pair_spmf_alt_def<span class="main">)</span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span>  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
      <span class="keyword1"><span class="command">including</span></span> monad_normalisation <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bind_spmf <span class="main">(</span>R1_14_interm2 <span class="free">M</span> <span class="main">(</span><span class="free">c0</span><span class="main">,</span> <span class="free">c1</span><span class="main">)</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="main">=</span>  <span class="main">(</span>bind_spmf <span class="main">(</span>pair_spmf coin_spmf coin_spmf<span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span><span class="main">.</span> bind_spmf <span class="main">(</span><span class="free">S1_OT12</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span> <span class="main">()</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="skolem">A1'</span> <span class="bound">view</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> R1_14_interm1_def R1_14_interm2_def A1'_def Let_def split_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pair_spmf_alt_def<span class="main">)</span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span>  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span>  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span>  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span>  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span>  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span>  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>  
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> reduction_step3<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">‚àÉ</span> <span class="bound">A1</span><span class="main">.</span> <span class="main">¬¶</span>spmf <span class="main">(</span>bind_spmf <span class="main">(</span>R1_14_interm2 <span class="free">M</span> <span class="main">(</span><span class="free">c0</span><span class="main">,</span> <span class="free">c1</span><span class="main">)</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> True <span class="main">-</span> spmf <span class="main">(</span>bind_spmf <span class="main">(</span>S1_14 <span class="free">M</span> <span class="free">out</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> True<span class="main">¬¶</span> <span class="main">=</span>
          <span class="main">¬¶</span>spmf <span class="main">(</span>bind_spmf <span class="main">(</span>pair_spmf coin_spmf coin_spmf<span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span><span class="main">.</span> bind_spmf <span class="main">(</span><span class="free">R1_OT12</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span> <span class="free">c1</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="bound">A1</span> <span class="bound">view</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True <span class="main">-</span>
            spmf <span class="main">(</span>bind_spmf <span class="main">(</span>pair_spmf coin_spmf coin_spmf<span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span><span class="main">.</span> bind_spmf <span class="main">(</span><span class="free">S1_OT12</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span> <span class="main">()</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="bound">A1</span> <span class="bound">view</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A1'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A1'</span> <span class="main">==</span> <span class="main">Œª</span> <span class="main">(</span><span class="bound">view</span> <span class="main">::</span> <span class="tfree">'v_OT121</span><span class="main">)</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">S2</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S3</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S4</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S5</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">a</span> <span class="main">::</span> <span class="tfree">'v_OT121</span> <span class="main">‚Üê</span> <span class="free">S1_OT12</span> <span class="main">(</span><span class="bound">S2</span><span class="main">,</span><span class="bound">S3</span><span class="main">)</span> <span class="main">()</span><span class="main">;</span>
    <span class="bound">b</span> <span class="main">::</span> <span class="tfree">'v_OT121</span> <span class="main">‚Üê</span> <span class="free">S1_OT12</span> <span class="main">(</span><span class="bound">S4</span><span class="main">,</span> <span class="bound">S5</span><span class="main">)</span> <span class="main">()</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">R</span> <span class="main">=</span> <span class="main">(</span><span class="free">M</span><span class="main">,</span> <span class="main">(</span><span class="bound">S2</span><span class="main">,</span><span class="bound">S3</span><span class="main">,</span> <span class="bound">S4</span><span class="main">,</span> <span class="bound">S5</span><span class="main">,</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">view</span><span class="main">)</span><span class="main">;</span>
    <span class="free">D</span> <span class="bound">R</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬¶</span>spmf <span class="main">(</span>bind_spmf <span class="main">(</span>R1_14_interm2 <span class="free">M</span> <span class="main">(</span><span class="free">c0</span><span class="main">,</span> <span class="free">c1</span><span class="main">)</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> True <span class="main">-</span> spmf <span class="main">(</span>bind_spmf <span class="main">(</span>S1_14 <span class="free">M</span> <span class="free">out</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> True<span class="main">¬¶</span> <span class="main">=</span>
       <span class="main">¬¶</span>spmf <span class="main">(</span>bind_spmf <span class="main">(</span>pair_spmf coin_spmf coin_spmf<span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span><span class="main">.</span> bind_spmf <span class="main">(</span><span class="free">R1_OT12</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span> <span class="free">c1</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="skolem">A1'</span> <span class="bound">view</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True <span class="main">-</span>
        spmf <span class="main">(</span>bind_spmf <span class="main">(</span>pair_spmf coin_spmf coin_spmf<span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span><span class="main">.</span> bind_spmf <span class="main">(</span><span class="free">S1_OT12</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span> <span class="main">()</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="skolem">A1'</span> <span class="bound">view</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bind_spmf <span class="main">(</span>R1_14_interm2 <span class="free">M</span> <span class="main">(</span><span class="free">c0</span><span class="main">,</span> <span class="free">c1</span><span class="main">)</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>bind_spmf <span class="main">(</span>pair_spmf coin_spmf coin_spmf<span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span><span class="main">.</span> bind_spmf <span class="main">(</span><span class="free">R1_OT12</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span> <span class="free">c1</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="skolem">A1'</span> <span class="bound">view</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span>  R1_14_interm2_def A1'_def Let_def split_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pair_spmf_alt_def<span class="main">)</span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span>  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span>  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span>  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
      <span class="keyword1"><span class="command">including</span></span> monad_normalisation <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bind_spmf <span class="main">(</span>S1_14 <span class="free">M</span> <span class="free">out</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>bind_spmf <span class="main">(</span>pair_spmf coin_spmf coin_spmf<span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span><span class="main">.</span> bind_spmf <span class="main">(</span><span class="free">S1_OT12</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span> <span class="main">()</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="skolem">A1'</span> <span class="bound">view</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> S1_14_def Let_def A1'_def split_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pair_spmf_alt_def<span class="main">)</span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span>  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span>  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span>  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">‚åë</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">‚åë</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">‚åë</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">‚åë</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">‚åë</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">‚åë</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">‚åë</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
      <span class="keyword1"><span class="command">including</span></span> monad_normalisation <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> reduction_P1_interm<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬¶</span>spmf <span class="main">(</span>bind_spmf <span class="main">(</span>R1_14 <span class="free">M</span> <span class="main">(</span><span class="free">c0</span><span class="main">,</span><span class="free">c1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">D</span><span class="main">)</span><span class="main">)</span> True <span class="main">-</span> spmf <span class="main">(</span>bind_spmf <span class="main">(</span>S1_14 <span class="free">M</span> <span class="free">out</span><span class="main">)</span> <span class="main">(</span><span class="free">D</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span> <span class="main">‚â§</span> <span class="numeral">3</span> <span class="main">*</span> <span class="free">adv_OT12</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">‚â§</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> lhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">‚â§</span> <span class="main">¬¶</span>spmf <span class="main">(</span>bind_spmf <span class="main">(</span>R1_14 <span class="free">M</span> <span class="main">(</span><span class="free">c0</span><span class="main">,</span> <span class="free">c1</span><span class="main">)</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> True <span class="main">-</span> spmf <span class="main">(</span>bind_spmf <span class="main">(</span>R1_14_interm1 <span class="free">M</span> <span class="main">(</span><span class="free">c0</span><span class="main">,</span> <span class="free">c1</span><span class="main">)</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> True<span class="main">¬¶</span> <span class="main">+</span> 
                     <span class="main">¬¶</span>spmf <span class="main">(</span>bind_spmf <span class="main">(</span>R1_14_interm1 <span class="free">M</span> <span class="main">(</span><span class="free">c0</span><span class="main">,</span> <span class="free">c1</span><span class="main">)</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> True <span class="main">-</span> spmf <span class="main">(</span>bind_spmf <span class="main">(</span>R1_14_interm2 <span class="free">M</span> <span class="main">(</span><span class="free">c0</span><span class="main">,</span> <span class="free">c1</span><span class="main">)</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> True<span class="main">¬¶</span> <span class="main">+</span>
                      <span class="main">¬¶</span>spmf <span class="main">(</span>bind_spmf <span class="main">(</span>R1_14_interm2 <span class="free">M</span> <span class="main">(</span><span class="free">c0</span><span class="main">,</span> <span class="free">c1</span><span class="main">)</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> True <span class="main">-</span> spmf <span class="main">(</span>bind_spmf <span class="main">(</span>S1_14 <span class="free">M</span> <span class="free">out</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> True<span class="main">¬¶</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A1</span></span> <span class="keyword2"><span class="keyword">where</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬¶</span>spmf <span class="main">(</span>bind_spmf <span class="main">(</span>R1_14 <span class="free">M</span> <span class="main">(</span><span class="free">c0</span><span class="main">,</span> <span class="free">c1</span><span class="main">)</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> True <span class="main">-</span> spmf <span class="main">(</span>bind_spmf <span class="main">(</span>R1_14_interm1 <span class="free">M</span> <span class="main">(</span><span class="free">c0</span><span class="main">,</span> <span class="free">c1</span><span class="main">)</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> True<span class="main">¬¶</span> <span class="main">=</span>
                        <span class="main">¬¶</span>spmf <span class="main">(</span>bind_spmf <span class="main">(</span>pair_spmf coin_spmf coin_spmf<span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span><span class="main">.</span> bind_spmf <span class="main">(</span><span class="free">R1_OT12</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span> <span class="free">c0</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="skolem">A1</span> <span class="bound">view</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True <span class="main">-</span>
                          spmf <span class="main">(</span>bind_spmf <span class="main">(</span>pair_spmf coin_spmf coin_spmf<span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span><span class="main">.</span> bind_spmf <span class="main">(</span><span class="free">S1_OT12</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span> <span class="main">()</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="skolem">A1</span> <span class="bound">view</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reduction_step1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A2</span></span> <span class="keyword2"><span class="keyword">where</span></span> A2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬¶</span>spmf <span class="main">(</span>bind_spmf <span class="main">(</span>R1_14_interm1 <span class="free">M</span> <span class="main">(</span><span class="free">c0</span><span class="main">,</span> <span class="free">c1</span><span class="main">)</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> True <span class="main">-</span> spmf <span class="main">(</span>bind_spmf <span class="main">(</span>R1_14_interm2 <span class="free">M</span> <span class="main">(</span><span class="free">c0</span><span class="main">,</span> <span class="free">c1</span><span class="main">)</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> True<span class="main">¬¶</span> <span class="main">=</span> 
                        <span class="main">¬¶</span>spmf <span class="main">(</span>bind_spmf <span class="main">(</span>pair_spmf coin_spmf coin_spmf<span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span><span class="main">.</span> bind_spmf <span class="main">(</span><span class="free">R1_OT12</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span> <span class="free">c1</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="skolem">A2</span> <span class="bound">view</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True <span class="main">-</span>
                          spmf <span class="main">(</span>bind_spmf <span class="main">(</span>pair_spmf coin_spmf coin_spmf<span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span><span class="main">.</span> bind_spmf <span class="main">(</span><span class="free">S1_OT12</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span> <span class="main">()</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="skolem">A2</span> <span class="bound">view</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reduction_step2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A3</span></span> <span class="keyword2"><span class="keyword">where</span></span> A3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬¶</span>spmf <span class="main">(</span>bind_spmf <span class="main">(</span>R1_14_interm2 <span class="free">M</span> <span class="main">(</span><span class="free">c0</span><span class="main">,</span> <span class="free">c1</span><span class="main">)</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> True <span class="main">-</span> spmf <span class="main">(</span>bind_spmf <span class="main">(</span>S1_14 <span class="free">M</span> <span class="free">out</span><span class="main">)</span> <span class="free">D</span><span class="main">)</span> True<span class="main">¬¶</span> <span class="main">=</span>
                        <span class="main">¬¶</span>spmf <span class="main">(</span>bind_spmf <span class="main">(</span>pair_spmf coin_spmf coin_spmf<span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span><span class="main">.</span> bind_spmf <span class="main">(</span><span class="free">R1_OT12</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span> <span class="free">c1</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="skolem">A3</span> <span class="bound">view</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True <span class="main">-</span>
                          spmf <span class="main">(</span>bind_spmf <span class="main">(</span>pair_spmf coin_spmf coin_spmf<span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span><span class="main">.</span> bind_spmf <span class="main">(</span><span class="free">S1_OT12</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span> <span class="main">()</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="skolem">A3</span> <span class="bound">view</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reduction_step3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> lhs_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">‚â§</span> <span class="main">¬¶</span>spmf <span class="main">(</span>bind_spmf <span class="main">(</span>pair_spmf coin_spmf coin_spmf<span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span><span class="main">.</span> bind_spmf <span class="main">(</span><span class="free">R1_OT12</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span> <span class="free">c0</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="skolem">A1</span> <span class="bound">view</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True <span class="main">-</span>
                  spmf <span class="main">(</span>bind_spmf <span class="main">(</span>pair_spmf coin_spmf coin_spmf<span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span><span class="main">.</span> bind_spmf <span class="main">(</span><span class="free">S1_OT12</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span> <span class="main">()</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="skolem">A1</span> <span class="bound">view</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span> <span class="main">+</span> 
                   <span class="main">¬¶</span>spmf <span class="main">(</span>bind_spmf <span class="main">(</span>pair_spmf coin_spmf coin_spmf<span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span><span class="main">.</span> bind_spmf <span class="main">(</span><span class="free">R1_OT12</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span> <span class="free">c1</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="skolem">A2</span> <span class="bound">view</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True <span class="main">-</span>
                    spmf <span class="main">(</span>bind_spmf <span class="main">(</span>pair_spmf coin_spmf coin_spmf<span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span><span class="main">.</span> bind_spmf <span class="main">(</span><span class="free">S1_OT12</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span> <span class="main">()</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="skolem">A2</span> <span class="bound">view</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span> <span class="main">+</span>
                     <span class="main">¬¶</span>spmf <span class="main">(</span>bind_spmf <span class="main">(</span>pair_spmf coin_spmf coin_spmf<span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span><span class="main">.</span> bind_spmf <span class="main">(</span><span class="free">R1_OT12</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span> <span class="free">c1</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="skolem">A3</span> <span class="bound">view</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True <span class="main">-</span>
                      spmf <span class="main">(</span>bind_spmf <span class="main">(</span>pair_spmf coin_spmf coin_spmf<span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span><span class="main">.</span> bind_spmf <span class="main">(</span><span class="free">S1_OT12</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span> <span class="main">()</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="skolem">A3</span> <span class="bound">view</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A1 A2 A3 lhs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> bound1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬¶</span>spmf <span class="main">(</span>bind_spmf <span class="main">(</span>pair_spmf coin_spmf coin_spmf<span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span><span class="main">.</span> bind_spmf <span class="main">(</span><span class="free">R1_OT12</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span> <span class="free">c0</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="skolem">A1</span> <span class="bound">view</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True <span class="main">-</span>
                  spmf <span class="main">(</span>bind_spmf <span class="main">(</span>pair_spmf coin_spmf coin_spmf<span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span><span class="main">.</span> bind_spmf <span class="main">(</span><span class="free">S1_OT12</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span> <span class="main">()</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="skolem">A1</span> <span class="bound">view</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span> 
                      <span class="main">‚â§</span> <span class="free">adv_OT12</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> bound2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬¶</span>spmf <span class="main">(</span>bind_spmf <span class="main">(</span>pair_spmf coin_spmf coin_spmf<span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span><span class="main">.</span> bind_spmf <span class="main">(</span><span class="free">R1_OT12</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span> <span class="free">c1</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="skolem">A2</span> <span class="bound">view</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True <span class="main">-</span>
                  spmf <span class="main">(</span>bind_spmf <span class="main">(</span>pair_spmf coin_spmf coin_spmf<span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span><span class="main">.</span> bind_spmf <span class="main">(</span><span class="free">S1_OT12</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span> <span class="main">()</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="skolem">A2</span> <span class="bound">view</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span> 
                      <span class="main">‚â§</span> <span class="free">adv_OT12</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> bound3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬¶</span>spmf <span class="main">(</span>bind_spmf <span class="main">(</span>pair_spmf coin_spmf coin_spmf<span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span><span class="main">.</span> bind_spmf <span class="main">(</span><span class="free">R1_OT12</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span> <span class="free">c1</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="skolem">A3</span> <span class="bound">view</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True <span class="main">-</span>
        spmf <span class="main">(</span>bind_spmf <span class="main">(</span>pair_spmf coin_spmf coin_spmf<span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">m0</span><span class="main">,</span> <span class="bound">m1</span><span class="main">)</span><span class="main">.</span> bind_spmf <span class="main">(</span><span class="free">S1_OT12</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span> <span class="main">()</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="skolem">A3</span> <span class="bound">view</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span> <span class="main">‚â§</span> <span class="free">adv_OT12</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reduction_step1' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> reduction_step1' lhs_bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> reduction_P1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬¶</span>spmf <span class="main">(</span>bind_spmf <span class="main">(</span>R1_14 <span class="free">M</span> <span class="main">(</span><span class="free">c0</span><span class="main">,</span><span class="free">c1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">D</span><span class="main">)</span><span class="main">)</span> True 
                        <span class="main">-</span> spmf <span class="main">(</span>funct_OT_14 <span class="free">M</span> <span class="main">(</span><span class="free">c0</span><span class="main">,</span><span class="free">c1</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">out1</span><span class="main">,</span><span class="bound">out2</span><span class="main">)</span><span class="main">.</span> S1_14 <span class="free">M</span> <span class="bound">out1</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="free">D</span> <span class="bound">view</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span> 
                              <span class="main">‚â§</span> <span class="numeral">3</span> <span class="main">*</span> <span class="free">adv_OT12</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> funct_OT_14_def split_def Let_def reduction_P1_interm <span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‚ÄπParty 2 security.‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> coin_coin<span class="main">:</span> <span class="quoted"><span class="quoted">"map_spmf <span class="main">(</span><span class="main">Œª</span> <span class="bound">S0</span><span class="main">.</span> <span class="bound">S0</span> <span class="main">‚äï</span> <span class="free">S3</span> <span class="main">‚äï</span> <span class="free">m1</span><span class="main">)</span> coin_spmf <span class="main">=</span> coin_spmf"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> lhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> map_spmf <span class="main">(</span><span class="main">Œª</span> <span class="bound">S0</span><span class="main">.</span> <span class="bound">S0</span> <span class="main">‚äï</span> <span class="main">(</span><span class="free">S3</span> <span class="main">‚äï</span> <span class="free">m1</span><span class="main">)</span><span class="main">)</span> coin_spmf"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> op_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> map_spmf <span class="main">(</span><span class="main">(‚äï)</span> <span class="main">(</span><span class="free">S3</span> <span class="main">‚äï</span> <span class="free">m1</span><span class="main">)</span><span class="main">)</span> coin_spmf"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> xor_bool_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> xor_uni_samp <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> op_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> coin_coin'<span class="main">:</span> <span class="quoted"><span class="quoted">"map_spmf <span class="main">(</span><span class="main">Œª</span> <span class="bound">S3</span><span class="main">.</span> <span class="free">S0</span> <span class="main">‚äï</span> <span class="bound">S3</span> <span class="main">‚äï</span> <span class="free">m1</span><span class="main">)</span> coin_spmf <span class="main">=</span> coin_spmf"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_spmf <span class="main">(</span><span class="main">Œª</span> <span class="bound">S3</span><span class="main">.</span> <span class="free">S0</span> <span class="main">‚äï</span> <span class="bound">S3</span> <span class="main">‚äï</span> <span class="free">m1</span><span class="main">)</span> coin_spmf <span class="main">=</span> map_spmf <span class="main">(</span><span class="main">Œª</span> <span class="bound">S3</span><span class="main">.</span> <span class="bound">S3</span> <span class="main">‚äï</span> <span class="free">S0</span> <span class="main">‚äï</span> <span class="free">m1</span><span class="main">)</span> coin_spmf"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> xor_left_commute<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> coin_coin <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">R2_14</span><span class="main">::</span> <span class="quoted"><span class="quoted">"input1 <span class="main">‚áí</span> input2 <span class="main">‚áí</span> <span class="tfree">'v_OT122</span> view2 spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">R2_14</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">m0</span><span class="main">,</span><span class="bound">m1</span><span class="main">,</span><span class="bound">m2</span><span class="main">,</span><span class="bound">m3</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">c0</span><span class="main">,</span><span class="bound">c1</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">;</span>
    <span class="bound">S0</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S1</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S2</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S3</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S4</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S5</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a0</span> <span class="main">=</span> <span class="bound">S0</span> <span class="main">‚äï</span> <span class="bound">S2</span> <span class="main">‚äï</span> <span class="bound">m0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a1</span> <span class="main">=</span> <span class="bound">S0</span> <span class="main">‚äï</span> <span class="bound">S3</span> <span class="main">‚äï</span> <span class="bound">m1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a2</span> <span class="main">=</span> <span class="bound">S1</span> <span class="main">‚äï</span> <span class="bound">S4</span> <span class="main">‚äï</span> <span class="bound">m2</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a3</span> <span class="main">=</span> <span class="bound">S1</span> <span class="main">‚äï</span> <span class="bound">S5</span> <span class="main">‚äï</span> <span class="bound">m3</span><span class="main">;</span> 
    <span class="bound">a</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">R2_OT12</span> <span class="main">(</span><span class="bound">S0</span><span class="main">,</span><span class="bound">S1</span><span class="main">)</span> <span class="bound">c0</span><span class="main">;</span>
    <span class="bound">b</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">R2_OT12</span> <span class="main">(</span><span class="bound">S2</span><span class="main">,</span><span class="bound">S3</span><span class="main">)</span> <span class="bound">c1</span><span class="main">;</span>
    <span class="bound">c</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">R2_OT12</span> <span class="main">(</span><span class="bound">S4</span><span class="main">,</span><span class="bound">S5</span><span class="main">)</span> <span class="bound">c1</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="main">(</span><span class="bound">a0</span><span class="main">,</span><span class="bound">a1</span><span class="main">,</span><span class="bound">a2</span><span class="main">,</span><span class="bound">a3</span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lossless_R2_14<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span>R2_14 <span class="free">M</span> <span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R2_14_def split_def lossless_R2_12<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">S2_14</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"input2 <span class="main">‚áí</span> bool <span class="main">‚áí</span> <span class="tfree">'v_OT122</span> view2 spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">S2_14</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">out</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="main">(</span><span class="bound">c0</span><span class="main">::</span>bool<span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">c1</span><span class="main">::</span>bool<span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">;</span>
    <span class="bound">S0</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S1</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S2</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S3</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S4</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S5</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">a0</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">a1</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">a2</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">a3</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a0'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">(</span><span class="main">¬¨</span> <span class="bound">c0</span><span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="main">¬¨</span> <span class="bound">c1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span><span class="bound">S0</span> <span class="main">‚äï</span> <span class="bound">S2</span> <span class="main">‚äï</span> <span class="free"><span class="bound"><span class="entity">out</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="bound">a0</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a1'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">(</span><span class="main">¬¨</span> <span class="bound">c0</span><span class="main">)</span> <span class="main">‚àß</span> <span class="bound">c1</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span><span class="bound">S0</span> <span class="main">‚äï</span> <span class="bound">S3</span> <span class="main">‚äï</span> <span class="free"><span class="bound"><span class="entity">out</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="bound">a1</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a2'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="bound">c0</span> <span class="main">‚àß</span> <span class="main">(</span><span class="main">¬¨</span> <span class="bound">c1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span><span class="bound">S1</span> <span class="main">‚äï</span> <span class="bound">S4</span> <span class="main">‚äï</span> <span class="free"><span class="bound"><span class="entity">out</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="bound">a2</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a3'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="bound">c0</span> <span class="main">‚àß</span> <span class="bound">c1</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span><span class="bound">S1</span> <span class="main">‚äï</span> <span class="bound">S5</span> <span class="main">‚äï</span> <span class="free"><span class="bound"><span class="entity">out</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="bound">a3</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">a</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> <span class="main">(</span><span class="bound">c0</span><span class="main">::</span>bool<span class="main">)</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">c0</span> <span class="keyword1">then</span> <span class="bound">S1</span> <span class="keyword1">else</span> <span class="bound">S0</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">b</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> <span class="main">(</span><span class="bound">c1</span><span class="main">::</span>bool<span class="main">)</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">c1</span> <span class="keyword1">then</span> <span class="bound">S3</span> <span class="keyword1">else</span> <span class="bound">S2</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">c</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> <span class="main">(</span><span class="bound">c1</span><span class="main">::</span>bool<span class="main">)</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">c1</span> <span class="keyword1">then</span> <span class="bound">S5</span> <span class="keyword1">else</span> <span class="bound">S4</span><span class="main">)</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">(</span><span class="bound">c0</span><span class="main">,</span><span class="bound">c1</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">a0'</span><span class="main">,</span><span class="bound">a1'</span><span class="main">,</span><span class="bound">a2'</span><span class="main">,</span><span class="bound">a3'</span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lossless_S2_14<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span>S2_14 <span class="free">c</span> <span class="free">out</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S2_14_def lossless_S2_12 split_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> P2_OT_14_FT<span class="main">:</span> <span class="quoted"><span class="quoted">"R2_14 <span class="main">(</span><span class="free">m0</span><span class="main">,</span><span class="free">m1</span><span class="main">,</span><span class="free">m2</span><span class="main">,</span><span class="free">m3</span><span class="main">)</span> <span class="main">(</span>False<span class="main">,</span>True<span class="main">)</span> <span class="main">=</span> funct_OT_14 <span class="main">(</span><span class="free">m0</span><span class="main">,</span><span class="free">m1</span><span class="main">,</span><span class="free">m2</span><span class="main">,</span><span class="free">m3</span><span class="main">)</span> <span class="main">(</span>False<span class="main">,</span>True<span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">out1</span><span class="main">,</span> <span class="bound">out2</span><span class="main">)</span><span class="main">.</span> S2_14 <span class="main">(</span>False<span class="main">,</span>True<span class="main">)</span> <span class="bound">out2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">including</span></span> monad_normalisation
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"R2_14 <span class="main">(</span><span class="free">m0</span><span class="main">,</span><span class="free">m1</span><span class="main">,</span><span class="free">m2</span><span class="main">,</span><span class="free">m3</span><span class="main">)</span> <span class="main">(</span>False<span class="main">,</span>True<span class="main">)</span> <span class="main">=</span>  <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">S0</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S1</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S3</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S5</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">a0</span> <span class="main">::</span> bool <span class="main">‚Üê</span> map_spmf <span class="main">(</span><span class="main">Œª</span> <span class="bound">S2</span><span class="main">.</span> <span class="bound">S0</span> <span class="main">‚äï</span> <span class="bound">S2</span> <span class="main">‚äï</span> <span class="free">m0</span><span class="main">)</span> coin_spmf<span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a1</span> <span class="main">=</span> <span class="bound">S0</span> <span class="main">‚äï</span> <span class="bound">S3</span> <span class="main">‚äï</span> <span class="free">m1</span><span class="main">;</span>
    <span class="bound">a2</span> <span class="main">‚Üê</span> map_spmf <span class="main">(</span><span class="main">Œª</span> <span class="bound">S4</span><span class="main">.</span> <span class="bound">S1</span> <span class="main">‚äï</span> <span class="bound">S4</span> <span class="main">‚äï</span> <span class="free">m2</span><span class="main">)</span> coin_spmf<span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a3</span> <span class="main">=</span> <span class="bound">S1</span> <span class="main">‚äï</span> <span class="bound">S5</span> <span class="main">‚äï</span> <span class="free">m3</span><span class="main">;</span> 
    <span class="bound">a</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> False <span class="bound">S0</span><span class="main">;</span> 
    <span class="bound">b</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> True <span class="bound">S3</span><span class="main">;</span>
    <span class="bound">c</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> True <span class="bound">S5</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">(</span>False<span class="main">,</span>True<span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">a0</span><span class="main">,</span><span class="bound">a1</span><span class="main">,</span><span class="bound">a2</span><span class="main">,</span><span class="bound">a3</span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_map_spmf o_def Let_def R2_14_def inf_th_OT12_P2 funct_OT_12_def OT_12_P2_assm<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">S0</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S1</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S3</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S5</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">a0</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a1</span> <span class="main">=</span> <span class="bound">S0</span> <span class="main">‚äï</span> <span class="bound">S3</span> <span class="main">‚äï</span> <span class="free">m1</span><span class="main">;</span>
    <span class="bound">a2</span> <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a3</span> <span class="main">=</span> <span class="bound">S1</span> <span class="main">‚äï</span> <span class="bound">S5</span> <span class="main">‚äï</span> <span class="free">m3</span><span class="main">;</span> 
    <span class="bound">a</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> False <span class="bound">S0</span><span class="main">;</span> 
    <span class="bound">b</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> True <span class="bound">S3</span><span class="main">;</span>
    <span class="bound">c</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> True <span class="bound">S5</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">(</span>False<span class="main">,</span>True<span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">a0</span><span class="main">,</span><span class="bound">a1</span><span class="main">,</span><span class="bound">a2</span><span class="main">,</span><span class="bound">a3</span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> coin_coin' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">S0</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S3</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S5</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">a0</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a1</span> <span class="main">=</span> <span class="bound">S0</span> <span class="main">‚äï</span> <span class="bound">S3</span> <span class="main">‚äï</span> <span class="free">m1</span><span class="main">;</span>
    <span class="bound">a2</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">a3</span> <span class="main">‚Üê</span> map_spmf <span class="main">(</span><span class="main">Œª</span> <span class="bound">S1</span><span class="main">.</span> <span class="bound">S1</span> <span class="main">‚äï</span> <span class="bound">S5</span> <span class="main">‚äï</span> <span class="free">m3</span><span class="main">)</span> coin_spmf<span class="main">;</span> 
    <span class="bound">a</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> False <span class="bound">S0</span><span class="main">;</span> 
    <span class="bound">b</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> True <span class="bound">S3</span><span class="main">;</span>
    <span class="bound">c</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> True <span class="bound">S5</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">(</span>False<span class="main">,</span>True<span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">a0</span><span class="main">,</span><span class="bound">a1</span><span class="main">,</span><span class="bound">a2</span><span class="main">,</span><span class="bound">a3</span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_map_spmf o_def Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">S0</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S3</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S5</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">a0</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a1</span> <span class="main">=</span> <span class="bound">S0</span> <span class="main">‚äï</span> <span class="bound">S3</span> <span class="main">‚äï</span> <span class="free">m1</span><span class="main">;</span>
    <span class="bound">a2</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">a3</span> <span class="main">‚Üê</span> coin_spmf<span class="main">;</span> 
    <span class="bound">a</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> False <span class="bound">S0</span><span class="main">;</span> 
    <span class="bound">b</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> True <span class="bound">S3</span><span class="main">;</span>
    <span class="bound">c</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> True <span class="bound">S5</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">(</span>False<span class="main">,</span>True<span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">a0</span><span class="main">,</span><span class="bound">a1</span><span class="main">,</span><span class="bound">a2</span><span class="main">,</span><span class="bound">a3</span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> coin_coin <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> funct_OT_14_def S2_14_def bind_spmf_const<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P2_OT_14_TT<span class="main">:</span> <span class="quoted"><span class="quoted">"R2_14 <span class="main">(</span><span class="free">m0</span><span class="main">,</span><span class="free">m1</span><span class="main">,</span><span class="free">m2</span><span class="main">,</span><span class="free">m3</span><span class="main">)</span> <span class="main">(</span>True<span class="main">,</span>True<span class="main">)</span> <span class="main">=</span> funct_OT_14 <span class="main">(</span><span class="free">m0</span><span class="main">,</span><span class="free">m1</span><span class="main">,</span><span class="free">m2</span><span class="main">,</span><span class="free">m3</span><span class="main">)</span> <span class="main">(</span>True<span class="main">,</span>True<span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">out1</span><span class="main">,</span> <span class="bound">out2</span><span class="main">)</span><span class="main">.</span> S2_14 <span class="main">(</span>True<span class="main">,</span>True<span class="main">)</span> <span class="bound">out2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">including</span></span> monad_normalisation
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"R2_14 <span class="main">(</span><span class="free">m0</span><span class="main">,</span><span class="free">m1</span><span class="main">,</span><span class="free">m2</span><span class="main">,</span><span class="free">m3</span><span class="main">)</span> <span class="main">(</span>True<span class="main">,</span>True<span class="main">)</span> <span class="main">=</span>  <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">S0</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S1</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S3</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S5</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">a0</span> <span class="main">::</span> bool <span class="main">‚Üê</span> map_spmf <span class="main">(</span><span class="main">Œª</span> <span class="bound">S2</span><span class="main">.</span> <span class="bound">S0</span> <span class="main">‚äï</span> <span class="bound">S2</span> <span class="main">‚äï</span> <span class="free">m0</span><span class="main">)</span> coin_spmf<span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a1</span> <span class="main">=</span> <span class="bound">S0</span> <span class="main">‚äï</span> <span class="bound">S3</span> <span class="main">‚äï</span> <span class="free">m1</span><span class="main">;</span>
    <span class="bound">a2</span> <span class="main">‚Üê</span> map_spmf <span class="main">(</span><span class="main">Œª</span> <span class="bound">S4</span><span class="main">.</span> <span class="bound">S1</span> <span class="main">‚äï</span> <span class="bound">S4</span> <span class="main">‚äï</span> <span class="free">m2</span><span class="main">)</span> coin_spmf<span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a3</span> <span class="main">=</span> <span class="bound">S1</span> <span class="main">‚äï</span> <span class="bound">S5</span> <span class="main">‚äï</span> <span class="free">m3</span><span class="main">;</span>
    <span class="bound">a</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> True <span class="bound">S1</span><span class="main">;</span> 
    <span class="bound">b</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> True <span class="bound">S3</span><span class="main">;</span>
    <span class="bound">c</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> True <span class="bound">S5</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">(</span>True<span class="main">,</span>True<span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">a0</span><span class="main">,</span><span class="bound">a1</span><span class="main">,</span><span class="bound">a2</span><span class="main">,</span><span class="bound">a3</span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_map_spmf o_def R2_14_def inf_th_OT12_P2 funct_OT_12_def OT_12_P2_assm Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">S0</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S1</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S3</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S5</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">a0</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a1</span> <span class="main">=</span> <span class="bound">S0</span> <span class="main">‚äï</span> <span class="bound">S3</span> <span class="main">‚äï</span> <span class="free">m1</span><span class="main">;</span>
    <span class="bound">a2</span> <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a3</span> <span class="main">=</span> <span class="bound">S1</span> <span class="main">‚äï</span> <span class="bound">S5</span> <span class="main">‚äï</span> <span class="free">m3</span><span class="main">;</span>
    <span class="bound">a</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> True <span class="bound">S1</span><span class="main">;</span> 
    <span class="bound">b</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> True <span class="bound">S3</span><span class="main">;</span>
    <span class="bound">c</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> True <span class="bound">S5</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">(</span>True<span class="main">,</span>True<span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">a0</span><span class="main">,</span><span class="bound">a1</span><span class="main">,</span><span class="bound">a2</span><span class="main">,</span><span class="bound">a3</span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> coin_coin' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">S1</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S3</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S5</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">a0</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">a1</span> <span class="main">::</span> bool <span class="main">‚Üê</span> map_spmf <span class="main">(</span><span class="main">Œª</span> <span class="bound">S0</span><span class="main">.</span> <span class="bound">S0</span> <span class="main">‚äï</span> <span class="bound">S3</span> <span class="main">‚äï</span> <span class="free">m1</span><span class="main">)</span> coin_spmf<span class="main">;</span>
    <span class="bound">a2</span> <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a3</span> <span class="main">=</span> <span class="bound">S1</span> <span class="main">‚äï</span> <span class="bound">S5</span> <span class="main">‚äï</span> <span class="free">m3</span><span class="main">;</span>
    <span class="bound">a</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> True <span class="bound">S1</span><span class="main">;</span> 
    <span class="bound">b</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> True <span class="bound">S3</span><span class="main">;</span>
    <span class="bound">c</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> True <span class="bound">S5</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">(</span>True<span class="main">,</span>True<span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">a0</span><span class="main">,</span><span class="bound">a1</span><span class="main">,</span><span class="bound">a2</span><span class="main">,</span><span class="bound">a3</span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_map_spmf o_def Let_def<span class="main">)</span>    
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">S1</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S3</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S5</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">a0</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">a1</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">a2</span> <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a3</span> <span class="main">=</span> <span class="bound">S1</span> <span class="main">‚äï</span> <span class="bound">S5</span> <span class="main">‚äï</span> <span class="free">m3</span><span class="main">;</span>
    <span class="bound">a</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> True <span class="bound">S1</span><span class="main">;</span> 
    <span class="bound">b</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> True <span class="bound">S3</span><span class="main">;</span>
    <span class="bound">c</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> True <span class="bound">S5</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">(</span>True<span class="main">,</span>True<span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">a0</span><span class="main">,</span><span class="bound">a1</span><span class="main">,</span><span class="bound">a2</span><span class="main">,</span><span class="bound">a3</span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> coin_coin <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> funct_OT_14_def S2_14_def bind_spmf_const<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P2_OT_14_FF<span class="main">:</span> <span class="quoted"><span class="quoted">"R2_14 <span class="main">(</span><span class="free">m0</span><span class="main">,</span><span class="free">m1</span><span class="main">,</span><span class="free">m2</span><span class="main">,</span><span class="free">m3</span><span class="main">)</span> <span class="main">(</span>False<span class="main">,</span> False<span class="main">)</span> <span class="main">=</span> funct_OT_14 <span class="main">(</span><span class="free">m0</span><span class="main">,</span><span class="free">m1</span><span class="main">,</span><span class="free">m2</span><span class="main">,</span><span class="free">m3</span><span class="main">)</span> <span class="main">(</span>False<span class="main">,</span> False<span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">out1</span><span class="main">,</span> <span class="bound">out2</span><span class="main">)</span><span class="main">.</span> S2_14 <span class="main">(</span>False<span class="main">,</span> False<span class="main">)</span> <span class="bound">out2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">including</span></span> monad_normalisation
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"R2_14 <span class="main">(</span><span class="free">m0</span><span class="main">,</span><span class="free">m1</span><span class="main">,</span><span class="free">m2</span><span class="main">,</span><span class="free">m3</span><span class="main">)</span> <span class="main">(</span>False<span class="main">,</span>False<span class="main">)</span> <span class="main">=</span>  <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">S0</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S1</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S2</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S4</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a0</span> <span class="main">=</span> <span class="bound">S0</span> <span class="main">‚äï</span> <span class="bound">S2</span> <span class="main">‚äï</span> <span class="free">m0</span><span class="main">;</span>
    <span class="bound">a1</span> <span class="main">::</span> bool <span class="main">‚Üê</span> map_spmf <span class="main">(</span><span class="main">Œª</span> <span class="bound">S3</span><span class="main">.</span> <span class="bound">S0</span> <span class="main">‚äï</span> <span class="bound">S3</span> <span class="main">‚äï</span> <span class="free">m1</span><span class="main">)</span> coin_spmf<span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a2</span> <span class="main">=</span> <span class="bound">S1</span> <span class="main">‚äï</span> <span class="bound">S4</span> <span class="main">‚äï</span> <span class="free">m2</span><span class="main">;</span>
    <span class="bound">a3</span> <span class="main">‚Üê</span> map_spmf <span class="main">(</span><span class="main">Œª</span> <span class="bound">S5</span><span class="main">.</span> <span class="bound">S1</span> <span class="main">‚äï</span> <span class="bound">S5</span> <span class="main">‚äï</span> <span class="free">m3</span><span class="main">)</span> coin_spmf<span class="main">;</span> 
    <span class="bound">a</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> False <span class="bound">S0</span><span class="main">;</span> 
    <span class="bound">b</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> False <span class="bound">S2</span><span class="main">;</span>
    <span class="bound">c</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> False <span class="bound">S4</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">(</span>False<span class="main">,</span>False<span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">a0</span><span class="main">,</span><span class="bound">a1</span><span class="main">,</span><span class="bound">a2</span><span class="main">,</span><span class="bound">a3</span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_map_spmf o_def R2_14_def inf_th_OT12_P2 funct_OT_12_def OT_12_P2_assm Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">S0</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S1</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S2</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S4</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a0</span> <span class="main">=</span> <span class="bound">S0</span> <span class="main">‚äï</span> <span class="bound">S2</span> <span class="main">‚äï</span> <span class="free">m0</span><span class="main">;</span>
    <span class="bound">a1</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a2</span> <span class="main">=</span> <span class="bound">S1</span> <span class="main">‚äï</span> <span class="bound">S4</span> <span class="main">‚äï</span> <span class="free">m2</span><span class="main">;</span>
    <span class="bound">a3</span> <span class="main">‚Üê</span> coin_spmf<span class="main">;</span> 
    <span class="bound">a</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> False <span class="bound">S0</span><span class="main">;</span> 
    <span class="bound">b</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> False <span class="bound">S2</span><span class="main">;</span>
    <span class="bound">c</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> False <span class="bound">S4</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">(</span>False<span class="main">,</span>False<span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">a0</span><span class="main">,</span><span class="bound">a1</span><span class="main">,</span><span class="bound">a2</span><span class="main">,</span><span class="bound">a3</span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> coin_coin' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">S0</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S2</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S4</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a0</span> <span class="main">=</span> <span class="bound">S0</span> <span class="main">‚äï</span> <span class="bound">S2</span> <span class="main">‚äï</span> <span class="free">m0</span><span class="main">;</span>
    <span class="bound">a1</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">a2</span> <span class="main">::</span> bool <span class="main">‚Üê</span> map_spmf <span class="main">(</span><span class="main">Œª</span> <span class="bound">S1</span><span class="main">.</span> <span class="bound">S1</span> <span class="main">‚äï</span> <span class="bound">S4</span> <span class="main">‚äï</span> <span class="free">m2</span><span class="main">)</span> coin_spmf<span class="main">;</span>
    <span class="bound">a3</span> <span class="main">‚Üê</span> coin_spmf<span class="main">;</span> 
    <span class="bound">a</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> False <span class="bound">S0</span><span class="main">;</span> 
    <span class="bound">b</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> False <span class="bound">S2</span><span class="main">;</span>
    <span class="bound">c</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> False <span class="bound">S4</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">(</span>False<span class="main">,</span>False<span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">a0</span><span class="main">,</span><span class="bound">a1</span><span class="main">,</span><span class="bound">a2</span><span class="main">,</span><span class="bound">a3</span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_map_spmf o_def Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">S0</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S2</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S4</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a0</span> <span class="main">=</span> <span class="bound">S0</span> <span class="main">‚äï</span> <span class="bound">S2</span> <span class="main">‚äï</span> <span class="free">m0</span><span class="main">;</span>
    <span class="bound">a1</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">a2</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">a3</span> <span class="main">‚Üê</span> coin_spmf<span class="main">;</span> 
    <span class="bound">a</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> False <span class="bound">S0</span><span class="main">;</span> 
    <span class="bound">b</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> False <span class="bound">S2</span><span class="main">;</span>
    <span class="bound">c</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> False <span class="bound">S4</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">(</span>False<span class="main">,</span>False<span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">a0</span><span class="main">,</span><span class="bound">a1</span><span class="main">,</span><span class="bound">a2</span><span class="main">,</span><span class="bound">a3</span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> coin_coin <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> funct_OT_14_def S2_14_def bind_spmf_const<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P2_OT_14_TF<span class="main">:</span> <span class="quoted"><span class="quoted">"R2_14 <span class="main">(</span><span class="free">m0</span><span class="main">,</span><span class="free">m1</span><span class="main">,</span><span class="free">m2</span><span class="main">,</span><span class="free">m3</span><span class="main">)</span> <span class="main">(</span>True<span class="main">,</span>False<span class="main">)</span> <span class="main">=</span> funct_OT_14 <span class="main">(</span><span class="free">m0</span><span class="main">,</span><span class="free">m1</span><span class="main">,</span><span class="free">m2</span><span class="main">,</span><span class="free">m3</span><span class="main">)</span> <span class="main">(</span>True<span class="main">,</span>False<span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">out1</span><span class="main">,</span> <span class="bound">out2</span><span class="main">)</span><span class="main">.</span> S2_14 <span class="main">(</span>True<span class="main">,</span>False<span class="main">)</span> <span class="bound">out2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">including</span></span> monad_normalisation
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"R2_14 <span class="main">(</span><span class="free">m0</span><span class="main">,</span><span class="free">m1</span><span class="main">,</span><span class="free">m2</span><span class="main">,</span><span class="free">m3</span><span class="main">)</span> <span class="main">(</span>True<span class="main">,</span>False<span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">S0</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S1</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S2</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S4</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a0</span> <span class="main">=</span> <span class="bound">S0</span> <span class="main">‚äï</span> <span class="bound">S2</span> <span class="main">‚äï</span> <span class="free">m0</span><span class="main">;</span>
    <span class="bound">a1</span> <span class="main">::</span> bool <span class="main">‚Üê</span> map_spmf <span class="main">(</span><span class="main">Œª</span> <span class="bound">S3</span><span class="main">.</span> <span class="bound">S0</span> <span class="main">‚äï</span> <span class="bound">S3</span> <span class="main">‚äï</span> <span class="free">m1</span><span class="main">)</span> coin_spmf<span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a2</span> <span class="main">=</span> <span class="bound">S1</span> <span class="main">‚äï</span> <span class="bound">S4</span> <span class="main">‚äï</span> <span class="free">m2</span><span class="main">;</span>
    <span class="bound">a3</span> <span class="main">‚Üê</span> map_spmf <span class="main">(</span><span class="main">Œª</span> <span class="bound">S5</span><span class="main">.</span> <span class="bound">S1</span> <span class="main">‚äï</span> <span class="bound">S5</span> <span class="main">‚äï</span> <span class="free">m3</span><span class="main">)</span> coin_spmf<span class="main">;</span> 
    <span class="bound">a</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> True <span class="bound">S1</span><span class="main">;</span> 
    <span class="bound">b</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> False <span class="bound">S2</span><span class="main">;</span>
    <span class="bound">c</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> False <span class="bound">S4</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">(</span>True<span class="main">,</span>False<span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">a0</span><span class="main">,</span><span class="bound">a1</span><span class="main">,</span><span class="bound">a2</span><span class="main">,</span><span class="bound">a3</span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R2_14_def inf_th_OT12_P2 OT_12_P2_assm funct_OT_12_def Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">‚åë</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">‚åë</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span>  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">‚åë</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_map_spmf o_def Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">S0</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S1</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S2</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S4</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a0</span> <span class="main">=</span> <span class="bound">S0</span> <span class="main">‚äï</span> <span class="bound">S2</span> <span class="main">‚äï</span> <span class="free">m0</span><span class="main">;</span>
    <span class="bound">a1</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a2</span> <span class="main">=</span> <span class="bound">S1</span> <span class="main">‚äï</span> <span class="bound">S4</span> <span class="main">‚äï</span> <span class="free">m2</span><span class="main">;</span>
    <span class="bound">a3</span> <span class="main">‚Üê</span> coin_spmf<span class="main">;</span> 
    <span class="bound">a</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> True <span class="bound">S1</span><span class="main">;</span> 
    <span class="bound">b</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> False <span class="bound">S2</span><span class="main">;</span>
    <span class="bound">c</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> False <span class="bound">S4</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">(</span>True<span class="main">,</span>False<span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">a0</span><span class="main">,</span><span class="bound">a1</span><span class="main">,</span><span class="bound">a2</span><span class="main">,</span><span class="bound">a3</span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> coin_coin' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">S1</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S2</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S4</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">a0</span> <span class="main">::</span> bool <span class="main">‚Üê</span> map_spmf <span class="main">(</span><span class="main">Œª</span> <span class="bound">S0</span><span class="main">.</span> <span class="bound">S0</span> <span class="main">‚äï</span> <span class="bound">S2</span> <span class="main">‚äï</span> <span class="free">m0</span><span class="main">)</span> coin_spmf<span class="main">;</span>
    <span class="bound">a1</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a2</span> <span class="main">=</span> <span class="bound">S1</span> <span class="main">‚äï</span> <span class="bound">S4</span> <span class="main">‚äï</span> <span class="free">m2</span><span class="main">;</span>
    <span class="bound">a3</span> <span class="main">‚Üê</span> coin_spmf<span class="main">;</span> 
    <span class="bound">a</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> True <span class="bound">S1</span><span class="main">;</span> 
    <span class="bound">b</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> False <span class="bound">S2</span><span class="main">;</span>
    <span class="bound">c</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> False <span class="bound">S4</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">(</span>True<span class="main">,</span>False<span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">a0</span><span class="main">,</span><span class="bound">a1</span><span class="main">,</span><span class="bound">a2</span><span class="main">,</span><span class="bound">a3</span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_map_spmf o_def Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">S1</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S2</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">S4</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">a0</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="bound">a1</span> <span class="main">::</span> bool <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a2</span> <span class="main">=</span> <span class="bound">S1</span> <span class="main">‚äï</span> <span class="bound">S4</span> <span class="main">‚äï</span> <span class="free">m2</span><span class="main">;</span>
    <span class="bound">a3</span> <span class="main">‚Üê</span> coin_spmf<span class="main">;</span> 
    <span class="bound">a</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> True <span class="bound">S1</span><span class="main">;</span> 
    <span class="bound">b</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> False <span class="bound">S2</span><span class="main">;</span>
    <span class="bound">c</span> <span class="main">::</span> <span class="tfree">'v_OT122</span> <span class="main">‚Üê</span> <span class="free">S2_OT12</span> False <span class="bound">S4</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">(</span>True<span class="main">,</span>False<span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">a0</span><span class="main">,</span><span class="bound">a1</span><span class="main">,</span><span class="bound">a2</span><span class="main">,</span><span class="bound">a3</span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> coin_coin <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> funct_OT_14_def S2_14_def bind_spmf_const<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span>  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">‚åë</span></span>"</span></span></span> bind_commute_spmf<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P2_sec_OT_14_split<span class="main">:</span> <span class="quoted"><span class="quoted">"R2_14 <span class="main">(</span><span class="free">m0</span><span class="main">,</span><span class="free">m1</span><span class="main">,</span><span class="free">m2</span><span class="main">,</span><span class="free">m3</span><span class="main">)</span> <span class="main">(</span><span class="free">c0</span><span class="main">,</span><span class="free">c1</span><span class="main">)</span> <span class="main">=</span> funct_OT_14 <span class="main">(</span><span class="free">m0</span><span class="main">,</span><span class="free">m1</span><span class="main">,</span><span class="free">m2</span><span class="main">,</span><span class="free">m3</span><span class="main">)</span> <span class="main">(</span><span class="free">c0</span><span class="main">,</span><span class="free">c1</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">out1</span><span class="main">,</span> <span class="bound">out2</span><span class="main">)</span><span class="main">.</span> S2_14 <span class="main">(</span><span class="free">c0</span><span class="main">,</span><span class="free">c1</span><span class="main">)</span> <span class="bound">out2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c0</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">c1</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P2_OT_14_FF P2_OT_14_TF P2_OT_14_FT P2_OT_14_TT<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> P2_sec_OT_14<span class="main">:</span> <span class="quoted"><span class="quoted">"R2_14 <span class="free">M</span> <span class="free">C</span> <span class="main">=</span> funct_OT_14 <span class="free">M</span> <span class="free">C</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">out1</span><span class="main">,</span> <span class="bound">out2</span><span class="main">)</span><span class="main">.</span> S2_14 <span class="free">C</span> <span class="bound">out2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> P2_sec_OT_14_split surj_pair<span class="main">)</span> 

<span class="keyword1"><span class="command">sublocale</span></span> OT_14<span class="main">:</span> sim_det_def <span class="quoted">R1_14</span> <span class="quoted">S1_14</span> <span class="quoted">R2_14</span> <span class="quoted">S2_14</span> <span class="quoted">funct_OT_14</span> <span class="quoted">protocol_14_OT</span>
  <span class="keyword1"><span class="command">unfolding</span></span> sim_det_def_def 
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lossless_R1_14 lossless_S1_14 lossless_funct_14_OT lossless_R2_14 lossless_S2_14 <span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> correctness_OT_14<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"funct_OT_14 <span class="free">M</span> <span class="free">C</span> <span class="main">=</span> protocol_14_OT <span class="free">M</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S1</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">S5</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">S1</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">S5</span> <span class="main">=</span> <span class="skolem">d</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">d</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">S1</span> <span class="skolem">S5</span> <span class="skolem">d</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="free">C</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"snd <span class="free">C</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> funct_OT_14_def protocol_14_OT_def correct funct_OT_12_def lossless_funct_OT_12 bind_spmf_const split_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> OT_14_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"OT_14.correctness <span class="free">M</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> OT_14.correctness_def 
  <span class="keyword1"><span class="command">using</span></span> correctness_OT_14 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> OT_14_P2_sec<span class="main">:</span> <span class="quoted"><span class="quoted">"OT_14.perfect_sec_P2 <span class="free">m1</span> <span class="free">m2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> OT_14.perfect_sec_P2_def
  <span class="keyword1"><span class="command">using</span></span> P2_sec_OT_14 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> OT_14_P1_sec<span class="main">:</span> <span class="quoted"><span class="quoted">"OT_14.adv_P1 <span class="free">m1</span> <span class="free">m2</span> <span class="free">D</span> <span class="main">‚â§</span> <span class="numeral">3</span> <span class="main">*</span> <span class="free">adv_OT12</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> OT_14.adv_P1_def  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> reduction_P1 surj_pair<span class="main">)</span> 

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> OT_14_asymp <span class="main">=</span> sim_det_def <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S1_OT12</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">‚áí</span> <span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span> <span class="main">‚áí</span> unit <span class="main">‚áí</span> <span class="tfree">'v_OT121</span> spmf"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">R1_OT12</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">‚áí</span> <span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span> <span class="main">‚áí</span> bool <span class="main">‚áí</span> <span class="tfree">'v_OT121</span> spmf"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">adv_OT12</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">‚áí</span> real"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">S2_OT12</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">‚áí</span> bool <span class="main">‚áí</span> bool <span class="main">‚áí</span> <span class="tfree">'v_OT122</span> spmf"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">R2_OT12</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">‚áí</span> <span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span> <span class="main">‚áí</span> bool <span class="main">‚áí</span> <span class="tfree">'v_OT122</span> spmf"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">protocol_OT12</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span> <span class="main">‚áí</span> bool <span class="main">‚áí</span> <span class="main">(</span>unit <span class="main">√ó</span> bool<span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ot14_base<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">‚ãÄ</span> <span class="main">(</span><span class="bound">n</span><span class="main">::</span>nat<span class="main">)</span><span class="main">.</span> ot14_base <span class="main">(</span><span class="free">S1_OT12</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="free">R1_12_0T</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="free">adv_OT12</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="free">S2_OT12</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="free">R2_12OT</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="free">protocol_OT12</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="keyword1"><span class="command">sublocale</span></span> ot14_base <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">S1_OT12</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">R1_12_0T</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">adv_OT12</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">S2_OT12</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">R2_12OT</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> local.ot14_base <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> OT_14_P1_sec<span class="main">:</span> <span class="quoted"><span class="quoted">"OT_14.adv_P1 <span class="main">(</span><span class="free">R1_12_0T</span> <span class="free">n</span><span class="main">)</span> <span class="free">n</span> <span class="free">m1</span> <span class="free">m2</span> <span class="free">D</span> <span class="main">‚â§</span> <span class="numeral">3</span> <span class="main">*</span> <span class="main">(</span><span class="free">adv_OT12</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> OT_14.adv_P1_def <span class="keyword1"><span class="command">using</span></span> reduction_P1 surj_pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">theorem</span></span> OT_14_P1_asym_sec<span class="main">:</span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">Œª</span> <span class="bound">n</span><span class="main">.</span> OT_14.adv_P1 <span class="main">(</span><span class="free">R1_12_0T</span> <span class="bound">n</span><span class="main">)</span> <span class="bound">n</span> <span class="free">m1</span> <span class="free">m2</span> <span class="free">D</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">Œª</span> <span class="bound">n</span><span class="main">.</span> <span class="free">adv_OT12</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> adv_neg<span class="main">:</span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">Œª</span><span class="bound">n</span><span class="main">.</span> <span class="numeral">3</span> <span class="main">*</span> <span class="free">adv_OT12</span> <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that negligible_cmultI <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬¶</span>OT_14.adv_P1 <span class="main">(</span><span class="free">R1_12_0T</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">n</span> <span class="free">m1</span> <span class="free">m2</span> <span class="free">D</span><span class="main">¬¶</span> <span class="main">‚â§</span> <span class="main">¬¶</span><span class="numeral">3</span> <span class="main">*</span> <span class="main">(</span><span class="free">adv_OT12</span> <span class="skolem">n</span><span class="main">)</span><span class="main">¬¶</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬¶</span>OT_14.adv_P1 <span class="main">(</span><span class="free">R1_12_0T</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">n</span> <span class="free">m1</span> <span class="free">m2</span> <span class="free">D</span><span class="main">¬¶</span> <span class="main">‚â§</span> <span class="numeral">3</span> <span class="main">*</span> <span class="free">adv_OT12</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> OT_14.adv_P1_def OT_14_P1_sec <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> abs_ge_self order_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> OT_14_P1_sec negligible_le adv_neg 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> negligible_absI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> OT_14_P2_asym_sec<span class="main">:</span> <span class="quoted"><span class="quoted">"OT_14.perfect_sec_P2 <span class="free">R2_OT12</span> <span class="free">n</span> <span class="free">m1</span> <span class="free">m2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> OT_14_P2_sec <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


</pre>
</div><div id="GMW">
<div class="head">
<h1>Theory GMW</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚Äπ1-out-of-4 OT to GMW‚Ä∫</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‚ÄπWe prove security for the gates of the GMW protocol in the semi honest model. We assume security on
1-out-of-4 OT.‚Ä∫</span></span>

<span class="keyword1"><span class="command">theory</span></span> GMW <span class="keyword2"><span class="keyword">imports</span></span>
  <a href="OT14.html">OT14</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> share_1 <span class="main">=</span> <span class="quoted">bool</span> 
<span class="keyword1"><span class="command">type_synonym</span></span> share_2 <span class="main">=</span> <span class="quoted">bool</span>

<span class="keyword1"><span class="command">type_synonym</span></span> shares_1 <span class="main">=</span> <span class="quoted"><span class="quoted">"bool list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> shares_2 <span class="main">=</span> <span class="quoted"><span class="quoted">"bool list"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> msgs_14_OT <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool <span class="main">√ó</span> bool <span class="main">√ó</span> bool <span class="main">√ó</span> bool<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> choice_14_OT <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> share_wire <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>share_1 <span class="main">√ó</span> share_2<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> gmw_base <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S1_14_OT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msgs_14_OT <span class="main">‚áí</span> unit <span class="main">‚áí</span> <span class="tfree">'v_14_OT1</span> spmf"</span></span> <span class="comment1">‚Äï ‚Äπsimulated view for party 1 of OT14‚Ä∫</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">R1_14_OT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msgs_14_OT <span class="main">‚áí</span> choice_14_OT <span class="main">‚áí</span> <span class="tfree">'v_14_OT1</span> spmf"</span></span> <span class="comment1">‚Äï ‚Äπreal view for party 1 of OT14‚Ä∫</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">S2_14_OT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"choice_14_OT <span class="main">‚áí</span> bool <span class="main">‚áí</span> <span class="tfree">'v_14_OT2</span> spmf"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">R2_14_OT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msgs_14_OT <span class="main">‚áí</span> choice_14_OT <span class="main">‚áí</span> <span class="tfree">'v_14_OT2</span> spmf"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">protocol_14_OT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msgs_14_OT <span class="main">‚áí</span> choice_14_OT <span class="main">‚áí</span> <span class="main">(</span>unit <span class="main">√ó</span> bool<span class="main">)</span> spmf"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">adv_14_OT</span> <span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> P1_OT_14_adv_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"sim_det_def.adv_P1 <span class="free">R1_14_OT</span> <span class="free">S1_14_OT</span> <span class="free">funct_14_OT</span> <span class="free">M</span> <span class="free">C</span> <span class="free">D</span> <span class="main">‚â§</span> <span class="free">adv_14_OT</span>"</span></span> <span class="comment1">‚Äï ‚Äπbound the advantage of party 1 in the 1-out-of-4 OT‚Ä∫</span>
    <span class="keyword2"><span class="keyword">and</span></span> P2_OT_12_inf_theoretic<span class="main">:</span> <span class="quoted"><span class="quoted">"sim_det_def.perfect_sec_P2 <span class="free">R2_14_OT</span> <span class="free">S2_14_OT</span> <span class="free">funct_14_OT</span> <span class="free">M</span> <span class="free">C</span>"</span></span> <span class="comment1">‚Äï ‚Äπinformation theoretic security for party 2 in the 1-out-of-4 OT‚Ä∫</span>
    <span class="keyword2"><span class="keyword">and</span></span> correct_14<span class="main">:</span> <span class="quoted"><span class="quoted">"funct_OT_14 <span class="free">msgs</span> <span class="free">C</span> <span class="main">=</span> <span class="free">protocol_14_OT</span> <span class="free">msgs</span> <span class="free">C</span>"</span></span> <span class="comment1">‚Äï ‚Äπcorrectness of the 1-out-of-4 OT‚Ä∫</span>
    <span class="keyword2"><span class="keyword">and</span></span> lossless_R1_14_OT<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span><span class="free">R1_14_OT</span> <span class="main">(</span><span class="free">m1</span><span class="main">,</span><span class="free">m2</span><span class="main">,</span><span class="free">m3</span><span class="main">,</span><span class="free">m4</span><span class="main">)</span> <span class="main">(</span><span class="free">c0</span><span class="main">,</span><span class="free">c1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> lossless_R2_14_OT<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span><span class="free">R2_14_OT</span> <span class="main">(</span><span class="free">m1</span><span class="main">,</span><span class="free">m2</span><span class="main">,</span><span class="free">m3</span><span class="main">,</span><span class="free">m4</span><span class="main">)</span> <span class="main">(</span><span class="free">c0</span><span class="main">,</span><span class="free">c1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> lossless_S1_14_OT<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span><span class="free">S1_14_OT</span> <span class="main">(</span><span class="free">m1</span><span class="main">,</span><span class="free">m2</span><span class="main">,</span><span class="free">m3</span><span class="main">,</span><span class="free">m4</span><span class="main">)</span> <span class="main">()</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> lossless_S2_14_OT<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span><span class="free">S2_14_OT</span> <span class="main">(</span><span class="free">c0</span><span class="main">,</span><span class="free">c1</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> lossless_protocol_14_OT<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span><span class="free">protocol_14_OT</span> <span class="free">S</span> <span class="free">C</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> lossless_funct_14_OT<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span><span class="free">funct_14_OT</span> <span class="free">M</span> <span class="free">C</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span>  funct_14<span class="main">:</span> <span class="quoted"><span class="quoted">"funct_OT_14 <span class="main">(</span><span class="free">m00</span><span class="main">,</span><span class="free">m01</span><span class="main">,</span><span class="free">m10</span><span class="main">,</span><span class="free">m11</span><span class="main">)</span> <span class="main">(</span><span class="free">c0</span><span class="main">,</span><span class="free">c1</span><span class="main">)</span> 
                      <span class="main">=</span> return_spmf <span class="main">(</span><span class="main">()</span><span class="main">,</span><span class="keyword1">if</span> <span class="free">c0</span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">c1</span> <span class="keyword1">then</span> <span class="free">m11</span> <span class="keyword1">else</span> <span class="free">m10</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">c1</span> <span class="keyword1">then</span> <span class="free">m01</span> <span class="keyword1">else</span> <span class="free">m00</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> funct_OT_14_def<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> OT_14_sim<span class="main">:</span> sim_det_def <span class="quoted"><span class="free">R1_14_OT</span></span> <span class="quoted"><span class="free">S1_14_OT</span></span> <span class="quoted"><span class="free">R2_14_OT</span></span> <span class="quoted"><span class="free">S2_14_OT</span></span> <span class="quoted"><span class="free">funct_14_OT</span></span> <span class="quoted"><span class="free">protocol_14_OT</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sim_det_def_def 
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lossless_R1_14_OT lossless_S1_14_OT lossless_funct_14_OT lossless_R2_14_OT lossless_S2_14_OT<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inf_th_14_OT_P4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R2_14_OT</span> <span class="free">msgs</span> <span class="free">C</span> <span class="main">=</span> <span class="main">(</span>funct_OT_14 <span class="free">msgs</span> <span class="free">C</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">s1</span><span class="main">,</span> <span class="bound">s2</span><span class="main">)</span><span class="main">.</span> <span class="free">S2_14_OT</span> <span class="free">C</span> <span class="bound">s2</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> P2_OT_12_inf_theoretic sim_det_def.perfect_sec_P2_def OT_14_sim.perfect_sec_P2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ass_adv_14_OT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬¶</span>spmf <span class="main">(</span>bind_spmf <span class="main">(</span><span class="free">S1_14_OT</span> <span class="free">msgs</span> <span class="main">()</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="bound">view</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True <span class="main">-</span> 
                    spmf <span class="main">(</span>bind_spmf <span class="main">(</span><span class="free">R1_14_OT</span> <span class="free">msgs</span> <span class="main">(</span><span class="free">c0</span><span class="main">,</span><span class="free">c1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="bound">view</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True <span class="main">¬¶</span> <span class="main">‚â§</span> <span class="free">adv_14_OT</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">‚â§</span> <span class="free">adv_14_OT</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"funct_OT_14 <span class="main">(</span><span class="skolem">m0</span><span class="main">,</span><span class="skolem">m1</span><span class="main">,</span><span class="skolem">m2</span><span class="main">,</span><span class="skolem">m3</span><span class="main">)</span> <span class="main">(</span><span class="free">c0</span><span class="main">,</span> <span class="free">c1</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">o1</span><span class="main">,</span> <span class="bound">o2</span><span class="main">)</span><span class="main">.</span> <span class="free">S1_14_OT</span> <span class="main">(</span><span class="skolem">m0</span><span class="main">,</span><span class="skolem">m1</span><span class="main">,</span><span class="skolem">m2</span><span class="main">,</span><span class="skolem">m3</span><span class="main">)</span> <span class="main">()</span> <span class="main">‚§ú</span> <span class="free">D</span><span class="main">)</span> <span class="main">=</span> <span class="free">S1_14_OT</span> <span class="main">(</span><span class="skolem">m0</span><span class="main">,</span><span class="skolem">m1</span><span class="main">,</span><span class="skolem">m2</span><span class="main">,</span><span class="skolem">m3</span><span class="main">)</span> <span class="main">()</span> <span class="main">‚§ú</span> <span class="free">D</span>"</span></span> 
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">m0</span> <span class="skolem">m1</span> <span class="skolem">m2</span> <span class="skolem">m3</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> funct_14<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> funct<span class="main">:</span> <span class="quoted"><span class="quoted">"funct_OT_14 <span class="free">msgs</span> <span class="main">(</span><span class="free">c0</span><span class="main">,</span> <span class="free">c1</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">o1</span><span class="main">,</span> <span class="bound">o2</span><span class="main">)</span><span class="main">.</span> <span class="free">S1_14_OT</span> <span class="free">msgs</span> <span class="main">()</span> <span class="main">‚§ú</span> <span class="free">D</span><span class="main">)</span> <span class="main">=</span> <span class="free">S1_14_OT</span> <span class="free">msgs</span> <span class="main">()</span> <span class="main">‚§ú</span> <span class="free">D</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod_cases4<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="main">¬¶</span>spmf <span class="main">(</span>bind_spmf <span class="main">(</span><span class="free">R1_14_OT</span> <span class="free">msgs</span> <span class="main">(</span><span class="free">c0</span><span class="main">,</span><span class="free">c1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="bound">view</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True 
                  <span class="main">-</span> spmf <span class="main">(</span>bind_spmf <span class="main">(</span><span class="free">S1_14_OT</span> <span class="free">msgs</span> <span class="main">()</span><span class="main">)</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="bound">view</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">¬¶</span><span class="main">(</span>spmf <span class="main">(</span><span class="free">R1_14_OT</span> <span class="free">msgs</span> <span class="main">(</span><span class="free">c0</span><span class="main">,</span><span class="free">c1</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="free">D</span> <span class="bound">view</span><span class="main">)</span><span class="main">)</span> True<span class="main">)</span> 
            <span class="main">-</span> spmf <span class="main">(</span>funct_OT_14 <span class="free">msgs</span> <span class="main">(</span><span class="free">c0</span><span class="main">,</span><span class="free">c1</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">o1</span><span class="main">,</span> <span class="bound">o2</span><span class="main">)</span><span class="main">.</span> <span class="free">S1_14_OT</span> <span class="free">msgs</span> <span class="bound">o1</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="free">D</span> <span class="bound">view</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> funct<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> P1_OT_14_adv_bound sim_det_def.adv_P1_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> OT_14_sim.adv_P1_def abs_minus_commute<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπThe sharing scheme‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">share</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">‚áí</span> share_wire spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">share</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">a<span class="hidden">‚á©</span><sub>1</sub></span> <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">b<span class="hidden">‚á©</span><sub>1</sub></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">‚äï</span> <span class="bound">a<span class="hidden">‚á©</span><sub>1</sub></span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="bound">a<span class="hidden">‚á©</span><sub>1</sub></span><span class="main">,</span> <span class="bound">b<span class="hidden">‚á©</span><sub>1</sub></span><span class="main">)</span><span class="main">}</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> lossless_share <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span>share <span class="free">x</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> share_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">reconstruct</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>share_1 <span class="main">√ó</span> share_2<span class="main">)</span> <span class="main">‚áí</span> bool spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">reconstruct</span> <span class="free"><span class="bound"><span class="entity">shares</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">shares</span></span></span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="bound">a</span> <span class="main">‚äï</span> <span class="bound">b</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lossless_reconstruct <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span>reconstruct <span class="free">s</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reconstruct_def split_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> reconstruct_share <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bind_spmf <span class="main">(</span>share <span class="free">x</span><span class="main">)</span> reconstruct<span class="main">)</span> <span class="main">=</span> <span class="main">(</span>return_spmf <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">=</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> share_def reconstruct_def bind_spmf_const eq_commute<span class="main">)</span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>reconstruct <span class="main">(</span><span class="free">s1</span><span class="main">,</span><span class="free">s2</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">rec</span><span class="main">.</span> share <span class="bound">rec</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">shares</span><span class="main">.</span> reconstruct <span class="bound">shares</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> return_spmf <span class="main">(</span><span class="free">s1</span> <span class="main">‚äï</span> <span class="free">s2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reconstruct_share reconstruct_def share_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s1</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">s2</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_spmf_const<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">xor_evaluate</span> <span class="main">::</span>  <span class="quoted"><span class="quoted">"bool <span class="main">‚áí</span> bool <span class="main">‚áí</span> bool spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">xor_evaluate</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> return_spmf <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">‚äï</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">xor_funct</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"share_wire <span class="main">‚áí</span> share_wire <span class="main">‚áí</span> <span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">xor_funct</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">a1</span><span class="main">,</span> <span class="bound">b1</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">a2</span><span class="main">,</span><span class="bound">b2</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="bound">a1</span> <span class="main">‚äï</span> <span class="bound">a2</span><span class="main">,</span> <span class="bound">b1</span> <span class="main">‚äï</span> <span class="bound">b2</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lossless_xor_funct<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span>xor_funct <span class="free">A</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> xor_funct_def split_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">xor_protocol</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"share_wire <span class="main">‚áí</span> share_wire <span class="main">‚áí</span> <span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">xor_protocol</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">a1</span><span class="main">,</span> <span class="bound">b1</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">a2</span><span class="main">,</span><span class="bound">b2</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="bound">a1</span> <span class="main">‚äï</span> <span class="bound">a2</span><span class="main">,</span> <span class="bound">b1</span> <span class="main">‚äï</span> <span class="bound">b2</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lossless_xor_protocol<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span>xor_protocol <span class="free">A</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> xor_protocol_def split_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> share_xor_reconstruct<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"share <span class="free">x</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">w1</span><span class="main">.</span> share <span class="free">y</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">w2</span><span class="main">.</span> xor_protocol <span class="bound">w1</span> <span class="bound">w2</span> 
              <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> reconstruct <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> xor_evaluate <span class="free">x</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ya</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬¨</span> <span class="skolem">yb</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬¨</span> <span class="skolem">ya</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬¨</span> <span class="skolem">yb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬¨</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ya</span> <span class="skolem">yb</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> share_def xor_protocol_def reconstruct_def xor_evaluate_def bind_spmf_const<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">R1_xor</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">R1_xor</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> return_spmf <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lossless_R1_xor<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span>R1_xor <span class="free">A</span> <span class="free">B</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R1_xor_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">S1_xor</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span> <span class="main">‚áí</span> bool <span class="main">‚áí</span> <span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">S1_xor</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">out</span></span></span>  <span class="main">=</span> return_spmf <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lossless_S1_xor<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span>S1_xor <span class="free">A</span> <span class="free">out</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S1_xor_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> P1_xor_inf_th<span class="main">:</span> <span class="quoted"><span class="quoted">"R1_xor <span class="free">A</span> <span class="free">B</span> <span class="main">=</span> xor_funct <span class="free">A</span> <span class="free">B</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">out1</span><span class="main">,</span> <span class="bound">out2</span><span class="main">)</span><span class="main">.</span> S1_xor <span class="free">A</span> <span class="bound">out1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R1_xor_def xor_funct_def S1_xor_def split_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">R2_xor</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">R2_xor</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> return_spmf <span class="free"><span class="bound"><span class="entity">B</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lossless_R2_xor<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span>R2_xor <span class="free">A</span> <span class="free">B</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R2_xor_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">S2_xor</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span> <span class="main">‚áí</span> bool <span class="main">‚áí</span> <span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">S2_xor</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">out</span></span></span>  <span class="main">=</span> return_spmf <span class="free"><span class="bound"><span class="entity">B</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lossless_S2_xor<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span>S2_xor <span class="free">A</span> <span class="free">out</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S2_xor_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> P2_xor_inf_th<span class="main">:</span> <span class="quoted"><span class="quoted">"R2_xor <span class="free">A</span> <span class="free">B</span> <span class="main">=</span> xor_funct <span class="free">A</span> <span class="free">B</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">out1</span><span class="main">,</span> <span class="bound">out2</span><span class="main">)</span><span class="main">.</span> S2_xor <span class="free">B</span> <span class="bound">out2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R2_xor_def xor_funct_def S2_xor_def split_def<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> xor_sim_det<span class="main">:</span> sim_det_def  <span class="quoted">R1_xor</span> <span class="quoted">S1_xor</span> <span class="quoted">R2_xor</span> <span class="quoted">S2_xor</span> <span class="quoted">xor_funct</span> <span class="quoted">xor_protocol</span> 
  <span class="keyword1"><span class="command">unfolding</span></span> sim_det_def_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lossless_R1_xor lossless_S1_xor lossless_R2_xor lossless_S2_xor lossless_xor_funct<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"xor_sim_det.perfect_sec_P1 <span class="free">m1</span> <span class="free">m2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> xor_sim_det.perfect_sec_P1_def P1_xor_inf_th<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"xor_sim_det.perfect_sec_P2 <span class="free">m1</span> <span class="free">m2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> xor_sim_det.perfect_sec_P2_def P2_xor_inf_th<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">and_funct</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>share_1 <span class="main">√ó</span> share_2<span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span>share_1 <span class="main">√ó</span> share_2<span class="main">)</span> <span class="main">‚áí</span> share_wire spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">and_funct</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">a1</span><span class="main">,</span> <span class="bound">a2</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">b1</span><span class="main">,</span><span class="bound">b2</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">;</span>
    <span class="bound">œÉ</span> <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    return_spmf <span class="main">(</span><span class="bound">œÉ</span><span class="main">,</span> <span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="bound">a1</span> <span class="main">‚äï</span> <span class="bound">b1</span><span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="bound">a2</span> <span class="main">‚äï</span> <span class="bound">b2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lossless_and_funct<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span>and_funct <span class="free">A</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> and_funct_def split_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">and_evaluate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">‚áí</span> bool <span class="main">‚áí</span> bool spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">and_evaluate</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span>  <span class="main">=</span> return_spmf <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">‚àß</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">and_protocol</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"share_wire <span class="main">‚áí</span> share_wire <span class="main">‚áí</span> share_wire spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">and_protocol</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">a1</span><span class="main">,</span> <span class="bound">b1</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">a2</span><span class="main">,</span><span class="bound">b2</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">;</span>
    <span class="bound">œÉ</span> <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">s0</span> <span class="main">=</span> <span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="bound">a1</span> <span class="main">‚äï</span> False<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="bound">b1</span> <span class="main">‚äï</span> False<span class="main">)</span><span class="main">)</span><span class="main">;</span>   
    <span class="keyword1">let</span> <span class="bound">s1</span> <span class="main">=</span> <span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="bound">a1</span> <span class="main">‚äï</span> False<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="bound">b1</span> <span class="main">‚äï</span> True<span class="main">)</span><span class="main">)</span><span class="main">;</span>   
    <span class="keyword1">let</span> <span class="bound">s2</span> <span class="main">=</span> <span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="bound">a1</span> <span class="main">‚äï</span> True<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="bound">b1</span> <span class="main">‚äï</span> False<span class="main">)</span><span class="main">)</span><span class="main">;</span>   
    <span class="keyword1">let</span> <span class="bound">s3</span> <span class="main">=</span> <span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="bound">a1</span> <span class="main">‚äï</span> True<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="bound">b1</span> <span class="main">‚äï</span> True<span class="main">)</span><span class="main">)</span><span class="main">;</span> 
    <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="free">protocol_14_OT</span> <span class="main">(</span><span class="bound">s0</span><span class="main">,</span><span class="bound">s1</span><span class="main">,</span><span class="bound">s2</span><span class="main">,</span><span class="bound">s3</span><span class="main">)</span> <span class="main">(</span><span class="bound">a2</span><span class="main">,</span><span class="bound">b2</span><span class="main">)</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="bound">œÉ</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">}</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> lossless_and_protocol<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span>and_protocol <span class="free">A</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> and_protocol_def split_def lossless_protocol_14_OT<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> and_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"and_protocol <span class="main">(</span><span class="free">a1</span><span class="main">,</span> <span class="free">b1</span><span class="main">)</span> <span class="main">(</span><span class="free">a2</span><span class="main">,</span><span class="free">b2</span><span class="main">)</span> <span class="main">=</span> and_funct <span class="main">(</span><span class="free">a1</span><span class="main">,</span> <span class="free">b1</span><span class="main">)</span> <span class="main">(</span><span class="free">a2</span><span class="main">,</span><span class="free">b2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> and_protocol_def and_funct_def correct_14<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> funct_14<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">b2</span></span> <span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">b1</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">a1</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">a2</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> share_and_reconstruct<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"share <span class="free">x</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">a1</span><span class="main">,</span><span class="bound">a2</span><span class="main">)</span><span class="main">.</span> share <span class="free">y</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">b1</span><span class="main">,</span><span class="bound">b2</span><span class="main">)</span><span class="main">.</span>
             and_protocol <span class="main">(</span><span class="bound">a1</span><span class="main">,</span><span class="bound">b1</span><span class="main">)</span> <span class="main">(</span><span class="bound">a2</span><span class="main">,</span><span class="bound">b2</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> reconstruct <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> and_evaluate <span class="free">x</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">yc</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬¨</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬¨</span> <span class="skolem">ya</span><span class="main">)</span> <span class="keyword1">then</span> <span class="keyword1">if</span> snd <span class="main">(</span>snd <span class="main">(</span><span class="skolem">ya</span><span class="main">,</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬¨</span> <span class="skolem">ya</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> snd <span class="main">(</span><span class="skolem">yb</span><span class="main">,</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬¨</span> <span class="skolem">yb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> <span class="skolem">yc</span> 
            <span class="main">=</span> <span class="main">(</span>fst <span class="main">(</span>fst <span class="main">(</span><span class="skolem">ya</span><span class="main">,</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬¨</span> <span class="skolem">ya</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> fst <span class="main">(</span><span class="skolem">yb</span><span class="main">,</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬¨</span> <span class="skolem">yb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">‚à®</span> snd <span class="main">(</span>fst <span class="main">(</span><span class="skolem">ya</span><span class="main">,</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬¨</span> <span class="skolem">ya</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> fst <span class="main">(</span><span class="skolem">yb</span><span class="main">,</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬¨</span> <span class="skolem">yb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                   <span class="keyword1">else</span> <span class="skolem">yc</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">(</span>fst <span class="main">(</span><span class="skolem">ya</span><span class="main">,</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬¨</span> <span class="skolem">ya</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> fst <span class="main">(</span><span class="skolem">yb</span><span class="main">,</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬¨</span> <span class="skolem">yb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">‚à®</span> <span class="main">¬¨</span> snd <span class="main">(</span>fst <span class="main">(</span><span class="skolem">ya</span><span class="main">,</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬¨</span> <span class="skolem">ya</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> fst <span class="main">(</span><span class="skolem">yb</span><span class="main">,</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬¨</span> <span class="skolem">yb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                       <span class="keyword1">else</span> <span class="keyword1">if</span> snd <span class="main">(</span>snd <span class="main">(</span><span class="skolem">ya</span><span class="main">,</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬¨</span> <span class="skolem">ya</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> snd <span class="main">(</span><span class="skolem">yb</span><span class="main">,</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬¨</span> <span class="skolem">yb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> <span class="skolem">yc</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">(</span>fst <span class="main">(</span><span class="skolem">ya</span><span class="main">,</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬¨</span> <span class="skolem">ya</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> fst <span class="main">(</span><span class="skolem">yb</span><span class="main">,</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬¨</span> <span class="skolem">yb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
                            <span class="main">‚ü∂</span> snd <span class="main">(</span>fst <span class="main">(</span><span class="skolem">ya</span><span class="main">,</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬¨</span> <span class="skolem">ya</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> fst <span class="main">(</span><span class="skolem">yb</span><span class="main">,</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬¨</span> <span class="skolem">yb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                                  <span class="keyword1">else</span> <span class="skolem">yc</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">(</span>fst <span class="main">(</span><span class="skolem">ya</span><span class="main">,</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬¨</span> <span class="skolem">ya</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> fst <span class="main">(</span><span class="skolem">yb</span><span class="main">,</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬¨</span> <span class="skolem">yb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
                                      <span class="main">‚ü∂</span> <span class="main">¬¨</span> snd <span class="main">(</span>fst <span class="main">(</span><span class="skolem">ya</span><span class="main">,</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬¨</span> <span class="skolem">ya</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> fst <span class="main">(</span><span class="skolem">yb</span><span class="main">,</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬¨</span> <span class="skolem">yb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">‚àß</span> <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">yc</span> <span class="skolem">yb</span> <span class="skolem">ya</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> share_def reconstruct_def and_protocol_def and_evaluate_def split_def correct_14<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> funct_14 bind_spmf_const Let_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">and_R1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>share_1 <span class="main">√ó</span> share_1<span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span>share_2 <span class="main">√ó</span> share_2<span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>share_1 <span class="main">√ó</span> share_1<span class="main">)</span> <span class="main">√ó</span> bool <span class="main">√ó</span> <span class="tfree">'v_14_OT1</span><span class="main">)</span>  <span class="main">√ó</span> <span class="main">(</span>share_1 <span class="main">√ó</span> share_2<span class="main">)</span><span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">and_R1</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">a1</span><span class="main">,</span> <span class="bound">a2</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">b1</span><span class="main">,</span><span class="bound">b2</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">;</span>
    <span class="bound">œÉ</span> <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">s0</span> <span class="main">=</span> <span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="bound">a1</span> <span class="main">‚äï</span> False<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="bound">a2</span> <span class="main">‚äï</span> False<span class="main">)</span><span class="main">)</span><span class="main">;</span>   
    <span class="keyword1">let</span> <span class="bound">s1</span> <span class="main">=</span> <span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="bound">a1</span> <span class="main">‚äï</span> False<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="bound">a2</span> <span class="main">‚äï</span> True<span class="main">)</span><span class="main">)</span><span class="main">;</span>   
    <span class="keyword1">let</span> <span class="bound">s2</span> <span class="main">=</span> <span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="bound">a1</span> <span class="main">‚äï</span> True<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="bound">a2</span> <span class="main">‚äï</span> False<span class="main">)</span><span class="main">)</span><span class="main">;</span>   
    <span class="keyword1">let</span> <span class="bound">s3</span> <span class="main">=</span> <span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="bound">a1</span> <span class="main">‚äï</span> True<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="bound">a2</span> <span class="main">‚äï</span> True<span class="main">)</span><span class="main">)</span><span class="main">;</span> 
    <span class="bound">V</span> <span class="main">‚Üê</span> <span class="free">R1_14_OT</span> <span class="main">(</span><span class="bound">s0</span><span class="main">,</span><span class="bound">s1</span><span class="main">,</span><span class="bound">s2</span><span class="main">,</span><span class="bound">s3</span><span class="main">)</span> <span class="main">(</span><span class="bound">b1</span><span class="main">,</span><span class="bound">b2</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="free">protocol_14_OT</span> <span class="main">(</span><span class="bound">s0</span><span class="main">,</span><span class="bound">s1</span><span class="main">,</span><span class="bound">s2</span><span class="main">,</span><span class="bound">s3</span><span class="main">)</span> <span class="main">(</span><span class="bound">b1</span><span class="main">,</span><span class="bound">b2</span><span class="main">)</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">a1</span><span class="main">,</span><span class="bound">a2</span><span class="main">)</span><span class="main">,</span> <span class="bound">œÉ</span><span class="main">,</span> <span class="bound">V</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">œÉ</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lossless_and_R1<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span>and_R1 <span class="free">A</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> and_R1_def split_def lossless_R1_14_OT lossless_protocol_14_OT Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.collapse lossless_R1_14_OT<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">S1_and</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>share_1 <span class="main">√ó</span> share_1<span class="main">)</span> <span class="main">‚áí</span> bool <span class="main">‚áí</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span> <span class="main">√ó</span> bool <span class="main">√ó</span> <span class="tfree">'v_14_OT1</span><span class="main">)</span><span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">S1_and</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">a1</span><span class="main">,</span><span class="bound">a2</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">s0</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="bound">a1</span> <span class="main">‚äï</span> False<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="bound">a2</span> <span class="main">‚äï</span> False<span class="main">)</span><span class="main">)</span><span class="main">;</span>   
    <span class="keyword1">let</span> <span class="bound">s1</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="bound">a1</span> <span class="main">‚äï</span> False<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="bound">a2</span> <span class="main">‚äï</span> True<span class="main">)</span><span class="main">)</span><span class="main">;</span>   
    <span class="keyword1">let</span> <span class="bound">s2</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="bound">a1</span> <span class="main">‚äï</span> True<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="bound">a2</span> <span class="main">‚äï</span> False<span class="main">)</span><span class="main">)</span><span class="main">;</span>   
    <span class="keyword1">let</span> <span class="bound">s3</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="bound">a1</span> <span class="main">‚äï</span> True<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="bound">a2</span> <span class="main">‚äï</span> True<span class="main">)</span><span class="main">)</span><span class="main">;</span> 
    <span class="bound">V</span> <span class="main">‚Üê</span> <span class="free">S1_14_OT</span> <span class="main">(</span><span class="bound">s0</span><span class="main">,</span><span class="bound">s1</span><span class="main">,</span><span class="bound">s2</span><span class="main">,</span><span class="bound">s3</span><span class="main">)</span> <span class="main">()</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">(</span><span class="bound">a1</span><span class="main">,</span><span class="bound">a2</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span><span class="main">,</span> <span class="bound">V</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">out1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>share_1 <span class="main">√ó</span> share_1<span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span>share_2 <span class="main">√ó</span> share_2<span class="main">)</span> <span class="main">‚áí</span> bool <span class="main">‚áí</span> <span class="main">(</span>share_1 <span class="main">√ó</span> share_2<span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">out1</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">a1</span><span class="main">,</span><span class="bound">a2</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">b1</span><span class="main">,</span><span class="bound">b2</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="free"><span class="bound"><span class="entity">œÉ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="bound">a1</span> <span class="main">‚äï</span> <span class="bound">b1</span><span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="bound">a2</span> <span class="main">‚äï</span> <span class="bound">b2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">S1_and'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>share_1 <span class="main">√ó</span> share_1<span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span>share_2 <span class="main">√ó</span> share_2<span class="main">)</span> <span class="main">‚áí</span> bool <span class="main">‚áí</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span> <span class="main">√ó</span> bool <span class="main">√ó</span> <span class="tfree">'v_14_OT1</span><span class="main">)</span> <span class="main">√ó</span> <span class="main">(</span>share_1 <span class="main">√ó</span> share_2<span class="main">)</span><span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">S1_and'</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">a1</span><span class="main">,</span><span class="bound">a2</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">b1</span><span class="main">,</span><span class="bound">b2</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">s0</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="bound">a1</span> <span class="main">‚äï</span> False<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="bound">a2</span> <span class="main">‚äï</span> False<span class="main">)</span><span class="main">)</span><span class="main">;</span>   
    <span class="keyword1">let</span> <span class="bound">s1</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="bound">a1</span> <span class="main">‚äï</span> False<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="bound">a2</span> <span class="main">‚äï</span> True<span class="main">)</span><span class="main">)</span><span class="main">;</span>   
    <span class="keyword1">let</span> <span class="bound">s2</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="bound">a1</span> <span class="main">‚äï</span> True<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="bound">a2</span> <span class="main">‚äï</span> False<span class="main">)</span><span class="main">)</span><span class="main">;</span>   
    <span class="keyword1">let</span> <span class="bound">s3</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="bound">a1</span> <span class="main">‚äï</span> True<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="bound">a2</span> <span class="main">‚äï</span> True<span class="main">)</span><span class="main">)</span><span class="main">;</span> 
    <span class="bound">V</span> <span class="main">‚Üê</span> <span class="free">S1_14_OT</span> <span class="main">(</span><span class="bound">s0</span><span class="main">,</span><span class="bound">s1</span><span class="main">,</span><span class="bound">s2</span><span class="main">,</span><span class="bound">s3</span><span class="main">)</span> <span class="main">()</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">a1</span><span class="main">,</span><span class="bound">a2</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span><span class="main">,</span> <span class="bound">V</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">œÉ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="bound">a1</span> <span class="main">‚äï</span> <span class="bound">b1</span><span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="bound">a2</span> <span class="main">‚äï</span> <span class="bound">b2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sec_ex_P1_and<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">‚àÉ</span> <span class="main">(</span><span class="bound">A</span> <span class="main">::</span> <span class="tfree">'v_14_OT1</span> <span class="main">‚áí</span> bool <span class="main">‚áí</span> bool spmf<span class="main">)</span><span class="main">.</span>
          <span class="main">¬¶</span>spmf <span class="main">(</span><span class="main">(</span>and_funct <span class="main">(</span><span class="free">a1</span><span class="main">,</span> <span class="free">a2</span><span class="main">)</span> <span class="main">(</span><span class="free">b1</span><span class="main">,</span><span class="free">b2</span><span class="main">)</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">s1</span><span class="main">,</span> <span class="bound">s2</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>S1_and' <span class="main">(</span><span class="free">a1</span><span class="main">,</span><span class="free">a2</span><span class="main">)</span> <span class="main">(</span><span class="free">b1</span><span class="main">,</span><span class="free">b2</span><span class="main">)</span> <span class="bound">s1</span><span class="main">)</span> 
            <span class="main">‚§ú</span> <span class="main">(</span><span class="free">D</span> <span class="main">::</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span> <span class="main">√ó</span> bool <span class="main">√ó</span> <span class="tfree">'v_14_OT1</span><span class="main">)</span> <span class="main">√ó</span> <span class="main">(</span>share_1 <span class="main">√ó</span> share_2<span class="main">)</span><span class="main">)</span> <span class="main">‚áí</span> bool spmf<span class="main">)</span><span class="main">)</span><span class="main">)</span> True <span class="main">-</span> spmf <span class="main">(</span><span class="main">(</span>and_R1 <span class="main">(</span><span class="free">a1</span><span class="main">,</span> <span class="free">a2</span><span class="main">)</span> <span class="main">(</span><span class="free">b1</span><span class="main">,</span><span class="free">b2</span><span class="main">)</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="free">D</span><span class="main">)</span> True<span class="main">¬¶</span> <span class="main">=</span>
              <span class="main">¬¶</span>spmf <span class="main">(</span>coin_spmf <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">œÉ</span><span class="main">.</span> <span class="free">S1_14_OT</span> <span class="main">(</span><span class="main">(</span><span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> False<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="free">a2</span> <span class="main">‚äï</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> False<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="free">a2</span> <span class="main">‚äï</span> True<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> True<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="free">a2</span> <span class="main">‚äï</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> True<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="free">a2</span> <span class="main">‚äï</span> True<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">()</span> 
                <span class="main">‚§ú</span>  <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="bound">A</span> <span class="bound">view</span> <span class="bound">œÉ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True 
                  <span class="main">-</span> spmf <span class="main">(</span>coin_spmf <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">œÉ</span><span class="main">.</span> <span class="free">R1_14_OT</span> <span class="main">(</span><span class="main">(</span><span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> False<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="free">a2</span> <span class="main">‚äï</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> False<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="free">a2</span> <span class="main">‚äï</span> True<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> True<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="free">a2</span> <span class="main">‚äï</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> True<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="free">a2</span> <span class="main">‚äï</span> True<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">b1</span><span class="main">,</span> <span class="free">b2</span><span class="main">)</span> 
                    <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="bound">A</span> <span class="bound">view</span> <span class="bound">œÉ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span>"</span></span>
  <span class="keyword1"><span class="command">including</span></span> monad_normalisation
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A'</span> <span class="main">==</span> <span class="main">Œª</span> <span class="bound">view</span> <span class="bound">œÉ</span><span class="main">.</span>  <span class="main">(</span><span class="free">D</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">a1</span><span class="main">,</span><span class="free">a2</span><span class="main">)</span><span class="main">,</span> <span class="bound">œÉ</span><span class="main">,</span> <span class="bound">view</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">œÉ</span><span class="main">,</span> <span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> <span class="free">b1</span><span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="free">a2</span> <span class="main">‚äï</span> <span class="free">b2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬¶</span>spmf <span class="main">(</span><span class="main">(</span>and_funct <span class="main">(</span><span class="free">a1</span><span class="main">,</span> <span class="free">a2</span><span class="main">)</span> <span class="main">(</span><span class="free">b1</span><span class="main">,</span><span class="free">b2</span><span class="main">)</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">s1</span><span class="main">,</span> <span class="bound">s2</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>S1_and' <span class="main">(</span><span class="free">a1</span><span class="main">,</span><span class="free">a2</span><span class="main">)</span> <span class="main">(</span><span class="free">b1</span><span class="main">,</span><span class="free">b2</span><span class="main">)</span> <span class="bound">s1</span><span class="main">)</span> 
          <span class="main">‚§ú</span> <span class="main">(</span><span class="free">D</span> <span class="main">::</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span> <span class="main">√ó</span> bool <span class="main">√ó</span> <span class="tfree">'v_14_OT1</span><span class="main">)</span> <span class="main">√ó</span> <span class="main">(</span>share_1 <span class="main">√ó</span> share_2<span class="main">)</span><span class="main">)</span> <span class="main">‚áí</span> bool spmf<span class="main">)</span><span class="main">)</span><span class="main">)</span> True <span class="main">-</span> 
            spmf <span class="main">(</span><span class="main">(</span>and_R1 <span class="main">(</span><span class="free">a1</span><span class="main">,</span> <span class="free">a2</span><span class="main">)</span> <span class="main">(</span><span class="free">b1</span><span class="main">,</span><span class="free">b2</span><span class="main">)</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="free">D</span> <span class="main">::</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span> <span class="main">√ó</span> bool <span class="main">√ó</span> <span class="tfree">'v_14_OT1</span><span class="main">)</span> <span class="main">√ó</span> <span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span><span class="main">)</span> <span class="main">‚áí</span> bool spmf<span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span> <span class="main">=</span>
              <span class="main">¬¶</span>spmf <span class="main">(</span>coin_spmf <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">œÉ</span> <span class="main">::</span> bool<span class="main">.</span> <span class="free">S1_14_OT</span> <span class="main">(</span><span class="main">(</span><span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> False<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="free">a2</span> <span class="main">‚äï</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> False<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="free">a2</span> <span class="main">‚äï</span> True<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> True<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="free">a2</span> <span class="main">‚äï</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> True<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="free">a2</span> <span class="main">‚äï</span> True<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">()</span> 
                <span class="main">‚§ú</span>  <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="skolem">A'</span> <span class="bound">view</span> <span class="bound">œÉ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True <span class="main">-</span> spmf <span class="main">(</span>coin_spmf <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">œÉ</span><span class="main">.</span> <span class="free">R1_14_OT</span> <span class="main">(</span><span class="main">(</span><span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> False<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="free">a2</span> <span class="main">‚äï</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> False<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="free">a2</span> <span class="main">‚äï</span> True<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> True<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="free">a2</span> <span class="main">‚äï</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> True<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="free">a2</span> <span class="main">‚äï</span> True<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">b1</span><span class="main">,</span> <span class="free">b2</span><span class="main">)</span> 
                  <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="skolem">A'</span> <span class="bound">view</span> <span class="bound">œÉ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S1_and'_def A'_def and_funct_def and_R1_def Let_def split_def correct_14<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> funct_14<span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">a1</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">a2</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">b1</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">b2</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bound_14_OT<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬¶</span>spmf <span class="main">(</span>coin_spmf <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">œÉ</span><span class="main">.</span> <span class="free">S1_14_OT</span> <span class="main">(</span><span class="main">(</span><span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> False<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="free">a2</span> <span class="main">‚äï</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> False<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="free">a2</span> <span class="main">‚äï</span> True<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> True<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="free">a2</span> <span class="main">‚äï</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> True<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="free">a2</span> <span class="main">‚äï</span> True<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">()</span> 
        <span class="main">‚§ú</span>  <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="main">::</span> <span class="tfree">'v_14_OT1</span> <span class="main">‚áí</span> bool <span class="main">‚áí</span> bool spmf<span class="main">)</span> <span class="bound">view</span> <span class="bound">œÉ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True <span class="main">-</span> spmf <span class="main">(</span>coin_spmf <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">œÉ</span><span class="main">.</span> <span class="free">R1_14_OT</span> <span class="main">(</span><span class="main">(</span><span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> False<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="free">a2</span> <span class="main">‚äï</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> False<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="free">a2</span> <span class="main">‚äï</span> True<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> True<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="free">a2</span> <span class="main">‚äï</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> True<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="free">a2</span> <span class="main">‚äï</span> True<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">b1</span><span class="main">,</span> <span class="free">b2</span><span class="main">)</span> 
              <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="free">A</span> <span class="bound">view</span> <span class="bound">œÉ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span> <span class="main">‚â§</span> <span class="free">adv_14_OT</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">‚â§</span> <span class="free">adv_14_OT</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> int1<span class="main">:</span> <span class="quoted"><span class="quoted">"integrable <span class="main">(</span>measure_spmf coin_spmf<span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> spmf <span class="main">(</span><span class="free">S1_14_OT</span> <span class="main">(</span><span class="bound">x</span> <span class="main">‚äï</span> <span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> False <span class="main">‚àß</span> <span class="free">a2</span> <span class="main">‚äï</span> False<span class="main">)</span><span class="main">,</span> <span class="bound">x</span> <span class="main">‚äï</span> <span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> False <span class="main">‚àß</span> <span class="free">a2</span> <span class="main">‚äï</span> True<span class="main">)</span><span class="main">,</span> <span class="bound">x</span> <span class="main">‚äï</span> <span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> True <span class="main">‚àß</span> <span class="free">a2</span> <span class="main">‚äï</span> False<span class="main">)</span><span class="main">,</span> <span class="bound">x</span> <span class="main">‚äï</span> <span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> True <span class="main">‚àß</span> <span class="free">a2</span> <span class="main">‚äï</span> True<span class="main">)</span><span class="main">)</span> <span class="main">()</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">view</span><span class="main">.</span> <span class="free">A</span> <span class="bound">view</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> True<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> int2<span class="main">:</span> <span class="quoted"><span class="quoted">"integrable <span class="main">(</span>measure_spmf coin_spmf<span class="main">)</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> spmf <span class="main">(</span><span class="free">R1_14_OT</span> <span class="main">(</span><span class="bound">x</span> <span class="main">‚äï</span> <span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> False <span class="main">‚àß</span> <span class="free">a2</span> <span class="main">‚äï</span> False<span class="main">)</span><span class="main">,</span> <span class="bound">x</span> <span class="main">‚äï</span> <span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> False <span class="main">‚àß</span> <span class="free">a2</span> <span class="main">‚äï</span> True<span class="main">)</span><span class="main">,</span> <span class="bound">x</span> <span class="main">‚äï</span> <span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> True <span class="main">‚àß</span> <span class="free">a2</span> <span class="main">‚äï</span> False<span class="main">)</span><span class="main">,</span> <span class="bound">x</span> <span class="main">‚äï</span> <span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> True <span class="main">‚àß</span> <span class="free">a2</span> <span class="main">‚äï</span> True<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">b1</span><span class="main">,</span> <span class="free">b2</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">view</span><span class="main">.</span> <span class="free">A</span> <span class="bound">view</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> True<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> measure_spmf.integrable_const_bound<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pmf_le_1<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="main">¬¶</span><span class="keyword1">LINT</span> <span class="bound">x</span><span class="main">|</span>measure_spmf coin_spmf<span class="main">.</span>
        spmf <span class="main">(</span><span class="free">S1_14_OT</span> <span class="main">(</span><span class="bound">x</span> <span class="main">‚äï</span> <span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> False <span class="main">‚àß</span> <span class="free">a2</span> <span class="main">‚äï</span> False<span class="main">)</span><span class="main">,</span> <span class="bound">x</span> <span class="main">‚äï</span> <span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> False <span class="main">‚àß</span> <span class="free">a2</span> <span class="main">‚äï</span> True<span class="main">)</span><span class="main">,</span> <span class="bound">x</span> <span class="main">‚äï</span> <span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> True <span class="main">‚àß</span> <span class="free">a2</span> <span class="main">‚äï</span> False<span class="main">)</span><span class="main">,</span> <span class="bound">x</span> <span class="main">‚äï</span> <span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> True <span class="main">‚àß</span> <span class="free">a2</span> <span class="main">‚äï</span> True<span class="main">)</span><span class="main">)</span> <span class="main">()</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">view</span><span class="main">.</span> <span class="free">A</span> <span class="bound">view</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> True <span class="main">-</span>
        spmf <span class="main">(</span><span class="free">R1_14_OT</span> <span class="main">(</span><span class="bound">x</span> <span class="main">‚äï</span> <span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> False <span class="main">‚àß</span> <span class="free">a2</span> <span class="main">‚äï</span> False<span class="main">)</span><span class="main">,</span> <span class="bound">x</span> <span class="main">‚äï</span> <span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> False <span class="main">‚àß</span> <span class="free">a2</span> <span class="main">‚äï</span> True<span class="main">)</span><span class="main">,</span> <span class="bound">x</span> <span class="main">‚äï</span> <span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> True <span class="main">‚àß</span> <span class="free">a2</span> <span class="main">‚äï</span> False<span class="main">)</span><span class="main">,</span> <span class="bound">x</span> <span class="main">‚äï</span> <span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> True <span class="main">‚àß</span> <span class="free">a2</span> <span class="main">‚äï</span> True<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">b1</span><span class="main">,</span> <span class="free">b2</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">view</span><span class="main">.</span> <span class="free">A</span> <span class="bound">view</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> spmf_bind<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> int1 int2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">‚â§</span> <span class="keyword1">LINT</span> <span class="bound">x</span><span class="main">|</span>measure_spmf coin_spmf<span class="main">.</span> <span class="main">¬¶</span>spmf <span class="main">(</span><span class="free">S1_14_OT</span> <span class="main">(</span><span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">a1</span> <span class="main">‚ü∂</span> <span class="main">¬¨</span> <span class="free">a2</span><span class="main">)</span><span class="main">,</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">a1</span> <span class="main">‚ü∂</span> <span class="free">a2</span><span class="main">)</span><span class="main">,</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">a1</span> <span class="main">‚à®</span> <span class="main">¬¨</span> <span class="free">a2</span><span class="main">)</span><span class="main">,</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">a1</span> <span class="main">‚à®</span> <span class="free">a2</span><span class="main">)</span><span class="main">)</span> <span class="main">()</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">view</span><span class="main">.</span> <span class="free">A</span> <span class="bound">view</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> True 
                <span class="main">-</span> spmf <span class="main">(</span><span class="free">R1_14_OT</span> <span class="main">(</span><span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">a1</span> <span class="main">‚ü∂</span> <span class="main">¬¨</span> <span class="free">a2</span><span class="main">)</span><span class="main">,</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">a1</span> <span class="main">‚ü∂</span> <span class="free">a2</span><span class="main">)</span><span class="main">,</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">a1</span> <span class="main">‚à®</span> <span class="main">¬¨</span> <span class="free">a2</span><span class="main">)</span><span class="main">,</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">a1</span> <span class="main">‚à®</span> <span class="free">a2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">b1</span><span class="main">,</span> <span class="free">b2</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">view</span><span class="main">.</span> <span class="free">A</span> <span class="bound">view</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> integral_abs_bound<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> order_trans<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">‚â§</span> <span class="keyword1">LINT</span> <span class="bound">x</span><span class="main">|</span>measure_spmf coin_spmf<span class="main">.</span> <span class="main">¬¶</span>spmf <span class="main">(</span><span class="free">S1_14_OT</span> <span class="main">(</span><span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">a1</span> <span class="main">‚ü∂</span> <span class="main">¬¨</span> <span class="free">a2</span><span class="main">)</span><span class="main">,</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">a1</span> <span class="main">‚ü∂</span> <span class="free">a2</span><span class="main">)</span><span class="main">,</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">a1</span> <span class="main">‚à®</span> <span class="main">¬¨</span> <span class="free">a2</span><span class="main">)</span><span class="main">,</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">a1</span> <span class="main">‚à®</span> <span class="free">a2</span><span class="main">)</span><span class="main">)</span> <span class="main">()</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">view</span><span class="main">.</span> <span class="free">A</span> <span class="bound">view</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> True 
                <span class="main">-</span> spmf <span class="main">(</span><span class="free">R1_14_OT</span> <span class="main">(</span><span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">a1</span> <span class="main">‚ü∂</span> <span class="main">¬¨</span> <span class="free">a2</span><span class="main">)</span><span class="main">,</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">a1</span> <span class="main">‚ü∂</span> <span class="free">a2</span><span class="main">)</span><span class="main">,</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">a1</span> <span class="main">‚à®</span> <span class="main">¬¨</span> <span class="free">a2</span><span class="main">)</span><span class="main">,</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">a1</span> <span class="main">‚à®</span> <span class="free">a2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">b1</span><span class="main">,</span> <span class="free">b2</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">view</span><span class="main">.</span> <span class="free">A</span> <span class="bound">view</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">LINT</span> <span class="bound">x</span><span class="main">|</span>measure_spmf coin_spmf<span class="main">.</span> <span class="main">¬¶</span>spmf <span class="main">(</span><span class="free">S1_14_OT</span> <span class="main">(</span><span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">a1</span> <span class="main">‚ü∂</span> <span class="main">¬¨</span> <span class="free">a2</span><span class="main">)</span><span class="main">,</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">a1</span> <span class="main">‚ü∂</span> <span class="free">a2</span><span class="main">)</span><span class="main">,</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">a1</span> <span class="main">‚à®</span> <span class="main">¬¨</span> <span class="free">a2</span><span class="main">)</span><span class="main">,</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">a1</span> <span class="main">‚à®</span> <span class="free">a2</span><span class="main">)</span><span class="main">)</span> <span class="main">()</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">view</span><span class="main">.</span> <span class="free">A</span> <span class="bound">view</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> True 
                <span class="main">-</span> spmf <span class="main">(</span><span class="free">R1_14_OT</span> <span class="main">(</span><span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">a1</span> <span class="main">‚ü∂</span> <span class="main">¬¨</span> <span class="free">a2</span><span class="main">)</span><span class="main">,</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">a1</span> <span class="main">‚ü∂</span> <span class="free">a2</span><span class="main">)</span><span class="main">,</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">a1</span> <span class="main">‚à®</span> <span class="main">¬¨</span> <span class="free">a2</span><span class="main">)</span><span class="main">,</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">a1</span> <span class="main">‚à®</span> <span class="free">a2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">b1</span><span class="main">,</span> <span class="free">b2</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">view</span><span class="main">.</span> <span class="free">A</span> <span class="bound">view</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span> <span class="main">‚â§</span> <span class="free">adv_14_OT</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> integral_mono<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> order_trans<span class="main"><span class="main">]</span></span><span class="main">)</span> 
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> measure_spmf.integrable_const_bound<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="numeral">2</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> abs_triangle_ineq4<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> order_trans<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a1</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a2</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> M
      <span class="keyword1"><span class="command">using</span></span> pmf_le_1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">R1_14_OT</span> <span class="main">(</span><span class="main">¬¨</span> <span class="skolem">M</span><span class="main">,</span> <span class="skolem">M</span><span class="main">,</span> <span class="skolem">M</span><span class="main">,</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">(</span><span class="free">b1</span><span class="main">,</span><span class="free">b2</span><span class="main">)</span> <span class="main">‚§ú</span>  <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="free">A</span> <span class="bound">view</span> <span class="skolem">M</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Some True"</span></span><span class="main">]</span>
        pmf_le_1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">S1_14_OT</span> <span class="main">(</span><span class="main">¬¨</span> <span class="skolem">M</span><span class="main">,</span> <span class="skolem">M</span><span class="main">,</span> <span class="skolem">M</span><span class="main">,</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">()</span> <span class="main">‚§ú</span>  <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="free">A</span> <span class="bound">view</span> <span class="skolem">M</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Some True"</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> M 
      <span class="keyword1"><span class="command">using</span></span> pmf_le_1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">R1_14_OT</span>  <span class="main">(</span><span class="skolem">M</span><span class="main">,</span> <span class="main">¬¨</span> <span class="skolem">M</span><span class="main">,</span> <span class="skolem">M</span><span class="main">,</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">(</span><span class="free">b1</span><span class="main">,</span><span class="free">b2</span><span class="main">)</span> <span class="main">‚§ú</span>  <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="free">A</span> <span class="bound">view</span> <span class="skolem">M</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Some True"</span></span><span class="main">]</span> 
        pmf_le_1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">S1_14_OT</span> <span class="main">(</span><span class="skolem">M</span><span class="main">,</span> <span class="main">¬¨</span> <span class="skolem">M</span><span class="main">,</span> <span class="skolem">M</span><span class="main">,</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">()</span> <span class="main">‚§ú</span>  <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="free">A</span> <span class="bound">view</span> <span class="skolem">M</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Some True"</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a2</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> M
      <span class="keyword1"><span class="command">using</span></span> pmf_le_1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">R1_14_OT</span>  <span class="main">(</span><span class="skolem">M</span><span class="main">,</span> <span class="skolem">M</span><span class="main">,</span> <span class="main">¬¨</span> <span class="skolem">M</span><span class="main">,</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">(</span><span class="free">b1</span><span class="main">,</span><span class="free">b2</span><span class="main">)</span> <span class="main">‚§ú</span>  <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="free">A</span> <span class="bound">view</span> <span class="skolem">M</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Some True"</span></span><span class="main">]</span> 
        pmf_le_1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">S1_14_OT</span> <span class="main">(</span><span class="skolem">M</span><span class="main">,</span> <span class="skolem">M</span><span class="main">,</span> <span class="main">¬¨</span> <span class="skolem">M</span><span class="main">,</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">()</span> <span class="main">‚§ú</span>  <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="free">A</span> <span class="bound">view</span> <span class="skolem">M</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Some True"</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> M
      <span class="keyword1"><span class="command">using</span></span> pmf_le_1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">R1_14_OT</span>  <span class="main">(</span><span class="skolem">M</span><span class="main">,</span> <span class="skolem">M</span><span class="main">,</span> <span class="skolem">M</span><span class="main">,</span> <span class="main">¬¨</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">(</span><span class="free">b1</span><span class="main">,</span><span class="free">b2</span><span class="main">)</span> <span class="main">‚§ú</span>  <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="free">A</span> <span class="bound">view</span> <span class="skolem">M</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Some True"</span></span><span class="main">]</span> 
        pmf_le_1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">S1_14_OT</span> <span class="main">(</span><span class="skolem">M</span><span class="main">,</span> <span class="skolem">M</span><span class="main">,</span> <span class="skolem">M</span><span class="main">,</span> <span class="main">¬¨</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">()</span> <span class="main">‚§ú</span>  <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="free">A</span> <span class="bound">view</span> <span class="skolem">M</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Some True"</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> ass_adv_14_OT <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> security_and_P1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬¶</span>spmf <span class="main">(</span><span class="main">(</span>and_funct <span class="main">(</span><span class="free">a1</span><span class="main">,</span> <span class="free">a2</span><span class="main">)</span> <span class="main">(</span><span class="free">b1</span><span class="main">,</span><span class="free">b2</span><span class="main">)</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">s1</span><span class="main">,</span> <span class="bound">s2</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>S1_and' <span class="main">(</span><span class="free">a1</span><span class="main">,</span><span class="free">a2</span><span class="main">)</span> <span class="main">(</span><span class="free">b1</span><span class="main">,</span><span class="free">b2</span><span class="main">)</span> <span class="bound">s1</span><span class="main">)</span> 
              <span class="main">‚§ú</span> <span class="main">(</span><span class="free">D</span> <span class="main">::</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span> <span class="main">√ó</span> bool <span class="main">√ó</span> <span class="tfree">'v_14_OT1</span><span class="main">)</span> <span class="main">√ó</span> <span class="main">(</span>share_1 <span class="main">√ó</span> share_2<span class="main">)</span><span class="main">)</span> <span class="main">‚áí</span> bool spmf<span class="main">)</span><span class="main">)</span><span class="main">)</span> True <span class="main">-</span> 
                    spmf <span class="main">(</span><span class="main">(</span>and_R1 <span class="main">(</span><span class="free">a1</span><span class="main">,</span> <span class="free">a2</span><span class="main">)</span> <span class="main">(</span><span class="free">b1</span><span class="main">,</span><span class="free">b2</span><span class="main">)</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="free">D</span><span class="main">)</span> True<span class="main">¬¶</span> <span class="main">‚â§</span> <span class="free">adv_14_OT</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v_14_OT1</span> <span class="main">‚áí</span> bool <span class="main">‚áí</span> bool spmf"</span></span> <span class="keyword2"><span class="keyword">where</span></span> A<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">¬¶</span>spmf <span class="main">(</span><span class="main">(</span>and_funct <span class="main">(</span><span class="free">a1</span><span class="main">,</span> <span class="free">a2</span><span class="main">)</span> <span class="main">(</span><span class="free">b1</span><span class="main">,</span><span class="free">b2</span><span class="main">)</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">s1</span><span class="main">,</span> <span class="bound">s2</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>S1_and' <span class="main">(</span><span class="free">a1</span><span class="main">,</span><span class="free">a2</span><span class="main">)</span> <span class="main">(</span><span class="free">b1</span><span class="main">,</span><span class="free">b2</span><span class="main">)</span> <span class="bound">s1</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span> True <span class="main">-</span> spmf <span class="main">(</span><span class="main">(</span>and_R1 <span class="main">(</span><span class="free">a1</span><span class="main">,</span> <span class="free">a2</span><span class="main">)</span> <span class="main">(</span><span class="free">b1</span><span class="main">,</span><span class="free">b2</span><span class="main">)</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="free">D</span><span class="main">)</span> True<span class="main">¬¶</span> <span class="main">=</span>
       <span class="main">¬¶</span>spmf <span class="main">(</span>coin_spmf <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">œÉ</span><span class="main">.</span> <span class="free">S1_14_OT</span> <span class="main">(</span><span class="main">(</span><span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> False<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="free">a2</span> <span class="main">‚äï</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> False<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="free">a2</span> <span class="main">‚äï</span> True<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> True<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="free">a2</span> <span class="main">‚äï</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> True<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="free">a2</span> <span class="main">‚äï</span> True<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">()</span> 
         <span class="main">‚§ú</span>  <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="skolem">A</span> <span class="bound">view</span> <span class="bound">œÉ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True <span class="main">-</span> spmf <span class="main">(</span>coin_spmf 
           <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">œÉ</span><span class="main">.</span> <span class="free">R1_14_OT</span> <span class="main">(</span><span class="main">(</span><span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> False<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="free">a2</span> <span class="main">‚äï</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> False<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="free">a2</span> <span class="main">‚äï</span> True<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> True<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="free">a2</span> <span class="main">‚äï</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="free">a1</span> <span class="main">‚äï</span> True<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="free">a2</span> <span class="main">‚äï</span> True<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">b1</span><span class="main">,</span> <span class="free">b2</span><span class="main">)</span>
             <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="skolem">A</span> <span class="bound">view</span> <span class="bound">œÉ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> sec_ex_P1_and <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> bound_14_OT<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">a1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b2</span>"</span></span> <span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> security_and_P1'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬¶</span>spmf <span class="main">(</span><span class="main">(</span>and_R1 <span class="main">(</span><span class="free">a1</span><span class="main">,</span> <span class="free">a2</span><span class="main">)</span> <span class="main">(</span><span class="free">b1</span><span class="main">,</span><span class="free">b2</span><span class="main">)</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="free">D</span><span class="main">)</span> True <span class="main">-</span> 
           spmf <span class="main">(</span><span class="main">(</span>and_funct <span class="main">(</span><span class="free">a1</span><span class="main">,</span> <span class="free">a2</span><span class="main">)</span> <span class="main">(</span><span class="free">b1</span><span class="main">,</span><span class="free">b2</span><span class="main">)</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">s1</span><span class="main">,</span> <span class="bound">s2</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>S1_and' <span class="main">(</span><span class="free">a1</span><span class="main">,</span><span class="free">a2</span><span class="main">)</span> <span class="main">(</span><span class="free">b1</span><span class="main">,</span><span class="free">b2</span><span class="main">)</span> <span class="bound">s1</span><span class="main">)</span> 
            <span class="main">‚§ú</span> <span class="main">(</span><span class="free">D</span> <span class="main">::</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span> <span class="main">√ó</span> bool <span class="main">√ó</span> <span class="tfree">'v_14_OT1</span><span class="main">)</span> <span class="main">√ó</span> <span class="main">(</span>share_1 <span class="main">√ó</span> share_2<span class="main">)</span><span class="main">)</span> <span class="main">‚áí</span> bool spmf<span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span> <span class="main">‚â§</span> <span class="free">adv_14_OT</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬¶</span>spmf <span class="main">(</span><span class="main">(</span>and_R1 <span class="main">(</span><span class="free">a1</span><span class="main">,</span> <span class="free">a2</span><span class="main">)</span> <span class="main">(</span><span class="free">b1</span><span class="main">,</span><span class="free">b2</span><span class="main">)</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="free">D</span><span class="main">)</span> True <span class="main">-</span> 
          spmf <span class="main">(</span><span class="main">(</span>and_funct <span class="main">(</span><span class="free">a1</span><span class="main">,</span> <span class="free">a2</span><span class="main">)</span> <span class="main">(</span><span class="free">b1</span><span class="main">,</span><span class="free">b2</span><span class="main">)</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">s1</span><span class="main">,</span> <span class="bound">s2</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>S1_and' <span class="main">(</span><span class="free">a1</span><span class="main">,</span><span class="free">a2</span><span class="main">)</span> <span class="main">(</span><span class="free">b1</span><span class="main">,</span><span class="free">b2</span><span class="main">)</span> <span class="bound">s1</span><span class="main">)</span> 
            <span class="main">‚§ú</span> <span class="main">(</span><span class="free">D</span> <span class="main">::</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span> <span class="main">√ó</span> bool <span class="main">√ó</span> <span class="tfree">'v_14_OT1</span><span class="main">)</span> <span class="main">√ó</span> <span class="main">(</span>share_1 <span class="main">√ó</span> share_2<span class="main">)</span><span class="main">)</span> <span class="main">‚áí</span> bool spmf<span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span> <span class="main">=</span>
              <span class="main">¬¶</span>spmf <span class="main">(</span><span class="main">(</span>and_funct <span class="main">(</span><span class="free">a1</span><span class="main">,</span> <span class="free">a2</span><span class="main">)</span> <span class="main">(</span><span class="free">b1</span><span class="main">,</span><span class="free">b2</span><span class="main">)</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">s1</span><span class="main">,</span> <span class="bound">s2</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>S1_and' <span class="main">(</span><span class="free">a1</span><span class="main">,</span><span class="free">a2</span><span class="main">)</span> <span class="main">(</span><span class="free">b1</span><span class="main">,</span><span class="free">b2</span><span class="main">)</span> <span class="bound">s1</span><span class="main">)</span> 
                <span class="main">‚§ú</span> <span class="main">(</span><span class="free">D</span> <span class="main">::</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span> <span class="main">√ó</span> bool <span class="main">√ó</span> <span class="tfree">'v_14_OT1</span><span class="main">)</span> <span class="main">√ó</span> <span class="main">(</span>share_1 <span class="main">√ó</span> share_2<span class="main">)</span><span class="main">)</span> <span class="main">‚áí</span> bool spmf<span class="main">)</span><span class="main">)</span><span class="main">)</span> True <span class="main">-</span> 
                  spmf <span class="main">(</span><span class="main">(</span>and_R1 <span class="main">(</span><span class="free">a1</span><span class="main">,</span> <span class="free">a2</span><span class="main">)</span> <span class="main">(</span><span class="free">b1</span><span class="main">,</span><span class="free">b2</span><span class="main">)</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="free">D</span><span class="main">)</span> True<span class="main">¬¶</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> abs_minus_commute <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> security_and_P1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">and_R2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>share_1 <span class="main">√ó</span> share_2<span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span>share_2 <span class="main">√ó</span> share_1<span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span> <span class="main">√ó</span> <span class="tfree">'v_14_OT2</span><span class="main">)</span> <span class="main">√ó</span> <span class="main">(</span>share_1 <span class="main">√ó</span> share_2<span class="main">)</span><span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">and_R2</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">a1</span><span class="main">,</span> <span class="bound">a2</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">b1</span><span class="main">,</span><span class="bound">b2</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">;</span>
    <span class="bound">œÉ</span> <span class="main">‚Üê</span> coin_spmf<span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">s0</span> <span class="main">=</span> <span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="bound">a1</span> <span class="main">‚äï</span> False<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="bound">a2</span> <span class="main">‚äï</span> False<span class="main">)</span><span class="main">)</span><span class="main">;</span>   
    <span class="keyword1">let</span> <span class="bound">s1</span> <span class="main">=</span> <span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="bound">a1</span> <span class="main">‚äï</span> False<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="bound">a2</span> <span class="main">‚äï</span> True<span class="main">)</span><span class="main">)</span><span class="main">;</span>   
    <span class="keyword1">let</span> <span class="bound">s2</span> <span class="main">=</span> <span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="bound">a1</span> <span class="main">‚äï</span> True<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="bound">a2</span> <span class="main">‚äï</span> False<span class="main">)</span><span class="main">)</span><span class="main">;</span>   
    <span class="keyword1">let</span> <span class="bound">s3</span> <span class="main">=</span> <span class="bound">œÉ</span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="bound">a1</span> <span class="main">‚äï</span> True<span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="bound">a2</span> <span class="main">‚äï</span> True<span class="main">)</span><span class="main">)</span><span class="main">;</span> 
    <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="free">protocol_14_OT</span> <span class="main">(</span><span class="bound">s0</span><span class="main">,</span><span class="bound">s1</span><span class="main">,</span><span class="bound">s2</span><span class="main">,</span><span class="bound">s3</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">;</span>
    <span class="bound">V</span> <span class="main">‚Üê</span> <span class="free">R2_14_OT</span> <span class="main">(</span><span class="bound">s0</span><span class="main">,</span><span class="bound">s1</span><span class="main">,</span><span class="bound">s2</span><span class="main">,</span><span class="bound">s3</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="bound">V</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">œÉ</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lossless_and_R2<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span>and_R2 <span class="free">A</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> and_R2_def split_def lossless_R2_14_OT lossless_protocol_14_OT Let_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lossless_R2_14_OT prod.collapse<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">S2_and</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>share_1 <span class="main">√ó</span> share_2<span class="main">)</span> <span class="main">‚áí</span> bool <span class="main">‚áí</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span> <span class="main">√ó</span> <span class="tfree">'v_14_OT2</span><span class="main">)</span><span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">S2_and</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">=</span>  <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">a2</span><span class="main">,</span><span class="bound">b2</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">;</span>
    <span class="bound">V</span> <span class="main">::</span> <span class="tfree">'v_14_OT2</span> <span class="main">‚Üê</span> <span class="free">S2_14_OT</span> <span class="main">(</span><span class="bound">a2</span><span class="main">,</span><span class="bound">b2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="bound">V</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">out2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>share_1 <span class="main">√ó</span> share_2<span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span>share_1 <span class="main">√ó</span> share_2<span class="main">)</span> <span class="main">‚áí</span> bool <span class="main">‚áí</span> <span class="main">(</span>share_1 <span class="main">√ó</span> share_2<span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">out2</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">a1</span><span class="main">,</span> <span class="bound">b1</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">a2</span><span class="main">,</span><span class="bound">b2</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">s1</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="bound">a1</span> <span class="main">‚äï</span> <span class="bound">a2</span><span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="bound">b1</span> <span class="main">‚äï</span> <span class="bound">b2</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="bound">s1</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">S2_and'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>share_1 <span class="main">√ó</span> share_2<span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span>share_1 <span class="main">√ó</span> share_2<span class="main">)</span> <span class="main">‚áí</span> bool <span class="main">‚áí</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>bool <span class="main">√ó</span> bool<span class="main">)</span> <span class="main">√ó</span> <span class="tfree">'v_14_OT2</span><span class="main">)</span> <span class="main">√ó</span> <span class="main">(</span>share_1 <span class="main">√ó</span> share_2<span class="main">)</span><span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">S2_and'</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">=</span>  <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">a1</span><span class="main">,</span> <span class="bound">a2</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">b1</span><span class="main">,</span><span class="bound">b2</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">;</span>
    <span class="bound">V</span> <span class="main">::</span> <span class="tfree">'v_14_OT2</span> <span class="main">‚Üê</span> <span class="free">S2_14_OT</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">s1</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">‚äï</span> <span class="main">(</span><span class="main">(</span><span class="bound">a1</span> <span class="main">‚äï</span> <span class="bound">b1</span><span class="main">)</span> <span class="main">‚àß</span> <span class="main">(</span><span class="bound">a2</span> <span class="main">‚äï</span> <span class="bound">b2</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="bound">V</span><span class="main">)</span><span class="main">,</span> <span class="bound">s1</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lossless_S2_and<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span>S2_and <span class="free">B</span> <span class="free">s2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S2_and_def split_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> prod.collapse lossless_S2_14_OT<span class="main">)</span> 

<span class="keyword1"><span class="command">sublocale</span></span> and_secret_sharing<span class="main">:</span> sim_non_det_def <span class="quoted">and_R1</span> <span class="quoted">S1_and</span> <span class="quoted">out1</span> <span class="quoted">and_R2</span> <span class="quoted">S2_and</span> <span class="quoted">out2</span> <span class="quoted">and_funct</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ideal_S1_and<span class="main">:</span> <span class="quoted"><span class="quoted">"and_secret_sharing.Ideal1 <span class="main">(</span><span class="free">a1</span><span class="main">,</span> <span class="free">b1</span><span class="main">)</span> <span class="main">(</span><span class="free">a2</span><span class="main">,</span> <span class="free">b2</span><span class="main">)</span> <span class="free">s2</span> <span class="main">=</span> S1_and' <span class="main">(</span><span class="free">a1</span><span class="main">,</span> <span class="free">b1</span><span class="main">)</span> <span class="main">(</span><span class="free">a2</span><span class="main">,</span> <span class="free">b2</span><span class="main">)</span> <span class="free">s2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def and_secret_sharing.Ideal1_def S1_and'_def split_def out1_def S1_and_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> and_P2_security<span class="main">:</span> <span class="quoted"><span class="quoted">"and_secret_sharing.perfect_sec_P2 <span class="free">m1</span> <span class="free">m2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"and_R2 <span class="main">(</span><span class="skolem">a1</span><span class="main">,</span> <span class="skolem">b1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">a2</span><span class="main">,</span> <span class="skolem">b2</span><span class="main">)</span> <span class="main">=</span> and_funct <span class="main">(</span><span class="skolem">a1</span><span class="main">,</span> <span class="skolem">b1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">a2</span><span class="main">,</span> <span class="skolem">b2</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">s1</span><span class="main">,</span> <span class="bound">s2</span><span class="main">)</span><span class="main">.</span> and_secret_sharing.Ideal2 <span class="main">(</span><span class="skolem">a2</span><span class="main">,</span> <span class="skolem">b2</span><span class="main">)</span> <span class="main">(</span><span class="skolem">a1</span><span class="main">,</span> <span class="skolem">b1</span><span class="main">)</span> <span class="bound">s2</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a1</span> <span class="skolem">a2</span> <span class="skolem">b1</span> <span class="skolem">b2</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def inf_th_14_OT_P4  S2_and'_def and_R2_def and_funct_def Let_def correct_14<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> and_secret_sharing.Ideal2_def S2_and_def out2_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> funct_14<span class="main">)</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b1</span></span><span class="main"><span class="keyword3">;</span></span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b2</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">a1</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">a2</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> and_secret_sharing.perfect_sec_P2_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">metis</span>  prod.collapse<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> and_P1_security<span class="main">:</span> <span class="quoted"><span class="quoted">"and_secret_sharing.adv_P1 <span class="free">m1</span> <span class="free">m2</span> <span class="free">D</span> <span class="main">‚â§</span> <span class="free">adv_14_OT</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬¶</span>spmf <span class="main">(</span>and_R1 <span class="main">(</span><span class="skolem">a1</span><span class="main">,</span> <span class="skolem">a2</span><span class="main">)</span> <span class="main">(</span><span class="skolem">b1</span><span class="main">,</span> <span class="skolem">b2</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="free">D</span><span class="main">)</span> True <span class="main">-</span>
            spmf <span class="main">(</span>and_funct <span class="main">(</span><span class="skolem">a1</span><span class="main">,</span> <span class="skolem">a2</span><span class="main">)</span> <span class="main">(</span><span class="skolem">b1</span><span class="main">,</span> <span class="skolem">b2</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">s1</span><span class="main">,</span> <span class="bound">s2</span><span class="main">)</span><span class="main">.</span> 
                and_secret_sharing.Ideal1 <span class="main">(</span><span class="skolem">a1</span><span class="main">,</span> <span class="skolem">a2</span><span class="main">)</span> <span class="main">(</span><span class="skolem">b1</span><span class="main">,</span> <span class="skolem">b2</span><span class="main">)</span> <span class="bound">s1</span> <span class="main">‚§ú</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span>
                    <span class="main">‚â§</span> <span class="free">adv_14_OT</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a1</span> <span class="skolem">a2</span> <span class="skolem">b1</span> <span class="skolem">b2</span> 
    <span class="keyword1"><span class="command">using</span></span> security_and_P1' ideal_S1_and prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  and_secret_sharing.adv_P1_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">metis</span> prod.collapse<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">=</span> <span class="main">{</span>and_evaluate<span class="main">,</span> xor_evaluate<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> share_reconstruct_xor<span class="main">:</span> <span class="quoted"><span class="quoted">"share <span class="free">x</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a1</span><span class="main">,</span> <span class="bound">a2</span><span class="main">)</span><span class="main">.</span> share <span class="free">y</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">b1</span><span class="main">,</span> <span class="bound">b2</span><span class="main">)</span><span class="main">.</span> 
          xor_protocol <span class="main">(</span><span class="bound">a1</span><span class="main">,</span> <span class="bound">b1</span><span class="main">)</span> <span class="main">(</span><span class="bound">a2</span><span class="main">,</span> <span class="bound">b2</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> 
              reconstruct <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> xor_evaluate <span class="free">x</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="skolem">ya</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="skolem">ya</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">yb</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬¨</span> <span class="skolem">yb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬¨</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ya</span> <span class="skolem">yb</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> xor_protocol_def share_def reconstruct_def xor_evaluate_def bind_spmf_const<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> share_correct<span class="main">:</span> secret_sharing_scheme <span class="quoted">share</span> <span class="quoted">reconstruct</span> <span class="quoted">F</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"share_correct.sharing_correct <span class="free">input</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> share_correct.sharing_correct_def reconstruct_share<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"share_correct.correct_share_eval <span class="free">input1</span> <span class="free">input2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> share_correct.correct_share_eval_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> F_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">using</span></span> share_and_reconstruct <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">using</span></span> share_reconstruct_xor <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword2"><span class="keyword">end</span></span> 

<span class="keyword1"><span class="command">locale</span></span> gmw_asym <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S1_14_OT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">‚áí</span> msgs_14_OT <span class="main">‚áí</span> unit <span class="main">‚áí</span> <span class="tfree">'v_14_OT1</span> spmf"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">R1_14_OT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">‚áí</span> msgs_14_OT <span class="main">‚áí</span> choice_14_OT <span class="main">‚áí</span> <span class="tfree">'v_14_OT1</span> spmf"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">S2_14_OT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">‚áí</span> choice_14_OT <span class="main">‚áí</span> bool <span class="main">‚áí</span> <span class="tfree">'v_14_OT2</span> spmf"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">R2_14_OT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">‚áí</span> msgs_14_OT <span class="main">‚áí</span> choice_14_OT <span class="main">‚áí</span> <span class="tfree">'v_14_OT2</span> spmf"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">protocol_14_OT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">‚áí</span> msgs_14_OT <span class="main">‚áí</span> choice_14_OT <span class="main">‚áí</span> <span class="main">(</span>unit <span class="main">√ó</span> bool<span class="main">)</span> spmf"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">adv_14_OT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">‚áí</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> gmw_base<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">‚ãÄ</span> <span class="main">(</span><span class="bound">n</span><span class="main">::</span>nat<span class="main">)</span><span class="main">.</span> gmw_base <span class="main">(</span><span class="free">S1_14_OT</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="free">R1_14_OT</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="free">S2_14_OT</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="free">R2_14_OT</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="free">protocol_14_OT</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="free">adv_14_OT</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> gmw_base <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">S1_14_OT</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">R1_14_OT</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">S2_14_OT</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">R2_14_OT</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">protocol_14_OT</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">adv_14_OT</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gmw_base<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"xor_sim_det.perfect_sec_P1 <span class="free">m1</span> <span class="free">m2</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P1_xor_inf_th xor_sim_det.perfect_sec_P1_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"xor_sim_det.perfect_sec_P2 <span class="free">m1</span> <span class="free">m2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P2_xor_inf_th xor_sim_det.perfect_sec_P2_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> and_P1_adv_negligible<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">Œª</span> <span class="bound">n</span><span class="main">.</span> <span class="free">adv_14_OT</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">Œª</span> <span class="bound">n</span><span class="main">.</span> and_secret_sharing.adv_P1 <span class="bound">n</span> <span class="free">m1</span> <span class="free">m2</span> <span class="free">D</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"and_secret_sharing.adv_P1 <span class="skolem">n</span> <span class="free">m1</span> <span class="free">m2</span> <span class="free">D</span> <span class="main">‚â§</span> <span class="free">adv_14_OT</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> and_P1_security<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> and_secret_sharing.adv_P1_def assms negligible_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> and_P2_security<span class="main">:</span> <span class="quoted"><span class="quoted">"and_secret_sharing.perfect_sec_P2 <span class="free">n</span> <span class="free">m1</span> <span class="free">m2</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> and_P2_security<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


</pre>
</div><div id="Secure_Multiplication">
<div class="head">
<h1>Theory Secure_Multiplication</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπSecure multiplication protocol‚Ä∫</span></span>

<span class="keyword1"><span class="command">theory</span></span> Secure_Multiplication <span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../CryptHOL/Cyclic_Group_SPMF.html">CryptHOL.Cyclic_Group_SPMF</a>   
  <a href="Uniform_Sampling.html">Uniform_Sampling</a> 
  <a href="Semi_Honest_Def.html">Semi_Honest_Def</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">locale</span></span> secure_mult <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">q</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> q_gt_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">q</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> real_view <span class="main">=</span> <span class="quoted"><span class="quoted">"nat <span class="main">‚áí</span> nat <span class="main">‚áí</span> <span class="main">(</span><span class="main">(</span>nat <span class="main">√ó</span> nat <span class="main">√ó</span> nat <span class="main">√ó</span> nat<span class="main">)</span> <span class="main">√ó</span> nat <span class="main">√ó</span> nat<span class="main">)</span> spmf"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> sim <span class="main">=</span> <span class="quoted"><span class="quoted">"nat <span class="main">‚áí</span> nat <span class="main">‚áí</span> <span class="main">(</span><span class="main">(</span>nat <span class="main">√ó</span> nat <span class="main">√ó</span> nat <span class="main">√ó</span> nat<span class="main">)</span> <span class="main">√ó</span> nat <span class="main">√ó</span> nat<span class="main">)</span> spmf"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> samp_uni_set_spmf <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set_spmf <span class="main">(</span>sample_uniform <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">{..&lt;</span> <span class="free">q</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sample_uniform_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">funct</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">‚áí</span> nat <span class="main">‚áí</span> <span class="main">(</span>nat <span class="main">√ó</span> nat<span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">funct</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">s</span> <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">TI</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>nat <span class="main">√ó</span> nat<span class="main">)</span> <span class="main">√ó</span> <span class="main">(</span>nat <span class="main">√ó</span> nat<span class="main">)</span><span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">TI</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">a</span> <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>  
    <span class="bound">b</span> <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>
    <span class="bound">r</span> <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="bound">a</span><span class="main">*</span><span class="bound">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">out</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">‚áí</span> nat <span class="main">‚áí</span> <span class="main">(</span>nat <span class="main">√ó</span> nat<span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">out</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="main">(</span><span class="main">(</span><span class="bound">c1</span><span class="main">,</span><span class="bound">d1</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">c2</span><span class="main">,</span><span class="bound">d2</span><span class="main">)</span><span class="main">)</span> <span class="main">‚Üê</span> TI<span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e2</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">+</span> <span class="bound">c1</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e1</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">c2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">*</span><span class="bound">e1</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">d1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="bound">e2</span> <span class="main">*</span> <span class="bound">c2</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">d2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">R1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real_view"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">R1</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="main">(</span><span class="main">(</span><span class="bound">c1</span><span class="main">,</span> <span class="bound">d1</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">c2</span><span class="main">,</span> <span class="bound">d2</span><span class="main">)</span><span class="main">)</span> <span class="main">‚Üê</span> TI<span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e2</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">+</span> <span class="bound">c1</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e1</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">c2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">s1</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">*</span><span class="bound">e1</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">d1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">s2</span> <span class="main">=</span> <span class="main">(</span><span class="bound">e2</span> <span class="main">*</span> <span class="bound">c2</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">d2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="bound">c1</span><span class="main">,</span> <span class="bound">d1</span><span class="main">,</span> <span class="bound">e1</span><span class="main">)</span><span class="main">,</span> <span class="bound">s1</span><span class="main">,</span> <span class="bound">s2</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">S1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">‚áí</span> nat <span class="main">‚áí</span> <span class="main">(</span>nat <span class="main">√ó</span> nat <span class="main">√ó</span> nat <span class="main">√ó</span> nat<span class="main">)</span> spmf"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">S1</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">a</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>  
    <span class="bound">e1</span> <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">d1</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">*</span><span class="bound">e1</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">d1</span><span class="main">,</span> <span class="bound">e1</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Out1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">‚áí</span> nat <span class="main">‚áí</span> nat <span class="main">‚áí</span> <span class="main">(</span>nat <span class="main">√ó</span> nat<span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Out1</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="bound">s2</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">,</span><span class="bound">s2</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">R2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real_view"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">R2</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="main">(</span><span class="main">(</span><span class="bound">c1</span><span class="main">,</span> <span class="bound">d1</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">c2</span><span class="main">,</span> <span class="bound">d2</span><span class="main">)</span><span class="main">)</span> <span class="main">‚Üê</span> TI<span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e2</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">+</span> <span class="bound">c1</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e1</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">c2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">s1</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">*</span><span class="bound">e1</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">d1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">s2</span> <span class="main">=</span> <span class="main">(</span><span class="bound">e2</span> <span class="main">*</span> <span class="bound">c2</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">d2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="bound">c2</span><span class="main">,</span> <span class="bound">d2</span><span class="main">,</span> <span class="bound">e2</span><span class="main">)</span><span class="main">,</span> <span class="bound">s1</span><span class="main">,</span> <span class="bound">s2</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">S2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">‚áí</span> nat <span class="main">‚áí</span> <span class="main">(</span>nat <span class="main">√ó</span> nat <span class="main">√ó</span> nat <span class="main">√ó</span> nat<span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">S2</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span> 
    <span class="bound">b</span> <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>
    <span class="bound">e2</span> <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">d2</span> <span class="main">=</span> <span class="main">(</span><span class="bound">e2</span><span class="main">*</span><span class="bound">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">d2</span><span class="main">,</span> <span class="bound">e2</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Out2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">‚áí</span> nat <span class="main">‚áí</span> nat <span class="main">‚áí</span> <span class="main">(</span>nat <span class="main">√ó</span> nat<span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Out2</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="bound">s1</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="bound">s1</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Ideal2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">‚áí</span> nat <span class="main">‚áí</span> nat <span class="main">‚áí</span> <span class="main">(</span><span class="main">(</span>nat <span class="main">√ó</span> nat <span class="main">√ó</span> nat <span class="main">√ó</span> nat<span class="main">)</span> <span class="main">√ó</span> <span class="main">(</span>nat <span class="main">√ó</span> nat<span class="main">)</span><span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ideal2</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">out2</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">view2</span> <span class="main">::</span> <span class="main">(</span>nat <span class="main">√ó</span> nat <span class="main">√ó</span> nat <span class="main">√ó</span> nat<span class="main">)</span> <span class="main">‚Üê</span> S2 <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">out2</span></span></span><span class="main">;</span>
    <span class="bound">out2</span> <span class="main">‚Üê</span> Out2 <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">out2</span></span></span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="bound">view2</span><span class="main">,</span> <span class="bound">out2</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> sim_non_det_def<span class="main">:</span> sim_non_det_def <span class="quoted">R1</span> <span class="quoted">S1</span> <span class="quoted">Out1</span> <span class="quoted">R2</span> <span class="quoted">S2</span> <span class="quoted">Out2</span> <span class="quoted">funct</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> minus_mod<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> cong_diff_nat  cong_def le_trans less_or_eq_imp_le assms mod_less_eq_dividend mod_mod_trivial<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> q_cong<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="free">q</span> <span class="main">+</span> <span class="free">a</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> q_cong_reverse<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">q</span> <span class="main">+</span> <span class="free">a</span> <span class="main">=</span> <span class="free">a</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> qq_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">a</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> minus_q_mult_cancel<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="free">e</span> <span class="main">+</span> <span class="free">b</span> <span class="main">-</span> <span class="free">q</span> <span class="main">*</span> <span class="free">c</span> <span class="main">-</span> <span class="free">d</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">+</span> <span class="free">b</span> <span class="main">-</span> <span class="free">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">+</span> <span class="free">b</span> <span class="main">-</span> <span class="free">q</span> <span class="main">*</span> <span class="free">c</span> <span class="main">-</span> <span class="free">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="free">e</span> <span class="main">+</span> <span class="free">b</span>  <span class="main">-</span> <span class="free">d</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="free">e</span> <span class="main">+</span> <span class="free">b</span> <span class="main">-</span> <span class="free">q</span> <span class="main">*</span> <span class="free">c</span> <span class="main">-</span> <span class="free">d</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> cong_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="free">e</span> <span class="main">+</span> <span class="free">b</span> <span class="main">-</span> <span class="free">d</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> add_cancel_left_left assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> diff_commute diff_is_0_eq' linordered_semidom_class.add_diff_inverse mod_add_left_eq mod_mult_self1_is_0 nat_less_le<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> cong_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> s1_s2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> r<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">a</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">*</span> <span class="free">b</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span>
          <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> 
                 <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">a</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">*</span> <span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> lhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">r</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?h</span> <span class="main">=</span> <span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> cong_def q_gt_0<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?h</span> <span class="main">=</span> <span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mod_add_left_eq mod_mult_right_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> no_qq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?h</span> <span class="main">=</span> <span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> distrib_left<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?h</span> <span class="main">=</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span>  
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> qq_cong  add.assoc cong_diff_nat cong_def le_add2 le_trans mod_le_divisor q_gt_0<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> cong_trans no_qq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mod<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?h</span> <span class="main">=</span> <span class="free">q</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span>  
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Nat.add_diff_assoc cong_def add.assoc add.commute le_add2 le_trans mod_add_self2 mod_le_divisor q_gt_0<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?h</span> <span class="main">=</span> <span class="free">q</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">‚â•</span> <span class="free">q</span> <span class="main">-</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">‚â•</span> <span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="free">q</span><span class="main">-</span><span class="free">b</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">‚â•</span> <span class="free">q</span> <span class="main">-</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1  assms   
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_strict_mono<span class="main">)</span>  
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_le_mono<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="free">q</span>  <span class="main">&gt;</span> <span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="free">q</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> minus_mod <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> mod <span class="keyword1"><span class="command">using</span></span> cong_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?h</span> <span class="main">=</span> <span class="free">q</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">*</span><span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span>  
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> right_diff_distrib'<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?h</span> <span class="main">=</span> <span class="free">q</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">*</span><span class="free">b</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mod'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?h</span> <span class="main">=</span> <span class="free">q</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">*</span><span class="free">b</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> neg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?h</span> <span class="main">=</span> <span class="free">q</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">x</span> <span class="main">*</span> <span class="free">q</span> <span class="main">+</span>  <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">-</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">*</span><span class="free">b</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="free">q</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">x</span> <span class="main">*</span> <span class="free">q</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">-</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">*</span> <span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">x</span> <span class="main">*</span> <span class="free">q</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>  
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> add.commute diff_mult_distrib2 less_Suc_eq mult.commute mult_Suc_right nat_0_less_mult_iff q_gt_0 zero_less_diff<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> mod' cong_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?h</span> <span class="main">=</span> <span class="free">q</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">+</span>  <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">-</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">x</span> <span class="main">*</span> <span class="free">q</span> <span class="main">+</span>  <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">-</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="free">q</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">+</span>  <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">-</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">&gt;</span> <span class="free">x</span><span class="main">*</span><span class="free">q</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> False assms 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_strict_mono<span class="main">)</span> 
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">x</span> <span class="main">*</span> <span class="free">q</span> <span class="main">+</span>  <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">-</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">+</span>  <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">-</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> 1 2 Nat.add_diff_assoc2 <span class="quoted"><span class="quoted">‚Äπ<span class="free">x</span> <span class="main">*</span> <span class="free">q</span> <span class="main">&lt;</span> <span class="free">q</span> <span class="main">*</span> <span class="free">q</span>‚Ä∫</span></span> add_cancel_left_left add_diff_inverse_nat 
                le_add1 le_add2 le_trans less_imp_add_positive less_numeral_extra<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> minus_mod 
                minus_q_mult_cancel mod_if mult.commute q_gt_0<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> cong_trans neg <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?h</span> <span class="main">=</span> <span class="free">q</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">+</span>  <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">-</span> <span class="free">q</span> <span class="main">+</span> <span class="free">r</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> r<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Nat.add_diff_assoc2 Nat.diff_diff_right le_add2 less_imp_le_nat semiring_normalization_rules<span class="main"><span class="main">(</span></span>23<span class="main"><span class="main">)</span></span><span class="main">)</span>   
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?h</span> <span class="main">=</span> <span class="free">q</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">+</span>  <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">r</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>  
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> add.assoc add.commute add_diff_cancel_right' diff_is_0_eq' mod_if mod_le_divisor q_gt_0<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?h</span> <span class="main">=</span> <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">r</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mod_add_cong mod_add_self1 mod_mult_self1<span class="main">)</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def assms<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> rhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">a</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">*</span> <span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">r</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">a</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">*</span> <span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?h</span> <span class="main">=</span>  <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">a</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">*</span> <span class="free">b</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> q_gt_0  assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> cong_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?h</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">a</span><span class="main">)</span> <span class="main">*</span> <span class="free">b</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Nat.add_diff_assoc cong_def mod_add_cong mod_le_divisor mod_mult_left_eq q_gt_0 assms<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?h</span> <span class="main">=</span> <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">a</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> distrib_right<span class="main">)</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mod<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?h</span> <span class="main">=</span> <span class="free">q</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">a</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Nat.add_diff_assoc cong_def add.assoc add.commute le_add2 le_trans mod_add_self2 mod_le_divisor q_gt_0<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?h</span> <span class="main">=</span>  <span class="free">q</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">a</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span>  q_cong assms<span class="main">(</span>1<span class="main">)</span> 
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> ge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">a</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">q</span>  <span class="main">&gt;</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span> <span class="free">q</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">a</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span>  <span class="free">q</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">a</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Divides.mod_less_eq_dividend cong_diff_nat  cong_def le_trans less_not_refl2
                  less_or_eq_imp_le q_gt_0 minus_mod <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> mod cong_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?h</span> <span class="main">=</span>  <span class="free">q</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?h</span> <span class="main">=</span>  <span class="free">q</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">q</span> <span class="main">+</span> <span class="free">r</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Nat.add_diff_assoc2 Nat.diff_diff_right r<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> le_add2 less_imp_le_nat<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?h</span> <span class="main">=</span> <span class="free">q</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">r</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?h</span> <span class="main">=</span> <span class="free">q</span> <span class="main">+</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> add.assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?h</span> <span class="main">=</span> <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">r</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> cong_def q_cong_reverse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> lhs<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">a</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">*</span> <span class="free">b</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">a</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">*</span> <span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> rhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> "</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">a</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">*</span> <span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms s<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> lhs rhs 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> s1_s2_P2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xa</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xb</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xc</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">xa</span><span class="main">,</span> <span class="main">(</span><span class="free">xb</span> <span class="main">*</span> <span class="free">xa</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">xc</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">,</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">xb</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">xc</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">xb</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">*</span> <span class="free">xa</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">xb</span> <span class="main">*</span> <span class="free">xa</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">xc</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span>
         <span class="main">(</span><span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">xa</span><span class="main">,</span> <span class="main">(</span><span class="free">xb</span> <span class="main">*</span> <span class="free">xa</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">xc</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">,</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">xb</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">xc</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">,</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">xc</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms s1_s2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> c1<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">e2</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">c1</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c1</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">c1</span> <span class="main">=</span> <span class="main">(</span><span class="free">e2</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">e2</span> <span class="main">+</span> <span class="free">q</span> <span class="main">=</span> <span class="free">x</span> <span class="main">+</span> <span class="free">c1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms cong_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">e2</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">x</span>  <span class="main">=</span>  <span class="free">c1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">e2</span> <span class="main">+</span> <span class="free">q</span> <span class="main">‚â•</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">[</span><span class="free">e2</span> <span class="main">+</span> <span class="free">q</span> <span class="main">=</span> <span class="free">x</span> <span class="main">+</span> <span class="free">c1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>‚Ä∫</span></span> cong_add_lcancel_nat le_add_diff_inverse<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def assms<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> c1_P2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xb</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xa</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xc</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">xa</span><span class="main">,</span> <span class="main">(</span><span class="free">xb</span> <span class="main">*</span> <span class="free">xa</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">xc</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">,</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">xb</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">xc</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">,</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">xc</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> 
          <span class="main">(</span><span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">xa</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">xb</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">*</span> <span class="free">xa</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">xc</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">,</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">xb</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">xc</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">,</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">xc</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xb</span> <span class="main">*</span> <span class="free">xa</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">xc</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">xb</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">*</span> <span class="free">xa</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">xc</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms c1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> minus_mod_cancel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">-</span> <span class="free">b</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">-</span> <span class="free">b</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span> <span class="main">+</span> <span class="free">c</span> <span class="main">=</span> <span class="free">a</span> <span class="main">-</span> <span class="free">b</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">+</span> <span class="free">c</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">b</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">+</span> <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span> <span class="main">+</span> <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  cong_def mod_add_cong neq0_conv q_gt_0 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> minus_mod_eq_mult_div<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Divides.mod_less_eq_dividend Nat.add_diff_assoc2 add_diff_inverse_nat assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> cong_def diff_is_0_eq' less_or_eq_imp_le mod_add_cong neq0_conv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> d2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> d2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d2</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">e2</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s2</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">s1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> e2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e2</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">d2</span>  <span class="main">=</span> <span class="main">(</span><span class="free">e2</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">s2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> s1_le_q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> s1 q_gt_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> s2_le_q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s2</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> s2 q_gt_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> xb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="free">s2</span>  <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s1 b 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mod_add_left_eq mod_mult_right_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> s1_dist<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> distrib_left<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> distrib_left b diff_mult_distrib2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">s1</span> <span class="main">=</span> <span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">s1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span> <span class="free">b</span> <span class="main">=</span> <span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute add.left_commute cong_add_lcancel_nat<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">s1</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">=</span> <span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> b <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">metis</span> add_diff_inverse_nat diff_diff_left diff_mult_distrib2 less_imp_add_positive mult.commute not_add_less1 zero_less_diff<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> s1_xb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">s1</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">=</span> <span class="free">q</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> mod_add_cong mod_add_self1 cong_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">=</span> <span class="free">q</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span> <span class="main">-</span> <span class="free">s1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span> <span class="main">-</span> <span class="free">s1</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s1_le_q <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_diff_inverse_nat less_numeral_extra<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> s1_xb cong_add_lcancel_nat nat_diff_split<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">=</span> <span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">s1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.assoc add.commute<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">=</span> <span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">s1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Nat.add_diff_assoc cong_def less_imp_le_nat mod_mult_self1 s1_le_q semiring_normalization_rules<span class="main"><span class="main">(</span></span>23<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span>  <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">s1</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span>  <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">s1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> add.assoc s1_le_q <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span>  <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">s1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> add.commute <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> s2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">qed</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">d2</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">e2</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> d2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">d2</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">e2</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> mod_add_cong mod_mult_left_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">d2</span> <span class="main">=</span> <span class="main">(</span><span class="free">e2</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">b</span> <span class="main">-</span> <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distrib_right diff_mult_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">d2</span> <span class="main">=</span> <span class="free">e2</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">b</span> <span class="main">-</span> <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">d2</span> <span class="main">=</span> <span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">+</span> <span class="free">e2</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">b</span> <span class="main">-</span> <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">e2</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">b</span> <span class="main">-</span> <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">+</span> <span class="free">e2</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">b</span> <span class="main">-</span> <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> assms Nat.add_diff_assoc add.commute cong_def less_imp_le_nat mod_add_self2 
          mult.commute nat_mult_le_cancel_disj semiring_normalization_rules<span class="main"><span class="main">(</span></span>23<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> cong_trans a <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">d2</span> <span class="main">=</span> <span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">+</span> <span class="free">e2</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">b</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">+</span> <span class="free">e2</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">b</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">b</span><span class="main">)</span>  <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">+</span> <span class="free">e2</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">b</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span><span class="main">*</span><span class="free">b</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">b</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> False x <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">+</span> <span class="free">e2</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">b</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">b</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">+</span> <span class="free">e2</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">b</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> q_gt_0 trans_less_add1<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 minus_mod_cancel <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> cong_trans b <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">d2</span> <span class="main">=</span> <span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">+</span> <span class="free">e2</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">b</span> <span class="main">-</span> <span class="main">(</span><span class="free">s2</span>  <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> xb <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">d2</span> <span class="main">=</span> <span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">+</span> <span class="free">e2</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">b</span> <span class="main">-</span> <span class="main">(</span><span class="free">s2</span>  <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">+</span> <span class="free">e2</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">b</span> <span class="main">-</span> <span class="main">(</span><span class="free">s2</span>  <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">+</span> <span class="free">e2</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">b</span> <span class="main">-</span> <span class="main">(</span><span class="free">s2</span>  <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">+</span> <span class="free">e2</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">b</span> <span class="main">-</span> <span class="main">(</span><span class="free">s2</span>  <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>  
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_is_0_eq gr0I le_less_trans mod_less_divisor not_add_less1 q_gt_0 semiring_normalization_rules<span class="main"><span class="main">(</span></span>23<span class="main"><span class="main">)</span></span> trans_less_add2<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span><span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">+</span> <span class="free">e2</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">b</span> <span class="main">-</span> <span class="main">(</span><span class="free">s2</span>  <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> s2_le_q <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> minus_mod_cancel cong_sym <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> cong_trans c <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">d2</span> <span class="main">=</span> <span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">+</span> <span class="free">e2</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">b</span> <span class="main">-</span> <span class="free">s2</span> <span class="main">-</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">d2</span> <span class="main">=</span> <span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">+</span> <span class="free">e2</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">b</span> <span class="main">-</span> <span class="free">s2</span> <span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">+</span> <span class="free">e2</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">b</span> <span class="main">-</span> <span class="free">s2</span> <span class="main">-</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> s2_le_q <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> d cong_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">d2</span> <span class="main">=</span> <span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">+</span> <span class="free">e2</span><span class="main">*</span><span class="free">b</span> <span class="main">-</span> <span class="free">s2</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Nat.add_diff_assoc2 cong_def less_imp_le_nat mod_mult_self1 mult.commute s2_le_q semiring_normalization_rules<span class="main"><span class="main">(</span></span>23<span class="main"><span class="main">)</span></span> trans_less_add2<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">d2</span> <span class="main">=</span> <span class="free">q</span> <span class="main">+</span> <span class="free">e2</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">s2</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute add.assoc<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">d2</span> <span class="main">=</span> <span class="free">e2</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">s2</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Nat.add_diff_assoc2 add.commute cong_def less_imp_le_nat mod_add_self2 s2_le_q trans_less_add2<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">d2</span> <span class="main">=</span> <span class="free">e2</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">s2</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_imp_le_nat s2_le_q<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def d2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> d2_P2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e2</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> e2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">b</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="free">e2</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">*</span> <span class="free">b</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">,</span> <span class="free">e2</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">,</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span>
                <span class="main">(</span><span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">b</span><span class="main">,</span> <span class="main">(</span><span class="free">e2</span> <span class="main">*</span> <span class="free">b</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">,</span> <span class="free">e2</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">,</span> 
                      <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">e2</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">*</span> <span class="free">b</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="free">e2</span> <span class="main">*</span> <span class="free">b</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> d2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">e2</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>  <span class="main">=</span> <span class="main">(</span><span class="free">e2</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms d2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">e2</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> <span class="main">(</span><span class="free">e2</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms d2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> s1<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s2</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">s1</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">s2</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> s2_le_q<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">s2</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s2 q_gt_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">s2</span> <span class="main">=</span> <span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">s1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def s2<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">s2</span> <span class="main">=</span> <span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">s1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> add.assoc 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_imp_le_nat s1<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> s1_s2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">s2</span> <span class="main">+</span> <span class="free">s1</span> <span class="main">=</span> <span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> cong_def le_add2 le_add_diff_inverse2 le_trans mod_add_left_eq order.strict_implies_order s1<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">s1</span> <span class="main">=</span> <span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">s2</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">s2</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s2_le_q <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> s1_s2 add_diff_cancel_left' cong_diff_nat cong_def le_add1 less_imp_le_nat zero_less_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def s1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> s1_P2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">e2</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">b</span><span class="main">,</span> <span class="main">(</span><span class="free">e2</span> <span class="main">*</span> <span class="free">b</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">,</span> <span class="free">e2</span><span class="main">)</span><span class="main">,</span> <span class="free">r</span><span class="main">,</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span>
                <span class="main">(</span><span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">b</span><span class="main">,</span> <span class="main">(</span><span class="free">e2</span> <span class="main">*</span> <span class="free">b</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">,</span> <span class="free">e2</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">,</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">s1</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms secure_mult.s1 secure_mult_axioms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms s1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> P2_security<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sim_non_det_def.perfect_sec_P2 <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">including</span></span> monad_normalisation
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>funct <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">s1'</span><span class="main">,</span><span class="bound">s2'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>sim_non_det_def.Ideal2 <span class="free">y</span> <span class="free">x</span> <span class="bound">s2'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> R2 <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"R2 <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">a</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>  
      <span class="bound">b</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>
      <span class="bound">r</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">c1</span> <span class="main">=</span> <span class="bound">a</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">d1</span> <span class="main">=</span> <span class="bound">r</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">c2</span> <span class="main">=</span> <span class="bound">b</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">d2</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="bound">a</span><span class="main">*</span><span class="bound">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">e2</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="bound">c1</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">e1</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">c2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">s1</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="bound">e1</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">s2</span> <span class="main">=</span> <span class="main">(</span><span class="bound">e2</span> <span class="main">*</span> <span class="bound">c2</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">d2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
      return_spmf <span class="main">(</span><span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="bound">c2</span><span class="main">,</span> <span class="bound">d2</span><span class="main">,</span> <span class="bound">e2</span><span class="main">)</span><span class="main">,</span> <span class="bound">s1</span><span class="main">,</span> <span class="bound">s2</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R2_def TI_def Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">a</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>  
      <span class="bound">b</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>
      <span class="bound">r</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">c1</span> <span class="main">=</span> <span class="bound">a</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">d1</span> <span class="main">=</span> <span class="bound">r</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">c2</span> <span class="main">=</span> <span class="bound">b</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">e2</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="bound">c1</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">d2</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">e2</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">*</span><span class="bound">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">s1</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">c2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
      return_spmf <span class="main">(</span><span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="bound">c2</span><span class="main">,</span> <span class="bound">d2</span><span class="main">,</span> <span class="bound">e2</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">s1</span><span class="main">,</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">s1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def s1_s2_P2 assms c1_P2 <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> bind_spmf_cong_simp<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">b</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>
      <span class="bound">r</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">d1</span> <span class="main">=</span> <span class="bound">r</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">c2</span> <span class="main">=</span> <span class="bound">b</span><span class="main">;</span>
      <span class="bound">e2</span> <span class="main">‚Üê</span> map_spmf <span class="main">(</span><span class="main">Œª</span> <span class="bound">c1</span><span class="main">.</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="bound">c1</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span>sample_uniform <span class="free">q</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">d2</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">e2</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">*</span><span class="bound">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">s1</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">c2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
      return_spmf <span class="main">(</span><span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="bound">c2</span><span class="main">,</span> <span class="bound">d2</span><span class="main">,</span> <span class="bound">e2</span><span class="main">)</span><span class="main">,</span> <span class="bound">s1</span><span class="main">,</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">s1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_map_spmf o_def Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">b</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>
      <span class="bound">r</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">d1</span> <span class="main">=</span> <span class="bound">r</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">c2</span> <span class="main">=</span> <span class="bound">b</span><span class="main">;</span>
      <span class="bound">e2</span> <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">d2</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">e2</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">*</span><span class="bound">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">s1</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">c2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
      return_spmf <span class="main">(</span><span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="bound">c2</span><span class="main">,</span> <span class="bound">d2</span><span class="main">,</span> <span class="bound">e2</span><span class="main">)</span><span class="main">,</span> <span class="bound">s1</span><span class="main">,</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">s1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> samp_uni_plus_one_time_pad<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">b</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>
      <span class="bound">r</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>
      <span class="bound">e2</span> <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">s1</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">s2</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">s1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">d2</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">e2</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">*</span><span class="bound">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
      return_spmf <span class="main">(</span><span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">d2</span><span class="main">,</span> <span class="bound">e2</span><span class="main">)</span><span class="main">,</span> <span class="bound">s1</span><span class="main">,</span> <span class="bound">s2</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">b</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>
      <span class="bound">r</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>
      <span class="bound">e2</span> <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">s1</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">s2</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">s1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">d2</span> <span class="main">=</span> <span class="main">(</span><span class="bound">e2</span><span class="main">*</span><span class="bound">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">s2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
      return_spmf <span class="main">(</span><span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">d2</span><span class="main">,</span> <span class="bound">e2</span><span class="main">)</span><span class="main">,</span> <span class="bound">s1</span><span class="main">,</span> <span class="bound">s2</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> d2_P2 assms Let_def <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> bind_spmf_cong_simp<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">b</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>
      <span class="bound">e2</span> <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>
      <span class="bound">s1</span> <span class="main">‚Üê</span> map_spmf <span class="main">(</span><span class="main">Œª</span> <span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span>sample_uniform <span class="free">q</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">s2</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">s1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">d2</span> <span class="main">=</span> <span class="main">(</span><span class="bound">e2</span><span class="main">*</span><span class="bound">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">s2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
      return_spmf <span class="main">(</span><span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">d2</span><span class="main">,</span> <span class="bound">e2</span><span class="main">)</span><span class="main">,</span> <span class="bound">s1</span><span class="main">,</span> <span class="bound">s2</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_map_spmf o_def Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">b</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>
      <span class="bound">e2</span> <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>
      <span class="bound">s1</span> <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">s2</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">s1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">d2</span> <span class="main">=</span> <span class="main">(</span><span class="bound">e2</span><span class="main">*</span><span class="bound">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">s2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
      return_spmf <span class="main">(</span><span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">d2</span><span class="main">,</span> <span class="bound">e2</span><span class="main">)</span><span class="main">,</span> <span class="bound">s1</span><span class="main">,</span> <span class="bound">s2</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> samp_uni_minus_one_time_pad<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">b</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>
      <span class="bound">e2</span> <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>
      <span class="bound">s1</span> <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">s2</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">s1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">d2</span> <span class="main">=</span> <span class="main">(</span><span class="bound">e2</span><span class="main">*</span><span class="bound">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">s2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
      return_spmf <span class="main">(</span><span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">d2</span><span class="main">,</span> <span class="bound">e2</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">s2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">,</span> <span class="bound">s2</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s1_P2 assms Let_def <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> bind_spmf_cong_simp<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> funct_def Let_def sim_non_det_def.Ideal2_def Out2_def S2_def R2_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sim_non_det_def.perfect_sec_P2_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> s1_s2_P1<span class="main">:</span>  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xa</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xb</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xc</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">xa</span><span class="main">,</span> <span class="free">xb</span><span class="main">,</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">xc</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">xc</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">xb</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">*</span> <span class="free">xc</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">xa</span> <span class="main">*</span> <span class="free">xc</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">xb</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> 
         <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">xa</span><span class="main">,</span> <span class="free">xb</span><span class="main">,</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">xc</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">xc</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">xb</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">,</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">xc</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">xb</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms s1_s2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> mod_minus<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">-</span> <span class="free">b</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">-</span> <span class="free">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">c</span> <span class="main">-</span> <span class="free">d</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">c</span> <span class="main">-</span> <span class="free">d</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cong_def minus_mod mod_add_right_eq zero_less_diff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> r<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> e1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">e1</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">s1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s1 b 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mod_add_left_eq mod_mult_right_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> s1_dist<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> distrib_left<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> e1  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mod_add_left_eq mod_mult_right_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> distrib_left<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> distrib_left b diff_mult_distrib2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span>  <span class="main">-</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">‚àÄ</span><span class="bound">n</span> <span class="bound">na</span> <span class="bound">nb</span> <span class="bound">nc</span> <span class="bound">nd</span><span class="main">.</span> <span class="main">(</span><span class="bound">n</span><span class="main">::</span>nat<span class="main">)</span> <span class="keyword1">mod</span> <span class="bound">na</span> <span class="main">‚â†</span> <span class="bound">nb</span> <span class="keyword1">mod</span> <span class="bound">na</span> <span class="main">‚à®</span> <span class="bound">nc</span> <span class="keyword1">mod</span> <span class="bound">na</span> <span class="main">‚â†</span> <span class="bound">nd</span> <span class="keyword1">mod</span> <span class="bound">na</span> <span class="main">‚à®</span> <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="bound">nc</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="bound">na</span> <span class="main">=</span> <span class="main">(</span><span class="bound">nb</span> <span class="main">+</span> <span class="bound">nd</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="bound">na</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> mod_add_cong<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="free">q</span> <span class="main">*</span> <span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">*</span> <span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Nat.diff_add_assoc mod_le_divisor q_gt_0 mod_mult_self4<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> f1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span>  <span class="main">-</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span>
         <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span><span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> True Nat.add_diff_assoc add.left_neutral 
            cong_def diff_le_self minus_mod mult_is_0 not_gr_zero zero_eq_add_iff_both_eq_0 zero_less_diff<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> qb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">-</span> <span class="free">b</span> <span class="main">‚â§</span> <span class="free">q</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> b <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> qb'<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult_less_le_imp_less nat_0_less_mult_iff nat_less_le neq0_conv<span class="main">)</span>   
      <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> False assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">&gt;</span> <span class="free">x</span><span class="main">*</span><span class="free">y</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_strict_mono q_gt_0 x y<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">&gt;</span> <span class="free">x</span><span class="main">*</span><span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_strict_mono q_gt_0 x y<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> 1 qb' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> a b mod_minus<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">*</span><span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> add.left_neutral cong_def gr0I minus_mod zero_less_diff<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> b <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">-</span> <span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">-</span> <span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True d <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> qb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">-</span> <span class="free">b</span> <span class="main">‚â§</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> qb'<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span>"</span></span>  
      <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult_less_le_imp_less nat_0_less_mult_iff nat_less_le neq0_conv<span class="main">)</span>   
    <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">&gt;</span> <span class="free">x</span><span class="main">*</span><span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_strict_mono q_gt_0 x y<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">&gt;</span> <span class="free">x</span><span class="main">*</span><span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_strict_mono q_gt_0 x y<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span>  <span class="main">-</span> <span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">-</span> <span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 qb' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> b d 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Nat.add_diff_assoc add.assoc diff_diff_left less_imp_le_nat zero_less_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main">*</span><span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">-</span> <span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">*</span><span class="free">b</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">+</span> <span class="skolem">n</span> <span class="main">-</span> <span class="free">b</span> <span class="main">=</span> <span class="free">q</span> <span class="main">-</span> <span class="free">b</span> <span class="main">+</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> less_imp_le<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">*</span> <span class="skolem">b</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">*</span> <span class="skolem">a</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">c</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">+</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">n</span>"</span></span> 
        <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distrib_left<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">+</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">c</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">-</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">q</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">*</span> <span class="free">q</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">*</span> <span class="free">q</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="free">q</span> <span class="main">+</span> <span class="free">y</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="free">q</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">*</span> <span class="free">q</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">*</span> <span class="free">q</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> add.commute 1 2<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute diff_mult_distrib2 distrib_left<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> e <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> diff_mult_distrib2<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> <span class="main">(</span><span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> <span class="main">(</span><span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">q</span> <span class="main">+</span> <span class="free">r</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Nat.diff_add_assoc2 less_imp_le<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> <span class="main">(</span><span class="free">q</span><span class="main">*</span><span class="free">q</span> <span class="main">+</span> <span class="free">q</span><span class="main">*</span><span class="free">q</span>  <span class="main">+</span> <span class="free">r</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> <span class="free">r</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute distrib_right mod_mult_self1<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_P2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="free">r</span><span class="main">,</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">,</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span>
              <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">,</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">,</span>     
                      <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="free">r</span>"</span></span> 
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms secure_mult.r secure_mult_axioms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> P1_security<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sim_non_det_def.perfect_sec_P1 <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">including</span></span> monad_normalisation
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>funct <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="main">(</span><span class="bound">s1'</span><span class="main">,</span><span class="bound">s2'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>sim_non_det_def.Ideal1 <span class="free">x</span> <span class="free">y</span> <span class="bound">s1'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> R1 <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"R1 <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">a</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>  
    <span class="bound">b</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>
    <span class="bound">r</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>    
    <span class="keyword1">let</span> <span class="bound">c1</span> <span class="main">=</span> <span class="bound">a</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">d1</span> <span class="main">=</span> <span class="bound">r</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">c2</span> <span class="main">=</span> <span class="bound">b</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">d2</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="bound">a</span><span class="main">*</span><span class="bound">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e2</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="bound">c1</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e1</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">c2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">s1</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="bound">e1</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">d1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">s2</span> <span class="main">=</span> <span class="main">(</span><span class="bound">e2</span> <span class="main">*</span> <span class="bound">c2</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">d2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">c1</span><span class="main">,</span> <span class="bound">d1</span><span class="main">,</span> <span class="bound">e1</span><span class="main">)</span><span class="main">,</span> <span class="bound">s1</span><span class="main">,</span> <span class="bound">s2</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R1_def TI_def Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">a</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>  
    <span class="bound">b</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>
    <span class="bound">r</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>    
    <span class="keyword1">let</span> <span class="bound">c1</span> <span class="main">=</span> <span class="bound">a</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">c2</span> <span class="main">=</span> <span class="bound">b</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e1</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">s1</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">d1</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="bound">e1</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">s1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">c1</span><span class="main">,</span> <span class="bound">d1</span><span class="main">,</span> <span class="bound">e1</span><span class="main">)</span><span class="main">,</span> <span class="bound">s1</span><span class="main">,</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">s1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def assms s1_s2_P1  r_P2 <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> bind_spmf_cong_simp<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">a</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>  
    <span class="bound">b</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">c1</span> <span class="main">=</span> <span class="bound">a</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">c2</span> <span class="main">=</span> <span class="bound">b</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e1</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
    <span class="bound">s1</span> <span class="main">‚Üê</span> map_spmf <span class="main">(</span><span class="main">Œª</span> <span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span>sample_uniform <span class="free">q</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">d1</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="bound">e1</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">s1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">c1</span><span class="main">,</span> <span class="bound">d1</span><span class="main">,</span> <span class="bound">e1</span><span class="main">)</span><span class="main">,</span> <span class="bound">s1</span><span class="main">,</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">s1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_map_spmf Let_def o_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">a</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>  
    <span class="bound">b</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">c1</span> <span class="main">=</span> <span class="bound">a</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">c2</span> <span class="main">=</span> <span class="bound">b</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e1</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
    <span class="bound">s1</span> <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">d1</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="bound">e1</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">s1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">c1</span><span class="main">,</span> <span class="bound">d1</span><span class="main">,</span> <span class="bound">e1</span><span class="main">)</span><span class="main">,</span> <span class="bound">s1</span><span class="main">,</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">s1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> samp_uni_minus_one_time_pad<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">a</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>  
    <span class="keyword1">let</span> <span class="bound">c1</span> <span class="main">=</span> <span class="bound">a</span><span class="main">;</span>
    <span class="bound">e1</span> <span class="main">‚Üê</span> map_spmf <span class="main">(</span><span class="main">Œª</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span>sample_uniform <span class="free">q</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">s1</span> <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">d1</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="bound">e1</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">s1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">c1</span><span class="main">,</span> <span class="bound">d1</span><span class="main">,</span> <span class="bound">e1</span><span class="main">)</span><span class="main">,</span> <span class="bound">s1</span><span class="main">,</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">s1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_map_spmf Let_def o_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">a</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>  
    <span class="keyword1">let</span> <span class="bound">c1</span> <span class="main">=</span> <span class="bound">a</span><span class="main">;</span>
    <span class="bound">e1</span> <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>
    <span class="bound">s1</span> <span class="main">‚Üê</span> sample_uniform <span class="free">q</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">d1</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="bound">e1</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">s1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">c1</span><span class="main">,</span> <span class="bound">d1</span><span class="main">,</span> <span class="bound">e1</span><span class="main">)</span><span class="main">,</span> <span class="bound">s1</span><span class="main">,</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="bound">s1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span><span class="main">}</span>"</span></span>      
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> samp_uni_minus_one_time_pad<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> funct_def sim_non_det_def.Ideal1_def Let_def R1_def TI_def Out1_def S1_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sim_non_det_def.perfect_sec_P1_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> secure_mult_asymp <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">q</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">‚áí</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">‚ãÄ</span> <span class="bound">n</span><span class="main">.</span> secure_mult <span class="main">(</span><span class="free">q</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> secure_mult <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">n</span> 
  <span class="keyword1"><span class="command">using</span></span> secure_mult_asymp_axioms secure_mult_asymp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">theorem</span></span> P1_secure<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">q</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&lt;</span> <span class="free">q</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sim_non_det_def.perfect_sec_P1 <span class="free">n</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> P1_security assms<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> P2_secure<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">q</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&lt;</span> <span class="free">q</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sim_non_det_def.perfect_sec_P2 <span class="free">n</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> P2_security assms<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span> 

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="DH_Ext">
<div class="head">
<h1>Theory DH_Ext</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπDHH Extension‚Ä∫</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπWe define a variant of the DDH assumption and show it is as hard as the original DDH assumption.‚Ä∫</span></span>

<span class="keyword1"><span class="command">theory</span></span> DH_Ext <span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../Game_Based_Crypto/Diffie_Hellman.html">Game_Based_Crypto.Diffie_Hellman</a>
  <a href="Cyclic_Group_Ext.html">Cyclic_Group_Ext</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> ddh <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">DDH0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'grp</span> adversary <span class="main">‚áí</span> bool spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">DDH0</span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">s</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">r</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">h</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">s</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span> <span class="bound">h</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="bound">h</span> <span class="main">[^]</span> <span class="bound">r</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">DDH1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'grp</span> adversary <span class="main">‚áí</span> bool spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">DDH1</span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">s</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">r</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">h</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">s</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span> <span class="bound">h</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="bound">h</span> <span class="main">[^]</span> <span class="bound">r</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">DDH_advantage</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'grp</span> adversary <span class="main">‚áí</span> real"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">DDH_advantage</span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span> <span class="main">=</span> <span class="main">¬¶</span>spmf <span class="main">(</span>DDH0 <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span><span class="main">)</span> True <span class="main">-</span> spmf <span class="main">(</span>DDH1 <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span><span class="main">)</span> True<span class="main">¬¶</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">DDH_ùíú'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'grp</span> adversary <span class="main">‚áí</span> <span class="tfree">'grp</span> <span class="main">‚áí</span> <span class="tfree">'grp</span> <span class="main">‚áí</span> <span class="tfree">'grp</span> <span class="main">‚áí</span> bool spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">DDH_ùíú'</span> <span class="free"><span class="bound"><span class="entity">D_ddh</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">D_ddh</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span> 

<span class="keyword1"><span class="command">locale</span></span> ddh_ext <span class="main">=</span> ddh <span class="main">+</span> cyclic_group <span class="quoted"><span class="free">ùí¢</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> DDH0_eq_ddh_0<span class="main">:</span> <span class="quoted"><span class="quoted">"ddh.DDH0 <span class="free">ùí¢</span> <span class="free">ùíú</span> <span class="main">=</span> ddh.ddh_0 <span class="free">ùí¢</span> <span class="free">ùíú</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ddh.DDH0_def Let_def monoid.nat_pow_pow ddh.ddh_0_def<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> DDH_bound1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬¶</span>spmf <span class="main">(</span>ddh.DDH0 <span class="free">ùí¢</span> <span class="free">ùíú</span><span class="main">)</span> True <span class="main">-</span> spmf <span class="main">(</span>ddh.DDH1 <span class="free">ùí¢</span> <span class="free">ùíú</span><span class="main">)</span> True<span class="main">¬¶</span> 
                        <span class="main">‚â§</span> <span class="main">¬¶</span>spmf <span class="main">(</span>ddh.ddh_0 <span class="free">ùí¢</span> <span class="free">ùíú</span><span class="main">)</span> True <span class="main">-</span> spmf <span class="main">(</span>ddh.ddh_1 <span class="free">ùí¢</span> <span class="free">ùíú</span><span class="main">)</span> True<span class="main">¬¶</span> 
                              <span class="main">+</span> <span class="main">¬¶</span>spmf <span class="main">(</span>ddh.ddh_1 <span class="free">ùí¢</span> <span class="free">ùíú</span><span class="main">)</span> True <span class="main">-</span> spmf <span class="main">(</span>ddh.DDH1 <span class="free">ùí¢</span> <span class="free">ùíú</span><span class="main">)</span> True<span class="main">¬¶</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_diff_triangle_ineq2 DDH0_eq_ddh_0<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> DDH_bound2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬¶</span>spmf <span class="main">(</span>ddh.DDH0 <span class="free">ùí¢</span> <span class="free">ùíú</span><span class="main">)</span> True <span class="main">-</span> spmf <span class="main">(</span>ddh.DDH1 <span class="free">ùí¢</span> <span class="free">ùíú</span><span class="main">)</span> True<span class="main">¬¶</span> 
               <span class="main">‚â§</span> ddh.advantage <span class="free">ùí¢</span> <span class="free">ùíú</span> <span class="main">+</span> <span class="main">¬¶</span>spmf <span class="main">(</span>ddh.ddh_1 <span class="free">ùí¢</span> <span class="free">ùíú</span><span class="main">)</span> True <span class="main">-</span> spmf <span class="main">(</span>ddh.DDH1 <span class="free">ùí¢</span> <span class="free">ùíú</span><span class="main">)</span> True<span class="main">¬¶</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> advantage_def DDH_bound1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> rewrite<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span> 
            <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">y</span><span class="main">.</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">z</span><span class="main">.</span> <span class="free">ùíú</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">z</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
              <span class="main">=</span> <span class="main">(</span>sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span> 
                <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">y</span><span class="main">.</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">z</span><span class="main">.</span> <span class="free">ùíú</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
   <span class="bound">x</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
   <span class="bound">y</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
   <span class="bound">c</span> <span class="main">‚Üê</span> map_spmf <span class="main">(</span><span class="main">Œª</span> <span class="bound">z</span><span class="main">.</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">z</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span><span class="main">)</span> <span class="main">(</span>sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
   <span class="free">ùíú</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">y</span><span class="main">)</span> <span class="bound">c</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def bind_map_spmf Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
   <span class="bound">x</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
   <span class="bound">y</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
   <span class="bound">c</span> <span class="main">‚Üê</span> map_spmf <span class="main">(</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
   <span class="free">ùíú</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">y</span><span class="main">)</span> <span class="bound">c</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sample_uniform_one_time_pad<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def bind_map_spmf o_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> DDH_ùíú'_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"ddh.advantage <span class="free">ùí¢</span> <span class="main">(</span>ddh.DDH_ùíú' <span class="free">ùí¢</span> <span class="free">ùíú</span><span class="main">)</span> <span class="main">=</span> <span class="main">¬¶</span>spmf <span class="main">(</span>ddh.ddh_1 <span class="free">ùí¢</span> <span class="free">ùíú</span><span class="main">)</span> True <span class="main">-</span> spmf <span class="main">(</span>ddh.DDH1 <span class="free">ùí¢</span> <span class="free">ùíú</span><span class="main">)</span> True<span class="main">¬¶</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ddh.advantage_def ddh.ddh_1_def ddh.DDH1_def Let_def ddh.DDH_ùíú'_def ddh.ddh_0_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rewrite abs_minus_commute nat_pow_pow<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> DDH_advantage_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"ddh.DDH_advantage <span class="free">ùí¢</span> <span class="free">ùíú</span> <span class="main">‚â§</span> ddh.advantage <span class="free">ùí¢</span> <span class="free">ùíú</span> <span class="main">+</span> ddh.advantage <span class="free">ùí¢</span> <span class="main">(</span>ddh.DDH_ùíú' <span class="free">ùí¢</span> <span class="free">ùíú</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> DDH_bound2 DDH_ùíú'_bound DDH_advantage_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span> 

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Malicious_Defs">
<div class="head">
<h1>Theory Malicious_Defs</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‚ÄπMalicious Security‚Ä∫</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπHere we define security in the malicious security setting. We follow the definitions given in 
\cite{DBLP:series/isc/HazayL10} and \cite{DBLP:books/cu/Goldreich2004}. The definition of malicious security 
follows the real/ideal world paradigm.‚Ä∫</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπMalicious Security Definitions‚Ä∫</span></span>

<span class="keyword1"><span class="command">theory</span></span> Malicious_Defs <span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../CryptHOL/CryptHOL.html">CryptHOL.CryptHOL</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'in1'</span><span class="main">,</span><span class="tfree">'aux'</span><span class="main">,</span> <span class="tfree">'P1_S1_aux'</span><span class="main">)</span> P1_ideal_adv1 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'in1'</span> <span class="main">‚áí</span> <span class="tfree">'aux'</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'in1'</span> <span class="main">√ó</span> <span class="tfree">'P1_S1_aux'</span><span class="main">)</span> spmf"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'in1'</span><span class="main">,</span> <span class="tfree">'aux'</span><span class="main">,</span> <span class="tfree">'out1'</span><span class="main">,</span> <span class="tfree">'P1_S1_aux'</span><span class="main">,</span> <span class="tfree">'adv_out1'</span><span class="main">)</span> P1_ideal_adv2 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'in1'</span> <span class="main">‚áí</span> <span class="tfree">'aux'</span> <span class="main">‚áí</span> <span class="tfree">'out1'</span> <span class="main">‚áí</span> <span class="tfree">'P1_S1_aux'</span> <span class="main">‚áí</span> <span class="tfree">'adv_out1'</span> spmf"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'in1'</span><span class="main">,</span> <span class="tfree">'aux'</span><span class="main">,</span> <span class="tfree">'out1'</span><span class="main">,</span> <span class="tfree">'P1_S1_aux'</span><span class="main">,</span> <span class="tfree">'adv_out1'</span><span class="main">)</span> P1_ideal_adv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'in1'</span><span class="main">,</span><span class="tfree">'aux'</span><span class="main">,</span> <span class="tfree">'P1_S1_aux'</span><span class="main">)</span> P1_ideal_adv1 <span class="main">√ó</span> <span class="main">(</span><span class="tfree">'in1'</span><span class="main">,</span> <span class="tfree">'aux'</span><span class="main">,</span> <span class="tfree">'out1'</span><span class="main">,</span> <span class="tfree">'P1_S1_aux'</span><span class="main">,</span> <span class="tfree">'adv_out1'</span><span class="main">)</span> P1_ideal_adv2"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'P1_real_adv'</span><span class="main">,</span> <span class="tfree">'in1'</span><span class="main">,</span> <span class="tfree">'aux'</span><span class="main">,</span> <span class="tfree">'P1_S1_aux'</span><span class="main">)</span> P1_sim1 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'P1_real_adv'</span> <span class="main">‚áí</span> <span class="tfree">'in1'</span> <span class="main">‚áí</span> <span class="tfree">'aux'</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'in1'</span> <span class="main">√ó</span> <span class="tfree">'P1_S1_aux'</span><span class="main">)</span> spmf"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'P1_real_adv'</span><span class="main">,</span> <span class="tfree">'in1'</span><span class="main">,</span> <span class="tfree">'aux'</span><span class="main">,</span> <span class="tfree">'out1'</span><span class="main">,</span> <span class="tfree">'P1_S1_aux'</span><span class="main">,</span> <span class="tfree">'adv_out1'</span><span class="main">)</span> P1_sim2 
                  <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'P1_real_adv'</span> <span class="main">‚áí</span> <span class="tfree">'in1'</span> <span class="main">‚áí</span> <span class="tfree">'aux'</span> <span class="main">‚áí</span> <span class="tfree">'out1'</span> 
                      <span class="main">‚áí</span> <span class="tfree">'P1_S1_aux'</span> <span class="main">‚áí</span> <span class="tfree">'adv_out1'</span> spmf"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'P1_real_adv'</span><span class="main">,</span> <span class="tfree">'in1'</span><span class="main">,</span> <span class="tfree">'aux'</span><span class="main">,</span> <span class="tfree">'out1'</span><span class="main">,</span> <span class="tfree">'P1_S1_aux'</span><span class="main">,</span> <span class="tfree">'adv_out1'</span><span class="main">)</span> P1_sim  
                <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'P1_real_adv'</span><span class="main">,</span> <span class="tfree">'in1'</span><span class="main">,</span> <span class="tfree">'aux'</span><span class="main">,</span> <span class="tfree">'P1_S1_aux'</span><span class="main">)</span> P1_sim1 
                    <span class="main">√ó</span> <span class="main">(</span><span class="tfree">'P1_real_adv'</span><span class="main">,</span> <span class="tfree">'in1'</span><span class="main">,</span> <span class="tfree">'aux'</span><span class="main">,</span> <span class="tfree">'out1'</span><span class="main">,</span> <span class="tfree">'P1_S1_aux'</span><span class="main">,</span> <span class="tfree">'adv_out1'</span><span class="main">)</span> P1_sim2<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'in2'</span><span class="main">,</span><span class="tfree">'aux'</span><span class="main">,</span> <span class="tfree">'P2_S2_aux'</span><span class="main">)</span> P2_ideal_adv1 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'in2'</span> <span class="main">‚áí</span> <span class="tfree">'aux'</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'in2'</span> <span class="main">√ó</span> <span class="tfree">'P2_S2_aux'</span><span class="main">)</span> spmf"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'in2'</span><span class="main">,</span> <span class="tfree">'aux'</span><span class="main">,</span> <span class="tfree">'out2'</span><span class="main">,</span> <span class="tfree">'P2_S2_aux'</span><span class="main">,</span> <span class="tfree">'adv_out2'</span><span class="main">)</span> P2_ideal_adv2 
                <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'in2'</span> <span class="main">‚áí</span> <span class="tfree">'aux'</span> <span class="main">‚áí</span> <span class="tfree">'out2'</span> <span class="main">‚áí</span> <span class="tfree">'P2_S2_aux'</span> <span class="main">‚áí</span> <span class="tfree">'adv_out2'</span> spmf"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'in2'</span><span class="main">,</span> <span class="tfree">'aux'</span><span class="main">,</span> <span class="tfree">'out2'</span><span class="main">,</span> <span class="tfree">'P2_S2_aux'</span><span class="main">,</span> <span class="tfree">'adv_out2'</span><span class="main">)</span> P2_ideal_adv 
                    <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'in2'</span><span class="main">,</span><span class="tfree">'aux'</span><span class="main">,</span> <span class="tfree">'P2_S2_aux'</span><span class="main">)</span> P2_ideal_adv1 
                        <span class="main">√ó</span> <span class="main">(</span><span class="tfree">'in2'</span><span class="main">,</span> <span class="tfree">'aux'</span><span class="main">,</span> <span class="tfree">'out2'</span><span class="main">,</span> <span class="tfree">'P2_S2_aux'</span><span class="main">,</span> <span class="tfree">'adv_out2'</span><span class="main">)</span> P2_ideal_adv2"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'P2_real_adv'</span><span class="main">,</span> <span class="tfree">'in2'</span><span class="main">,</span> <span class="tfree">'aux'</span><span class="main">,</span> <span class="tfree">'P2_S2_aux'</span><span class="main">)</span> P2_sim1 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'P2_real_adv'</span> <span class="main">‚áí</span> <span class="tfree">'in2'</span> <span class="main">‚áí</span> <span class="tfree">'aux'</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'in2'</span> <span class="main">√ó</span> <span class="tfree">'P2_S2_aux'</span><span class="main">)</span> spmf"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'P2_real_adv'</span><span class="main">,</span> <span class="tfree">'in2'</span><span class="main">,</span> <span class="tfree">'aux'</span><span class="main">,</span> <span class="tfree">'out2'</span><span class="main">,</span> <span class="tfree">'P2_S2_aux'</span><span class="main">,</span> <span class="tfree">'adv_out2'</span><span class="main">)</span> P2_sim2 
                  <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'P2_real_adv'</span> <span class="main">‚áí</span> <span class="tfree">'in2'</span> <span class="main">‚áí</span> <span class="tfree">'aux'</span> <span class="main">‚áí</span> <span class="tfree">'out2'</span> 
                      <span class="main">‚áí</span> <span class="tfree">'P2_S2_aux'</span> <span class="main">‚áí</span> <span class="tfree">'adv_out2'</span> spmf"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'P2_real_adv'</span><span class="main">,</span> <span class="tfree">'in2'</span><span class="main">,</span> <span class="tfree">'aux'</span><span class="main">,</span> <span class="tfree">'out2'</span><span class="main">,</span> <span class="tfree">'P2_S2_aux'</span><span class="main">,</span> <span class="tfree">'adv_out2'</span><span class="main">)</span> P2_sim 
                  <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'P2_real_adv'</span><span class="main">,</span> <span class="tfree">'in2'</span><span class="main">,</span> <span class="tfree">'aux'</span><span class="main">,</span> <span class="tfree">'P2_S2_aux'</span><span class="main">)</span> P2_sim1 
                      <span class="main">√ó</span> <span class="main">(</span><span class="tfree">'P2_real_adv'</span><span class="main">,</span> <span class="tfree">'in2'</span><span class="main">,</span> <span class="tfree">'aux'</span><span class="main">,</span> <span class="tfree">'out2'</span><span class="main">,</span> <span class="tfree">'P2_S2_aux'</span><span class="main">,</span> <span class="tfree">'adv_out2'</span><span class="main">)</span> P2_sim2<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> malicious_base <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">funct</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'in1</span> <span class="main">‚áí</span> <span class="tfree">'in2</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'out1</span> <span class="main">√ó</span> <span class="tfree">'out2</span><span class="main">)</span> spmf"</span></span> <span class="comment1">‚Äï ‚Äπthe functionality‚Ä∫</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">protocol</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'in1</span> <span class="main">‚áí</span> <span class="tfree">'in2</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'out1</span> <span class="main">√ó</span> <span class="tfree">'out2</span><span class="main">)</span> spmf"</span></span> <span class="comment1">‚Äï ‚Äπoutputs the output of each party in the protocol‚Ä∫</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">S1_1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'P1_real_adv</span><span class="main">,</span> <span class="tfree">'in1</span><span class="main">,</span> <span class="tfree">'aux</span><span class="main">,</span> <span class="tfree">'P1_S1_aux</span><span class="main">)</span> P1_sim1"</span></span> <span class="comment1">‚Äï ‚Äπfirst part of the simulator for party 1‚Ä∫</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">S1_2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'P1_real_adv</span><span class="main">,</span> <span class="tfree">'in1</span><span class="main">,</span> <span class="tfree">'aux</span><span class="main">,</span> <span class="tfree">'out1</span><span class="main">,</span> <span class="tfree">'P1_S1_aux</span><span class="main">,</span> <span class="tfree">'adv_out1</span><span class="main">)</span> P1_sim2"</span></span> <span class="comment1">‚Äï ‚Äπsecond part of the simulator for party 1‚Ä∫</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">P1_real_view</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'in1</span> <span class="main">‚áí</span> <span class="tfree">'in2</span> <span class="main">‚áí</span> <span class="tfree">'aux</span> <span class="main">‚áí</span> <span class="tfree">'P1_real_adv</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'adv_out1</span> <span class="main">√ó</span> <span class="tfree">'out2</span><span class="main">)</span> spmf"</span></span> <span class="comment1">‚Äï ‚Äπreal view for party 1, the adversary totally controls party 1‚Ä∫</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">S2_1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'P2_real_adv</span><span class="main">,</span> <span class="tfree">'in2</span><span class="main">,</span> <span class="tfree">'aux</span><span class="main">,</span> <span class="tfree">'P2_S2_aux</span><span class="main">)</span> P2_sim1"</span></span> <span class="comment1">‚Äï ‚Äπfirst part of the simulator for party 2‚Ä∫</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">S2_2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'P2_real_adv</span><span class="main">,</span> <span class="tfree">'in2</span><span class="main">,</span> <span class="tfree">'aux</span><span class="main">,</span> <span class="tfree">'out2</span><span class="main">,</span> <span class="tfree">'P2_S2_aux</span><span class="main">,</span> <span class="tfree">'adv_out2</span><span class="main">)</span> P2_sim2"</span></span> <span class="comment1">‚Äï ‚Äπsecond part of the simulator for party 1‚Ä∫</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">P2_real_view</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'in1</span> <span class="main">‚áí</span> <span class="tfree">'in2</span> <span class="main">‚áí</span> <span class="tfree">'aux</span> <span class="main">‚áí</span> <span class="tfree">'P2_real_adv</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'out1</span> <span class="main">√ó</span> <span class="tfree">'adv_out2</span><span class="main">)</span> spmf"</span></span> <span class="comment1">‚Äï ‚Äπreal view for party 2, the adversary totally controls party 2‚Ä∫</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">correct</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">‚ü∑</span> <span class="main">(</span><span class="free">protocol</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">=</span> <span class="free">funct</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">trusted_party</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">‚â°</span> <span class="free">funct</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‚ÄπThe ideal game defines the ideal world. First we consider the case where party 1 is corrupt, and thus 
controlled by the adversary. The adversary is split into two parts, the first part takes the original input and 
auxillary information and outputs its input to the protocol. The trusted party then computes the functionality on
the input given by the adversary and the correct input for party 2. Party 2 outputs the its correct output as
given by the trusted party, the adversary provides the output for party 1.‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ideal_game_1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'in1</span> <span class="main">‚áí</span> <span class="tfree">'in2</span> <span class="main">‚áí</span> <span class="tfree">'aux</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'in1</span><span class="main">,</span> <span class="tfree">'aux</span><span class="main">,</span> <span class="tfree">'out1</span><span class="main">,</span> <span class="tfree">'P1_S1_aux</span><span class="main">,</span> <span class="tfree">'adv_out1</span><span class="main">)</span> P1_ideal_adv <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'adv_out1</span> <span class="main">√ó</span> <span class="tfree">'out2</span><span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ideal_game_1</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">A1</span><span class="main">,</span><span class="bound">A2</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">;</span>
    <span class="main">(</span><span class="bound">x'</span><span class="main">,</span> <span class="bound">aux_out</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="bound">A1</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">;</span>
    <span class="main">(</span><span class="bound">out1</span><span class="main">,</span> <span class="bound">out2</span><span class="main">)</span> <span class="main">‚Üê</span> trusted_party <span class="bound">x'</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span> 
    <span class="bound">out1'</span> <span class="main">::</span> <span class="tfree">'adv_out1</span> <span class="main">‚Üê</span> <span class="bound">A2</span> <span class="bound">x'</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="bound">out1</span> <span class="bound">aux_out</span><span class="main">;</span> 
    return_spmf <span class="main">(</span><span class="bound">out1'</span><span class="main">,</span> <span class="bound">out2</span><span class="main">)</span><span class="main">}</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ideal_view_1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'in1</span> <span class="main">‚áí</span> <span class="tfree">'in2</span> <span class="main">‚áí</span> <span class="tfree">'aux</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'P1_real_adv</span><span class="main">,</span> <span class="tfree">'in1</span><span class="main">,</span> <span class="tfree">'aux</span><span class="main">,</span> <span class="tfree">'out1</span><span class="main">,</span> <span class="tfree">'P1_S1_aux</span><span class="main">,</span> <span class="tfree">'adv_out1</span><span class="main">)</span> P1_sim <span class="main">‚áí</span> <span class="tfree">'P1_real_adv</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'adv_out1</span> <span class="main">√ó</span> <span class="tfree">'out2</span><span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ideal_view_1</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">S1</span><span class="main">,</span> <span class="bound">S2</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="keyword1">in</span> <span class="main">(</span>ideal_game_1 <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">(</span><span class="bound">S1</span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span><span class="main">,</span> <span class="bound">S2</span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‚ÄπWe have information theoretic security when the real and ideal views are equal.‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">perfect_sec_P1</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span> <span class="main">‚ü∑</span> <span class="main">(</span>ideal_view_1 <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span> <span class="main">=</span> <span class="free">P1_real_view</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‚ÄπThe advantage of party 1 denotes the probability of a distinguisher distinguishing the real and 
ideal views.‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">adv_P1</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'adv_out1</span> <span class="main">√ó</span> <span class="tfree">'out2</span><span class="main">)</span> <span class="main">‚áí</span> bool spmf<span class="main">)</span> <span class="main">=</span> 
                <span class="main">¬¶</span>spmf <span class="main">(</span><span class="free">P1_real_view</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="bound">view</span><span class="main">)</span><span class="main">)</span> True
                    <span class="main">-</span> spmf <span class="main">(</span>ideal_view_1 <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="bound">view</span><span class="main">)</span><span class="main">)</span> True <span class="main">¬¶</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ideal_game_2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'in1</span> <span class="main">‚áí</span> <span class="tfree">'in2</span> <span class="main">‚áí</span> <span class="tfree">'aux</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'in2</span><span class="main">,</span> <span class="tfree">'aux</span><span class="main">,</span> <span class="tfree">'out2</span><span class="main">,</span> <span class="tfree">'P2_S2_aux</span><span class="main">,</span> <span class="tfree">'adv_out2</span><span class="main">)</span> P2_ideal_adv <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'out1</span> <span class="main">√ó</span> <span class="tfree">'adv_out2</span><span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ideal_game_2</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">A1</span><span class="main">,</span><span class="bound">A2</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">;</span>
    <span class="main">(</span><span class="bound">y'</span><span class="main">,</span> <span class="bound">aux_out</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="bound">A1</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">;</span> 
    <span class="main">(</span><span class="bound">out1</span><span class="main">,</span> <span class="bound">out2</span><span class="main">)</span> <span class="main">‚Üê</span> trusted_party <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">y'</span><span class="main">;</span>
    <span class="bound">out2'</span> <span class="main">::</span> <span class="tfree">'adv_out2</span> <span class="main">‚Üê</span> <span class="bound">A2</span> <span class="bound">y'</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="bound">out2</span> <span class="bound">aux_out</span><span class="main">;</span> 
    return_spmf <span class="main">(</span><span class="bound">out1</span><span class="main">,</span> <span class="bound">out2'</span><span class="main">)</span><span class="main">}</span>"</span></span>   

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ideal_view_2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'in1</span> <span class="main">‚áí</span> <span class="tfree">'in2</span> <span class="main">‚áí</span> <span class="tfree">'aux</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'P2_real_adv</span><span class="main">,</span> <span class="tfree">'in2</span><span class="main">,</span> <span class="tfree">'aux</span><span class="main">,</span> <span class="tfree">'out2</span><span class="main">,</span> <span class="tfree">'P2_S2_aux</span><span class="main">,</span> <span class="tfree">'adv_out2</span><span class="main">)</span> P2_sim <span class="main">‚áí</span> <span class="tfree">'P2_real_adv</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'out1</span> <span class="main">√ó</span> <span class="tfree">'adv_out2</span><span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ideal_view_2</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">S1</span><span class="main">,</span> <span class="bound">S2</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="keyword1">in</span> <span class="main">(</span>ideal_game_2 <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">(</span><span class="bound">S1</span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span><span class="main">,</span> <span class="bound">S2</span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">perfect_sec_P2</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span> <span class="main">‚ü∑</span> <span class="main">(</span>ideal_view_2 <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span> <span class="main">=</span> <span class="free">P2_real_view</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">adv_P2</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'out1</span> <span class="main">√ó</span> <span class="tfree">'adv_out2</span><span class="main">)</span> <span class="main">‚áí</span> bool spmf<span class="main">)</span> <span class="main">=</span> 
                <span class="main">¬¶</span>spmf <span class="main">(</span><span class="free">P2_real_view</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="bound">view</span><span class="main">)</span><span class="main">)</span> True
                    <span class="main">-</span> spmf <span class="main">(</span>ideal_view_2 <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="bound">view</span><span class="main">)</span><span class="main">)</span> True <span class="main">¬¶</span>"</span></span> 


<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Malicious_OT">
<div class="head">
<h1>Theory Malicious_OT</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπMalicious OT‚Ä∫</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπHere we prove secure the 1-out-of-2 OT protocol given in \cite{DBLP:series/isc/HazayL10} (p190). 
For party 1 reduce security to the DDH assumption and for party 2 we show information theoretic security.‚Ä∫</span></span>

<span class="keyword1"><span class="command">theory</span></span> Malicious_OT <span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Number_Theory/Cong.html">HOL-Number_Theory.Cong</a>"</span>
  <a href="Cyclic_Group_Ext.html">Cyclic_Group_Ext</a>
  <a href="DH_Ext.html">DH_Ext</a>
  <a href="Malicious_Defs.html">Malicious_Defs</a>  
  <a href="Number_Theory_Aux.html">Number_Theory_Aux</a>
  <a href="OT_Functionalities.html">OT_Functionalities</a>
  <a href="Uniform_Sampling.html">Uniform_Sampling</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'aux</span><span class="main">,</span> <span class="tfree">'grp'</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> adv_1_P1 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'grp'</span> <span class="main">√ó</span> <span class="tfree">'grp'</span><span class="main">)</span> <span class="main">‚áí</span> <span class="tfree">'grp'</span> <span class="main">‚áí</span> <span class="tfree">'grp'</span> <span class="main">‚áí</span> <span class="tfree">'grp'</span> <span class="main">‚áí</span> <span class="tfree">'grp'</span> <span class="main">‚áí</span> <span class="tfree">'grp'</span> <span class="main">‚áí</span> <span class="tfree">'aux</span> <span class="main">‚áí</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'grp'</span> <span class="main">√ó</span> <span class="tfree">'grp'</span> <span class="main">√ó</span> <span class="tfree">'grp'</span><span class="main">)</span> <span class="main">√ó</span> <span class="tfree">'state</span><span class="main">)</span> spmf"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'grp'</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> adv_2_P1 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'grp'</span> <span class="main">‚áí</span> <span class="tfree">'grp'</span> <span class="main">‚áí</span> <span class="tfree">'grp'</span> <span class="main">‚áí</span> <span class="tfree">'grp'</span> <span class="main">‚áí</span> <span class="tfree">'grp'</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'grp'</span> <span class="main">√ó</span> <span class="tfree">'grp'</span><span class="main">)</span> <span class="main">‚áí</span> <span class="tfree">'state</span> <span class="main">‚áí</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="tfree">'grp'</span> <span class="main">√ó</span> <span class="tfree">'grp'</span><span class="main">)</span> <span class="main">√ó</span> <span class="main">(</span><span class="tfree">'grp'</span> <span class="main">√ó</span> <span class="tfree">'grp'</span><span class="main">)</span><span class="main">)</span> <span class="main">√ó</span> <span class="tfree">'state</span><span class="main">)</span> spmf"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'adv_out1</span><span class="main">,</span><span class="tfree">'state</span><span class="main">)</span> adv_3_P1 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">‚áí</span> <span class="tfree">'adv_out1</span> spmf"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'aux</span><span class="main">,</span> <span class="tfree">'grp'</span><span class="main">,</span> <span class="tfree">'adv_out1</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> adv_mal_P1 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'aux</span><span class="main">,</span> <span class="tfree">'grp'</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> adv_1_P1 <span class="main">√ó</span> <span class="main">(</span><span class="tfree">'grp'</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> adv_2_P1 <span class="main">√ó</span> <span class="main">(</span><span class="tfree">'adv_out1</span><span class="main">,</span><span class="tfree">'state</span><span class="main">)</span> adv_3_P1<span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'aux</span><span class="main">,</span> <span class="tfree">'grp'</span><span class="main">,</span><span class="tfree">'state</span><span class="main">)</span> adv_1_P2 <span class="main">=</span> <span class="quoted"><span class="quoted">"bool <span class="main">‚áí</span> <span class="tfree">'aux</span> <span class="main">‚áí</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'grp'</span> <span class="main">√ó</span> <span class="tfree">'grp'</span> <span class="main">√ó</span> <span class="tfree">'grp'</span> <span class="main">√ó</span> <span class="tfree">'grp'</span> <span class="main">√ó</span> <span class="tfree">'grp'</span><span class="main">)</span> <span class="main">√ó</span> <span class="tfree">'state</span><span class="main">)</span> spmf"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'grp'</span><span class="main">,</span><span class="tfree">'state</span><span class="main">)</span> adv_2_P2 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'grp'</span> <span class="main">√ó</span> <span class="tfree">'grp'</span> <span class="main">√ó</span> <span class="tfree">'grp'</span> <span class="main">√ó</span> <span class="tfree">'grp'</span> <span class="main">√ó</span> <span class="tfree">'grp'</span><span class="main">)</span> <span class="main">‚áí</span> <span class="tfree">'state</span> <span class="main">‚áí</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="tfree">'grp'</span> <span class="main">√ó</span> <span class="tfree">'grp'</span> <span class="main">√ó</span> <span class="tfree">'grp'</span><span class="main">)</span> <span class="main">√ó</span> nat<span class="main">)</span> <span class="main">√ó</span> <span class="tfree">'state</span><span class="main">)</span> spmf"</span></span> 

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'grp'</span><span class="main">,</span> <span class="tfree">'adv_out2</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> adv_3_P2 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'grp'</span> <span class="main">√ó</span> <span class="tfree">'grp'</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'grp'</span> <span class="main">√ó</span> <span class="tfree">'grp'</span><span class="main">)</span> <span class="main">‚áí</span> <span class="tfree">'state</span> <span class="main">‚áí</span> <span class="tfree">'adv_out2</span> spmf"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'aux</span><span class="main">,</span> <span class="tfree">'grp'</span><span class="main">,</span> <span class="tfree">'adv_out2</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> adv_mal_P2 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'aux</span><span class="main">,</span> <span class="tfree">'grp'</span><span class="main">,</span><span class="tfree">'state</span><span class="main">)</span> adv_1_P2 <span class="main">√ó</span> <span class="main">(</span><span class="tfree">'grp'</span><span class="main">,</span><span class="tfree">'state</span><span class="main">)</span> adv_2_P2 <span class="main">√ó</span> <span class="main">(</span><span class="tfree">'grp'</span><span class="main">,</span> <span class="tfree">'adv_out2</span><span class="main">,</span><span class="tfree">'state</span><span class="main">)</span> adv_3_P2<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> ot_base <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ùí¢</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'grp</span> cyclic_group"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">structure</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite_group<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>carrier <span class="free">ùí¢</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> order_gt_0<span class="main">:</span> <span class="quoted"><span class="quoted">"order <span class="free">ùí¢</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> prime_order<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prime_field<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="free">a</span> <span class="main">‚â†</span> <span class="main">0</span> <span class="main">‚üπ</span> coprime <span class="free">a</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dvd_imp_le neq0_conv not_le prime_imp_coprime prime_order coprime_commute<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‚ÄπThe protocol uses a call to an idealised functionality of a zero knowledge protocol for the 
DDH relation, this is described by the functionality given below.‚Ä∫</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">funct_DH_ZK</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span><span class="main">)</span> <span class="main">√ó</span> nat<span class="main">)</span>  <span class="main">‚áí</span> <span class="main">(</span>bool <span class="main">√ó</span> unit<span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">funct_DH_ZK</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">h'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b'</span></span></span><span class="main">)</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> return_spmf <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">‚àß</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">[^]</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">‚àß</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b'</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‚ÄπThe probabilistic program that defines the output for both parties in the protocol.‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">protocol_ot</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span><span class="main">)</span> <span class="main">‚áí</span> bool <span class="main">‚áí</span> <span class="main">(</span>unit <span class="main">√ó</span> <span class="tfree">'grp</span><span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">protocol_ot</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="keyword1">let</span> <span class="main">(</span><span class="bound">x0</span><span class="main">,</span><span class="bound">x1</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">;</span>
  <span class="bound">r</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
  <span class="bound">Œ±0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
  <span class="bound">Œ±1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">h0</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">Œ±0</span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">h1</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">Œ±1</span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">r</span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">b0</span> <span class="main">=</span> <span class="bound">h0</span> <span class="main">[^]</span> <span class="bound">r</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span>nat<span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">b1</span> <span class="main">=</span> <span class="bound">h1</span> <span class="main">[^]</span> <span class="bound">r</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span>nat<span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">h</span> <span class="main">=</span> <span class="bound">h0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="bound">h1</span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">b</span> <span class="main">=</span> <span class="bound">b0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="bound">b1</span><span class="main">;</span>
  <span class="main"><span class="bound">_</span></span> <span class="main">::</span> unit <span class="main">‚Üê</span> assert_spmf <span class="main">(</span><span class="bound">a</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">r</span> <span class="main">‚àß</span> <span class="bound">b</span> <span class="main">=</span> <span class="bound">h</span> <span class="main">[^]</span> <span class="bound">r</span><span class="main">)</span><span class="main">;</span>
  <span class="bound">u0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
  <span class="bound">u1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
  <span class="bound">v0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
  <span class="bound">v1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span> 
  <span class="keyword1">let</span> <span class="bound">z0</span> <span class="main">=</span> <span class="bound">b0</span> <span class="main">[^]</span> <span class="bound">u0</span> <span class="main">‚äó</span> <span class="bound">h0</span> <span class="main">[^]</span> <span class="bound">v0</span> <span class="main">‚äó</span> <span class="bound">x0</span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">w0</span> <span class="main">=</span> <span class="bound">a</span> <span class="main">[^]</span> <span class="bound">u0</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">v0</span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">e0</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w0</span><span class="main">,</span> <span class="bound">z0</span><span class="main">)</span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">z1</span> <span class="main">=</span> <span class="main">(</span><span class="bound">b1</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u1</span> <span class="main">‚äó</span> <span class="bound">h1</span> <span class="main">[^]</span> <span class="bound">v1</span> <span class="main">‚äó</span> <span class="bound">x1</span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">w1</span> <span class="main">=</span> <span class="bound">a</span> <span class="main">[^]</span> <span class="bound">u1</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">v1</span><span class="main">;</span>
  <span class="keyword1">let</span> <span class="bound">e1</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w1</span><span class="main">,</span> <span class="bound">z1</span><span class="main">)</span><span class="main">;</span>
  return_spmf <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="bound">z1</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="main">(</span><span class="bound">w1</span> <span class="main">[^]</span> <span class="bound">Œ±1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="bound">z0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="main">(</span><span class="bound">w0</span> <span class="main">[^]</span> <span class="bound">Œ±0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‚ÄπParty 1 sends three messages (including the output) in the protocol so we split the adversary into three parts, one part
to output each message. The real view of the protocol for party 1 outputs the correct output for party 2 
and the adversary outputs the output for party 1.‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">P1_real_model</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span><span class="main">)</span> <span class="main">‚áí</span> bool <span class="main">‚áí</span> <span class="tfree">'aux</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'aux</span><span class="main">,</span> <span class="tfree">'grp</span><span class="main">,</span> <span class="tfree">'adv_out1</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> adv_mal_P1 <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'adv_out1</span> <span class="main">√ó</span> <span class="tfree">'grp</span><span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">P1_real_model</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ùíú1</span><span class="main">,</span> <span class="bound">ùíú2</span><span class="main">,</span> <span class="bound">ùíú3</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span><span class="main">;</span>
    <span class="bound">r</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">Œ±0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">Œ±1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">h0</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">Œ±0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">h1</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">Œ±1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">r</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">b0</span> <span class="main">=</span> <span class="bound">h0</span> <span class="main">[^]</span> <span class="bound">r</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="keyword1">then</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="keyword1">else</span> <span class="main">ùü≠</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">b1</span> <span class="main">=</span> <span class="bound">h1</span> <span class="main">[^]</span> <span class="bound">r</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="keyword1">then</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="keyword1">else</span> <span class="main">ùü≠</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="main">(</span><span class="bound">in1</span> <span class="main">::</span> <span class="tfree">'grp</span><span class="main">,</span> <span class="bound">in2</span> <span class="main">::</span><span class="tfree">'grp</span><span class="main">,</span> <span class="bound">in3</span> <span class="main">::</span> <span class="tfree">'grp</span><span class="main">)</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="bound">ùíú1</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">h0</span> <span class="bound">h1</span> <span class="bound">a</span> <span class="bound">b0</span> <span class="bound">b1</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">h</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">h0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="bound">h1</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">b0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="bound">b1</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="bound">b</span> <span class="main">::</span> bool<span class="main">,</span> <span class="main"><span class="bound">_</span></span> <span class="main">::</span> unit<span class="main">)</span> <span class="main">‚Üê</span> funct_DH_ZK <span class="main">(</span><span class="bound">in1</span><span class="main">,</span> <span class="bound">in2</span><span class="main">,</span> <span class="bound">in3</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="bound">h</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">;</span>
    <span class="main"><span class="bound">_</span></span> <span class="main">::</span> unit <span class="main">‚Üê</span> assert_spmf <span class="main">(</span><span class="bound">b</span><span class="main">)</span><span class="main">;</span> 
    <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">w0</span><span class="main">,</span><span class="bound">z0</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">w1</span><span class="main">,</span><span class="bound">z1</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="bound">ùíú2</span> <span class="bound">h0</span> <span class="bound">h1</span> <span class="bound">a</span> <span class="bound">b0</span> <span class="bound">b1</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">s</span><span class="main">;</span>
    <span class="bound">adv_out</span> <span class="main">::</span> <span class="tfree">'adv_out1</span>  <span class="main">‚Üê</span> <span class="bound">ùíú3</span> <span class="bound">s'</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="bound">adv_out</span><span class="main">,</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="bound">z1</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">inv</span> <span class="bound">w1</span> <span class="main">[^]</span> <span class="bound">Œ±1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="bound">z0</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">inv</span> <span class="bound">w0</span> <span class="main">[^]</span> <span class="bound">Œ±0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‚ÄπThe first and second part of the simulator for party 1 are defined below.‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">P1_S1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'aux</span><span class="main">,</span> <span class="tfree">'grp</span><span class="main">,</span> <span class="tfree">'adv_out1</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> adv_mal_P1 <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span><span class="main">)</span> <span class="main">‚áí</span> <span class="tfree">'aux</span> <span class="main">‚áí</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span><span class="main">)</span> <span class="main">√ó</span> <span class="tfree">'state</span><span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">P1_S1</span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ùíú1</span><span class="main">,</span> <span class="bound">ùíú2</span><span class="main">,</span> <span class="bound">ùíú3</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span><span class="main">;</span>
    <span class="bound">r</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">Œ±0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">Œ±1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">h0</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">Œ±0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">h1</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">Œ±1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">r</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">b0</span> <span class="main">=</span> <span class="bound">h0</span> <span class="main">[^]</span> <span class="bound">r</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">b1</span> <span class="main">=</span> <span class="bound">h1</span> <span class="main">[^]</span> <span class="bound">r</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span><span class="main">;</span>
    <span class="main">(</span><span class="main">(</span><span class="bound">in1</span> <span class="main">::</span> <span class="tfree">'grp</span><span class="main">,</span> <span class="bound">in2</span> <span class="main">::</span><span class="tfree">'grp</span><span class="main">,</span> <span class="bound">in3</span> <span class="main">::</span> <span class="tfree">'grp</span><span class="main">)</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="bound">ùíú1</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">h0</span> <span class="bound">h1</span> <span class="bound">a</span> <span class="bound">b0</span> <span class="bound">b1</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">h</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">h0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="bound">h1</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">b0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="bound">b1</span><span class="main">)</span><span class="main">;</span>
    <span class="main"><span class="bound">_</span></span> <span class="main">::</span> unit <span class="main">‚Üê</span> assert_spmf <span class="main">(</span><span class="main">(</span><span class="bound">in1</span><span class="main">,</span> <span class="bound">in2</span><span class="main">,</span> <span class="bound">in3</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">h</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">w0</span><span class="main">,</span><span class="bound">z0</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">w1</span><span class="main">,</span><span class="bound">z1</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="bound">ùíú2</span> <span class="bound">h0</span> <span class="bound">h1</span> <span class="bound">a</span> <span class="bound">b0</span> <span class="bound">b1</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">s</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">x0</span> <span class="main">=</span> <span class="main">(</span><span class="bound">z0</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">inv</span> <span class="bound">w0</span> <span class="main">[^]</span> <span class="bound">Œ±0</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">x1</span> <span class="main">=</span> <span class="main">(</span><span class="bound">z1</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">inv</span> <span class="bound">w1</span> <span class="main">[^]</span> <span class="bound">Œ±1</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">(</span><span class="bound">x0</span><span class="main">,</span><span class="bound">x1</span><span class="main">)</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">}</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">P1_S2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'aux</span><span class="main">,</span> <span class="tfree">'grp</span><span class="main">,</span> <span class="tfree">'adv_out1</span><span class="main">,</span><span class="tfree">'state</span><span class="main">)</span> adv_mal_P1 <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span><span class="main">)</span> <span class="main">‚áí</span> <span class="tfree">'aux</span> <span class="main">‚áí</span> unit <span class="main">‚áí</span> <span class="tfree">'state</span> <span class="main">‚áí</span> <span class="tfree">'adv_out1</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">P1_S2</span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">out1</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ùíú1</span><span class="main">,</span> <span class="bound">ùíú2</span><span class="main">,</span> <span class="bound">ùíú3</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span><span class="main">;</span>
    <span class="bound">ùíú3</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‚ÄπWe explicitly provide the unfolded definition of the ideal model for convieience in the proof.‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">P1_ideal_model</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span><span class="main">)</span> <span class="main">‚áí</span> bool <span class="main">‚áí</span> <span class="tfree">'aux</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'aux</span><span class="main">,</span> <span class="tfree">'grp</span><span class="main">,</span> <span class="tfree">'adv_out1</span><span class="main">,</span><span class="tfree">'state</span><span class="main">)</span> adv_mal_P1 <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'adv_out1</span> <span class="main">√ó</span> <span class="tfree">'grp</span><span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">P1_ideal_model</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span>  <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ùíú1</span><span class="main">,</span> <span class="bound">ùíú2</span><span class="main">,</span> <span class="bound">ùíú3</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span><span class="main">;</span>
    <span class="bound">r</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">Œ±0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">Œ±1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">h0</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">Œ±0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">h1</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">Œ±1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">r</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">b0</span> <span class="main">=</span> <span class="bound">h0</span> <span class="main">[^]</span> <span class="bound">r</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">b1</span> <span class="main">=</span> <span class="bound">h1</span> <span class="main">[^]</span> <span class="bound">r</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span><span class="main">;</span>
    <span class="main">(</span><span class="main">(</span><span class="bound">in1</span> <span class="main">::</span> <span class="tfree">'grp</span><span class="main">,</span> <span class="bound">in2</span> <span class="main">::</span><span class="tfree">'grp</span><span class="main">,</span> <span class="bound">in3</span> <span class="main">::</span> <span class="tfree">'grp</span><span class="main">)</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="bound">ùíú1</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">h0</span> <span class="bound">h1</span> <span class="bound">a</span> <span class="bound">b0</span> <span class="bound">b1</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">h</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">h0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="bound">h1</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">b0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="bound">b1</span><span class="main">)</span><span class="main">;</span>
    <span class="main"><span class="bound">_</span></span> <span class="main">::</span> unit <span class="main">‚Üê</span> assert_spmf <span class="main">(</span><span class="main">(</span><span class="bound">in1</span><span class="main">,</span> <span class="bound">in2</span><span class="main">,</span> <span class="bound">in3</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">h</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">w0</span><span class="main">,</span><span class="bound">z0</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">w1</span><span class="main">,</span><span class="bound">z1</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="bound">ùíú2</span> <span class="bound">h0</span> <span class="bound">h1</span> <span class="bound">a</span> <span class="bound">b0</span> <span class="bound">b1</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">s</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">x0'</span> <span class="main">=</span> <span class="bound">z0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="bound">w0</span> <span class="main">[^]</span> <span class="bound">Œ±0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">x1'</span> <span class="main">=</span> <span class="bound">z1</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="bound">w1</span> <span class="main">[^]</span> <span class="bound">Œ±1</span><span class="main">;</span>
    <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">f_out2</span><span class="main">)</span> <span class="main">‚Üê</span> funct_OT_12  <span class="main">(</span><span class="bound">x0'</span><span class="main">,</span> <span class="bound">x1'</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span><span class="main">;</span>
    <span class="bound">adv_out</span> <span class="main">::</span> <span class="tfree">'adv_out1</span>  <span class="main">‚Üê</span> <span class="bound">ùíú3</span> <span class="bound">s'</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="bound">adv_out</span><span class="main">,</span> <span class="bound">f_out2</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‚ÄπThe advantage associated with the unfolded definition of the ideal view.‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">P1_adv_real_ideal_model</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'adv_out1</span> <span class="main">√ó</span> <span class="tfree">'grp</span><span class="main">)</span> <span class="main">‚áí</span> bool spmf<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span>
                  <span class="main">=</span> <span class="main">¬¶</span>spmf <span class="main">(</span><span class="main">(</span>P1_real_model <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span><span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="bound">view</span><span class="main">)</span><span class="main">)</span> True 
                              <span class="main">-</span> spmf <span class="main">(</span><span class="main">(</span>P1_ideal_model <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span><span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="bound">view</span><span class="main">)</span><span class="main">)</span> True<span class="main">¬¶</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‚ÄπWe now define the real view and simulators for party 2 in an analogous way.‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">P2_real_model</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span><span class="main">)</span> <span class="main">‚áí</span> bool <span class="main">‚áí</span> <span class="tfree">'aux</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'aux</span><span class="main">,</span> <span class="tfree">'grp</span><span class="main">,</span> <span class="tfree">'adv_out2</span><span class="main">,</span><span class="tfree">'state</span><span class="main">)</span> adv_mal_P2 <span class="main">‚áí</span> <span class="main">(</span>unit <span class="main">√ó</span> <span class="tfree">'adv_out2</span><span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">P2_real_model</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">x0</span><span class="main">,</span><span class="bound">x1</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ùíú1</span><span class="main">,</span> <span class="bound">ùíú2</span><span class="main">,</span> <span class="bound">ùíú3</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span><span class="main">;</span>
    <span class="main">(</span><span class="main">(</span><span class="bound">h0</span><span class="main">,</span><span class="bound">h1</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b0</span><span class="main">,</span><span class="bound">b1</span><span class="main">)</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="bound">ùíú1</span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">;</span>
    <span class="main"><span class="bound">_</span></span> <span class="main">::</span> unit <span class="main">‚Üê</span> assert_spmf <span class="main">(</span><span class="bound">h0</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span> <span class="main">‚àß</span> <span class="bound">h1</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span> <span class="main">‚àß</span> <span class="bound">a</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span> <span class="main">‚àß</span> <span class="bound">b0</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span> <span class="main">‚àß</span> <span class="bound">b1</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">in1</span><span class="main">,</span> <span class="bound">in2</span><span class="main">,</span> <span class="bound">in3</span> <span class="main">::</span> <span class="tfree">'grp</span><span class="main">)</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="bound">ùíú2</span> <span class="main">(</span><span class="bound">h0</span><span class="main">,</span><span class="bound">h1</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b0</span><span class="main">,</span><span class="bound">b1</span><span class="main">)</span> <span class="bound">s</span><span class="main">;</span> 
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">h</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">h0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="bound">h1</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">b0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="bound">b1</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="bound">out_zk_funct</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">‚Üê</span> funct_DH_ZK <span class="main">(</span><span class="bound">h</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="bound">in1</span><span class="main">,</span> <span class="bound">in2</span><span class="main">,</span> <span class="bound">in3</span><span class="main">)</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">;</span>  
    <span class="main"><span class="bound">_</span></span> <span class="main">::</span> unit <span class="main">‚Üê</span> assert_spmf <span class="bound">out_zk_funct</span><span class="main">;</span>
    <span class="bound">u0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">u1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span> 
    <span class="keyword1">let</span> <span class="bound">z0</span> <span class="main">=</span> <span class="bound">b0</span> <span class="main">[^]</span> <span class="bound">u0</span> <span class="main">‚äó</span> <span class="bound">h0</span> <span class="main">[^]</span> <span class="bound">v0</span> <span class="main">‚äó</span> <span class="bound">x0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w0</span> <span class="main">=</span> <span class="bound">a</span> <span class="main">[^]</span> <span class="bound">u0</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">v0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e0</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w0</span><span class="main">,</span> <span class="bound">z0</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z1</span> <span class="main">=</span> <span class="main">(</span><span class="bound">b1</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u1</span> <span class="main">‚äó</span> <span class="bound">h1</span> <span class="main">[^]</span> <span class="bound">v1</span> <span class="main">‚äó</span> <span class="bound">x1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w1</span> <span class="main">=</span> <span class="bound">a</span> <span class="main">[^]</span> <span class="bound">u1</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">v1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e1</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w1</span><span class="main">,</span> <span class="bound">z1</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">out</span> <span class="main">‚Üê</span> <span class="bound">ùíú3</span> <span class="bound">e0</span> <span class="bound">e1</span> <span class="bound">s'</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="bound">out</span><span class="main">)</span><span class="main">}</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">P2_S1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'aux</span><span class="main">,</span> <span class="tfree">'grp</span><span class="main">,</span> <span class="tfree">'adv_out2</span><span class="main">,</span><span class="tfree">'state</span><span class="main">)</span> adv_mal_P2 <span class="main">‚áí</span> bool <span class="main">‚áí</span> <span class="tfree">'aux</span> <span class="main">‚áí</span> <span class="main">(</span>bool <span class="main">√ó</span> <span class="main">(</span><span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span><span class="main">)</span> <span class="main">√ó</span> <span class="tfree">'state</span><span class="main">)</span>  spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">P2_S1</span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
   <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ùíú1</span><span class="main">,</span> <span class="bound">ùíú2</span><span class="main">,</span> <span class="bound">ùíú3</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span><span class="main">;</span>
    <span class="main">(</span><span class="main">(</span><span class="bound">h0</span><span class="main">,</span><span class="bound">h1</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b0</span><span class="main">,</span><span class="bound">b1</span><span class="main">)</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="bound">ùíú1</span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">;</span> 
    <span class="main"><span class="bound">_</span></span> <span class="main">::</span> unit <span class="main">‚Üê</span> assert_spmf <span class="main">(</span><span class="bound">h0</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span> <span class="main">‚àß</span> <span class="bound">h1</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span>  <span class="main">‚àß</span> <span class="bound">a</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span> <span class="main">‚àß</span> <span class="bound">b0</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span> <span class="main">‚àß</span> <span class="bound">b1</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">in1</span><span class="main">,</span> <span class="bound">in2</span><span class="main">,</span> <span class="bound">in3</span> <span class="main">::</span> <span class="tfree">'grp</span><span class="main">)</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="bound">ùíú2</span> <span class="main">(</span><span class="bound">h0</span><span class="main">,</span><span class="bound">h1</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b0</span><span class="main">,</span><span class="bound">b1</span><span class="main">)</span> <span class="bound">s</span><span class="main">;</span> 
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">h</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">h0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="bound">h1</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">b0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="bound">b1</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="bound">out_zk_funct</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">‚Üê</span> funct_DH_ZK <span class="main">(</span><span class="bound">h</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="bound">in1</span><span class="main">,</span> <span class="bound">in2</span><span class="main">,</span> <span class="bound">in3</span><span class="main">)</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">;</span>  
    <span class="main"><span class="bound">_</span></span> <span class="main">::</span> unit <span class="main">‚Üê</span> assert_spmf <span class="bound">out_zk_funct</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">l</span> <span class="main">=</span> <span class="bound">b0</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">inv</span> <span class="main">(</span><span class="bound">h0</span> <span class="main">[^]</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> <span class="bound">l</span> <span class="main">=</span> <span class="main">ùü≠</span> <span class="keyword1">then</span> False <span class="keyword1">else</span> True<span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">h0</span><span class="main">,</span><span class="bound">h1</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b0</span><span class="main">,</span><span class="bound">b1</span><span class="main">)</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">P2_S2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'aux</span><span class="main">,</span> <span class="tfree">'grp</span><span class="main">,</span> <span class="tfree">'adv_out2</span><span class="main">,</span><span class="tfree">'state</span><span class="main">)</span> adv_mal_P2 <span class="main">‚áí</span> bool <span class="main">‚áí</span> <span class="tfree">'aux</span> <span class="main">‚áí</span> <span class="tfree">'grp</span> <span class="main">‚áí</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span><span class="main">)</span> <span class="main">√ó</span> <span class="tfree">'state</span><span class="main">)</span> <span class="main">‚áí</span> <span class="tfree">'adv_out2</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">P2_S2</span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span> <span class="free"><span class="bound"><span class="entity">œÉ'</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">xœÉ</span></span></span> <span class="free"><span class="bound"><span class="entity">aux_out</span></span></span>  <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ùíú1</span><span class="main">,</span> <span class="bound">ùíú2</span><span class="main">,</span> <span class="bound">ùíú3</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="main">(</span><span class="bound">h0</span><span class="main">,</span><span class="bound">h1</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b0</span><span class="main">,</span><span class="bound">b1</span><span class="main">)</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">aux_out</span></span></span><span class="main">;</span>
    <span class="bound">u0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">u1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w0</span> <span class="main">=</span> <span class="bound">a</span> <span class="main">[^]</span> <span class="bound">u0</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">v0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w1</span> <span class="main">=</span> <span class="bound">a</span> <span class="main">[^]</span> <span class="bound">u1</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">v1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z0</span> <span class="main">=</span> <span class="bound">b0</span> <span class="main">[^]</span> <span class="bound">u0</span> <span class="main">‚äó</span> <span class="bound">h0</span> <span class="main">[^]</span> <span class="bound">v0</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">œÉ'</span></span></span> <span class="keyword1">then</span> <span class="main">ùü≠</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">xœÉ</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z1</span> <span class="main">=</span> <span class="main">(</span><span class="bound">b1</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u1</span> <span class="main">‚äó</span> <span class="bound">h1</span> <span class="main">[^]</span> <span class="bound">v1</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">œÉ'</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">xœÉ</span></span></span> <span class="keyword1">else</span> <span class="main">ùü≠</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e0</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w0</span><span class="main">,</span><span class="bound">z0</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e1</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w1</span><span class="main">,</span><span class="bound">z1</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">ùíú3</span> <span class="bound">e0</span> <span class="bound">e1</span> <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> mal_def <span class="main">:</span> malicious_base <span class="quoted">funct_OT_12</span> <span class="quoted">protocol_ot</span> <span class="quoted">P1_S1</span> <span class="quoted">P1_S2</span> <span class="quoted">P1_real_model</span> <span class="quoted">P2_S1</span> <span class="quoted">P2_S2</span> <span class="quoted">P2_real_model</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‚ÄπWe prove the unfolded definition of the ideal views are equal to the definition we provide in the 
abstract locale that defines security.‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P1_ideal_ideal_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"mal_def.ideal_view_1 <span class="free">x</span> <span class="free">y</span> <span class="free">z</span> <span class="main">(</span>P1_S1<span class="main">,</span> P1_S2<span class="main">)</span> <span class="free">ùíú</span> <span class="main">=</span> P1_ideal_model <span class="free">x</span> <span class="free">y</span> <span class="free">z</span> <span class="free">ùíú</span>"</span></span>
  <span class="keyword1"><span class="command">including</span></span> monad_normalisation
  <span class="keyword1"><span class="command">unfolding</span></span> mal_def.ideal_view_1_def mal_def.ideal_game_1_def P1_ideal_model_def P1_S1_def P1_S2_def Let_def split_def 
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> P1_advantages_eq<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mal_def.adv_P1 <span class="free">x</span> <span class="free">y</span> <span class="free">z</span> <span class="main">(</span>P1_S1<span class="main">,</span> P1_S2<span class="main">)</span> <span class="free">ùíú</span> <span class="free">D</span> <span class="main">=</span> P1_adv_real_ideal_model <span class="free">D</span> <span class="free">x</span> <span class="free">y</span> <span class="free">ùíú</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mal_def.adv_P1_def P1_adv_real_ideal_model_def P1_ideal_ideal_eq<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">P1_DDH_mal_adv_œÉ_false</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span><span class="main">)</span> <span class="main">‚áí</span> <span class="tfree">'aux</span>  <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'aux</span><span class="main">,</span> <span class="tfree">'grp</span><span class="main">,</span> <span class="tfree">'adv_out1</span><span class="main">,</span><span class="tfree">'state</span><span class="main">)</span> adv_mal_P1 <span class="main">‚áí</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'adv_out1</span> <span class="main">√ó</span> <span class="tfree">'grp</span><span class="main">)</span> <span class="main">‚áí</span> bool spmf<span class="main">)</span> <span class="main">‚áí</span> <span class="tfree">'grp</span> ddh.adversary"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">P1_DDH_mal_adv_œÉ_false</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ùíú1</span><span class="main">,</span> <span class="bound">ùíú2</span><span class="main">,</span> <span class="bound">ùíú3</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span><span class="main">;</span>
    <span class="bound">Œ±0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">h0</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">Œ±0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">h1</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">b0</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">[^]</span> <span class="bound">Œ±0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">b1</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">;</span>
    <span class="main">(</span><span class="main">(</span><span class="bound">in1</span> <span class="main">::</span> <span class="tfree">'grp</span><span class="main">,</span> <span class="bound">in2</span> <span class="main">::</span><span class="tfree">'grp</span><span class="main">,</span> <span class="bound">in3</span> <span class="main">::</span> <span class="tfree">'grp</span><span class="main">)</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="bound">ùíú1</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">h0</span> <span class="bound">h1</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">b0</span> <span class="bound">b1</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">;</span>
    <span class="main"><span class="bound">_</span></span> <span class="main">::</span> unit <span class="main">‚Üê</span> assert_spmf <span class="main">(</span><span class="bound">in1</span> <span class="main">=</span> <span class="bound">h0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="bound">h1</span> <span class="main">‚àß</span> <span class="bound">in2</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">‚àß</span> <span class="bound">in3</span> <span class="main">=</span> <span class="bound">b0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="bound">b1</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">w0</span><span class="main">,</span><span class="bound">z0</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">w1</span><span class="main">,</span><span class="bound">z1</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="bound">ùíú2</span> <span class="bound">h0</span> <span class="bound">h1</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">b0</span> <span class="bound">b1</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">s</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">x0</span> <span class="main">=</span> <span class="main">(</span><span class="bound">z0</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">inv</span> <span class="bound">w0</span> <span class="main">[^]</span> <span class="bound">Œ±0</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">adv_out</span> <span class="main">::</span> <span class="tfree">'adv_out1</span> <span class="main">‚Üê</span> <span class="bound">ùíú3</span> <span class="bound">s'</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">(</span><span class="bound">adv_out</span><span class="main">,</span> <span class="bound">x0</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">P1_DDH_mal_adv_œÉ_true</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span><span class="main">)</span> <span class="main">‚áí</span> <span class="tfree">'aux</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'aux</span><span class="main">,</span> <span class="tfree">'grp</span><span class="main">,</span> <span class="tfree">'adv_out1</span><span class="main">,</span><span class="tfree">'state</span><span class="main">)</span> adv_mal_P1 <span class="main">‚áí</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'adv_out1</span> <span class="main">√ó</span> <span class="tfree">'grp</span><span class="main">)</span> <span class="main">‚áí</span> bool spmf<span class="main">)</span> <span class="main">‚áí</span> <span class="tfree">'grp</span> ddh.adversary"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">P1_DDH_mal_adv_œÉ_true</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ùíú1</span><span class="main">,</span> <span class="bound">ùíú2</span><span class="main">,</span> <span class="bound">ùíú3</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span><span class="main">;</span>
    <span class="bound">Œ±1</span> <span class="main">::</span> nat <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">h1</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">Œ±1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">h0</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">b0</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">b1</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">[^]</span> <span class="bound">Œ±1</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span><span class="main">;</span>
    <span class="main">(</span><span class="main">(</span><span class="bound">in1</span> <span class="main">::</span> <span class="tfree">'grp</span><span class="main">,</span> <span class="bound">in2</span> <span class="main">::</span><span class="tfree">'grp</span><span class="main">,</span> <span class="bound">in3</span> <span class="main">::</span> <span class="tfree">'grp</span><span class="main">)</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="bound">ùíú1</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">h0</span> <span class="bound">h1</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">b0</span> <span class="bound">b1</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">;</span>
    <span class="main"><span class="bound">_</span></span> <span class="main">::</span> unit <span class="main">‚Üê</span> assert_spmf <span class="main">(</span><span class="bound">in1</span> <span class="main">=</span> <span class="bound">h0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="bound">h1</span> <span class="main">‚àß</span> <span class="bound">in2</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">‚àß</span> <span class="bound">in3</span> <span class="main">=</span> <span class="bound">b0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="bound">b1</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">w0</span><span class="main">,</span><span class="bound">z0</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">w1</span><span class="main">,</span><span class="bound">z1</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="bound">ùíú2</span> <span class="bound">h0</span> <span class="bound">h1</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">b0</span> <span class="bound">b1</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">s</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">x1</span> <span class="main">=</span> <span class="main">(</span><span class="bound">z1</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">inv</span> <span class="bound">w1</span> <span class="main">[^]</span> <span class="bound">Œ±1</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">adv_out</span> <span class="main">::</span> <span class="tfree">'adv_out1</span> <span class="main">‚Üê</span> <span class="bound">ùíú3</span> <span class="bound">s'</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">(</span><span class="bound">adv_out</span><span class="main">,</span> <span class="bound">x1</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">P2_ideal_model</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span><span class="main">)</span> <span class="main">‚áí</span> bool <span class="main">‚áí</span> <span class="tfree">'aux</span> <span class="main">‚áí</span>  <span class="main">(</span><span class="tfree">'aux</span><span class="main">,</span> <span class="tfree">'grp</span><span class="main">,</span> <span class="tfree">'adv_out2</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> adv_mal_P2 <span class="main">‚áí</span> <span class="main">(</span>unit <span class="main">√ó</span> <span class="tfree">'adv_out2</span><span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">P2_ideal_model</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">x0</span><span class="main">,</span><span class="bound">x1</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ùíú1</span><span class="main">,</span> <span class="bound">ùíú2</span><span class="main">,</span> <span class="bound">ùíú3</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span><span class="main">;</span>
    <span class="main">(</span><span class="main">(</span><span class="bound">h0</span><span class="main">,</span><span class="bound">h1</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b0</span><span class="main">,</span><span class="bound">b1</span><span class="main">)</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="bound">ùíú1</span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">;</span> 
    <span class="main"><span class="bound">_</span></span> <span class="main">::</span> unit <span class="main">‚Üê</span> assert_spmf <span class="main">(</span><span class="bound">h0</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span> <span class="main">‚àß</span> <span class="bound">h1</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span>  <span class="main">‚àß</span> <span class="bound">a</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span> <span class="main">‚àß</span> <span class="bound">b0</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span> <span class="main">‚àß</span> <span class="bound">b1</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">in1</span><span class="main">,</span> <span class="bound">in2</span><span class="main">,</span> <span class="bound">in3</span><span class="main">)</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="bound">ùíú2</span> <span class="main">(</span><span class="bound">h0</span><span class="main">,</span><span class="bound">h1</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b0</span><span class="main">,</span><span class="bound">b1</span><span class="main">)</span> <span class="bound">s</span><span class="main">;</span> 
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">h</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">h0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="bound">h1</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">b0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="bound">b1</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="bound">out_zk_funct</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">‚Üê</span> funct_DH_ZK <span class="main">(</span><span class="bound">h</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="bound">in1</span><span class="main">,</span> <span class="bound">in2</span><span class="main">,</span> <span class="bound">in3</span><span class="main">)</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">;</span> 
    <span class="main"><span class="bound">_</span></span> <span class="main">::</span> unit <span class="main">‚Üê</span> assert_spmf <span class="bound">out_zk_funct</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">l</span> <span class="main">=</span> <span class="bound">b0</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">inv</span> <span class="main">(</span><span class="bound">h0</span> <span class="main">[^]</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> 
    <span class="keyword1">let</span> <span class="bound">œÉ'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">l</span> <span class="main">=</span> <span class="main">ùü≠</span> <span class="keyword1">then</span> False <span class="keyword1">else</span> True<span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="main"><span class="bound">_</span></span> <span class="main">::</span> unit<span class="main">,</span> <span class="bound">xœÉ</span><span class="main">)</span> <span class="main">‚Üê</span> funct_OT_12 <span class="main">(</span><span class="bound">x0</span><span class="main">,</span> <span class="bound">x1</span><span class="main">)</span> <span class="bound">œÉ'</span><span class="main">;</span> 
    <span class="bound">u0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">u1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w0</span> <span class="main">=</span> <span class="bound">a</span> <span class="main">[^]</span> <span class="bound">u0</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">v0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w1</span> <span class="main">=</span> <span class="bound">a</span> <span class="main">[^]</span> <span class="bound">u1</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">v1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z0</span> <span class="main">=</span> <span class="bound">b0</span> <span class="main">[^]</span> <span class="bound">u0</span> <span class="main">‚äó</span> <span class="bound">h0</span> <span class="main">[^]</span> <span class="bound">v0</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">œÉ'</span> <span class="keyword1">then</span> <span class="main">ùü≠</span> <span class="keyword1">else</span> <span class="bound">xœÉ</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z1</span> <span class="main">=</span> <span class="main">(</span><span class="bound">b1</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u1</span> <span class="main">‚äó</span> <span class="bound">h1</span> <span class="main">[^]</span> <span class="bound">v1</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">œÉ'</span> <span class="keyword1">then</span> <span class="bound">xœÉ</span> <span class="keyword1">else</span> <span class="main">ùü≠</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e0</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w0</span><span class="main">,</span><span class="bound">z0</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e1</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w1</span><span class="main">,</span><span class="bound">z1</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">out</span> <span class="main">‚Üê</span> <span class="bound">ùíú3</span> <span class="bound">e0</span> <span class="bound">e1</span> <span class="bound">s'</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="bound">out</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">P2_ideal_model_end</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span><span class="main">)</span> <span class="main">‚áí</span> <span class="tfree">'grp</span> <span class="main">‚áí</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span><span class="main">)</span> <span class="main">√ó</span> <span class="tfree">'state</span><span class="main">)</span>
                                    <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'grp</span><span class="main">,</span> <span class="tfree">'adv_out2</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> adv_3_P2 <span class="main">‚áí</span> <span class="main">(</span>unit <span class="main">√ó</span> <span class="tfree">'adv_out2</span><span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">P2_ideal_model_end</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="free"><span class="bound"><span class="entity">ùíú3</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">x0</span><span class="main">,</span><span class="bound">x1</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="main">(</span><span class="bound">h0</span><span class="main">,</span><span class="bound">h1</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b0</span><span class="main">,</span><span class="bound">b1</span><span class="main">)</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">œÉ'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">ùü≠</span> <span class="keyword1">then</span> False <span class="keyword1">else</span> True<span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">::</span> unit<span class="main">,</span> <span class="bound">xœÉ</span><span class="main">)</span> <span class="main">‚Üê</span> funct_OT_12 <span class="main">(</span><span class="bound">x0</span><span class="main">,</span> <span class="bound">x1</span><span class="main">)</span> <span class="bound">œÉ'</span><span class="main">;</span>
    <span class="bound">u0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">u1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w0</span> <span class="main">=</span> <span class="bound">a</span> <span class="main">[^]</span> <span class="bound">u0</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">v0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w1</span> <span class="main">=</span> <span class="bound">a</span> <span class="main">[^]</span> <span class="bound">u1</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">v1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z0</span> <span class="main">=</span> <span class="bound">b0</span> <span class="main">[^]</span> <span class="bound">u0</span> <span class="main">‚äó</span> <span class="bound">h0</span> <span class="main">[^]</span> <span class="bound">v0</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">œÉ'</span> <span class="keyword1">then</span> <span class="main">ùü≠</span> <span class="keyword1">else</span> <span class="bound">xœÉ</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z1</span> <span class="main">=</span> <span class="main">(</span><span class="bound">b1</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u1</span> <span class="main">‚äó</span> <span class="bound">h1</span> <span class="main">[^]</span> <span class="bound">v1</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">œÉ'</span> <span class="keyword1">then</span> <span class="bound">xœÉ</span> <span class="keyword1">else</span> <span class="main">ùü≠</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e0</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w0</span><span class="main">,</span><span class="bound">z0</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e1</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w1</span><span class="main">,</span><span class="bound">z1</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">out</span> <span class="main">‚Üê</span> <span class="free"><span class="bound"><span class="entity">ùíú3</span></span></span> <span class="bound">e0</span> <span class="bound">e1</span> <span class="bound">s</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="bound">out</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">P2_ideal_model'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span><span class="main">)</span> <span class="main">‚áí</span> bool <span class="main">‚áí</span> <span class="tfree">'aux</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'aux</span><span class="main">,</span> <span class="tfree">'grp</span><span class="main">,</span> <span class="tfree">'adv_out2</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> adv_mal_P2 <span class="main">‚áí</span> <span class="main">(</span>unit <span class="main">√ó</span> <span class="tfree">'adv_out2</span><span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">P2_ideal_model'</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">x0</span><span class="main">,</span><span class="bound">x1</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ùíú1</span><span class="main">,</span> <span class="bound">ùíú2</span><span class="main">,</span> <span class="bound">ùíú3</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span><span class="main">;</span>
    <span class="main">(</span><span class="main">(</span><span class="bound">h0</span><span class="main">,</span><span class="bound">h1</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b0</span><span class="main">,</span><span class="bound">b1</span><span class="main">)</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="bound">ùíú1</span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">;</span>
    <span class="main"><span class="bound">_</span></span> <span class="main">::</span> unit <span class="main">‚Üê</span> assert_spmf <span class="main">(</span><span class="bound">h0</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span> <span class="main">‚àß</span> <span class="bound">h1</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span>  <span class="main">‚àß</span> <span class="bound">a</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span> <span class="main">‚àß</span> <span class="bound">b0</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span> <span class="main">‚àß</span> <span class="bound">b1</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">in1</span><span class="main">,</span> <span class="bound">in2</span><span class="main">,</span> <span class="bound">in3</span> <span class="main">::</span> <span class="tfree">'grp</span><span class="main">)</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="bound">ùíú2</span> <span class="main">(</span><span class="bound">h0</span><span class="main">,</span><span class="bound">h1</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b0</span><span class="main">,</span><span class="bound">b1</span><span class="main">)</span> <span class="bound">s</span><span class="main">;</span> 
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">h</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">h0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="bound">h1</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">b0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="bound">b1</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="bound">out_zk_funct</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">‚Üê</span> funct_DH_ZK <span class="main">(</span><span class="bound">h</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="bound">in1</span><span class="main">,</span> <span class="bound">in2</span><span class="main">,</span> <span class="bound">in3</span><span class="main">)</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">;</span>  
    <span class="main"><span class="bound">_</span></span> <span class="main">::</span> unit <span class="main">‚Üê</span> assert_spmf <span class="bound">out_zk_funct</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">l</span> <span class="main">=</span> <span class="bound">b0</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">inv</span> <span class="main">(</span><span class="bound">h0</span> <span class="main">[^]</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    P2_ideal_model_end <span class="main">(</span><span class="bound">x0</span><span class="main">,</span><span class="bound">x1</span><span class="main">)</span> <span class="bound">l</span> <span class="main">(</span><span class="main">(</span><span class="bound">h0</span><span class="main">,</span><span class="bound">h1</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b0</span><span class="main">,</span><span class="bound">b1</span><span class="main">)</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="bound">ùíú3</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P2_ideal_model_rewrite<span class="main">:</span> <span class="quoted"><span class="quoted">"P2_ideal_model <span class="free">M</span> <span class="free">œÉ</span> <span class="free">z</span> <span class="free">ùíú</span> <span class="main">=</span> P2_ideal_model' <span class="free">M</span> <span class="free">œÉ</span> <span class="free">z</span> <span class="free">ùíú</span> "</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P2_ideal_model'_def P2_ideal_model_def P2_ideal_model_end_def Let_def split_def<span class="main">)</span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">P2_real_model_end</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span><span class="main">)</span> <span class="main">√ó</span> <span class="tfree">'state</span><span class="main">)</span> 
                                    <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'grp</span><span class="main">,</span> <span class="tfree">'adv_out2</span><span class="main">,</span><span class="tfree">'state</span><span class="main">)</span> adv_3_P2 <span class="main">‚áí</span> <span class="main">(</span>unit <span class="main">√ó</span> <span class="tfree">'adv_out2</span><span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">P2_real_model_end</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="free"><span class="bound"><span class="entity">ùíú3</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">x0</span><span class="main">,</span><span class="bound">x1</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="main">(</span><span class="bound">h0</span><span class="main">,</span><span class="bound">h1</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b0</span><span class="main">,</span><span class="bound">b1</span><span class="main">)</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">;</span>
    <span class="bound">u0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">u1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span> 
    <span class="keyword1">let</span> <span class="bound">z0</span> <span class="main">=</span> <span class="bound">b0</span> <span class="main">[^]</span> <span class="bound">u0</span> <span class="main">‚äó</span> <span class="bound">h0</span> <span class="main">[^]</span> <span class="bound">v0</span> <span class="main">‚äó</span> <span class="bound">x0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w0</span> <span class="main">=</span> <span class="bound">a</span> <span class="main">[^]</span> <span class="bound">u0</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">v0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e0</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w0</span><span class="main">,</span> <span class="bound">z0</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z1</span> <span class="main">=</span> <span class="main">(</span><span class="bound">b1</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u1</span> <span class="main">‚äó</span> <span class="bound">h1</span> <span class="main">[^]</span> <span class="bound">v1</span> <span class="main">‚äó</span> <span class="bound">x1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w1</span> <span class="main">=</span> <span class="bound">a</span> <span class="main">[^]</span> <span class="bound">u1</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">v1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e1</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w1</span><span class="main">,</span> <span class="bound">z1</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">out</span> <span class="main">‚Üê</span> <span class="free"><span class="bound"><span class="entity">ùíú3</span></span></span> <span class="bound">e0</span> <span class="bound">e1</span> <span class="bound">s</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="bound">out</span><span class="main">)</span><span class="main">}</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">P2_real_model'</span> <span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'grp</span> <span class="main">√ó</span> <span class="tfree">'grp</span><span class="main">)</span> <span class="main">‚áí</span> bool <span class="main">‚áí</span> <span class="tfree">'aux</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'aux</span><span class="main">,</span> <span class="tfree">'grp</span><span class="main">,</span> <span class="tfree">'adv_out2</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> adv_mal_P2 <span class="main">‚áí</span> <span class="main">(</span>unit <span class="main">√ó</span> <span class="tfree">'adv_out2</span><span class="main">)</span> spmf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">P2_real_model'</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">x0</span><span class="main">,</span><span class="bound">x1</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ùíú1</span><span class="main">,</span> <span class="bound">ùíú2</span><span class="main">,</span> <span class="bound">ùíú3</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ùíú</span></span></span><span class="main">;</span>
    <span class="main">(</span><span class="main">(</span><span class="bound">h0</span><span class="main">,</span><span class="bound">h1</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b0</span><span class="main">,</span><span class="bound">b1</span><span class="main">)</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="bound">ùíú1</span> <span class="free"><span class="bound"><span class="entity">œÉ</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">;</span>
    <span class="main"><span class="bound">_</span></span> <span class="main">::</span> unit <span class="main">‚Üê</span> assert_spmf <span class="main">(</span><span class="bound">h0</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span> <span class="main">‚àß</span> <span class="bound">h1</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span>  <span class="main">‚àß</span> <span class="bound">a</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span> <span class="main">‚àß</span> <span class="bound">b0</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span> <span class="main">‚àß</span> <span class="bound">b1</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">in1</span><span class="main">,</span> <span class="bound">in2</span><span class="main">,</span> <span class="bound">in3</span> <span class="main">::</span> <span class="tfree">'grp</span><span class="main">)</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="bound">ùíú2</span> <span class="main">(</span><span class="bound">h0</span><span class="main">,</span><span class="bound">h1</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b0</span><span class="main">,</span><span class="bound">b1</span><span class="main">)</span> <span class="bound">s</span><span class="main">;</span> 
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">h</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">h0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="bound">h1</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">b0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="bound">b1</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="bound">out_zk_funct</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">‚Üê</span> funct_DH_ZK <span class="main">(</span><span class="bound">h</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="bound">in1</span><span class="main">,</span> <span class="bound">in2</span><span class="main">,</span> <span class="bound">in3</span><span class="main">)</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">;</span>  
    <span class="main"><span class="bound">_</span></span> <span class="main">::</span> unit <span class="main">‚Üê</span> assert_spmf <span class="bound">out_zk_funct</span><span class="main">;</span>
    P2_real_model_end <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">(</span><span class="main">(</span><span class="bound">h0</span><span class="main">,</span><span class="bound">h1</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b0</span><span class="main">,</span><span class="bound">b1</span><span class="main">)</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="bound">ùíú3</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P2_real_model_rewrite<span class="main">:</span> <span class="quoted"><span class="quoted">"P2_real_model <span class="free">M</span> <span class="free">œÉ</span> <span class="free">z</span> <span class="free">ùíú</span> <span class="main">=</span> P2_real_model' <span class="free">M</span> <span class="free">œÉ</span> <span class="free">z</span> <span class="free">ùíú</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P2_real_model'_def P2_real_model_def P2_real_model_end_def split_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> P2_ideal_view_unfold<span class="main">:</span> <span class="quoted"><span class="quoted">"mal_def.ideal_view_2 <span class="main">(</span><span class="free">x0</span><span class="main">,</span><span class="free">x1</span><span class="main">)</span> <span class="free">œÉ</span> <span class="free">z</span> <span class="main">(</span>P2_S1<span class="main">,</span> P2_S2<span class="main">)</span> <span class="free">ùíú</span> <span class="main">=</span> P2_ideal_model <span class="main">(</span><span class="free">x0</span><span class="main">,</span><span class="free">x1</span><span class="main">)</span> <span class="free">œÉ</span> <span class="free">z</span> <span class="free">ùíú</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> local.mal_def.ideal_view_2_def P2_ideal_model_def local.mal_def.ideal_game_2_def P2_S1_def P2_S2_def 
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def split_def<span class="main">)</span> 

<span class="keyword2"><span class="keyword">end</span></span> 

<span class="keyword1"><span class="command">locale</span></span> ot <span class="main">=</span> ot_base <span class="main">+</span> cyclic_group <span class="quoted"><span class="free">ùí¢</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P1_assert_correct1<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">Œ±0</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">Œ±1</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="free">r</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span><span class="main">)</span> 
                <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">Œ±0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">Œ±1</span><span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> in_carrier1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">Œ±1</span><span class="main">)</span> <span class="main">[^]</span> <span class="free">r</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> in_carrier2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">inv</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">Œ±1</span><span class="main">)</span> <span class="main">[^]</span> <span class="free">r</span><span class="main">)</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">Œ±0</span><span class="main">)</span> <span class="main">[^]</span> <span class="free">r</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">Œ±1</span><span class="main">)</span> <span class="main">[^]</span> <span class="free">r</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span>"</span></span>  
    <span class="keyword1"><span class="command">using</span></span>  cyclic_group_assoc nat_pow_pow inverse_split in_carrier1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">Œ±0</span><span class="main">)</span> <span class="main">[^]</span> <span class="free">r</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">Œ±1</span><span class="main">)</span> <span class="main">[^]</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cyclic_group_assoc in_carrier2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">Œ±0</span><span class="main">)</span> <span class="main">[^]</span> <span class="free">r</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">inv</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">Œ±1</span><span class="main">)</span> <span class="main">[^]</span> <span class="free">r</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> in_carrier2 cyclic_group_commute <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">Œ±0</span><span class="main">)</span> <span class="main">[^]</span> <span class="free">r</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">Œ±1</span><span class="main">)</span> <span class="main">[^]</span> <span class="free">r</span><span class="main">)</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cyclic_group_assoc in_carrier2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">Œ±0</span><span class="main">)</span> <span class="main">[^]</span> <span class="free">r</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">Œ±1</span><span class="main">)</span> <span class="main">[^]</span> <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">Œ±0</span><span class="main">)</span> <span class="main">[^]</span> <span class="free">r</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">Œ±1</span><span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="free">r</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> inverse_pow_pow <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cyclic_group_commute pow_mult_distrib<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P1_assert_correct2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">Œ±0</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">Œ±1</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">Œ±0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">Œ±1</span><span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="free">r</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> in_carrier2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">Œ±1</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">Œ±0</span><span class="main">)</span> <span class="main">[^]</span> <span class="free">r</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">Œ±1</span><span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="free">r</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> inverse_pow_pow <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cyclic_group_commute monoid_comm_monoidI pow_mult_distrib<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> ddh<span class="main">:</span> ddh_ext  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cyclic_group_axioms ddh_ext.intro<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> P1_real_ddh0_œÉ_false<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">œÉ</span> <span class="main">=</span> False"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>P1_real_model <span class="free">M</span> <span class="free">œÉ</span> <span class="free">z</span> <span class="free">ùíú</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="free">D</span> <span class="bound">view</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>ddh.DDH0 <span class="main">(</span>P1_DDH_mal_adv_œÉ_false <span class="free">M</span> <span class="free">z</span> <span class="free">ùíú</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">including</span></span> monad_normalisation
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">in2</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">r</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">‚àß</span> <span class="skolem">in3</span> <span class="main">=</span> <span class="skolem">in1</span> <span class="main">[^]</span> <span class="skolem">r</span> <span class="main">‚àß</span> <span class="skolem">in1</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">Œ±0</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">Œ±1</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> 
        <span class="main">‚àß</span> <span class="skolem">in2</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">r</span> <span class="main">‚àß</span> <span class="skolem">in3</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">[^]</span> <span class="skolem">Œ±0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">Œ±1</span><span class="main">)</span> <span class="main">[^]</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>
          <span class="main">‚ü∑</span> <span class="main">(</span><span class="skolem">in1</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">Œ±0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">Œ±1</span><span class="main">)</span> <span class="main">‚àß</span> <span class="skolem">in2</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">r</span> <span class="main">‚àß</span> <span class="skolem">in3</span> 
            <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">[^]</span> <span class="skolem">Œ±0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">Œ±1</span><span class="main">)</span> <span class="main">[^]</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span>  
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">in1</span> <span class="skolem">in2</span> <span class="skolem">in3</span> <span class="skolem">r</span> <span class="skolem">Œ±0</span> <span class="skolem">Œ±1</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P1_assert_correct2 power_swap<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>P1_real_model <span class="free">M</span> <span class="free">œÉ</span> <span class="free">z</span> <span class="free">ùíú</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="free">D</span> <span class="bound">view</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ùíú1</span><span class="main">,</span> <span class="bound">ùíú2</span><span class="main">,</span> <span class="bound">ùíú3</span><span class="main">)</span> <span class="main">=</span> <span class="free">ùíú</span><span class="main">;</span>
    <span class="bound">r</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">Œ±0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">Œ±1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">h0</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">Œ±0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">h1</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">Œ±1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">r</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">b0</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">r</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">Œ±0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">b1</span> <span class="main">=</span> <span class="bound">h1</span> <span class="main">[^]</span> <span class="bound">r</span><span class="main">;</span>
    <span class="main">(</span><span class="main">(</span><span class="bound">in1</span><span class="main">,</span> <span class="bound">in2</span><span class="main">,</span> <span class="bound">in3</span><span class="main">)</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="bound">ùíú1</span> <span class="free">M</span> <span class="bound">h0</span> <span class="bound">h1</span> <span class="bound">a</span> <span class="bound">b0</span> <span class="bound">b1</span> <span class="free">z</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">h</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">h0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="bound">h1</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">b0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="bound">b1</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="bound">b</span> <span class="main">::</span> bool<span class="main">,</span> <span class="main"><span class="bound">_</span></span> <span class="main">::</span> unit<span class="main">)</span> <span class="main">‚Üê</span> funct_DH_ZK <span class="main">(</span><span class="bound">in1</span><span class="main">,</span> <span class="bound">in2</span><span class="main">,</span> <span class="bound">in3</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="bound">h</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">;</span>
    <span class="main"><span class="bound">_</span></span> <span class="main">::</span> unit <span class="main">‚Üê</span> assert_spmf <span class="main">(</span><span class="bound">b</span><span class="main">)</span><span class="main">;</span> 
    <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">w0</span><span class="main">,</span><span class="bound">z0</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">w1</span><span class="main">,</span><span class="bound">z1</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="bound">ùíú2</span> <span class="bound">h0</span> <span class="bound">h1</span> <span class="bound">a</span> <span class="bound">b0</span> <span class="bound">b1</span> <span class="free">M</span> <span class="bound">s</span><span class="main">;</span>
    <span class="bound">adv_out</span> <span class="main">‚Üê</span> <span class="bound">ùíú3</span> <span class="bound">s'</span><span class="main">;</span>
    <span class="free">D</span> <span class="main">(</span><span class="bound">adv_out</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="bound">z0</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">inv</span> <span class="bound">w0</span> <span class="main">[^]</span> <span class="bound">Œ±0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P1_real_model_def assms split_def Let_def power_swap<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P1_real_model_def ddh.DDH0_def Let_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P1_ideal_ddh1_œÉ_false<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">œÉ</span> <span class="main">=</span> False"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>P1_ideal_model <span class="free">M</span> <span class="free">œÉ</span> <span class="free">z</span> <span class="free">ùíú</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="free">D</span> <span class="bound">view</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>ddh.DDH1 <span class="main">(</span>P1_DDH_mal_adv_œÉ_false <span class="free">M</span> <span class="free">z</span> <span class="free">ùíú</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">including</span></span> monad_normalisation
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>P1_ideal_model <span class="free">M</span> <span class="free">œÉ</span> <span class="free">z</span> <span class="free">ùíú</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="free">D</span> <span class="bound">view</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ùíú1</span><span class="main">,</span> <span class="bound">ùíú2</span><span class="main">,</span> <span class="bound">ùíú3</span><span class="main">)</span> <span class="main">=</span> <span class="free">ùíú</span><span class="main">;</span>
    <span class="bound">r</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">Œ±0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">Œ±1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">h0</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">Œ±0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">h1</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">Œ±1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">r</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">b0</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">r</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">Œ±0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">b1</span> <span class="main">=</span> <span class="bound">h1</span> <span class="main">[^]</span> <span class="bound">r</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span><span class="main">;</span>
    <span class="main">(</span><span class="main">(</span><span class="bound">in1</span><span class="main">,</span> <span class="bound">in2</span><span class="main">,</span> <span class="bound">in3</span><span class="main">)</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="bound">ùíú1</span> <span class="free">M</span> <span class="bound">h0</span> <span class="bound">h1</span> <span class="bound">a</span> <span class="bound">b0</span> <span class="bound">b1</span> <span class="free">z</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">h</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">h0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="bound">h1</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">b0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="bound">b1</span><span class="main">)</span><span class="main">;</span>
    <span class="main"><span class="bound">_</span></span> <span class="main">::</span> unit <span class="main">‚Üê</span> assert_spmf <span class="main">(</span><span class="main">(</span><span class="bound">in1</span><span class="main">,</span> <span class="bound">in2</span><span class="main">,</span> <span class="bound">in3</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">h</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">w0</span><span class="main">,</span><span class="bound">z0</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">w1</span><span class="main">,</span><span class="bound">z1</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="bound">ùíú2</span> <span class="bound">h0</span> <span class="bound">h1</span> <span class="bound">a</span> <span class="bound">b0</span> <span class="bound">b1</span> <span class="free">M</span> <span class="bound">s</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">x0</span> <span class="main">=</span> <span class="main">(</span><span class="bound">z0</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">inv</span> <span class="bound">w0</span> <span class="main">[^]</span> <span class="bound">Œ±0</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">x1</span> <span class="main">=</span> <span class="main">(</span><span class="bound">z1</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">inv</span> <span class="bound">w1</span> <span class="main">[^]</span> <span class="bound">Œ±1</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">f_out2</span><span class="main">)</span> <span class="main">‚Üê</span> funct_OT_12  <span class="main">(</span><span class="bound">x0</span><span class="main">,</span> <span class="bound">x1</span><span class="main">)</span> <span class="free">œÉ</span><span class="main">;</span>
    <span class="bound">adv_out</span> <span class="main">‚Üê</span> <span class="bound">ùíú3</span> <span class="bound">s'</span><span class="main">;</span>
    <span class="free">D</span> <span class="main">(</span><span class="bound">adv_out</span><span class="main">,</span> <span class="bound">f_out2</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P1_ideal_model_def assms split_def Let_def  power_swap<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P1_ideal_model_def ddh.DDH1_def funct_OT_12_def Let_def assms <span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P1_real_ddh1_œÉ_true<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">œÉ</span> <span class="main">=</span> True"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>P1_real_model <span class="free">M</span> <span class="free">œÉ</span> <span class="free">z</span> <span class="free">ùíú</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="free">D</span> <span class="bound">view</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>ddh.DDH1 <span class="main">(</span>P1_DDH_mal_adv_œÉ_true <span class="free">M</span> <span class="free">z</span> <span class="free">ùíú</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">including</span></span> monad_normalisation
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">in2</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">r</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">‚àß</span> <span class="skolem">in3</span> <span class="main">=</span> <span class="skolem">in1</span> <span class="main">[^]</span> <span class="skolem">r</span> <span class="main">‚àß</span> <span class="skolem">in1</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">Œ±0</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">Œ±1</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> 
          <span class="main">‚àß</span> <span class="skolem">in2</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">r</span> <span class="main">‚àß</span> <span class="skolem">in3</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">[^]</span> <span class="skolem">Œ±0</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">Œ±1</span><span class="main">)</span> <span class="main">[^]</span> <span class="skolem">r</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span><span class="main">)</span><span class="main">)</span>
          <span class="main">‚ü∑</span> <span class="main">(</span><span class="skolem">in1</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">Œ±0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">Œ±1</span><span class="main">)</span> <span class="main">‚àß</span> <span class="skolem">in2</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">r</span> 
              <span class="main">‚àß</span> <span class="skolem">in3</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">Œ±0</span><span class="main">)</span> <span class="main">[^]</span> <span class="skolem">r</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">[^]</span> <span class="skolem">Œ±1</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">in1</span> <span class="skolem">in2</span> <span class="skolem">in3</span> <span class="skolem">r</span> <span class="skolem">Œ±0</span> <span class="skolem">Œ±1</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P1_assert_correct1 power_swap<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>P1_real_model <span class="free">M</span> <span class="free">œÉ</span> <span class="free">z</span> <span class="free">ùíú</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="free">D</span> <span class="bound">view</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ùíú1</span><span class="main">,</span> <span class="bound">ùíú2</span><span class="main">,</span> <span class="bound">ùíú3</span><span class="main">)</span> <span class="main">=</span> <span class="free">ùíú</span><span class="main">;</span>
    <span class="bound">r</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">Œ±0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">Œ±1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">h0</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">Œ±0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">h1</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">Œ±1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">r</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">b0</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">r</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">Œ±0</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">b1</span> <span class="main">=</span> <span class="main">(</span><span class="bound">h1</span> <span class="main">[^]</span> <span class="bound">r</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span><span class="main">;</span>
    <span class="main">(</span><span class="main">(</span><span class="bound">in1</span><span class="main">,</span> <span class="bound">in2</span><span class="main">,</span> <span class="bound">in3</span><span class="main">)</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="bound">ùíú1</span> <span class="free">M</span> <span class="bound">h0</span> <span class="bound">h1</span> <span class="bound">a</span> <span class="bound">b0</span> <span class="bound">b1</span> <span class="free">z</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">h</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">h0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="bound">h1</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">b0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="bound">b1</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="bound">b</span> <span class="main">::</span> bool<span class="main">,</span> <span class="main"><span class="bound">_</span></span> <span class="main">::</span> unit<span class="main">)</span> <span class="main">‚Üê</span> funct_DH_ZK <span class="main">(</span><span class="bound">in1</span><span class="main">,</span> <span class="bound">in2</span><span class="main">,</span> <span class="bound">in3</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="bound">h</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">;</span>
    <span class="main"><span class="bound">_</span></span> <span class="main">::</span> unit <span class="main">‚Üê</span> assert_spmf <span class="main">(</span><span class="bound">b</span><span class="main">)</span><span class="main">;</span> 
    <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">w0</span><span class="main">,</span><span class="bound">z0</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">w1</span><span class="main">,</span><span class="bound">z1</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="bound">ùíú2</span> <span class="bound">h0</span> <span class="bound">h1</span> <span class="bound">a</span> <span class="bound">b0</span> <span class="bound">b1</span> <span class="free">M</span> <span class="bound">s</span><span class="main">;</span>
    <span class="bound">adv_out</span> <span class="main">‚Üê</span> <span class="bound">ùíú3</span> <span class="bound">s'</span><span class="main">;</span>
    <span class="free">D</span> <span class="main">(</span><span class="bound">adv_out</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="bound">z1</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">inv</span> <span class="bound">w1</span> <span class="main">[^]</span> <span class="bound">Œ±1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P1_real_model_def assms split_def Let_def power_swap<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def P1_real_model_def ddh.DDH1_def assms power_swap<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P1_ideal_ddh0_œÉ_true<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">œÉ</span> <span class="main">=</span> True"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>P1_ideal_model <span class="free">M</span> <span class="free">œÉ</span> <span class="free">z</span> <span class="free">ùíú</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="free">D</span> <span class="bound">view</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>ddh.DDH0 <span class="main">(</span>P1_DDH_mal_adv_œÉ_true <span class="free">M</span> <span class="free">z</span> <span class="free">ùíú</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">including</span></span> monad_normalisation
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>P1_ideal_model <span class="free">M</span> <span class="free">œÉ</span> <span class="free">z</span> <span class="free">ùíú</span><span class="main">)</span> <span class="main">‚§ú</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">view</span><span class="main">.</span> <span class="free">D</span> <span class="bound">view</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ùíú1</span><span class="main">,</span> <span class="bound">ùíú2</span><span class="main">,</span> <span class="bound">ùíú3</span><span class="main">)</span> <span class="main">=</span> <span class="free">ùíú</span><span class="main">;</span>
    <span class="bound">r</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">Œ±0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">Œ±1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">h0</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">Œ±0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">h1</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">Œ±1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">r</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">b0</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">r</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">Œ±0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">b1</span> <span class="main">=</span> <span class="bound">h1</span> <span class="main">[^]</span> <span class="bound">r</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span><span class="main">;</span>
    <span class="main">(</span><span class="main">(</span><span class="bound">in1</span><span class="main">,</span> <span class="bound">in2</span><span class="main">,</span> <span class="bound">in3</span><span class="main">)</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="bound">ùíú1</span> <span class="free">M</span> <span class="bound">h0</span> <span class="bound">h1</span> <span class="bound">a</span> <span class="bound">b0</span> <span class="bound">b1</span> <span class="free">z</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">h</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">h0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="bound">h1</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">b0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="bound">b1</span><span class="main">)</span><span class="main">;</span>
    <span class="main"><span class="bound">_</span></span> <span class="main">::</span> unit <span class="main">‚Üê</span> assert_spmf <span class="main">(</span><span class="main">(</span><span class="bound">in1</span><span class="main">,</span> <span class="bound">in2</span><span class="main">,</span> <span class="bound">in3</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">h</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">w0</span><span class="main">,</span><span class="bound">z0</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">w1</span><span class="main">,</span><span class="bound">z1</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="bound">ùíú2</span> <span class="bound">h0</span> <span class="bound">h1</span> <span class="bound">a</span> <span class="bound">b0</span> <span class="bound">b1</span> <span class="free">M</span> <span class="bound">s</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">x0</span> <span class="main">=</span> <span class="main">(</span><span class="bound">z0</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">inv</span> <span class="bound">w0</span> <span class="main">[^]</span> <span class="bound">Œ±0</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">x1</span> <span class="main">=</span> <span class="main">(</span><span class="bound">z1</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">inv</span> <span class="bound">w1</span> <span class="main">[^]</span> <span class="bound">Œ±1</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">f_out2</span><span class="main">)</span> <span class="main">‚Üê</span> funct_OT_12  <span class="main">(</span><span class="bound">x0</span><span class="main">,</span> <span class="bound">x1</span><span class="main">)</span> <span class="free">œÉ</span><span class="main">;</span>
    <span class="bound">adv_out</span> <span class="main">‚Üê</span> <span class="bound">ùíú3</span> <span class="bound">s'</span><span class="main">;</span>
    <span class="free">D</span> <span class="main">(</span><span class="bound">adv_out</span><span class="main">,</span> <span class="bound">f_out2</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P1_ideal_model_def assms Let_def split_def power_swap<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def Let_def P1_ideal_model_def ddh.DDH0_def assms funct_OT_12_def power_swap<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P1_real_ideal_DDH_advantage_false<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">œÉ</span> <span class="main">=</span> False"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mal_def.adv_P1 <span class="free">M</span> <span class="free">œÉ</span> <span class="free">z</span> <span class="main">(</span>P1_S1<span class="main">,</span> P1_S2<span class="main">)</span> <span class="free">ùíú</span> <span class="free">D</span> <span class="main">=</span> ddh.DDH_advantage <span class="main">(</span>P1_DDH_mal_adv_œÉ_false <span class="free">M</span> <span class="free">z</span> <span class="free">ùíú</span> <span class="free">D</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P1_adv_real_ideal_model_def ddh.DDH_advantage_def P1_ideal_ddh1_œÉ_false P1_real_ddh0_œÉ_false assms P1_advantages_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> P1_real_ideal_DDH_advantage_false_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">œÉ</span> <span class="main">=</span> False"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mal_def.adv_P1 <span class="free">M</span> <span class="free">œÉ</span> <span class="free">z</span> <span class="main">(</span>P1_S1<span class="main">,</span> P1_S2<span class="main">)</span> <span class="free">ùíú</span> <span class="free">D</span> 
          <span class="main">‚â§</span> ddh.advantage <span class="main">(</span>P1_DDH_mal_adv_œÉ_false <span class="free">M</span> <span class="free">z</span> <span class="free">ùíú</span> <span class="free">D</span><span class="main">)</span> 
            <span class="main">+</span> ddh.advantage <span class="main">(</span>ddh.DDH_ùíú' <span class="main">(</span>P1_DDH_mal_adv_œÉ_false <span class="free">M</span> <span class="free">z</span> <span class="free">ùíú</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> P1_real_ideal_DDH_advantage_false ddh.DDH_advantage_bound assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> P1_real_ideal_DDH_advantage_true<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">œÉ</span> <span class="main">=</span> True"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mal_def.adv_P1 <span class="free">M</span> <span class="free">œÉ</span> <span class="free">z</span> <span class="main">(</span>P1_S1<span class="main">,</span> P1_S2<span class="main">)</span> <span class="free">ùíú</span> <span class="free">D</span> <span class="main">=</span> ddh.DDH_advantage <span class="main">(</span>P1_DDH_mal_adv_œÉ_true <span class="free">M</span> <span class="free">z</span> <span class="free">ùíú</span> <span class="free">D</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P1_adv_real_ideal_model_def ddh.DDH_advantage_def P1_real_ddh1_œÉ_true P1_ideal_ddh0_œÉ_true assms P1_advantages_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> P1_real_ideal_DDH_advantage_true_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">œÉ</span> <span class="main">=</span> True"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mal_def.adv_P1 <span class="free">M</span> <span class="free">œÉ</span> <span class="free">z</span> <span class="main">(</span>P1_S1<span class="main">,</span> P1_S2<span class="main">)</span> <span class="free">ùíú</span> <span class="free">D</span> 
          <span class="main">‚â§</span> ddh.advantage <span class="main">(</span>P1_DDH_mal_adv_œÉ_true <span class="free">M</span> <span class="free">z</span> <span class="free">ùíú</span> <span class="free">D</span><span class="main">)</span> 
            <span class="main">+</span> ddh.advantage <span class="main">(</span>ddh.DDH_ùíú' <span class="main">(</span>P1_DDH_mal_adv_œÉ_true <span class="free">M</span> <span class="free">z</span> <span class="free">ùíú</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> P1_real_ideal_DDH_advantage_true ddh.DDH_advantage_bound assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>


<span class="comment1">(*Auxillary proofs that we use in the proof of security, mainly rewriting things for P2*)</span>

<span class="keyword1"><span class="command">lemma</span></span> P2_output_rewrite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">&lt;</span> order <span class="free">ùí¢</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">u1</span> <span class="main">+</span> <span class="free">v1</span><span class="main">)</span><span class="main">,</span>  <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">u1</span> <span class="main">+</span> <span class="free">v1</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">u1</span><span class="main">)</span>
           <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span> <span class="main">+</span> <span class="free">u1</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">v1</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">,</span>  
             <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span> <span class="main">+</span> <span class="free">u1</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">v1</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">)</span> 
               <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span> <span class="main">+</span> <span class="free">u1</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">+</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">u1</span> <span class="main">+</span> <span class="free">v1</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span> <span class="main">+</span> <span class="free">u1</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">v1</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">u1</span> <span class="main">+</span> <span class="free">v1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span> <span class="main">+</span> <span class="free">u1</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">v1</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span> <span class="main">+</span> <span class="free">u1</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">v1</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="main">(</span><span class="free">s</span> <span class="main">+</span> <span class="free">u1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">v1</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> cong_def mod_add_left_eq mod_add_right_eq mod_mult_right_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span> <span class="main">+</span> <span class="free">u1</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">v1</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">u1</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">v1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Nat.add_diff_assoc add.assoc assms distrib_left less_or_eq_imp_le mult_le_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span> <span class="main">+</span> <span class="free">u1</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">v1</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="free">u1</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">+</span> <span class="free">v1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def semiring_normalization_rules<span class="main"><span class="main">(</span></span>23<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> finite_group pow_generator_eq_iff_cong <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span> <span class="main">+</span> <span class="free">u1</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">v1</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">)</span> 
               <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span> <span class="main">+</span> <span class="free">u1</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">+</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> 
                    <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">u1</span> <span class="main">+</span> <span class="free">v1</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">u1</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span> <span class="main">+</span> <span class="free">u1</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">v1</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">u1</span> <span class="main">+</span> <span class="free">v1</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span> <span class="main">+</span> <span class="free">u1</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">v1</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">)</span> <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">u1</span> <span class="main">+</span> <span class="free">v1</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span> <span class="main">+</span> <span class="free">u1</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">v1</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">)</span> 
                  <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="main">(</span><span class="free">s</span> <span class="main">+</span> <span class="free">u1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">v1</span><span class="main">)</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> cong_def mod_add_cong mod_mult_left_eq mod_mult_right_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span> <span class="main">+</span> <span class="free">u1</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">v1</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">)</span> 
                  <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">u1</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">v1</span><span class="main">)</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distrib_left<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span> <span class="main">+</span> <span class="free">u1</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">v1</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">)</span> 
                  <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">u1</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">-</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">+</span> <span class="free">v1</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> distrib_right assms 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Groups.mult_ac<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> order_gt_0 Nat.add_diff_assoc2 add.commute diff_mult_distrib2 mult.commute mult_strict_mono order.strict_implies_order semiring_normalization_rules<span class="main"><span class="main">(</span></span>25<span class="main"><span class="main">)</span></span> zero_order<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span> <span class="main">+</span> <span class="free">u1</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">v1</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">)</span> 
                  <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">u1</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">+</span> <span class="free">v1</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def semiring_normalization_rules<span class="main"><span class="main">(</span></span>16<span class="main"><span class="main">)</span></span> semiring_normalization_rules<span class="main"><span class="main">(</span></span>23<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> finite_group pow_generator_eq_iff_cong <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span> <span class="main">+</span> <span class="free">u1</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">+</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">u1</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">s</span> <span class="main">+</span> <span class="free">u1</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">+</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">u1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">s</span> <span class="main">+</span> <span class="free">u1</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">+</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span> <span class="main">+</span> <span class="free">u1</span> <span class="main">+</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute mod_add_right_eq cong_def<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="free">s</span> <span class="main">+</span> <span class="free">u1</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">+</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">u1</span> <span class="main">+</span> order <span class="free">ùí¢</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span> <span class="main">+</span> <span class="free">u1</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">+</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">u1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> finite_group pow_generator_eq_iff_cong <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> generator_closed inverse_pow_pow<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P2_inv_g_rewrite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">&lt;</span> order <span class="free">ùí¢</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span><span class="main">)</span> <span class="main">[^]</span> <span class="main">(</span><span class="free">u1'</span> <span class="main">+</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">s</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">u1'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> power_commute_rewrite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span> <span class="main">+</span> <span class="free">u1'</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">=</span>  <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">u1'</span> <span class="main">+</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> add.commute pow_generator_mod <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">+</span> <span class="free">u1'</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">=</span> <span class="main">(</span>int <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">-</span> int <span class="free">s</span> <span class="main">+</span> int <span class="free">u1'</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_nat_add of_nat_diff order.strict_implies_order zmod_int assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span> int <span class="free">s</span> <span class="main">+</span> int <span class="free">u1'</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> add.commute minus_mod_self1 mod_add_right_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">+</span> <span class="free">u1'</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span> int <span class="free">s</span> <span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> int <span class="free">u1'</span> <span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span> <span class="main">+</span> <span class="free">u1'</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>
              <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="main">(</span><span class="main">-</span> int <span class="free">s</span> <span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> int <span class="free">u1'</span> <span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> int_pow_int<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">u1'</span> <span class="main">+</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>
              <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="main">(</span><span class="main">-</span> int <span class="free">s</span> <span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> int <span class="free">u1'</span> <span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> power_commute_rewrite <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span>
              <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="main">-</span> int <span class="free">s</span> <span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> int <span class="free">u1'</span> <span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> pow_generator_mod_int <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="main">-</span> int <span class="free">s</span> <span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span>int <span class="free">u1'</span> <span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> int_pow_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="main">-</span> int <span class="free">s</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span>int <span class="free">u1'</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> pow_generator_mod_int <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">inv</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">u1'</span> <span class="main">+</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">inv</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="main">-</span> int <span class="free">s</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span>int <span class="free">u1'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">inv</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="main">(</span><span class="free">u1'</span> <span class="main">+</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">)</span> <span class="main">=</span> <span class="keyword1">inv</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="main">-</span> int <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span>int <span class="free">u1'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pow_generator_mod 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inverse_split<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span>int <span class="free">s</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span>int <span class="free">u1'</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> int_pow_neg<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">s</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">u1'</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> int_pow_int<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inverse_pow_pow pow_generator_mod <span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P2_inv_g_s_rewrite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">&lt;</span> order <span class="free">ùí¢</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">u1</span> <span class="main">+</span> <span class="free">v1</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">u1</span> <span class="main">+</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">u1</span> <span class="main">+</span> <span class="free">v1</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">s</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">u1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> in_carrier1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">u1</span> <span class="main">+</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> in_carrier2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">u1</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> in_carrier_3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">u1</span> <span class="main">+</span> <span class="free">v1</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">)</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">u1</span> <span class="main">+</span> <span class="free">v1</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">)</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">u1</span> <span class="main">+</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>  <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">u1</span> <span class="main">+</span> <span class="free">v1</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">)</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">s</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">u1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> P2_inv_g_rewrite assms  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inverse_pow_pow<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> cyclic_group_assoc in_carrier1 in_carrier2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P2_e0_rewrite<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">&lt;</span> order <span class="free">ùí¢</span> "</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span><span class="main">,</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> <span class="free">xa</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">x</span><span class="main">)</span>  <span class="main">=</span> 
            <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">,</span>
               <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">)</span> 
                  <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">+</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> 
              <span class="main">=</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span>  
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> mod_mod_trivial cong_add cong_def mod_mult_right_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> 
              <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">xa</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.assoc distrib_left<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> 
              <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span> <span class="main">+</span> <span class="free">xa</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.assoc add.commute<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> 
              <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">xa</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">xa</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">=</span> <span class="free">xa</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="main">(</span><span class="free">s</span> <span class="main">+</span> <span class="free">x</span> <span class="main">+</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">[</span><span class="free">r</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span> <span class="main">+</span> <span class="free">xa</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>‚Ä∫</span></span> add.commute distrib_left<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms add.commute distrib_left order.strict_implies_order<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> 
              <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> <span class="free">xa</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">xa</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">=</span> <span class="free">xa</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">[</span><span class="free">r</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">xa</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>‚Ä∫</span></span> add.commute add.left_commute add_diff_cancel_left'<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> add.commute cong_add_lcancel_nat cong_def distrib_left mod_add_self2 mod_mult_right_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> cong_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> finite_group pow_generator_eq_iff_cong <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> <span class="free">xa</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">x</span> <span class="main">=</span> 
              <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">)</span> 
                  <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">+</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">)</span> 
                <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> <span class="free">xa</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">)</span> <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> <span class="free">xa</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">)</span> 
                  <span class="main">=</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> cong_add cong_def mod_mult_left_eq mod_mult_right_eq<span class="main">)</span> 
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">)</span> 
                  <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">+</span> <span class="free">xa</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.assoc distrib_left distrib_right<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">)</span> 
                  <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span> <span class="main">+</span> <span class="free">xa</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute add.left_commute<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">)</span> 
                  <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">xa</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">‚àÄ</span><span class="bound">n</span> <span class="bound">na</span><span class="main">.</span> <span class="main">¬¨</span> <span class="main">(</span><span class="bound">n</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">‚â§</span> <span class="bound">na</span> <span class="main">‚à®</span> <span class="bound">n</span> <span class="main">+</span> <span class="main">(</span><span class="bound">na</span> <span class="main">-</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> <span class="bound">na</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> ordered_cancel_comm_monoid_diff_class.add_diff_inverse<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> order <span class="free">ùí¢</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_mult_distrib2 assms less_or_eq_imp_le<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">s</span> <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span> <span class="main">-</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">s</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">s</span> <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> f1 diff_add_inverse2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">[</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span> <span class="main">+</span> <span class="free">xa</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">)</span> 
                  <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">xa</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> add.commute add.assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">)</span> 
                  <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">+</span> <span class="free">xa</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> cong_def semiring_normalization_rules<span class="main">(</span>23<span class="main">)</span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">c</span> <span class="bound">b</span> <span class="bound">a</span><span class="main">.</span> <span class="main">[</span><span class="bound">b</span> <span class="main">=</span> <span class="bound">c</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">b</span> <span class="keyword1">mod</span> <span class="bound">a</span> <span class="main">=</span> <span class="bound">c</span> <span class="keyword1">mod</span> <span class="bound">a</span><span class="main">)</span>‚Ä∫</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">‚ãÄ</span><span class="bound">c</span> <span class="bound">b</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">+</span> <span class="bound">b</span> <span class="main">+</span> <span class="bound">c</span> <span class="main">=</span> <span class="bound">a</span> <span class="main">+</span> <span class="bound">c</span> <span class="main">+</span> <span class="bound">b</span>‚Ä∫</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> finite_group pow_generator_eq_iff_cong <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">+</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">+</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">+</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">+</span> <span class="free">x</span><span class="main">+</span> <span class="free">s</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute cong_def mod_add_right_eq<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">+</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> finite_group pow_generator_eq_iff_cong <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P2_case_l_new_1_gt_e0_rewrite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">&lt;</span> order <span class="free">ùí¢</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> 
            <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">,</span>
              <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> 
                <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">)</span> <span class="main">‚äó</span>
                  <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">t</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> 
                    <span class="main">+</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span><span class="main">,</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> <span class="free">xa</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">t</span> <span class="main">*</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>
                   <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>
                                <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pow_generator_mod<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>
                  <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> <span class="free">xa</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">r</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> 
                  <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">*</span> nat <span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span>
                        <span class="main">=</span>  <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> 
                              <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">*</span> nat <span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order <span class="free">ùí¢</span> <span class="main">‚â†</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> order_gt_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span>  cong_add cong_def mod_mult_right_eq 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> mod_mod_trivial<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">r</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> 
                  <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span>
                        <span class="main">=</span>  <span class="free">r</span> <span class="main">*</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">x</span> 
                              <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">r</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> 
                <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def distrib_left mod_mult_right_eq<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> assms cong_add gr_implies_not0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">r</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> 
                    <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span>
                          <span class="main">=</span>  <span class="free">r</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">x</span> 
                                <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">xa</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ab_semigroup_mult_class.mult_ac<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> right_diff_distrib' add.assoc<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">r</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> 
                    <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span>
                          <span class="main">=</span>  <span class="free">r</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> <span class="free">xa</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
        <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">&gt;</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span> 
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">‚â§</span> order <span class="free">ùí¢</span>"</span></span> 
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">‚àÄ</span><span class="bound">x0</span> <span class="bound">x1</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">x0</span><span class="main">::</span>int<span class="main">)</span> <span class="keyword1">mod</span> <span class="bound">x1</span> <span class="main">&lt;</span> <span class="bound">x1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬¨</span> <span class="bound">x1</span> <span class="main">+</span> <span class="main">-</span> <span class="main">1</span> <span class="main">*</span> <span class="main">(</span><span class="bound">x0</span> <span class="keyword1">mod</span> <span class="bound">x1</span><span class="main">)</span> <span class="main">‚â§</span> <span class="main">0</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬¨</span> int <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">-</span> <span class="main">1</span> <span class="main">*</span> <span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">‚â§</span> <span class="main">0</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> of_nat_0_less_iff order_gt_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms 
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">‚àÄ</span><span class="bound">n</span> <span class="bound">na</span><span class="main">.</span> <span class="main">¬¨</span> <span class="bound">n</span> <span class="main">‚â§</span> <span class="bound">na</span> <span class="main">‚à®</span> <span class="main">¬¨</span> <span class="bound">na</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">&lt;</span> <span class="bound">n</span> <span class="main">*</span> nat <span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‚Äπnat <span class="main">(</span>fst <span class="main">(</span>bezw <span class="main">(</span><span class="free">t</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">‚â§</span> order <span class="free">ùí¢</span>‚Ä∫</span></span> mult_le_mono not_le<span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span>  <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="free">s</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">&lt;</span> order <span class="free">ùí¢</span>‚Ä∫</span></span> mult_less_cancel2 nat_less_le not_le not_less_zero<span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> False
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> <span class="free">xa</span> <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">*</span> nat <span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">*</span> nat <span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">0</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">r</span> <span class="main">*</span> <span class="main">(</span><span class="free">s</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">*</span> nat <span class="main">(</span>fst <span class="main">(</span>bezw <span class="main">(</span><span class="free">t</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span>‚Ä∫</span></span> diff_mult_distrib2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">[</span><span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="main">(</span><span class="free">s</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">*</span> nat <span class="main">(</span>fst <span class="main">(</span>bezw <span class="main">(</span><span class="free">t</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">*</span> nat <span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">xa</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">*</span> nat <span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">*</span> nat <span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>‚Ä∫</span></span> semiring_normalization_rules<span class="main"><span class="main">(</span></span>23<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">r</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> 
                    <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span>
                          <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> <span class="free">xa</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> mod_mult_self4 add.assoc mult.commute cong_def<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> finite_group pow_generator_eq_iff_cong <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> 
                      <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">)</span> <span class="main">‚äó</span>
                             <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">t</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> 
                                  <span class="main">+</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                                      <span class="main">=</span>  <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> <span class="free">xa</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">t</span> <span class="main">*</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">)</span>
              <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> <span class="free">xa</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">*</span> <span class="free">Œ±</span>
                  <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> <span class="free">xa</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">*</span> <span class="free">Œ±</span>
                  <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> cong_def mod_add_cong mod_mult_left_eq mod_mult_right_eq<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> 
        <span class="keyword1"><span class="command">hence</span></span> mod_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">*</span> <span class="free">Œ±</span>
                  <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">+</span> <span class="free">xa</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distrib_left distrib_right add.assoc<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> mod_eq'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">*</span> <span class="free">Œ±</span>
                  <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">xa</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> semiring_normalization_rules<span class="main"><span class="main">(</span></span>16<span class="main"><span class="main">)</span></span> diff_mult_distrib2 semiring_normalization_rules<span class="main"><span class="main">(</span></span>18<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">xa</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">*</span> <span class="free">Œ±</span>
                  <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> <span class="free">xa</span> <span class="main">*</span> <span class="free">Œ±</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mod_eq' diff_zero mult_0 plus_nat.add_0<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">hence</span></span> bound<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
          <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span>"</span></span> 
              <span class="keyword1"><span class="command">using</span></span> assms 
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_strict_mono nat_less_iff<span class="main">)</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
              <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">*</span> nat <span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
                                                      <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">*</span> nat <span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">Œ±</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> bound diff_mult_distrib2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">x</span> <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">*</span> nat <span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
                                                                  <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">Œ±</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span> <span class="main">*</span> nat <span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">Œ±</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">using</span></span> mod_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> add.assoc cong_def mod_mult_self3<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> finite_group pow_generator_eq_iff_cong <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">t</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">+</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                    <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">t</span> <span class="main">*</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">t</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">+</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span> <span class="main">*</span> <span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">t</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">+</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                    <span class="main">=</span> <span class="main">(</span><span class="free">t</span> <span class="main">*</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span> <span class="main">+</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> cong_def mod_add_left_eq mod_mult_cong <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">t</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">+</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                    <span class="main">=</span> <span class="free">t</span> <span class="main">*</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">+</span> <span class="free">x</span> <span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
          <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">‚â§</span> order <span class="free">ùí¢</span>"</span></span> 
              <span class="keyword1"><span class="command">using</span></span> nat_le_iff order.strict_implies_order order_gt_0
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> order.strict_implies_order<span class="main">)</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms diff_mult_distrib le0 linorder_neqE_nat mult_strict_mono not_le zero_less_diff<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">[</span><span class="main">(</span><span class="free">t</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="main">(</span><span class="free">s</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">*</span> nat <span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">+</span> <span class="free">s</span> <span class="main">*</span> nat <span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span> <span class="main">*</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">s</span> <span class="main">*</span> nat <span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span> <span class="main">+</span> <span class="free">s</span> <span class="main">*</span> nat <span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>‚Ä∫</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> add.commute cong_def mod_mult_right_eq mod_mult_self1<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> finite_group pow_generator_eq_iff_cong  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P2_case_l_neq_1_gt_x0_rewrite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">&lt;</span> order <span class="free">ùí¢</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">‚â†</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">t</span> <span class="main">*</span> <span class="main">(</span><span class="free">u0</span> <span class="main">+</span> <span class="main">(</span><span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">t</span> <span class="main">*</span> <span class="free">u0</span><span class="main">)</span> <span class="main">‚äó</span>  <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> gcd<span class="main">:</span> <span class="quoted"><span class="quoted">"gcd <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> prime_field coprime_imp_gcd_eq_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> inverse_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span><span class="free">t</span> <span class="main">*</span> <span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span> <span class="main">*</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Num.of_nat_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Num.of_nat_simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> cong_scalar_left order_gt_0 inverse<span class="main">)</span> 
  <span class="keyword1"><span class="command">hence</span></span> inverse_t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">t</span> <span class="main">*</span> <span class="free">u0</span> <span class="main">+</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span><span class="free">t</span> <span class="main">*</span> <span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span><span class="free">t</span> <span class="main">*</span> <span class="free">u0</span> <span class="main">+</span> <span class="free">s</span> <span class="main">*</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cong_add_lcancel <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"int <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span> <span class="main">‚â•</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> order_gt_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">t</span> <span class="main">*</span> <span class="main">(</span><span class="free">u0</span> <span class="main">+</span> <span class="main">(</span><span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span> <span class="main">*</span> <span class="free">u0</span> <span class="main">+</span> <span class="free">s</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">t</span> <span class="main">*</span> <span class="main">(</span><span class="free">u0</span> <span class="main">+</span> <span class="main">(</span><span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span> <span class="main">*</span> <span class="free">u0</span> <span class="main">+</span> <span class="free">t</span> <span class="main">*</span> <span class="main">(</span><span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distrib_left<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">t</span> <span class="main">*</span> <span class="main">(</span><span class="free">u0</span> <span class="main">+</span> <span class="main">(</span><span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span> <span class="main">*</span> <span class="free">u0</span> <span class="main">+</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span><span class="free">t</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ab_semigroup_mult_class.mult_ac<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> mult.left_commute<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">t</span> <span class="main">*</span> <span class="main">(</span><span class="free">u0</span> <span class="main">+</span> <span class="main">(</span><span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span> <span class="main">*</span> <span class="free">u0</span> <span class="main">+</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span><span class="free">t</span> <span class="main">*</span> <span class="main">(</span> <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eq 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distrib_left mult.commute semiring_normalization_rules<span class="main"><span class="main">(</span></span>18<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">t</span> <span class="main">*</span> <span class="main">(</span><span class="free">u0</span> <span class="main">+</span> <span class="main">(</span><span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span> <span class="main">*</span> <span class="free">u0</span> <span class="main">+</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span><span class="free">t</span> <span class="main">*</span> <span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> cong_def mod_add_right_eq mod_mult_right_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">t</span> <span class="main">*</span> <span class="main">(</span><span class="free">u0</span> <span class="main">+</span> <span class="main">(</span><span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span> <span class="main">*</span> <span class="free">u0</span> <span class="main">+</span> <span class="free">s</span> <span class="main">*</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inverse_t'  
      <span class="keyword1"><span class="command">using</span></span> cong_trans cong_int_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">t</span> <span class="main">*</span> <span class="main">(</span><span class="free">u0</span> <span class="main">+</span> <span class="main">(</span><span class="free">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="free">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">t</span> <span class="main">*</span> <span class="free">u0</span> <span class="main">+</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finite_group pow_generator_eq_iff_cong <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nat_pow_mult<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚Äπ Now we show the two end definitions are equal when the input for l (in the ideal model, the second input) is the one constructed by the simulator ‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P2_ideal_real_end_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> b0_inv_b1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="free">b1</span> <span class="main">=</span> <span class="main">(</span><span class="free">h0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="free">h1</span><span class="main">)</span> <span class="main">[^]</span> <span class="free">r</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> assert_in_carrier<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h0</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span> <span class="main">‚àß</span> <span class="free">h1</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span> <span class="main">‚àß</span> <span class="free">b0</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span> <span class="main">‚àß</span> <span class="free">b1</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> x1_in_carrier<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x1</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> x0_in_carrier<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x0</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"P2_ideal_model_end <span class="main">(</span><span class="free">x0</span><span class="main">,</span><span class="free">x1</span><span class="main">)</span> <span class="main">(</span><span class="free">b0</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">inv</span> <span class="main">(</span><span class="free">h0</span> <span class="main">[^]</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">h0</span><span class="main">,</span><span class="free">h1</span><span class="main">,</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span><span class="main">,</span><span class="free">b0</span><span class="main">,</span><span class="free">b1</span><span class="main">)</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span> <span class="free">ùíú3</span> <span class="main">=</span> P2_real_model_end <span class="main">(</span><span class="free">x0</span><span class="main">,</span><span class="free">x1</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">h0</span><span class="main">,</span><span class="free">h1</span><span class="main">,</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span><span class="main">,</span><span class="free">b0</span><span class="main">,</span><span class="free">b1</span><span class="main">)</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span> <span class="free">ùíú3</span>"</span></span>
  <span class="keyword1"><span class="command">including</span></span> monad_normalisation
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b0</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">inv</span> <span class="main">(</span><span class="free">h0</span> <span class="main">[^]</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">ùü≠</span>"</span></span><span class="main">)</span> <span class="comment1">‚Äï ‚Äπ The case distinctions follow the 3 cases give on p 193/194*) ‚Ä∫</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">have</span></span> b1_h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b1</span> <span class="main">=</span> <span class="free">h1</span> <span class="main">[^]</span> <span class="free">r</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> b0_inv_b1 assert_in_carrier <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="free">b1</span> <span class="main">=</span> <span class="free">h0</span> <span class="main">[^]</span> <span class="free">r</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="free">h1</span> <span class="main">[^]</span> <span class="free">r</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pow_mult_distrib cyclic_group_commute monoid_comm_monoidI<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">b0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="free">h0</span> <span class="main">[^]</span> <span class="free">r</span> <span class="main">=</span> <span class="free">b1</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="free">h1</span> <span class="main">[^]</span> <span class="free">r</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Units_eq Units_l_cancel local.inv_equality True assert_in_carrier 
              cyclic_group.inverse_pow_pow cyclic_group_axioms 
                  inv_closed nat_pow_closed r_inv<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">ùü≠</span> <span class="main">=</span> <span class="free">b1</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="free">h1</span> <span class="main">[^]</span> <span class="free">r</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assert_in_carrier inverse_pow_pow<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">ùü≠</span> <span class="main">‚äó</span> <span class="free">h1</span> <span class="main">[^]</span> <span class="free">r</span> <span class="main">=</span> <span class="free">b1</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assert_in_carrier cyclic_group.inverse_pow_pow cyclic_group_axioms inv_closed inv_inv l_one local.inv_equality nat_pow_closed<span class="main">)</span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> assert_in_carrier l_one <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Œ±</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> Œ±<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">Œ±</span> <span class="main">=</span> <span class="free">h1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Œ±</span> <span class="main">&lt;</span> order <span class="free">ùí¢</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mod_less_divisor assert_in_carrier generatorE order_gt_0 pow_generator_mod<span class="main">)</span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">s</span> <span class="main">=</span> <span class="free">x1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">&lt;</span> order <span class="free">ùí¢</span>"</span></span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> mod_less_divisor generatorE order_gt_0 pow_generator_mod<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b1</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="skolem">Œ±</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Œ± b1_h1 generator_closed mult.commute nat_pow_pow<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> a_g_exp_rewrite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="skolem">u0</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">v0</span> <span class="main">=</span>  <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="skolem">u0</span> <span class="main">+</span> <span class="skolem">v0</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">u0</span> <span class="skolem">v0</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nat_pow_mult nat_pow_pow<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> z1_rewrite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b1</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span><span class="main">)</span> <span class="main">[^]</span> <span class="skolem">u1</span> <span class="main">‚äó</span> <span class="free">h1</span> <span class="main">[^]</span> <span class="skolem">v1</span> <span class="main">‚äó</span> <span class="main">ùü≠</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="skolem">Œ±</span> <span class="main">*</span> <span class="skolem">u1</span> <span class="main">+</span>  <span class="skolem">v1</span> <span class="main">*</span> <span class="skolem">Œ±</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">u1</span>"</span></span> 
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">u1</span> <span class="skolem">v1</span> <span class="main">::</span> <span class="quoted">nat</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Œ± b1_h1 pow_mult_distrib cyclic_group_commute generator_closed inv_closed m_assoc m_closed monoid_comm_monoidI mult.commute nat_pow_closed nat_pow_mult nat_pow_pow r_one<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> z1_rewrite'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="skolem">Œ±</span> <span class="main">*</span> <span class="skolem">u1</span> <span class="main">+</span> <span class="skolem">v1</span> <span class="main">*</span> <span class="skolem">Œ±</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">s</span> <span class="main">‚äó</span>  <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">u1</span> <span class="main">=</span> <span class="main">(</span><span class="free">b1</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span><span class="main">)</span> <span class="main">[^]</span> <span class="skolem">u1</span> <span class="main">‚äó</span> <span class="free">h1</span> <span class="main">[^]</span> <span class="skolem">v1</span> <span class="main">‚äó</span> <span class="free">x1</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">u1</span> <span class="skolem">v1</span> 
    <span class="keyword1"><span class="command">using</span></span> assert_in_carrier cyclic_group_commute m_assoc s z1_rewrite <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"P2_ideal_model_end <span class="main">(</span><span class="free">x0</span><span class="main">,</span><span class="free">x1</span><span class="main">)</span> <span class="main">(</span><span class="free">b0</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">inv</span> <span class="main">(</span><span class="free">h0</span> <span class="main">[^]</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">h0</span><span class="main">,</span><span class="free">h1</span><span class="main">,</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span><span class="main">,</span><span class="free">b0</span><span class="main">,</span><span class="free">b1</span><span class="main">)</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span> <span class="free">ùíú3</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">u0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">u1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w0</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u0</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">v0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w1</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u1</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">v1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z0</span> <span class="main">=</span> <span class="free">b0</span> <span class="main">[^]</span> <span class="bound">u0</span> <span class="main">‚äó</span> <span class="free">h0</span> <span class="main">[^]</span> <span class="bound">v0</span> <span class="main">‚äó</span> <span class="free">x0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z1</span> <span class="main">=</span> <span class="main">(</span><span class="free">b1</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u1</span> <span class="main">‚äó</span> <span class="free">h1</span> <span class="main">[^]</span> <span class="bound">v1</span> <span class="main">‚äó</span> <span class="main">ùü≠</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e0</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w0</span><span class="main">,</span><span class="bound">z0</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e1</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w1</span><span class="main">,</span><span class="bound">z1</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">out</span> <span class="main">‚Üê</span> <span class="free">ùíú3</span> <span class="bound">e0</span> <span class="bound">e1</span> <span class="free">s'</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="bound">out</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P2_ideal_model_end_def True funct_OT_12_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">u0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">u1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w0</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u0</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">v0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w1</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u1</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">v1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z0</span> <span class="main">=</span> <span class="free">b0</span> <span class="main">[^]</span> <span class="bound">u0</span> <span class="main">‚äó</span> <span class="free">h0</span> <span class="main">[^]</span> <span class="bound">v0</span> <span class="main">‚äó</span> <span class="free">x0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z1</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="skolem">Œ±</span> <span class="main">*</span> <span class="bound">u1</span> <span class="main">+</span> <span class="bound">v1</span> <span class="main">*</span> <span class="skolem">Œ±</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">u1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e0</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w0</span><span class="main">,</span><span class="bound">z0</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e1</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w1</span><span class="main">,</span><span class="bound">z1</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">out</span> <span class="main">‚Üê</span> <span class="free">ùíú3</span> <span class="bound">e0</span> <span class="bound">e1</span> <span class="free">s'</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="bound">out</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> z1_rewrite<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">u0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">u1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w0</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u0</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">v0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w1</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="bound">u1</span> <span class="main">+</span> <span class="bound">v1</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z0</span> <span class="main">=</span> <span class="free">b0</span> <span class="main">[^]</span> <span class="bound">u0</span> <span class="main">‚äó</span> <span class="free">h0</span> <span class="main">[^]</span> <span class="bound">v0</span> <span class="main">‚äó</span> <span class="free">x0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z1</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="skolem">Œ±</span> <span class="main">*</span> <span class="bound">u1</span> <span class="main">+</span> <span class="bound">v1</span> <span class="main">*</span> <span class="skolem">Œ±</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">u1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e0</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w0</span><span class="main">,</span><span class="bound">z0</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e1</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w1</span><span class="main">,</span><span class="bound">z1</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">out</span> <span class="main">‚Üê</span> <span class="free">ùíú3</span> <span class="bound">e0</span> <span class="bound">e1</span> <span class="free">s'</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="bound">out</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_g_exp_rewrite<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">u0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">u1</span> <span class="main">‚Üê</span> map_spmf <span class="main">(</span><span class="main">Œª</span> <span class="bound">u1'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">s</span> <span class="main">+</span> <span class="bound">u1'</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v1</span> <span class="main">‚Üê</span> map_spmf <span class="main">(</span><span class="main">Œª</span> <span class="bound">v1'</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">r</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="free">r</span> <span class="main">*</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">+</span> <span class="bound">v1'</span><span class="main">)</span>  <span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w0</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u0</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">v0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w1</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="bound">u1</span> <span class="main">+</span> <span class="bound">v1</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z0</span> <span class="main">=</span> <span class="free">b0</span> <span class="main">[^]</span> <span class="bound">u0</span> <span class="main">‚äó</span> <span class="free">h0</span> <span class="main">[^]</span> <span class="bound">v0</span> <span class="main">‚äó</span> <span class="free">x0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z1</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="skolem">Œ±</span> <span class="main">*</span> <span class="bound">u1</span> <span class="main">+</span> <span class="bound">v1</span> <span class="main">*</span> <span class="skolem">Œ±</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="bound">u1</span> <span class="main">+</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e0</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w0</span><span class="main">,</span><span class="bound">z0</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e1</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w1</span><span class="main">,</span><span class="bound">z1</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">out</span> <span class="main">‚Üê</span> <span class="free">ùíú3</span> <span class="bound">e0</span> <span class="bound">e1</span> <span class="free">s'</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="bound">out</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_map_spmf o_def Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> P2_output_rewrite assms s_lt assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">u0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">u1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w0</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u0</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">v0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w1</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="bound">u1</span> <span class="main">+</span> <span class="bound">v1</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z0</span> <span class="main">=</span> <span class="free">b0</span> <span class="main">[^]</span> <span class="bound">u0</span> <span class="main">‚äó</span> <span class="free">h0</span> <span class="main">[^]</span> <span class="bound">v0</span> <span class="main">‚äó</span> <span class="free">x0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z1</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="skolem">Œ±</span> <span class="main">*</span> <span class="bound">u1</span> <span class="main">+</span> <span class="bound">v1</span> <span class="main">*</span> <span class="skolem">Œ±</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="bound">u1</span> <span class="main">+</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e0</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w0</span><span class="main">,</span><span class="bound">z0</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e1</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w1</span><span class="main">,</span><span class="bound">z1</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">out</span> <span class="main">‚Üê</span> <span class="free">ùíú3</span> <span class="bound">e0</span> <span class="bound">e1</span> <span class="free">s'</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="bound">out</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> samp_uni_plus_one_time_pad<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">u0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">u1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w0</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u0</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">v0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w1</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="bound">u1</span> <span class="main">+</span> <span class="bound">v1</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z0</span> <span class="main">=</span> <span class="free">b0</span> <span class="main">[^]</span> <span class="bound">u0</span> <span class="main">‚äó</span> <span class="free">h0</span> <span class="main">[^]</span> <span class="bound">v0</span> <span class="main">‚äó</span> <span class="free">x0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z1</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="skolem">Œ±</span> <span class="main">*</span> <span class="bound">u1</span> <span class="main">+</span> <span class="bound">v1</span> <span class="main">*</span> <span class="skolem">Œ±</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">s</span> <span class="main">‚äó</span>  <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">u1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e0</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w0</span><span class="main">,</span><span class="bound">z0</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e1</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w1</span><span class="main">,</span><span class="bound">z1</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">out</span> <span class="main">‚Üê</span> <span class="free">ùíú3</span> <span class="bound">e0</span> <span class="bound">e1</span> <span class="free">s'</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="bound">out</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P2_inv_g_s_rewrite assms s_lt <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> bind_spmf_cong_simp<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">u0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">u1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w0</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u0</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">v0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w1</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u1</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">v1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z0</span> <span class="main">=</span> <span class="free">b0</span> <span class="main">[^]</span> <span class="bound">u0</span> <span class="main">‚äó</span> <span class="free">h0</span> <span class="main">[^]</span> <span class="bound">v0</span> <span class="main">‚äó</span> <span class="free">x0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z1</span> <span class="main">=</span> <span class="main">(</span><span class="free">b1</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u1</span> <span class="main">‚äó</span> <span class="free">h1</span> <span class="main">[^]</span> <span class="bound">v1</span> <span class="main">‚äó</span> <span class="free">x1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e0</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w0</span><span class="main">,</span><span class="bound">z0</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e1</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w1</span><span class="main">,</span><span class="bound">z1</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">out</span> <span class="main">‚Üê</span> <span class="free">ùíú3</span> <span class="bound">e0</span> <span class="bound">e1</span> <span class="free">s'</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="bound">out</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_g_exp_rewrite z1_rewrite'<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P2_real_model_end_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Œ±</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> Œ±<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">Œ±</span> <span class="main">=</span> <span class="free">h0</span>"</span></span>  
    <span class="keyword1"><span class="command">using</span></span> generatorE assms  
    <span class="keyword1"><span class="command">using</span></span> assert_in_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> w0_rewrite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="skolem">u0</span> <span class="main">+</span> <span class="skolem">v0</span><span class="main">)</span> <span class="main">=</span>  <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="skolem">u0</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">v0</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">u0</span> <span class="skolem">v0</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nat_pow_mult nat_pow_pow<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> order_gt_0<span class="main">:</span> <span class="quoted"><span class="quoted">"order <span class="free">ùí¢</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> order_gt_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">s</span> <span class="main">=</span> <span class="free">x0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">&lt;</span> order <span class="free">ùí¢</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mod_less_divisor generatorE order_gt_0 pow_generator_mod x0_in_carrier<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False <span class="comment1">‚Äï ‚Äπcase 2‚Ä∫</span>
  <span class="keyword1"><span class="command">hence</span></span> l_neq_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b0</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">inv</span> <span class="main">(</span><span class="free">h0</span> <span class="main">[^]</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">‚â†</span> <span class="main">ùü≠</span>"</span></span><span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b0</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">inv</span> <span class="main">(</span><span class="free">h0</span> <span class="main">[^]</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">b0</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">‚äó</span> <span class="free">h0</span> <span class="main">[^]</span> <span class="free">r</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assert_in_carrier generator_closed inv_solve_right nat_pow_closed<span class="main">)</span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">b0</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="skolem">Œ±</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Œ± generator_closed mult.commute nat_pow_pow<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> z0_rewrite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b0</span> <span class="main">[^]</span> <span class="skolem">u0</span> <span class="main">‚äó</span> <span class="free">h0</span> <span class="main">[^]</span> <span class="skolem">v0</span> <span class="main">‚äó</span> <span class="main">ùü≠</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="skolem">Œ±</span> <span class="main">*</span> <span class="skolem">u0</span> <span class="main">+</span> <span class="skolem">v0</span> <span class="main">*</span> <span class="skolem">Œ±</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">u0</span>"</span></span> 
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">u0</span> <span class="skolem">v0</span> <span class="main">::</span> <span class="quoted">nat</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Œ± <span class="quoted"><span class="quoted">‚Äπ<span class="free">b0</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="skolem">Œ±</span><span class="main">)</span>‚Ä∫</span></span> pow_mult_distrib cyclic_group_commute generator_closed m_assoc monoid_comm_monoidI mult.commute nat_pow_closed nat_pow_mult nat_pow_pow r_one<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> z0_rewrite'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="skolem">Œ±</span> <span class="main">*</span> <span class="skolem">u0</span> <span class="main">+</span> <span class="skolem">v0</span> <span class="main">*</span> <span class="skolem">Œ±</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">u0</span> <span class="main">+</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span>  <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="skolem">Œ±</span> <span class="main">*</span> <span class="skolem">u0</span> <span class="main">+</span> <span class="skolem">v0</span> <span class="main">*</span> <span class="skolem">Œ±</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">u0</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">u0</span> <span class="skolem">v0</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.assoc nat_pow_mult<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> z0_rewrite''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="skolem">Œ±</span> <span class="main">*</span> <span class="skolem">u0</span> <span class="main">+</span> <span class="skolem">v0</span> <span class="main">*</span> <span class="skolem">Œ±</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">u0</span> <span class="main">‚äó</span> <span class="free">x0</span> <span class="main">=</span>  <span class="free">b0</span> <span class="main">[^]</span> <span class="skolem">u0</span> <span class="main">‚äó</span> <span class="free">h0</span> <span class="main">[^]</span> <span class="skolem">v0</span> <span class="main">‚äó</span> <span class="free">x0</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">u0</span> <span class="skolem">v0</span> <span class="keyword1"><span class="command">using</span></span> z0_rewrite 
      <span class="keyword1"><span class="command">using</span></span> assert_in_carrier <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"P2_ideal_model_end <span class="main">(</span><span class="free">x0</span><span class="main">,</span><span class="free">x1</span><span class="main">)</span> <span class="main">(</span><span class="free">b0</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">inv</span> <span class="main">(</span><span class="free">h0</span> <span class="main">[^]</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">h0</span><span class="main">,</span><span class="free">h1</span><span class="main">,</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span><span class="main">,</span><span class="free">b0</span><span class="main">,</span><span class="free">b1</span><span class="main">)</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span> <span class="free">ùíú3</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">u0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">u1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w0</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u0</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">v0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w1</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u1</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">v1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z0</span> <span class="main">=</span> <span class="free">b0</span> <span class="main">[^]</span> <span class="bound">u0</span> <span class="main">‚äó</span> <span class="free">h0</span> <span class="main">[^]</span> <span class="bound">v0</span> <span class="main">‚äó</span> <span class="main">ùü≠</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z1</span> <span class="main">=</span> <span class="main">(</span><span class="free">b1</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u1</span> <span class="main">‚äó</span> <span class="free">h1</span> <span class="main">[^]</span> <span class="bound">v1</span> <span class="main">‚äó</span> <span class="free">x1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e0</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w0</span><span class="main">,</span><span class="bound">z0</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e1</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w1</span><span class="main">,</span><span class="bound">z1</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">out</span> <span class="main">‚Üê</span> <span class="free">ùíú3</span> <span class="bound">e0</span> <span class="bound">e1</span> <span class="free">s'</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="bound">out</span><span class="main">)</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P2_ideal_model_end_def True funct_OT_12_def<span class="main">)</span> 
      <span class="keyword1"><span class="command">using</span></span> order_gt_0 order_gt_1_gen_not_1 True l_neq_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">u0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">u1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w0</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="bound">u0</span> <span class="main">+</span> <span class="bound">v0</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w1</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u1</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">v1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z0</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="skolem">Œ±</span> <span class="main">*</span> <span class="bound">u0</span> <span class="main">+</span> <span class="bound">v0</span> <span class="main">*</span> <span class="skolem">Œ±</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">u0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z1</span> <span class="main">=</span> <span class="main">(</span><span class="free">b1</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u1</span> <span class="main">‚äó</span> <span class="free">h1</span> <span class="main">[^]</span> <span class="bound">v1</span> <span class="main">‚äó</span> <span class="free">x1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e0</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w0</span><span class="main">,</span><span class="bound">z0</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e1</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w1</span><span class="main">,</span><span class="bound">z1</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">out</span> <span class="main">‚Üê</span> <span class="free">ùíú3</span> <span class="bound">e0</span> <span class="bound">e1</span> <span class="free">s'</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="bound">out</span><span class="main">)</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> z0_rewrite w0_rewrite<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">u0</span> <span class="main">‚Üê</span> map_spmf <span class="main">(</span><span class="main">Œª</span> <span class="bound">u0</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">+</span> <span class="bound">u0</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v0</span> <span class="main">‚Üê</span> map_spmf <span class="main">(</span><span class="main">Œª</span> <span class="bound">v0</span><span class="main">.</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="skolem">s</span> <span class="main">+</span> <span class="bound">v0</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">u1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w0</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="bound">u0</span> <span class="main">+</span> <span class="bound">v0</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w1</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u1</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">v1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z0</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="skolem">Œ±</span> <span class="main">*</span> <span class="bound">u0</span> <span class="main">+</span> <span class="bound">v0</span> <span class="main">*</span> <span class="skolem">Œ±</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="bound">u0</span> <span class="main">+</span> <span class="skolem">s</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z1</span> <span class="main">=</span> <span class="main">(</span><span class="free">b1</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u1</span> <span class="main">‚äó</span> <span class="free">h1</span> <span class="main">[^]</span> <span class="bound">v1</span> <span class="main">‚äó</span> <span class="free">x1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e0</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w0</span><span class="main">,</span><span class="bound">z0</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e1</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w1</span><span class="main">,</span><span class="bound">z1</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">out</span> <span class="main">‚Üê</span> <span class="free">ùíú3</span> <span class="bound">e0</span> <span class="bound">e1</span> <span class="free">s'</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="bound">out</span><span class="main">)</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_map_spmf o_def Let_def <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> bind_spmf_cong_simp<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> P2_e0_rewrite assms s_lt assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span> 
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">u0</span> <span class="main">‚Üê</span> map_spmf <span class="main">(</span><span class="main">Œª</span> <span class="bound">u0</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">+</span> <span class="bound">u0</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v0</span> <span class="main">‚Üê</span> map_spmf <span class="main">(</span><span class="main">Œª</span> <span class="bound">v0</span><span class="main">.</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="skolem">s</span> <span class="main">+</span> <span class="bound">v0</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">u1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w0</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="bound">u0</span> <span class="main">+</span> <span class="bound">v0</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w1</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u1</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">v1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z0</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="skolem">Œ±</span> <span class="main">*</span> <span class="bound">u0</span> <span class="main">+</span> <span class="bound">v0</span> <span class="main">*</span> <span class="skolem">Œ±</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">u0</span> <span class="main">‚äó</span> <span class="free">x0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z1</span> <span class="main">=</span> <span class="main">(</span><span class="free">b1</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u1</span> <span class="main">‚äó</span> <span class="free">h1</span> <span class="main">[^]</span> <span class="bound">v1</span> <span class="main">‚äó</span> <span class="free">x1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e0</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w0</span><span class="main">,</span><span class="bound">z0</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e1</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w1</span><span class="main">,</span><span class="bound">z1</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">out</span> <span class="main">‚Üê</span> <span class="free">ùíú3</span> <span class="bound">e0</span> <span class="bound">e1</span> <span class="free">s'</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="bound">out</span><span class="main">)</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> z0_rewrite' s<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">u0</span> <span class="main">‚Üê</span> map_spmf <span class="main">(</span><span class="main">Œª</span> <span class="bound">u0</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">-</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">+</span> <span class="bound">u0</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v0</span> <span class="main">‚Üê</span> map_spmf <span class="main">(</span><span class="main">Œª</span> <span class="bound">v0</span><span class="main">.</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="skolem">s</span> <span class="main">+</span> <span class="bound">v0</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">u1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w0</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u0</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">v0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w1</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u1</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">v1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z0</span> <span class="main">=</span> <span class="free">b0</span> <span class="main">[^]</span> <span class="bound">u0</span> <span class="main">‚äó</span> <span class="free">h0</span> <span class="main">[^]</span> <span class="bound">v0</span> <span class="main">‚äó</span> <span class="free">x0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z1</span> <span class="main">=</span> <span class="main">(</span><span class="free">b1</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u1</span> <span class="main">‚äó</span> <span class="free">h1</span> <span class="main">[^]</span> <span class="bound">v1</span> <span class="main">‚äó</span> <span class="free">x1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e0</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w0</span><span class="main">,</span><span class="bound">z0</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e1</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w1</span><span class="main">,</span><span class="bound">z1</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">out</span> <span class="main">‚Üê</span> <span class="free">ùíú3</span> <span class="bound">e0</span> <span class="bound">e1</span> <span class="free">s'</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="bound">out</span><span class="main">)</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> w0_rewrite z0_rewrite''<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">u0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">u1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w0</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u0</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">v0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w1</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u1</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">v1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z0</span> <span class="main">=</span> <span class="free">b0</span> <span class="main">[^]</span> <span class="bound">u0</span> <span class="main">‚äó</span> <span class="free">h0</span> <span class="main">[^]</span> <span class="bound">v0</span> <span class="main">‚äó</span> <span class="free">x0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z1</span> <span class="main">=</span> <span class="main">(</span><span class="free">b1</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u1</span> <span class="main">‚äó</span> <span class="free">h1</span> <span class="main">[^]</span> <span class="bound">v1</span> <span class="main">‚äó</span> <span class="free">x1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e0</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w0</span><span class="main">,</span><span class="bound">z0</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e1</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w1</span><span class="main">,</span><span class="bound">z1</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">out</span> <span class="main">‚Üê</span> <span class="free">ùíú3</span> <span class="bound">e0</span> <span class="bound">e1</span> <span class="free">s'</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="bound">out</span><span class="main">)</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> samp_uni_plus_one_time_pad<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P2_real_model_end_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">case</span></span> False <span class="comment1">‚Äï ‚Äπcase 3‚Ä∫</span>
    <span class="keyword1"><span class="command">have</span></span> b0_l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b0</span> <span class="main">=</span> <span class="main">(</span><span class="free">b0</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">inv</span> <span class="main">(</span><span class="free">h0</span> <span class="main">[^]</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="free">h0</span> <span class="main">[^]</span> <span class="free">r</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assert_in_carrier m_assoc<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> b0_g_r<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">b0</span> <span class="main">=</span> <span class="main">(</span><span class="free">b0</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">inv</span> <span class="main">(</span><span class="free">h0</span> <span class="main">[^]</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="skolem">Œ±</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Œ± b0_l generator_closed mult.commute nat_pow_pow<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">t</span> <span class="main">=</span> <span class="main">(</span><span class="free">b0</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">inv</span> <span class="main">(</span><span class="free">h0</span> <span class="main">[^]</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t_lt_order_g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">&lt;</span> order <span class="free">ùí¢</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> mod_less_divisor order_gt_0 pow_generator_mod 
                assert_in_carrier cyclic_group.generatorE cyclic_group_axioms 
                      inv_closed m_closed nat_pow_closed<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> l_neq_1 <span class="keyword1"><span class="command">have</span></span> t_neq_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">‚â†</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l_neq_1_exp_neq_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> z0_rewrite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b0</span> <span class="main">[^]</span> <span class="skolem">u0</span> <span class="main">‚äó</span> <span class="free">h0</span> <span class="main">[^]</span> <span class="skolem">v0</span> <span class="main">‚äó</span> <span class="main">ùü≠</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="skolem">Œ±</span> <span class="main">*</span> <span class="skolem">u0</span> <span class="main">+</span> <span class="skolem">v0</span> <span class="main">*</span> <span class="skolem">Œ±</span><span class="main">)</span> <span class="main">‚äó</span> <span class="main">(</span><span class="main">(</span><span class="free">b0</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">inv</span> <span class="main">(</span><span class="free">h0</span> <span class="main">[^]</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="skolem">u0</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">u0</span> <span class="skolem">v0</span> 
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> b0_l <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b0</span> <span class="main">[^]</span> <span class="skolem">u0</span> <span class="main">‚äó</span> <span class="free">h0</span> <span class="main">[^]</span> <span class="skolem">v0</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">b0</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">inv</span> <span class="main">(</span><span class="free">h0</span> <span class="main">[^]</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="free">h0</span> <span class="main">[^]</span> <span class="free">r</span><span class="main">)</span> <span class="main">[^]</span> <span class="skolem">u0</span> <span class="main">‚äó</span> <span class="free">h0</span> <span class="main">[^]</span> <span class="skolem">v0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">b0</span> <span class="main">[^]</span> <span class="skolem">u0</span> <span class="main">‚äó</span> <span class="free">h0</span> <span class="main">[^]</span> <span class="skolem">v0</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">b0</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">inv</span> <span class="main">(</span><span class="free">h0</span> <span class="main">[^]</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="skolem">u0</span> <span class="main">‚äó</span> <span class="main">(</span><span class="free">h0</span> <span class="main">[^]</span> <span class="free">r</span><span class="main">)</span> <span class="main">[^]</span> <span class="skolem">u0</span> <span class="main">‚äó</span> <span class="free">h0</span> <span class="main">[^]</span> <span class="skolem">v0</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assert_in_carrier pow_mult_distrib cyclic_group_commute monoid_comm_monoidI<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">b0</span> <span class="main">[^]</span> <span class="skolem">u0</span> <span class="main">‚äó</span> <span class="free">h0</span> <span class="main">[^]</span> <span class="skolem">v0</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">Œ±</span><span class="main">)</span> <span class="main">[^]</span> <span class="free">r</span><span class="main">)</span> <span class="main">[^]</span> <span class="skolem">u0</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">Œ±</span><span class="main">)</span> <span class="main">[^]</span> <span class="skolem">v0</span> <span class="main">‚äó</span> <span class="main">(</span><span class="main">(</span><span class="free">b0</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">inv</span> <span class="main">(</span><span class="free">h0</span> <span class="main">[^]</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="skolem">u0</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> cyclic_group_assoc cyclic_group_commute assert_in_carrier Œ± <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">b0</span> <span class="main">[^]</span> <span class="skolem">u0</span> <span class="main">‚äó</span> <span class="free">h0</span> <span class="main">[^]</span> <span class="skolem">v0</span> <span class="main">=</span>  <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="skolem">Œ±</span> <span class="main">*</span> <span class="skolem">u0</span> <span class="main">+</span> <span class="skolem">v0</span> <span class="main">*</span> <span class="skolem">Œ±</span><span class="main">)</span> <span class="main">‚äó</span>  <span class="main">(</span><span class="main">(</span><span class="free">b0</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">inv</span> <span class="main">(</span><span class="free">h0</span> <span class="main">[^]</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="skolem">u0</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monoid.nat_pow_pow mult.commute nat_pow_mult<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assert_in_carrier<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> z0_rewrite'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="skolem">Œ±</span> <span class="main">*</span> <span class="skolem">u0</span> <span class="main">+</span> <span class="skolem">v0</span> <span class="main">*</span> <span class="skolem">Œ±</span><span class="main">)</span> <span class="main">‚äó</span> <span class="main">(</span><span class="main">(</span><span class="free">b0</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">inv</span> <span class="main">(</span><span class="free">h0</span> <span class="main">[^]</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="skolem">u0</span> <span class="main">=</span>  <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="skolem">Œ±</span> <span class="main">*</span> <span class="skolem">u0</span> <span class="main">+</span> <span class="skolem">v0</span> <span class="main">*</span> <span class="skolem">Œ±</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">*</span> <span class="skolem">u0</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">u0</span> <span class="skolem">v0</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> generator_closed nat_pow_pow t<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> z0_rewrite''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="skolem">Œ±</span> <span class="main">*</span> <span class="skolem">u0</span> <span class="main">+</span> <span class="skolem">v0</span> <span class="main">*</span> <span class="skolem">Œ±</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">*</span> <span class="skolem">u0</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">s</span> <span class="main">=</span>  <span class="free">b0</span> <span class="main">[^]</span> <span class="skolem">u0</span> <span class="main">‚äó</span> <span class="free">h0</span> <span class="main">[^]</span> <span class="skolem">v0</span> <span class="main">‚äó</span> <span class="free">x0</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">u0</span> <span class="skolem">v0</span> 
      <span class="keyword1"><span class="command">using</span></span> assert_in_carrier s z0_rewrite z0_rewrite' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"P2_ideal_model_end <span class="main">(</span><span class="free">x0</span><span class="main">,</span><span class="free">x1</span><span class="main">)</span> <span class="main">(</span><span class="free">b0</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">inv</span> <span class="main">(</span><span class="free">h0</span> <span class="main">[^]</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">h0</span><span class="main">,</span><span class="free">h1</span><span class="main">,</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span><span class="main">,</span><span class="free">b0</span><span class="main">,</span><span class="free">b1</span><span class="main">)</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span> <span class="free">ùíú3</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">u0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">u1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w0</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="bound">u0</span> <span class="main">+</span> <span class="bound">v0</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w1</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u1</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">v1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z0</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="skolem">Œ±</span> <span class="main">*</span> <span class="bound">u0</span> <span class="main">+</span> <span class="bound">v0</span> <span class="main">*</span> <span class="skolem">Œ±</span><span class="main">)</span> <span class="main">‚äó</span> <span class="main">(</span><span class="main">(</span><span class="free">b0</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">inv</span> <span class="main">(</span><span class="free">h0</span> <span class="main">[^]</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z1</span> <span class="main">=</span> <span class="main">(</span><span class="free">b1</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u1</span> <span class="main">‚äó</span> <span class="free">h1</span> <span class="main">[^]</span> <span class="bound">v1</span> <span class="main">‚äó</span> <span class="free">x1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e0</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w0</span><span class="main">,</span><span class="bound">z0</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e1</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w1</span><span class="main">,</span><span class="bound">z1</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">out</span> <span class="main">‚Üê</span> <span class="free">ùíú3</span> <span class="bound">e0</span> <span class="bound">e1</span> <span class="free">s'</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="bound">out</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P2_ideal_model_end_def l_neq_1 funct_OT_12_def w0_rewrite z0_rewrite<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span>  <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">u0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">u1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w0</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="bound">u0</span> <span class="main">+</span> <span class="bound">v0</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w1</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u1</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">v1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z0</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="skolem">Œ±</span> <span class="main">*</span> <span class="bound">u0</span> <span class="main">+</span> <span class="bound">v0</span> <span class="main">*</span> <span class="skolem">Œ±</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">*</span> <span class="bound">u0</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z1</span> <span class="main">=</span> <span class="main">(</span><span class="free">b1</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u1</span> <span class="main">‚äó</span> <span class="free">h1</span> <span class="main">[^]</span> <span class="bound">v1</span> <span class="main">‚äó</span> <span class="free">x1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e0</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w0</span><span class="main">,</span><span class="bound">z0</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e1</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w1</span><span class="main">,</span><span class="bound">z1</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">out</span> <span class="main">‚Üê</span> <span class="free">ùíú3</span> <span class="bound">e0</span> <span class="bound">e1</span> <span class="free">s'</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="bound">out</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> z0_rewrite'<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span>  <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">u0</span> <span class="main">‚Üê</span> map_spmf <span class="main">(</span><span class="main">Œª</span> <span class="bound">u0</span><span class="main">.</span> <span class="main">(</span>order <span class="free">ùí¢</span> <span class="main">*</span> order <span class="free">ùí¢</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">s</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>nat <span class="main">(</span><span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="skolem">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="bound">u0</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v0</span> <span class="main">‚Üê</span> map_spmf <span class="main">(</span><span class="main">Œª</span> <span class="bound">v0</span><span class="main">.</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="skolem">s</span> <span class="main">*</span>  <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="skolem">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="bound">v0</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">u1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w0</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="bound">u0</span> <span class="main">+</span> <span class="bound">v0</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w1</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u1</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">v1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z0</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="skolem">Œ±</span> <span class="main">*</span> <span class="bound">u0</span> <span class="main">+</span> <span class="bound">v0</span> <span class="main">*</span> <span class="skolem">Œ±</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">*</span> <span class="main">(</span><span class="bound">u0</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="skolem">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z1</span> <span class="main">=</span> <span class="main">(</span><span class="free">b1</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u1</span> <span class="main">‚äó</span> <span class="free">h1</span> <span class="main">[^]</span> <span class="bound">v1</span> <span class="main">‚äó</span> <span class="free">x1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e0</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w0</span><span class="main">,</span><span class="bound">z0</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e1</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w1</span><span class="main">,</span><span class="bound">z1</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">out</span> <span class="main">‚Üê</span> <span class="free">ùíú3</span> <span class="bound">e0</span> <span class="bound">e1</span> <span class="free">s'</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="bound">out</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_map_spmf o_def Let_def s_lt P2_case_l_new_1_gt_e0_rewrite <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> bind_spmf_cong_simp<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span>  <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">u0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">u1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w0</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="bound">u0</span> <span class="main">+</span> <span class="bound">v0</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w1</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u1</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">v1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z0</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="skolem">Œ±</span> <span class="main">*</span> <span class="bound">u0</span> <span class="main">+</span> <span class="bound">v0</span> <span class="main">*</span> <span class="skolem">Œ±</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">*</span> <span class="main">(</span><span class="bound">u0</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">s</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span>fst <span class="main">(</span>bezw <span class="skolem">t</span> <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> order <span class="free">ùí¢</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z1</span> <span class="main">=</span> <span class="main">(</span><span class="free">b1</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u1</span> <span class="main">‚äó</span> <span class="free">h1</span> <span class="main">[^]</span> <span class="bound">v1</span> <span class="main">‚äó</span> <span class="free">x1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e0</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w0</span><span class="main">,</span><span class="bound">z0</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e1</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w1</span><span class="main">,</span><span class="bound">z1</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">out</span> <span class="main">‚Üê</span> <span class="free">ùíú3</span> <span class="bound">e0</span> <span class="bound">e1</span> <span class="free">s'</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="bound">out</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> samp_uni_plus_one_time_pad<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span>  <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">u0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">u1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w0</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="bound">u0</span> <span class="main">+</span> <span class="bound">v0</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w1</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u1</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">v1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z0</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="skolem">Œ±</span> <span class="main">*</span> <span class="bound">u0</span> <span class="main">+</span> <span class="bound">v0</span> <span class="main">*</span> <span class="skolem">Œ±</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">*</span> <span class="bound">u0</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">s</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z1</span> <span class="main">=</span> <span class="main">(</span><span class="free">b1</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u1</span> <span class="main">‚äó</span> <span class="free">h1</span> <span class="main">[^]</span> <span class="bound">v1</span> <span class="main">‚äó</span> <span class="free">x1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e0</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w0</span><span class="main">,</span><span class="bound">z0</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e1</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w1</span><span class="main">,</span><span class="bound">z1</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">out</span> <span class="main">‚Üê</span> <span class="free">ùíú3</span> <span class="bound">e0</span> <span class="bound">e1</span> <span class="free">s'</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="bound">out</span><span class="main">)</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P2_case_l_neq_1_gt_x0_rewrite t_lt_order_g t_neq_0 cyclic_group_assoc<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span>  <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">u0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v0</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">u1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">v1</span> <span class="main">‚Üê</span> sample_uniform <span class="main">(</span>order <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w0</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u0</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">v0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">w1</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u1</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="bound">v1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z0</span> <span class="main">=</span> <span class="free">b0</span> <span class="main">[^]</span> <span class="bound">u0</span> <span class="main">‚äó</span> <span class="free">h0</span> <span class="main">[^]</span> <span class="bound">v0</span> <span class="main">‚äó</span> <span class="free">x0</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">z1</span> <span class="main">=</span> <span class="main">(</span><span class="free">b1</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span><span class="main">)</span> <span class="main">[^]</span> <span class="bound">u1</span> <span class="main">‚äó</span> <span class="free">h1</span> <span class="main">[^]</span> <span class="bound">v1</span> <span class="main">‚äó</span> <span class="free">x1</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e0</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w0</span><span class="main">,</span><span class="bound">z0</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">e1</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w1</span><span class="main">,</span><span class="bound">z1</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">out</span> <span class="main">‚Üê</span> <span class="free">ùíú3</span> <span class="bound">e0</span> <span class="bound">e1</span> <span class="free">s'</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="bound">out</span><span class="main">)</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> w0_rewrite z0_rewrite''<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P2_real_model_end_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P2_ideal_real_eq<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> x1_in_carrier<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x1</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> x0_in_carrier<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x0</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span>"</span></span>  
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"P2_real_model <span class="main">(</span><span class="free">x0</span><span class="main">,</span><span class="free">x1</span><span class="main">)</span> <span class="free">œÉ</span>  <span class="free">z</span> <span class="free">ùíú</span>  <span class="main">=</span> P2_ideal_model <span class="main">(</span><span class="free">x0</span><span class="main">,</span><span class="free">x1</span><span class="main">)</span> <span class="free">œÉ</span>  <span class="free">z</span> <span class="free">ùíú</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"P2_real_model' <span class="main">(</span><span class="free">x0</span><span class="main">,</span> <span class="free">x1</span><span class="main">)</span> <span class="free">œÉ</span>  <span class="free">z</span> <span class="free">ùíú</span> <span class="main">=</span> P2_ideal_model' <span class="main">(</span><span class="free">x0</span><span class="main">,</span> <span class="free">x1</span><span class="main">)</span> <span class="free">œÉ</span>  <span class="free">z</span> <span class="free">ùíú</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ùíú1</span><span class="main">,</span> <span class="bound">ùíú2</span><span class="main">,</span> <span class="bound">ùíú3</span><span class="main">)</span> <span class="main">=</span> <span class="free">ùíú</span><span class="main">;</span>
    <span class="main">(</span><span class="main">(</span><span class="bound">h0</span><span class="main">,</span><span class="bound">h1</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b0</span><span class="main">,</span><span class="bound">b1</span><span class="main">)</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="bound">ùíú1</span> <span class="free">œÉ</span> <span class="free">z</span><span class="main">;</span>
    <span class="main"><span class="bound">_</span></span> <span class="main">::</span> unit <span class="main">‚Üê</span> assert_spmf <span class="main">(</span><span class="bound">h0</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span> <span class="main">‚àß</span> <span class="bound">h1</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span>  <span class="main">‚àß</span> <span class="bound">a</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span> <span class="main">‚àß</span> <span class="bound">b0</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span> <span class="main">‚àß</span> <span class="bound">b1</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">in1</span><span class="main">,</span> <span class="bound">in2</span><span class="main">,</span> <span class="bound">in3</span><span class="main">)</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="bound">ùíú2</span> <span class="main">(</span><span class="bound">h0</span><span class="main">,</span><span class="bound">h1</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b0</span><span class="main">,</span><span class="bound">b1</span><span class="main">)</span> <span class="bound">s</span><span class="main">;</span> 
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">h</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">h0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="bound">h1</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">b0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="bound">b1</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="bound">out_zk_funct</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">‚Üê</span> funct_DH_ZK <span class="main">(</span><span class="bound">h</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="bound">in1</span><span class="main">,</span> <span class="bound">in2</span><span class="main">,</span> <span class="bound">in3</span><span class="main">)</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">;</span>  
    <span class="main"><span class="bound">_</span></span> <span class="main">::</span> unit <span class="main">‚Üê</span> assert_spmf <span class="bound">out_zk_funct</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">l</span> <span class="main">=</span> <span class="bound">b0</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">inv</span> <span class="main">(</span><span class="bound">h0</span> <span class="main">[^]</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    P2_ideal_model_end <span class="main">(</span><span class="free">x0</span><span class="main">,</span><span class="free">x1</span><span class="main">)</span> <span class="bound">l</span> <span class="main">(</span><span class="main">(</span><span class="bound">h0</span><span class="main">,</span><span class="bound">h1</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b0</span><span class="main">,</span><span class="bound">b1</span><span class="main">)</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="bound">ùíú3</span><span class="main">}</span> <span class="main">=</span> P2_ideal_model' <span class="main">(</span><span class="free">x0</span><span class="main">,</span><span class="free">x1</span><span class="main">)</span> <span class="free">œÉ</span> <span class="free">z</span> <span class="free">ùíú</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> P2_ideal_model'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"P2_real_model' <span class="main">(</span><span class="free">x0</span><span class="main">,</span> <span class="free">x1</span><span class="main">)</span> <span class="free">œÉ</span>  <span class="free">z</span> <span class="free">ùíú</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ùíú1</span><span class="main">,</span> <span class="bound">ùíú2</span><span class="main">,</span> <span class="bound">ùíú3</span><span class="main">)</span> <span class="main">=</span> <span class="free">ùíú</span><span class="main">;</span>
    <span class="main">(</span><span class="main">(</span><span class="bound">h0</span><span class="main">,</span><span class="bound">h1</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b0</span><span class="main">,</span><span class="bound">b1</span><span class="main">)</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="bound">ùíú1</span> <span class="free">œÉ</span> <span class="free">z</span><span class="main">;</span>
    <span class="main"><span class="bound">_</span></span> <span class="main">::</span> unit <span class="main">‚Üê</span> assert_spmf <span class="main">(</span><span class="bound">h0</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span> <span class="main">‚àß</span> <span class="bound">h1</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span>  <span class="main">‚àß</span> <span class="bound">a</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span> <span class="main">‚àß</span> <span class="bound">b0</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span> <span class="main">‚àß</span> <span class="bound">b1</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">in1</span><span class="main">,</span> <span class="bound">in2</span><span class="main">,</span> <span class="bound">in3</span><span class="main">)</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="bound">ùíú2</span> <span class="main">(</span><span class="bound">h0</span><span class="main">,</span><span class="bound">h1</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b0</span><span class="main">,</span><span class="bound">b1</span><span class="main">)</span> <span class="bound">s</span><span class="main">;</span> 
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">h</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">h0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="bound">h1</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">b0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="bound">b1</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="bound">out_zk_funct</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">‚Üê</span> funct_DH_ZK <span class="main">(</span><span class="bound">h</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="bound">in1</span><span class="main">,</span> <span class="bound">in2</span><span class="main">,</span> <span class="bound">in3</span><span class="main">)</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">;</span>  
    <span class="main"><span class="bound">_</span></span> <span class="main">::</span> unit <span class="main">‚Üê</span> assert_spmf <span class="bound">out_zk_funct</span><span class="main">;</span>
    P2_real_model_end <span class="main">(</span><span class="free">x0</span><span class="main">,</span> <span class="free">x1</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="bound">h0</span><span class="main">,</span><span class="bound">h1</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b0</span><span class="main">,</span><span class="bound">b1</span><span class="main">)</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="bound">ùíú3</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P2_real_model'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ùíú1</span><span class="main">,</span> <span class="bound">ùíú2</span><span class="main">,</span> <span class="bound">ùíú3</span><span class="main">)</span> <span class="main">=</span> <span class="free">ùíú</span><span class="main">;</span>
    <span class="main">(</span><span class="main">(</span><span class="bound">h0</span><span class="main">,</span><span class="bound">h1</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b0</span><span class="main">,</span><span class="bound">b1</span><span class="main">)</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="bound">ùíú1</span> <span class="free">œÉ</span> <span class="free">z</span><span class="main">;</span>
    <span class="main"><span class="bound">_</span></span> <span class="main">::</span> unit <span class="main">‚Üê</span> assert_spmf <span class="main">(</span><span class="bound">h0</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span> <span class="main">‚àß</span> <span class="bound">h1</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span>  <span class="main">‚àß</span> <span class="bound">a</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span> <span class="main">‚àß</span> <span class="bound">b0</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span> <span class="main">‚àß</span> <span class="bound">b1</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">in1</span><span class="main">,</span> <span class="bound">in2</span><span class="main">,</span> <span class="bound">in3</span><span class="main">)</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">‚Üê</span> <span class="bound">ùíú2</span> <span class="main">(</span><span class="bound">h0</span><span class="main">,</span><span class="bound">h1</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b0</span><span class="main">,</span><span class="bound">b1</span><span class="main">)</span> <span class="bound">s</span><span class="main">;</span> 
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">h</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">h0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="bound">h1</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">b0</span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="bound">b1</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="bound">out_zk_funct</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">‚Üê</span> funct_DH_ZK <span class="main">(</span><span class="bound">h</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="bound">in1</span><span class="main">,</span> <span class="bound">in2</span><span class="main">,</span> <span class="bound">in3</span><span class="main">)</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">;</span>  
    <span class="main"><span class="bound">_</span></span> <span class="main">::</span> unit <span class="main">‚Üê</span> assert_spmf <span class="bound">out_zk_funct</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">l</span> <span class="main">=</span> <span class="bound">b0</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1">inv</span> <span class="main">(</span><span class="bound">h0</span> <span class="main">[^]</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    P2_ideal_model_end <span class="main">(</span><span class="free">x0</span><span class="main">,</span><span class="free">x1</span><span class="main">)</span> <span class="bound">l</span> <span class="main">(</span><span class="main">(</span><span class="bound">h0</span><span class="main">,</span><span class="bound">h1</span><span class="main">,</span><span class="bound">a</span><span class="main">,</span><span class="bound">b0</span><span class="main">,</span><span class="bound">b1</span><span class="main">)</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="bound">ùíú3</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P2_ideal_real_end_eq assms <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> bind_spmf_cong_simp<span class="main">)</span>  
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P2_real_model'_def P2_ideal_model'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P2_ideal_model_rewrite P2_real_model_rewrite<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> malicious_sec_P2<span class="main">:</span>   
  <span class="keyword2"><span class="keyword">assumes</span></span> x1_in_carrier<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x1</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> x0_in_carrier<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x0</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span>"</span></span>  
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mal_def.perfect_sec_P2 <span class="main">(</span><span class="free">x0</span><span class="main">,</span><span class="free">x1</span><span class="main">)</span> <span class="free">œÉ</span> <span class="free">z</span> <span class="main">(</span>P2_S1<span class="main">,</span> P2_S2<span class="main">)</span> <span class="free">ùíú</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> malicious_base.perfect_sec_P2_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P2_ideal_real_eq P2_ideal_view_unfold assms<span class="main">)</span>

<span class="comment1">(*correctness*)</span>

<span class="keyword1"><span class="command">lemma</span></span> correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x0</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x1</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"funct_OT_12 <span class="main">(</span><span class="free">x0</span><span class="main">,</span> <span class="free">x1</span><span class="main">)</span> <span class="free">œÉ</span> <span class="main">=</span> protocol_ot <span class="main">(</span><span class="free">x0</span><span class="main">,</span><span class="free">x1</span><span class="main">)</span> <span class="free">œÉ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> œÉ_eq_0_output_correct<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">Œ±0</span><span class="main">)</span> <span class="main">[^]</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">[^]</span> <span class="skolem">u0</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">Œ±0</span><span class="main">)</span> <span class="main">[^]</span> <span class="skolem">v0</span> <span class="main">‚äó</span> <span class="free">x0</span> <span class="main">‚äó</span>
                      <span class="keyword1">inv</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">[^]</span> <span class="skolem">u0</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">v0</span><span class="main">)</span> <span class="main">[^]</span> <span class="skolem">Œ±0</span><span class="main">)</span> <span class="main">=</span> <span class="free">x0</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">Œ±0</span> <span class="skolem">r</span> <span class="skolem">u0</span> <span class="skolem">v0</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> mult_com<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">*</span> <span class="skolem">u0</span> <span class="main">*</span> <span class="skolem">Œ±0</span> <span class="main">=</span> <span class="skolem">Œ±0</span> <span class="main">*</span> <span class="skolem">r</span> <span class="main">*</span> <span class="skolem">u0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> in_carrier1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">r</span>  <span class="main">*</span> <span class="skolem">u0</span> <span class="main">*</span> <span class="skolem">Œ±0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">v0</span> <span class="main">*</span> <span class="skolem">Œ±0</span><span class="main">)</span><span class="main">)</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> in_carrier2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">inv</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">r</span>  <span class="main">*</span> <span class="skolem">u0</span> <span class="main">*</span> <span class="skolem">Œ±0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">v0</span> <span class="main">*</span> <span class="skolem">Œ±0</span><span class="main">)</span><span class="main">)</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">Œ±0</span> <span class="main">*</span> <span class="skolem">r</span> <span class="main">*</span> <span class="skolem">u0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">Œ±0</span> <span class="main">*</span> <span class="skolem">v0</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="free">x0</span> <span class="main">‚äó</span>
                        <span class="keyword1">inv</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">r</span>  <span class="main">*</span> <span class="skolem">u0</span> <span class="main">*</span> <span class="skolem">Œ±0</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">v0</span> <span class="main">*</span> <span class="skolem">Œ±0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nat_pow_pow pow_mult_distrib cyclic_group_commute monoid_comm_monoidI<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">r</span>  <span class="main">*</span> <span class="skolem">u0</span> <span class="main">*</span> <span class="skolem">Œ±0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">v0</span> <span class="main">*</span> <span class="skolem">Œ±0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="free">x0</span> <span class="main">‚äó</span>
                        <span class="main">(</span><span class="keyword1">inv</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">r</span>  <span class="main">*</span> <span class="skolem">u0</span> <span class="main">*</span> <span class="skolem">Œ±0</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">v0</span> <span class="main">*</span> <span class="skolem">Œ±0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> mult.commute mult.assoc mult_com   
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> mult.commute<span class="main">)</span> 
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">x0</span> <span class="main">‚äó</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">r</span>  <span class="main">*</span> <span class="skolem">u0</span> <span class="main">*</span> <span class="skolem">Œ±0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">v0</span> <span class="main">*</span> <span class="skolem">Œ±0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span>
                        <span class="main">(</span><span class="keyword1">inv</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">r</span>  <span class="main">*</span> <span class="skolem">u0</span> <span class="main">*</span> <span class="skolem">Œ±0</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">v0</span> <span class="main">*</span> <span class="skolem">Œ±0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cyclic_group_commute in_carrier1 assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">x0</span> <span class="main">‚äó</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">r</span>  <span class="main">*</span> <span class="skolem">u0</span> <span class="main">*</span> <span class="skolem">Œ±0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">v0</span> <span class="main">*</span> <span class="skolem">Œ±0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span>
                        <span class="main">(</span><span class="keyword1">inv</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">r</span>  <span class="main">*</span> <span class="skolem">u0</span> <span class="main">*</span> <span class="skolem">Œ±0</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">v0</span> <span class="main">*</span> <span class="skolem">Œ±0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cyclic_group_assoc in_carrier1 in_carrier2 assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> œÉ_eq_1_output_correct<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">Œ±1</span><span class="main">)</span> <span class="main">[^]</span> <span class="skolem">r</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span><span class="main">)</span> <span class="main">[^]</span> <span class="skolem">u1</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">Œ±1</span><span class="main">)</span> <span class="main">[^]</span> <span class="skolem">v1</span> <span class="main">‚äó</span> <span class="free">x1</span> <span class="main">‚äó</span>
                               <span class="keyword1">inv</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">[^]</span> <span class="skolem">u1</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="skolem">v1</span><span class="main">)</span> <span class="main">[^]</span> <span class="skolem">Œ±1</span><span class="main">)</span> <span class="main">=</span> <span class="free">x1</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">Œ±1</span> <span class="skolem">r</span> <span class="skolem">u1</span> <span class="skolem">v1</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> com1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Œ±1</span> <span class="main">*</span> <span class="skolem">r</span> <span class="main">*</span> <span class="skolem">u1</span> <span class="main">=</span> <span class="skolem">r</span> <span class="main">*</span>  <span class="skolem">u1</span> <span class="main">*</span> <span class="skolem">Œ±1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">*</span> <span class="skolem">Œ±1</span> <span class="main">=</span> <span class="skolem">Œ±1</span> <span class="main">*</span> <span class="skolem">v1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> in_carrier1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">*</span>  <span class="skolem">u1</span> <span class="main">*</span> <span class="skolem">Œ±1</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">v1</span> <span class="main">*</span> <span class="skolem">Œ±1</span><span class="main">)</span><span class="main">)</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> in_carrier2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">inv</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">*</span>  <span class="skolem">u1</span> <span class="main">*</span> <span class="skolem">Œ±1</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">v1</span> <span class="main">*</span> <span class="skolem">Œ±1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> lhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">Œ±1</span><span class="main">*</span><span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">‚äó</span> <span class="keyword1">inv</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span><span class="main">)</span> <span class="main">[^]</span> <span class="skolem">u1</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">Œ±1</span> <span class="main">*</span> <span class="skolem">v1</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="free">x1</span> <span class="main">‚äó</span>
                                 <span class="keyword1">inv</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">*</span>  <span class="skolem">u1</span> <span class="main">*</span> <span class="skolem">Œ±1</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">v1</span><span class="main">*</span><span class="skolem">Œ±1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nat_pow_pow pow_mult_distrib cyclic_group_commute monoid_comm_monoidI<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> lhs1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">Œ±1</span> <span class="main">*</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">[^]</span> <span class="skolem">u1</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">Œ±1</span> <span class="main">*</span> <span class="skolem">v1</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="free">x1</span> <span class="main">‚äó</span>
                                 <span class="keyword1">inv</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">*</span>  <span class="skolem">u1</span> <span class="main">*</span> <span class="skolem">Œ±1</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">v1</span><span class="main">*</span><span class="skolem">Œ±1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cyclic_group_assoc<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> lhs2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">*</span>  <span class="skolem">u1</span> <span class="main">*</span> <span class="skolem">Œ±1</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">v1</span> <span class="main">*</span> <span class="skolem">Œ±1</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="free">x1</span> <span class="main">‚äó</span>
                                 <span class="keyword1">inv</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">*</span>  <span class="skolem">u1</span> <span class="main">*</span> <span class="skolem">Œ±1</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">v1</span> <span class="main">*</span> <span class="skolem">Œ±1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nat_pow_pow pow_mult_distrib cyclic_group_commute monoid_comm_monoidI com1<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">*</span>  <span class="skolem">u1</span> <span class="main">*</span> <span class="skolem">Œ±1</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">v1</span> <span class="main">*</span> <span class="skolem">Œ±1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="free">x1</span><span class="main">)</span> <span class="main">‚äó</span>
                                 <span class="keyword1">inv</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">*</span>  <span class="skolem">u1</span> <span class="main">*</span> <span class="skolem">Œ±1</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">v1</span> <span class="main">*</span> <span class="skolem">Œ±1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> in_carrier1 in_carrier2 assms cyclic_group_assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="free">x1</span> <span class="main">‚äó</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">*</span>  <span class="skolem">u1</span> <span class="main">*</span> <span class="skolem">Œ±1</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">v1</span> <span class="main">*</span> <span class="skolem">Œ±1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span>
                                 <span class="keyword1">inv</span> <span class="main">(</span><span class="main">(</span><span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">*</span>  <span class="skolem">u1</span> <span class="main">*</span> <span class="skolem">Œ±1</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äó</span> <span class="keyword1"><span class="hidden">‚ùô</span><b>g</b></span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">v1</span> <span class="main">*</span> <span class="skolem">Œ±1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> in_carrier1 assms cyclic_group_commute <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> cyclic_group_assoc assms in_carrier1 in_carrier1 assms cyclic_group_commute lhs1 lhs2 lhs <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> funct_OT_12_def protocol_ot_def Let_def
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">œÉ</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms œÉ_eq_1_output_correct œÉ_eq_0_output_correct bind_spmf_const
        lossless_sample_uniform_units order_gt_0 P1_assert_correct1 P1_assert_correct2 lossless_weight_spmfD<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> correctness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x0</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x1</span> <span class="main">‚àà</span> carrier <span class="free">ùí¢</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mal_def.correct <span class="main">(</span><span class="free">x0</span><span class="main">,</span><span class="free">x1</span><span class="main">)</span> <span class="free">œÉ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mal_def.correct_def 
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> correct assms<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span> 

<span class="keyword1"><span class="command">locale</span></span> OT_asymp <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ùí¢</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">‚áí</span> <span class="tfree">'grp</span> cyclic_group"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ot<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">‚ãÄ</span><span class="bound">Œ∑</span><span class="main">.</span> ot <span class="main">(</span><span class="free">ùí¢</span> <span class="bound">Œ∑</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> ot <span class="quoted"><span class="quoted">"<span class="free">ùí¢</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">n</span> <span class="keyword1"><span class="command">using</span></span> ot <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> correctness_asym<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x0</span> <span class="main">‚àà</span> carrier <span class="main">(</span><span class="free">ùí¢</span> <span class="free">n</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x1</span> <span class="main">‚àà</span> carrier <span class="main">(</span><span class="free">ùí¢</span> <span class="free">n</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mal_def.correct <span class="free">n</span> <span class="main">(</span><span class="free">x0</span><span class="main">,</span><span class="free">x1</span><span class="main">)</span> <span class="free">œÉ</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms correctness <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> P1_security_asym<span class="main">:</span>
  <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">Œª</span> <span class="bound">n</span><span class="main">.</span> mal_def.adv_P1 <span class="bound">n</span> <span class="free">M</span> <span class="free">œÉ</span> <span class="free">z</span> <span class="main">(</span>P1_S1 <span class="bound">n</span><span class="main">,</span> P1_S2<span class="main">)</span> <span class="free">ùíú</span> <span class="free">D</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">if</span></span> neg1<span class="main">:</span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">Œª</span> <span class="bound">n</span><span class="main">.</span> ddh.advantage <span class="bound">n</span> <span class="main">(</span>P1_DDH_mal_adv_œÉ_true <span class="bound">n</span> <span class="free">M</span> <span class="free">z</span> <span class="free">ùíú</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> neg2<span class="main">:</span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">Œª</span> <span class="bound">n</span><span class="main">.</span> ddh.advantage <span class="bound">n</span> <span class="main">(</span>ddh.DDH_ùíú' <span class="bound">n</span> <span class="main">(</span>P1_DDH_mal_adv_œÉ_true <span class="bound">n</span> <span class="free">M</span> <span class="free">z</span> <span class="free">ùíú</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> neg3<span class="main">:</span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">Œª</span> <span class="bound">n</span><span class="main">.</span> ddh.advantage <span class="bound">n</span> <span class="main">(</span>P1_DDH_mal_adv_œÉ_false <span class="bound">n</span> <span class="free">M</span> <span class="free">z</span> <span class="free">ùíú</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> neg4<span class="main">:</span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">Œª</span> <span class="bound">n</span><span class="main">.</span> ddh.advantage <span class="bound">n</span> <span class="main">(</span>ddh.DDH_ùíú' <span class="bound">n</span> <span class="main">(</span>P1_DDH_mal_adv_œÉ_false <span class="bound">n</span> <span class="free">M</span> <span class="free">z</span> <span class="free">ùíú</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>  
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> neg_add1<span class="main">:</span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">Œª</span> <span class="bound">n</span><span class="main">.</span> ddh.advantage <span class="bound">n</span> <span class="main">(</span>P1_DDH_mal_adv_œÉ_true <span class="bound">n</span> <span class="free">M</span> <span class="free">z</span> <span class="free">ùíú</span> <span class="free">D</span><span class="main">)</span> 
        <span class="main">+</span> ddh.advantage <span class="bound">n</span> <span class="main">(</span>ddh.DDH_ùíú' <span class="bound">n</span> <span class="main">(</span>P1_DDH_mal_adv_œÉ_true <span class="bound">n</span> <span class="free">M</span> <span class="free">z</span> <span class="free">ùíú</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> neg_add2<span class="main">:</span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">Œª</span> <span class="bound">n</span><span class="main">.</span> ddh.advantage <span class="bound">n</span> <span class="main">(</span>P1_DDH_mal_adv_œÉ_false <span class="bound">n</span> <span class="free">M</span> <span class="free">z</span> <span class="free">ùíú</span> <span class="free">D</span><span class="main">)</span>
        <span class="main">+</span> ddh.advantage <span class="bound">n</span> <span class="main">(</span>ddh.DDH_ùíú' <span class="bound">n</span> <span class="main">(</span>P1_DDH_mal_adv_œÉ_false <span class="bound">n</span> <span class="free">M</span> <span class="free">z</span> <span class="free">ùíú</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>  
    <span class="keyword1"><span class="command">using</span></span> neg1 neg2 neg3 neg4 negligible_plus <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">œÉ</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> bound_mod<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬¶</span>mal_def.adv_P1 <span class="skolem">n</span> <span class="free">M</span> <span class="free">œÉ</span> <span class="free">z</span> <span class="main">(</span>P1_S1 <span class="skolem">n</span><span class="main">,</span> P1_S2<span class="main">)</span> <span class="free">ùíú</span> <span class="free">D</span><span class="main">¬¶</span> 
            <span class="main">‚â§</span> ddh.advantage <span class="skolem">n</span> <span class="main">(</span>P1_DDH_mal_adv_œÉ_true <span class="skolem">n</span> <span class="free">M</span> <span class="free">z</span> <span class="free">ùíú</span> <span class="free">D</span><span class="main">)</span> 
              <span class="main">+</span> ddh.advantage <span class="skolem">n</span> <span class="main">(</span>ddh.DDH_ùíú' <span class="skolem">n</span> <span class="main">(</span>P1_DDH_mal_adv_œÉ_true <span class="skolem">n</span> <span class="free">M</span> <span class="free">z</span> <span class="free">ùíú</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> True abs_idempotent P1_adv_real_ideal_model_def P1_advantages_eq P1_real_ideal_DDH_advantage_true_bound<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> P1_real_ideal_DDH_advantage_true_bound that bound_mod that negligible_le neg_add1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> bound_mod<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬¶</span>mal_def.adv_P1 <span class="skolem">n</span> <span class="free">M</span> <span class="free">œÉ</span> <span class="free">z</span> <span class="main">(</span>P1_S1 <span class="skolem">n</span><span class="main">,</span> P1_S2<span class="main">)</span> <span class="free">ùíú</span> <span class="free">D</span><span class="main">¬¶</span> 
            <span class="main">‚â§</span> ddh.advantage <span class="skolem">n</span> <span class="main">(</span>P1_DDH_mal_adv_œÉ_false <span class="skolem">n</span> <span class="free">M</span> <span class="free">z</span> <span class="free">ùíú</span> <span class="free">D</span><span class="main">)</span> 
              <span class="main">+</span> ddh.advantage <span class="skolem">n</span> <span class="main">(</span>ddh.DDH_ùíú' <span class="skolem">n</span> <span class="main">(</span>P1_DDH_mal_adv_œÉ_false <span class="skolem">n</span> <span class="free">M</span> <span class="free">z</span> <span class="free">ùíú</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬¶</span>spmf <span class="main">(</span>P1_real_model <span class="skolem">n</span> <span class="free">M</span> <span class="free">œÉ</span> <span class="free">z</span> <span class="free">ùíú</span> <span class="main">‚§ú</span> <span class="free">D</span><span class="main">)</span> True <span class="main">-</span> spmf <span class="main">(</span>P1_ideal_model <span class="skolem">n</span> <span class="free">M</span> <span class="free">œÉ</span> <span class="free">z</span> <span class="free">ùíú</span> <span class="main">‚§ú</span> <span class="free">D</span><span class="main">)</span> True<span class="main">¬¶</span> 
                    <span class="main">‚â§</span> local.ddh.advantage <span class="skolem">n</span> <span class="main">(</span>P1_DDH_mal_adv_œÉ_false <span class="skolem">n</span> <span class="free">M</span> <span class="free">z</span> <span class="free">ùíú</span> <span class="free">D</span><span class="main">)</span>    
                            <span class="main">+</span> local.ddh.advantage <span class="skolem">n</span> <span class="main">(</span>ddh.DDH_ùíú' <span class="skolem">n</span> <span class="main">(</span>P1_DDH_mal_adv_œÉ_false <span class="skolem">n</span> <span class="free">M</span> <span class="free">z</span> <span class="free">ùíú</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> False P1_adv_real_ideal_model_def P1_advantages_eq P1_real_ideal_DDH_advantage_false_bound<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P1_adv_real_ideal_model_def P1_advantages_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> P1_real_ideal_DDH_advantage_false_bound  bound_mod that negligible_le neg_add2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P2_security_asym<span class="main">:</span>   
  <span class="keyword2"><span class="keyword">assumes</span></span> x1_in_carrier<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x1</span> <span class="main">‚àà</span> carrier <span class="main">(</span><span class="free">ùí¢</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> x0_in_carrier<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x0</span> <span class="main">‚àà</span> carrier <span class="main">(</span><span class="free">ùí¢</span> <span class="free">n</span><span class="main">)</span>"</span></span>  
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mal_def.perfect_sec_P2 <span class="free">n</span> <span class="main">(</span><span class="free">x0</span><span class="main">,</span><span class="free">x1</span><span class="main">)</span> <span class="free">œÉ</span> <span class="free">z</span> <span class="main">(</span>P2_S1 <span class="free">n</span><span class="main">,</span> P2_S2 <span class="free">n</span><span class="main">)</span> <span class="free">ùíú</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms malicious_sec_P2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>